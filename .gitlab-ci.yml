image: docker.uib.gmbh/opsi/opsidoc-antora:bookworm

stages:
  # - lint
  - build
  - package
  - publish
  - publish_ext

.install_toolchain: &install_toolchain |
  npm config set fetch-retry-maxtimeout 60000 -g
  # Antora
  npm install
  # Antora-UI
  cd antora-ui
  npm install
  cd ..

.install_cspell: &install_cspell |
  echo "Install cspell"
  npm install -g cspell@latest
  npm install -g @cspell/dict-de-de
  cspell link add @cspell/dict-de-de

#lint-cspell:
 # stage: lint
 # script:
    # - *install_cspell
    #- cspell lint -c cspell.json docs/de/modules/server
    #- cspell lint -c cspell.json docs/de/modules/clients

build-antora:
  stage: build
  script:
    - *install_toolchain
    - cd antora-ui
    - gulp bundle
    - gulp bundle:pack
    - cd ..
    - npx antora -v
    - npx antora --log-level=debug antora-playbook.yml
    - touch build/docs-opsi-org/site/index.html
  artifacts:
    paths:
      - build/docs-opsi-org/site
    expire_in: 2 days

build-antora-bonifax:
  stage: build
  script:
    - *install_toolchain
    - cd antora-ui
    - gulp bundle
    - gulp bundle:pack
    - cd ..
    - npx antora -v
    - npx antora --log-level=debug bonifax-playbook.yml
    - touch build/bonifax/site/index.html
  artifacts:
    paths:
      - build/bonifax/site
    expire_in: 2 days

build-pdf-html:
  stage: build
  script: | 
    for LANGUAGE in de en
    do
      for DOCUMENT in getting-started manual opsi-script-manual releasenotes macos-client-manual windows-client-manual linux-client-manual quickinstall supportmatrix opsi-script-reference-card
      do
        if [ $DOCUMENT == 'opsi-script-reference-card' ] && [ $LANGUAGE == 'de' ] 
        then
          echo "skip opsi-script-reference-card de"
          continue
        fi
        ./tools/make-books.sh -l $LANGUAGE -m -n $DOCUMENT
        echo "build/pdf/$LANGUAGE/$DOCUMENT/opsi-$DOCUMENT.pdf"
        if [[ "${DOCUMENT}" == "opsi"* ]]; then
          test -f build/pdf/$LANGUAGE/$DOCUMENT/$DOCUMENT.pdf
          test -f build/html/$LANGUAGE/$DOCUMENT/$DOCUMENT.html
        else
          test -f build/pdf/$LANGUAGE/opsi-$DOCUMENT/opsi-$DOCUMENT.pdf
          test -f build/html/$LANGUAGE/opsi-$DOCUMENT/opsi-$DOCUMENT.html
        fi
      done
    done
  only:
    - stable
  artifacts:
    paths:
      - build/pdf
      - build/html
    expire_in: 2 days


# Packaging and renaming of documents
package_docs:
  stage: package
  before_script:
    - apt update
  script:
    - make publish
  only:
    - stable
  artifacts:
    paths:
      - pub/
    expire_in: 7 days



publish_antora_docs:
  stage: publish
  before_script:
    - 'which ssh-agent || (apt update && apt install -y openssh-client)'
    - 'which rsync || (apt update && apt install -y rsync)'
    - mkdir -p ~/.ssh
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$DOCUSER_PRIVATE_KEY")
  script:
    - rsync -e "ssh -o StrictHostKeyChecking=no" --delete -azv build/bonifax/site/* "$DOCUSER@$DOCSERVER:/home/opsi/doc/opsidoc/antora/"
  only:
    - devel
    - stable


# Publishing documentation to internal server
publish_docs:
  stage: publish
  before_script:
    - 'which ssh-agent || (apt update && apt install -y openssh-client)'
    - mkdir -p ~/.ssh
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$DOCUSER_PRIVATE_KEY")
  script:
    - scp -o StrictHostKeyChecking=no -r pub/* "$DOCUSER@$DOCSERVER:/home/opsi/doc/opsidoc/v4.2/"
  only:
    - stable



# Publishing documentation to external server
publish_docs_ext:
  stage: publish_ext
  when: manual
  before_script:
    - 'which ssh-agent || (apt update && apt -y install openssh-client)'
    - mkdir -p ~/.ssh
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$DOCUSER_PRIVATE_KEY")
  script:
    - scp -o StrictHostKeyChecking=no -r pub/* "$DOCUSER_EXT@$DOCSERVER_EXT:/var/www/opsi/htdocs/opsi4.2/$DOCTARGET/documentation/"
  only:
    - stable



publish_to_docs_opsi_org:
  stage: publish_ext
  when: manual
  before_script:
    - 'which ssh-agent || (apt update && apt -y install openssh-client)'
    - 'which rsync || (apt update && apt -y install rsync)'
    - mkdir -p ~/.ssh
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$BLOG_PUBLISH_PRIVATE_KEY")
  script:  # rsync with delete to get rid of old artifacts. Exclude python-opsi[-common] to not remove them
    - rsync -e "ssh -o StrictHostKeyChecking=no" --delete -azv build/docs-opsi-org/site/ root@docker1.ext.uib.gmbh:/var/lib/docker/volumes/docs_nginx_data/_data/ --exclude=python-opsi --exclude=python-opsi-common
  only:
    - devel
    - stable

