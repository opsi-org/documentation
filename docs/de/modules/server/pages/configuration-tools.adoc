





[[opsi-manual-configuration-tools-opsi-package-manager]]
== Werkzeug 'opsi-package-manager': opsi-Pakete (de-)installieren


[[opsi-manual-configuration-tools-opsi-package-updater]]
== Werkzeug: 'opsi-package-updater'


[[opsi-manual-configuration-tools-opsi-admin-overview]]
== Werkzeuge zum Zugriff auf die opsi API: opsi-admin & opsi interface page

Opsi enthält eine Python-Bibliothek für die zentralen Zugriffsfunktionen
auf die opsi-Datenhaltung. Eine API-Dokumentation zu python-opsi link:https://docs.opsi.org/python-docs/python-opsi[https://docs.opsi.org/python-docs/python-opsi]
und opsicommon link:https://docs.opsi.org/python-docs/python-opsi-common[https://docs.opsi.org/python-docs/python-opsi-common] liegt unter docs.opsi.org.

Nach außen bietet _opsiconfd_ diese als API an, mit der ihre Funktionen
genutzt werden können.
Es gibt mehrere Wege darauf zuzugreifen.


[[opsi-manual-configuration-tools-opsi-interface-page]]
=== Im Browser: opsi admin page

In Version 4.2 wurden die _interface page_ und die _info page_ in der _admin page_ zusammengefasst. Die Seite wird über die URL _https://<opsi-server>:4447/admin_ aufgerufen. Um die Seite zu öffnen müssen Sie sich als Mitglied der Gruppe _opsiadmin_ authentifizieren.

Auf der Seite werden gesperrte Clients als Liste angezeigt. Einzelne Clients können über die IP-Adresse oder über den Knopf _unblock_ in der Liste freigegeben werden.
Es gibt auch einen Möglichkeit alle Clients aufeinmal freizugeben. Hierzu wird die Zeile _Unblock all clients_ verwendet.

Zum Löschen von allen Sessions auf einem Client, wird in der Zeile _Delete client sessions_ die Adresse des Clients angegeben und der Vorgang mit _Execute_ bestätigt.

Rückmeldung bekommt der Benutzer in einer Textbox unter den Eingabefeldern. Außerdem wird die JSON-Response des Servers ausgegeben.

.'opsiconfd': Gesperrte Clients
image:opsi-webinterface-blocked-clients.png["opsiconfd: Gesperrte Clients", pdfwidth=90%]


Im Reiter *RPC-Info* befindet sich eine Tabelle der letzten RPC-Aufrufe. Die Tabelle lässt sich durch einen Klick auf die Header-Leiste sortieren.

._opsiconfd_: RPC-Liste
image:opsi-webinterface-rpc-list.png["opsiconfd: RPC Liste", pdfwidth=90%]


Die ehemalige _interface page_ befindet sich jetzt auf der Adminseite im Reiter *RPC-Interface*. Über das RPC-Interface können Anfragen an die API gestellt werden. Die Anfrage und das Ergebnis werden auf der Seite als JSON dargestellt.

._opsiconfd_: RPC-Interface
image:opsi-webinterface-rpc-interface.png["opsiconfd: RPC-Interface", pdfwidth=90%]

Im Reiter *Redis-Interface* können Anfragen an Redis gestellt werden. Die Antwort des Servers wird als JSON angezeigt.

._opsiconfd_: Redis-Interface
image:opsi-webinterface-redis.png["opsiconfd: Redis-Interface", pdfwidth=90%]


// [[opsi-manual-configuration-tools-serverprocesses-info]]
// === 'opsiconfd'-Überwachung: grafana

Der Tab *Grafana* leitet den Benutzer zum Grafana-Dashboard des opsiconfds weiter. Dort sind grafisch
aufbereitete Informationen über den Lastverlauf des _opsiconfd_ zu finden.

.opsiconfd info: _opsiconfd_-Werte der letzten 3 Stunden
image::opsiconfd-grafana-hour.png["opsiconfd grafana: opsiconfd-Werte der letzten 3 Stunden", pdfwidth=90%]

.opsiconfd info: _opsiconfd_-Werte des letzten Tages
image::opsiconfd-grafana-day.png["opsiconfd grafana: opsiconfd-Werte des letzten Tages", pdfwidth=90%]

Wenn der Grafana Server auf dem gleichen Host wie der _opsiconfd_ läuft und mit der Konfigurationvariablen `grafana_internal_url` kein Benutzer und Password festgelegt wurde, wird ein neuer Grafana Benutzer in der Datenbank angelegt und die Variable `grafana_internal_url` angepasst (Beispiel: http://opsiconfd:passwort@<host>:3000). Das Anlegen des Benutzer findet beim Starten des _opsiconfds_ oder beim Aufrufen von `opsiconfd setup` statt. Grafana kann über die Adminseite (https://<opsi-server>:4447/admin) aufgerufen werden. Beim Klick auf den entsprechenden Tab findet eine Weiterletung zu https://<opsi-server>:4447/metrics/grafana/dashboard. Der Endpoint _metrics/grafana/dashboard_ legt das Dashboard in Grafana an und öffnet es. Bei der Weiterletung wird auch, wenn er nicht existiert, der Benutzer `opsidashboard` angelegt. Der opsidashbord Benutzer wird für die automatische Anmeldung in Grafana verwendet und bekommt bei jeden Aufruf ein zufälliges Password.



[[opsi-manual-configuration-tools-opsi-admin]]
=== Auf der Kommandozeile: opsi-admin

Auf der Kommandozeile kann mit dem Befehl `opsi-admin` auf die opsi API zugegriffen werden.
Dabei bietet _opsi-admin_ einen interaktiven und einen nicht-interaktiven Modus, z.B. zum Einsatz in Skripten.

Der Aufruf von `opsi-admin --help` zeigt eine Hilfe zu den Optionen:
[source,shell]
----
$ opsi-admin --help

Verwendung: opsi-admin [options] [command] [args...]
Optionen:
  -h, --help           Diesen Hilfetext anzeigen
  -V, --version        Versionsnummer ausgeben und beenden
  -u, --username       Benutzername (standard: momentaner Benutzer)
  -p, --password       Passwort (standard: Passwort interaktiv abfragen)
  -a, --address        URL des {opsiconfd} (standard: https://localhost:4447/rpc)
      --opsirc         Pfad zur zu verwendende opsirc-Datei (Standard: ~/.opsi.org/opsirc)
                       Eine opsirc-Datei beinhaltet Zugangsdaten für die Web API.
  -d, --direct         {opsiconfd} umgehen
      --no-depot       Depotserver-Backend nicht verwenden
  -l, --log-level      Protokollierungsstufe (Standard: 3)
                       0=nichts, 1=essenziell, 2=kritisch, 3=Fehler, 4=Warnungen
                       5=Hinweise, 6=Informationen, 7=debug, 8=debug2, 9=vertraulich
  -f, --log-file       Pfad zur Protokolldatei
  -i, --interactive    Im interaktiven Modus starten
  -c, --colorize       Farbige Ausgabe
  -S, --simple-output  Einfache Ausgabe (nur für Skalare und Listen)
  -s, --shell-output   Shell-Ausgabe
  -r, --raw-output     Rohdaten-Ausgabe
  --exit-zero          Beende immer mit Exit-Code 0.
----

´opsi-admin´ kann auf einen {opsi-webservice} zugreifen oder direkt auf der Datenhaltung arbeiten.
Für die Arbeit über den Webservice müssen neben der URL auch 'username' und 'password' angegeben werden.
Als Benutzername wird der Name des aktuell angemeldeten Benutzers verwendet.
Ein abweichender Name kann mittels `--username` angegeben werden.

Für die Verwendung in Scripten wird man besonders das Kennwort nicht direkt über die Kommandozeile
angeben wollen, weil die Gefahr besteht, dass diese Werte in der Prozessliste von
anderen Benutzern gesehen werden können.
Es bietet sich dabei an eine <<opsi-manual-configuration-tools-opsi-admin-opsirc,opsirc-Datei>> zu verwenden.
Als Alternative kann der direkte Datenzugriff über die Option `-d` verwendet werden.

`opsi-admin` bietet einen interaktiven Modus an, welcher mit `-i` gestartet wird.
In der Regel wird man diesen zusätzlich mit `-c` zur farbigen Anzeige und manchmal zusätzlich mit `-d` für direkten Datenzugriff starten wollen - der Befehl lautet dann `opsi-admin -i -c -d`, kurz `opsi-admin -idc`.
Im interaktiven Modus erhalten Sie Eingabe-Unterstützung durch die Tabtaste.
Betätigen der Tabtaste führt auf eine Auswahl der der möglichen Fortsetzungen der Eingabe
bzw. die Angabe des Datentyps der nächsten erwarteten Eingabe.
In der Liste der möglichen Eingaben können Sie mit Bild-auf und Bild-ab blättern.

Die Optionen `-s` und `-S` erzeugen eine Form der Ausgabe welche sich leichter in Skripten weiterverarbeiten lässt.

Außer den Methodenaufrufen (eingeleitet mit `method`), welche direkt die API widerspiegeln, gibt
es Aufrufe (eingeleitet mit `task`),
die intern auf eine Kombination von Methodenaufrufen zur Erledigung
einer bestimmten Aufgabe abgebildet werden.


[[opsi-manual-configuration-tools-opsi-admin-opsirc]]
=== Verwendung einer Verbindungskonfigurationsdatei - opsirc

Seit Version 4.1.1.30 bietet `opsi-admin` die Möglichkeit die Konfiguration
für die Verbindung zum opsi Webservice in einer Datei zu speichern.
Damit ist es möglich eine Verbindung über den Webservice zu verwenden,
ohne dass Benutzername und Kennwort auf der Kommandozeile angegeben werden.

Eine solche Datei wird standardmäßig in `~/.opsi.org/opsirc` gesucht.
Mit der Option `--opsirc` kann der Pfad zur zu verwendenden Datei angegeben werden.
Dadurch können mehrere, unterschiedlich konfigurierte Verbindungen
vorbereitet werden.

Eine _opsirc_-Datei hat den folgenden Aufbau:
[source,ini]
----
address = https://seeing.the.ramp:4447/rpc
username = tony
password file = ~/.opsi.org/tonys_secret
----

Alle Angaben in einer opsirc-Datei sind optional.
Falls die Datei leer oder nicht vorhanden ist, so werden die Standard-Einstellungen verwenden.

In vorangegangenen Beispiel ist das Kennwort in der Datei `~/.opsi.org/tonys_secret` hinterlegt
und wird von dort ausgelesen.
Diese Datei enthält nur das Kennwort.

Es ist ebenfalls möglich das Passwort direkt anzugeben:
[source,ini]
----
address = https://seeing.the.ramp:4447/rpc
username = tony
password = first900
----


[[opsi-manual-configuration-tools-opsi-admin-typical-usage]]
=== Typische Verwendung


[[opsi-manual-configuration-tools-opsi-admin-typical-usage-setup]]
.Ein Produkt für alle Clients auf setup stellen, welche dieses Produkt installiert haben:

[source,shell]
----
opsi-admin -d task setupWhereInstalled "softprod"
----


[[opsi-manual-configuration-tools-opsi-admin-typical-usage-clientlist]]
.Liste aller Clients

[source,shell]
----
opsi-admin -d method host_getIdents
----


[[opsi-manual-configuration-tools-opsi-admin-typical-usage-delete-client]]
.Client löschen

[source,shell]
----
opsi-admin -d method host_delete <clientname>
----

z.B.:

[source,shell]
----
opsi-admin -d method host_delete "pxevm.uib.local"
----


[[opsi-manual-configuration-tools-opsi-admin-typical-usage-create-client]]
.Client anlegen

[source,shell]
----
opsi-admin -d method host_createOpsiClient <full qualified clientname>
----

z.B.:

[source,shell]
----
opsi-admin -d method host_createOpsiClient "pxevm.uib.local"
----


[[opsi-manual-configuration-tools-opsi-admin-typical-usage-setProductActionRequest]]
.Action Request setzen

[source,shell]
----
opsi-admin -d method setProductActionRequest <productId> <clientId> <actionRequest>
----

z.B.:

[source,shell]
----
opsi-admin -d method setProductActionRequest win7 pxevm.uib.local setup
----


[[opsi-manual-configuration-tools-opsi-admin-typical-usage-setHostDescription]]
.Beschreibungen den Clients zuordnen

[source,shell]
----
opsi-admin -d method setHostDescription "dpvm02.uib.local" "virtueller Client"
----

[[opsi-manual-configuration-tools-opsi-admin-typical-usage-list-host-ids]]
.IDs aller Clients auflisten

Hierzu wird die Option `-S` verwendet, um zu erreichen, dass jeder Client in einer eigenen Zeile ausgeben wird. Durch die Eingrenzung auf den Typ `OpsiClient` wird verhindert, dass {opsi-server} mit ausgegeben werden.

Diese Ausgabe eignet sich zur Weiterverwendung in anderen Aufrufen.

[source,shell]
----
opsi-admin -dS method host_getIdents '' '{"type": "OpsiClient"}'
----

[[opsi-manual-configuration-tools-opsi-admin-typical-list-installed-products]]
.Auflisten der auf Clients installierten Produkte

[source,shell]
----
opsi-admin -d method productOnClient_getObjects '["productVersion", "packageVersion", "installationStatus"]' '{"installationStatus": "installed"}'
----

[[opsi-manual-configuration-tools-opsi-admin-typical-setPcpatchPassword]]
.Pcpatch-Passwort setzen

[source,shell]
----
opsi-admin -d task setPcpatchPassword
----

Setzt das Passwort von pcpatch für Unix, samba und opsi.


[[opsi-manual-configuration-tools-serverprocesses]]
== Serverprozesse: {opsiconfd} und {opsipxeconfd}

Der 'opsipxeconfd' dient zur Bereitstellung von 'named pipes' im `tftpboot`-Bereich,
welche den Bootvorgang eines PCs über das PXE-Protokoll steuern.

Die zugehörige Konfigurationsdatei ist `/etc/opsi/opsipxeconfd.conf`, die Logdatei
`/var/log/opsi/opsipxeconfd.log`.

Der 'opsiconfd' dient zur Bereitstellung der {opsi-server}-API als JSON-Webservice
und nimmt noch eine Reihe weiterer Aufgaben wahr.

Dieser Dienst ist damit der zentrale opsi-Dienst.
Über ihn wird z.B. sämtliche Kommunikation zwischen den Clients und dem Server abgewickelt.

Daher ist die Möglichkeit, diesen Prozess und seine Last zu überwachen, ein wichtiges Werkzeug.




[[opsi-manual-configuration-tools-serverprocess-tftpd]]
== Serverprozess: opsi-tftpd-hpa

Der opsi-tftpd-hpa ist ein standard tftpd-hpa, welche um die Fähigkeit erweitert wurde mit _named pipes_ umzugehen.

Per default wird der opsi-tftpd-hpa so installiert, daß er standardmäßig läuft und per systemd service file gestartet oder gestoppt werden kann.

Für gewöhnlich startet der Dienst mit einem Verbose Parameter. Zur Fehlersuche oder zur weiteren Analyse kann der Dienst mehr loggen. Hierfür muss folgender Befehl eingegeben werden:
[source,shell]
----
# systemctl edit --full opsi-tftpd-hpa.service
----
Nun muss der Parameter '-v' durch den Parameter '--verbosity 7' ersetzt werden. Daraufhin genügt es den Dienst neu zu starten
[source,shell]
----
# service opsi-tftpd-hpa restart
----

WARNING: auf Debian 8 ist die Operation _edit_ nicht verfügbar. Hier die Befehle zum Ändern des Parameters:
[source,shell]
----
# cp /lib/systemd/system/opsi-tftpd-hpa.service /etc/systemd/system/opsi-tftpd-hpa.service
# vi /etc/systemd/system/opsi-tftpd-hpa.service
# systemctl daemon-reload
# service opsi-tftpd-hpa restart
----
