////
; Copyright (c) uib GmbH (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: https://www.opsi.org/credits/
////

:Author:    uib GmbH
:Email:     info@uib.de
:Date:      30.05.2023
:Revision:  4.3
:toclevels: 6
:doctype:   book
:icons:     font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]


[[server-components-opsiconfd]]
= Der Dienst *opsiconfd*

Der zentrale Dienst auf jedem opsi-Server ist der `opsiconfd`. Er stellt über HTTPS (Port 4447) verschiedene Services bereit:

* */rpc*: JSON-RPC API
* */dav*: WebDAV-Zugriff auf Workbench, Repository, Depot, Boot-Verzeichnis
* */admin*: xref:server:components/opsiconfd.adoc#server-components-opsiconfd-admin-page[Admin-Seite] für Status-Informationen und Administrations-Aufgaben
* */grafana*: Reverse-Proxy-Zugriff auf einen lokalen Grafana-Server
* */status*: einfache Statusausgabe für Monitoring-Werkzeuge
* */public*: öffentliche Dateifreigabe ohne Authentifizierung

NOTE: Sie können den `opsiconfd` über Add-ons erweitern. So ist beispielsweise das opsi-WebGUI ein solches Add-on. Mehr dazu lesen Sie in Abschnitt ##.
//TODO: Add link

== Kommandozeilen-Interface

Der `opsiconfd` besitzt ein Kommandozeilen-Interface, das die folgenden Befehle bereitstellt:

* `start`: Startet den `opsiconfd` (Standardkommando).
* `stop`: Stoppt einen laufenden `opsiconfd`.
* `force-stop`: Wie `stop`, bricht zusätzlich aktive Client-Verbindungen ab.
* `status`: Zeigt den Service-Status an (`systemctl status`).
* `restart`: Startet den `opsiconfd`-Service neu (`systemctl restart`).
* `reload`: Sendet ein `SIGHUP`-Signal an laufende `opsiconfd`-(Worker-)Prozesse. Die Prozesse lesen die Konfigurationsdateien daraufhin neu ein.
//TODO: Links am Ende checken
* `setup`: Startet ein xref:server:configuration/opsiconfd.adoc#server-configuration-opsiconfd-setup[`opsiconfd setup`].
* `log-viewer`: Gibt die xref:server:configuration/opsiconfd.adoc#opsiconfd-logs[opsiconfd-Logs] im Terminal aus.
* `health-check`: Startet einen xref:server:components/opsiconfd.adoc#server-components-opsiconfd-health-check[opsiconfd Health-Check].
* `backup`: Erstellt ein xref:server:components/backup.adoc#server-components-opsiconfd-backup[opsiconfd-Backup].
* `restore`: Stellt ein xref:server:components/backup.adoc#server-components-opsiconfd-backup[opsiconfd-Backup] wieder her.

[[server-components-opsiconfd-server-id-role]]
== Server-Rolle

Ein opsi-Server kann die Rolle eines opsi-Configservers oder die eines opsi-Depotservers übernehmen. Die Konfigurationsdatei `/etc/opsi/opsi.conf` legt die Rolle fest. Ab opsi 4.3 definiert diese Konfigurationsdatei auch die ID des Servers.

NOTE: Wenn Sie den opsi-Server als Docker-Container betreiben, steuern Umgebungsvariablen das Verhalten (siehe Abschnitt xref:modules:server/installation/docker.adoc#server-installation-docker-compose[Docker Compose]).

Beispiel für einen opsi-Configserver:

[source,toml]
----
[host]
id = "opsi.domain.tld"
key = "5b4324721a114195098bdaf3fab54a9f"
server-role = "configserver"

[service]
url = "https://localhost:4447"
----

Beispiel für einen opsi-Depotserver:

[source,toml]
----
[host]
id = "opsi-depot.domain.tld"
key = "a1b5098fabcaf315b13249cba1a24d17"
server-role = "depotserver"

[service]
url = "https://opsi.domain.tld:4447"
----

NOTE: Ab opsi 4.3 löst die Datei `/etc/opsi/opsi.conf` die Datei `/etc/opsi/backends/jsonrpc.conf` ab.

[[server-components-opsiconfd-config]]
== Konfiguration

Den `opsiconfd` können Sie über die Datei `/etc/opsi/opsiconfd.conf`, über Umgebungsvariablen oder über Kommandozeilen-Parameter beim Aufruf konfigurieren. Dabei gilt die folgende Reihenfolge:

. Einträge in der Konfigurationsdatei überschreiben die Standardeinstellungen.
. Umgebungsvariablen überschreiben Einträge in der Konfigurationsdatei.
. Kommandozeilen-Parameter überschreiben Umgebungsvariablen.

TIPP: Eine Liste aller Konfigurationsoptionen erhalten Sie am schnellsten, wenn Sie den folgenden Befehl in ein Terminalfenster eingeben:

// cSpell:disable
[source,shell]
----
opsiconfd --help
...
--admin-networks ADMIN_NETWORKS [ADMIN_NETWORKS ...]
                A list of network addresses from which administrative connections are allowed.
                [env var: OPSICONFD_ADMIN_NETWORKS]
                (default: ['0.0.0.0/0', '::/0'])
...
----
// cSpell:enable

In der Ausgabe sehen Sie jeweils den Namen der Option (`admin-networks`) und den dazugehörigen Namen der Umgebungsvariable in Großbuchstaben (hier: `ADMIN_NETWORKS`). Der Kommandozeilenparameter verwendet vorangestellte `--`, während diese in der Konfigurationsdatei entfallen. Für die im letzten Listing gezeigte Option sieht das also so aus:

* In der Konfigurationsdatei `/etc/opsi/opsiconfd.conf` steht z.{nbsp}B.: +
[source,configfile]
----
admin-networks = [10.1.1.0/24,192.168.1.0/24]
----
* Umgebungsvariable: +
[source,console]
----
OPSICONFD_ADMIN_NETWORKS="[10.1.1.0/24,192.168.1.0/24]"
----
* Kommandozeilenparameter: +
[source,console]
----
opsiconfd --admin-networks 10.1.1.0/24 192.168.1.0/24
----

NOTE: Änderungen an der Konfiguration können Sie in der Regel im laufenden Betrieb über den Befehl `opsiconfd reload` übernehmen. Einige Parameter erfordern jedoch einen Neustart über `opsiconfd restart`.

[[server-components-opsiconfd-admin-page]]
== Admin-Seite

Die `opsiconfd`-Admin-Seite stellt Status-Informationen und Administrations-Aufgaben zum `opsiconfd` im Webbrowser zur Verfügung.
Der Zugriff erfolgt über `\https://<opsi-server>:4447/admin`; Benutzer müssen Mitglied der opsi-Admin-Gruppe sein.
//TODO: add link zu Autorisierung?


[[server-components-opsiconfd-admin-page-licensing]]
=== Tab: Licensing

Im Tab *Licensing* kann eingesehen werden welche xref:opsi-modules:modules.adoc[opsi-Erweiterungen] lizenziert sind.

Außerdem können hier Lizenz-Dateien im *opsilic*-Format eingespielt werden.

NOTE: Lizenz-Dateien im alten `modules`-Format können hier nicht eingespielt werden.
Eine `modules`-Lizenz-Datei kann jedoch weiterhin verwendet werden, muss aber manuell unter `/etc/opsi/modules` auf dem opsi-Configserver abgelegt werden.
Wenden Sie sich an mailto:sales@uib.de[sales@uib.de] um eine Lizenz-Datei im neuen Format zu erhalten.


[[server-components-opsiconfd-admin-page-clients]]
=== Tab: Clients
Auf der Seite werden Informationen über Verbundene Clients und Sessions angezeigt.
Gesperrte Clients werden in einer separaten Liste angezeigt.
Einzelne Clients können über die IP-Adresse oder über den Button *unblock* in der Liste freigegeben werden.
Über *Unblock all clients* können alle gesperrten Client auf einmal entsperrt werden.

Zum Löschen aller Sessions eines Clients, wird in der Zeile *Delete client sessions* die Adresse des Clients angegeben und der Vorgang mit *Execute* bestätigt.

.'opsiconfd': Gesperrte Clients
image:opsi-webinterface-blocked-clients.png["opsiconfd: Gesperrte Clients", pdfwidth=90%]


[[server-components-opsiconfd-admin-page-rpc-info]]
=== Tab: RPC-Info
Hier befindet sich eine Tabelle der letzten RPC-Aufrufe.
Die Tabelle lässt sich durch einen Klick auf die Header-Leiste sortieren.

.*opsiconfd*: RPC-Liste
image:opsi-webinterface-rpc-list.png["opsiconfd: RPC Liste", pdfwidth=90%]


[[server-components-opsiconfd-admin-page-rpc-interface]]
=== Tab: RPC-Interface
Auf dieser Seite werden alle zur Verfügung stehenden Methoden der JSONRPC-API (Remote-Procedure-Calls) aufgeführt.
Bei der Auswahl einer Methode aus der Liste, wird deren Dokumentation und die verfügbaren Parameter angezeigt.

Parameter müssen JSON-kodiert übergeben werden.
Mit einem Klick auf den Button *Execute* wird der RPC ausgeführt.

Die Anfrage und das Ergebnis werden auf der Seite im JSON-Format dargestellt.

.*opsiconfd*: RPC-Interface
image:opsi-webinterface-rpc-interface.png["opsiconfd: RPC-Interface", pdfwidth=90%]


[[server-components-opsiconfd-admin-page-redis-interface]]
=== Tab: Redis-Interface
Hier können Redis-Status-Informationen angezeigt und Redis-Befehle ausgeführt werden.
Die Antwort des Servers wird JSON-kodiert angezeigt.

.*opsiconfd*: Redis-Interface
image:opsi-webinterface-redis.png["opsiconfd: Redis-Interface", pdfwidth=90%]


[[server-components-opsiconfd-admin-page-grafana]]
=== Tab: Grafana

Der Tab *Grafana* leitet Sie zum xref:server:components/grafana.adoc[Grafana-Dashboard] weiter.

Beim Klick auf den Tab wird auf dem Grafana-Server das *opsiconfd main dashboard* angelegt bzw. aktualisiert.
Weiterhin wird der Benutzer *opsidashboard* angelegt, der für den Zugriff auf das Dashboard verwendet wird.

[[server-components-opsiconfd-health-check]]
== opsiconfd Health-Check
////
TODO
////
Health-Check

[[server-components-opsiconfd-logs]]
== Logfiles

// cSpell:ignore log-viewer
//TODO: Link zu Redis-Kapitel einfügen
Die Protokollierung des Dienstes findet normalerweise mit Redis statt. Darüber hinaus legt der `opsiconfd` im Verzeichnis `/var/log/opsi/opsiconfd` eigene Logfiles ab.

NOTE: Wenn Probleme mit dem Zugriff auf Redis bestehen, findet keine Protokollierung statt. Um dennoch Logfiles zu generieren, können Sie den Parameter `log-mode` auf `local` stellen.



