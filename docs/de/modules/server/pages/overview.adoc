////
; Copyright (c) uib gmbh (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: http://www.opsi.org/credits/
////


:Author:    uib gmbh
:Email:     info@uib.de
:Date:      08.05.2023
:Revision:  4.3
:toclevels: 6
:doctype:   book
:icons:     font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]



= {opsi-server}

[[opsi-manual-server-overview]]
==  Überblick

*{opsi-configserver}*
Die zentrale Steuerungs-Komponente jeder opsi-Umgebung ist der {opsi-configserver}.
Es gibt in jeder Umgebung nur einen {opsi-configserver}.
Der {opsi-configserver} stellt die Konfigurations- und Statusdaten über eine API zur Verfügung.
Alle Server-, Client- und Management-Komponenten sind über diese zentrale API gekoppelt.
Ein {opsi-configserver} übernimmt in der Regel auch zusätzlich die Rolle eines {opsi-depotserver}s.

*{opsi-depotserver}*
Ein {opsi-depotserver} stellt Dateien der zu verteilenden Software, Betriebssysteme und Bootimages zur Verfügung.
Zusätzlich kann er weitere benötigte Dienste (z.B. DHCP-Server) zur Verfügung stellen.
Der {opsi-depotserver} ist über den opsi-Messagebus mit dem {opsi-configserver} verbunden und wird von diesem gesteuert.
{opsi-depotserver} kommen oft in Außenstellen zum Einsatz um einen performanten Zugriff auf Dateien und Services im LAN zu gewährleisten.


Hier finden Sie weitere Informationen:

* xref:server:installation/installation.adoc[Installation und Inbetriebnahme eines {opsi-server}s]

////
TODO: Kapitel zu Architektur / technischen Details

Seit Version 4.2 wird die In-Memory-Datenbank Redis eingesetzt (https://redis.io/). Der _{opsi-server}_ speichert folgende Daten in Redis:

* Session Daten

* Log-Ausgaben werden MessagePack-codiert in einen Redis-Stream geschrieben. Dieser Stream wird dann z. B. vom Logviewer gelesen (https://msgpack.org/).

* Statistiken wie zB. CPU Auslastung werden als Time Series in Redis gespeichert. Hierzu wird das Modul RedisTimeSeries verwendet (https://github.com/RedisTimeSeries/RedisTimeSeries).

Die Statistiken werden von Grafana (https://grafana.com/) ausgelesen und angezeigt. Das Grafana Dashboard ist über die Adminseite https://<opsi-server>:4447/admin erreichbar.

image::grafana_dashboard.png["Grafana Dashboard", pdfwidth=90%]

[[opsi-manual-server-installation]]
=== Installation und Inbetriebnahme
Die Installation und Inbetriebnahme eines _{opsi-server}s_ ist in dem gesonderten Handbuch: _opsi-getting-started_ ausführlich erläutert.

[[opsi-manual-server-samba]]
=== Samba Konfiguration
Um den Client-PCs Zugriff auf die Softwarepakete zu ermöglichen, stellt der opsi-server Shares bereit, die von den Clients als Netzlaufwerke gemountet werden können. Für die Windows-Clients wird dazu die Software Samba eingesetzt.
Die Korrekte Sambakonfiguration können Sie erstellen bzw. reparieren durch den Aufruf von:
[source,shell]
----
opsi-setup --auto-configure-samba
----

Nach einer Änderung der Samba-Konfigurationsdateien ist ein Neustart der Samba-Software notwendig (`systemctl restart smbd.service`).

[[opsi-manual-server-opsiconfd]]
=== Der Daemon {opsiconfd}
Der _opsiconfd_ ist der zentrale Konfigurations-Daemon von opsi.
Alle Client-Komponenten ({opsi-client-agent}, {opsi-configed}, {opsi-linux-bootimage}, ...) verbinden sich mit diesem Service um auf die Konfigurationen in den Backends zuzugreifen.
Der _opsiconfd_ wird über die Datei `/etc/opsi/opsiconfd.conf`, über Umgebungsvariablen oder über Kommandozeilen-Parameter konfiguriert.

Die einzelnen Konfigurations-Optionen können über den Befehl `opsiconfd --help` abgefragt werden. Um Optionen bei jedem Start des _opsiconfd_ zu verwenden, können die Option aus dem Hilfetext ohne das `--` in die Konfigurationsdatei eingetragen werden.

Außerdem ist es möglich, die Umgebungsvariablen, wie im Hilfetext gezeigt, zu verwenden.

Werden die einzelnen Ansätze miteinander kombiniert, gilt die folgende Reihenfolge:
Einträge in der Konfigurationsdatei überschreiben die Defaults,
Umgebungsvariablen überschreiben Einträge in der Konfigurationsdatei, Kommandozeilen-Parameter überschreiben Umgebungsvariablen.


[[opsi-manual-server-accounts]]
=== Notwendige System-User und Gruppen

* User _opsiconfd_ +
Dies ist der user unter dem der {opsiconfd} Daemon läuft.

* User _pcpatch_ +
Dies ist der user, den der _{opsi-client-agent}_ verwendet um den _depotshare_ zu mounten und von diesem zu lesen.
Dieser User hat per Voreinstellung das Heimatverzeichnis `/var/lib/opsi`.
Das Passwort des Benutzers kann mittels `opsi-admin -d task setPcpatchPassword` gesetzt werden.

* Gruppe _opsifileadmins_ +
Mitglieder dieser Gruppe haben Zugriff auf eine opsi-Paket-Daten, wie Depot, Repository und Workbench. Die Systemadministratoren des {opsi-server}s sollten daher Mitglieder dieser Gruppe sein.

Ehemals hieß diese Gruppe _pcpatch_, seit opsi 4.2 wird standardmäßig _opsifileadmins_ als Gruppenname verwendet. Wird eine bestehende opsi-Umgebung auf opsi 4.2 aktualisiert wird der verwendete Gruppenname jedoch beibehalten.

Bei Anbindung des {opsi-server}s an ein Active Directory muss in jedem Fall der Gruppenname _opsifileadmins_ verwendet werden.

* Gruppe _opsiadmin_ +
Die Mitglieder dieser Gruppe können sich gegenüber dem opsi-webservice authentifizieren und damit z.B. mit dem {opsi-configed} arbeiten. Daher sollten alle Mitarbeiter die mit opsi arbeiten, Mitglied dieser Gruppe sein.

[[opsi-manual-server-shares]]
=== Notwendige Shares

* Bereich: _Depotshare_ mit Softwarepaketen (_opsi_depot_) +
Auf dem depot-Share liegen die für die Installation durch das Programm opsi Winst vorbereiteten Softwarepakete. +
In der Voreinstellung liegt dieses Verzeichnis auf dem opsi-server unter `/var/lib/opsi/depot`. +
Unterhalb von diesem Verzeichnis findet sich für jedes Softwarepaket ein Verzeichnis mit dem Namen des Softwarepakets. +
Wiederum unterhalb dieses Verzeichnisses liegen dann die Installationsskripte und -dateien.
+
Das Verzeichnis wird mit dem Freigabe-Namen _opsi_depot_ per Samba read-only exportiert.
+
NOTE: In alten Versionen von opsi war das entsprechende Verzeichnis `/opt/pcbin` und der Share hieß 'opt_pcbin'.

* Bereich: Arbeitsverzeichnis zum Pakethandling (_opsi_workbench_) +
Unter `/var/lib/opsi/workbench` ist der Bereich um Pakete zu erstellen und in dem Pakete vor der Installation mit opsi-package-manager abgelegt werden sollen.
Dieses Verzeichnis ist als share _opsi_workbench_ freigegeben.
+
NOTE: Seit opsi 4.1 kann der Pfad Depot-spezifisch über das Attribut `workbenchLocalUrl` konfiguriert werden.

* Bereich: Konfigurationsdateien {file-backend} (_opsi_config_) +
Unter `/var/lib/opsi/config` liegen die Konfigurationsdateien des file Backends.
Dieses Verzeichnis ist als share _opsi_config_ freigegeben.
+
WARNING: Wenn Sie über diesen Share auf den Dateien arbeiten, verwenden Sie keine Editoren die das Dateiformat (Unix/DOS) verändern und entfernen Sie Sicherungsdateien wie z.B. *.bak.

////