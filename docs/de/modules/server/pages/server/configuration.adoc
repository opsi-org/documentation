////
; Copyright (c) uib gmbh (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: https://www.opsi.org/credits/
////

:Author:    uib gmbh
:Email:     info@uib.de
:Date:      02.05.2023
:Revision:  4.2
:toclevels: 6
:doctype:   book
:icons: font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]

[[opsi-getting-started-installation-config]]
= Konfiguration

Dieses Kapitel erklärt zuerst, wie Sie einen frisch installierten {opsi-server} aktualisieren und dann die Standard-Produkte einspielen. Danach geht es um die Backend- und die Samba-Konfiguration des {opsi-server}s, um Benutzer und Gruppen zur Administration, die DHCP-Konfiguration und die Namensauflösung.

[[opsi-getting-started-installation-config-update-server]]
== {opsi-server} aktualisieren

Bevor Sie den {opsi-server} konfigurieren, bringen sie zunächst die Pakete des zugrundeliegenden Linux-Systems auf den aktuellen Stand. Wenn Sie die von uns bereitgestellte virtuelle Maschine verwenden (siehe Abschnitt xref:getting-started:server/base-installation.adoc#opsi-getting-started-installation-base-vm[Inbetriebnahme der vorkonfigurierten virtuellen Maschine]), dann nutzen Sie dazu das Paketverwaltungstool APT, denn die VM basiert auf der letzten LTS-Version von Ubuntu. APT verwenden Sie ebenfalls zum Aktualisieren von Debian und anderen Ubuntu-Versionen. Der letzte Befehl deinstalliert nicht mehr benötigte Pakete, die als Abhängigkeit installiert waren:

[source,prompt]
----
sudo apt update
sudo apt upgrade
sudo apt autoremove
----

TIP: Wenn Sie unsere vorkonfigurierte virtuelle Maschine einsetzen, dann können Sie das Symbol _Update OS_ auf dem Desktophintergrund zur Aktualisierung der Pakete verwenden. Doppelklicken Sie es und geben dann das Kennwort des Benutzers `adminuser` ein.

Verwenden Sie SLES/openSUSE, dann nutzen Sie das Werkzeug `zypper`:

[source,prompt]
----
sudo zypper refresh
sudo zypper update
----

Unter RHEL/AlmaLinux/Rocky Linux heißen die Befehle zum Aktualisieren der Distribution so:

[source,prompt]
----
sudo yum check-update
sudo yum update
----

Nachdem das Upgrade abgeschlossen ist, starten Sie den Server neu.

NOTE: Falls Sie einen Proxy-Server zum Zugriff auf das Internet verwenden, konfigurieren Sie diesen über die Umgebungsvariablen `http_proxy` und `https_proxy` (siehe Kapitel xref:getting-started:server/requirements.adoc[Voraussetzungen]).

[[opsi-getting-started-installation-config-update-opsi-product]]
== Standard-Produkte einspielen

Nach der Installation des {opsi-server}s und der Aktualisierung des zugrundeliegenden Linux-Systems spielen Sie die opsi-Standard-Produkte ein. Dazu geben Sie den folgenden Befehl in ein Terminalfenster ein:

[source,prompt]
----
sudo opsi-package-updater -v install
----

Auf Aufforderung geben Sie das Passwort für den Benutzer `adminuser` ein.

Das Kommando aktualisiert alle vorhandenen opsi-Pakete inklusive der Templates für Betriebssystem-Installationen aus den opsi-Repositorys.

.Innstallieren Sie die Standard-Produkte auf Ihrem opsi-Server.
image::opsi-package-updater.png["Installieren Sie die Standard-Produkte auf Ihrem opsi-Server.", pdfwidth=80%]

TIP: Auf unserer vorkonfigurierten virtuellen Maschine können Sie alternativ das Desktop-Icon _First package installation_ doppelklicken, um die Standard-Produkte zu installieren.

[[opsi-getting-started-installation-config-update-start-configed]]
== Management-Oberfläche starten

Die Management-Oberfläche `opsi-configed` starten Sie in der virtuellen Maschine über einen Doppelklick auf das Desktopsymbol _Opsi Configuration Editor_. Weitere Informationen zu dieser grafischen Anwendung finden Sie in xref:manual:configed.adoc[Management-Oberfläche `opsi-configed`].

[[opsi-getting-started-installation-configure-mysql]]
== MySQL konfigurieren

Läuft der MySQL-Service auf der gleichen Maschine wie der opsiconfd, findet die Konfiguration des MySQL-Server in der Regel vollautomatisch statt. Falls notwendig, kann eine manuelle Konfiguration jederzeit durch den Aufruf des folgenden Befehls vorgenommen werden:

[source,prompt]
----
opsiconfd setup --configure-mysql
----

Das Programm führt Sie dann interaktiv durch die Einrichtung.

=== Passwort für Benutzer `pcpatch`

Auf dem {opsi-server} gibt es einen Benutzer `pcpatch`. Bei Verwendung von CIFS für den Zugriff auf das opsi-Depot verwenden die Clients nutzen diesen Account bei der Installation von Softwarepaketen und haben nach der Anmeldung Zugriff auf die Installationsdateien auf den hierfür vorgesehenen Freigaben. Der Benutzer `pcpatch` benötigt ein Passwort, das für den System-Account, den Samba-Account und für den opsi-Account gilt. Sie setzen dieses Kennwort für alle drei Konten mit dem Tool `opsi-admin` in einem einzigen Aufruf:

[source,prompt]
----
opsi-admin -d task setPcpatchPassword
----

Nach dem Betätigen von [Eingabe] erscheint ein Passwort-Prompt, und Sie können das Kennwort eintippen.

[[opsi-getting-started-installation-config-users-and-groups]]
== Benutzer und Gruppen für opsi

NOTE: Auf der vorkonfigurierten virtuellen Maschine sind der Account `adminuser` sowie die beiden Gruppen `opsiadmin` und `opsifileadmins` bereits eingerichtet, sodass Sie diesen Abschnitt überspringen können.

Um den {opsi-server} zu administrieren, muss ein Benutzer Mitglied der Gruppe `opsiadmin` sein. Das folgende Kommando erstellt einen neuen Benutzeraccount namens `adminuser`; Sie führen es als `root` aus:

[source,prompt]
----
useradd -m -s /bin/bash adminuser
----

Anschließend setzen Sie für den neuen Account ein Unix-Passwort (System):

[source,prompt]
----
passwd adminuser
----

Außerdem benötigt der Account ein Passwort für Samba:

[source,prompt]
----
smbpasswd -a adminuser
----

WARNING: Verwenden Sie in den beiden Passwörtern kein `§`-Zeichen!

Als Nächstes fügen Sie den Account `adminuser` der Gruppe `opsiadmin` hinzu:

[source,prompt]
----
usermod -aG opsiadmin adminuser
----

Sie können mit dem `getent`-Befehl überprüfen, dass alles geklappt hat:

[source,prompt]
----
getent group opsiadmin
opsiadmin:x:1001:opsiconfd,adminuser,root
----

NOTE: Wenn `root` nicht Mitglied der Gruppe `opsiadmin` ist, kann der Benutzer unter Umständen nicht alle opsi-Administrations-Kommandos ausführen!

Für alltägliche Arbeiten auf Ihrem {opsi-server} ist es in der Regel nicht notwendig, als `root` zu arbeiten.
Wir empfehlen, sich als normaler Benutzer anzumelden und `sudo` vor die Kommandos zu stellen, die Root-Rechte benötigen.

Alle Benutzer, die Produkte packen (`opsi-makepackage`), installieren (`opsi-package-manager`) oder Konfigurationsdateien im Texteditor bearbeiten, müssen zusätzlich Mitglied in der Gruppe `opsifileadmins` sein:

[source,prompt]
----
usermod -aG opsifileadmins adminuser
----

Sie können wiederum `getent` zur Kontrolle verwenden:

[source,prompt]
----
getent group opsifileadmins
opsifileadmins:x:999:adminuser,root
----

[[opsi-getting-started-installation-config-dhcp]]
== DHCP-Konfiguration

Eine korrekt funktionierende Namensauflösung (siehe Abschnitt <<opsi-getting-started-installation-config-nameresolution>>) und DHCP (Dynamic Host Configuration Protocol) sind wichtig, damit opsi korrekt funktioniert. In diesem Abschnitt geht es um DHCP: Das Protokoll sorgt dafür, dass neu eingebundene Geräte im Netzwerk automatisch konfiguriert werden. Dazu gehören etwa die dynamische Zuweisung von IP-Adressen, Netzmaske, Gateway usw.

Der {opsi-server} kann als DHCP-Server arbeiten und angeschlossene Clients automatisch konfigurieren (Abschnitt <<opsi-getting-started-installation-config-dhcp-at-opsi>>). In vielen Umgebungen ist bereits ein DHCP-Server vorhanden; daher beschreibt Abschnitt <<opsi-getting-started-installation-config-at-other-server>>, wie Sie diesen nutzen.

[[opsi-getting-started-installation-config-dhcp-at-opsi]]
=== DHCP auf dem {opsi-server}

NOTE: Die vorkonfigurierte virtuelle Maschine ist bereits mit einem DHCP-Server ausgestattet, der keine freien Leases hat, also keine IP-Adressen an unbekannte Clients vergibt. Wenn Sie über die Management-Oberfläche `opsi-configed` einen Client erzeugen, geben Sie daher dessen IP- und die MAC-Adresse an, um sie in die Konfigurationsdatei `/etc/dhcp/dhcpd.conf` einzutragen und den DHCP-Dienst neu zu starten.

Wenn Sie den {opsi-server} selbst installiert haben und als DHCP-Server verwenden möchten, installieren Sie das Paket `isc-dhcp-server` bzw. `dhcp-server`.

Auf Debian-basierten Systemen geben Sie dazu das folgende Kommando ein:

[source,prompt]
----
apt install isc-dhcp-server
----

TIP: Auf vielen Distributionen heißt das Paket stattdessen `dhcp-server` (RHEL, Rocky Linux, AlmaLinux, SLES usw.) -- schauen Sie im Zweifelsfall im Handbuch bzw. in den Paketquellen des Linux-Systems nach.


[[opsi-getting-started-installation-config-at-other-server]]
=== Externen DHCP-Server nutzen

NOTE: Den DHCP-Server der vorkonfigurierten virtuellen Maschine deinstallieren Sie mit dem folgenden Befehl:

[source,prompt]
----
apt remove isc-dhcp-server
----

Gibt es in Ihrem Netzwerk bereits einen DHCP-Server, dann konfigurieren Sie diesen so, dass er ein PXE-Boot über den {opsi-server} ermöglicht. Läuft der Dienst auf einem Linux-Rechner, dann passen Sie die Konfigurationsdatei `/etc/dhcp/dhcpd.conf` an und tragen Folgendes ein:

[source,configfile]
----
next-server <IP-opsi-Server>;
filename "linux/pxelinux.0";
----

Ersetzen Sie `<IP-opsi-Server>` durch die IP-Adresse Ihres {opsi-server}s.

Unter openSUSE und SLES lautet die zweite Zeile so:

[source,configfile]
----
filename=opsi/pxelinux.0
----

Unter UCS sieht die Zeile so aus:

[source,configfile]
----
filename=pxelinux.0
----

Bei einem Windows-Server sind die entsprechenden Einträge `Startserver (Option 66)` und `Startfile (Option 67)`.

NOTE: Wenn Sie einen externen DHCP-Server nutzen, geben Sie beim Erstellen eines Clients in der Management-Oberfläche `opsi-configed` dessen MAC-Adresse an, aber keine IP-Adresse.

[[opsi-getting-started-installation-config-dhcp-backend]]
=== Backend anpassen

Je nachdem, ob Sie den DHCP-Server auf dem {opsi-server} oder als externen Dienst verwenden, sieht die Backend-Konfiguration anders aus. In der Datei `/etc/opsi/backendManager/dispatch.conf` legen Sie fest, welche opsi-Backends zum Einsatz kommen (siehe auch Abschnitt <<opsi-getting-started-installation-config-backend>>).

Die beiden Zeilen `backend_.*` und `host_.*` steuern, ob der {opsi-server} auch die lokale DHCP-Konfiguration, also die Zuweisung von IP-Adressen zu den MAC-Adressen der Netzwerkkarten, übernimmt. Das ist dann notwendig, wenn die DHCP-Einträge der opsi-Clients durch die opsi-Konfigurations-Aufrufe erzeugt werden sollen. In dem Fall sehen die beiden Zeilen in der Datei `dispatch.conf` so aus:

[source,configfile]
----
backend_.*         : file, opsipxeconfd, dhcpd
host_.*            : file, opsipxeconfd, dhcpd
----

Stellt der {opsi-server} den DHCP-Dienst nicht bereit (weil ein anderer Server im lokalen Netz diese Aufgabe übernimmt), dann benötigen Sie das Backend `dhcpd` nicht:

[source,configfile]
----
backend_.*         : file, {opsipxeconfd}
host_.*            : file, {opsipxeconfd}
----

NOTE: Wenn Sie die Datei `dispatch.conf` bearbeitet haben, führen Sie anschließend die folgenden Befehle aus, um die Konfiguration zu initialisieren und opsi neu zu starten:

[source,prompt]
----
opsi-setup --init-current-config
opsi-set-rights
systemctl restart opsiconfd.service
systemctl restart opsipxeconfd.service
----

[[opsi-getting-started-installation-config-nameresolution]]
== Namensauflösung

Um Software auf den opsi-Clients vor dem Login installieren zu können, müssen nur die Clients wissen, wie sie den {opsi-server} erreichen.

NOTE: opsi kennt inzwischen eine Reihe von Push-Funktionalitäten, wie z.{nbsp}B. On-Demand-Installationen, Nachrichten versenden, Remote-Control-Software starten, Session-Informationen abrufen usw.

Für all diese Funktionen muss der Server die Clients erreichen können und dazu deren IP-Adresse ermitteln. Im Netzwerk müssen daher DHCP und DNS entsprechend konfiguriert sein. Dazu gibt es mehrere Möglichkeiten -- zwei typische Szenarien sind diese:

. Die Clients sind nicht im DNS und haben dynamisch zugewiesene, wechselnde IP-Adressen.

. Die IP-Adressen aller laufenden Clients sind stets bekannt und lassen sich per DNS abfragen.

Um den {opsi-server} nun an die unterschiedlichen Gegebenheiten anzupassen, gibt es zwei Konfigurationsdateien, die Sie ändern können:

* `/etc/opsi/backends/hostcontrol.conf`: +
Setzen Sie `resolveHostAddress` auf `True`, dann wird beim Verbindungsaufbau vom {opsi-server} zum opsi-Client die IP-Adresse des Clients bevorzugt über die Namensauflösung ermittelt. Um die im Backend von opsi hinterlegte IP-Adresse zu bevorzugen, setzen Sie die Option hingegen auf `False`.

* `/etc/opsi/opsiconfd.conf`: +
Steht die Option `update-ip` auf `true` (Standard), dann wird die IP-Datenbank des {opsi-server}s immer aktualisiert, wenn der {opsi-server} von einem Client eine IP-Adresse empfängt, z.{nbsp}B. bei jeder Kontaktaufnahme.

Für die oben aufgeführte Variante 1 ist es sinnvoll `resolveHostAddress` auf `False` und `update-ip` auf `true` zu setzen.

Für die oben aufgeführte Variante 2 ist es besser, `resolveHostAddress` auf `True` zu setzen und `update-ip` auf `false`.

Wenn Sie an diesen Konfigurationsdateien etwas geändert haben, dann starten Sie den `opsiconfd` neu:

[source,prompt]
----
systemctl restart opsiconfd.service
----
