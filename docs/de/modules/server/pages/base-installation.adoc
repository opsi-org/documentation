////
; Copyright (c) uib gmbh (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: https://www.opsi.org/credits/
////

:Author:    uib gmbh
:Email:     info@uib.de
:Date:      24.04.2023
:Revision:  4.2
:toclevels: 6
:doctype:   book
:icons: font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]

[[opsi-getting-started-installation-base]]
= Installation

Dieses Kapitel stellt verschiedene Varianten zur Installation des {opsi-server}s vor. Als Erstes erklärt es die <<opsi-getting-started-installation-base-vm>>, danach geht es um
//<<opsi-getting-started-installation-base-docker>> und um
<<opsi-getting-started-installation-base-quickinstall>>, die <<opsi-getting-started-installation-base-packages>> unter Debian, Ubuntu, openSUSE/Suse Linux Enterprise Server (SLES), CentOS, Red Hat Enterprise Linux (RHEL), AlmaLinux, Rocky Linux sowie die <<opsi-getting-started-installation-base-ucs>>.

include::server:partial$vm-installation.adoc[]

[[opsi-getting-started-installation-base-quickinstall]]
== opsi-QuickInstall

opsi-QuickInstall installiert schnell und einfach einen {opsi-server} unter Linux -- über ein grafisches Setup-Programm oder auf der Kommandozeile. Sie finden das Programm auf unseren Servern unter dem folgenden Link: https://download.uib.de/opsi4.2/stable/quickinstall/

[[opsi-getting-started-installation-base-quickinstall-download]]
=== QuickInstall herunterladen und entpacken

Laden Sie die Zip-Datei herunter und entpacken sie, z.{nbsp}B. mit diesem Kommando:

[source,prompt]
----
unzip opsi-quick-install.zip
----

Alternativ entpacken Sie das Archiv über den Dateimanager Ihrer grafischen Desktopumgebung (Rechtsklick / _Hier entpacken_). opsi-QuickInstall können Sie mit einer grafischen Oberfläche oder über die Kommandozeile installieren. Die nächsten beiden Abschnitte beschreiben beide Varianten.

NOTE: Der Installer fragt nach so genannten Propertys. Weitere Informationen dazu finden Sie in Abschnitt xref:opsi-modules:linux.adoc#opsi-manual-linux-localboot-l-opsi-server[Das Produkt `l-opsi-server`]. Dort können Sie auch die Default-Werte der Propertys nachlesen. Beachten Sie, dass für opsi-QuickInstall der Standard für `allow_reboot` auf `false` gesetzt ist.

[[opsi-getting-started-installation-base-quickinstall-gui]]
=== Grafisches Setup-Programm

. Wechseln Sie im Dateimanager Ihrer Desktopumgebung ins Verzeichnis `gui` und führen Sie den Installer `opsi_quick_install_project` aus, z.{nbsp}B. mit einem Doppelklick.

. Im sich öffnenden Dialogfenster wählen Sie aus dem oberen Drop-down-Menü die Sprache für das Setup-Programm aus. Außerdem wählen Sie den _Setup-Typ_ aus. Wenn Sie sich hier für _Benutzerdefiniert_ entscheiden, dann können Sie detailliertere Einstellungen vornehmen.
+
.Wählen Sie die Sprache und die Art der Installation aus.
image::oqi.png["Wählen Sie die Sprache und die Art der Installation aus.", pdfwidth=80%]

. Klicken Sie auf _weiter >_ und füllen Sie die Dialoge aus.
+
TIP: Neben einigen Feldern finden Sie ein `i`-Symbol, das einen Tooltip mit weiteren Informationen zum Thema einblendet.
+
[[Information]]
.Fahren Sie mit der Maus über das kleine Symbol, um weitere Informationen einzublenden.
image::oqiInfo.png["Fahren Sie mit der Maus über das kleine Symbol, um weitere Informationen einzublenden.", pdfwidth=80%]

. Im letzten Dialog füllen Sie unter anderem die Felder opsi-Admin-User und opsi-Admin-Passwort aus.
+
IMPORTANT: Wählen Sie unbedingt einen anderen Namen und ein starkes Passwort und nicht das in diesem Beispiel (<<Information>>) gezeigte.

. Klicken Sie auf _Übersicht_, um Ihre Angaben noch einmal zu kontrollieren. Wenn alles korrekt ist, klicken Sie auf _fertigstellen_, geben Ihr Passwort ein und bestätigen mit einem erneuten Klick auf _fertigstellen_. Danach startet die opsi-Server-Installation.

.Die opsi-server-Installation läuft.
image::quickinstall_l-opsi-server.png["Die opsi-server-Installation läuft.", pdfwidth=80%]

Die Installation kann einige Minuten dauern. Am Ende zeigt Ihnen opsi-QuickInstall an, ob sie erfolgreich war. Erhalten Sie die Meldung `success`, dann ist Ihr {opsi-server} betriebsbereit und fertig konfiguriert.

Erhalten Sie stattdessen eine Fehlermeldung wie in <<oqiFailed>>, geben die Logdateien Hinweise auf mögliche Fehler. Die Protokolle finden Sie in den beiden Dateien `/var/log/opsi-quick-install-l-opsi-server.log` und `/tmp/opsi_quickinstall.log`.

[[oqiFailed]]
.Falls die Installation fehlschlägt, finden Sie in den Logdateien mögliche Fehlerursachen.
image::oqiFailed.png["Falls die Installation fehlschlägt, finden Sie in den Logdateien mögliche Fehlerursachen.", pdfwidth=80%]

[[opsi-getting-started-installation-base-quickinstall-nogui]]
=== Installation auf der Kommandozeile

Im Verzeichnis `nogui` finden Sie das Programm `opsi_quick_install_project`, das die folgenden Parameter kennt:

* `-d`: Das Setup-Programm verwendet die Standardwerte für die opsi-Server-Installation. Es richtet den opsi-Admin-Benutzer mit dem Benutzernamen `Alexandra` (opsi-QuickInstall Version 4.2.0.1) bzw. `adminuser` (ab Version 4.2.0.1-2) und dem Passwort `linux123` ein.
+
IMPORTANT: Aus Sicherheitsgründen ändern Sie diese Werte unbedingt nach der Installation.
* `-f <file>`: Das Setup-Programm verwendet die Werte aus der angegebenen Datei für die opsi-Server-Installation.
* `-n`: Das Setup-Programm startet in interaktiven Modus und erfragt die Werte für die Installation (_empfohlen_).

Um das Setup-Programm im interaktiven Modus zu starten, geben Sie diesen Befehl ein:

[source,prompt]
----
sudo ./opsi_quick_install_project -n
----

Danach beantworten Sie die Fragen. Sie haben jederzeit die Möglichkeit, folgende Befehle einzugeben:

* `-b`: springt zur vorigen Frage zurück
* `-h`: blendet bei Fragen, die mit einem `*` gekennzeichnet sind, weitere Informationen ein
* [Eingabe]: übernimmt die Standardwerte für eine Frage

Am Ende sehen Sie eine Zusammenfassung und können Ihre Antworten noch einmal kontrollieren. Haben Sie alles richtig eingegeben, starten Sie über [Eingabe] die Installation.

Die Installation kann einige Minuten dauern. Am Ende zeigt Ihnen opsi-QuickInstall an, ob sie erfolgreich war. Erhalten Sie die Meldung `success`, dann ist Ihr {opsi-server} betriebsbereit und fertig konfiguriert.

Erhalten Sie stattdessen die Meldung `failed`, finden Sie in den Logdateien `/var/log/opsi-quick-install-l-opsi-server.log` und `/tmp/opsi_quickinstall.log` Hinweise auf mögliche Fehler.

.Das Setup-Programm gibt Hinweise auf Fehler und Logdateien.
image::quickinstallNoGuiFailed.png["Das Setup-Programm gibt Hinweise auf Fehler und Logdateien.", pdfwidth=80%]


[[opsi-getting-started-installation-base-docker]]
== opsi als Docker-Container

Seit 2022 gibt es ein link:https://github.com/opsi-org/opsi-docker[Docker-Image], mit dem Sie einen Config-Server oder einen Depot-Server einrichten können. Es setzt auf das Orchestrierungswerkzeug Docker Compose, das es ermöglicht, mehrere Container zu definieren, diese miteinander zu verbinden und auf einem Docker-Host auszuführen. Sie benötigen mindestens Docker Compose 1.17.0 und die Docker-Engine 17.09.0 oder neuer.

NOTE: Beachten Sie, dass ausschließlich WebDAV als Protokoll zur Kommunikation mit dem opsi-Depot zum Einsatz kommt; eine Samba-Unterstützung gibt es in dieser Variante (noch) nicht. Außerdem benötigen Sie eine Lizenz für die MySQL-Erweiterung, denn das File Backend wird nicht unterstützt (siehe Kapitel xref:opsi-modules:modules.adoc[opsi-Erweiterungen]).

Installieren Sie Docker bzw. Docker Desktop unter Linux, Windows oder macOS. Dass die Installation erfolgreich war, können Sie schnell im Terminal überprüfen und den folgenden Befehl eingeben:

[source,prompt]
----
docker run --rm hello-world
----

Als Antwort sollten Sie diese Ausgabe sehen:

[source,prompt]
----
Hello from Docker!
This message shows that your installation appears to be working correctly.
[...]
----

[[opsi-getting-started-installation-base-docker-quick]]
=== Quick Start

Um den Docker-Container in Betrieb zu nehmen, sind lediglich drei Befehle nötig:

[source,prompt]
----
git clone https://github.com/opsi-org/opsi-docker.git
cd opsi-docker/opsi-server
./opsi-server.sh start
----

[[opsi-getting-started-installation-base-docker-compose]]
=== Docker Compose

Die Konfigurationsdatei `docker-compose.yml` definiert Netzwerke, Volumes und diese vier Dienste (Abschnitt `services`):

* `mysql`: installiert den Datenbankserver MariaDB
* `redis`: installiert die In-Memory-Datenbank Redis mit dem RedisTimeSeries-Modul
* `grafana`: spielt ein aktuelles Grafana ein
* `opsi-server`: installiert die Pakete `opsiconfd`, `opsipxeconfd`, `opsi-tftpd-hpa` und `opsi-utils` in der jeweils aktuellsten Version

Am Anfang der Datei sind einige X Properties (sog. Extension fields) definiert, z.{nbsp}B. `x-restart-policy`, `x-common-variables` usw. Diese YAML-Anker kommen zum Einsatz, um Einstellungen zwischen den Diensten auszutauschen.

NOTE: Aus Sicherheitsgründen sollten Sie alle Passwörter in der Datei `docker-compose.yml` ändern: `MYSQL_ROOT_PASSWORD`, `MYSQL_PASSWORD`, `REDIS_PASSWORD`, `GF_SECURITY_ADMIN_PASSWORD` und `OPSI_ADMIN_PASSWORD`.

Ein Kennwort für den Benutzer `root` ist nicht gesetzt. Sie können dieses über `OPSI_ROOT_PASSWORD` festlegen:

[source,prompt]
----
OPSI_ROOT_PASSWORD: <passwort>
----

TIP: Wenn Sie TFTP-Netzwerk-Boot (und damit `opsipxeconfd` und `opsi-tftp-hpa`) nicht benötigen, können Sie die Variable `OPSI_TFTPBOOT` auf `"false"` setzen.

Die nächsten beiden Abschnitte erklären, wie Sie die Konfigurationsdatei `docker-compose.yml` anpassen, um einen Config-Server oder einen Depot-Server aufzusetzen.

[[opsi-getting-started-installation-base-docker-compose-config]]
==== Config-Server

Nachdem Sie die Einstellungen für den Hostnamen und die Domain im Bereich `opsi-server` an Ihr Netzwerk angepasst haben, setzen Sie die Variable `OPSI_HOST_ROLE` auf `configserver`:

[source,prompt]
----
OPSI_HOST_ROLE: configserver
----

Unter Linux und macOS starten Sie alle Dienste über `./opsi-server.sh start`, unter Windows mit dem Befehl `.\opsi-server.ps1 start` (siehe Abschnitt <<opsi-getting-started-installation-base-docker-scripts>>). Den Status des Containers überprüfen Sie mit dem Befehl `./opsi-server.sh status` (Linux, macOS) bzw. `.\opsi-server.ps1 status`, und die Logfiles betrachten Sie mit `./opsi-server.sh logs` bzw. `.\opsi-server.ps1 logs`.

.Überprüfen Sie den Status und die Logfiles mit dem Skript `opsi-server.sh`.
image::opsi-server-script.png["Überprüfen Sie den Status und die Logfiles mit dem Skript `opsi-server.sh`.", pdfwidth=80%]

[[opsi-getting-started-installation-base-docker-compose-depot]]
==== Depot-Server

Kontrollieren Sie die Einstellungen für Netzwerk und Volumes. Die beiden Dienste `mysql` und `grafana` benötigen Sie für einen Depot-Server nicht, daher können Sie diese auskommentieren oder löschen. Achten Sie darauf, `mysql` dann auch im Abschnitt `opsi-server` aus dem `depends_on`-Attribut zu entfernen.

Setzen Sie die Variable `OPSI_HOST_ROLE` auf `depotserver`:

[source,prompt]
----
OPSI_HOST_ROLE: depotserver
----

Für einen Depot-Server setzen Sie außerdem die beiden Variablen `OPSI_SERVICE_ADDRESS` (IP-Adresse des opsi-Config-Servers) und `OPSI_HOST_KEY` (Host-Key des Depots). Danach starten Sie alle Dienste über `./opsi-server.sh start` (Linux, macOS) bzw. `.\opsi-server.ps1 start` (Windows).

[[opsi-getting-started-installation-base-docker-scripts]]
=== Die Helfer-Skripte

Wir haben zwei Helfer-Skripte beigelegt, die den Umgang mit dem opsi-Docker-Container erleichtern. Wenn Sie Linux oder macOS verwenden, verwenden Sie das Skript `opsi-server.sh`. Machen Sie dieses zunächst ausführbar:

[source,prompt]
----
chmod +x opsi-server.sh
----

Danach rufen Sie es als normaler Benutzer ohne weitere Parameter oder Optionen auf, um eine Onlinehilfe einzublenden:

[source,prompt]
----
./opsi-server.sh
Usage: ./opsi-server.sh <command>

Commands:
  edit                      Edit docker-compose.yml.
  start                     Start all containers.
  status                    Show running containers.
  stop                      Stop all containers.
  logs [service]            Attach to container logs (all logs or supplied service).
  shell [service]           Exexute a shell in a running container (default service: opsi-server).
  update                    Update and restart all containers.
  open-volumes              Open volumes directory in explorer.
  inspect [service]         Show detailed container informations (default service: opsi-server).
  diff [service]            Show container's filesystem changes (default service: opsi-server).
  prune                     Delete all containers and unassociated volumes.
  export-images             Export images as archive.
  import-images [archive]   Import images from archive.
  build [--no-cache]        Build opsi-server image. Use --no-cache to build without cache.
  publish                   Publish opsi-server image.
----

Das zweite Skript `opsi-server.ps1` ist für Windows-Anwender und den Einsatz auf der Windows PowerShell gedacht. Es hat im Wesentlichen die gleichen Optionen und Parameter -- lediglich die letzten beiden Kommandos (`build` und `publish`) sind nicht verfügbar.


[[opsi-getting-started-installation-base-packages]]
== Paketbasierte Installation

Sie können den {opsi-server} auch über die jeweilige Paketverwaltung Ihrer Linux-Distribution installieren. Die Abläufe auf den verschiedenen Systemen sind weitgehend gleich:

* fehlende Software installieren
* unsere Paketquelle (Repository) hinzufügen
* Liste der installierbaren Pakete aktualisieren
* eines der opsi-Server-Pakete installieren: `opsi-server-full`, `opsi-server` oder `opsi-server-expert` (siehe Abschnitt <<opsi-getting-started-installation-base-prerequires>>)

[[opsi-getting-started-installation-base-prerequires]]
=== Vorbereitungen

Der {opsi-server} benötigt Zugriff auf eine Redis- und eine Grafana-Instanz. Wir gehen im Folgenden davon aus, dass diese beiden Dienste auch auf dem {opsi-server} laufen. In dem Fall können Sie das Paket `opsi-server-full` installieren, das alle notwendigen Anwendungen einspielt und konfiguriert. Wir bezeichnen das in den einzelnen Abschnitten als _Single-Server-Setup_. Wenn Sie hingegen Dienste wie Redis, MySQL/MariaDB oder Grafana auf einem anderen Server betreiben, spielen Sie stattdessen `opsi-server` oder `opsi-server-expert` ein.

TIP: Nutzen Sie zur Installation von Grafana die offiziellen Grafana-Repositorys. Wenn Sie eine Debian-basierte Distribution einsetzen, beachten Sie, dass die Repositorys im November 2022 von `packages.grafana.com` nach `apt.grafana.com` umgezogen sind. Die alten Adressen funktionieren noch, aber es kann bei der Installation oder Aktualisierung zu Warnungen auf dem System kommen.

==== Debian/Ubuntu/UCS

[source,bash]
----
sudo mkdir -p /usr/local/share/keyrings
REPO_URL=https://apt.grafana.com
REPO_KEY=/usr/local/share/keyrings/grafana.gpg
sudo apt-get install -y apt-transport-https software-properties-common curl gpg
curl -fsSL ${REPO_URL}/gpg.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL} stable main" > /etc/apt/sources.list.d/grafana.list
----

==== SLES/openSUSE

[source,bash]
----
zypper install wget
cd /etc/zypp/repos.d
cat <<EOF > grafana.repo
[grafana]
name=grafana
baseurl=https://rpm.grafana.com
repo_gpgcheck=1
enabled=1
gpgcheck=1
gpgkey=https://rpm.grafana.com/gpg.key
sslverify=1
sslcacert=/etc/pki/tls/certs/ca-bundle.crt
EOF
----

==== RHEL/AlmaLinux/Rocky Linux

[source,bash]
----
yum install wget
cd /etc/yum.repos.d
cat <<EOF > grafana.repo
[grafana]
name=grafana
baseurl=https://rpm.grafana.com/
repo_gpgcheck=1
enabled=1
gpgcheck=1
gpgkey=https://rpm.grafana.com/gpg.key
sslverify=1
sslcacert=/etc/pki/tls/certs/ca-bundle.crt
EOF
----

[[opsi-getting-started-installation-base-deb]]
=== Installation unter Debian/Ubuntu

Wir empfehlen zunächst, folgende Pakete zu installieren:

[source,bash]
----
apt install host pigz apt-transport-https software-properties-common curl gpg
----

Falls noch nicht geschehen, legen Sie das Verzeichnis `/usr/local/share/keyrings` an:

[source,bash]
----
mkdir -p /usr/local/share/keyrings
----


Fügen Sie nun das opsi-Repository zu den APT-Paketquellen hinzu:

*Debian 11 _Bullseye_:*
[source,bash]
[subs="attributes"]
----
REPO_URL=https://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/{release}/Debian_11
REPO_KEY=/usr/local/share/keyrings/opsi.gpg
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL}/ /" > /etc/apt/sources.list.d/opsi.list
curl -fsSL ${REPO_URL}/Release.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
----

*Debian 10 _Buster_:*
[source,bash]
[subs="attributes"]
----
REPO_URL=https://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/{release}/Debian_10
REPO_KEY=/usr/local/share/keyrings/opsi.gpg
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL}/ /" > /etc/apt/sources.list.d/opsi.list
curl -fsSL ${REPO_URL}/Release.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
----

*Ubuntu 22.04 LTS _Jammy Jellyfish_:*
[source,bash]
[subs="attributes"]
----
REPO_URL=https://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/{release}/xUbuntu_22.04
REPO_KEY=/usr/local/share/keyrings/opsi.gpg
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL}/ /" > /etc/apt/sources.list.d/opsi.list
curl -fsSL ${REPO_URL}/Release.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
----

*Ubuntu 20.04 LTS _Focal Fossa_:*
[source,bash]
[subs="attributes"]
----
REPO_URL=https://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/{release}/xUbuntu_20.04
REPO_KEY=/usr/local/share/keyrings/opsi.gpg
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL}/ /" > /etc/apt/sources.list.d/opsi.list
curl -fsSL ${REPO_URL}/Release.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
----

Prüfen Sie, ob der Import des GnuPG-Schlüssels erfolgreich war:

[source,bash]
----
gpg /usr/local/share/keyrings/opsi.gpg 2>/dev/null
----

In der Ausgabe sollten unter anderem folgende Zeilen auftauchen:

[source,bash]
----
pub   rsa2048 2017-09-30 [SC] [expires: 2023-11-09]
      2E98F7B5A5B2C8FE7F609705D1F933E6D8361F81
uid           home:uibmz:opsi OBS Project <home:uibmz:opsi@build.opensuse.org>
----

Installieren Sie jetzt eines der opsi-Server-Pakete:

*Single-Server-Setup:*
[source,prompt]
----
apt update
apt install opsi-server-full
----


TIP: Falls bei der Installation eine Frage nach dem TFTP-Basisverzeichnis auftaucht, geben Sie `/tftpboot` ein.

[[opsi-getting-started-installation-base-opensuse-sles]]
=== Installation unter SLES/openSUSE

* Soll die Maschine auch als DHCP-Server eingesetzt werden, muss der Daemon `dhcpd` konfiguriert sein und laufen.

So fügen Sie das opsi-Repository per `zypper` hinzu:

*openSUSE Leap 15.4:*
[source,prompt]
[subs="attributes"]
----
zypper addrepo https://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/openSUSE_Leap_15.4/home:uibmz:opsi:4.2:{release}.repo
----

*SLES 15 SP1:*
[source,prompt]
[subs="attributes"]
----
zypper addrepo http://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/SLE_15_SP1/home:uibmz:opsi:4.2:{release}.repo
----

*SLES 15 SP2:*
[source,prompt]
[subs="attributes"]
----
zypper addrepo http://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/SLE_15_SP2/home:uibmz:opsi:4.2:{release}.repo
----

*SLES 15 SP3:*
[source,prompt]
[subs="attributes"]
----
zypper addrepo http://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/SLE_15_SP3/home:uibmz:opsi:4.2:{release}.repo
----

*SLES 15 SP4:*
[source,prompt]
[subs="attributes"]
----
zypper addrepo http://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/SLE_15_SP4/home:uibmz:opsi:4.2:{release}.repo
----

Nach dem Hinzufügen der Repositorys können Sie die Installation starten:

*Single-Server-Setup:*
[source,prompt]
----
zypper refresh
  Wollen Sie den Schlüssel (a)bweisen, ihm (t)emporär oder (i)mmer vertrauen? [a/t/i/?] (a): i
zypper -v install opsi-server-full
----


NOTE: Stellen Sie sicher, dass Ihre Firewall-Konfiguration Verbindungen zu den Ports 69/UDP (TFTP) sowie 4447/TCP und 4441/TCP (opsi) zulässt.


[[opsi-getting-started-installation-base-centos-rhel]]
=== Installation unter RHEL/AlmaLinux/Rocky Linux

Die Installation unter Red Hat Enterprise Linux (RHEL), AlmaLinux und Rocky Linux läuft weitgehend gleich ab. Unterschiede gibt es lediglich beim verwendeten Repository.

NOTE: Wenn Sie Red Hat Enterprise Linux einsetzen, müssen Sie sich beim Red Hat Network registrieren, um Zugriff auf alle benötigten Pakete zu haben: +
[source,prompt]
----
subscription-manager register
subscription-manager attach --auto
----

Notwendige Vorbereitungen:

* Samba und Datenbankserver installieren:
+
[source,prompt]
----
yum install mariadb-server samba samba-client
----

* Samba und Datenbankserver konfigurieren:
+
[source,prompt]
----
systemctl start smb.service
systemctl start nmb.service
systemctl start mariadb.service
systemctl enable smb.service
systemctl enable nmb.service
systemctl enable mariadb.service
mysql_secure_installation
----

* Soll die Maschine auch als DHCP-Server eingesetzt werden, muss der Daemon `dhcpd` konfiguriert sein und laufen.

So fügen Sie das opsi-Repository hinzu:

*RHEL 9:*
[source,prompt]
[subs="attributes"]
----
cd /etc/yum.repos.d/
wget https://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/RHEL_9/home:uibmz:opsi:4.2:{release}.repo
yum makecache
----

*RHEL 8:*
[source,prompt]
[subs="attributes"]
----
cd /etc/yum.repos.d/
wget https://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/RHEL_8/home:uibmz:opsi:4.2:{release}.repo
yum makecache
----

*AlmaLinux 9:*
[source,prompt]
[subs="attributes"]
----
cd /etc/yum.repos.d/
wget https://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/AlmaLinux_9/home:uibmz:opsi:4.2:{release}.repo
yum makecache
----

*AlmaLinux 8:*
[source,prompt]
[subs="attributes"]
----
cd /etc/yum.repos.d/
wget https://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/AlmaLinux_8/home:uibmz:opsi:4.2:{release}.repo
yum makecache
----

*Rocky Linux 9:*
[source,prompt]
[subs="attributes"]
----
cd /etc/yum.repos.d/
wget https://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/RockyLinux_9/home:uibmz:opsi:4.2:{release}.repo
yum makecache
----

*Rocky Linux 8:*
[source,prompt]
[subs="attributes"]
----
cd /etc/yum.repos.d/
wget https://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/RockyLinux_8/home:uibmz:opsi:4.2:{release}.repo
yum makecache
----

Nach dem Hinzufügen der Repositorys können Sie die Installation starten:

*Single-Server-Setup:*
[source,prompt]
----
yum install opsi-server-full
----

*Manuelles Setup:*
[source,prompt]
----
yum makecache
yum install redis-server redis-timeseries grafana.x86_64
systemctl daemon-reload
systemctl enable grafana-server
systemctl start grafana-server
yum install opsi-server
----

Es kann vorkommen, dass Sie beim Importieren des GnuPG-Schlüssel des Repositorys eine solche Meldung sehen:

[source,prompt]
----
   Importing GPG key 0xD8361F81 "home:uibmz OBS Project <home:uibmz@build.opensuse.org>" from http://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/stable/RockyLinux_8/repodata/repomd.xml.key
   Is this ok [y/N]: y
----

Geben Sie `y` ein und drücken [Eingabe], um das Hinzufügen des Schlüssels zu bestätigen.

NOTE: Stellen Sie sicher, dass Ihre Firewall und die SELinux-Konfiguration -Konfiguration Verbindungen zu den Ports 69/UDP (TFTP) sowie 4447/TCP und 4441/TCP (opsi) zulässt.

[[opsi-getting-started-installation-base-ucs]]
== Installation unter Univention Corporate Server (UCS)

Unter Univention Corporate Server (UCS) gibt es zwei Möglichkeiten, den {opsi-server} zu installieren:

* <<opsi-getting-started-installation-base-ucs-appcenter>> (nur UCS 5.0 oder neuer)
* <<opsi-getting-started-installation-base-ucs-manually>> über die uib-Repositorys (UCS 4.4 und 5.0)

Beide Varianten führen zu einem funktionierenden opsi-Server, sollten aber nicht zusammen auf einem Server laufen. Entscheiden Sie im Vorfeld, welche Installation zu Ihrer Umgebung passt. Wenn Sie opsi über das Univention App Center beziehen, dann kann es sein, dass Sie länger auf Aktualisierungen warten müssen. Der Wechsel auf eine neue UCS-Version (etwa von 4.4 auf 5.0) ist erst dann möglich, wenn alle installierten Apps unter der neuen UCS-Version zur Verfügung stehen. Entscheiden Sie sich für die Installation über die uib-Repositorys, erhalten Sie zeitnah Updates.


[[opsi-getting-started-installation-base-ucs-appcenter]]
==== Installation über das Univention App Center

Im link:https://www.univention.de/produkte/univention-app-center/app-katalog/opsi/[Univention App Center Katalog] finden Sie opsi für die UCS-Version 5.0. Bei der Installation spielt der Paketmanager automatisch weitere Pakete ein: `opsi-tftpd-hpa` und `univention-mariadb`.

NOTE: Der erste {opsi-server} einer UCS-Umgebung konfiguriert einen vorhandenen MariaDB-Server als Backend. Alle weiteren {opsi-server} registriert opsi als Depots. Gibt es also bei der Installation bereits einen {opsi-server} in der UCS-Umgebung, so wird das Tool `opsi-package-updater` so konfiguriert, dass es die Pakete von diesem Server bezieht.

[[opsi-getting-started-installation-base-ucs-manually]]
==== Manuelle Installation

Bevor Sie den {opsi-server} unter Univention Corporate Server von Hand installieren, treffen Sie ein paar Vorbereitungen:

* Samba muss installiert und konfiguriert sein. Ist der UCS-Server Mitglied einer AD-Domäne, installieren Sie `univention-samba`, das Samba als Mitgliedsserver ohne Domänen-Controller-Funktionalität einrichtet und konfiguriert. Das Paket `univention-samba4` hingegen richtet Samba als AD-Domänen-Controller ein.

* Ein MariaDB-Server muss installiert und konfiguriert sein. Installieren Sie dazu `univention-mariadb`; das Paket `univention-mysql` ist seit UCS 4.3 ein Metapaket, das den MariaDB-Server installiert.

* Soll der UCS-Rechner auch als DHCP-Server dienen, konfigurieren Sie vor der opsi-Installation den DHCP-Daemon und starten ihn.

Grundsätzlich ist die Installation auf Servern mit den UCS-Rollen Primary Directory Node, Backup Directory Node, Replica Directory Node und Managed Node möglich.

WARNING: Wenn Sie den {opsi-server} nicht auf einem Primary Directory Node, sondern auf einem Rechner mit einer anderen UCS-Systemrolle installieren, muss der UCS-Server vorher der Domäne beitreten.

Die Konfigurationsdatei `/etc/opsi/opsi.conf` definiert die Gruppe für den Samba-Zugriff auf die Freigaben; der Name ist `opsifileadmins`. Alle Anwender, die Zugriffsrechte für die Freigaben von opsi erhalten sollen (opsi-Paketierer), müssen dementsprechend Mitglied der Gruppe `opsifileadmins` sein.

So fügen Sie das opsi-Repository hinzu:

*Univention UCS 4.4:*
[source,bash]
[subs="attributes"]
----
REPO_URL=https://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/{release}/Univention_4.4
REPO_KEY=/usr/local/share/keyrings/opsi.gpg
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL}/ /" > /etc/apt/sources.list.d/opsi.list
curl -fsSL ${REPO_URL}/Release.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
----

*Univention UCS 5.0:*
[source,bash]
[subs="attributes"]
----
REPO_URL=https://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/{release}/Univention_5.0
REPO_KEY=/usr/local/share/keyrings/opsi.gpg
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL}/ /" > /etc/apt/sources.list.d/opsi.list
curl -fsSL ${REPO_URL}/Release.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
----

Nach dem Hinzufügen der Repositorys können Sie die Installation starten:

*Single-Server-Setup:*
[source,bash]
----
univention-install opsi-server-full
----


Wenn der {opsi-server} auf einer anderen UCS-Systemrolle als Primary Directory Node laufen soll, führen Sie zusätzlich den Befehl `univention-run-join-scripts` aus.

Benutzer müssen Mitglied der Gruppe `opsi-admin-group` sein, um den `opsi-configed` verwenden zu können. Während der Installation, wird der Benutzer `Administrator` automatisch zu dieser Gruppe hinzugefügt. Andere Accounts fügen Sie über das UMC-Modul _Benutzerverwaltung_ , Reiter _Gruppen_ hinzu.

Um sicherzustellen, dass alle opsi-Einstellungen korrekt übernommen wurden, führen Sie abschließend die folgenden Befehle aus:

[source,bash]
----
opsi-setup --init-current-config
opsi-set-rights
systemctl restart opsiconfd.service
systemctl restart opsipxeconfd.service
----

[[opsi-getting-started-installation-base-after]]
== Nach der Installation

Fahren Sie nun mit der Aktualisierung des Servers fort (Abschnitt xref:server:configuration.adoc#opsi-getting-started-installation-config-update-server[opsi-Server aktualisieren]). Danach können Sie die Standard-Produkte einspielen (Abschnitt xref:server:configuration.adoc#opsi-getting-started-installation-config-update-opsi-product[Standard-Produkte einspielen]).

== Hilfe und Support

Bei Problemen können Sie mit anderen aus der Community in unserem link:https://forum.opsi.org[Forum] diskutieren.

TIP: Wenn Sie einen Support-Vertrag haben, können Sie sich auch direkt an den link:https://www.uib.de/de/support-schulung/support[uib-Support] mit Ihren Fragen wenden.
