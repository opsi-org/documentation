////
; Copyright (c) uib gmbh (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: http://www.opsi.org/credits/
////

:Author:    uib gmbh
:Email:     info@uib.de
:Date:      10.02.2023
:Revision:  4.1.0
:toclevels: 6
:doctype: book

ifeval::["{mode}" == "antora"]
include::common:partial$opsi_terms.adoc[]
endif::[]

[[opsi-manual-licensemanagement]]
= Lizenzmanagement

Lizenzmanagement oder Software-Lizenzmanagement sichert den legalen Umgang mit proprietärer Software in Unternehmen und Organisationen ab. Idealerweise unterstützt das Lizenzmanagement unterschiedliche Lizenzmodelle und hilft den Verantwortlichen dabei, den Überblick über die im Unternehmen genutzte Software und die vorhandenen Lizenzen zu behalten. Mit einem guten Lizenzmanagement vermeiden Sie strafrechtliche Risiken und überflüssige Lizenzkosten.

[[opsi-manual-licensemanagement-preconditions]]
== Voraussetzungen

NOTE: Dieses Modul ist momentan eine https://opsi.org/extensions/[kostenpflichtige Erweiterung]. Das heißt, dass Sie eine Freischaltdatei benötigen. Sie erhalten diese, nachdem Sie die Erweiterung gekauft haben. Zu Evaluierungszwecken stellen wir Ihnen kostenlos eine zeitlich befristete Freischaltung zur Verfügung. Bitte kontaktieren Sie uns dazu per mailto:info@uib.de[E-Mail].

Weitere Details hierzu finden Sie im Kapitel xref:modules/modules#opsi-manual-modules[opsi-Erweiterungen].

[[opsi-manual-licensemanagement-overview]]
== Überblick

Das Lizenzmanagement-Modul erleichtert die aufwändige und komplexe Verwaltung von Lizenzen nicht-freier Software, die auf mit opsi verwalteten Clients installiert ist.

[[opsi-manual-licensemanagement-overview-features]]
=== Funktion und Features

Die wesentlichen Features dieser opsi-Erweiterung sind:

* Die Konfiguration der Lizenzverwaltung findet in derselben Oberfläche statt wie die Softwareverteilung und Betriebssystem-Installation (siehe Kapitel xref:configed[opsi-Management-GUI: `opsi-configed`]).

* Sie können komfortabel Berichte über die installierte lizenzpflichtige Software generieren, auch für nicht über opsi verteilte Software. Letzteres nutzt die Informationen aus der Software-Inventarisierung als Basis.

* Sie können Installationen und bestehende Lizenzverträge abgleichen.

* Optional können Sie Lizenzen und Lizenzschlüssel automatisch bereitstellen, zuteilen und reservieren.

=== Software-Lizenzmodelle

Ein Lizenzmodell legt fest, wer eine Software in welcher Form nutzen darf (siehe Abschnitt <<opsi-manual-licensemanagement-createlicense-model>>). Dabei gibt es ganz unterschiedliche Ansätze, wie die Softwarehersteller das regeln:

* Standard-Einzellizenz: eine Installation auf einem Rechner (mit individuellem Lizenzschlüssel)

* Volume-Lizenz: maximale Anzahl der Installationen ist festgelegt; als Campus-Lizenz gilt der Schlüssel für eine unbegrenzte Zahl von Installationen

* OEM-Lizenz: an einen Rechner gebundene Lizenz, Schlüssel gilt nur für bestimmte Hardware

* Concurrent-User-Lizenz: beliebige Installation der Software, ein Lizenzserver regelt die Anzahl der Nutzungen

Wenn der opsi-Server die Zuteilung der Lizenzen steuert, ist sichergestellt, dass die Lizenz und gegebenenfalls der Schlüssel bei der Deinstallation der Software auch wieder freigegeben werden. Die Zuordnung von Lizenzen kann darüber hinaus auch manuell oder sogar skriptgesteuert erfolgen, z.{nbsp}B. wenn eine Lizenz nicht mit opsi verteilt worden ist.

[[opsi-manual-licensemanagement-database-tables]]
=== Datenbankmodell zur Lizenzverwaltung

Lizenzverwaltung ist ein komplexes Thema. opsi setzt auf ein relativ komplexes Datenbankmodell, um die Lizenzen und ihre Schlüssel zu verwalten. Zur besseren Übersicht stellt das folgende Diagramm die beteiligten Tabellen dar. Die blaue Linie markiert die Abgrenzung von Tabellen, deren Inhalte automatisiert aus dem Software-Audit kommen, und Tabellen, deren Daten eigens zur Lizenzverwaltung erhoben oder zugeordnet werden. Nur die Lizenzpool-Datenbank hat Verbindungen zu beiden Bereichen, was auf die Bedeutung dieses Konstrukts hinweist.

.Für das Lizenzmanagement relevante Datenbanktabellen
image::mysql-schema-licensemanagement.png["Für das Lizenzmanagement relevante Datenbanktabellen"]

Das Diagramm zeigt außerdem die Bedeutung der Lizenzpools (license pools), die der Abschnitt <<opsi-manual-licensemanagement-licensepools>> ausführlich erklärt.

[[opsi-manual-licensemanagement-overview-start]]
=== Lizenzmanagement in `opsi-configed`

Die Management-Oberfläche `opsi-configed` bietet eine eigene Abteilung für das Lizenzmanagement an. Sie erreichen den Dialog über die Schaltfläche _Lizenzen_ im Hauptfenster. Voraussetzung ist, dass das die Erweiterung installiert und aktiviert ist. Sie überprüfen das über das Menü _Hilfe_ / _Module_ im Hauptfenster.

.`opsi-configed`: Das Lizenzmanagement erreichen Sie über das ganz rechte Symbol (_Lizenzen_).
image::opsi-configed-mode-selection.png["`opsi-configed`: Das Lizenzmanagement erreichen Sie über das ganz rechte Symbol (_Lizenzen_).", pdfwidth=50%, width=400]

Das Dialogfenster zur Lizenzverwaltung zeigt am oberen Rand sechs Reiter an:

* Lizenzpools
* Lizenz anlegen
* Lizenzen bearbeiten
* Lizenzenverwendung
* Abgleich mit Inventarisierung
* Statistik

Die folgenden Abschnitte erklären die einzelnen Dialoge und ihre Funktionen.

[[opsi-manual-licensemanagement-licensepools]]
== Lizenzpools

Der Reiter _Lizenzpools_ zeigt die Verknüpfungen der Lizenzpools mit den Informationen der opsi-Datenbank über installierte Software und Installationspakete.

[[opsi-manual-licensemanagement-licensepools-concept]]
=== Was ist ein Lizenzpool?

Für jede Art von Lizenz, die Sie mit dieser Erweiterung verwalten möchten, richten Sie einen eigenen Lizenzpool ein. Dieser beschreibt die Zusammenfassung von Berechtigungen, die benötigt werden, um eine bestimmte Art von Software legal zu installieren. Der Lizenzpool steht im Mittelpunkt aller Aktivitäten des opsi-Lizenzmanagements:

* Er verweist einerseits auf die installierten Software-Items und opsi-Installationspakete.
* Er fasst andererseits rechtliche und technische Konstruktionen der Installations-Berechtigungen zusammen.

.Der Reiter _Lizenzpools_
image::licensemanagement-licensepools.png["Der Reiter _Lizenzpools_", pdfwidth=80%]

[[opsi-manual-licensemanagement-licensepools-creation]]
=== Verwaltung von Lizenzpools

Ganz oben im Bereich _Lizenzpools_ finden Sie eine zweispaltige Tabelle, die alle verfügbaren Lizenzpools auflistet. Das Feld _description_ können Sie bearbeiten und dort eigene Beschreibungen eintragen.

Weitere Funktionen zum Bearbeiten erreichen Sie über das Kontextmenü der rechten Maustaste. Über die dort angezeigten Einträge legen Sie einen neuen Pool an, löschen einen vorhandenen, speichern oder verwerfen die Änderungen und laden die Daten neu.

Beim Erzeugen eines neuen Pools, also beim Anlegen einer neuen Zeile in der Tabelle, tragen Sie eine (eindeutige) _licensePoolId_ in das entsprechende Feld ein, beispielsweise `pool_fuer_x`.

NOTE: Achten Sie darauf, keine Umlaute für die IDs zu verwenden. Großbuchstaben werden automatisch in Kleinbuchstaben konvertiert!

Anders als die Beschreibung, können Sie die Pool-ID nur bis zum ersten Speichervorgang bearbeiten. Danach ist sie als Schlüssel des Datensatzes unveränderlich. Das Löschen eines Eintrags ist nur dann möglich, wenn es keine Referenz auf diesen Schlüssel in anderen Tabellen gibt. Die rekursive Suche nach solchen Referenzen wird derzeit nicht unterstützt.

Jeder Bearbeitungsvorgang verändert die Statusanzeige der beiden Schaltflächen _OK_ und _Cancel_. Das grüne Häkchen des _OK_-Buttons erscheint in Rot, und der _Cancel_-Button wird aktiviert. Betätigen Sie eine der beiden Schaltflächen oder wählen Sie den entsprechenden Eintrag aus dem Kontextmenü der rechten Maustaste aus, um Ihre Änderungen zu speichern oder zu widerrufen.

[[opsi-manual-licensemanagement-licensepools-opsiproducts]]
=== Lizenzpools und opsi-Produkte

Normalerweise gehört zu einem opsi-Produkt, das eine lizenzpflichtige Software installiert und dabei das Lizenzmanagement nutzen soll, genau ein Lizenzpool, aus dem die benötigten Lizenzen geschöpft werden. Es ist möglich, dass mehrere Produkte auf denselben Lizenzpool verweisen, wenn es sich z.{nbsp}B. um Varianten desselben Produktes handelt. So nutzen beispielsweise die Produkte `win10-x64` und `opsi-local-image-win10-x64` beide den Pool `p_win10-x64`.

Weniger übersichtlich ist die Situation, wenn ein opsi-Produkt mehrere lizenzpflichtige Software-Produkte installiert und daher Lizenzen von mehreren Pools benötigt. Angenommen, zu einem Paket namens _Designprogramme_ gehören Adobe Photoshop und Adobe Writer, muss das opsi-Produkt Lizenzen aus zwei unterschiedlichen Pools anfordern. Im Prinzip liegt diesen Zuordnungen ein n:m-Schema zugrunde.

TIP: Zur besseren Übersicht ordnen Sie bei lizenzpflichtiger Software immer nur ein Software-Produkt einem opsi-Produkt zu. Dieses eine opsi-Produkt binden Sie dann an den entsprechenden Lizenzpool. Zwingend notwendig ist diese Beschränkung, wenn Sie das Lizenzmanagement-Modul zusammen mit der xref:modules/wan-support#opsi-manual-wansupport[WAN/VPN-Erweiterung] verwenden.

Die zweite Tabelle von oben im Dialog _Lizenzpools_ (siehe <<licensemanagement-licensepools.png>>) zeigt alle Zuordnungen zwischen den Lizenzpools und den Produkt-IDs der opsi-Produkte. Klicken Sie auf den Spaltentitel _licensePoolId_ bzw. _productId_, um die Ansicht zu sortieren. So können Sie alle Zuordnungen von opsi-Produkten zu einem Lizenzpool bzw. alle einem opsi-Produkt zugewiesenen Lizenzpools zusammenhängend darstellen.

Einen neuen Eintrag, also eine neue Zuordnung eines Lizenzpools zu einer Produkt-ID, erstellen Sie über das Kontextmenü der rechten Maustaste. Nach einem Klick ins Tabellenfeld sehen Sie die Liste der verfügbaren Werte.

[[opsi-manual-licensemanagement-licensepools-softwareids]]
=== Lizenzpools und installierte Software

Die untere Hälfte des _Lizenzpools_-Dialogs (siehe <<licensemanagement-licensepools.png>>) stellt die Beziehungen zwischen Lizenzpools und der installierten Software auf den opsi-Clients dar -- egal, ob diese mit opsi-Werkzeugen oder auf einem anderen Weg installiert wurde. In den einzelnen Spalten sehen Sie zunächst eine eindeutige ID, die aus einer Kombination aller Attribute konstruiert ist und als eindeutiger Schlüssel fungiert. Es folgen Informationen zur Software, darunter den Namen, die Versionsnummer, das Betriebssystem, die Architektur usw.

Die Werte ermittelt das opsi-Software-Audit (siehe Abschnitt xref:manual/pages/products/localboot-products#opsi-manual-localboot-swaudit_hwaudit[Hard- und Software-Inventarisierung mit `hwaudit` und `swaudit`]); es liest Informationen aus der Registry aus und meldet diese an den opsi-Server zurück. Die Tabelle _SOFTWARE_CONFIG_ der opsi-Datenbank speichert die Werte für jeden Client. Sofern noch nicht vorhanden, werden sie in die Tabelle _SOFTWARE_ aufgenommen. Diese bildet die Grundlage für die im Lizenzmanagement angezeigte Tabelle.

Welche Daten Sie in der Tabelle unten im _Lizenzpools_-Dialogs sehen, bestimmen zwei verschiedene Ansichten:

* Beschränkung der Anzeige auf bestimmte Daten (_Alle anzeigen_, _Ausblenden von Software, die anderen Pools zugeordnet ist_, _Nur die keinem Pool zugeordnete Software zeigen_); das ist die Voreinstellung
* Beschreibung, was die Markierung von Zeilen bedeutet (_Auswahl = Gesamte Liste der zugewiesenen/zuzuweisenden SW-Einträge_, _Auswahl = SW-Einträge, die (neu) zugewiesen werden_)

[[sw-table-configuration]]
.Software-Tabelle: Konfiguration der Anzeige
image::licensemanagement-table-sw-modi-blended.png["Software-Tabelle: Konfiguration der Anzeige", pdfwidth=80%]

Sie sehen hier also alle Zuweisungen von Software-Items (aus der Datenbanktabelle _SOFTWARE_) zu einem Lizenzpool (Tabelle _LICENSE_POOL_). Sämtliche Einträge, die zum in der oberen Tabelle ausgewählten Lizenzpool gehören, erscheinen als farblich hinterlegte, markierte Zeilen. Alle Zuordnungen von Pools und Software entsprechen der Datenbanktabelle _AUDIT_SOFTWARE_TO_LICENSE_POOL_.

TIP: Ändern Sie die Markierung, um die Zuordnung von Software-Items zu den einzelnen Lizenzpools zu bearbeiten: Mit [Strg]+Mausklick bzw. [Umschalt]+Mausklick beeinflussen Sie die Mehrfachauswahl in der Software-Tabelle. Ein einfacher Klick in eine Zeile startet die Auswahl neu.

NOTE: Wenn es in der Datenbank noch eine Zuordnung eines Software-Items zu einem Lizenzpool gibt, die Software aber laut Datenbank nicht mehr existiert, erscheint die Schaltfläche _fehlend_ aktiviert. Betätigen Sie die Schaltfläche, um ein neues Dialogfenster zu öffnen. Es listet die referenzierte, aber anscheinend nicht mehr vorhandene Software auf und bietet an, Zuordnungen aus der Tabelle _AUDIT_SOFTWARE_TO_LICENSE_POOL_ zu entfernen.

[[opsi-manual-licensemanagement-licensepools-softwarei-navigating]]
=== Navigieren in der Software-Tabelle

Eine Veränderung bei den blau unterlegten Zeilen bedeutet eine Datenänderung. Daher verhalten sich die Funktionen zur Navigation in der Tabelle anders als sonst. Ein rotes Sternchen am Zeilenanfang markiert den Ort, an dem der Cursor steht.

.Software-Tabelle: Cursor in der Zeile
image::licensemanagement-table-sw-rowcursor.png["Software-Tabelle: Cursor in der Zeile", pdfwidth=80%]


Um den Cursor neu zu platzieren, stehen Ihnen folgende Möglichkeiten zur Verfügung:

* mittels impliziter Suche nach einem Tabellenwert (zum Beispiel automatisch bei der Anzeige der zugeordneten Software-Einträge beim Wechsel der Lizenzpoolzeile),
* durch eine über das Suchfeld der Tabelle angestoßene manuelle Suche,
* mithilfe der roten Pfeil-Buttons in der Navigationsleiste der Tabelle.
* durch Klicken in die Sternchenspalte der gewünschten Zeile (während ein Klick in dem Datenteil der Zeile die Zeilenauswahl neu setzt!)

* Suchen Sie nach einem Wert (z.{nbsp}B. indem Sie beim Wechsel des Lizenzpools die zugeordneten Software-Items anzeigen).
* Verwenden Sie das Suchfeld über der Tabelle.
* Betätigen Sie die Schaltflächen mit den roten Pfeilen über der Tabelle zur Navigation.
* Klicken Sie die mit dem Sternchen markierte Spalte der Zeile an. (Achtung: Ein Klick in die Daten selbst setzt die Zeilenauswahl neu!)

[[opsi-manual-licensemanagement-softwareids-based-audit]]
=== Compliance-Check durchführen

Mit der Zuordnung von Software-Items zu Lizenzpools haben Sie bereits die Grundlage für den von Microsoft geforderten Compliance-Check geschaffen. Das Prinzip ist einfach: Mit ein paar Mausklicks markieren Sie die Software-Items in einem bestimmten Pool. Um die Gesamtzahl der einem Pool zugeordneten Installationen zu ermitteln, öffnen Sie den Reiter _Statistik_ (siehe Abschnitt <<opsi-manual-licensemanagement-statistics>>).

NOTE: Um korrekte Ergebnisse zu erhalten, ist es wichtig, die Zuordnungen von Software-Items zu einem Lizenzpool sorgfältig zu pflegen. Diese müssen unbedingt vollständig sein. Wenn eine neue lizenzpflichtige Anwendung hinzukommt, muss die Software also dem Pool zugeordnet werden.

[[opsi-manual-licensemanagement-softwareids-filtered-by-assignment]]
=== Filtern der Software-Tabelle

Über das Kontextmenü der rechten Maustaste erreichen Sie Funktionen zum Filtern der zugeordneten Software-Items. Sie können entweder alle oder nur die markierten Einträge anzeigen.

.Software-Tabelle: das Kontextmenü der rechten Maustaste
image::licensemanagement-table-sw-contextmenu01.png["Software-Tabelle: das Kontextmenü der rechten Maustaste", pdfwidth=80%]

Das ist hilfreich, da die Zeilen der zugeordneten Software-Items nicht unbedingt aufeinanderfolgen in der Software-Tabelle. Nachdem Sie _Nur markierte Einträge zeigen_ ausgewählt haben, verändert sich die Anzeige:

.Software-Tabelle: einem Pool zugeordnete Software-Items anzeigen
image::licensemanagement-table-sw-contextmenu02.png["Software-Tabelle: einem Pool zugeordnete Software-Items anzeigen", pdfwidth=80%]

Alternativ verwenden Sie das Filter-Icon neben dem Suchfeld. Wenn ein Filter aktiv ist, erscheint das Symbol durchgestrichen.

TIP: Auch im gefilterten Zustand können Sie die Zuordnungen bearbeiten, genauer gesagt: Zuordnungen entfernen.

[[opsi-manual-licensemanagement-completeness-by-softwarename-policy]]
=== Zuordnungen zu Softwarenamen vervollständigen

Wenn der Hersteller einer Software eine neue Version, ein Update oder einen Patch verteilt, erhält die neue Variante auch eine neue Windows-Software-ID. Daher gibt es danach auch einen neuen Eintrag in der Software-Tabelle mit einer neuen ID. Was die Lizenz betrifft, ist die neue Version in der Regel genauso zu behandeln wie die alte -- wenn es einen Lizenzvertrag für die Vorgängerversion gab, existiert wahrscheinlich auch einer für den Nachfolger. Das heißt, dass der Bedarf für eine Lizenzierung für beide Ausgaben in demselben Lizenzpool angemeldet werden muss. Eine Abdeckung wird dann über den gemeinsamen Lizenzpool organisiert.

Beim Ausrollen neuer Versionen sollten Sie daher daran denken, eine Zuordnung zum richtigen Lizenzpool hinzuzufügen. Natürlich gibt es auch Software, die Updates ohne Ihr Zutun einspielt -- dann fehlt nach der Aktualisierung eventuell die korrekte Zuordnung. Für diese Fällte bietet die Management-Oberfläche `opsi-configed` ab Version 4.1.9.8 einen eigenen Dialog, der die Vervollständigung erleichtert. Sie öffnen das Fenster per Klick auf die Schaltfläche _Name -> Pool_ in der unteren Hälfte des _Lizenzpools_-Reiters.

.Zuordnung von IDs, Namen und Pools
image::licensemanagement-table-sw-name2pool.png["Zuordnung von IDs, Namen und Pools", pdfwidth=80%]

TIP: Oft ist das Feld _name_ für die Identifikation des benötigten Lizenzpools ausreichend, sodass Sie Unterschiede in anderen Bestandteilen der Software-ID ignorieren können.

Der Dialog zeigt zwei weitere Tabellen an. Wenn Sie vor dem Öffnen die Standardeinstellung _Alle Software-Namenseinträge anzeigen_ aktiviert haben, zeigt die erste Spalte der ersten Tabelle die Softwarenamen alphabetisch sortiert an. Die zweite Spalte listet alle IDs auf, die mit dem jeweiligen Namen verbunden sind (wobei der Name als eigentlich erster ID-Bestandteil nicht wiederholt wird).

Die zweite Tabelle listet zum in der ersten Tabelle ausgewählten Namen die IDs einzeln auf. Für jede ID zeigt sie an, ob eine Zuordnung zu einem Lizenzpool besteht und wie dieser heißt. Die Lizenzpool-Zuordnungen können Sie so vereinheitlichen:

* alle Zuordnungen entfernen
* den im Hauptfenster ausgewählten Pool allen ID-Varianten zuweisen (vermutlich der Standard)
* alles dem ausgewählten Pool zuweisen, falls die Varianten verschiedenen Pools zugeordnet sind

Wenn Sie systematisch die Lizenzpool-Zuordnungen überprüfen möchten, sollten Sie vor dem Klick auf die Schaltfläche _Name -> Pool_ im Hauptfenster die Option _Nur Namen mit varianter Zuordnung zu Lizenzpool_ aktivieren. Die Tabelle im sich öffnenden Dialog zeigt nun nur die Softwarenamen an, zu denen es mehrere IDs gibt und für die unterschiedliche Lizenzpool-Zuordnungen existieren.

.Hauptfenster: Optionen für die Zuordnung von IDs, Namen und Pools
image::licensemanagement-table-sw-alternative-view.png["Hauptfenster: Optionen für die Zuordnung von IDs, Namen und Pools", pdfwidth=80%, width=400]

NOTE: Sofern solche unaufgelösten Zuordnungen existieren, erscheint ein kleines _i_ in diesem grauen Kasten. Wir haben uns bewusst für ein dezentes Design entschieden, weil es durchaus korrekt und erforderlich sein kann, dass Varianten einer Software unterschiedlich lizenziert sind.

Die dritte Option (_Nur Namen ganz ohne Lizenzpoolzuordnung_) ermöglicht Ihnen, nach eventuell vergessenen Zuordnungen von Lizenzen zu suchen.

[[opsi-manual-licensemanagement-softwareids-total-assignment-policy]]
=== Noch nicht zugeordnete Software erkennen

Selbstverständlich ist es möglich, sämtliche installierten Anwendungen einem Lizenzpool zuzuweisen -- auch freie Software. Wenn Sie dann eine neue Software bzw. eine neue Version einer vorhandenen installieren, sind bisher nicht zugeordnete Software-Items gut identifizierbar.

TIP: Damit eine solche Strategie in der Praxis funktioniert, benötigen Sie Pseudo-Lizenzpools wie beispielsweise _freie Software_ oder _Betriebssystem-Komponenten_. Diesen Pools ordnen Sie dann Software-Items zu, für die keine Lizenzierung existiert oder erforderlich ist.

`opsi-configed` bietet für solche Szenarien zusätzliche Anzeigeoptionen an (siehe auch <<sw-table-configuration>>):

.Software-Tabelle: Andere Anzeige auswählen
image::licensemanagement-table-sw-modi-primary.png["Software-Tabelle: Andere Anzeige auswählen", pdfwidth=80%, width=400]

Angenommen, Sie haben bisher sämtliche Software einem Lizenzpool zugeordnet, dann sehen die einzelnen Arbeitsschritte so aus:

. Sie installieren eine (neue) Software auf einem opsi-Client.
. Dort starten Sie das opsi-Produkt `swaudit`.
. Handelt es sich tatsächlich um eine neue Software, erscheint ein neuer Eintrag in der Software-Tabelle. Es kann vorkommen, dass Sie dort mehrere Einträge sehen, beispielsweise für zusätzlich installierte Bibliotheken.
. Wählen Sie einen passenden Lizenzpool aus und aktivieren Sie die Option _Ausblenden von Software, die anderen Pools zugeordnet ist_. Die neuen Tabellenzeilen sind nun die einzigen, die markiert sind.
. Passt der vorausgewählte Lizenzpool, dann fügen Sie mit [Strg]+Mausklick einen neuen Eintrag hinzu.

Anders sehen die Arbeitsschritte aus, wenn Sie beliebige, noch nicht zugeordnete Software-Items auf Lizenzpools verteilen möchten:

. Aktivieren Sie die Option _Nur die keinem Pool zugeordnete Software zeigen_.
. Im Bereich _Bearbeitungsmodus_ aktivieren Sie _Auswahl = SW-Einträge, die (neu) zugewiesen werden_.
. Markieren Sie mit [Strg]+Mausklick die gewünschten Zeilen; optional können Sie die Suchfunktion oder einen Filter verwenden.
. Wählen Sie jetzt den Lizenzpool aus, dem Sie die markierten Software-Items zuordnen wollen.
. Betätigen Sie die nun grüne Schaltfläche _OK_ zum Speichern.
. Setzen Sie abschließend den _Bearbeitungsmodus_ zurück auf _Auswahl = Gesamte Liste der zugewiesenen/zuzuweisenden SW-Einträge_.

NOTE: Beachten Sie, dass sich die hier beschriebenen Funktionen (scheinbar) abweichend verhalten, wenn ein Filter für die Tabelle aktiv ist.

[[opsi-manual-licensemanagement-createlicenses]]
== Lizenzen anlegen

Auf diesem Reiter richten Sie Lizenzen ein und stellen diese dann über einen Lizenzpool bereit. Das Dialogfenster zeigt im oberen Bereich eine (nicht editierbare) Tabelle mit den verfügbaren Lizenzpools an. Wählen Sie dort einen Pool aus, für den Sie eine Lizenz einrichten möchten.

.Der Reiter _Lizenz anlegen_
image::licensemanagement-createlicense.png["Der Reiter _Lizenz anlegen_", pdfwidth=80%]

[[opsi-manual-licensemanagement-createlicense-concepts]]
=== Das Lizenzkonzept

Zunächst sollten einige wichtige Begriffe geklärt werden:

* *Lizenzierung*
* *Lizenzschlüssel*
* *Lizenzierungsrecht*
* *Lizenzmodell*
* *Lizenzvertrag*
* *Lizenzierungsoption*
* *Lizenznutzung*

*Lizenzierung* (_licensing_) ist die faktische Zuweisung der Erlaubnis, eine Software zu nutzen. Dazu gehört auch die Installation. Oft, aber nicht immer, ist dafür ein *Lizenzschlüssel* (_license key_) erforderlich.

Das *Lizenzierungsrecht* ist die in ihrem Geltungsumfang definierte Erlaubnis, solche Zuweisungen durchführen zu dürfen. In der opsi-Datenbank entspricht die _software license_ dem Lizenzierungsrecht. Der Datensatz heißt dementsprechend _softwareLicenseId_. Wie das Lizenzierungsrecht genau aussieht, also für wie viele Rechner und wie lange eine Lizenz gültig ist, beschreibt das *Lizenzmodell* (_licensing model_). Der *Lizenzvertrag* (_license contract_) stellt das Lizenzierungsrecht im juristischen Sinn fest und dokumentiert es.

Eine *Lizenzierungsoption* (_licensing option_) definiert die Möglichkeit, ein Lizenzierungsrecht für einen bestimmten Lizenzpool anzuwenden. Die Kombination aus _softwareLicenseId_ und _licensePoolId_ legt unter opsi diese Lizenzierungsoption fest. Zur Lizenzierungsoption gehört auch der Wert eines Lizenzschlüssels (_licenseKey_), sofern dieser für die Installation erforderlich ist.

Die *Lizenznutzung* (_license usage_) dokumentiert die Anwendung einer Lizenzierungsoption für einen Client, sie ist also die vollzogene und berechtigte Lizenzierung einer Software-Installation. Die Beschreibung setzt sich zusammen aus _softwareLicenseId_, _licensePoolId_ und _hostId_ (eindeutiger Name des opsi-Clients). Zusätzlich wird der verwendete Lizenzschlüssel notiert (_licenseKey_).

[[opsi-manual-licensemanagement-createlicense-contract]]
=== Lizenzvertrag erfassen

Nachdem Sie den Lizenzpool ausgewählt haben, für den Sie eine Lizenzierungsoption anlegen wollen, bestimmen Sie nun den Lizenzvertrag. In der Tabelle _Lizenzvertrag auswählen oder erfassen_ können Sie einen vorhandenen Vertrag auswählen oder einen neuen Vertrags-Datensatz anlegen.

Die erste Spalte zeigt die _licenseContractId_, die zur Identifizierung des Lizenzvertrags in der Datenbank dient. Es folgen Angaben zum Vertragspartner (_partner_), zum Abschlussdatum (_conclusionDate_), zum Benachrichtigungsdatum (_notificationDate_) und zum Ablaufdatum (_expirationDate_). Das letzte Feld (_notes_) ist für Ihre eigenen Notizen gedacht. Hier können Sie beispielsweise den Aufbewahrungsort der zum Vertrag gehörenden Dokumente oder ein Aktenzeichen notieren.

Einen neuen Datensatz legen Sie über das Kontextmenü der rechten Maustaste an. Es wird automatisch eine neue eindeutige ID (basierend auf dem aktuellen Datum und Zeitstempel) erstellt. Sie können die Standardeinstellung verwenden, wenn der Kauf der Software den Lizenzvertrag impliziert oder wenn der Vertrag auf andere Weise dokumentiert und nachvollziehbar ist. Andernfalls können und sollten Sie die Daten bearbeiten, um den zugrundeliegenden Vertrag ordentlich nachverfolgen zu können. Tragen Sie dann beispielsweise ein Aktenzeichen ins Feld _notes_ ein.

NOTE: Eine Änderung der Vertrags-ID ist nur möglich, solange der Datensatz noch nicht gespeichert wurde. Beim Speichern der Daten prüft der opsi-Dienst, ob die ID eindeutig ist. Ist das nicht der Fall, wird eine neue ID erzeugt, die nicht mehr geändert werden kann.

[[opsi-manual-licensemanagement-createlicense-model]]
=== Lizenzmodell konfigurieren

Im Abschnitt _Lizenzmodell konfigurieren_ können Sie folgende vier Varianten über Schaltflächen einrichten:

* _Standardlizenz_: Installation auf einem beliebigen Rechner (mit individuellem Lizenzschlüssel, der auch nur einmal verwendet wird).
* _Volume_: Maximale Anzahl der Installationen ist festgelegt; eine Volumen-Lizenz legitimiert _n_ Installationen (ggf. mit einem einzigen Lizenzschlüssel); _n=0_ bedeutet, dass der Schlüssel beliebig oft verwendet werden darf (Campus-Lizenz).
* _OEM_: Lizenz ist an einen Rechner gebunden, Schlüssel gilt nur für bestimmte Hardware (häufig bei PCs mit vorinstalliertem Betriebssystem).
* _Concurrent_: Aus opsi-Sicht ist das eine Volumen-Lizenz, die beliebig oft genutzt werden darf; de facto wird die Anzahl der in Anspruch genommenen Lizenzen jedoch anders kontrolliert , z.{nbsp}B. durch einen Lizenzserver.

In allen vier Fällen enthält das Feld _ID_ jeweils einen Vorschlag, der sich aus Datum und Zeit zusammensetzt; Sie können den Vorschlag übernehmen oder abändern. Abhängig vom gewählten  Lizenzmodell können Sie die anderen Felder anpassen oder nicht.

NOTE: Beachten Sie, dass das Feld _Ablaufdatum_ die Gültigkeit des Lizenzierungsrechts definiert. Das inhaltlich gleichbedeutende Feld _expirationDate_ in der Lizenzvertrags-Tabelle dient derzeit lediglich zur Dokumentation. Aktuell ist eine Verwendung nicht implementiert, das kann sich künftig aber ändern.

Betätigen Sie die Schaltfläche _Abschicken_, um die Daten an den opsi-Service zu übermitteln und in die Datenbank aufzunehmen. Dabei werden Datensätze für ein Lizenzierungsrecht basierend auf dem ausgewählten Vertrag und der Lizenzierungsoption erzeugt. Diese sehen Sie ganz unten auf dem Reiter im Bereich _Verfügbare Lizenzoptionen_. Nach dem Speichern wird diese Tabelle neu geladen und die neu erzeugte Option automatisch markiert.

TIP: Falls erforderlich können Sie über diese Tabelle den erfassten Lizenzschlüssel korrigieren.

[[opsi-manual-licensemanagement-editlicense]]
== Lizenzen bearbeiten

In 90{nbsp}% der Fälle sollten die Funktionen auf den beiden Reitern _Lizenzpools_ und _Lizenz anlegen_ genügen, um Lizenzoptionen zu erfassen und zu bearbeiten. Der dritte Reiter _Lizenzen bearbeiten_ erlaubt Feinjustierungen: Hier können Sie Interna der Lizenzoptionen betrachten und gegebenenfalls anpassen.

.Der Reiter _Lizenzen bearbeiten_
image::licensemanagement-editlicense.png["Der Reiter _Lizenzen bearbeiten_", pdfwidth=80%]

[[opsi-manual-licensemanagement-editlicense-downgrade-option]]
=== Beispiel: Downgrade-Option konfigurieren

Das folgende Beispiel zeigt, wie Sie eine Lizenz mit Downgrade-Option konfigurieren. Das bedeutet, dass anstelle der gekauften Software auch die entsprechende Vorgängerversion installiert werden darf. Ein vorhandener Lizenzschlüssel darf also für eine zusätzliche Installation verwendet werden, für die er ursprünglich nicht legitimiert war.

Das opsi-Modell bildet diese Konstruktion folgendermaßen ab: Auf dem Reiter _Lizenz anlegen_ erfassen Sie die Lizenz regulär. Als Ergebnis erhalten Sie eine neue Lizenzoption (angezeigt in der unteren Tabelle), die auf einem gleichfalls neu angelegten Lizenzierungsrecht beruht (_softwareLicenseId_). Diesen Wert benötigen Sie für das weitere Vorgehen. Entweder kopieren Sie Sie den Wert in die Zwischenablage oder Sie suchen ihn in der zweiten Tabelle auf dem Reiter __Lizenzen bearbeiten__ heraus.

TIP: Über das Kontextmenü der rechten Maustaste erreichen Sie die Funktion _Übertrage Lizenzierungs-ID in Lizenzoptions-Zeile_, welche die ID kopiert.

._Lizenzen bearbeiten_: Kopieren der Lizenz-ID über das Kontextmenü
image::licensemanagement-editlicense-copying-license-id.png["_Lizenzen bearbeiten_: Kopieren der Lizenz-ID über das Kontextmenü", pdfwidth=80%]

Als Nächstes stellen Sie eine Verknüpfung des vorhandenen Lizenzierungsrechts mit einem weiteren Lizenzpool her:

. Legen Sie in der ersten Tabelle (_Verfügbare Lizenzoptionen_) des Reiters __Lizenzen bearbeiten__ einen neuen Datensatz an.
. Tragen Sie die ID des Lizenzierungsrechts (_softwareLicenseId_) und die ID des zusätzlichen Lizenzpools ein.
. Speichern Sie die Änderungen -- jetzt haben Sie zwei Lizenzoptionen registriert, die auf das gleiche Lizenzierungsrecht verweisen.

NOTE: Der opsi-Service rechnet jede Anwendung einer der beiden Optionen auf die maximale Zahl von Installationen an, die das Lizenzierungsrecht einräumt. Daher gibt er bei einer solchen Downgrade-Option für Einzel-PC-Lizenzen mit `maxInstallations = 1` immer nur für eine Lizenz den Schlüssel zurück.

[[opsi-manual-licensemanagement-usages-manually]]
== Lizenzenverwendung

Die über den opsi-Service registrierten Lizenzierungen können Sie auf dem Reiter _Lizenzenverwendung_ einsehen.

.Der Reiter _Lizenzenverwendung_
image::licensemanagement-usages.png["Der Reiter _Lizenzenverwendung_", pdfwidth=80%]

Außerdem können Sie hier die Verwendung der Lizenzen manuell verwalten. Das ist z.{nbsp}B. dann sinnvoll, wenn eine Software von Hand auf einzelnen Clients installiert werden soll und nicht in die opsi-Verteilung eingebunden ist:

* Markieren Sie eine Tabellenzeile und rufen Sie aus dem Kontextmenü der rechten Maustaste den Eintrag _Zeilen löschen_ auf, um eine Lizenzoption wieder freigegeben.

* Wenn Sie in der oberen Tabelle das Feld _licenseKey_ bearbeiten, können Sie den für eine Lizenzierung verwendeten Schlüssel (neu) bestimmen.

* Der Abschnitt _Lizenz reservieren für Client_ unten im Dialog dient dazu, eine Lizenzoption anzufordern und zu belegen.

TIP: Bei einer erneuten Installation eines PCs bleiben die vorher zugeordnete Lizenzoptionen erhalten, sofern Sie diese nicht ausdrücklich gelöscht haben. Geben Sie eine solche Option entweder in diesem Reiter oder mit `opsi-script` wieder frei (siehe Abschnitt <<opsi-manual-licensemanagement-usages-opsiservice>>).

[[opsi-manual-licensemanagement-reconciliation]]
== Abgleich mit Inventarisierung

Die Tabelle _Abgleich mit der Software-Inventarisierung_ zeigt für jeden Client (_hostID_) und Lizenzpool (_licensePoolId_) an, ob das opsi-Lizenzmanagement zuständig ist oder nicht (Spalte _used_by_opsi_). Die letzte Spalte (_SWinventory_used_) verrät außerdem, ob auf dem Client laut Software-Inventarisierung (`swaudit`) eine (Windows-)Software installiert ist, die eine Lizenz aus dem Pool benötigt.

.Der Reiter _Abgleich mit Inventarisierung_
image::licensemanagement-reconciliation.png["Der Reiter _Abgleich mit Inventarisierung_", pdfwidth=80%]

Damit die Ergebnisse von `swaudit` die Lizenzenverwendung beschreiben können, müssen die entsprechenden Software-IDs den richtigen Lizenzpools zugeordnet sein (Reiter _Lizenzpools_).

NOTE: Das Lizenzmanagement zählt beim Abgleich mit der Software-Inventarisierung maximal 1 Vorkommen pro Client und Lizenzpool. Ist beispielsweise ein Lizenzpool _office2010_ mit 10 verschiedenen Mustern aus der Inventarisierung verknüpft, die alle darauf hinweisen, dass ein MS Office 2010 installiert ist, wird das nur als eine Installation gezählt -- auch wenn alle 10 Muster auf einem Client gefunden werden.

Um zusätzliche Informationen zu den Clients in der Tabelle darzustellen, bearbeiten Sie die Host-Parameter-Seite des Servers im `opsi-configed` und erweitern `configed.license_inventory_extradisplayfields` entsprechend.

TIP: Sie können die Daten per Copy{nbsp}&{nbsp}Paste in eine Tabellenkalkulation übernehmen oder über das Kontextmenü der rechten Maustaste ausdrucken. Dazu muss der `opsi-configed` über die entsprechenden Rechte verfügen. Er darf nicht als Applet-Sandbox im Browser, sondern muss als eigenständige Anwendung laufen.

[[opsi-manual-licensemanagement-statistics]]
== Statistik

Auf dem letzten Reiter erhalten Sie eine Übersicht über den allgemeinen Stand der Lizenzierungen. Sie sehen hier unter anderem die genutzten und noch freien Lizenzoptionen der verschiedenen Lizenzpools.

.Der Reiter  _Statistik_
image::licensemanagement-statistics.png["Der Reiter  _Statistik_", pdfwidth=80%]

Zusätzlich zu den registrierten Lizenzenverwendungen (_used_by_opsi_) und den danach noch freien Lizenzen (_remaining_opsi_) sehen Sie die Gesamtzahl tatsächlicher Installationen, die eigentlich eine Lizenz benötigen (_SWinventory_used_). Die Daten der Spalte _SWinventory_used_ liefert das opsi-Produkt `swaudit` und erhält sie nach einem Scan der Registry auf den Clients. Die Zuordnungen der so ermittelten Software-IDs zu den jeweiligen Lizenzpools verwaltet der Reiter _Lizenzpools_ (siehe Abschnitt <<opsi-manual-licensemanagement-licensepools>>).

TIP: Sie können die Daten der per Copy{nbsp}&{nbsp}Paste in eine Tabellenkalkulation übernehmen oder über das Kontextmenü der rechten Maustaste ausdrucken. Dazu muss der `opsi-configed` über die entsprechenden Rechte verfügen. Er darf nicht als Applet-Sandbox im Browser, sondern muss als eigenständige Anwendung laufen.

[[opsi-manual-licensemanagement-statistics-downgrade-option]]
=== Beispiel: Downgrade-Option

Wenn Sie eine Downgrade-Option konfiguriert haben (siehe Abschnitt <<opsi-manual-licensemanagement-editlicense-downgrade-option>>), stellt die Tabelle _Übersicht Lizenzenverwendung_ das ebenfalls dar. Eine Downgrade-Lizenz räumt je eine Lizenzierungsoption für (mindestens) zwei Lizenzpools ein. Nur eine der beiden kann tatsächlich genutzt werden. Sobald daher eine Lizenzoption verwendet wird, verringert sich in der Spalte _remaining_opsi_ in *beiden* Zeilen der Wert um 1. Scheinbar vermindert sich also die Zahl der verfügbaren Lizenzen um 2 -- das ist aber völlig korrekt und spiegelt die tatsächliche Berechtigungs-Situation wider.

[[opsi-manual-licensemanagement-usages]]
== Zuteilung und Freigabe per Skript

Immer, wenn Sie eine Software auf einem Rechner installieren und dafür eine Lizenzoption erfassen, führt das zu einer Lizenznutzung. In einer opsi-Umgebung finden diese Installationen skriptbasiert und automatisch statt. Das Skript setzt dazu Aufrufe an den zentral laufenden opsi-Service ab.

NOTE: Zum Einsatz kommt das Programm `opsi-script` (früher `opsi-winst` unter Windows). Das Skript kümmert sich um die automatisch Software-Installation und -Konfiguration, Sie können es aber auch als eigenständiges Programm einsetzen. Weitere Informationen zur Skriptsprache und zu den einzelnen Befehlen finden Sie im xref:opsi-script-manual[`opsi-script`-Handbuch].

Die nächsten Abschnitte stellen die für die Lizenzverwaltung relevanten `opsi-script`-Kommando vor.

[[opsi-manual-licensemanagement-usages-opsiservice]]
=== Lizenzen anfordern und freigeben

Es gibt zwei Funktionen für die Lizenzverwaltung (siehe xref:opsi-script-manual/prim-section#opsi-script-string-functions-license[(String-)Funktionen für die Lizenzverwaltung [W/L/M]):

* `DemandLicenseKey(poolId [, productId [,windowsSoftwareId]])` +
Mit der Funktion `getAndAssignSoftwareLicenseKey` starten Sie eine Abfrage an den opsi-Service, ob es für den Computer eine reservierte Lizenz gibt. So können Sie beispielsweise mit dem Setup-Skript einer Betriebssystem-Installation eine Lizenzoption "ziehen" und den benötigten Schlüssel anfordern.
* `FreeLicense(poolId [, productId [,windowsSoftwareId]]])` +
Mit der Funktion `freeSoftwareLicense` geben Sie eine Lizenz wieder frei und führen sie in den Pool der nicht verwendeten Lizenzoptionen zurück.

Anstelle der Lizenzpool-ID können Sie jeweils die Produkt-ID oder eine Windows-Software-ID als Parameter übergeben.

NOTE: Wenn Sie eine Software erneut installieren und das Skript über `DemandLicenseKey` eine Lizenz anfordert, dann wird die vorher zugeordnete Lizenzoption weiter verwendet, die Funktion liefert also denselben Schlüssel wie vorher. Ist das nicht gewünscht, heben Sie die Verwendung durch `FreeLicense` mit dem Aufruf `deleteSoftwareLicenseUsage` auf. Entsprechend bleiben bei einer erneuten Installation die Lizenzverwendungen erhalten. Sie geben Sie mit dem Aufruf `deleteAllSoftwareLicenseUsages` (zusammen mit der Host-ID des betreffenden PCs als Parameter) frei.

TIP: Die Boolesche Funktion `opsiLicenseManagementEnabled` prüft, ob das Lizenzmanagement freigeschaltet ist (siehe xref:opsi-script-manual/prim-section#opsi-script-commands-if-else-bool-functions[Boolesche Ausdrücke [W/L/M]]).

[[opsi-manual-licensemanagement-service-methods]]
== Service-Methoden zum Lizenzmanagement

Sie können Service-Methoden zum Lizenzmanagement mit dem Kommandozeilenwerkzeug `opsi-admin` (siehe xref:manual/server/configuration-tools#opsi-manual-configuration-tools-opsi-admin[Auf der Kommandozeile: `opsi-admin`]) verwenden, um z.{nbsp}B. mit einem Skript Lizenzschlüssel aus einer Datei einzulesen.

Entsprechende Beispiele finden Sie in den Produkten `license-test-\*.opsi` unter https://download.uib.de/opsi4.1/misc/license-management/. Sie installieren diese Pakete mit dem Befehl `opsi-package-manager -i`. Anschließend finden Sie im Verzeichnis `/var/lib/opsi/depot/<produkt>` die dazugehörigen Skripte (`create_license-\*.sh`).

[[opsi-manual-licensemanagement-service-methods-contracts]]
=== Lizenzverträge mit `opsi-admin` bearbeiten

Die Service-Methoden rufen Sie z.{nbsp}B. über `opsi-admin` auf; mit `\*` gekennzeichnete Parameter sind optional:

[source,prompt]
----
method createLicenseContract(*licenseContractId, *partner, *conclusionDate, *notificationDate, *expirationDate, *notes)
----

Die Methode erstellt einen neuen Lizenzvertrags-Datensatz mit der ID `licenseContractId` bzw. bearbeitet einen bestehenden. Geben Sie die ID nicht an, wird sie automatisch generiert. Die beiden Parameter `partner` (Vertragspartner) und `notes` (Notizen zum Vertrag) sind frei wählbare Strings. `conclusionDate` (Datum des Vertragsabschlusses), `notificationDate` (Erinnerung) und `expirationDate` (Ablaufdatum) übergeben Sie im Format `JJJJ-MM-TT`, z.{nbsp}B. `2023-02-28`.

Mit den String-Funktionen `getLastServiceErrorClass` und `getLastServiceErrorMessage` kann auf einen Fehler reagiert werden, wenn z.{nbsp}B. keine freie Lizenz mehr verfügbar ist:

[source]
----
if getLastServiceErrorClass = "None"
        comment "kein Fehler aufgetreten"
endif
----

Die Fehlerklasse `LicenseMissingError` wird zurückgegeben, falls eine Lizenz angefordert wird, aber nicht verfügbar ist. Die Fehlerklasse `LicenseConfigurationError` wird zurückgegeben, wenn die Konfiguration keine eindeutige Zuordnung eines Lizenzpools zu einer Software zulässt.

[[opsi-manual-licensemanagement-examples]]
== Beispielprodukte und Templates

Im https://download.uib.de/opsi4.1/misc/license-management/[Downloadbereich] finden Sie vier Beispiele: je ein Produkt zur Verwendung von Retail-, OEM- und Volumenlizenzen sowie ein Produkt, das alle drei Lizenztypen vereint.

Diese Produkte belegen bei der Installation Lizenzen und geben sie bei der Deinstallation wieder frei. Außerdem hinterlassen die Beispiele entsprechende Spuren in der Software-Inventarisierung, die das Lizenzmanagement zum Abgleich verwenden kann.

TIP: Wie im vorigen Abschnitt erwähnt, enthalten die Produkte ein Shell-Skript, mit dem Sie zu Testzwecken automatisiert die Lizenzpools, Lizenzverträge und Lizenzen anlegen können.
