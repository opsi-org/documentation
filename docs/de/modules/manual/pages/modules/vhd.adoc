////
; Copyright (c) uib gmbh (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: http://www.opsi.org/credits/
////

:Author:    uib gmbh
:Email:     info@uib.de
:Date:      30.01.2023
:Revision:  4.1
:toclevels: 6
:doctype:   book

ifeval::["{mode}" == "antora"]
include::common:partial$opsi_terms.adoc[]
endif::[]

[[opsi-manual-vhd]]
= Virtual Hard Disk (`opsi-vhd-reset`)

`opsi-local-image` unterstützt Sie dabei, viele opsi-Clients schnell zurück auf einen bestimmten Stand bringen, etwa in der Kaffeepause während einer Schulung oder im Klassenraum nach dem Unterricht. Der Administrator steuert alles von zentraler Stelle aus: Zuerst erstellt die Erweiterung ein Image, dann speichert sie es auf einer separaten Festplatten-Partition. Dieses Image kommt dann zur schnellen Wiederherstellung zum Einsatz, mit minimaler Auswirkung auf die Netzwerk-Performance.

Die Erweiterung `opsi-vhd-reset` ergänzt `opsi-local-image` (siehe xref:modules/local-image#opsi-manual-localimage[Lokale Images (`opsi-local-image`)]): Die initiale Installation mit abschließender lokaler Image-Sicherung findet in einem VHD-Container statt.

[[opsi-manual-vhd-preconditions]]
== Voraussetzungen

NOTE: Dieses Modul ist momentan eine https://www.uib.de/de/opsi-erweiterungen/erweiterungen[kostenpflichtige Erweiterung]. Das heißt, dass Sie eine Freischaltdatei benötigen. Sie erhalten diese, nachdem Sie die Erweiterung gekauft haben. Zu Evaluierungszwecken stellen wir Ihnen kostenlos eine zeitlich befristete Freischaltung zur Verfügung. Bitte kontaktieren Sie uns dazu per mailto:info@uib.de[E-Mail].

Weitere Details hierzu finden Sie im Kapitel xref:modules/modules#opsi-manual-modules[opsi-Erweiterungen].

`opsi-vhd-reset` kommt im Bundle mit der Erweiterung `opsi-local-image` (siehe xref:modules/local-image#opsi-manual-localimage[Lokale Images (`opsi-local-image`)]), das heißt, dass die Freischaltung von `opsi-local-image` automatisch auch für `opsi-vhd-reset` gilt.

Die Erweiterung setzt opsi 4.0.7 oder neuer voraus. Die folgende Tabelle listet die benötigten opsi-Pakete auf:

.Benötigte Pakete
[options="header"]
|==========================
|opsi-Paket|Version
|`opsi-winst` |>= 4.12.0.13
|==========================

[[opsi-manual-vhd-introduction]]
== Einführung

opsi bietet eine gute Basis, um automatisiert Windows-Rechner zu installieren und zu pflegen -- auch und gerade, wenn es sich um heterogene Hardware handelt. Eine paketbasierte opsi-Installation ist jedoch nicht schnell genug, um Rechner innerhalb kurzer Zeit wieder in einen vorher definierten Zustand zu bringen, z.{nbsp}B. in Schulungs- oder Klassenräumen während einer Pause. Die Erweiterung `opsi-vhd-reset` erweitert `opsi-local-image`:

. initiale Windows-10-Installation in einem VHD-Container
. "Versiegelung" der initialen Installation durch eine Child-VHD
. schnelle Wiederherstellung durch Austauschen der Child-VHD
. Upgrade der initialen Installation durch einen Merge der Child-VHD

NOTE: Das Verfahren arbeitet mit den aus der Virtualisierung bekannten Snapshot-Techniken, ohne selbst eine Virtualisierung zu benötigen.

[[opsi-manual-vhd-proceedings]]
== Ablauf

[[opsi-manual-vhd-proceedings-initial]]
=== Initiale Installation

Installieren Sie mit dem Produkt `opsi-vhd-win10-x64` ein Windows-10-System in einem VHD-Container.

.Schema: Partitionieren und VHD erstellen (`opsi-vhd-win10-x64`)
image::opsi-vhd-inst1.png["Schema: Partitionieren und VHD erstellen (`opsi-vhd-win10-x64`)", width=332]

.Schema: Windows installieren (`opsi-vhd-win10-x64`)
image::opsi-vhd-inst2.png["Schema: Windows installieren (`opsi-vhd-win10-x64`)", width=332]

Anschließend können Sie auf diesem Windows-System die gewünschten Applikationen installieren.

.Schema: Anwendungssoftware installieren (`opsi-vhd-win10-x64`)
image::opsi-vhd-inst3.png["Schema: Anwendungssoftware installieren (`opsi-vhd-win10-x64`)", width=332]

Rufen Sie das Produkt `opsi-vhd-control` auf, um aktuelle Metadaten zu diesem opsi-Client zu speichern. Dazu gehört auch die Information, welches Produkt in welcher Version installiert ist. Anschließend aktivieren und booten Sie das Windows PE (Preinstallation Environment).

TIP: Das Produkt `opsi-vhd-control` hat eine sehr niedrige Priorität (-97) und ist daher erst nach der Anwendungssoftware-Installation an der Reihe. Daher können Sie `opsi-vhd-control` zusammen mit der Anwendungssoftware auf `setup` stellen.

.Schema: Windows-PE-Partition aktivieren (`opsi-vhd-win10-x64`)
image::opsi-vhd-inst4.png["Schema: Windows-PE-Partition aktivieren (`opsi-vhd-win10-x64`)", width=332]

Unter Windows PE wird durch Anlegen einer Child-VHD die initiale Installation gegen Veränderungen geschützt.

.Schema: Initiale Installation versiegeln (`opsi-vhd-control`)
image::opsi-vhd-control-1stsnap.png["Schema: Initiale Installation versiegeln (`opsi-vhd-control`)", width=332]

Ab sofort landen alle Änderungen in der Child-VHD.

.Schema: Arbeiten mit dem versiegelten System
image::opsi-vhd-control-work.png["Schema: Arbeiten mit dem versiegelten System", width=332]


[[opsi-manual-vhd-proceedings-restore]]
=== Image wiederherstellen

Über das opsi Produkt 'opsi-vhd-control' kann die Initiale Installation wieder hergestellt werden. +
Zunächst werden die gespeicherten opsi Meta Daten aus dem System wiederhergestellt.
Dann wird für das Child VHD handling wieder in das Windows PE gebootet.

.Schema: opsi-vhd-control: Wiederherstellung der initialen Installation 1
image::opsi-vhd-control-activatepe.png["Schema: Wiederherstellung der initialen Installation mit opsi-vhd-control 1", width=332]

Vom Windows PE aus wird die 'child' VHD mit den Veränderungen gelöscht und gegen eine neue, leere 'child' VHD ausgetauscht.

.Schema: opsi-vhd-control: Wiederherstellung der initialen Installation 2
image::opsi-vhd-control-resnap.png["Schema: Wiederherstellung der initialen Installation mit opsi-vhd-control 2", width=332]


[[opsi-manual-vhd-proceedings-update]]
=== Image aktualisieren

Um die Pflege der Clients zu vereinfachen, gibt es das Produkt `opsi-auto-update`.


`opsi-auto-update`

Für ein Update der initialen Installation mit Patches und Softwareupdates, kann wie folgt vorgegangen werden:

* Wiederherstellung der initialen Installation (wie oben beschrieben)
* Einspielen der Updates
* Integration der Updates in die initiale Installation und Neuversiegelung durch start von 'opsi-vhd-control' mit dem Property 'upgrade=true'
* Dies startet auch das Ablegen der neuen opsi Meta Daten im System

Diese Vorgänge werden automatisiert durchgeführt durch das Produkt `opsi-auto-update`.

Das Produkt `opsi-auto-update` ersetzt das vorherige Produkt `opsi-vhd-auto-upgrade`


[[opsi-manual-vhd-components]]
== `opsi-vhd`r- Produkte

Die Erweiterung 'opsi-vhd-reset' besteht aus folgenden Produkten

Das Netbootprodukt zur initialen Installation

* `opsi-vhd-win10-x64`

Das Localboot Produkt zur Steuerung der Erstellung, des Austausches und des Merge der Child-VHD's.

* `opsi-vhd-control`

Das Localboot Produkt zum Vollautomatischen Update der Parent VHD.

* `opsi-auto-update`


[[opsi-manual-vhd-components-uefi]]
=== UEFI Kompatibilität

Die opsi-vhd Produkte sind UEFI kompatibel.


[[opsi-manual-vhd-components-netboot]]
=== Das opsi Netboot Produkt 'opsi-vhd-win10-x64' und seine Properties

Diese Netbootprodukt gleicht vom Aufbau her den normalen Netbootprodukten (4.1.0) zur Windows Installation
und muss entsprechend befüllt werden wie dies im 'Getting-started' Handbuch beschrieben ist. +
Auch die Properties sind weitgehend die selben. 


Folgende Properties sind speziell für dieses Produkt:

* `windows_vhd_size` +
Dieses Property gibt die Größe der Basis VHD absolut oder in Prozent der Festplattengröße
abzüglich der WinPE Partition an. Der Defaultwert von 100% wird automatisch auf 80 % gekürzt,
um Platz für die child VHD zu lassen. Wird (absolut oder relativ) ein Wert angegeben der über 80% landet,
so wird dieser auch auf 80% vermindert. +
Dieses Property ersetzt das Standard Property 'windows_partition_size' +
(Default = 100%)

* `installto`: +
Der Wert ist 'vhd' und soll und kann auch nicht geändert werden

Folgende Properties fehlen bei diesem Produkt:

* `windows_partition_size`, `windows_partition_label` +
Siehe oben. Das Label der Partition in welcher die VHD's liegen ist 'CONTAINER'.
* `data_partition_size`, `data_partition_letter`, `data_partition_create`, `data_partition_preserve` +
Die Verwaltung einer Data-Partition ist bisher bei opsi-vhd nicht vorgesehen.
* `boot_partition_size`, `boot_partition_letter`, `boot_partition_label` +
Die Verwaltung einer Boot-Partition ist bisher bei opsi-vhd nicht vorgesehen.
* `pre_format_system_partitions`, `preserve_winpe_partition` +
Bei opsi-vhd stehen diese beiden Werte fest auf 'true'.

[[opsi-manual-vhd-components-control]]
=== Das opsi Localboot Produkt 'opsi-vhd-control' und seine Properties

Das Produkt opsi-vhd-control hat eine sehr niedrige Priorität (-96).

* `disabled` +
Diese Property dient zu Debug-Zwecken. +
Wenn 'true', führt das Produkt keine Aktionen aus. +
Default = 'false'

* `upgrade` +
Wenn 'true': Merge die, in der child CHD gesammelten Änderungen in die Haupt VHD.
Danach tausche die child VHD gegen eine leere child VHD aus. +
Wenn 'false': Tausche die child VHD gegen eine leere child VHD aus. +
Am Ende eines erfolgreichen 'upgrade' Laufs wird dieses Property automatisch auf 'false' zurückgestellt. +
Default = 'false'

* `stop_on_no_network_in_pe` +
Diese Property dient zu Debug Zwecken. +
Wenn 'true': Breche mit einer Fehlermeldung ab, damit untersucht werden kann,
warum keine Netzwerkverbindung aufgebaut werden konnte.
Default = 'false'

[[opsi-manual-vhd-components-upgrade]]
=== Das opsi Localboot Produkt 'opsi-auto-update' und seine Properties

opsi-auto-update ist ein Produkt um die Pflege der Clients zu vereinfachen.

Im Kern ist es die Aufgabe des Produktes dafür zu sorgen die installierten Produkte aktuell zu halten. +
Das Produkt setzt alle installierten Produkte, 
deren Version nicht identisch mit der auf dem Server ist, 
für den Client auf setup. +
Da dieses Produkt nicht nur im Kontext von 'opsi-vhd-reset' eingesetzt werden kann, ist es im Kapitel 'opsi Standardprodukte' / 'opsi-auto-update' beschrieben: +
xref:modules/local-image#opsi-manual-localboot-opsi-auto-update[opsi-auto-update]

[[opsi-manual-vhd-restrictions]]
=== Bekannte Probleme und Einschränkungen

* Es gibt auch eine 32 Bit Version. Diese ist aufgrund eines Problems beim Diskpart merge Befehls in den 32 bit Windows PE Versionen nur eingeschränkt verwendbar.

* Theoretisch wäre auch eine Implementierung für Windows 8.1 bzw Windows 7 Enterprise möglich. Diese werden wir aber nur auf Bedarf anfertigen.

* Es gibt Hinweise darauf, das ein Windows 10 Release Upgrade einer Installation in einer VHD fehlschlägt. +
(https://www.heise.de/newsticker/meldung/VHD-Boot-Windows-Update-demoliert-Aktivierung-3806023.html)
