////
; Copyright (c) uib gmbh (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: https://www.opsi.org/credits/
////

:Author:    uib gmbh
:Email:     info@uib.de
:Date:      24.04.2023
:Revision:  4.2
:toclevels: 6
:doctype:   book
:icons: font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]

[[opsi-getting-started-installation-config]]
= Konfiguration

Dieses Kapitel erklärt zuerst, wie Sie einen frisch installierten opsi-Server aktualisieren und dann die Standard-Produkte einspielen. Danach ä######äää

[[opsi-getting-started-installation-config-update-server]]
== opsi-Server aktualisieren

Bevor Sie den opsi-Server konfigurieren, bringen sie zunächst die Pakete des zugrundeliegenden Linux-Systems auf den aktuellen Stand. Wenn Sie die von uns bereitgestellte virtuelle Maschine verwenden (siehe Abschnitt xref:getting-started:server/base-installation.adoc#opsi-getting-started-installation-base-vm[Inbetriebnahme der vorkonfigurierten virtuellen Maschine]), dann nutzen Sie dazu das Paketverwaltungstool APT, denn die VM basiert auf der letzten LTS-Version von Ubuntu. APT verwenden Sie ebenfalls zum Aktualisieren von Debian und anderen Ubuntu-Versionen. Der letzte Befehl deinstalliert nicht mehr benötigte Pakete, die als Abhängigkeit installiert waren:

[source,prompt]
----
sudo apt update
sudo apt upgrade
sudo apt autoremove
----

TIP: Wenn Sie unsere vorkonfigurierte virtuelle Maschine einsetzen, dann können Sie das Symbol _Update OS_ auf dem Desktophintergrund zur Aktualisierung der Pakete verwenden. Doppelklicken Sie es und geben dann das Kennwort des Benutzers `adminuser` ein.

Verwenden Sie SLES/openSUSE, dann nutzen Sie das Werkzeug `zypper`:

[source,prompt]
----
sudo zypper refresh
sudo zypper update
----

Unter RHEL/AlmaLinux/Rocky Linux heißen die Befehle zum Aktualisieren der Distribution so:

[source,prompt]
----
sudo yum check-update
sudo yum update
----

Nachdem das Upgrade abgeschlossen ist, starten Sie den Server neu.

NOTE: Falls Sie einen Proxy-Server zum Zugriff auf das Internet verwenden, konfigurieren Sie diesen über die Umgebungsvariablen `http_proxy` und `https_proxy` (siehe Kapitel xref:getting-started:server/requirements.adoc[Voraussetzungen]).

[[opsi-getting-started-installation-config-update-opsi-product]]
== Standard-Produkte einspielen

Nach der Installation des opsi-Servers und der Aktualisierung des zugrundeliegenden Linux-Systems spielen Sie die opsi-Standard-Produkte ein. Dazu geben Sie den folgenden Befehl in ein Terminalfenster ein:

[source,prompt]
----
sudo opsi-package-updater -v install
----

Auf Aufforderung geben Sie das Passwort für den Benutzer `adminuser` ein.

Das Kommando aktualisiert alle vorhandenen opsi-Pakete inklusive der Templates für Betriebssystem-Installationen aus den opsi-Repositorys. 

.Innstallieren Sie die Standard-Produkte auf Ihrem opsi-Server.
image::opsi-package-updater.png["Installieren Sie die Standard-Produkte auf Ihrem opsi-Server.", pdfwidth=80%]

TIP: Auf unserer vorkonfigurierten virtuellen Maschine können Sie alternativ das Desktop-Icon _First package installation_ doppelklicken, um die Standard-Produkte zu installieren.

[[opsi-getting-started-installation-config-update-start-configed]]
== Management-Oberfläche starten

Die Management-Oberfläche `opsi-configed` starten Sie in der virtuellen Maschine über einen Doppelklick auf das Desktopsymbol _Opsi Configuration Editor_. Weitere Informationen zu dieser grafischen Anwendung finden Sie in xref:manual:configed.adoc[Management-Oberfläche `opsi-configed`].

[[opsi-getting-started-installation-config-backend]]
== Backend-Konfiguration

opsi unterstützt unterschiedliche Backends. Für die Datenhaltung sind das diese beiden:

* *file*:  Datenhaltung in Dateien
* *mysql*: Datenhaltung in einer MySQL-Datenbank

NOTE: Einige Distributionen verwenden MariaDB anstelle von MySQL. Das MySQL-Backend funktioniert auch mit MariaDB. Das MySQL-Backend zur Inventarisierung ist kostenlos. Mehr zu den kostenpflichtigen Erweiterungen lesen Sie in Kapitel xref:manual:modules/modules.adoc[opsi-Erweiterungen].

Daneben gibt es diese Backends für spezielle Zwecke:

* *opsipxeconfd*: der Dienst für opsi-Netzwerkboot
* *dhcpd*: zur Kommunikation mit dem DHCP-Dienst auf dem opsi-Server
* *jsonrpc*: JSON-RPC-Methoden auf einem opsi-Server ausführen

In der Voreinstellung kommt das MySQL-Backend bei der Inventarisierung zum Einsatz. Es ist möglich, das File-Backend für die Inventarisierung zu verwenden -- das ist allerdings deutlich langsamer.

=== MySQL-Backend konfigurieren

Im Folgenden zeigen wir, wie Sie das MySQL-Backend einrichten. Wir gehen davon aus, dass Sie den MySQL-Server installiert und konfiguriert haben und dass Sie die Zugangsdaten des Datenbank-Administrators kennen.

TIP: Wenn Sie unsere vorkonfigurierte virtuelle Maschine einsetzen, lautet das Kennwort für den Datenbank-Administrator `linux123`. Aus Sicherheitsgründen sollten Sie dieses in einer Produktivumgebung ändern. Weitere Informationen zu MySQL entnehmen Sie bitte den Handbüchern Ihrer Distribution.

Zur initialen Konfiguration des MySQL-Backends geben Sie den folgenden Befehl ein; er erfordert Root-Rechte:

[source,prompt]
----
opsi-setup --configure-mysql
----

Sie sehen das folgende Dialogfenster:

.Konfigurieren Sie das MySQL-Backend für den opsi-Server.
image::mysql-config-input-mask.png["Konfigurieren Sie das MySQL-Backend für den opsi-Server.", pdfwidth=80%]

Tragen Sie `localhost` im Feld `Database host` ein, der `Database admin user` ist `root` (falls nicht anders konfiguriert), und ins Feld `Database admin password` gehört das bei der MySQL-Server-Installation eingerichtete Administrator-Kennwort. Die anderen Voreinstellungen können Sie übernehmen. Verwenden Sie die [Tab]-Taste, um zu `OK` zu navigieren und drücken Sie [Eingabe].

Anschließend wird die neue Datenbank `opsi` und ein neuer Benutzer `opsi` mit entsprechenden Berechtigungen für diese Datenbank angelegt.

.Die neue Datenbank und ein Benutzer wurden angelegt.
image::mysql-config-output.png["Die neue Datenbank und ein Benutzer wurden angelegt.", pdfwidth=80%]

Zum Schluss sollten Sie die Meldung `MySQL Backend configuration done` sehen.

=== Methoden und Backends zuordnen

Unterschiedliche Daten kann opsi in unterschiedlichen Backends vorhalten. Zudem müssen über bestimmte Vorgänge immer mehrere Backends informiert werden. Dazu ordnet die Konfigurationsdatei `/etc/opsi/backendManager/dispatch.conf` die opsi-Methoden den Backends zu.

Hier ist ein Beispiel:

[source,configfile]
----
# = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
# =      backend dispatch configuration                                     =
# = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
#
# This file configures which methods are dispatched to which backends.
# Entries has to follow the form:
# <regular expression to match method name(s)> : <comma separated list of backend name(s)>
#
# Backend names have to match a backend configuration
# file basename <backend name>.conf beneath /etc/opsi/backends.
# For every method executed on backend dispatcher
# the first matching regular expression will be decisive.

# Recommended standard configuration (dhcpd not at the opsi server)
#    file as main backend, mysql as hw/sw invent
#     and license management backend and opsipxeconfd backend:
backend_.*         : file, mysql, opsipxeconfd
host_.*            : file, opsipxeconfd
productOnClient_.* : file, opsipxeconfd
configState_.*     : file, opsipxeconfd
license.*          : mysql
softwareLicense.*  : mysql
audit.*            : mysql
.*                 : file
----

Im oberen Bereich finden Sie zahlreiche Beispiele und Erklärungen; diese sind mit einem Rautezeichen am Zeilenanfang auskommentiert. Ganz unten steht in den nicht auskommentierten Zeilen jeweils der Name der opsi-Methoden (mit Wildcard `.*`) und nach einem Doppelpunkt die Liste der dafür zuständigen Backends.

Bei jedem Methodenaufruf prüft opsi anhand dieser Liste, welche Backends es ansprechen muss. Dabei nimmt es die erste Zeile, die zum Namen der Methode passt. Die letzte Zeile (`.*`) passt zu allen Methoden.

Die Standardeinstellung nach der Installation ist: Das File-Backend steht an erster Stelle, außer beim Lizenzmanagement und bei der Hardware-/Software-Inventarisierung. Dort übernimmt das MySQL-Backend.

CAUTION: Achten Sie darauf, dass die erste Zeile (`backend_.*`) alle verwendeten Backends auflistet!

Wenn Sie die Datei `dispatch.conf` bearbeitet haben, führen Sie anschließend die folgenden Befehle aus:

[source,prompt]
----
opsi-setup --init-current-config
opsi-set-rights
systemctl restart opsiconfd.service
systemctl restart opsipxeconfd.service
----

Die Befehle übernehmen die Änderung in die opsi-Datenbank, setzen die Berechtigungen und starten die beiden Dienste `opsiconfd` und `opsipxeconfd` neu.

[[opsi-getting-started-installation-config-passwords]]
== Samba-Konfiguration 

Um sicherzustellen, dass die für opsi erforderlichen Samba-Freigaben verfügbar sind, führen Sie den folgenden Befehl aus:

[source,prompt]
----
opsi-setup --auto-configure-samba
----

Anschließend starten Sie die Samba-Dienste neu:

[source,prompt]
----
systemctl restart smbd.service
systemctl restart nmbd.service
----

TIP: Wenn Sie bei der Aktualisierung der Pakete des opsi-Servers gefragt werden, ob die Datei `smb.conf` überschrieben werden soll, bestätigen Sie das. Falls Sie die Datei `/etc/samba/smb.conf` vor dem Upgrade geändert haben, behalten Sie diese und gleichen die beiden Dateien miteinander ab.

=== Passwort für Benutzer `pcpatch`

Auf dem opsi-Server gibt es einen Pseudo-Benutzer `pcpatch`. Die Clients nutzen diesen Account bei der Installation von Softwarepaketen und haben nach der Anmeldung Zugriff auf die Installationsdateien auf den hierfür vorgesehenen Freigaben. Der Benutzer `pcpatch` benötigt ein Passwort, das für den System-Account, den Samba-Account und für den opsi-Account gilt. Sie setzen dieses Kennwort für alle drei Konten mit dem Tool `opsi-admin` in einem einzigen Aufruf:

[source,prompt]
----
opsi-admin -d task setPcpatchPassword
----

Nach dem Betätigen von [Eingabe] erscheint ein Passwort-Prompt, und Sie können das Kennwort eintippen.

[[opsi-getting-started-installation-config-users-and-groups]]
== Benutzer und Gruppen für opsi

NOTE: Auf der vorkonfigurierten virtuellen Maschine sind der Account `adminuser` sowie die beiden Gruppen `opsiadmin` und `opsifileadmins` bereits eingerichtet, sodass Sie diesen Abschnitt überspringen können.

Um den opsi-Server zu administrieren, muss ein Benutzer Mitglied der Gruppe `opsiadmin` sein. Das folgende Kommando erstellt einen neuen Benutzeraccount namens `adminuser`; Sie führen es als `root` aus:

[source,prompt]
----
useradd -m -s /bin/bash adminuser
----

Anschließend setzen Sie für den neuen Account ein Unix-Passwort (System):

[source,prompt]
----
passwd adminuser
----

Außerdem benötigt der Account ein Passwort für Samba:

[source,prompt]
----
smbpasswd -a adminuser
----

CAUTION: Verwenden Sie in den beiden Passwörtern kein `§`-Zeichen!

Als Nächstes fügen Sie den Account `adminuser` der Gruppe `opsiadmin` hinzu:

[source,prompt]
----
usermod -aG opsiadmin adminuser
----

Sie können mit dem `getent`-Befehl überprüfen, dass alles geklappt hat:

[source,prompt]
----
getent group opsiadmin
opsiadmin:x:1001:opsiconfd,adminuser,root
----

NOTE: Wenn `root` nicht Mitglied der Gruppe `opsiadmin` ist, kann der Benutzer unter Umständen nicht alle opsi-Administrations-Kommandos ausführen! 

Für alltägliche Arbeiten auf Ihrem opsi-Server ist es in der Regel nicht notwendig, als `root` zu arbeiten.
Wir empfehlen, sich als normaler Benutzer anzumelden und `sudo` vor die Kommandos zu stellen, die Root-Rechte benötigen.

Alle Benutzer, die Produkte packen (`opsi-makepackage`), installieren (`opsi-package-manager`) oder Konfigurationsdateien im Texteditor bearbeiten, müssen zusätzlich Mitglied in der Gruppe `opsifileadmins` sein:

[source,prompt]
----
usermod -aG opsifileadmins adminuser
----

Sie können wiederum `getent` zur Kontrolle verwenden:

[source,prompt]
----
getent group opsifileadmins
opsifileadmins:x:999:adminuser,root
----

Damit Mitglieder der Gruppe `opsifileadmins` den Befehl `sudo opsi-set-rights` nutzen können, führen Sie das folgende Kommando aus:

[source,prompt]
----
opsi-setup --patch-sudoers-file
----

TIP: `opsi-set-rights` ist gleichbedeutend zu `opsi-setup --set-rights`.

[[opsi-getting-started-installation-config-dhcp]]
== DHCP-Konfiguration

Eine korrekt funktionierende Namensauflösung (siehe Abschnitt <<opsi-getting-started-installation-config-nameresolution>>) und DHCP (Dynamic Host Configuration Protocol) sind wichtig, damit opsi korrekt funktioniert. In diesem Abschnitt geht es um DHCP: Das Protokoll sorgt dafür, dass neu eingebundene Geräte im Netzwerk automatisch konfiguriert werden. Dazu gehören etwa die dynamische Zuweisung von IP-Adressen, Netzmaske, Gateway usw. 

Der opsi-Server kann als DHCP-Server arbeiten und angeschlossene Clients automatisch konfigurieren (Abschnitt <<opsi-getting-started-installation-config-dhcp-at-opsi>>). In vielen Umgebungen ist bereits ein DHCP-Server vorhanden; daher beschreibt Abschnitt <<opsi-getting-started-installation-config-at-other-server>>, wie Sie diesen nutzen.

[[opsi-getting-started-installation-config-dhcp-at-opsi]]
=== DHCP auf dem opsi-Server

NOTE: Die vorkonfigurierte virtuelle Maschine ist bereits mit einem DHCP-Server ausgestattet, der keine freien Leases hat, also keine IP-Adressen an Rechner vergibt. Wenn Sie über die Management-Oberfläche `opsi-configed` einen Client erzeugen, geben Sie daher dessen IP- und die MAC-Adresse an, die dann in die Konfigurationsdatei `/etc/dhcp/dhcpd.conf` eingetragen werden.

Nach einer solchen Änderung starten Sie den DHCP-Dienst neu:

[source,prompt]
----
systemctl restart isc-dhcp-server
----

Wenn Sie den opsi-Server selbst installiert haben und als DHCP-Server verwenden möchten, installieren Sie das Paket nach. Seit opsi 4.0.3 wird dieses nicht mehr automatisch installiert.

Auf Debian-basierten Systemen geben Sie dazu das folgende Kommando ein:

[source,prompt]
----
apt install isc-dhcp-server
----

TIP: Je nach Distribution heißt das Paket auch `dhcp-server` (RHEL, Rocky Linux, AlmaLinux, SLES usw.) -- schauen Sie im Zweifelsfall im Handbuch nach.

Nach der Installation passen Sie die Konfigurationsdatei an; dazu können Sie das Tool `opsi-setup` verwenden:

[source,prompt]
----
opsi-setup --auto-configure-dhcpd
----

Die Rechte der Datei `/etc/dhcp/dhcpd.conf` sollten wie folgt aussehen:

[source,prompt]
----
-rw-r--r-- 1 opsiconfd opsiadmin 80174 Dec 22 14:37 /etc/dhcp/dhcpd.conf
----

[[opsi-getting-started-installation-config-at-other-server]]
=== Externen DHCP-Server nutzen

NOTE: Den DHCP-Server der vorkonfigurierten virtuellen Maschine deinstallieren Sie mit dem folgenden Befehl:

[source,prompt]
----
apt remove isc-dhcp-server
----

Gibt es in Ihrem Netzwerk bereits einen DHCP-Server, dann konfigurieren Sie diesen so, dass er ein PXE-Boot über den opsi-Server ermöglicht. Läuft der Dienst auf einem Linux-Rechner, dann passen Sie die Konfigurationsdatei `/etc/dhcp/dhcpd.conf` an und tragen Folgendes ein:

[source,configfile]
----
next-server <IP-opsi-Server>;
filename "linux/pxelinux.0";
----

Ersetzen Sie `<IP-opsi-Server>` durch die IP-Adresse Ihres opsi-Servers.

Unter openSUSE und SLES lautet die zweite Zeile so:

[source,configfile]
----
filename=opsi/pxelinux.0
----

Unter UCS lautet die Zeile so:

[source,configfile]
----
filename=pxelinux.0
----

Bei einem Windows-Server sind die entsprechenden Einträge `Startserver (Option 66)` und `Startfile (Option 67)`.

NOTE: Wenn Sie einen externen DHCP-Server nutzen, geben Sie beim Erstellen eines Clients in der Management-Oberfläche `opsi-configed` dessen MAC-Adresse an, aber keine IP-Adresse.


[[opsi-getting-started-installation-config-dhcp-backend]]
=== Backend anpassen

Je nachdem, ob Sie den DHCP-Server auf dem opsi-Server oder als externen Dienst verwenden, sieht die Backend-Konfiguration anders aus. In der Datei `/etc/opsi/backendManager/dispatch.conf` legen Sie fest, welche opsi-Backends zum Einsatz kommen (siehe auch Abschnitt <<opsi-getting-started-installation-config-backend>>).

Die beiden Zeilen `backend_.*` und `host_.*` steuern, ob der opsi-Server die Zuweisung von IP-Adressen zu den MAC-Adressen der Netzwerkkarten übernimmt. ## 

In den Zeilen `backend_.*` und `host_.*` wird u.a. gesteuert, ob der {opsi-Server} auch die lokale DHCP-Konfiguration – also die Zuweisung von Internet-Adressen zu den Hardware-Adressen der Netzwerkkarten – mit übernimmt.
Dies muss so eingerichtet sein, wenn für die {opsi-Client}s die DHCP-Einträge durch die opsi-Konfigurationsaufrufe erzeugt werden sollen. Der entsprechende Eintrag mit `file` Backend muss dann z.B. lauten:
[source,configfile]
----
backend_.*         : file, opsipxeconfd, dhcpd
host_.*            : file, opsipxeconfd, dhcpd
----

Wenn der {opsi-Server} den DHCP-Dienst nicht bereitstellen soll (weil ein anderer Server im lokalen Netz diese Aufgabe übernimmt und auch für die {opsi-Client}s gepflegt wird), so wird das Backend `dhcpd` nicht benötigt:

[source,configfile]
----
backend_.*         : file, opsipxeconfd
host_.*            : file, opsipxeconfd
----

Nach Anpassung der Backendkonfiguration muss die Konfiguration initialisiert und der {opsiconfd} neu gestartet werden:

[source,prompt]
----
opsi-setup --init-current-config
opsi-set-rights
systemctl restart opsiconfd.service
systemctl restart opsipxeconfd.service
----


[[opsi-getting-started-installation-config-nameresolution]]
== Namensauflösung

Für die Installation der Software auf den Clients vor dem Login müssen allgemein nur die Clients wissen, wie sie den {opsi-Server} erreichen.

opsi kennt inzwischen allerdings auch eine Reihe von 'Push' Funktionalitäten wie z.B. 'on_demand' Installationen, Nachrichten versenden, Remote-Control Software starten, Session Informationen abrufen.

Für all diese Funktionen muss der Server die Clients erreichen können und dazu muss er die gültige IP-Nummer des Clients zu ermitteln. Wie dies am besten geschieht hängt von der konkreten Konfiguration von DNS und DHCP ab. Die Zahl der möglichen Varianten ist hier sehr groß.

Daher seien hier zwei typische Extreme aufgeführt:

. Die Clients sind nicht im DNS und haben dynamisch zugewiesene wechselnde IP-Nummern.

. Die IP-Nummern aller laufenden Clients lassen sich immer korrekt beim DNS abfragen.

Um den opsi-server nun an die unterschiedlichen Gegebenheiten anpassen zu können gibt es zwei Konfigurationen die Sie ändern können:

* Der Eintrag +resolveHostAddress+ in der Datei `/etc/opsi/backends/hostcontrol.conf` +
Steht diese Option auf 'True', wird bei einem Verbindungsaufbau vom {opsi-server} zu einem opsi-client die IP-Adresse des Clients bevorzugt über die Namensauflösung ermittelt. Um die im Backend von opsi hinterlegte IP-Adresse zu bevorzugen ist die Option auf 'False' zu setzen.

* Der Eintrag +update-ip+ in der Datei `/etc/opsi/opsiconfd.conf` +
Steht dieser Eintrag auf 'true', so wird wann immer der opsi-server von einem Client eine IP-Adresse empfängt (z.B. bei jedem Kontakt die der Client aufnimmt) die IP-Datenbank des opsi-servers aktualisiert. Der Default ist 'true'.

Für die oben aufgeführte Variante 1, ist es sinnvoll +resolveHostAddress+ auf 'False' und +update-ip+ auf 'true' zu setzen.

Für die oben aufgeführte Variante 2, ist die bessere Konfiguration  +resolveHostAddress+ auf 'True' zu setzen und +update-ip+ auf 'false'.

Welche Kombination bei Ihnen am besten passt, müssen Sie anhand Ihrer Gegebenheiten selbst ermitteln.

Wenn Sie an diesen Konfigurationen etwas geändert haben, so starten Sie den opsiconfd neu:

[source,prompt]
----
systemctl restart opsiconfd.service
----
