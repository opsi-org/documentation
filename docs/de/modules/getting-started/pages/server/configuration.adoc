////
; Copyright (c) uib gmbh (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: https://www.opsi.org/credits/
////

:Author:    uib gmbh
:Email:     info@uib.de
:Date:      24.04.2023
:Revision:  4.2
:toclevels: 6
:doctype:   book
:icons: font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]

[[opsi-getting-started-installation-config]]
= Konfiguration

Dieses Kapitel erklärt zuerst, wie Sie einen frisch installierten opsi-Server aktualisieren und dann die Standard-Produkte einspielen. Danach ä######äää

[[opsi-getting-started-installation-config-update-server]]
== opsi-Server aktualisieren

Bevor Sie den opsi-Server konfigurieren, bringen sie zunächst die Pakete des zugrundeliegenden Linux-Systems auf den aktuellen Stand. Wenn Sie die von uns bereitgestellte virtuelle Maschine verwenden (siehe Abschnitt xref:getting-started:server/base-installation.adoc#opsi-getting-started-installation-base-vm[Inbetriebnahme der vorkonfigurierten virtuellen Maschine]), dann nutzen Sie dazu das Paketverwaltungstool APT, denn die VM basiert auf der letzten LTS-Version von Ubuntu. APT verwenden Sie ebenfalls zum Aktualisieren von Debian und anderen Ubuntu-Versionen. Der letzte Befehl deinstalliert nicht mehr benötigte Pakete, die als Abhängigkeit installiert waren:

[source,prompt]
----
sudo apt update
sudo apt upgrade
sudo apt autoremove
----

TIP: Wenn Sie unsere vorkonfigurierte virtuelle Maschine einsetzen, dann können Sie das Symbol _Update OS_ auf dem Desktophintergrund zur Aktualisierung der Pakete verwenden. Doppelklicken Sie es und geben dann das Kennwort des Benutzers `adminuser` ein.

Verwenden Sie SLES/openSUSE, dann nutzen Sie das Werkzeug `zypper`:

[source,prompt]
----
sudo zypper refresh
sudo zypper update
----

Unter RHEL/AlmaLinux/Rocky Linux heißen die Befehle zum Aktualisieren der Distribution so:

[source,prompt]
----
sudo yum check-update
sudo yum update
----

Nachdem das Upgrade abgeschlossen ist, starten Sie den Server neu.

NOTE: Falls Sie einen Proxy-Server zum Zugriff auf das Internet verwenden, konfigurieren Sie diesen über die Umgebungsvariablen `http_proxy` und `https_proxy` (siehe Kapitel xref:getting-started:server/requirements.adoc[Voraussetzungen]).

[[opsi-getting-started-installation-config-update-opsi-product]]
== Standard-Produkte einspielen

Nach der Installation des opsi-Servers und der Aktualisierung des zugrundeliegenden Linux-Systems spielen Sie die opsi-Standard-Produkte ein. Dazu geben Sie den folgenden Befehl in ein Terminalfenster ein:

[source,prompt]
----
sudo opsi-package-updater -v install
----

Auf Aufforderung geben Sie das Passwort für den Benutzer `adminuser` ein.

Das Kommando aktualisiert alle vorhandenen opsi-Pakete inklusive der Templates für Betriebssystem-Installationen aus den opsi-Repositorys. 

.Innstallieren Sie die Standard-Produkte auf Ihrem opsi-Server.
image::opsi-package-updater.png["Installieren Sie die Standard-Produkte auf Ihrem opsi-Server.", pdfwidth=80%]

TIP: Auf unserer vorkonfigurierten virtuellen Maschine können Sie alternativ das Desktop-Icon _First package installation_ doppelklicken, um die Standard-Produkte zu installieren.

[[opsi-getting-started-installation-config-update-start-configed]]
== Management-Oberfläche starten

Die Management-Oberfläche `opsi-configed` starten Sie in der virtuellen Maschine über einen Doppelklick auf das Desktopsymbol _Opsi Configuration Editor_. Weitere Informationen zu dieser grafischen Anwendung finden Sie in xref:manual:configed.adoc[Management-Oberfläche `opsi-configed`].

[[opsi-getting-started-installation-config-backend]]
== Backend-Konfiguration

opsi unterstützt unterschiedliche Backends. Für die Datenhaltung sind das diese beiden:

* *file*:  Datenhaltung in Dateien
* *mysql*: Datenhaltung in einer MySQL-Datenbank

NOTE: Einige Distributionen verwenden MariaDB anstelle von MySQL. Das MySQL-Backend funktioniert auch mit MariaDB. Das MySQL-Backend zur Inventarisierung ist kostenlos. Mehr zu den kostenpflichtigen Erweiterungen lesen Sie in Kapitel xref:manual:modules/modules.adoc[opsi-Erweiterungen].

Daneben gibt es diese Backends für spezielle Zwecke:

* *opsipxeconfd*: der Dienst für opsi-Netzwerkboot
* *dhcpd*: zur Kommunikation mit dem DHCP-Dienst auf dem opsi-Server
* *jsonrpc*: JSON-RPC-Methoden auf einem opsi-Server ausführen

In der Voreinstellung kommt das MySQL-Backend bei der Inventarisierung zum Einsatz. Es ist möglich, das File-Backend für die Inventarisierung zu verwenden -- das ist allerdings deutlich langsamer.

=== MySQL-Backend konfigurieren

Im Folgenden zeigen wir, wie Sie das MySQL-Backend einrichten. Wir gehen davon aus, dass Sie den MySQL-Server installiert und konfiguriert haben und dass Sie die Zugangsdaten des Datenbank-Administrators kennen.

TIP: Wenn Sie unsere vorkonfigurierte virtuelle Maschine einsetzen, lautet das Kennwort für den Datenbank-Administrator `linux123`. Aus Sicherheitsgründen sollten Sie dieses in einer Produktivumgebung ändern. Weitere Informationen zu MySQL entnehmen Sie bitte den Handbüchern Ihrer Distribution.

Zur initialen Konfiguration des MySQL-Backends geben Sie den folgenden Befehl ein; er erfordert Root-Rechte:

[source,prompt]
----
opsi-setup --configure-mysql
----

Sie sehen das folgende Dialogfenster:

.Konfigurieren Sie das MySQL-Backend für den opsi-Server.
image::mysql-config-input-mask.png["Konfigurieren Sie das MySQL-Backend für den opsi-Server.", pdfwidth=80%]

Tragen Sie `localhost` im Feld `Database host` ein, der `Database admin user` ist `root` (falls nicht anders konfiguriert), und ins Feld `Database admin password` gehört das bei der MySQL-Server-Installation eingerichtete Administrator-Kennwort. Die anderen Voreinstellungen können Sie übernehmen. Verwenden Sie die [Tab]-Taste, um zu `OK` zu navigieren und drücken Sie [Eingabe].

Anschließend wird die neue Datenbank `opsi` und ein neuer Benutzer `opsi` mit entsprechenden Berechtigungen für diese Datenbank angelegt.

.Die neue Datenbank und ein Benutzer wurden angelegt.
image::mysql-config-output.png["Die neue Datenbank und ein Benutzer wurden angelegt.", pdfwidth=80%]

Zum Schluss sollten Sie die Meldung `MySQL Backend configuration done` sehen.

=== Methoden und Backends zuordnen

Unterschiedliche Daten kann opsi in unterschiedlichen Backends vorhalten. Zudem müssen über bestimmte Vorgänge immer mehrere Backends informiert werden. Dazu ordnet die Konfigurationsdatei `/etc/opsi/backendManager/dispatch.conf` die opsi-Methoden den Backends zu.

Hier ist ein Beispiel:

[source,configfile]
----
# = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
# =      backend dispatch configuration                                     =
# = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
#
# This file configures which methods are dispatched to which backends.
# Entries has to follow the form:
# <regular expression to match method name(s)> : <comma separated list of backend name(s)>
#
# Backend names have to match a backend configuration
# file basename <backend name>.conf beneath /etc/opsi/backends.
# For every method executed on backend dispatcher
# the first matching regular expression will be decisive.

# Recommended standard configuration (dhcpd not at the opsi server)
#    file as main backend, mysql as hw/sw invent
#     and license management backend and opsipxeconfd backend:
backend_.*         : file, mysql, opsipxeconfd
host_.*            : file, opsipxeconfd
productOnClient_.* : file, opsipxeconfd
configState_.*     : file, opsipxeconfd
license.*          : mysql
softwareLicense.*  : mysql
audit.*            : mysql
.*                 : file
----

Im oberen Bereich finden Sie zahlreiche Beispiele und Erklärungen; diese sind mit einem Rautezeichen am Zeilenanfang auskommentiert. Ganz unten steht in den nicht auskommentierten Zeilen jeweils der Name der opsi-Methoden (mit Wildcard `.*`) und nach einem Doppelpunkt die Liste der dafür zuständigen Backends.

Bei jedem Methodenaufruf prüft opsi anhand dieser Liste, welche Backends es ansprechen muss. Dabei nimmt es die erste Zeile, die zum Namen der Methode passt. Die letzte Zeile (`.*`) passt zu allen Methoden.

Die Standardeinstellung nach der Installation ist: Das File-Backend steht an erster Stelle, außer beim Lizenzmanagement und bei der Hardware-/Software-Inventarisierung. Dort übernimmt das MySQL-Backend.

CAUTION: Achten Sie darauf, dass die erste Zeile (`backend_.*`) alle verwendeten Backends auflistet!

Wenn Sie die Datei `dispatch.conf` bearbeitet haben, führen Sie anschließend die folgenden Befehle aus:

[source,prompt]
----
opsi-setup --init-current-config
opsi-set-rights
systemctl restart opsiconfd.service
systemctl restart opsipxeconfd.service
----

Die Befehle übernehmen die Änderung in die opsi-Datenbank, setzen die Berechtigungen und starten die beiden Dienste `opsiconfd` und `opsipxeconfd` neu.

[[opsi-getting-started-installation-config-passwords]]
== Samba-Konfiguration 

Um sicherzustellen, dass die für opsi erforderlichen Samba-Freigaben verfügbar sind, führen Sie den folgenden Befehl aus:

[source,prompt]
----
opsi-setup --auto-configure-samba
----

Anschließend starten Sie die Samba-Dienste neu:

[source,prompt]
----
systemctl restart smbd.service
systemctl restart nmbd.service
----

TIP: Wenn Sie bei der Aktualisierung der Pakete des opsi-Servers gefragt werden, ob die Datei `smb.conf` überschrieben werden soll, bestätigen Sie das. Falls Sie die Datei `/etc/samba/smb.conf` vor dem Upgrade geändert haben, behalten Sie diese und gleichen die beiden Dateien miteinander ab.

=== Passwort für Benutzer `pcpatch`

Auf dem opsi-Server gibt es einen Pseudo-Benutzer `pcpatch`. Die Clients nutzen diesen Account bei der Installation von Softwarepaketen und haben nach der Anmeldung Zugriff auf die Installationsdateien auf den hierfür vorgesehenen Freigaben. Der Benutzer `pcpatch` benötigt ein Passwort, das für den System-Account, den Samba-Account und für den opsi-Account gilt. Sie setzen dieses Kennwort für alle drei Konten mit dem Tool `opsi-admin` in einem einzigen Aufruf:

[source,prompt]
----
opsi-admin -d task setPcpatchPassword
----

Nach dem Betätigen von [Eingabe] erscheint ein Passwort-Prompt, und Sie können das Kennwort eintippen.

[[opsi-getting-started-installation-config-users-and-groups]]
== Benutzer und Gruppen für opsi

NOTE: Auf der vorkonfigurierten virtuellen Maschine sind der Account `adminuser` sowie die beiden Gruppen `opsiadmin` und `opsifileadmins` bereits eingerichtet, sodass Sie diesen Abschnitt überspringen können.

Um den opsi-Server zu administrieren, muss ein Benutzer Mitglied der Gruppe `opsiadmin` sein. Das folgende Kommando erstellt einen neuen Benutzeraccount namens `adminuser`; Sie führen es als `root` aus:

[source,prompt]
----
useradd -m -s /bin/bash adminuser
----

Anschließend setzen Sie für den neuen Account ein Passwort (System):

[source,prompt]
----
passwd adminuser
----

Außerdem benötigt der Account ein Passwort für Samba:

[source,prompt]
----
smbpasswd -a adminuser
----

CAUTION: Verwenden Sie in den Passwörtern kein `§`-Zeichen, da dies bei der Verbindung zum opsi-Service nicht erlaubt ist.

Als Nächstes fügen Sie den Account `adminuser` der Gruppe `opsiadmin` hinzu:

[source,prompt]
----
usermod -aG opsiadmin adminuser
getent group opsiadmin
----

Der `getent`-Befehl sollte dann so etwas ausgeben:

[source,prompt]
----
opsiadmin:x:1001:opsiconfd,adminuser
----

NOTE: Wenn 'root' nicht Mitglied von {opsi-admin-group} ist, kann er unter Umständen nicht alle opsi-Administrationskommandos ausführen! +

Für alltägliche Arbeiten auf Ihrem opsi-Server ist es in der Regel nicht notwendig als 'root' zu arbeiten.
Unsere Empfehlung ist es einen normalen Benutzer zu nutzen und `sudo` zu verwenden, wann immer administrative Privilegien benötigt werden.

Alle User, die Produkte packen (`opsi-makepackage`), installieren (`opsi-package-manager`) oder Konfigurationsdateien manuell bearbeiten wollen, müssen zusätzlich in der Gruppe '{opsi-file-admin-group}' sein:

[source,prompt]
----
usermod -aG opsifileadmins adminuser
----

Der Test

[source,prompt]
----
getent group opsifileadmins
----
ergibt +
'opsifileadmins:x:998:adminuser'

Damit Mitglieder der Gruppe '{opsi-file-admin-group}' den Befehl `sudo opsi-set-rights` nutzen können führen Sie bitte aus:
[source,prompt]
----
opsi-setup --patch-sudoers-file
----

Dann kann `opsi-set-rights` (macht das selbe wie `opsi-setup --set-rights`), nicht nur als root, sondern auch per sudo von Mitgliedern der Gruppe '{opsi-file-admin-group}' aufgerufen werden.:

Beispiel: +
[source,prompt]
----
sudo opsi-set-rights .
----


[[opsi-getting-started-installation-config-dhcp]]
== DHCP-Konfiguration

Eine korrekt funktionierende Namensauflösung und DHCP ist für das Funktionieren von opsi essentiell.
Um die Installation zu vereinfachen, ist die von uib bereitgestellte VM schon mit einem DHCP-Server ausgestattet.
Auf der anderen Seite ist in vielen Umgebungen in der Regel bereits ein DHCP-Server schon vorhanden, der weiter genutzt werden soll.
Daher werden im folgenden beide Alternativen beschrieben.


[[opsi-getting-started-installation-config-dhcp-at-opsi]]
=== Alternative: DHCP auf dem {opsi-Server}

.Vorkonfigurierte VM:
In der vorkonfigurieren opsi VM ist bereits ein DHCP-Server installiert. +
Der DHCP-Server auf der {opsi-Server} VM ist so konfiguriert, das er keine freien leases hat, also keine IP-Nummern an unbekannte Rechner vergibt.
Wenn Sie im {opsi-configed} einen Client erzeugen, müssen Sie daher IP-Nummer und MAC-Adresse angeben, da diese in die `/etc/dhcp/dhcpd.conf` eingetragen und danach der DHCP Dienst neu gestartet wird.

.Eigene Installation:
Wenn Sie den opsi-Server als DHCP-Server verwenden möchten, müssen Sie daher das entsprechende Paket manuell nachinstallieren

z.B. mit
[source,prompt]
----
apt install isc-dhcp-server
----

Nach der Installation muss die Konfigurationsdatei noch angepasst werden mit dem Befehl:
[source,prompt]
----
opsi-setup --auto-configure-dhcpd
----
Um den DHCP Server neu zu starten, so wie in `/etc/opsi/backends/dhcpd.conf` beschrieben, ist ein entsprechender Eintrag in der `/etc/sudoers` notwendig. Dieser wird mit folgendem Befehl erstellt.
[source,prompt]
----
opsi-setup --patch-sudoers-file
----
Die Rechte der `/etc/dhcp/dhcpd.conf` sollten wie folgt aussehen.
[source,prompt]
----
-rw-r--r-- 1 opsiconfd opsiadmin 80174 Dec 22 14:37 /etc/dhcp/dhcpd.conf
----


[[opsi-getting-started-installation-config-at-other-server]]
=== Alternative: externer DHCP-Server

.Vorkonfigurierte VM:
Wenn Sie die opsi-VM verwenden dann können Sie den DHCP-Server deinstallieren.

Dazu führen Sie den folgenden Befehl aus:
[source,prompt]
----
apt remove isc-dhcp-server
----

.Eigene Installation:
Bei einer eigenen Installation wird seit opsi 4.0.3 nicht mehr automatisch ein DHCP-Server installiert.

Nun müssen Sie den externen DHCP-Server so konfigurieren, dass er ein PXE-Boot über den {opsi-Server} ermöglicht. Wenn Ihr DHCP-Server auf einem Linux läuft, sind folgende Einträge in der Konfigurationsdatei des dhcpd (z.B. `/etc/dhcp/dhcpd.conf`) für die Clients notwendig:

[source,configfile]
----
next-server <ip of opsi-server>;
filename "linux/pxelinux.0";
----

Wobei '<ip of opsi-server>' durch die IP-Adresse des {opsi-Server}s zu ersetzen ist.

Läuft der opsi-Server auf openSUSE oder SLES, so ist `filename=opsi/pxelinux.0`. +
Läuft der opsi-Server auf UCS, so ist `filename=pxelinux.0`.

Bei einem Windows-Server sind die entsprechenden Einträge 'Startserver (Option 66)' und 'Startfile (Option 67)'.

Wenn Sie im {opsi-configed} einen Client erzeugen, müssen Sie die MAC-Adresse angeben, aber keine IP-Nummer.


[[opsi-getting-started-installation-config-dhcp-backend]]
=== Überprüfung/Anpassung Backendkonfiguration für DHCP-Nutzung

Je nachdem ob der interne oder ein externer DHCP-Server verwendet wird, muss die Konfiguration von opsi angepasst werden.

In der Datei `/etc/opsi/backendManager/dispatch.conf` ist festgelegt, welche Backends von opsi zum Einsatz kommen (bspw. 'file', 'mysql').

In den Zeilen `backend_.*` und `host_.*` wird u.a. gesteuert, ob der {opsi-Server} auch die lokale DHCP-Konfiguration – also die Zuweisung von Internet-Adressen zu den Hardware-Adressen der Netzwerkkarten – mit übernimmt.
Dies muss so eingerichtet sein, wenn für die {opsi-Client}s die DHCP-Einträge durch die opsi-Konfigurationsaufrufe erzeugt werden sollen. Der entsprechende Eintrag mit `file` Backend muss dann z.B. lauten:
[source,configfile]
----
backend_.*         : file, opsipxeconfd, dhcpd
host_.*            : file, opsipxeconfd, dhcpd
----

Wenn der {opsi-Server} den DHCP-Dienst nicht bereitstellen soll (weil ein anderer Server im lokalen Netz diese Aufgabe übernimmt und auch für die {opsi-Client}s gepflegt wird), so wird das Backend `dhcpd` nicht benötigt:

[source,configfile]
----
backend_.*         : file, opsipxeconfd
host_.*            : file, opsipxeconfd
----

Nach Anpassung der Backendkonfiguration muss die Konfiguration initialisiert und der {opsiconfd} neu gestartet werden:

[source,prompt]
----
opsi-setup --init-current-config
opsi-set-rights
systemctl restart opsiconfd.service
systemctl restart opsipxeconfd.service
----


[[opsi-getting-started-installation-config-nameresolution]]
== Konfiguration der Namensauflösung

Für die Installation der Software auf den Clients vor dem Login müssen allgemein nur die Clients wissen, wie sie den {opsi-Server} erreichen.

opsi kennt inzwischen allerdings auch eine Reihe von 'Push' Funktionalitäten wie z.B. 'on_demand' Installationen, Nachrichten versenden, Remote-Control Software starten, Session Informationen abrufen.

Für all diese Funktionen muss der Server die Clients erreichen können und dazu muss er die gültige IP-Nummer des Clients zu ermitteln. Wie dies am besten geschieht hängt von der konkreten Konfiguration von DNS und DHCP ab. Die Zahl der möglichen Varianten ist hier sehr groß.

Daher seien hier zwei typische Extreme aufgeführt:

. Die Clients sind nicht im DNS und haben dynamisch zugewiesene wechselnde IP-Nummern.

. Die IP-Nummern aller laufenden Clients lassen sich immer korrekt beim DNS abfragen.

Um den opsi-server nun an die unterschiedlichen Gegebenheiten anpassen zu können gibt es zwei Konfigurationen die Sie ändern können:

* Der Eintrag +resolveHostAddress+ in der Datei `/etc/opsi/backends/hostcontrol.conf` +
Steht diese Option auf 'True', wird bei einem Verbindungsaufbau vom {opsi-server} zu einem opsi-client die IP-Adresse des Clients bevorzugt über die Namensauflösung ermittelt. Um die im Backend von opsi hinterlegte IP-Adresse zu bevorzugen ist die Option auf 'False' zu setzen.

* Der Eintrag +update-ip+ in der Datei `/etc/opsi/opsiconfd.conf` +
Steht dieser Eintrag auf 'true', so wird wann immer der opsi-server von einem Client eine IP-Adresse empfängt (z.B. bei jedem Kontakt die der Client aufnimmt) die IP-Datenbank des opsi-servers aktualisiert. Der Default ist 'true'.

Für die oben aufgeführte Variante 1, ist es sinnvoll +resolveHostAddress+ auf 'False' und +update-ip+ auf 'true' zu setzen.

Für die oben aufgeführte Variante 2, ist die bessere Konfiguration  +resolveHostAddress+ auf 'True' zu setzen und +update-ip+ auf 'false'.

Welche Kombination bei Ihnen am besten passt, müssen Sie anhand Ihrer Gegebenheiten selbst ermitteln.

Wenn Sie an diesen Konfigurationen etwas geändert haben, so starten Sie den opsiconfd neu:

[source,prompt]
----
systemctl restart opsiconfd.service
----
