////
; Copyright (c) uib gmbh (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: https://www.opsi.org/credits/
////

:Author:    uib gmbh
:Email:     info@uib.de
:Date:      21.04.2023
:Revision:  4.2
:toclevels: 6
:doctype:   book
:icons: font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]

[[opsi-getting-started-installation-base]]
= Installation

Dieses Kapitel stellt verschiedene Varianten zur Installation des opsi-Servers vor. Als Erstes erklärt es die <<opsi-getting-started-installation-base-vm>>, danach geht es um 
//<<opsi-getting-started-installation-base-docker>> und um
<<opsi-getting-started-installation-base-quickinstall>>, die <<opsi-getting-started-installation-base-packages>> unter Debian, Ubuntu, openSUSE/Suse Linux Enterprise Server (SLES), CentOS, Red Hat Enterprise Linux (RHEL), Alma Linux, Rocky Linux sowie die <<opsi-getting-started-installation-base-ucs>>.

[[opsi-getting-started-installation-base-vm]]
== Inbetriebnahme der vorkonfigurierten virtuellen Maschine

Der opsi-Server hat vergleichsweise geringe Anforderungen an die Rechengeschwindigkeit. Daher ist es problemlos möglich, ihn als virtuelle Maschine zu installieren und betreiben. Wir haben zu diesem Zweck eine VM eingerichtet, die wir auf unserer link:https://uib.de/de/opsi/opsi-testen-download/[Website] zum Download anbieten.

Sie können die virtuelle Maschine unter link:https://www.virtualbox.org/[VirtualBox], link:https://www.vmware.com/de/products/workstation-player.html[VMware Workstation Player] oder link:https://www.vmware.com/de/products/esxi-and-esx.html[VMware ESXi] betreiben.

[[opsi-getting-started-installation-base-vm-start]]
=== VM herunterladen und importieren

Laden Sie die virtuelle Maschine herunter und entpacken Sie die Zip-Datei. In den meisten grafischen Arbeitsumgebungen gelingt das im jeweiligen Dateimanager mit einem Rechtsklick und _Hier entpacken_ o.{nbsp}Ä. Alternativ verwenden Sie ein Programm wie link:https://www.7-zip.de/[7-Zip] (Windows) oder das Kommando `unzip` unter Linux auf der Shell. Anschließend finden Sie die drei Dateien `opsi[...].vmdk`, `opsi[...].mf` und `opsi[...].ovf` im aktuellen Verzeichnis.

So importieren Sie die virtuelle Maschine:

*VMware Workstation Player*

* Wählen Sie den Menüpunkt _Open a Virtual Maschine_ und navigieren Sie im Dateiauswahldialog ins Verzeichnis mit den Dateien aus dem gerade entpackten Zip-File. 
* Wählen Sie die Datei mit der Endung `.ovf` aus. (Ggf. ändern Sie am unteren Rand des Dialogs den Typ auf _Virtual Machines (*vmx, *.ovf, *.ova)_).
* Nach einem Klick auf _Öffnen_ können Sie der Maschine einen Namen geben und den Ort auswählen.
* Klicken Sie abschließend auf _Import_.
* Sie können die neue VM nun über _Power On_ starten.

.VMware Workstation Player: Import der virtuellen Maschine
image::vmware-player-import.png["VMware Workstation Player: Import der virtuellen Maschine", pdfwidth=80%]

*ESXi-Server*

* Starten Sie den vSphere Client.
* Erstellen Sie einen neuen Rechner über _Datei_ / _OVF-Vorlage bereitstellen_ und navigieren dann zur `.ovf`-Datei.
* Klicken Sie auf _Öffnen_ und dann _Weiter_.
* Geben Sie einen Namen ein oder übernehmen Sie die Voreinstellung.
* Klicken Sie auf _Weiter_, um eine Übersicht aller Einstellungen zu erhalten. Über die Schaltfläche _Beenden_ starten Sie den Import.

*VirtualBox*

* Wählen Sie _Datei_ / _Appliance importieren_ aus dem Menü.
* Navigieren Sie im Dateiauswahldialog zur `.ovf`-Datei und klicken _Öffnen_.
* Nach einem Klick auf _Weiter_ können Sie im folgenden Dialog die Einstellungen bearbeiten und beispielsweise den Namen, die Größe des Arbeitsspeichers usw. verändern.
* Klicken Sie abschließend auf _Importieren_.

.VirtualBox: Import der virtuellen Maschine
image::virtualbox-import.png["VirtualBox: Import der virtuellen Maschine", pdfwidth=80%]

[[opsi-getting-started-installation-base-vm-lang]]
=== VM booten und Sprache wählen

Booten Sie die neue virtuelle Maschine. Im ersten Dialog wählen Sie die Sprache des neuen opsi-Servers aus. Navigieren Sie mit [Tab] zum gewünschten Eintrag und drücken die Leertaste, um ihn zu markieren. Anschließend betätigen Sie wieder [Tab], bis Sie _Ok_ erreichen und drücken [Eingabe].

.Wählen Sie die Sprache für Ihren neuen opsi-Server aus.
image::1stboot-language-selection.png["Wählen Sie die Sprache für Ihren neuen opsi-Server aus.", pdfwidth=80%]

Sie sehen nun die Meldung, dass das Installationsprogramm die Netzwerkeinstellungen des opsi-Servers anpasst. Bestätigen Sie das mit [Eingabe].

TIP: Je nach Umgebung und Virtualisierungs-Software kann es vorkommen, dass Systemmeldungen im Fenster auftauchen und die Dialoge des Installationsskripts unlesbar werden. Mit der Tastenkombination [Strg]+[L] setzen Sie die Anzeige zurück.

[[opsi-getting-started-installation-base-vm-1stboot]]
===  Erster Start: das Skript `1stboot.py`

Das Skript `1stboot.py`, das beim ersten Booten der Appliance automatisch startet, unterstützt Sie bei der Konfiguration des Netzwerks. Sie können das Skript jederzeit zu einem späteren Zeitpunkt über `/usr/local/bin/1stboot.py` auf der Kommandozeile aufrufen und die Einstellungen anpassen. Die Logdatei von `1stboot.py` ist `/var/lib/1stboot/1stboot.log`.

WARNING: `1stboot.py` eignet sich nicht, um einen konfigurierten {opsi-Server} nachträglich umzubenennen!

.Das Skript `1stboot.py` unterstützt Sie bei der Netzwerkkonfiguration.
image::1st-startup-mask.png["Das Skript `1stboot.py` unterstützt Sie bei der Netzwerkkonfiguration.", pdfwidth=80%]

Das Skript erfragt die folgenden Informationen:

Servername:: Name diese opsi-Servers (ohne Domain), z.{nbsp}B. `opsiserver` oder `opsidepot`

Domain:: DNS-Domain (nicht Windows-Domäne, muss einen Punkt enthalten), z.{nbsp}B. `opsi.local` oder `meinefirma.local`

IP-Adresse:: Adresse dieses Servers, z.{nbsp}B. `192.168.1.50`

Netzmaske:: Netzmaske dieses Servers, z.{nbsp}B. `255.255.255.0`

Windows Workgroup/Domain:: Name der Windows-Domäne (nicht DNS-Domain), z.{nbsp}B. `OPSI`

Gateway:: IP-Adresse des Gateways, z.{nbsp}B. `192.168.1.1`

Proxy::	Adresse und Port des Proxy-Servers (falls erforderlich), z.{nbsp}B. `http://myuser:mypass@192.168.1.5:8080`

DNS:: IP-Adresse des Nameservers, z.{nbsp}B. `192.168.1.1`

Mail-Relay:: IP-Adresse des Mailservers, z.{nbsp}B. `192.168.1.1`

TFTP-Server:: Normalerweise ist das die IP-Adresse des opsi-Servers (Voreinstellung).

Passwort für root:: Das Passwort für den lokalen Administrator-Benutzer; das Kennwort geben Sie zweimal ein, um eventuelle Vertipper auszuschließen.

Passwort für adminuser:: Das Passwort für den lokalen opsi-Administrator; auch dieses Kennwort geben Sie zweimal ein.

Starten Sie die virtuelle Maschine anschließend neu.

[[opsi-getting-started-installation-base-vm-second-start]]
=== Zweiter Start: Login und Update

Nach dem Neustart melden Sie sich mit dem Benutzernamen `adminuser` und dem bei der Installation eingerichteten Kennwort an der grafischen Arbeitsumgebung an. Die virtuelle Maschine enthält drei schlanke Desktopumgebungen, die Sie über das Menü _Sitzung_ am oberen Rand auswählen.

Nach dem Einloggen startet der Browser Firefox und öffnet eine Seite mit weiterführenden Links zum Handbuch, zu unserem Forum (Community-Support), zum opsi-Wiki und zum professionellen uib-Support.

.Die grafische Arbeitsumgebung auf dem opsi-Server
image::opsiserver_start_gui.png["Die grafische Arbeitsumgebung auf dem opsi-Server", pdfwidth=80%]

NOTE: Wenn die Meldung erscheint, dass keine Netzwerkverbindung verfügbar ist, kann das mit der besonderen Konfiguration der virtuellen Appliance zusammenhängen. Bevor Sie nach Fehlern suchen, starten Sie den Server am besten einmal neu. Dazu klicken Sie entweder auf den Ausschaltknopf im Startmenü oder geben das Kommando `reboot` in ein Terminalfenster ein.

[[opsi-getting-started-installation-base-vm-update-server]]
=== opsi-Server aktualisieren

Bevor Sie den opsi-Server konfigurieren, bringen sie zunächst die Pakete des zugrundeliegenden Linux-Systems auf den aktuellen Stand. Die von uns bereitgestellte virtuelle Maschine basiert auf der letzten LTS-Version von Ubuntu und nutzt das Paketverwaltungstool APT.

Falls Sie bereits mit APT vertraut sind, können Sie den Server im Terminal mit den folgenden Kommandos aktualisieren; der letzte Befehl deinstalliert nicht mehr benötigte Pakete, die als Abhängigkeit installiert waren:

[source,prompt]
----
sudo apt update
sudo apt upgrade
sudo apt autoremove
----

Alternativ haben wir auf dem Desktophintergrund ein Symbol namens _Update OS_ hinterlegt, das nach einem Doppelklick genau diese Befehle in einem Terminal ausführt. Als Kennwort geben Sie das des Benutzers `adminuser` ein.

NOTE: Falls Sie einen Proxy-Server zum Zugriff auf das Internet verwenden, konfigurieren Sie diesen über die Umgebungsvariablen `http_proxy` und `https_proxy` (siehe Kapitel xref:server/requirements[Voraussetzungen]). Zusätzlich tragen Sie den Proxy in die Konfigurationsdatei `/etc/apt/apt.conf` ein. Sie bearbeiten diese Datei als Benutzer `root` in einem Texteditor Ihrer Wahl, z.{nbsp}B. über den Befehl `nano /etc/apt/apt.conf`.

Tragen Sie in die Konfigurationsdatei Folgendes ein:

[source,prompt]
----
Acquire::http::proxy "http://<proxy-address>:<port>/";
Acquire::https::proxy "https://<proxy-address>:<port>/";
----

Ist eine Authentifizierung erforderlich, lauten die beiden Einträge so:

[source,prompt]
----
Acquire::http::proxy "http://<user>:<password>@<proxy-address>:<port>/";
Acquire::https::proxy "https://<user>:<password>@<proxy-address>:<port>";
----

Nachdem das Upgrade abgeschlossen ist, starten Sie den Server neu.

[[opsi-getting-started-installation-base-vm-update-opsi-product]]
=== Standard-Produkte einspielen

Danach installieren Sie die opsi-Standard-Produkte. Auch dazu haben wir ein Symbol auf dem Desktop platziert. Doppelklicken Sie _First package installation_ und geben Sie auf Aufforderung das Passwort für den Benutzer `adminuser` ein.

Alternativ rufen Sie in einem Terminal den folgenden Befehl auf:

[source,prompt]
----
sudo opsi-package-updater -v install
----

Das Kommando aktualisiert alle vorhandenen opsi-Pakete inklusive der Templates für Betriebssystem-Installationen aus den opsi-Repositorys. Auf Aufforderung geben Sie das Passwort des Benutzers `adminuser` ein.

[[opsi-getting-started-installation-base-vm-start-configed]]
=== Management-Oberfläche starten

Die Management-Oberfläche `opsi-configed` starten Sie über einen Doppelklick auf das Desktopsymbol _Opsi Configuration Editor_. Weitere Informationen zu dieser grafischen Anwendung finden Sie in xref:manual:configed.adoc[Management-Oberfläche `opsi-configed`].


[[opsi-getting-started-installation-base-quickinstall]]
include::common:partial$quickinstall.adoc[]



// ab hier erstmal auskommentieren, wird freigeschaltet mit 4.3-Release
////

[[opsi-getting-started-installation-base-docker]]
== opsi als Docker-Container

Seit 2022 gibt es ein link:https://github.com/opsi-org/opsi-docker[Docker-Image], mit dem Sie einen Config-Server oder einen Depot-Server einrichten können. Es setzt auf das Orchestrierungswerkzeug Docker Compose, das es ermöglicht, mehrere Container zu definieren, diese miteinander zu verbinden und auf einem Docker-Host auszuführen. Sie benötigen mindestens Docker Compose 1.17.0 und die Docker-Engine 17.09.0 oder neuer.

NOTE: Beachten Sie, dass ausschließlich WebDAV als Protokoll zur Kommunikation mit dem opsi-Depot zum Einsatz kommt; eine Samba-Unterstützung gibt es in dieser Variante (noch) nicht. Außerdem benötigen Sie eine Lizenz für die MySQL-Erweiterung, denn das File Backend wird nicht unterstützt (siehe Kapitel xref:modules/modules[opsi-Erweiterungen]).

Installieren Sie Docker bzw. Docker Desktop unter Linux, Windows oder macOS. Dass die Installation erfolgreich war, können Sie schnell im Terminal überprüfen und den folgenden Befehl eingeben:

[source,prompt]
----
docker run --rm hello-world
----

Als Antwort sollten Sie diese Ausgabe sehen:

[source,prompt]
----
Hello from Docker!
This message shows that your installation appears to be working correctly.
[...]
----
 
[[opsi-getting-started-installation-base-docker-quick]]
=== Quick Start

Um den Docker-Container in Betrieb zu nehmen, sind lediglich drei Befehle nötig:

[source,prompt]
----
git clone https://github.com/opsi-org/opsi-docker.git
cd opsi-docker/opsi-server
./opsi-server.sh start
----

[[opsi-getting-started-installation-base-docker-compose]]
=== Docker Compose

Die Konfigurationsdatei `docker-compose.yml` definiert Netzwerke, Volumes und diese vier Dienste (Abschnitt `services`):

* `mysql`: installiert den Datenbankserver MariaDB
* `redis`: installiert die In-Memory-Datenbank Redis mit dem RedisTimeSeries-Modul
* `grafana`: spielt ein aktuelles Grafana ein
* `opsi-server`: installiert die Pakete `opsiconfd`, `opsipxeconfd`, `opsi-tftpd-hpa` und `opsi-utils` in der jeweils aktuellsten Version

Am Anfang der Datei sind einige X Properties (sog. Extension fields) definiert, z.{nbsp}B. `x-restart-policy`, `x-common-variables` usw. Diese YAML-Anker kommen zum Einsatz, um Einstellungen zwischen den Diensten auszutauschen.

NOTE: Aus Sicherheitsgründen sollten Sie alle Passwörter in der Datei `docker-compose.yml` ändern: `MYSQL_ROOT_PASSWORD`, `MYSQL_PASSWORD`, `REDIS_PASSWORD`, `GF_SECURITY_ADMIN_PASSWORD` und `OPSI_ADMIN_PASSWORD`. 

Ein Kennwort für den Benutzer `root` ist nicht gesetzt. Sie können dieses über `OPSI_ROOT_PASSWORD` festlegen:

[source,prompt]
----
OPSI_ROOT_PASSWORD: <passwort>
----

TIP: Wenn Sie TFTP-Netzwerk-Boot (und damit `opsipxeconfd` und `opsi-tftp-hpa`) nicht benötigen, können Sie die Variable `OPSI_TFTPBOOT` auf `"false"` setzen.

Die nächsten beiden Abschnitte erklären, wie Sie die Konfigurationsdatei `docker-compose.yml` anpassen, um einen Config-Server oder einen Depot-Server aufzusetzen.

[[opsi-getting-started-installation-base-docker-compose-config]]
==== Config-Server

Nachdem Sie die Einstellungen für den Hostnamen und die Domain im Bereich `opsi-server` an Ihr Netzwerk angepasst haben, setzen Sie die Variable `OPSI_HOST_ROLE` auf `configserver`:

[source,prompt]
----
OPSI_HOST_ROLE: configserver
----

Unter Linux und macOS starten Sie alle Dienste über `./opsi-server.sh start`, unter Windows mit dem Befehl `.\opsi-server.ps1 start` (siehe Abschnitt <<opsi-getting-started-installation-base-docker-scripts>>). Den Status des Containers überprüfen Sie mit dem Befehl `./opsi-server.sh status` (Linux, macOS) bzw. `.\opsi-server.ps1 status`, und die Logfiles betrachten Sie mit `./opsi-server.sh logs` bzw. `.\opsi-server.ps1 logs`.

.Überprüfen Sie den Status und die Logfiles mit dem Skript `opsi-server.sh`.
image::opsi-server-script.png["Überprüfen Sie den Status und die Logfiles mit dem Skript `opsi-server.sh`.", pdfwidth=80%]

[[opsi-getting-started-installation-base-docker-compose-depot]]
==== Depot-Server

Kontrollieren Sie die Einstellungen für Netzwerk und Volumes. Die beiden Dienste `mysql` und `grafana` benötigen Sie für einen Depot-Server nicht, daher können Sie diese auskommentieren oder löschen. Achten Sie darauf, `mysql` dann auch im Abschnitt `opsi-server` aus dem `depends_on`-Attribut zu entfernen.

Setzen Sie die Variable `OPSI_HOST_ROLE` auf `depotserver`:

[source,prompt]
----
OPSI_HOST_ROLE: depotserver
----

Für einen Depot-Server setzen Sie außerdem die beiden Variablen `OPSI_SERVICE_ADDRESS` (IP-Adresse des opsi-Config-Servers) und `OPSI_HOST_KEY` (Host-Key des Depots). Danach starten Sie alle Dienste über `./opsi-server.sh start` (Linux, macOS) bzw. `.\opsi-server.ps1 start` (Windows).

[[opsi-getting-started-installation-base-docker-scripts]]
=== Die Helfer-Skripte

Wir haben zwei Helfer-Skripte beigelegt, die den Umgang mit dem opsi-Docker-Container erleichtern. Wenn Sie Linux oder macOS verwenden, verwenden Sie das Skript `opsi-server.sh`. Machen Sie dieses zunächst ausführbar:

[source,prompt]
----
chmod +x opsi-server.sh
----

Danach rufen Sie es als normaler Benutzer ohne weitere Parameter oder Optionen auf, um eine Onlinehilfe einzublenden:

[source,prompt]
----
./opsi-server.sh 
Usage: ./opsi-server.sh <command>

Commands:
  edit                      Edit docker-compose.yml.
  start                     Start all containers.
  status                    Show running containers.
  stop                      Stop all containers.
  logs [service]            Attach to container logs (all logs or supplied service).
  shell [service]           Exexute a shell in a running container (default service: opsi-server).
  update                    Update and restart all containers.
  open-volumes              Open volumes directory in explorer.
  inspect [service]         Show detailed container informations (default service: opsi-server).
  diff [service]            Show container's filesystem changes (default service: opsi-server).
  prune                     Delete all containers and unassociated volumes.
  export-images             Export images as archive.
  import-images [archive]   Import images from archive.
  build [--no-cache]        Build opsi-server image. Use --no-cache to build without cache.
  publish                   Publish opsi-server image.
----

Das zweite Skript `opsi-server.ps1` ist für Windows-Anwender und den Einsatz auf der Windows PowerShell gedacht. Es hat im Wesentlichen die gleichen Optionen und Parameter -- lediglich die letzten beiden Kommandos (`build` und `publish`) sind nicht verfügbar.
////

[[opsi-getting-started-installation-base-packages]]
== Paketbasierte Installation

Alternativ zur virtuellen Appliance
//und zum Docker-Container
können Sie den opsi-Server auch über die jeweilige Paketverwaltung Ihrer Linux-Distribution installieren. Die Abläufe auf den verschiedenen Systemen sind weitgehend gleich:

* fehlende Software installieren
* unsere Paketquelle (Repository) hinzufügen
* Liste der installierbaren Pakete aktualisieren
* eines der opsi-Server-Pakete installieren: `opsi-server-full`, `opsi-server` oder `opsi-server-expert` (siehe Abschnitt <<opsi-getting-started-installation-base-prerequires>>)

[[opsi-getting-started-installation-base-prerequires]]
=== Vorbereitungen

Ab Version 4.2 benötigt der opsi-Server Zugriff auf eine Redis- und eine Grafana-Instanz. Wir gehen im Folgenden davon aus, dass diese beiden Dienste auch auf dem opsi-Server laufen. In dem Fall können Sie das Paket `opsi-server-full` installieren, das alle notwendigen Anwendungen einspielt und konfiguriert. Wir bezeichnen das in den einzelnen Abschnitten als Single-Server-Setup. Wenn Sie hingegen Dienste wie Redis, MySQL/MariaDB oder Grafana auf einem anderen Server betreiben, spielen Sie stattdessen `opsi-server` oder `opsi-server-expert` ein.

TIP: Nutzen Sie zur Installation von Grafana die offiziellen Grafana-Repositorys. Wenn Sie eine Debian-basierte Distribution einsetzen, beachten Sie, dass die Repositorys im November 2022 von `<packages.grafana.com/deb/{product}>` nach `<apt.grafana.com>` umgezogen sind. Die alten Adressen funktionieren noch, aber es kann bei der Installation oder Aktualisierung zu Warnungen auf dem System kommen.

==== Debian/Ubuntu/UCS

[source,bash]
----
sudo mkdir -p /usr/local/share/keyrings
REPO_URL=https://apt.grafana.com
REPO_KEY=/usr/local/share/keyrings/grafana.gpg
sudo apt-get install -y apt-transport-https software-properties-common curl gpg
curl -fsSL ${REPO_URL}/gpg.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL} stable main" > /etc/apt/sources.list.d/grafana.list
----

==== SLES/openSUSE

[source,bash]
----
zypper install wget
cd /etc/zypp/repos.d
cat <<EOF > grafana.repo
[grafana]
name=grafana
baseurl=https://rpm.grafana.com
repo_gpgcheck=1
enabled=1
gpgcheck=1
gpgkey=https://rpm.grafana.com/gpg.key
sslverify=1
sslcacert=/etc/pki/tls/certs/ca-bundle.crt
EOF
----

==== RHEL/Alma Linux/Rocky Linux

[source,bash]
----
yum install wget
cd /etc/yum.repos.d
cat <<EOF > grafana.repo
[grafana]
name=grafana
baseurl=https://rpm.grafana.com/
repo_gpgcheck=1
enabled=1
gpgcheck=1
gpgkey=https://rpm.grafana.com/gpg.key
sslverify=1
sslcacert=/etc/pki/tls/certs/ca-bundle.crt
EOF
----

==== MySQL statt MariaDB

Wenn Sie MySQL anstelle von MariaDB verwenden möchten, dann müssen Sie bei `opsi-setup --configure-mysql` einen Benutzernamen und ein `mysql_native_password` angeben. So gehen Sie vor, um `mysql_native_password` für den Benutzer `root` zu aktivieren:

. Tragen Sie in der MySQL-Konfiguration `skip-grant-tables` im Abschnitt `[mysqld]` ein.
. Starten Sie den MySQL-Service neu.
. Loggen Sie sich als `root` mit `mysql -u root -p` ein.
. Führen Sie das Kommando `flush privileges;` aus.
. Führen Sie das Kommando `ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'NewPassword';` aus.
. Entfernen Sie den Eintrag `skip-grant-tables` aus der Konfiguration und starten den MySQL-Dienst neu.

[[opsi-getting-started-installation-base-deb]]
=== Installation unter Debian/Ubuntu

Wir empfehlen zunächst, folgende Pakete zu installieren:

[source,bash]
----
apt install host pigz apt-transport-https software-properties-common curl gpg
----

Falls noch nicht geschehen, legen Sie das Verzeichnis `/usr/local/share/keyrings` an:

[source,bash]
----
mkdir -p /usr/local/share/keyrings
----

Weiterhin muss Samba installiert sein:

[source,bash]
----
apt install samba samba-common smbclient cifs-utils
----

Fügen Sie nun das opsi-Repository zu den APT-Paketquellen hinzu:

*Debian 11 _Bullseye_:*
[source,bash]
[subs="attributes"]
----
REPO_URL=https://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/{release}/Debian_11
REPO_KEY=/usr/local/share/keyrings/opsi.gpg
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL}/ /" > /etc/apt/sources.list.d/opsi.list
curl -fsSL ${REPO_URL}/Release.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
----

*Debian 10 _Buster_:*
[source,bash]
[subs="attributes"]
----
REPO_URL=https://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/{release}/Debian_10
REPO_KEY=/usr/local/share/keyrings/opsi.gpg
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL}/ /" > /etc/apt/sources.list.d/opsi.list
curl -fsSL ${REPO_URL}/Release.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
----

*Ubuntu 22.04 LTS _Jammy Jellyfish_:*
[source,bash]
[subs="attributes"]
----
REPO_URL=https://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/{release}/xUbuntu_22.04
REPO_KEY=/usr/local/share/keyrings/opsi.gpg
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL}/ /" > /etc/apt/sources.list.d/opsi.list
curl -fsSL ${REPO_URL}/Release.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
----

*Ubuntu 20.04 LTS _Focal Fossa_:*
[source,bash]
[subs="attributes"]
----
REPO_URL=https://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/{release}/xUbuntu_20.04
REPO_KEY=/usr/local/share/keyrings/opsi.gpg
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL}/ /" > /etc/apt/sources.list.d/opsi.list
curl -fsSL ${REPO_URL}/Release.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
----

*Ubuntu 18.04 LTS _Bionic Beaver_:*
[source,bash]
[subs="attributes"]
----
REPO_URL=https://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/{release}/xUbuntu_18.04
REPO_KEY=/usr/local/share/keyrings/opsi.gpg
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL}/ /" > /etc/apt/sources.list.d/opsi.list
curl -fsSL ${REPO_URL}/Release.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
----

Prüfen Sie, ob der Import des GnuPG-Schlüssels erfolgreich war:

[source,bash]
----
gpg /usr/local/share/keyrings/opsi.gpg 2>/dev/null
----

In der Ausgabe sollten unter anderem folgende Zeilen auftauchen:

[source,bash]
----
pub   rsa2048 2017-09-30 [SC] [expires: 2023-11-09]
      2E98F7B5A5B2C8FE7F609705D1F933E6D8361F81
uid           home:uibmz:opsi OBS Project <home:uibmz:opsi@build.opensuse.org>
----

Installieren Sie jetzt eines der opsi-Server-Pakete:

*Single-Server-Setup:*
[source,prompt]
----
apt update
apt install opsi-server-full
----

*Manuelles Setup:*
[source,prompt]
----
apt update
apt install redis-server redis-timeseries grafana mariadb-server
systemctl daemon-reload
systemctl enable grafana-server
systemctl start grafana-server
apt install opsi-server
apt install opsi-windows-support
----

TIP: Falls bei der Installation eine Frage nach dem TFTP-Basisverzeichnis auftaucht, geben Sie `/tftpboot` ein.

[[opsi-getting-started-installation-base-opensuse-sles]]
=== Installation unter SLES/openSUSE

Notwendige Vorbereitungen:

* Samba muss installiert und konfiguriert sein.

* Das Paket `mariadb-server` muss installiert sein.

* Soll die Maschine auch als DHCP-Server eingesetzt werden, muss der Daemon `dhcpd` konfiguriert sein und laufen.

So fügen Sie das opsi-Repository per `zypper` hinzu:

*openSUSE Leap 15.1:*
[source,prompt]
[subs="attributes"]
----
zypper addrepo https://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/openSUSE_Leap_15.1/home:uibmz:opsi:4.2:{release}.repo
----

*openSUSE Leap 15.2:*
[source,prompt]
[subs="attributes"]
----
zypper addrepo https://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/openSUSE_Leap_15.2/home:uibmz:opsi:4.2:{release}.repo
----

*openSUSE Leap 15.3:*
[source,prompt]
[subs="attributes"]
----
zypper addrepo https://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/openSUSE_Leap_15.3/home:uibmz:opsi:4.2:{release}.repo
----

*SLES 15SP1:*
[source,prompt]
[subs="attributes"]
----
zypper addrepo http://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/SLE_15_SP1/home:uibmz:opsi:4.2:{release}.repo
----

*SLES 15SP2:*
[source,prompt]
[subs="attributes"]
----
zypper addrepo http://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/SLE_15_SP2/home:uibmz:opsi:4.2:{release}.repo
----

*SLES 15SP3:*
[source,prompt]
[subs="attributes"]
----
zypper addrepo http://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/SLE_15_SP3/home:uibmz:opsi:4.2:{release}.repo
----

Nach dem Hinzufügen der Repositorys können Sie die Installation starten:

*Single-Server-Setup:*
[source,prompt]
----
zypper refresh
  Wollen Sie den Schlüssel (a)bweisen, ihm (t)emporär oder (i)mmer vertrauen? [a/t/i/?] (a): i
zypper -v install opsi-server-full
----

*Manuelles Setup:*
[source,prompt]
----
zypper refresh
zypper install redis-server redis-timeseries grafana
systemctl daemon-reload
systemctl enable grafana-server
systemctl start grafana-server
zypper -v install opsi-server
zypper -v install opsi-windows-support
----

NOTE: Stellen Sie sicher, dass Ihre Firewall-Konfiguration Verbindungen zu den Ports 69/UDP (TFTP) sowie 4447/TCP und 4441/TCP (opsi) zulässt.

Falls Sie die Netzwerkkonfiguration mit Hilfe von YaST oder AutoYaST vorgenommen haben, kann es sein, dass die Datei `/etc/hosts` einen Eintrag der folgenden Form enthält:

[source,configfile]
----
127.0.0.2 <fqdn> <hostname>
----

Falls Sie opsi die Konfiguration des DHCP-Servers überlassen wollen, tragen Sie stattdessen die öffentliche IP-Adresse ein,
 über die der Server erreichbar ist.

[[opsi-getting-started-installation-base-centos-rhel]]
=== Installation unter RHEL/Alma Linux/Rocky Linux

Die Installation unter Red Hat Enterprise Linux (RHEL), Alma Linux und Rocky Linux läuft weitgehend gleich ab. Unterschiede gibt es lediglich beim verwendeten Repository.

NOTE: Wenn Sie Red Hat Enterprise Linux einsetzen, müssen Sie sich beim Red Hat Network registrieren, um Zugriff auf alle benötigten Pakete zu haben: +
[source,prompt]
----
subscription-manager register
subscription-manager attach --auto
----

Notwendige Vorbereitungen:

* Samba und Datenbankserver installieren:
+
[source,prompt]
----
yum install mariadb-server samba samba-client
----

* Samba und Datenbankserver konfigurieren:
+
[source,prompt]
----
systemctl start smb.service
systemctl start nmb.service
systemctl start mariadb.service
systemctl enable smb.service
systemctl enable nmb.service
systemctl enable mariadb.service
mysql_secure_installation
----

* Soll die Maschine auch als DHCP-Server eingesetzt werden, muss der Daemon `dhcpd` konfiguriert sein und laufen.

So fügen Sie das opsi-Repository hinzu:

*RHEL 8:*
[source,prompt]
[subs="attributes"]
----
cd /etc/yum.repos.d/
wget https://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/RHEL_8/home:uibmz:opsi:4.2:{release}.repo
yum makecache
----

*Alma Linux 8:*
[source,prompt]
[subs="attributes"]
----
cd /etc/yum.repos.d/
wget https://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/AlmaLinux_8/home:uibmz:opsi:4.2:{release}.repo
yum makecache
----

*Rocky Linux 8:*
[source,prompt]
[subs="attributes"]
----
cd /etc/yum.repos.d/
wget https://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/RockyLinux_8/home:uibmz:opsi:4.2:{release}.repo
yum makecache
----

Nach dem Hinzufügen der Repositorys können Sie die Installation starten:

*Single-Server-Setup:*
[source,prompt]
----
yum install opsi-server-full
----

*Manuelles Setup:*
[source,prompt]
----
yum makecache
yum install redis-server redis-timeseries grafana.x86_64
systemctl daemon-reload
systemctl enable grafana-server
systemctl start grafana-server
yum install opsi-server
yum install opsi-windows-support
----

Es kann vorkommen, dass Sie beim Importieren des GnuPG-Schlüssel des Repositorys eine solche Meldung sehen:

[source,prompt]
----
   Importing GPG key 0xD8361F81 "home:uibmz OBS Project <home:uibmz@build.opensuse.org>" from http://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/stable/CentOS_8/repodata/repomd.xml.key
   Is this ok [y/N]: y
----

Geben Sie `y` ein und drücken [Eingabe], um das Hinzufügen des Schlüssels zu bestätigen.

NOTE: Stellen Sie sicher, dass Ihre Firewall und die SELinux-Konfiguration -Konfiguration Verbindungen zu den Ports 69/UDP (TFTP) sowie 4447/TCP und 4441/TCP (opsi) zulässt.


[[opsi-getting-started-installation-base-ucs]]
== Installation unter Univention Corporate Server (UCS)

Unter Univention Corporate Server (UCS) gibt es zwei Möglichkeiten, den opsi-Server zu installieren:

* <<opsi-getting-started-installation-base-ucs-appcenter>> (nur UCS 5.0 oder neuer)
* <<opsi-getting-started-installation-base-ucs-manually>> über die uib-Repositorys (UCS 4.4 und 5.0)

Beide Varianten führen zu einem funktionierenden opsi-Server, sollten aber nicht zusammen auf einem Server laufen. Entscheiden Sie im Vorfeld, welche Installation zu Ihrer Umgebung passt. Wenn Sie opsi über das Univention App Center beziehen, dann kann es sein, dass Sie länger auf Aktualisierungen warten müssen. Der Wechsel auf eine neue UCS-Version (etwa von 4.4 auf 5.0) ist erst dann möglich, wenn alle installierten Apps unter der neuen UCS-Version zur Verfügung stehen. Entscheiden Sie sich für die Installation über die uib-Repositorys, erhalten Sie zeitnah Updates.

NOTE: Bei der Veröffentlichung von opsi 4.2 haben wir den UCS-Support den anderen Distributionen angepasst. Die Funktion von `opsi4ucs` übernimmt ab 4.2 das Paket für den opsi-Server und dessen Varianten. Das Paket `opsi4ucs` ist in opsi 4.2 weiterhin als Übergangspaket enthalten, um die Migration von opsi 4.1 zu vereinfachen. Während des Upgrades von opsi 4.1 auf 4.2 ersetzt das Paketverwaltungstool `opsi4ucs` automatisch durch `opsi-server`.

[[opsi-getting-started-installation-base-ucs-appcenter]]
==== Installation über das Univention App Center

Im link:https://www.univention.de/produkte/univention-app-center/app-katalog/opsi/[Univention App Center Katalog] finden Sie opsi für die UCS-Version 5.0. Bei der Installation spielt der Paketmanager automatisch weitere Pakete ein: `opsi-tftpd-hpa`, `opsi-windows-support` und `univention-mariadb`.

NOTE: Der erste opsi-Server einer UCS-Umgebung konfiguriert einen vorhandenen MariaDB-Server als Backend. Alle weiteren opsi-Server registriert opsi als Depots. Gibt es also bei der Installation bereits einen opsi-Server in der UCS-Umgebung, so wird das Tool `opsi-package-updater` so konfiguriert, dass es die Pakete von diesem Server bezieht.

[[opsi-getting-started-installation-base-ucs-manually]]
==== Manuelle Installation 

Bevor Sie den opsi-Server unter Univention Corporate Server von Hand installieren, treffen Sie ein paar Vorbereitungen:

* Samba muss installiert und konfiguriert sein. Ist der UCS-Server Mitglied einer AD-Domäne, installieren Sie `univention-samba`, das Samba als Mitgliedsserver ohne Domänen-Controller-Funktionalität einrichtet und konfiguriert. Das Paket `univention-samba4` hingegen richtet Samba als AD-Domänen-Controller ein.

* Ein MariaDB-Server muss installiert und konfiguriert sein. Installieren Sie dazu `univention-mariadb`; das Paket `univention-mysql` ist seit UCS 4.3 ein Metapaket, das den MariaDB-Server installiert.

* Soll der UCS-Rechner auch als DHCP-Server dienen, konfigurieren Sie vor der opsi-Installation den DHCP-Daemon und starten ihn.

Grundsätzlich ist die Installation auf Servern mit den UCS-Rollen Primary Directory Node, Backup Directory Node, Replica Directory Node und Managed Node möglich.

CAUTION: Wenn Sie den opsi-Server nicht auf einem Primary Directory Node, sondern auf einem Rechner mit einer anderen UCS-Systemrolle installieren, muss der UCS-Server vorher der Domäne beitreten.

Die Konfigurationsdatei `/etc/opsi/opsi.conf` definiert die Gruppe für den Samba-Zugriff auf die Freigaben; der Name ist `opsifileadmins`. Alle Anwender, die Zugriffsrechte für die Freigaben von opsi erhalten sollen (opsi-Paketierer), müssen dementsprechend Mitglied der Gruppe `opsifileadmins` sein.

So fügen Sie das opsi-Repository hinzu:

*Univention UCS 4.4:*
[source,bash]
[subs="attributes"]
----
REPO_URL=https://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/{release}/Univention_4.4
REPO_KEY=/usr/local/share/keyrings/opsi.gpg
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL}/ /" > /etc/apt/sources.list.d/opsi.list
curl -fsSL ${REPO_URL}/Release.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
----

*Univention UCS 5.0:*
[source,bash]
[subs="attributes"]
----
REPO_URL=https://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/{release}/Univention_5.0
REPO_KEY=/usr/local/share/keyrings/opsi.gpg
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL}/ /" > /etc/apt/sources.list.d/opsi.list
curl -fsSL ${REPO_URL}/Release.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
----

Nach dem Hinzufügen der Repositorys können Sie die Installation starten:

*Single-Server-Setup:*
[source,bash]
----
univention-install opsi-server-full
----

*Manuelles Setup:*
[source,bash]
----
univention-install redis-server redis-timeseries grafana
systemctl daemon-reload
systemctl enable grafana-server
systemctl start grafana-server
univention-install opsi-server
----

Wenn der opsi-Server auf einer anderen UCS-Systemrolle als Primary Directory Node laufen soll, führen Sie zusätzlich den Befehl `univention-run-join-scripts` aus.

Benutzer müssen Mitglied der Gruppe `opsi-admin-group` sein, um den `opsi-configed` verwenden zu können. Während der Installation, wird der Benutzer `Administrator` automatisch zu dieser Gruppe hinzugefügt. Andere Accounts fügen Sie über das UMC-Modul _Benutzerverwaltung_ , Reiter _Gruppen_ hinzu.

Um sicherzustellen, dass alle opsi-Einstellungen korrekt übernommen wurden, führen Sie abschließend die folgenden Befehle aus:

[source,bash]
----
opsi-setup --init-current-config
opsi-set-rights
systemctl restart opsiconfd.service
systemctl restart opsipxeconfd.service
----

== Hilfe und Support

Bei Problemen können Sie mit anderen aus der Community in unserem link:https://forum.opsi.org[Forum] diskutieren.

TIP: Wenn Sie einen Support-Vertrag haben, können Sie sich auch direkt an den link:https://www.uib.de/de/support-schulung/support[uib-Support] mit Ihren Fragen wenden.
