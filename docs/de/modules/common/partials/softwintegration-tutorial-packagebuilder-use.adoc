////
; Copyright (c) uib GmbH (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: http://www.opsi.org/credits/
////

:Author:    uib GmbH
:Email:     info@uib.de
:Date:      03.10.2023
:Revision:  4.3
:toclevels: 6
:doctype:   book
:icons:     font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]

[[opsi-softwintegration-tutorial-modify-with-opsi-packagebuilder]]
== opsi PackageBuilder: Skript modifizieren

Starten Sie den opsi PackageBuilder (oPB) aus dem Startmenü. Sollte das nicht funktionieren (beobachtet Unter Linux mit KDE-Desktopumgebung), starten Sie das Programm aus einem Terminal heraus. Geben Sie einen beliebigen Pfad an und bestätigen die Fehlermeldung, dass der Pfad nicht gefunden wurde:

[source,console]
----
opsipackagebuilder --path /home
----

Beim ersten Start befindet sich der opsi PackageBuilder im Offlinemodus, da die Verbindung zum opsi-Server noch fehlt:

.opsi PackageBuilder: Erster Start im Offlinemodus
image::opb_firststart.png["opsi PackageBuilder: Erster Start im Offlinemodus", pdfwidth=80%]

[[opsi-softwintegration-tutorial-modify-with-opsi-packagebuilder_config]]
=== Initiale Konfiguration

Klicken Sie auf die Schaltfläche _Einstellungen_, um das Programm zu konfigurieren.

.oPB-Einstellungen: Reiter *Allgemein*
image::opb_conf_general.jpeg["oPB-Einstellungen: Reiter *Allgemein*", pdfwidth=80%]

Auf dem Reiter _Allgemein_ nehmen Sie die folgenden Einstellungen vor:

* _Konfigserver_: Tragen Sie den vollständigen Namen (FQDN) Ihres opsi-Configservers ein (z.{nbsp}B. \`opsi.mycompany.org`).

* _opsiadmin Benutzer_: username eines Mitglieds der Gruppe `opsiadmin` (Am besten Ihr username)

* _opsiadmin Passwort_: das Passwort des oben angegeben Benutzers. Dieses wird nicht angezeigt und verschlüsselt gespeichert. Es ist notwendig damit der opsi PackageBuilder mit dem opsi-server kommunizieren kann.

* _opsi Server Version_: opsi 4.1 oder höher

* _opsi Workbench_ : `/var/lib/opsi/workbench`

* _Kompatibilität der Befehlsausführung_ : opsi 4.0.4 oder neuer / Sudo ohne Passwort

* _Benutzer_ : Ihr voller Name (wird in changelogs verwendet)

* _EMail_ : Ihre eMail Adresse (wird in changelogs verwendet)


.opsi PackageBuilder Einstellungen: Programm
image::opb_conf_program.jpeg["Einstellungen: Programm", pdfwidth=70%]

Im Reiter _Programm_ machen Sie bitte folgende Einstellungen:

* _Bestehendes Netzlaufwerk verwenden_ : Häkchen setzen

* _Entwicklungsordner_ : Pfad zum Verzeichnis in dem die opsi-Pakete erstellt werden sollen. Dies ist idealerweise der Pfad zu der Stelle an der die opsi_workbench Ihres opsi-servers gemountet ist.

* _Skripteditor_ : +
Den Skripteditor des opsi PackageBuilder gibt es leider nur für Windows.

** Unter Windows belassen Sie es bei den Voreinstellungen

** Unter Linux: Externer Editor: `/usr/local/bin/jedit` +
Kommandozeilenoptionen: (leer)

** Unter MacOS: Externer Editor: `/Application/jedit` +
Kommandozeilenoptionen: (leer)


.opsi PackageBuilder Einstellungen: Verwaltung
image::opb_conf_opsi.png["Einstellungen: Verwaltung", pdfwidth=70%]

Im Reiter _Verwaltung_ empfehlen wir folgende Einstellung abweichend vom Default

* _Paketieren_ : `opsi-makepackage -v`


Speichern Sie die Einstellungen und starten Sie den opsi PackageBuilder neu.
Der opsi PackageBuilder sollte nun nicht mehr _Offline Modus_ melden.

[[opsi-softwintegration-tutorial-modify-with-opsi-packagebuilder_use]]
=== Pakete modifizieren, packen und Installieren

.opsi PackageBuilder Start
image::opb_start.jpg[Start, pdfwidth=70%]

Verwenden Sie _Paket öffnen (F2)_ und wählen Sie das Verzeichnis in dem das Sie mit dem _opsi-setup-detector_ erstellt haben. (z.B.: w:\newprod2 ) +
Dann öffnet sich das Produktfenster mit verschiedenen Reitern. Der default Reiter ist _Paket_.

.opsi PackageBuilder Reiter Packet
image::opb_tab_product.jpg[Reiter Packet, pdfwidth=60%]

In desem Reiter sehen auf der Linken Seite die allgemeinen Metadaten des opsi-Produktes wie Sie auch schon in <<opsi-setup-detector-product-configuration1>> erläutert wurden.

Auf der rechten Seite sehen Sie die Scriptdateien und daneben den Button:

.opsi PackageBuilder Button Edit
image::opb_btnSkriptEdit.png["Button Edit",width=20]

Mit dem Button können Sie die Datei in dem in der Konfiguration angegebenen Scripteditor aufrufen und das Script modifizieren. Unter Windows ist das der Scripteditor des opsi PackageBuilder.

.opsi PackageBuilder Scripteditor unter Windows
image::opb_ScEdit.jpg["Scripteditor", pdfwidth=60%]

Wesentliche Merkmale:

* Farbige Syntaxhervorhebung

* “Falten” des Quellcodes (optional: kompakt, mit Kommentaren)

* Lexerdefinition anpassbar (dazu muss der Editor per Startmenü Eintrag aufgerufen werden)

* Autocomplete für Syntaxelemente und Variablen

* Frei definierbare und wiederverwendbare Codeblöcke (“Snippets”)

Die Kernkomponente des Editors bildet das Modul Scintilla, welches auch in andere bekannten Editoren, wie bspw. Notepad++, verwendet wird. Die lexikalischen Elemente (Syntaxhervorhebung und Faltung) zur Darstellung der für opsi gültigen Scriptsprache sind allerdings komplett in AutoIt geschrieben, da Scintilla für opsi Skripte kein eigenes Darstellungsmodul mitliefert. Dadurch, dass AutoIt eine Interpretersprache ist, ist er damit langsamer als andere Editoren und eignet sich daher nur bedingt zur Bearbeitung sehr großer Skripte, vor allem bei eingeschalteter Quellcode Faltung. In den Einstellungen lässt sich jedoch vorgeben, ob der Editor mit diesen Funktionen überhaupt aufgerufen wird oder nicht, sofern der Aufruf direkt über den Skriptbaum erfolgt. Bei einem Aufruf über den Link im Startmenü sind Syntaxhervorhebung und Faltung generell beim Start ausgeschaltet und können über das Editormenü “Ansicht” aktiviert werden.

(Der Editor kann auch über die Kommandozeile aufgerufen werden. Weitere Informationen zu den möglichen Kommandozeilenparametern können mit der Option “–help” aufgerufen werden.)

.opsi PackageBuilder Reiter Produktvariablen (Properties)
image::opb_tab_property.jpg[Reiter Produktvariablen (Properties), pdfwidth=60%]

In desem Reiter sehen auf der Linken Seite die Produkt Properties des opsi-Produktes wie Sie auch schon in
<<opsi-setup-detector-product-configuration-properties>> erläutert wurden.

.opsi PackageBuilder Reiter Abhängigkeiten
image::opb_tab_dependencies.jpg[Reiter Abhängigkeiten, pdfwidth=50%]

In desem Reiter sehen auf der Linken Seite die Produkt Abhängigkeiten des opsi-Produktes wie Sie auch schon in
<<opsi-setup-detector-product-configuration-priority_dependecy>> erläutert wurden.


.opsi PackageBuilder Button: Packen
image::opb_btnPacken.png[Button: Packen, pdfwidth=15%]

Dieser Button startet eine SSH-Verbindung vom Server und ruft dort den Paketierungsbefehl auf. +
Sie können das selbe auch in einem Terminal selber machen wie in
<<opsi-softwintegration-create-opsi-package-makeproductfile,Packen mit opsi-makepackage>> beschrieben.

.opsi PackageBuilder Button: Installieren
image::opb_btnInstallieren.png[Button: Installieren, pdfwidth=15%]

Dieser Button startet eine SSH-Verbindung vom Server und ruft dort den Installationsbefehl auf um das Produkt auf dem Server zu installieren. +
Sie können das selbe auch in einem Terminal selber machen wie in
<<opsi-softwintegration-create-opsi-package-manager, Installieren mit opsi-package-manager>> beschrieben.

.opsi PackageBuilder Button: Installieren + Setup
image::opb_InstSetup.jpg[Button: Installieren + Setup, pdfwidth=15%]

Ähnlich wie der Button _Installieren_, allerdings wird das Paket zusätzlich auf allen Clients, auf denen es als _installed_ gekennzeichnet ist, auf _setup_ gesetzt. 

WARNING: Finger weg!

