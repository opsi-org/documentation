////
; Copyright (c) uib GmbH (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: http://www.opsi.org/credits/
////


:Author:    uib GmbH
:Email:     info@uib.de
:Date:      17.07.2023
:Revision:  4.3
:toclevels: 6
:doctype:   book
:icons:     font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]

[[opsi-manual-clientagent-overview]]
== Überblick

Den Client-Agent installieren Sie auf allen Rechnern, die Sie mit opsi verwalten möchten. Beim Start des Rechners (noch vor Benutzeranmeldung) kontaktiert der Client-Agent den opsi-Configserver. Anhand der dort gespeicherten Informationen prüft der Client-Agent, ob es Updates oder neue Pakete für den Client gibt. 

Um die Installation kümmert sich das Programm xref:opsi-script-manual:opsi-script-manual.adoc[opsi-script], die notwendigen Skripte und Softwarepakete stehen im opsi-Depot (einer Dateifreigabe) bereit. Während die Installation läuft, gibt es keine Möglichkeit und auch keine Notwendigkeit, in den Prozess einzugreifen.

Um zu verhindern, dass sich Benutzer vor Abschluss der Installation auf dem System anmelden können, wird zusätzlich der sogenannte Loginblocker installiert. Er sorgt dafür, dass ein Login erst nach beendeter Installation möglich ist.

NOTE: Um Softwarepakete mit dem Programm `opsi-script` ohne Interaktion installieren zu können, müssen diese bestimmten Regeln und Konventionen folgen (siehe Abschnitt xref:clients:windows-client/softwareintegration.adoc#opsi-winclient-softwintegration-tutorial[Tutorial: *opsi-script*-Skript erstellen]).

[[opsi-manual-clientagent-installation]]
== Installation

Wenn Sie ein xref:clients:windows-client/os-installation.adoc[Betriebssystem] (neu) über opsi installieren, wird der Client-Agent automatisch installiert. 
Alternativ können Sie den <<opsi-manual-clientagent-subsequent-installation>>.

TIP: Um den opsi-Client-Agent auf einem Client zu deinstallieren, setzen Sie das Produkt in der Management-Oberfläche auf _uninstall_.

[[opsi-manual-clientagent-subsequent-installation]]
=== Client-Agent nachträglich installieren

// cspell: ignore installer, help
Zur nachträglichen Installation oder zu Reparaturzwecken des Client-Agent stehen verschiedene Methoden zur Verfügung:

* als MSI-Paket (nur Windows, siehe Abschnitt xref:clients:windows-client/windows-client-agent.adoc#opsi-manual-client-agent-msi[Client-Agent via MSI installieren])
* automatisch im Rahmen einer Betriebssystem-Installation
* manuell aus einem (Depot-)Verzeichnis durch den `oca-installation-helper[.exe]` (siehe Abschnitt <<opsi-manual-clientagent-subsequent-installation-oca-installation-helper>>)
* per Push vom Server aus (`opsi-deploy-client-agent`)
* über den Installer (`opsi-client-agent-installer.exe`, `opsi-linux-client-agent-installer.run`, `opsi-mac-client-agent-installer.command`)
* im opsi-Service-Kontext (Client-Agent aktualisiert sich selbst)

TIP: Den Installer können Sie (ohne Authentifizierung) von einem opsi-Server in Ihrer Umgebung über die Adresse `\https://<opsi-server>:4447/public/opsi-client-agent/` herunterladen. Hier finden Sie Pakete für Windows, Linux und macOS.

In den meisten Fällen (außer beim Upgrade im opsi-Service-Kontext) kommt der `oca-installation-helper[.exe]` zum Einsatz. Diese Anwendung erfüllt im Wesentlichen die folgenden Zwecke:

* Sie kopiert die Installationsdateien (falls notwendig) in ein lokales temporäres Verzeichnis (z.{nbsp}B. Aufruf per UNC-Pfad).
* Sie zeigt ein Dialogfenster an, in dem Sie weitere Angaben zur Installation machen können (z.{nbsp}B. Client-ID, opsi-Service-URL, Benutzername und Passwort).
* Sie erzeugt den Client im opsi-Service, falls er noch nicht existiert.
* Sie startet `opsi-script` und führt die eigentliche Installation durch.

NOTE: Der Installer baut in jedem Fall eine Service-Verbindung auf, sodass (unabhängig vom Installationsmodus) immer die Product-Propertys vom Server verwendet werden.

[[opsi-manual-clientagent-subsequent-installation-oca-installation-helper]]
==== *oca-installation-helper*-Parameter

Das Programm `oca-installation-helper[.exe]` erfordert Root-Rechte; es kennt einige Parameter und Optionen, die Sie mit `--help` anzeigen.

.Die Onlinehilfe von `oca-installation-helper`
image::oca_installer_help.png["Die Onlinehilfe von `oca-installation-helper`", pdfwidth=80%]

Mit diesen Parametern können Sie die Installation automatisieren:

// cspell: ignore adminuser, crypt, encode
[source,console]
----
oca-installation-helper --service-address https://10.1.2.3:4447 --service-username adminuser --service-password <passwort> --non-interactive
----

Das `service-password` können Sie optional verschlüsseln. Dazu erzeugen Sie in einem ersten Schritt das verschlüsselte Kennwort:

[source,console]
----
oca-installation-helper --encode-password <passwort>
----

Als Ergebnis erhalten Sie eine Zeichenkette, die mit `{crypt}` beginnt. Diese übergeben Sie anschließend hinter dem Parameter `--service-password`:

[source,console]
----
oca-installation-helper --service-password {crypt}w5TDjcOQw5PDjsOr
----

Wenn Sie die Installation von Hand starten, werden die folgenden Konfigurationsdateien (sofern vorhanden) mit absteigender Priorität ausgewertet, um die Parameter zu setzen:

* `.\files\custom\install.conf` (bzw. `./files/custom/install.conf`)
* `.\install.conf` (bzw. `./install.conf`)
* die jeweilige lokale Datei `opsiclientd.conf`

Hier ist ein Beispiel für eine `install.conf`-Datei zur Automatisierung der Installation:

[source,toml]
----
client_id =
service_address = server.domain.tld
service_username = adminuser
service_password = {crypt}w5TDjcOQw5PDjsOr
dns_domain = subdomain.domain.tld
interactive = false
----

NOTE: Beachten Sie, dass auf der Kommandozeile gesetzte Parameter immer Vorrang vor der Konfigurationsdatei haben!

// cspell: ignore Zeroconf, crypt, noreboot, Temp, interactive
Wenn Sie keine Adresse für den opsi-Service angeben (`--service-address`), dann versucht der Installer, diese automatisch über Zeroconf zu ermitteln.

Über die Parameter `--depot` und `--group` können Sie einen Client zu einem Depot und zu einer Hostgruppe zuordnen. Dazu benötigen Sie administrative Rechte.

Mit dem Parameter `--finalize` legen Sie fest, was nach Abschluss der Installation passiert. Zur Wahl stehen `noreboot` (Standard, `opsiclientd` wird gestartet, ohne ein Event auszulösen), `reboot` und `shutdown`. 

In der Voreinstellung protokolliert der `oca-installation-helper` seine Arbeit. Unter Linux und macOS finden Sie die Logdatei unter `/tmp/oca-installation-helper.log`, unter Windows liegt sie im Verzeichnis `C:\Users\<userid>\AppData\Local\Temp`.

[[opsi-manual-clientagent-components]]
== Komponenten

Der opsi-Client-Agent besteht aus mehreren Komponenten:

* `opsiclientd`: der zentrale Client-Agent-Dienst (siehe Abschnitt <<opsi-manual-clientagent-opsiclientd>>)
* `opsi-notifier`: Dialogfenster, um Anwender zu informieren (siehe Abschnitt <<opsi-manual-clientagent-opsi-notifier>>)
* `opsi-login-blocker`: verhindert die Benutzeranmeldung, bis die Installation abgeschlossen ist (nur Windows, siehe Abschnitt <<opsi-manual-clientagent-opsi-notifier>>)

[[opsi-manual-clientagent-opsiclientd]]
=== *opsiclientd*

Der zentrale Client-Agent-Dienst heißt `opsiclientd`. Der Service läuft dauerhaft im Hintergrund und kann in bestimmten Situationen besondere Aktionen ausführen. Diese bezeichnen wir im Folgenden als Events. Die wesentlichen Funktionen und Features des Dienstes `opsiclientd` sind:

* *Event-basierte Steuerung*: Der `opsiclientd` kann auf verschiedene Events im System reagieren. Ein Beispiel für ein solches Event ist der Start des `opsiclientd`-Dienstes.

* *Steuerung über Webservice*: Der Zugriff auf diese Schnittstelle ist über das Netzwerk möglich; sie dient zum Anstoßen von Installationen (`push`) und auch zu Wartungszwecken.

* *Remote Konfiguration*: Sie können alle wichtigen Einstellungen global über die Host-Parameter oder für einzelne Clients vornehmen (`opsi-configed`). 

* *Kontakt zum opsi-Configserver*: Sobald ein konfiguriertes Event eintritt, nimmt der `opsiclientd` Kontakt zum opsi-Configserver auf. Er fragt Konfigurationen und anstehende Action Requests per JSON-RPC ab. Das Standard-Event ist `gui_startup`, das beim Start des Rechners bzw. der grafischen Oberfläche und damit vor dem Login des Benutzers stattfindet.

* *opsi-notifier*: Der `opsiclientd` startet den `opsi-notifier` zur Interaktion und Kommunikation mit dem Anwender.

* *opsi-Depot*: Bei Bedarf stellt der `opsiclientd` eine Verbindung zum Depotserver her, aktualisiert die lokale `opsi-script`-Installation und startet `opsi-script` zur Bearbeitung der anstehenden Action Requests (Installation/Deinstallation von Paketen).

// cSpell:ignore notifier
[[opsi-manual-clientagent-opsi-notifier]]
=== *opsi-notifier*/*opsi-login-blocker*
//TODO: neue Screenshots für opsiclientd-action-notifier.png und opsiclientd-shutdown-notifier_timepicker.png, einheitlich, gleiche Größe/Font

Der `opsi-notifier` dient zur Interaktion mit den Anwendern. Er gibt einerseits `opsiclientd`-Statusmeldungen und andererseits Dialoge zum Steuern des `opsiclientd` aus. Konfigurationsdateien definieren jeweils die Funktion und das Erscheinungsbild der Dialoge. 

Der `opsi-notifier` kann in unterschiedlichen Situationen erscheinen und jeweils anders aussehen:

Blocklogin Notifier::
Sie sehen diesen Notifier, während der opsi-Loginblocker aktiv ist (siehe Abschnitt <<opsi-manual-client-agent-opsi-login-blocker>>). In der Voreinstellung sehen Sie ein Vorhängeschloss in der Ecke rechts oben auf dem Bildschirm.

.`opsiclientd`: Blocklogin Notifier
image::opsiclientd-blocklogin-notifier.png["`opsiclientd`: Blocklogin Notifier", pdfwidth=15%]

Event Notifier::
Startet beim Auftreten eines Events, gibt Informationen zum Event-Ablauf aus und bietet die Möglichkeit,
die Bearbeitung eines Events abzubrechen.

.`opsiclientd`: Event Notifier
image::opsiclientd-event-notifier.png["`opsiclientd`: Event Notifier", pdfwidth=30%]

Action Notifier::
Der Notifier startet, wenn Aktionen ausgeführt werden sollen. Er bietet die Möglichkeit, diese abzubrechen und damit zu einem anderen Zeitpunkt auszuführen.

[[action-notifier]]
.`opsiclientd`: Action Notifier
image::opsiclientd-action-notifier.png["`opsiclientd`: Action Notifier", pdfwidth=30%]

Shutdown Notifier::
Startet, wenn ein Shutdown/Reboot auf dem Client ausgeführt werden soll. Es gibt die Möglichkeit, den Vorgang abzubrechen oder aus einem Drop-down-Menü einen anderen Zeitpunkt auszuwählen.

// cSpell:ignore timepicker
.`opsiclientd`: Shutdown Notifier mit Zeitauswahl (`timepicker`)
[[opsi-manual-clientagent-image-shutdown-notifier_timepicker]]
image::opsiclientd-shutdown-notifier_timepicker.png["`opsiclientd`: Shutdown Notifier mit Zeitauswahl (`timepicker`)", pdfwidth=30%]

TIP: Mehr zur Konfiguration des Shutdown Notifiers lesen Sie im nächsten Abschnitt, in dem es um den Ablauf von Events und die wichtigsten Parameter zur Steuerung von Events geht.

[[opsi-manual-clientagent-event-flow]]
== Event-Ablauf

Wie bereits erwähnt läuft der Dienst `opsiclientd` permanent im Hintergrund und startet in bestimmten Situationen Events. Nachdem der `opsiclientd` Kontakt zum opsi-Server aufgenommen und sich authentifiziert hat, fragt er nach anstehenden Aktionen. Gibt es beispielsweise eine neue Version eines Programms, übermittelt der Server diese Information und teilt auch mit, aus welchem Depot der Client-Agent das Paket beziehen soll. Der `opsiclientd` mountet die entsprechende Freigabe (Share) und startet `opsi-script` mit den passenden Credentials für den Service. Nachdem `opsi-script` die Installation abgeschlossen hat, hängt der `opsiclientd` die Freigabe wieder aus und initiiert bei Bedarf einen Reboot des Clients.

Sie können die genaue Abfolge eines Events flexibel konfigurieren (siehe Abschnitt <<opsi-manual-clientagent-configuration-events>>). Um Einstellungen an Ihre Umgebung anzupassen, ist ein Verständnis der Ablauflogik wichtig. Daher zeigt <<event-ablauf>> einen Überblick über den Ablauf eines Standard-Events (`event_gui_startup`) und die Kommunikation zwischen den opsi-Komponenten. 

NOTE: Inzwischen gibt es zusätzlich zum Event `event_gui_startup` für Windows auch das Event `event_startup` für Linux. Beide Events sind weitgehend identisch; sie werden ausgelöst, wenn der Dienst `opsiclientd` gestartet wird (also beim Booten des Clients). Dazu kommen Events, die starten, wenn der Client herunterfährt, wenn es eine Netzwerkverbindung gibt usw.

[[event-ablauf]]
.Der Ablauf eines Standard-Events im Überblick
image::eventflowchart.png["Abbildung: Ablauf eines Standard-Events", pdfwidth=80%, width=1000]

Im Folgenden finden Sie den Ablauf noch einmal Schritt für Schritt zusammengefasst:

// cSpell:ignore user_cancelable_after, action_user_cancelable, action_cancel_counter, shutdown_cancel_counter, shutdown_user_cancelable, shutdown_warning_repetition_time, shutdown_user_selectable_time

1. Beim Start eines Events, wird `event_notifier_command` ausgeführt. Der Client versucht nun, Kontakt zum opsi-Configserver aufzunehmen. Wenn innerhalb von `connection_timeout` Sekunden keine Verbindung zum opsi-Configserver hergestellt werden kann, so wird das laufende Event mit einem Fehler beendet. Kann nach `user_cancelable_after` Sekunden keine Verbindung hergestellt werden, so wird im `opsi-notifier` ein Button aktiviert, über den der Benutzer die Verbindungsaufnahme abbrechen kann. Soll der Benutzer keine Möglichkeit zum Abbrechen haben, muss `user_cancelable_after` auf einen Wert größer oder gleich `connection_timeout` gesetzt werden. Beim Abbruch eines Events schickt der `opsiclientd` abschließend sein Logfile an den Service, und das Event ist zuende.

2. Sobald die Verbindung zum opsi-Configserver hergestellt ist, ist ein Abbrechen nicht mehr möglich. Kommt die Verbindung zustande, fragt der `opsiclientd` nach, ob es für den Client Action Requests gibt. Gibt es keine, ist das Event wiederum zuende. Existiert ein Action Request, wird zunächst geschaut, ob eine `action_warning_time` definiert ist. Der Standardwert ist 0; in dem Fall geht es ohne Action Notifier weiter, und es wird kein `action_notifier_command` ausgeführt.. Ist eine `action_warning_time` > 0 gesetzt, gibt die Zahl die Anzahl der Sekunden an, die der Notifier sichtbar ist. Der Action Notifier (siehe Abbildung <<action-notifier>>) meldet die anstehende Aktion und zeigt den Countdown an. Wenn der Benutzer nicht auf _Abbrechen_ klickt oder der Countdown abgelaufen ist, geht es automatisch weiter.

NOTE: Ob es einen _Abbrechen_-Button gibt, hängt vom Paramter `action_user_cancelable` an. Ist dieser > 0, bestimmt die Zahl die Anzahl der Abbrüche in Folge, der Benutzer kann die anstehende Aktion also genau so viel mal verschieben. Nach Erreichen des Maximalwerts (oder bei `action_user_cancelable` = 0), kann der Anwender die Aktion nicht mehr verschieben. Ein Button, der die Wartezeit unterbricht und die Aktion ohne weitere Verzögerung startet, ist in jedem Fall sichtbar.

TIP: Der Parameter `action_user_cancelable` ist besonders dann sinnvoll, wenn ein Benutzer z.{nbsp}B. seinen Laptop im Meeting oder auf einer Konferenz aufklappt, den Hinweis sieht, dass eine Aktualisierung des Office-Pakets ansteht und das Update auf einen späteren Zeitpunkt verschieben möchte. Der Systemadministrator entscheidet letztendlich, wie oft ein Mitarbeiter ein Update ablehnen kann, bis die Aktion dann auf jeden Fall stattfindet.

[start=3]
3. Die beiden Parameter `action_message` und `action_message[lang]` konfigurieren den Hinweistext, der im Notifier erscheint. Zusätzlich stehen die beiden Platzhalter `%action_user_cancelable%` (Gesamtanzahl der möglichen Abbrüche) und `%action_cancel_counter%` (Anzahl der bereits erfolgten Abbrüche) zur Verfügung. Wenn der Benutzer die Aktion nicht abbricht, wird der `action_cancel_counter` zurückgesetzt und `opsi-script` beginnt mit der Arbeit.

4. Sobald `opsi-script` fertig ist, wird geprüft, ob der Client neu gestartet werden muss. `opsi-script` übermittelt in dem Fall an den `opsiclientd` die Informationen, dass der Rechner einen Reboot benötigt und führt das `shutdown_notifier_command` aus. Ist kein Reboot erforderlich, wird das Event beendet. Ist der Reboot hingegen notwendig, dann wird als Nächstes geprüft, ob es eine `shutdown_warning_time` gibt. Ist diese = 0, startet der Client ohne Warnung neu. Ist der Parameter > 0, zeigt der Shutdown Notifier ähnlich wie der Action Notifier einen Countdown an. Er ist `shutdown_warning_time` Sekunden lang sichtbar.

5. Der Parameter `shutdown_user_cancelable` definiert, wie oft der Benutzer einen Reboot abbrechen und damit verschieben darf. Der Shutdown Notifier bietet in jedem Fall die Möglichkeit, den Shutdown/Reboot sofort auszuführen. Verschiebt der Benutzer die Reboot-/Shutdown-Anforderung, erscheint der Shutdown Notifier nach `shutdown_warning_repetition_time` Sekunden wieder.

6. Die beiden Parameter `shutdown_warning_message` und `shutdown_warning_message[lang] konfigurieren den Hinweistext, der im Shutdown Notifier erscheint. Zusätzlich stehen die beiden Platzhalter `%shutdown_user_cancelable%` (Gesamtanzahl der möglichen Abbrüche) und `%shutdown_cancel_counter%` (Anzahl der bereits erfolgten Abbrüche) zur Verfügung. Nach dem Shutdown/Reboot wird der Parameter `shutdown_cancel_counter` zurückgesetzt.

NOTE: Wenn Sie den Host-Parameter `opsiclientd.event_on_demand.shutdown_user_selectable_time = true` setzen, verändern Sie den Shutdown Notifier für das Event `on_demand`. Dieser Dialog zeigt nun ein Drop-down-Menü an, und Benutzer können hier den gewünschten Zeitpunkt für Shutdown/Reboot auswählen. Die `shutdown_warning_repetition_time` spielt dann keine Rolle mehr. Sie können das Verhalten für auch für andere Events konfigurieren; der nächste Abschnitt geht näher auf die Einrichtung ein. 

Beachten Sie, dass kein Logfile zum opsi-Configserver übertragen wird, wenn die Verbindung zwischen Client und Server fehlschlägt. Eine genaue Fehlerbeschreibung finden Sie dann in der Datei `opsiclientd.log` auf dem Client.

TIP: Den Ablauf von Events und auch die Aktionen des Benutzers zeigt die Timeline auf der `opsiclientd`-Infoseite (siehe Abschnitt <<opsi-manual-clientagent-infopage>>). 

[[opsi-manual-clientagent-configuration]]
== Konfiguration

Im Folgenden wird die Konfiguration des *opsi-client-agent* vorgestellt.
## bisschen mehr Inhalt, Event, Working Windows usw.

Die Konfiguration des `opsiclientd` ist in der Datei `opsiclientd.conf` festgehalten. Die Standardwerte finden Sie unter https://github.com/opsi-org/opsiclientd/blob/devel/opsiclientd_data/windows/opsiclientd.conf
Manuelle Änderungen an der Datei können bei Verbindung mit dem *opsi-Configserver* automatisch überschrieben werden, weshalb diese Möglichkeit nur zu test-Zwecken genutzt werden sollte.

// cSpell:ignore notepad
WARNING: Diese Konfigurationsdatei ist UTF-8 kodiert. Änderungen mit Editoren, die diese Kodierung nicht beherrschen (z.B. notepad.exe), zerstören die Umlaute in dieser Datei.

##Datei abdrucken wie in 4.2?##

Alternativ zur Konfigurationsdatei ... Überleitung

[[opsi-manual-clientagent-configuration-webservice]]
=== Konfiguration über Webservice

Kurzeinführung: entweder configed oder opsi-cli

hier Host-Parameter

==== *opsi-configed*

Die Konfiguration kann zentral gesteuert werden. Hierzu dienen Einträge in den Host-Parametern des *opsi-Configserver*.

Diese Einträge müssen dem folgenden Muster folgen:
`opsiclientd.<name der section>.<name der option>`

Ein Beispiel:
`opsiclientd.event_gui_startup.action_warning_time = 20`
setzt in der Konfigurationsdatei `opsiclientd.conf` in der Sektion `[event_gui_startup]` den Wert von `action_warning_time` auf 20.

* Alle Clients:

Die folgende Abbildung zeigt, wie diese Werte als Defaults für alle Clients über den *opsi-configed* gesetzt werden können.

.Serverweite Konfiguration des opsiclientd über den opsi-configed
image::opsiclientd-configuration-via-configed-serverdefault.png["Abbildung: Serverweite Konfiguration des opsiclientd über den opsi-configed",pdfwidth=70%, width=70%]

Hier kann über das Kontextmenü `Property hinzufügen` ein neuer Wert gesetzt werden.

* Gezielt einzelne Clients:

Alternativ können über den *opsi-configed* client-spezifische Werte bearbeitet werden im 'Host-Parameter' Tab in der Client-Konfiguration.

.Client-spezifische Konfiguration des opsiclientd über den opsi-configed
image::opsiclientd-configuration-via-configed.png["Abbildung: Client spezifische Konfiguration des opsiclientd über den opsi-configed",pdfwidth=70%, width=70%]

==== *opsi-cli*

Alternativ können Sie das Anlegen und Löschen von Host-Parametern mit dem Werkzeug `opsi-cli` durchführen.
Beispiel:

[source,console]
----
opsi-cli jsonrpc execute config_createUnicode opsiclientd.event_gui_startup.action_warning_time
opsi-cli jsonrpc execute config_delete opsiclientd.event_gui_startup.action_warning_time
----

Um Client-spezifische Einträge mit `opsi-cli` anzulegen oder zu löschen, verwenden Sie
Beispiel:

[source,console]
----
opsi-cli jsonrpc execute configState_create opsiclientd.event_gui_startup.action_warning_time "client.domain.de" "120"
opsi-cli jsonrpc execute configState_delete opsiclientd.event_gui_startup.action_warning_time "client.domain.de"
----

[[opsi-manual-clientagent-configuration-events]]
=== Events konfigurieren

Um den vielen unterschiedlichen Situationen gerecht zu werden, in denen der *opsi-client-agent* aktiv werden kann, sind die Konfigurations-Möglichkeiten vielfältig.
In der Konfiguration des `opsiclientd` leitet eine Sektion in der Form `[event_<Event Name>]` eine neue Event-Konfiguration ein.
Eine Event-Konfiguration kann über das Setzen der Option `active = false` deaktiviert werden.
Existiert zu einem Event-Typ keine Event-Konfiguration (oder sind diese deaktiviert), wird der entsprechende Event-Typ komplett deaktiviert.
Es gibt verschiedene Typen von Event-Konfigurationen (`type`).

* Es gibt 'Event-Konfigurations-Vorlagen' (type = template)
Event-Konfigurationen können voneinander "erben". Ist über die Option super die Id einer anderen Event-Konfiguration gesetzt,
erbt die Event-Konfiguration alle Optionen (bis auf `active`) der Parent-Konfiguration.
Geerbte Optionen können jedoch überschrieben werden.
Das Deaktivieren von Events beeinflusst die Vererbung nicht.

* Alle weiteren Event-Konfigurationen gelten für einen gewissen Event-Typ.
Verfügbare Event-Typen sind:

// Kann xref:clients:windows-client/win-client-agent.adoc#opsi-manual-client-agent-custom-events hier nicht verlinken
gui_startup:: Ein Event vom Typ `gui_startup` tritt beim Start des Clients (der GUI) auf. Es ist das gängigste Event und ist in der Standard-Konfiguration aktiv.
custom:: Event-Konfigurationen vom Typ `custom` können selbst festlegen, wann ein solches Event erzeugt wird. Unter windows kann beispielsweise eine WQL Abfrage als Auslöser genutzt werden.
user_login:: Wird ausgelöst, wenn sich ein Benutzer am System anmeldet.
timer:: Tritt in festen Intervallen auf (alle `<Intervall>` Sekunden).
sync_completed:: Wird ausgelöst, wenn die Synchronisation von Konfigurationen (`sync_config_from_server`) oder von Produkten (`cache_products`) erfolgt ist.
on_demand:: Tritt auf, wenn es explizit angefordert wurde, z.B. über den *opsi-configed* oder *opsi Software On Demand (Kiosk Mode)*.
// TODO: link zu xref:configed/configed.adoc#opsi-manual-configed[opsi-configed] oder xref:modules/software-on-demand#software-on-demand[opsi Software On Demand (Kiosk-Mode)]

// cSpell:ignore precondition, user_logged_in, config_cached, products_cached, cachen
* Es gibt Vorbedingungen
Vorbedingungen geben bestimmte Systemzustände vor (z.B. ob gerade ein Benutzer am System angemeldet ist).
In der Konfiguration des `opsiclientd` leitet eine Sektion in der Form `[precondition_<precondition-id>]` die Deklaration einer Vorbedingung ein.
Eine Vorbedingung ist dann erfüllt, wenn alle angegebenen Optionen erfüllt sind.
Mögliche Optionen für Vorbedingungen sind:
user_logged_in:: ist erfüllt, wenn ein Benutzer am System angemeldet ist.
config_cached:: ist erfüllt, wenn das Cachen von Konfigurationen abgeschlossen ist (siehe: +sync_config_from_server+).
products_cached:: ist erfüllt, wenn das Cachen von Produkten abgeschlossen ist (siehe: +cache_products+).

* Einer Event-Konfiguration kann eine Vorbedingung zugewiesen werden.
Einer Event-Konfiguration kann eine Vorbedingung zugewiesen werden, indem diese bei der Deklaration in geschweiften Klammern angegeben wird (z.B. `[event_on_demand{user_logged_in}]`).
Zu einer Event-Konfiguration mit Vorbedingung muss immer eine entsprechende Event-Konfiguration ohne Vorbedingung existieren.
Existiert z.B. eine Event-Konfiguration `event_on_demand{user_logged_in}`, muss auch die Event-Konfiguration `event_on_demand` existieren!
Hierbei erbt die Event-Konfiguration mit Vorbedingung automatisch von der Event-Konfiguration ohne Vorbedingung.
Beim Auftreten eines Events wird nun entschieden, welche Vorbedingungen erfüllt sind.
Ist keine der Vorbedingungen erfüllt, gilt die Event-Konfiguration ohne Vorbedingung.
Ist eine der Vorbedingungen erfüllt, gilt die Event-Konfiguration, die mit dieser Vorbedingung verknüpft ist.
Sind mehrere Vorbedingungen erfüllt, so wird die Vorbedingung bevorzugt, die am genauesten definiert ist (die meisten Optionen besitzt).

Ein Beispiel zur Erläuterung:
Im Rahmen einer Installation kann es notwendig sein, den Rechner neu zu starten.
Ist gerade ein Benutzer am System angemeldet, sollte dieser über den anstehenden Reboot informiert werden.
Hierbei ist eine angemessene Wartezeit vor dem Ausführen des Reboots angebracht.
Zusätzlich kann es sinnvoll sein, dem Benutzer die Entscheidung zu überlassen, ob der Reboot besser zu einem späteren Zeitpunkt ausgeführt werden soll.
Ist zum Zeitpunkt des benötigten Reboots jedoch kein Benutzer angemeldet, ist es sinnvoll, den Reboot ohne weitere Wartezeit sofort durchzuführen.
Dieses Problem wird am Beispiel von `event_on_demand` wie folgt konfiguriert:

* Es wird eine Vorbedingung `user_logged_in` definiert, die erfüllt ist, wenn ein Benutzer am System angemeldet ist (`user_logged_in = true`).

* In der Event-Konfiguration `event_on_demand` (ohne Vorbedingung) wird `shutdown_warning_time = 0` gesetzt (sofortiger Reboot ohne Meldung).

* In der Event-Konfiguration `event_on_demand{user_logged_in}` wird `shutdown_warning_time = 300` gesetzt (300 Sekunden Vorwarnzeit).


[[opsi-manual-clientagent-working-window]]
=== Working Window

Für alle Events kann ein sogenanntes `working_window` konfiguriert werden.
Dieses begrenzt die Funktion eines Events auf einen Zeitraum innerhalb einer konfigurierbaren Start- und Endzeit.

Um das `working_window' zu verwenden, muss der Konfiguration eines Events der Key `working_window` hinzugefügt werden.
Falls dieser Key nicht existiert, oder keinen, oder einen ungültigen Wert hat, so gilt das `working_window` als leer und es gibt keine zeitliche Beschränkung für das Event.

NOTE: Startzeit und Endzeit müssen im Format hh:mm angegeben werden und sind durch einen Bindestrich voneinander getrennt. Leerzeichen zwischen Start und Endzeit sind nicht erlaubt!

Ein `working_window` kann in allen events angelegt werden.
Die Konfiguration des `working_window` erfolgt über das Hinzufügen des Host-Parameters `working_window` für das gewünschte Event.
Das kann entweder über den *opsi-configed*, oder über die Werkzeuge `opsi-admin` oder `opsi-cli` erfolgen.

Die folgenden Beispiele zeigen wie ein `working_window` für das Event 'event_gui_startup' per 'opsi-cli' konfiguriert werden kann.
Siehe Kapitel <<opsi-manual-clientagent-configuration-webservice,Konfiguration über den Webservice>> für das Hinzufügen von Host-Parametern per *opsi-configed*.

Beispiel 1: Globales Erstellen eines leeren `working_window` für das Event `event_gui_startup`. Die zeitliche Einschränkung erfolgt Client spezifisch (siehe Beispiel 3).
[source,shell]
opsi-cli jsonrpc execute config_createUnicode opsiclientd.event_gui_startup.working_window

Beispiel 2: Globales Erstellen eines `working_window` für die Zeit zwischen 20:00 Uhr und 07:00 Uhr für das Event 'event_gui_startup'.
[source,shell]
opsi-cli jsonrpc execute config_createUnicode opsiclientd.event_gui_startup.working_window "gui_startup.working_window" "20:00-07:00"

Beispiel 3: Client spezifisches Einstellen des `working_window` für die Zeit zwischen 07:00 Uhr und 19:00 Uhr für das Event 'event_gui_startup'.
[source,shell]
opsi-cli jsonrpc execute configState_create opsiclientd.event_gui_startup.working_window "client.domain.de" "07:00-19:00"

Ist die Startzeit größer ist als die Endzeit gilt das `working_window` über den nächtlichen Tageswechsel (23:59-00:00).
Beispiel am Tag (Startzeit < Endzeit): working_window=07:00-19:00
Beispiel in der Nacht (Startzeit > Endzeit): working_window=20:00-07:00


[[opsi-clientagent-configuration-ip-version]]
=== IP-Version (IPv4/IPv6)

Der opsiclientd unterstützt bei der Verbindung zum opsi-Service die Protokolle IPv4 und IPv6. Normalerweise wird das Protokoll beim Verbindungsaufbau automatisch gewählt.
Es gibt jedoch auch die Möglichkeit die zu verwendende Protokoll-Version fest zu konfigurieren.
Hierfür kann in der Sektion "global" der opsiclientd.conf die Option "ip_version" verwendet werden. Mögliche Werte sind "4" (IPv4 verwenden), "6" (IPv6 verwenden) und "auto" (Protokoll automatisch wählen, Standardwert).


[[opsi-clientagent-configuration-proxy]]
=== Proxyserver

Über den Host-Parameter `opsiclientd.global.proxy_url` kann die Verwendung eines HTTP(S)-Proxy konfiguriert werden. Der Wert folgt dem Schema
`http://<user>:<password>@<proxy-url>:<proxy-port>` also z.B. http://proxyuser:proxypass123@proxy.domain.local:8080

Hierbei gibt es drei grundlegende Möglichkeiten:

[proxy_url]
proxy_url = system::
  Es werden die Proxy-Einstellungen des Systems verwendet. Das ist der Default.
proxy_url = ::
  Wenn kein Wert (Leerstring) für proxy_url gesetzt wird, wird kein Proxy-Server verwendet. Die Proxy-Einstellungen des Systems werden in diesem Fall ignoriert.
proxy_url = <url>::
  Es wird der über die URL angegebene Proxy-Server verwendet, die Proxy-Einstellungen des Systems werden ignoriert.
  Die URL muss in der Form `http(s)://<proxy-user>:<proxy-password>@<proxy-url>:<proxy-port>` angeben werden.
  Hierbei kann auch eine Authentifizierung für den Proxy konfiguriert werden.
  Beispiel: `http://proxy.domain.tld:3128`


[[opsi-manual-clientagent-configuration-eventcontrol_over_productgroups]]
=== Produktgruppen

Steuerung der verarbeiteten Produkte pro Event

Mit diesem neuen Feature ist es über die Konfiguration möglich, die Liste der ab zu bearbeitenden Produkte über Produktgruppen zu steuern.

Dazu gibt es Grundsätzlich zwei Vorgehensweise:

Black-listing (ausschließen):

Mit der Option `exclude_product_group_ids` kann man nun eine Komma separierte Liste von Produktgruppen-Ids mitgeben, dessen Mitglieder vom aktuellen Event ausgeschlossen werden. Auch wenn Sie eigentlich auf setup stehen. Diese Produkte werden zwar ignoriert, aber bleiben auf setup stehen.

White-listing (Liste von Produkten ausschließlich freigeben):

Mit der Option `include_product_group_ids` kann man eine Komma separierte Liste von Produktgruppen-Ids festlegen, dessen Mitglieder überhaupt bearbeitet werden dürfen, vorausgesetzt eine entsprechende Aktion ist gesetzt.

Diese Einstellung kann man entweder Global im Default-Event angeben, damit das für jedes Event gilt. Man kann diese Optionen aber auch Zum Beispiel nur im Event `on_demand` einsetzen, somit kann man Pakete die auf setup stehen von Push-Installationen ausschließen, obwohl Sie auf setup stehen. Bei einem normalen Neustarts des Clients mit `gui_startup` (default) würden diese ausgeschlossenen Pakete trotzdem auf dem Client installiert werden.

WARNING: Für Clients, die das Modul WAN/VPN aktiviert haben, muss man diese Optionen neben dem Sync-Event auch in der CacheService-Sektion mit aufgenommen werden, da der CacheService zwar vom Sync-Event getriggert wird, aber selbst keinen Zugriff auf das sync-Event hat.

WARNING: Produktabhängigkeiten werden bei diesem Feature nicht berücksichtigt. Bitte achten Sie darauf, dass Sie bei der Konfiguration keine Abhängigkeiten außer Kraft setzen.

[[opsi-manual-clientagent-logging]]
=== Logfiles

// cSpell:ignore clientconnect
Die Log-Informationen des `opsiclientd` werden auch an den *opsi-Configserver* übertragen.
Dort liegen sie unter '/var/log/opsi/clientconnect/<ip-bzw.-name-des-clients>.log'.
Sie sind auch im *opsi-configed* über Logdateien => Clientconnect einsehbar.

Jede Zeile in der Logdatei folgt dem Muster:
+[<log level>] [<Datum Zeit>] [Quelle der Meldung] Meldung   (Quellcode-Datei|Zeilennummer).+

Dabei gibt es die Log-Level 0 (nichts) bis 9 (viel) (siehe Abschnitt xref:server:components/opsiconfd.adoc#server-components-opsiconfd-logs[Log-Dateien]).

[[opsi-manual-clientagent-infopage]]
=== *opsiclientd*-Infoseite

Da bei den Abläufen im `opsiclientd` vielfältige Komponenten zusammenwirken, welche zum Teil gleichzeitig aktiv sind, wird die Logdatei leicht unübersichtlich.

Daher verfügt der `opsiclientd` über eine eigene 'infopage' welche die Abläufe auf einer Zeitachse grafisch darstellt.
Diese 'infopage' kann mit dem Browser über die URL `https://<adresse-des-clients>:4441/info.html` aufgerufen werden.

.Info-Page des opsiclientd nach einer Push-Installation mit aktiviertem Produkt-Caching
image::opsiclientd_infopage_event_on_demand.png["Abbildung: Info-Page des opsiclientd nach einer Push-Installation mit aktiviertem Produkt-Caching",width=400]


[[opsi-manual-clientagent-control]]
== Fernsteuerung

Der `opsiclientd` verfügt über eine Webservice-Schnittstelle. (Link auf Webservice-Abschnitt)
Diese ermöglicht es, dem opsi-client-agent Anweisungen zu übermitteln und Vieles mehr.
Beispiele für solche Anweisungen sind:

* Nachrichten (Popup) versenden
* Auslösen von Events (z.B. `on_demand`)

Dies kann auch auf der Kommandozeile mittels Aufrufs einer `hostControlSafe_*`-Methode über `opsi-cli` geschehen.
Bei Verwendung der `hostControlSafe_*`-Methoden `opsi-cli jsonrpc execute hostControlSafe_xx *hostIds` kann der Parameter `*hostIds` folgende Werte haben:

* `["*"]`, dann gilt der Aufruf für alle Clients
* einen Client Namen (z.B. "client.uib.local")
* eine Liste von Clients `["<client1>", "<client2>", ...]` z.B. `["client1.uib.local", "client2.uib.local"]`
* eine Wildcard enthalten, wobei `*` als Platzhalter dient, z.B. `"client.*"` oder `"*.uib.*"`

Werden Rechner nicht erreicht (z.B. weil sie aus sind), wird für diese Rechner eine Fehlermeldung ausgegeben.

[[opsi-manual-clientagent-control-messages]]
=== Nachrichten per Popup senden

Über den *opsi-configed* lassen sich Nachrichten an einen oder mehrere Clients versenden.

//TODO kaputter link
Siehe dazu Kapitel xref:configed#opsi-manual-configed-client-editing-send-message[opsi-configed - Nachrichten senden]

Auf der Kommandozeile lässt sich dies ebenfalls mittels `opsi-cli` durchführen:
[source,shell]
----
opsi-cli jsonrpc execute hostControlSafe_showPopup message *host
----

Beispiel:
[source,shell]
----
opsi-cli jsonrpc execute hostControlSafe_showPopup "Ein Text..." "client.uib.local"
----

[[opsi-manual-clientagent-control-fire-event]]
=== 'Push'-Installationen: Event 'on demand' auslösen

Vom opsi-Server aus kann der Client aufgefordert werden, die gesetzten action-requests auszuführen.

//TODO kaputter link
Das Auslösen des Events kann vom *opsi-configed* aus erfolgen.
xref:configed#opsi-manual-configed-client-editing-ondemand[opsi-configed - on_demand Ereignis auslösen]

// cspell: ignore hostControlSafe_fireEvent
Auf der Kommandozeile lässt sich dies ebenfalls mittels `opsi-cli` durchführen:
[source,shell]
----
opsi-cli jsonrpc execute hostControlSafe_fireEvent event *hostIds
----

Beispiel:
[source,shell]
----
opsi-cli jsonrpc execute hostControlSafe_fireEvent "on_demand" "client.uib.local"
----

[[opsi-manual-clientagent-control-misc]]
== Wartungsarbeiten (Shutdown/Reboot)

Über den Webservice des `opsiclientd` ist es möglich, steuernd auf den *opsi-client-agent* einzuwirken.
Authentifizierung funktioniert entweder mittels des lokalen Administrator-Accounts (ein leeres Passwort ist unzulässig)
oder mittels der *opsi-host-id* (FQDN / vollständiger Host-Name inkl. DNS-Domain) als Benutzername und des `opsi host key` als Passwort.

Vom *opsi-configed* aus geht dies über das Menü 'OpsiClient' oder aus dem Kontextmenü des 'Client'-Tabs.

.Webservice des opsiclientd
image::opsiclientd-control-server-web-interface.png["Abbildung: Webservice des opsiclientd",width=400]

Auch auf der Kommandozeile gibt es hierfür Entsprechungen:

shutdown:
[source,shell]
----
opsi-cli jsonrpc execute hostControlSafe_shutdown *hostIds
----

reboot:
[source,shell]
----
opsi-cli jsonrpc execute hostControlSafe_reboot *hostIds
----

//cspell: ignore corporate
[[opsi-manual-clientagent-ci]]
== Client-Agent an Corporate Identity (CI) anpassen

Die Anpassung des Erscheinungsbildes des *opsi-client-agent* kann insbesondere bei der Einführung erheblich zur Akzeptanz beitragen. So kann z.B. durch das Einfügen eines bekannten Firmenlogos in die Hintergrundgrafiken eine Verunsicherung der Anwender vermieden werden.

Alle graphischen Komponenten des *opsi-client-agent* (*opsi-notifier*, *opsi-script*) basieren auf den Darstellungskomponenten zum Anzeigen von Grafiken und werden auf die selbe Weise angepasst.
Farben können auf drei unterschiedliche Weise angegeben werden: Als symbolischer Name (`clRed`), als Hexadezimal-Wert (`$FF00FF`) oder als rgb Wertliste (`(255,0,0)`).

Als Hintergrund Grafikformate kommt eine Vielzahl unterschiedlicher Bitmap Formate wie .bmp, .png, .jpeg usw in Frage. All dies Formate sind wieder Containerformate, dh. z.B. PNG ist nicht unbedingt gleich PNG. Eventuell ist das eine Darstellbar und das andere nicht.

//cspell: ignore depot, skin
[[opsi-manual-clientagent-ci-opsi-script]]
=== *opsi-script*

Die Dateien, die Sie beim *opsi-script* anpassen können, finden Sie im Verzeichnis `/var/lib/opsi/depot/opsi-client-agent/files/opsi-script/skin`:

bg.png::
Die Default Hintergrundgrafik des *opsi-script* in welche dann zur Laufzeit Textmeldungen und Produktlogos eingeblendet werden. Der Name kann in der Datei `skin.ini` angepasst werden.

skin.ini::
Die Konfigurationsdatei in der festgelegt ist, an welcher Stelle, mit welchem Font und Farbe Textmeldungen eingeblendet werden.

[[opsi-manual-clientagent-ci-opsiclientd]]
=== *opsiclientd*

Im Verzeichnis
`/var/lib/opsi/depot/opsi-client-agent/files/opsi-notifier`
finden sich die Dateien welche das Erscheinungsbild der unterschiedlichen Notifier bestimmen.
Dabei gibt es für jeden Notifier ein Hintergrundbild und eine Konfigurationsdatei:

//cspell: ignore notifiers, userlogin, rights
block_login.bmp:: Hintergrundbild des notifiers, der einen aktiven *opsi-login-blocker* anzeigt.
block_login.ini:: Konfigurationsdatei des *opsi-login-blocker* notifiers.
event.bmp:: Hintergrundbild des notifiers, der einen aktives Event mit Verbindung zum *opsi-Server* anzeigt.
event.ini:: Konfigurationsdatei des Event notifiers.
action.bmp:: Hintergrundbild des notifiers, der eine anstehende Aktion (Softwareinstallation) anzeigt.
action.ini:: Konfigurationsdatei des Action notifiers.
shutdown.bmp:: Hintergrundbild des notifiers, der einen anstehenden Shutdown oder Reboot anzeigt.
shutdown.ini:: Konfigurationsdatei des Shutdown notifiers.
popup.bmp:: Hintergrundbild des notifiers, der eine vom Server gesendete Popup Nachricht anzeigt.
popup.ini:: Konfigurationsdatei des Popup notifiers.
userlogin.bmp:: Hintergrundbild des notifiers, der ein aktives userlogin Event anzeigt.
userlogin.ini:: Konfigurationsdatei des UserLogin notifiers.

[[opsi-manual-clientagent-ci-custom]]
=== Das Verzeichnis *custom* 

Möchten Sie Änderungen, welche Sie an den oben genannten Dateien durchgeführt haben, davor schützen, dass selbige beim Einspielen einer neuen Version des opsi-client-agenten verloren gehen, so können Sie hierfür das `custom` Verzeichnis (`/var/lib/opsi/depot/opsi-client-agent/files/custom`) verwenden. Das komplette `custom` Verzeichnis wird bei der Installation einer neuen Version des opsi-client-agenten gesichert und wieder hergestellt, so dass hier gemachte Änderungen bei einem Update nicht verloren gehen.

files/custom/install.conf:: Die hier festgelegten Werte beeinflussen das Verhalten des oca-installation-helper bei der opsi-client-agent Installation von einem depot mount aus. Sie überschreiben die allgemeine install.conf im opsi-client-agent depot-Verzeichnis.

files/custom/opsi-script/skin/*.*:: Alle Dateien aus diesem Verzeichnis werden bei der Installation des opsi-client-agent auf dem Client in das skin-Verzeichnis des *opsi-script* kopiert.

files/custom/notifier/*.*:: Alle Dateien aus diesem Verzeichnis werden bei der Installation des opsi-client-agent auf dem Client in das Verzeichnis des `opsi notifiers` kopiert und überschreiben dabei die entsprechenden aus dem serverseitigen Standard-Verzeichnis `files/opsi-notifier/notifier.d` stammenden Dateien.

Ein nachträgliches Rechte nachziehen hilft, Folgefehler zu vermeiden:

[source, shell]
----
opsi-setup --set-rights /var/lib/opsi/depot/opsi-client-agent
----



// cspell: ignore systray, systray_check_interval, productid, productname, productversion

[[opsi-manual-clientagent-systray-program]]
== Das Systray Programm des opsi-client-agents

Das Systray Programm des *opsi-client-agent* erfüllt folgende Aufgaben:

* Regelmässige Information über anstehende Installationen (optional)
* Information über anstehende Installationen auf Anforderung über das Kontextmenü
* Möglichkeit den Start der Installationen anzufordern.

.Message Fenster des opsi-client-systray Programms
image::opsi-systray-message.png["Abbildung: Message Fenster des opsi-client-systray Programms",width=200]

.Kontext Menü (Rechte Maustaste) des opsi-client-systray Programms
image::opsi-systray-menue.png["Abbildung: Kontext Menü (Rechte Maustaste) des opsi-client-systray Programms",width=200]

Das `opsi-client-systray` Programm lässt sich über die Produkteigenschaften des Produkts *opsi-client-agent* steuern.

systray_install:: (`true` / `false`) Soll das opsi-client-systray Programm installiert werden ? Default = `false`

systray_check_interval:: Alle wie viel Minuten soll das Programm überprüfen, ob für den Client Installationen anstehen.
Default=`180` (Kleine Werte hier, geben viel Last auf den Server). Der Wert `0` bedeutet, das keine regelmäßigen Prüfungen durchgeführt werden.

systray_request_notify_format:: Format der Benachrichtigung über anstehende Installationen.
Mögliche Werte: `"productid : request"`, `"productname : request"`, `"productname productversion : request"`. Default: `"productname : request"`

Log-Dateien des `opsi-client-systray` werden im log-Verzeichnis des users abgelegt.

//TODO: proper link
//Siehe auch Kapitel xref:modules/software-on-demand#software-on-demand[opsi Software On Demand (Kiosk-Mode)]


##das hier nach oben?
[[opsi_manual_opsi-client-agent_webapi]]
== opsi-client-agent web service

Der *opsiclientd* stellt unter `https://<client-addresse>:4441` eine web-Schnittstelle zur Verfügung. Darin sind verschiedene Möglichkeiten enthalten:

// cspell: ignore viewer
info:: zeigt in kompakter Form an, was der *opsiclientd* tut
log viewer:: ist ein Hilfsmittel zum Betrachten und Durchsuchen des *opsiclientd* logs
control interface:: stellt einen Weg dar, JSONRPC-Anfragen an den *opsiclientd* zu stellen

Die folgenden Abschnitte beleuchten einzelne JSONRPC-Anfragen, die getätigt werden können.

[[opsi_manual_opsi-client-agent_webapi_log_read]]
=== Logdateien auslesen

// cspell: ignore opsi_loginblocker, notifier_block_login, notifier_event
Die JSONRPC-Anfrage `log_read` liest eine auf dem Client vorhandene opsi-Logdatei.
Parameter: `logType *extension *maxSize`
Mögliche `logType` Werte sind `opsiclientd`, `opsi-client-agent`, `opsi-script`, `opsi_loginblocker`, `notifier_block_login` und `notifier_event`.
Mit dem Parameter `extension` können rotierte Logdateien (_1.log, _2.log etc.) angezeigt werden.
Mögliche Werte sind 0-9.
Der Parameter `maxSize` limitiert die Ausgabe auf den angegebenen Wert in Bytes.

[[opsi_manual_opsi-client-agent_webapi_update_component]]
=== Eine opsi-client-agent-Komponente aktualisieren
Die JSONRPC-Anfrage `updateComponent` kann eine *opsi-client-agent*-Komponente aktualisieren.
Parameter: `*component *url`
Mögliche Werte für `component` sind: `opsiclientd`.
Das Update wird von der angegebenen `url` geladen (mögliche Protokolle sind hierbei: `http`, `https` und `file`).
Das Update muss als Archiv (zip / tar / tar.gz / tar.bz2) bereitgestellt werden, das die Dateien der Komponente enthält.

// cspell: ignore insecure
Alternativ kann das Archiv auch über einen `POST`-Request auf `/upload/update/opsiclientd` hochgeladen werden.
Beispiel:
[source,bash]
----
curl --insecure --request POST \
	--user ':<opsi-client-host-key>' \
	--header 'Content-Disposition: filename=oca.zip' \
	--data-binary '@path/to/opsiclientd_windows_x86_<version>.zip' \
	https://<client-address>:4441/upload/update/opsiclientd
----
