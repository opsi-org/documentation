////
; Copyright (c) uib GmbH (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: http://www.opsi.org/credits/
////


:Author:    uib GmbH
:Email:     info@uib.de
:Date:      17.07.2023
:Revision:  4.3
:toclevels: 6
:doctype:   book
:icons:     font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]

[[opsi-manual-clientagent-overview]]
== Überblick

Den Client-Agent installieren Sie auf allen Rechnern, die Sie mit opsi verwalten möchten. Beim Start des Rechners (noch vor Benutzeranmeldung) kontaktiert der Client-Agent den opsi-Configserver. Anhand der dort gespeicherten Informationen prüft der Client-Agent, ob es Updates oder neue Pakete für den Client gibt. 

Um die Installation kümmert sich das Programm xref:opsi-script-manual:opsi-script-manual.adoc[opsi-script], die notwendigen Skripte und Softwarepakete stehen im opsi-Depot (einer Dateifreigabe) bereit. Während die Installation läuft, gibt es keine Möglichkeit und auch keine Notwendigkeit, in den Prozess einzugreifen.

Um zu verhindern, dass sich Benutzer vor Abschluss der Installation auf dem System anmelden können, wird zusätzlich der sogenannte Loginblocker installiert. Er sorgt dafür, dass ein Login erst nach beendeter Installation möglich ist.

NOTE: Um Softwarepakete mit dem Programm `opsi-script` ohne Interaktion installieren zu können, müssen diese bestimmten Regeln und Konventionen folgen (siehe Abschnitt xref:clients:windows-client/softwareintegration.adoc#opsi-winclient-softwintegration-tutorial[Tutorial: *opsi-script*-Skript erstellen]).

[[opsi-manual-clientagent-installation]]
== Installation

Wenn Sie ein xref:clients:windows-client/os-installation.adoc[Betriebssystem] (neu) über opsi installieren, wird der Client-Agent automatisch installiert. 
Alternativ können Sie den <<opsi-manual-clientagent-subsequent-installation>>.

TIP: Um den opsi-Client-Agent auf einem Client zu deinstallieren, setzen Sie das Produkt in der Management-Oberfläche auf _uninstall_.

[[opsi-manual-clientagent-subsequent-installation]]
=== Client-Agent nachträglich installieren

// cspell: ignore installer, help
Zur nachträglichen Installation oder zu Reparaturzwecken des Client-Agent stehen verschiedene Methoden zur Verfügung:

* als MSI-Paket (nur Windows, siehe Abschnitt xref:clients:windows-client/windows-client-agent.adoc#opsi-manual-client-agent-msi[Client-Agent via MSI installieren])
* automatisch im Rahmen einer Betriebssystem-Installation
* manuell aus einem (Depot-)Verzeichnis durch den `oca-installation-helper[.exe]`
* per Push vom Server aus (`opsi-deploy-client-agent`)
* über den Installer (`opsi-client-agent-installer.exe`, `opsi-linux-client-agent-installer.run`, `opsi-mac-client-agent-installer.command`)
* im opsi-Service-Kontext (Client-Agent aktualisiert sich selbst)

In den meisten Fällen (außer beim Upgrade im opsi-Service-Kontext) kommt der `oca-installation-helper[.exe]` zum Einsatz. Diese Anwendung erfüllt im Wesentlichen die folgenden Zwecke:

* Sie kopiert die Installationsdateien (falls notwendig) in ein lokales temporäres Verzeichnis (z.{nbsp}B. Aufruf per UNC-Pfad).
* Sie zeigt ein Dialogfenster an, in dem Sie 

* Die Installationsdateien werden, wenn notwendig, in ein lokales temporäres Verzeichnis kopiert (z.B. Aufruf per UNC-Pfad).
* Es wird ein Dialog-Fenster angezeigt, in dem Parameter zur Installations-Steuerung eingegeben werden können.
* Der Client wird am opsi-Service erzeugt, falls er noch nicht existiert.
* opsi-script wird gestartet und führt die eigentliche Installation durch.

Die Installation baut in jedem Fall eine Service-Verbindung auf, sodass, unabhängig vom Installations-Modus, immer die Product-Properties vom Server verwendet werden.

Die oca-installation-helper[.exe] kennt einige Parameter die per `oca-installation-helper --help` angezeigt werden können.
Mittels dieser Parameter kann die Installation automatisiert werden:

// cspell: ignore adminuser, crypt, encode
[source,bash]
----
oca-installation-helper --service-address https://10.1.2.3:4447 --service-username adminuser --service-password secret --non-interactive
----

Auch die opsi-client-agent-installer[.exe] nimmt die gleichen Parameter entgegen.
Der Installer kann von einem opsi Server ohne Authentifizierung über die folgende Adresse heruntergeladen werden
(analog für opsi-linux-client-agent-installer.run und opsi-mac-client-agent-installer.command):

`https://<opsi-server>:4447/public/opsi-client-agent/opsi-client-agent-installer.exe`

Das ist bei einer manuellen Installation in der Regel einfacher als auf den Depot-Share zuzugreifen.

Das "service-password" kann auch verschlüsselt verwendet werden:

[source,bash]
----
oca-installation-helper --service-password {crypt}w5TDjcOQw5PDjsOr
----

Die Verschlüsselung erfolgt dabei über:

[source,bash]
----
oca-installation-helper --encode-password <Klartext-Passwort>
----

Beim Start der manuellen Installation werden zusätzlich folgende Konfigurations-Dateien (sofern vorhanden) mit absteigender Priorität ausgewertet, um die Parameter zu befüllen:

* .\files\custom\install.conf (bzw. ./files/custom/install.conf)
* .\install.conf (bzw. ./install.conf)
* Die jeweilige lokale opsiclientd.conf

Kommandozeilen-Parameter haben immer Vorrang.

// cspell: ignore Zeroconf, crypt, noreboot, Temp, interactive
Sollte keine opsi-Service-URL angegeben werden, wird versucht, diese über Zeroconf zu ermitteln.

Über die Parameter --depot und --group kann der client einem Depot und einer Hostgruppe zugeordnet werden (geht nur mit admin credentials).

Mit dem Parameter --finalize kann festgelegt werden, wie die Installation abgeschlossen wird (default ist `"noreboot"` wobei der *opsiclientd* gestartet wird, ohne ein Event auszulösen).

Hier noch ein Beispiel für eine install.conf zur Automatisierung der Installation:

[source,bash]
----
client_id =
service_address = server.domain.tld
service_username = adminuser
service_password = {crypt}w5TDjcOQw5PDjsOr
dns_domain = subdomain.domain.tld
interactive = false
----

Standardmäßig erstellt der oca-installation-helper eine Log-Datei (oca-installation-helper.log) im Temp-Verzeichnis des Benutzers.


[[opsi-manual-clientagent-components]]
== Komponenten

Der opsi-Client-Agent besteht aus mehreren Komponenten:

* `opsiclientd`: der zentrale Client-Agent-Dienst (siehe Abschnitt <<opsi-manual-clientagent-opsiclientd>>)
* `opsi-notifier`: Dialogfenster, um Anwender zu informieren (siehe Abschnitt <<opsi-manual-clientagent-opsi-notifier>>)
* `opsi-login-blocker`: verhindert die Benutzeranmeldung, bis die Installation abgeschlossen ist (nur Windows)


[[opsi-manual-clientagent-opsiclientd]]
=== opsiclientd

Wesentliche Funktionen des opsiclientd sind:

* Event basierte Steuerung: Es kann auf unterschiedliche Events im System reagiert werden.
Ein Event ist zum Beispiel der Start des `opsiclientd` Dienstes.

* Steuerung über Webservice: Auf den Webservice des `opsiclientd` kann über das Netzwerk zugegriffen werden.
Diese Schnittstelle dient zum Anstoßen von Installationen (`push`) aber auch zu Wartungszwecken.

* Remote Konfiguration: Alle wesentlichen Konfigurationsdaten des `opsiclientd` lassen sich zentral über
die Host-Parameter global oder Client-spezifisch bearbeiten.

* Beim Auftreten der konfigurierten Events nimmt der `opsiclientd` Kontakt zum *opsi-Configserver* auf.
Konfigurationen und anstehende `action-requests` werden per JSON-RPC abgefragt.
Das Standard-Event ist hierbei `gui_startup`, welches beim Start des Rechners (Start der GUI) und damit vor dem Login aktiv wird.

* Er startet den *opsi-notifier* zur Interaktion und Kommunikation mit dem Anwender.

* Bei Bedarf stellt er eine Verbindung zum *opsi-Depot* her, aktualisiert die lokale Installation des *opsi-script*
und startet diesen zur Bearbeitung der anstehenden `action-requests` (Installationen und Deinstallationen).

// cSpell:ignore notifier
[[opsi-manual-clientagent-opsi-notifier]]
=== opsi-notifier

Der *opsi-notifier* realisiert die Interaktion mit dem Anwender.
Hier werden sowohl Statusmeldungen des `opsiclientd` ausgegeben als auch Dialoge, die zur Steuerung des `opsiclientd` dienen.
Die jeweilige Funktion und das Erscheinungsbild wird hierbei über Konfigurations-Dateien bestimmt.

Der *opsi-notifier* kann zu unterschiedlichen Situationen und auf unterschiedliche Weise erscheinen:

blocklogin notifier::
Der blocklogin notifier ist aktiv, während der *opsi-login-blocker* aktiv ist. Standardmäßig zeigt er ein Schloss in der oberen Ecke des Bildschirms.

.opsiclientd blocklogin notifier
image::opsiclientd-blocklogin-notifier.png["Abbildung: opsiclientd blocklogin notifier", pdfwidth=15%]

event notifier::
Startet beim Auftreten eines Events, gibt Informationen zum Event-Ablauf aus und bietet die Möglichkeit,
die Bearbeitung eines Events abzubrechen.

.opsiclientd event notifier
image::opsiclientd-event-notifier.png["Abbildung: opsiclientd event notifier", pdfwidth=30%]

action notifier::
Wird gestartet, wenn Aktionen ausgeführt werden sollen und bietet die Möglichkeit, diese zu verschieben.

.opsiclientd action notifier
image::opsiclientd-action-notifier.png["Abbildung: opsiclientd action notifier", pdfwidth=30%]

shutdown notifier::
Startet sobald ein Shutdown/Reboot ausgeführt werden muss und bietet die Möglichkeit, diesen zu verschieben. +
Der Default *shutdown notifier* sieht wie folgt aus:

.opsiclientd shutdown notifier
[[opsi-manual-clientagent-image-shutdown-notifier_default]]
image::opsiclientd-shutdown-notifier.png["Abbildung: opsiclientd shutdown notifier", pdfwidth=30%]

Es gibt noch eine alternative Form des *opsiclientd shutdown notifier*bei dem der gewünschte Shutdown Zeitpunkt aus einem Dropdown-Feld ausgewählt werden kann. Das sieht dann z.B. so aus:

// cSpell:ignore timepicker
.opsiclientd shutdown notifier timepicker
[[opsi-manual-clientagent-image-shutdown-notifier_timepicker]]
image::opsiclientd-shutdown-notifier_timepicker.png["Abbildung: opsiclientd shutdown notifier mit Zeitauswahl per Dropdown", pdfwidth=30%]

Zur Konfiguration der `opsiclientd shutdown notifier` siehe unten: <<opsi-manual-clientagent-config-shutdown-notifier,shutdown-notifier>>.

[[opsi-manual-clientagent-event-flow]]
== Event-Ablauf

Der Ablauf der Aktionen, die in einem Event stattfinden, ist vielfältig konfigurierbar.
Um die Konfigurations-Möglichkeiten zu verstehen, ist ein Verständnis der Ablauf-Logik notwendig.
Es folgt zunächst ein Überblick über den Ablauf eines "Standard-Events" bei dem der opsi-Configserver gefragt wird,
ob Aktionen auszuführen sind (z.B. `event_gui_startup`).

.Ablauf eines Standard-Events
image::eventflowchsrt.png["Abbildung: Ablauf eines Standard-Events", pdfwidth=90%]

Die wichtigsten Parameter wirken hier wie folgt zusammen:

// cSpell:ignore user_cancelable_after, action_user_cancelable, action_cancel_counter, shutdown_cancel_counter, shutdown_user_cancelable, shutdown_warning_repetition_time, shutdown_user_selectable_time
. Tritt ein Event ein, wird der `event_notifier_command` ausgeführt.
Nun wird versucht den konfigurierten *opsi-Configserver* über dessen URL zu erreichen.
Konnte nach `user_cancelable_after` Sekunden keine Verbindung hergestellt werden, so wird im *opsi-notifier*
der Button aktiviert, der das Abbrechen der Verbindungsaufnahme ermöglicht.
Sobald die Verbindung zum *opsi-Configserver* hergestellt ist, ist ein Abbrechen nicht mehr möglich.
Kann innerhalb von `connection_timeout` Sekunden keine Verbindung zum *opsi-Configserver* hergestellt werden,
so wird das laufende Event mit einem Fehler beendet.
Soll der User keine Möglichkeit zum Abbrechen haben, muss `user_cancelable_after` auf einen Wert größer oder gleich `connection_timeout` gesetzt werden.

. Wird der *opsi-Configserver* erreicht, wird geprüft, ob Aktionen gesetzt sind.
Sollen Aktionen ausgeführt werden wird der `action_notifier_command` ausgeführt.
Dieser *opsi-notifier* zeigt die Liste der Produkte an, für die Aktionen gesetzt sind und ist `action_warning_time` Sekunden sichtbar.
Ist die `action_warning_time` = 0 (Standard-Wert) wird kein `action_notifier_command` ausgeführt.
Zusätzlich kann ermöglicht werden, das Bearbeiten der Aktionen auf einen späteren Zeitpunkt zu verschieben.
Die Aktionen können hierbei `action_user_cancelable` mal verschoben werden.
Nach Erreichen der maximalen Abbrüche oder im Fall von `action_user_cancelable` = 0 kann die Aktionen nicht mehr verschoben werden.
In jedem Fall wird ein Button angezeigt, mit dem die Wartezeit abgebrochen und die Bearbeitung der Aktionen ohne weitere Verzögerung begonnen werden kann.
Der Hinweis-Text, der im *opsi-notifier*` erscheint, ist über die Option `action_message` bzw `action_message[lang]` konfigurierbar.
Innerhalb dieses Textes können die Platzhalter `%action_user_cancelable%` (Gesamtanzahl der möglichen Abbrüche)
und `%action_cancel_counter%` (Anzahl der bereits erfolgten Abbrüche) verwendet werden.
Wurden die Aktionen nicht vom User abgebrochen, wird der `action_cancel_counter` zurückgesetzt und der *opsi-script* startet mit deren Bearbeitung.

[[opsi-manual-clientagent-config-shutdown-notifier]]
. Beendet sich der *opsi-script* mit einer Reboot-/Shutdown-Anforderung so wird geprüft ob ein `shutdown_notifier_command` gesetzt ist
und ob die `shutdown_warning_time` > 0 ist.
Sind diese Bedingungen erfüllt, wird der `shutdown_notifier_command` ausgeführt.
Der nun startende *opsi-notifier* kündigt den Reboot / Shutdown an und ist `shutdown_warning_time` Sekunden sichtbar.
Die maximale Anzahl, wie oft ein Reboot/Shutdown vom Benutzer verschoben werden kann, wird hierbei über `shutdown_user_cancelable` konfiguriert.
In jedem Fall bietet der *opsi-notifier* die Möglichkeit, den Shutdown/Reboot sofort auszuführen.
Bei einem Verschieben der Reboot-/Shutdown-Anforderung durch den Benutzer erscheint der *opsi-notifier* nach `shutdown_warning_repetition_time` Sekunden wieder.
Der Hinweis-Text ist über `shutdown_warning_message` bzw. `shutdown_warning_message[lang]` konfigurierbar.
Innerhalb dieses Textes können die Platzhalter `%shutdown_user_cancelable%` (Gesamtanzahl der möglichen Abbrüche)
und `%shutdown_cancel_counter%` (Anzahl der bereits erfolgten Abbrüche) verwendet werden.
Nach erfolgtem Shutdown oder Reboot wird der `shutdown_cancel_counter` zurückgesetzt.
Wird der folgende Config (Host-Parameter) gesetzt:
`opsiclientd.event_on_demand.shutdown_user_selectable_time = true`, so verändert sich das Verhalten etwas:
Läuft nun das Event `on_demand`, so wird eine alternative Form des `opsiclientd shutdown notifier` gestartet, bei dem der gewünschte Zeitpunkt aus einem DropDown Feld ausgewählt werden kann.
Dieses geänderte Verhalten ist Event spezifisch: es muss für jedes Event konfiguriert werden, wo dieses Verhalten gewünscht wird
Siehe auch: <<opsi-manual-clientagent-image-shutdown-notifier_timepicker,shutdown-notifier-timepicker>> und <<opsi-manual-clientagent-configuration-webservice,Konfiguration über den Webservice>>.

Da hierbei der Zeitpunkt individuell gewählt wird, spielt die `shutdown_warning_repetition_time` in diesem Fall keine Rolle.

TIP: Tritt bei der Verbindungsaufnahme zum *opsi-Configserver* ein Fehler auf, kann natürlich auch keine Log-Datei
zum `opsi-Configserver' übertragen werden.
Die genaue Fehlerbeschreibung ist jedoch in der `opsiclientd.log` im Log-Verzeichnis auf dem Client festgehalten.

TIP: Der Ablauf des Event und auch die Aktionen des Benutzers sind in der Timeline auf der Info-Seite des *opsiclientd* sichtbar (siehe <<opsi-manual-clientagent-infopage,opsiclientd infopage>>).

[[opsi-manual-clientagent-configuration]]
== Konfiguration

Im Folgenden wird die Konfiguration des *opsi-client-agent* vorgestellt.
## bisschen mehr Inhalt, Event, Working Windows usw.

Die Konfiguration des `opsiclientd` ist in der Datei `opsiclientd.conf` festgehalten. Die Standardwerte finden Sie unter https://github.com/opsi-org/opsiclientd/blob/devel/opsiclientd_data/windows/opsiclientd.conf
Manuelle Änderungen an der Datei können bei Verbindung mit dem *opsi-Configserver* automatisch überschrieben werden, weshalb diese Möglichkeit nur zu test-Zwecken genutzt werden sollte.

// cSpell:ignore notepad
WARNING: Diese Konfigurationsdatei ist UTF-8 kodiert. Änderungen mit Editoren, die diese Kodierung nicht beherrschen (z.B. notepad.exe), zerstören die Umlaute in dieser Datei.

Alternativ zur Konfigurationsdatei ...

[[opsi-manual-clientagent-configuration-webservice]]
=== Konfiguration über Webservice (Host-Parameter)

Die Konfiguration kann zentral gesteuert werden. Hierzu dienen Einträge in den Host-Parametern des *opsi-Configserver*.

Diese Einträge müssen dem folgenden Muster folgen:
`opsiclientd.<name der section>.<name der option>`

Ein Beispiel:
`opsiclientd.event_gui_startup.action_warning_time = 20`
setzt in der Konfigurationsdatei `opsiclientd.conf` in der Sektion `[event_gui_startup]` den Wert von `action_warning_time` auf 20.

Die folgende Abbildung zeigt, wie diese Werte als Defaults für alle Clients über den *opsi-configed* gesetzt werden können.

.Serverweite Konfiguration des opsiclientd über den opsi-configed
image::opsiclientd-configuration-via-configed-serverdefault.png["Abbildung: Serverweite Konfiguration des opsiclientd über den opsi-configed",pdfwidth=70%, width=70%]

Hier kann über das Kontextmenü `Property hinzufügen` ein neuer Wert gesetzt werden.

Alternativ können Sie das Anlegen und Löschen von Host-Parametern mit dem Werkzeug `opsi-cli` durchführen.
Beispiel:
[source,shell]
----
opsi-cli jsonrpc execute config_createUnicode opsiclientd.event_gui_startup.action_warning_time
opsi-cli jsonrpc execute config_delete opsiclientd.event_gui_startup.action_warning_time
----

Um Client-spezifische Einträge mit `opsi-cli` anzulegen oder zu löschen, verwenden Sie
Beispiel:
[source,shell]
----
opsi-cli jsonrpc execute configState_create opsiclientd.event_gui_startup.action_warning_time "client.domain.de" "120"
opsi-cli jsonrpc execute configState_delete opsiclientd.event_gui_startup.action_warning_time "client.domain.de"
----

Alternativ können über den *opsi-configed* client-spezifische Werte bearbeitet werden im 'Host-Parameter' Tab in der Client-Konfiguration.

.Client-spezifische Konfiguration des opsiclientd über den opsi-configed
image::opsiclientd-configuration-via-configed.png["Abbildung: Client spezifische Konfiguration des opsiclientd über den opsi-configed",pdfwidth=70%, width=70%]


[[opsi-manual-clientagent-configuration-events]]
=== Events

Um den vielen unterschiedlichen Situationen gerecht zu werden, in denen der *opsi-client-agent* aktiv werden kann, sind die Konfigurations-Möglichkeiten vielfältig.
In der Konfiguration des `opsiclientd` leitet eine Sektion in der Form `[event_<Event Name>]` eine neue Event-Konfiguration ein.
Eine Event-Konfiguration kann über das Setzen der Option `active = false` deaktiviert werden.
Existiert zu einem Event-Typ keine Event-Konfiguration (oder sind diese deaktiviert), wird der entsprechende Event-Typ komplett deaktiviert.
Es gibt verschiedene Typen von Event-Konfigurationen (`type`).

* Es gibt 'Event-Konfigurations-Vorlagen' (type = template)
Event-Konfigurationen können voneinander "erben". Ist über die Option super die Id einer anderen Event-Konfiguration gesetzt,
erbt die Event-Konfiguration alle Optionen (bis auf `active`) der Parent-Konfiguration.
Geerbte Optionen können jedoch überschrieben werden.
Das Deaktivieren von Events beeinflusst die Vererbung nicht.

* Alle weiteren Event-Konfigurationen gelten für einen gewissen Event-Typ.
Verfügbare Event-Typen sind:

// Kann xref:clients:windows-client/win-client-agent.adoc#opsi-manual-client-agent-custom-events hier nicht verlinken
gui_startup:: Ein Event vom Typ `gui_startup` tritt beim Start des Clients (der GUI) auf. Es ist das gängigste Event und ist in der Standard-Konfiguration aktiv.
custom:: Event-Konfigurationen vom Typ `custom` können selbst festlegen, wann ein solches Event erzeugt wird. Unter windows kann beispielsweise eine WQL Abfrage als Auslöser genutzt werden.
user_login:: Wird ausgelöst, wenn sich ein Benutzer am System anmeldet.
timer:: Tritt in festen Intervallen auf (alle `<Intervall>` Sekunden).
sync_completed:: Wird ausgelöst, wenn die Synchronisation von Konfigurationen (`sync_config_from_server`) oder von Produkten (`cache_products`) erfolgt ist.
on_demand:: Tritt auf, wenn es explizit angefordert wurde, z.B. über den *opsi-configed* oder *opsi Software On Demand (Kiosk Mode)*.
// TODO: link zu xref:configed/configed.adoc#opsi-manual-configed[opsi-configed] oder xref:modules/software-on-demand#software-on-demand[opsi Software On Demand (Kiosk-Mode)]

// cSpell:ignore precondition, user_logged_in, config_cached, products_cached, cachen
* Es gibt Vorbedingungen
Vorbedingungen geben bestimmte Systemzustände vor (z.B. ob gerade ein Benutzer am System angemeldet ist).
In der Konfiguration des `opsiclientd` leitet eine Sektion in der Form `[precondition_<precondition-id>]` die Deklaration einer Vorbedingung ein.
Eine Vorbedingung ist dann erfüllt, wenn alle angegebenen Optionen erfüllt sind.
Mögliche Optionen für Vorbedingungen sind:
user_logged_in:: ist erfüllt, wenn ein Benutzer am System angemeldet ist.
config_cached:: ist erfüllt, wenn das Cachen von Konfigurationen abgeschlossen ist (siehe: +sync_config_from_server+).
products_cached:: ist erfüllt, wenn das Cachen von Produkten abgeschlossen ist (siehe: +cache_products+).

* Einer Event-Konfiguration kann eine Vorbedingung zugewiesen werden.
Einer Event-Konfiguration kann eine Vorbedingung zugewiesen werden, indem diese bei der Deklaration in geschweiften Klammern angegeben wird (z.B. `[event_on_demand{user_logged_in}]`).
Zu einer Event-Konfiguration mit Vorbedingung muss immer eine entsprechende Event-Konfiguration ohne Vorbedingung existieren.
Existiert z.B. eine Event-Konfiguration `event_on_demand{user_logged_in}`, muss auch die Event-Konfiguration `event_on_demand` existieren!
Hierbei erbt die Event-Konfiguration mit Vorbedingung automatisch von der Event-Konfiguration ohne Vorbedingung.
Beim Auftreten eines Events wird nun entschieden, welche Vorbedingungen erfüllt sind.
Ist keine der Vorbedingungen erfüllt, gilt die Event-Konfiguration ohne Vorbedingung.
Ist eine der Vorbedingungen erfüllt, gilt die Event-Konfiguration, die mit dieser Vorbedingung verknüpft ist.
Sind mehrere Vorbedingungen erfüllt, so wird die Vorbedingung bevorzugt, die am genauesten definiert ist (die meisten Optionen besitzt).

Ein Beispiel zur Erläuterung:
Im Rahmen einer Installation kann es notwendig sein, den Rechner neu zu starten.
Ist gerade ein Benutzer am System angemeldet, sollte dieser über den anstehenden Reboot informiert werden.
Hierbei ist eine angemessene Wartezeit vor dem Ausführen des Reboots angebracht.
Zusätzlich kann es sinnvoll sein, dem Benutzer die Entscheidung zu überlassen, ob der Reboot besser zu einem späteren Zeitpunkt ausgeführt werden soll.
Ist zum Zeitpunkt des benötigten Reboots jedoch kein Benutzer angemeldet, ist es sinnvoll, den Reboot ohne weitere Wartezeit sofort durchzuführen.
Dieses Problem wird am Beispiel von `event_on_demand` wie folgt konfiguriert:

* Es wird eine Vorbedingung `user_logged_in` definiert, die erfüllt ist, wenn ein Benutzer am System angemeldet ist (`user_logged_in = true`).

* In der Event-Konfiguration `event_on_demand` (ohne Vorbedingung) wird `shutdown_warning_time = 0` gesetzt (sofortiger Reboot ohne Meldung).

* In der Event-Konfiguration `event_on_demand{user_logged_in}` wird `shutdown_warning_time = 300` gesetzt (300 Sekunden Vorwarnzeit).


[[opsi-manual-clientagent-working-window]]
=== Working Window

Für alle Events kann ein sogenanntes `working_window` konfiguriert werden.
Dieses begrenzt die Funktion eines Events auf einen Zeitraum innerhalb einer konfigurierbaren Start- und Endzeit.

Um das `working_window' zu verwenden, muss der Konfiguration eines Events der Key `working_window` hinzugefügt werden.
Falls dieser Key nicht existiert, oder keinen, oder einen ungültigen Wert hat, so gilt das `working_window` als leer und es gibt keine zeitliche Beschränkung für das Event.

NOTE: Startzeit und Endzeit müssen im Format hh:mm angegeben werden und sind durch einen Bindestrich voneinander getrennt. Leerzeichen zwischen Start und Endzeit sind nicht erlaubt!

Ein `working_window` kann in allen events angelegt werden.
Die Konfiguration des `working_window` erfolgt über das Hinzufügen des Host-Parameters `working_window` für das gewünschte Event.
Das kann entweder über den *opsi-configed*, oder über die Werkzeuge `opsi-admin` oder `opsi-cli` erfolgen.

Die folgenden Beispiele zeigen wie ein `working_window` für das Event 'event_gui_startup' per 'opsi-cli' konfiguriert werden kann.
Siehe Kapitel <<opsi-manual-clientagent-configuration-webservice,Konfiguration über den Webservice>> für das Hinzufügen von Host-Parametern per *opsi-configed*.

Beispiel 1: Globales Erstellen eines leeren `working_window` für das Event `event_gui_startup`. Die zeitliche Einschränkung erfolgt Client spezifisch (siehe Beispiel 3).
[source,shell]
opsi-cli jsonrpc execute config_createUnicode opsiclientd.event_gui_startup.working_window

Beispiel 2: Globales Erstellen eines `working_window` für die Zeit zwischen 20:00 Uhr und 07:00 Uhr für das Event 'event_gui_startup'.
[source,shell]
opsi-cli jsonrpc execute config_createUnicode opsiclientd.event_gui_startup.working_window "gui_startup.working_window" "20:00-07:00"

Beispiel 3: Client spezifisches Einstellen des `working_window` für die Zeit zwischen 07:00 Uhr und 19:00 Uhr für das Event 'event_gui_startup'.
[source,shell]
opsi-cli jsonrpc execute configState_create opsiclientd.event_gui_startup.working_window "client.domain.de" "07:00-19:00"

Ist die Startzeit größer ist als die Endzeit gilt das `working_window` über den nächtlichen Tageswechsel (23:59-00:00).
Beispiel am Tag (Startzeit < Endzeit): working_window=07:00-19:00
Beispiel in der Nacht (Startzeit > Endzeit): working_window=20:00-07:00


[[opsi-clientagent-configuration-ip-version]]
=== IP-Version (IPv4/IPv6)

Der opsiclientd unterstützt bei der Verbindung zum opsi-Service die Protokolle IPv4 und IPv6. Normalerweise wird das Protokoll beim Verbindungsaufbau automatisch gewählt.
Es gibt jedoch auch die Möglichkeit die zu verwendende Protokoll-Version fest zu konfigurieren.
Hierfür kann in der Sektion "global" der opsiclientd.conf die Option "ip_version" verwendet werden. Mögliche Werte sind "4" (IPv4 verwenden), "6" (IPv6 verwenden) und "auto" (Protokoll automatisch wählen, Standardwert).


[[opsi-clientagent-configuration-proxy]]
=== Proxyserver

Über den Host-Parameter `opsiclientd.global.proxy_url` kann die Verwendung eines HTTP(S)-Proxy konfiguriert werden. Der Wert folgt dem Schema
`http://<user>:<password>@<proxy-url>:<proxy-port>` also z.B. http://proxyuser:proxypass123@proxy.domain.local:8080

Hierbei gibt es drei grundlegende Möglichkeiten:

[proxy_url]
proxy_url = system::
  Es werden die Proxy-Einstellungen des Systems verwendet. Das ist der Default.
proxy_url = ::
  Wenn kein Wert (Leerstring) für proxy_url gesetzt wird, wird kein Proxy-Server verwendet. Die Proxy-Einstellungen des Systems werden in diesem Fall ignoriert.
proxy_url = <url>::
  Es wird der über die URL angegebene Proxy-Server verwendet, die Proxy-Einstellungen des Systems werden ignoriert.
  Die URL muss in der Form `http(s)://<proxy-user>:<proxy-password>@<proxy-url>:<proxy-port>` angeben werden.
  Hierbei kann auch eine Authentifizierung für den Proxy konfiguriert werden.
  Beispiel: `http://proxy.domain.tld:3128`


[[opsi-manual-clientagent-configuration-eventcontrol_over_productgroups]]
=== Produktgruppen

Steuerung der verarbeiteten Produkte pro Event

Mit diesem neuen Feature ist es über die Konfiguration möglich, die Liste der ab zu bearbeitenden Produkte über Produktgruppen zu steuern.

Dazu gibt es Grundsätzlich zwei Vorgehensweise:

Black-listing (ausschließen):

Mit der Option `exclude_product_group_ids` kann man nun eine Komma separierte Liste von Produktgruppen-Ids mitgeben, dessen Mitglieder vom aktuellen Event ausgeschlossen werden. Auch wenn Sie eigentlich auf setup stehen. Diese Produkte werden zwar ignoriert, aber bleiben auf setup stehen.

White-listing (Liste von Produkten ausschließlich freigeben):

Mit der Option `include_product_group_ids` kann man eine Komma separierte Liste von Produktgruppen-Ids festlegen, dessen Mitglieder überhaupt bearbeitet werden dürfen, vorausgesetzt eine entsprechende Aktion ist gesetzt.

Diese Einstellung kann man entweder Global im Default-Event angeben, damit das für jedes Event gilt. Man kann diese Optionen aber auch Zum Beispiel nur im Event `on_demand` einsetzen, somit kann man Pakete die auf setup stehen von Push-Installationen ausschließen, obwohl Sie auf setup stehen. Bei einem normalen Neustarts des Clients mit `gui_startup` (default) würden diese ausgeschlossenen Pakete trotzdem auf dem Client installiert werden.

WARNING: Für Clients, die das Modul WAN/VPN aktiviert haben, muss man diese Optionen neben dem Sync-Event auch in der CacheService-Sektion mit aufgenommen werden, da der CacheService zwar vom Sync-Event getriggert wird, aber selbst keinen Zugriff auf das sync-Event hat.

WARNING: Produktabhängigkeiten werden bei diesem Feature nicht berücksichtigt. Bitte achten Sie darauf, dass Sie bei der Konfiguration keine Abhängigkeiten außer Kraft setzen.

[[opsi-manual-clientagent-logging]]
=== Logfiles

// cSpell:ignore clientconnect
Die Log-Informationen des `opsiclientd` werden auch an den *opsi-Configserver* übertragen.
Dort liegen sie unter '/var/log/opsi/clientconnect/<ip-bzw.-name-des-clients>.log'.
Sie sind auch im *opsi-configed* über Logdateien => Clientconnect einsehbar.

Jede Zeile in der Logdatei folgt dem Muster:
+[<log level>] [<Datum Zeit>] [Quelle der Meldung] Meldung   (Quellcode-Datei|Zeilennummer).+

Dabei gibt es die Log-Level 0 (nichts) bis 9 (viel) (siehe Abschnitt xref:server:components/opsiconfd.adoc#server-components-opsiconfd-logs[Log-Dateien]).

[[opsi-manual-clientagent-infopage]]
=== opsiclientd infopage

Da bei den Abläufen im `opsiclientd` vielfältige Komponenten zusammenwirken, welche zum Teil gleichzeitig aktiv sind, wird die Logdatei leicht unübersichtlich.

Daher verfügt der `opsiclientd` über eine eigene 'infopage' welche die Abläufe auf einer Zeitachse grafisch darstellt.
Diese 'infopage' kann mit dem Browser über die URL `https://<adresse-des-clients>:4441/info.html` aufgerufen werden.

.Info-Page des opsiclientd nach einer Push-Installation mit aktiviertem Produkt-Caching
image::opsiclientd_infopage_event_on_demand.png["Abbildung: Info-Page des opsiclientd nach einer Push-Installation mit aktiviertem Produkt-Caching",width=400]


[[opsi-manual-clientagent-control]]
== Fernsteuerung

Der `opsiclientd` verfügt über eine Webservice-Schnittstelle. (Link auf Webservice-Abschnitt)
Diese ermöglicht es, dem opsi-client-agent Anweisungen zu übermitteln und Vieles mehr.
Beispiele für solche Anweisungen sind:

* Nachrichten (Popup) versenden
* Auslösen von Events (z.B. `on_demand`)

Dies kann auch auf der Kommandozeile mittels Aufrufs einer `hostControlSafe_*`-Methode über `opsi-cli` geschehen.
Bei Verwendung der `hostControlSafe_*`-Methoden `opsi-cli jsonrpc execute hostControlSafe_xx *hostIds` kann der Parameter `*hostIds` folgende Werte haben:

* `["*"]`, dann gilt der Aufruf für alle Clients
* einen Client Namen (z.B. "client.uib.local")
* eine Liste von Clients `["<client1>", "<client2>", ...]` z.B. `["client1.uib.local", "client2.uib.local"]`
* eine Wildcard enthalten, wobei `*` als Platzhalter dient, z.B. `"client.*"` oder `"*.uib.*"`

Werden Rechner nicht erreicht (z.B. weil sie aus sind), wird für diese Rechner eine Fehlermeldung ausgegeben.

[[opsi-manual-clientagent-control-messages]]
=== Nachrichten per Popup senden

Über den *opsi-configed* lassen sich Nachrichten an einen oder mehrere Clients versenden.

//TODO kaputter link
Siehe dazu Kapitel xref:configed#opsi-manual-configed-client-editing-send-message[opsi-configed - Nachrichten senden]

Auf der Kommandozeile lässt sich dies ebenfalls mittels `opsi-cli` durchführen:
[source,shell]
----
opsi-cli jsonrpc execute hostControlSafe_showPopup message *host
----

Beispiel:
[source,shell]
----
opsi-cli jsonrpc execute hostControlSafe_showPopup "Ein Text..." "client.uib.local"
----

[[opsi-manual-clientagent-control-fire-event]]
=== 'Push'-Installationen: Event 'on demand' auslösen

Vom opsi-Server aus kann der Client aufgefordert werden, die gesetzten action-requests auszuführen.

//TODO kaputter link
Das Auslösen des Events kann vom *opsi-configed* aus erfolgen.
xref:configed#opsi-manual-configed-client-editing-ondemand[opsi-configed - on_demand Ereignis auslösen]

// cspell: ignore hostControlSafe_fireEvent
Auf der Kommandozeile lässt sich dies ebenfalls mittels `opsi-cli` durchführen:
[source,shell]
----
opsi-cli jsonrpc execute hostControlSafe_fireEvent event *hostIds
----

Beispiel:
[source,shell]
----
opsi-cli jsonrpc execute hostControlSafe_fireEvent "on_demand" "client.uib.local"
----

[[opsi-manual-clientagent-control-misc]]
== Wartungsarbeiten (Shutdown/Reboot)

Über den Webservice des `opsiclientd` ist es möglich, steuernd auf den *opsi-client-agent* einzuwirken.
Authentifizierung funktioniert entweder mittels des lokalen Administrator-Accounts (ein leeres Passwort ist unzulässig)
oder mittels der *opsi-host-id* (FQDN / vollständiger Host-Name inkl. DNS-Domain) als Benutzername und des `opsi host key` als Passwort.

Vom *opsi-configed* aus geht dies über das Menü 'OpsiClient' oder aus dem Kontextmenü des 'Client'-Tabs.

.Webservice des opsiclientd
image::opsiclientd-control-server-web-interface.png["Abbildung: Webservice des opsiclientd",width=400]

Auch auf der Kommandozeile gibt es hierfür Entsprechungen:

shutdown:
[source,shell]
----
opsi-cli jsonrpc execute hostControlSafe_shutdown *hostIds
----

reboot:
[source,shell]
----
opsi-cli jsonrpc execute hostControlSafe_reboot *hostIds
----

//cspell: ignore corporate
[[opsi-manual-clientagent-ci]]
== Client-Agent an Corporate Identity (CI) anpassen

Die Anpassung des Erscheinungsbildes des *opsi-client-agent* kann insbesondere bei der Einführung erheblich zur Akzeptanz beitragen. So kann z.B. durch das Einfügen eines bekannten Firmenlogos in die Hintergrundgrafiken eine Verunsicherung der Anwender vermieden werden.

Alle graphischen Komponenten des *opsi-client-agent* (*opsi-notifier*, *opsi-script*) basieren auf den Darstellungskomponenten zum Anzeigen von Grafiken und werden auf die selbe Weise angepasst.
Farben können auf drei unterschiedliche Weise angegeben werden: Als symbolischer Name (`clRed`), als Hexadezimal-Wert (`$FF00FF`) oder als rgb Wertliste (`(255,0,0)`).

Als Hintergrund Grafikformate kommt eine Vielzahl unterschiedlicher Bitmap Formate wie .bmp, .png, .jpeg usw in Frage. All dies Formate sind wieder Containerformate, dh. z.B. PNG ist nicht unbedingt gleich PNG. Eventuell ist das eine Darstellbar und das andere nicht.

//cspell: ignore depot, skin
[[opsi-manual-clientagent-ci-opsi-script]]
=== *opsi-script*

Die Dateien, die Sie beim *opsi-script* anpassen können, finden Sie im Verzeichnis `/var/lib/opsi/depot/opsi-client-agent/files/opsi-script/skin`:

bg.png::
Die Default Hintergrundgrafik des *opsi-script* in welche dann zur Laufzeit Textmeldungen und Produktlogos eingeblendet werden. Der Name kann in der Datei `skin.ini` angepasst werden.

skin.ini::
Die Konfigurationsdatei in der festgelegt ist, an welcher Stelle, mit welchem Font und Farbe Textmeldungen eingeblendet werden.

[[opsi-manual-clientagent-ci-opsiclientd]]
=== *opsiclientd*

Im Verzeichnis
`/var/lib/opsi/depot/opsi-client-agent/files/opsi-notifier`
finden sich die Dateien welche das Erscheinungsbild der unterschiedlichen Notifier bestimmen.
Dabei gibt es für jeden Notifier ein Hintergrundbild und eine Konfigurationsdatei:

//cspell: ignore notifiers, userlogin, rights
block_login.bmp:: Hintergrundbild des notifiers, der einen aktiven *opsi-login-blocker* anzeigt.
block_login.ini:: Konfigurationsdatei des *opsi-login-blocker* notifiers.
event.bmp:: Hintergrundbild des notifiers, der einen aktives Event mit Verbindung zum *opsi-Server* anzeigt.
event.ini:: Konfigurationsdatei des Event notifiers.
action.bmp:: Hintergrundbild des notifiers, der eine anstehende Aktion (Softwareinstallation) anzeigt.
action.ini:: Konfigurationsdatei des Action notifiers.
shutdown.bmp:: Hintergrundbild des notifiers, der einen anstehenden Shutdown oder Reboot anzeigt.
shutdown.ini:: Konfigurationsdatei des Shutdown notifiers.
popup.bmp:: Hintergrundbild des notifiers, der eine vom Server gesendete Popup Nachricht anzeigt.
popup.ini:: Konfigurationsdatei des Popup notifiers.
userlogin.bmp:: Hintergrundbild des notifiers, der ein aktives userlogin Event anzeigt.
userlogin.ini:: Konfigurationsdatei des UserLogin notifiers.

[[opsi-manual-clientagent-ci-custom]]
=== Das Verzeichnis *custom* 

Möchten Sie Änderungen, welche Sie an den oben genannten Dateien durchgeführt haben, davor schützen, dass selbige beim Einspielen einer neuen Version des opsi-client-agenten verloren gehen, so können Sie hierfür das `custom` Verzeichnis (`/var/lib/opsi/depot/opsi-client-agent/files/custom`) verwenden. Das komplette `custom` Verzeichnis wird bei der Installation einer neuen Version des opsi-client-agenten gesichert und wieder hergestellt, so dass hier gemachte Änderungen bei einem Update nicht verloren gehen.

files/custom/install.conf:: Die hier festgelegten Werte beeinflussen das Verhalten des oca-installation-helper bei der opsi-client-agent Installation von einem depot mount aus. Sie überschreiben die allgemeine install.conf im opsi-client-agent depot-Verzeichnis.

files/custom/opsi-script/skin/*.*:: Alle Dateien aus diesem Verzeichnis werden bei der Installation des opsi-client-agent auf dem Client in das skin-Verzeichnis des *opsi-script* kopiert.

files/custom/notifier/*.*:: Alle Dateien aus diesem Verzeichnis werden bei der Installation des opsi-client-agent auf dem Client in das Verzeichnis des `opsi notifiers` kopiert und überschreiben dabei die entsprechenden aus dem serverseitigen Standard-Verzeichnis `files/opsi-notifier/notifier.d` stammenden Dateien.

Ein nachträgliches Rechte nachziehen hilft, Folgefehler zu vermeiden:

[source, shell]
----
opsi-setup --set-rights /var/lib/opsi/depot/opsi-client-agent
----



// cspell: ignore systray, systray_check_interval, productid, productname, productversion

[[opsi-manual-clientagent-systray-program]]
== Das Systray Programm des opsi-client-agents

Das Systray Programm des *opsi-client-agent* erfüllt folgende Aufgaben:

* Regelmässige Information über anstehende Installationen (optional)
* Information über anstehende Installationen auf Anforderung über das Kontextmenü
* Möglichkeit den Start der Installationen anzufordern.

.Message Fenster des opsi-client-systray Programms
image::opsi-systray-message.png["Abbildung: Message Fenster des opsi-client-systray Programms",width=200]

.Kontext Menü (Rechte Maustaste) des opsi-client-systray Programms
image::opsi-systray-menue.png["Abbildung: Kontext Menü (Rechte Maustaste) des opsi-client-systray Programms",width=200]

Das `opsi-client-systray` Programm lässt sich über die Produkteigenschaften des Produkts *opsi-client-agent* steuern.

systray_install:: (`true` / `false`) Soll das opsi-client-systray Programm installiert werden ? Default = `false`

systray_check_interval:: Alle wie viel Minuten soll das Programm überprüfen, ob für den Client Installationen anstehen.
Default=`180` (Kleine Werte hier, geben viel Last auf den Server). Der Wert `0` bedeutet, das keine regelmäßigen Prüfungen durchgeführt werden.

systray_request_notify_format:: Format der Benachrichtigung über anstehende Installationen.
Mögliche Werte: `"productid : request"`, `"productname : request"`, `"productname productversion : request"`. Default: `"productname : request"`

Log-Dateien des `opsi-client-systray` werden im log-Verzeichnis des users abgelegt.

//TODO: proper link
//Siehe auch Kapitel xref:modules/software-on-demand#software-on-demand[opsi Software On Demand (Kiosk-Mode)]


##das hier nach oben?
[[opsi_manual_opsi-client-agent_webapi]]
== opsi-client-agent web service

Der *opsiclientd* stellt unter `https://<client-addresse>:4441` eine web-Schnittstelle zur Verfügung. Darin sind verschiedene Möglichkeiten enthalten:

// cspell: ignore viewer
info:: zeigt in kompakter Form an, was der *opsiclientd* tut
log viewer:: ist ein Hilfsmittel zum Betrachten und Durchsuchen des *opsiclientd* logs
control interface:: stellt einen Weg dar, JSONRPC-Anfragen an den *opsiclientd* zu stellen

Die folgenden Abschnitte beleuchten einzelne JSONRPC-Anfragen, die getätigt werden können.

[[opsi_manual_opsi-client-agent_webapi_log_read]]
=== Logdateien auslesen

// cspell: ignore opsi_loginblocker, notifier_block_login, notifier_event
Die JSONRPC-Anfrage `log_read` liest eine auf dem Client vorhandene opsi-Logdatei.
Parameter: `logType *extension *maxSize`
Mögliche `logType` Werte sind `opsiclientd`, `opsi-client-agent`, `opsi-script`, `opsi_loginblocker`, `notifier_block_login` und `notifier_event`.
Mit dem Parameter `extension` können rotierte Logdateien (_1.log, _2.log etc.) angezeigt werden.
Mögliche Werte sind 0-9.
Der Parameter `maxSize` limitiert die Ausgabe auf den angegebenen Wert in Bytes.

[[opsi_manual_opsi-client-agent_webapi_update_component]]
=== Eine opsi-client-agent-Komponente aktualisieren
Die JSONRPC-Anfrage `updateComponent` kann eine *opsi-client-agent*-Komponente aktualisieren.
Parameter: `*component *url`
Mögliche Werte für `component` sind: `opsiclientd`.
Das Update wird von der angegebenen `url` geladen (mögliche Protokolle sind hierbei: `http`, `https` und `file`).
Das Update muss als Archiv (zip / tar / tar.gz / tar.bz2) bereitgestellt werden, das die Dateien der Komponente enthält.

// cspell: ignore insecure
Alternativ kann das Archiv auch über einen `POST`-Request auf `/upload/update/opsiclientd` hochgeladen werden.
Beispiel:
[source,bash]
----
curl --insecure --request POST \
	--user ':<opsi-client-host-key>' \
	--header 'Content-Disposition: filename=oca.zip' \
	--data-binary '@path/to/opsiclientd_windows_x86_<version>.zip' \
	https://<client-address>:4441/upload/update/opsiclientd
----
