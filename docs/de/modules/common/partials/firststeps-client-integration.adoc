[[firststeps-osinstall-create-client]]
= Clients hinzufügen

Dieses Kapitel erklärt, wie Sie Windows-Clients in die opsi-Umgebung integrieren. Als Erstes geht es um die Aufnahme vorhandener Clients, danach zeigen wir, wie Sie neue Clients hinzufügen.

[[firststeps-software-deployment-client-integration]]
== Vorhandene Clients integrieren

Um vorhandene Clients mit bereits installiertem Betriebssystem in opsi aufzunehmen, installieren Sie auf dem jeweiligen Rechner den Client-Agent. Danach erscheint der Client auch in der Client-Liste der Management-Oberfläche, sofern Sie ihn dort noch nicht hinzugefügt hatten.

Grundsätzlich gibt es zwei verschiedene Möglichkeiten, den Client-Agent zu installieren:

* <<firststeps-software-deployment-client-integration-installer>> (Installation auf dem Client, eignet sich für einzelne Rechner)
* <<firststeps-software-deployment-client-integration-opsi-deploy>> (Installation auf Server anstoßen, Massen-Rollout)

NOTE: Nachdem der Client-Agent installiert ist, können Sie opsi-Produkte auf dem Client einspielen (siehe Kapitel xref:clients:windows-client/rollout-products.adoc[Rollout existierender Produkte]).

[[firststeps-software-deployment-client-integration-installer]]
=== Installer auf dem Client verwenden

Diese Variante eignet sich besonders für einzelne Rechner, die Sie als Client in eine opsi-Umgebung integrieren möchten. So gehen Sie vor:

. Loggen Sie sich auf dem Client ein.
. Laden Sie den Installer von Ihrem opsi-Config-Server herunter. Sie finden ihn unter https://<fqdn_oder_ip_des_configservers>:4447/public/opsi-client-agent/; das Windows-Programm heißt `opsi-client-agent-installer.exe`.
. Führen Sie den Installer aus; er entpackt sich in ein temporäres lokales Verzeichnis und startet den enthaltenen `oca-installation-helper`. Tragen Sie im Dialogfenster die Werte für die Client-ID, die opsi-Service-URL, den Benutzernamen und das Passwort ein. Soweit möglich, sind die Felder bereits ausgefüllt; passen Sie die Werte gegebenenfalls an Ihre Umgebung an:
* Die Client-ID entspricht in der Regel dem FQDN des Clients.
* Die opsi-Service-URL muss das Format https://<fqdn_oder_ip_des_configservers>:4447 haben.
* Bei einer Erstinstallation des Clients gehören Benutzername und Passwort zu einem Account, der Mitglied der Gruppe `opsiadmin`; bei einer erneuten Installation können Sie auch die Client-ID und den PC-Key verwenden.
. Der Installer nimmt per opsi-Webservice Kontakt zum Server auf, um den Client beim Server zu registrieren. Anschließend ruft er das enthaltene opsi-script auf, um das `setup.opsiscript` des Client-Agents auszuführen.

.Client-Agent-Installation unter Windows 
image::oca_installer-win10.png["Client-Agent-Installation unter Windows", pdfwidth=80%]

TIP: Beim Aufruf des Installers können Sie Parameter angeben, die unter anderem Vorgänge automatisieren. Weitere Details dazu finden Sie in Kapitel xref:clients:client-agent/opsi-client-agent.adoc[{opsi-client-agent}].

[[firststeps-software-deployment-client-integration-opsi-deploy]]
=== `opsi-deploy-client-agent` verwenden

Das Tool `opsi-deploy-client-agent` verteilt den opsi-client-agent direkt vom opsi-Server auf die Clients. Damit steht eine komfortable Möglichkeit bereit, eine große Anzahl von Clients direkt vom Server aus in die opsi-Umgebung zu integrieren.

NOTE: Falls bereits eine andere Möglichkeit zur Softwareverteilung existiert, bietet es sich an, den initialen Rollout über den `client-agent-installer` oder das MSI-Paket des Client-Agents durchzuführen.

Voraussetzungen für Windows-Clients:

* ein offener `c$` Share
* ein offener `admin$` Share
* ein administrativer Account
* die Dienste `RpcSs` und `RpcEptMapper` müssen laufen (ab Windows 8 die Voreinstellung)
* Firewall, die "Datei-und-Druckerfreigabe" und "Windows-Verwaltungsinstrumentalisierung (WMI)" zulässt
* der Registry-Schlüssel `HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy` sollte den Wert 1 haben

Sie finden den `opsi-deploy-client-agent` auf dem opsi-Server im Verzeichnis `/var/lib/opsi/depot/opsi-client-agent`. Das Programm erfordert `root`-Rechte; alternativ reicht es aus, wenn der Benutzer Mitglied der Gruppe `opsifileadmins` ist. Das Werkzeug führt die folgenden Schritte aus:

. Erzeugen des Clients auf dem Server
. Kopieren der Installationsdateien und der Konfiguration (z.{nbsp}B. den PC-Key)
. Starten der Installation über den `oca-installation-helper` (nicht-interaktiv)

Das Tool `opsi-deploy-client-agent` akzeptiert IP-Adressen, Hostnamen und FQDNs. Es versucht, automatisch zu erkennen, welche Art von Adresse der Benutzer übergeben hat.

Rufen Sie das Programm mit dem Parameter `--help` auf, um eine Onlinehilfe einzublenden:

[source,shell]
----
usage: opsi-deploy-client-agent [-h] [--version] [--verbose] [--debug-file DEBUG_FILE] [--username USERNAME]
                                [--password PASSWORD] [--use-fqdn | --use-hostname | --use-ip-address]
                                [--ignore-failed-ping]
                                [--reboot | --shutdown | --start-opsiclientd | --no-start-opsiclientd]
                                [--hosts-from-file HOST_FILE] [--skip-existing-clients] [--threads MAX_THREADS]
                                [--install-timeout INSTALL_TIMEOUT] [--depot DEPOT] [--group GROUP] [--smbclient | --mount]
                                [--keep-client-on-failure | --remove-client-on-failure]
                                [--failed-clients-file FAILED_CLIENTS_FILE]
                                [host [host ...]]

Deploy opsi client agent to the specified clients. The c$ and admin$ must be accessible on every client. Simple File Sharing
(Folder Options) should be disabled on the Windows machine.

positional arguments:
  host                  The hosts to deploy the opsi-client-agent to.

optional arguments:
  -h, --help            show this help message and exit
  --version, -V         show program's version number and exit
  --verbose, -v         increase verbosity (can be used multiple times)
  --debug-file DEBUG_FILE
                        Write debug output to given file.
  --username USERNAME, -u USERNAME
                        username for authentication (default: Administrator).Example for a domain account: -u
                        <DOMAIN>\\<username>
  --password PASSWORD, -p PASSWORD
                        password for authentication
  --use-fqdn, -c        Use FQDN to connect to client.
  --use-hostname        Use hostname to connect to client.
  --use-ip-address      Use IP address to connect to client.
  --ignore-failed-ping, -x
                        try installation even if ping fails
  --reboot, -r          reboot computer after installation
  --shutdown, -s        shutdown computer after installation
  --start-opsiclientd, -o
                        Start opsiclientd service after installation without performing Events (default).
  --no-start-opsiclientd
                        Do not start opsiclientd service after installation (deprecated).
  --hosts-from-file HOST_FILE, -f HOST_FILE
                        File containing addresses of hosts (one per line). If there is a space followed by text after the
                        address this will be used as client description for new clients.
  --skip-existing-clients, -S
                        skip known opsi clients
  --threads MAX_THREADS, -t MAX_THREADS
                        number of concurrent deployment threads
  --install-timeout INSTALL_TIMEOUT
                        timeout for single threads (default is unlimited)
  --depot DEPOT         Assign new clients to the given depot.
  --group GROUP         Assign fresh clients to an already existing group.
  --smbclient           Mount the client's C$-share via smbclient.
  --mount               Mount the client's C$-share via normal mount on the server for copying the files.This imitates the
                        behaviour of the 'old' script.
  --keep-client-on-failure
                        If the client was created in opsi through this script it will not be removed in case of failure.
                        (DEFAULT)
  --remove-client-on-failure
                        If the client was created in opsi through this script it will be removed in case of failure.
  --failed-clients-file FAILED_CLIENTS_FILE
                        filename to store list of failed clients in
----

TIP: Sie können mit `opsi-deploy-client-agent` auch eine Liste von Clients bearbeiten. Dazu übergeben Sie die Clients entweder als letzten Parameter oder verwenden `-f`, gefolgt vom Dateinamen mit der Liste. In einer solchen Datei notieren Sie jeden Client in einer eigenen Zeile.
