////
; Copyright (c) uib GmbH (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: http://www.opsi.org/credits/
////

:Author:    uib GmbH
:Email:     info@uib.de
:Date:      30.09.2023
:Revision:  4.3
:toclevels: 6
:doctype:   book
:icons:     font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]

[[opsi-setup-detector-use-single-analyze-and-create]]
=== Datei analysieren und Paket erzeugen

Die folgenden Abschnitte beschreiben, wie Sie eine Setup-Datei analysieren und daraus ein opsi-Produkt erstellen. Klicken Sie dazu auf der Startseite (<<osd_page_start_de>>) auf die Schaltfläche _Analysiere eine Datei und erzeuge ein opsi Paket_. Danach navigieren Sie im Dateiauswahldialog zur gewünschten `.exe`- oder `.msi`-Datei. Der `opsi-setup-detector` beginnt direkt mit der Analyse.

[[opsi-setup-detector-use-single-analyze]]
==== *opsi-setup-detector*: Analyse

Nach erfolgreicher Analyse einer Setup-Datei sehen Sie diesen Dialog:

.Der *opsi-setup-detector* hat eine Datei analysiert.
image::osd_page_analyze_de.png["Der *opsi-setup-detector* hat eine Datei analysiert.", pdfwidth=80%]

War die Analyse nicht erfolgreich, sehen Sie stattdessen diesen Dialog:

.Der Dialog *Sorry Unknown Installer*
image::osd_unknown_select_installer.png["Der Dialog *Sorry Unknown Installer*", pdfwidth=30%]

Sie können jetzt den Vorgang per Klick auf _Cancel_ abbrechen oder aus dem Drop-down-Menü einen Installertyp auswählen und die Analyse fortsetzen.

Ist die Analyse erfolgreich verlaufen, zeigt der `opsi-setup-detector` das Ergebnis an:

.Auf diesem Reiter sehen Sie das Ergebnis einer erfolgreichen Analyse.
image::osd_page_setup1_de.png["Auf diesem Reiter sehen Sie das Ergebnis einer erfolgreichen Analyse.", pdfwidth=80%]

Im Detail finden Sie auf dem Reiter _1. Setup_ die folgenden Informationen und Funktionen:

* _Erkannter Setup Typ_: Typ des erkannten Installers

* _Bevorzuge Silent Installation_: Aktivieren Sie diese Checkbox, um (wenn möglich) eine Silent-Installation einer Unattended-Installation vorzuziehen.

* _MST erlaubt_: Sollen zusätzliche `mst`-Dateien zum Anpassen der Einstellungen für Microsoft-Windows-Installer-Anwendungen (MSI) verwendet werden? 

* _Info_: Link, der weiterführende Informationen zum Installer anzeigt

* _Setup Datei_: Pfad und Name der analysierten Setup-Datei

* _MST Datei_: Zur Angabe der MST-Datei, die in den Installer-Aufruf integriert werden soll

* _MsiId_: Produktcode bei MSI-Installern oder Installern, die MSI enthalten

* _MsiName_: Produktname Bei MSI-Installern oder Installern, die MSI enthalten; in der Registry als _Displayname_ hinterlegt

* _Software Version_: Version der zu installierenden Software (falls diese ermittelt werden kann)

* _Setup Datei Größe MB_: Größe der Setup-Datei in MByte

* _Benötigter Platz MB_: geschätzter Wert (Größe der Setup-Datei mal 6), kann gegebenenfalls angepasst werden

* _InstallDir_: Verzeichnis, in das die Software installiert werden wird (sofern dieses erkannt wird); falls nicht korrekt erkannt, können Sie über das Ordner-Icon neben dem Feld einen Dateiauswahl-Dialog öffnen und das Verzeichnis festlegen. Pfade wie `C:\program Files` bzw. `C:\program Files (x86)` werden automatisch durch die entsprechenden `opsi-script`-Konstanten (z.{nbsp}B. `%ProgramFiles32Dir%`) ersetzt.

* _Kommando zur Installation_: ermitteltes Kommando zur nicht-interaktiven Installation; kann abhängig von der Checkbox  _Bevorzuge Silent Installation_ unterschiedlich ausfallen

* _Kommando zur Deinstallation_: ermitteltes Kommando zur nicht-interaktiven Deinstallation; kann abhängig von der Checkbox  _Bevorzuge Silent Installation_ unterschiedlich ausfallen

* _Deinstallations Programm_: ermitteltes Programm zur Deinstallation; falls nicht korrekt erkannt, können Sie über das Ordner-Icon neben dem Feld einen Dateiauswahl-Dialog öffnen und zur gewünschten Anwendung navigieren. *MSI-Dateien haben (üblicherweise) kein Deinstallations-Programm.*

* _Hauptrogramm_: Hauptrogramm der zu installierenden Software; wird verwendet, um z.{nbsp}B. Desktopsymbole oder Einträge fürs Starmenü zu erzeugen. Wird nicht automatisch erkannt. Wenn das Produkt bereits auf dem Rechner installiert ist, können Sie über das Ordner-Icon einen Auswahldialog öffnen.

Alle nach der Analyse ermittelten Werte können Sie bei Bedarf korrigieren und/oder ergänzen. Klicken Sie danach auf die Schaltfläche _Nächster Schritt_, um den ersten Reiter der Produkt-Konfiguration zu öffnen.

WARNING: Es ist sehr wahrscheinlich, dass die ermittelten Werte unvollständig oder sogar teilweise falsch sind. Überprüfen Sie nach einer ersten Installation unbedingt die Werte von _InstallDir_, _Deinstallations Programm_, _Hauptrogramm_ und _Software Version_ und passen Sie diese gegebenenfalls in Ihrem Skript an!

[[opsi-setup-detector-product-configuration1]]
==== *opsi-setup-detector*: Produkt-Konfiguration 1

Auf diesem Reiter nehmen Sie die folgenden Einstellungen vor:

.Konfigurieren Sie das opsi-Produkt.
image::osd_page_product1_de.png["Konfigurieren Sie das opsi-Produkt", pdfwidth=80%]

* _opsi Product ID_: Das ist der Name des neuen opsi-Paketes. Er wird aus dem Produktnamen (Feld _opsi Product Name_) erzeugt, wobei Leer- und Sonderzeichen durch Bindestriche ersetzt werden. Die vorgeschlagene Produkt-ID können Sie verändern.

* _Import control File_: Öffnet einen Dateiauswahl-Dialog, um Daten aus einer bestehenden `control`-Datei (`control, control.toml`) ins aktuelle Projekt zu importieren. Nicht importiert werden Angaben zu Versionsnummern, Skriptnamen oder dem benötigten Platz.

* _opsi Product Name_: Den Namen der zu installierenden Software können Sie hier korrigieren.

* _Produkt Version_: Die aus dem Namen der Setup-Datei ermittelte Versionsnummer können Sie hier korrigieren; sie darf nur Ziffern und Punkte enthalten, da sie zur Versionierung des opsi-Paketes verwendet wird.

* _Paket-Version_: Die Versionsnummer des opsi-Paketes dient zur Unterscheidung von opsi-Produkten, die dieselbe Software in derselben Version enthalten, aber unterschiedliche Skripte oder Propertys haben. Sie darf nur Ziffern und Punkte enthalten, da sie zur Versionierung des opsi-Paketes verwendet wird.

* _Beschreibung_: Tragen Sie in dieses Feld eine kurze Beschreibung der Anwendung ein.

* _Hinweis_: Hier ist Platz für ergänzende Hinweise zur Software, wie z.{nbsp}B. Herkunft, Downloadlink, Lizenz usw.

* _Template Channel_: Wählen Sie aus dem Drop-down-Menü eines der folgenden Templates zur Erstellung der Skripte aus:

  - _default_: Standard und Fallback; wählen Sie ein anderes Template aus, das die notwendigen Dateien für Ihren Task nicht bereitstellt, so wird automatisch _default_ verwendet. Wesentliche Skripte des Produktes sind: `setup.opsiscript`, `uninstall.opsiscript`, `declarations.opsiinc`, `sections.opsiinc` und `delinc.opsiinc`.

  - _training_: einfacher Aufbau mit ausführlichen Kommentaren; wesentliche Skripte des Produktes sind: `setup.opsiscript`, `uninstall.opsiscript` und `delinc.opsiinc`

  - _structured_: Fallback zu _default_; in Version 4.2.2 nicht verwendet

  - _custom_: Ist in der Voreinstellung leer und bietet Platz für eigene Template-Dateien. Dazu kopieren Sie Ihre Templates ins Verzeichnis `opsi-setup-detector/custom/template-files/` auf dem Depotserver und installieren danach den `opsi-setup-detector` neu auf den entsprechenden Clients.

Im unteren Fensterbereich finden Sie außerdem einige Checkboxen, über die Sie zusätzlichen Code und Einstellungen für bestimmte Aufgaben ergänzen:

* _Unterstütze custom directory_: Das Produkt bekommt ein zusätzliches Verzeichnis namens `custom`, das (kundenspezifische) Anpassungen enthalten kann. Bei der Installation einer neuen Version des Paketes auf dem Server wird ein solches `custom`-Verzeichnis nicht überschrieben. Der Code enthält Vorlagen, um Dateien aus diesem Verzeichnis hinzuzufügen (siehe Abschnitt <<opsi-setup-detector-support_custom_directory>>).)

* _Installiere von lokalem, temporären Verzeichnis_: Die Installations-Dateien werden zunächst in ein lokales, temporäres Verzeichnis kopiert und dann von dort aus installiert. Das ist vor allem sinnvoll für alle Komponenten, die während der Installation die Netzwerkverbindung beeinträchtigen könnten, z.{nbsp}B. Treiber (siehe Abschnitt <<opsi-setup-detector-install_from_local_temp_dir>>).

* _Behandle Lizenzkeys_: Erzeugt ein zusätzliches Property zur Behandlung von Lizenzschlüsseln hinzu (siehe Abschnitt <<opsi-setup-detector-handle_license_key>>).

* _Desktopicon_: Erzeugt ein zusätzliches, boolesches Property (Voreinstellung `false`) zur Behandlung von Desktopsymbolen hinzu (siehe Abschnitt <<opsi-setup-detector-desktopicon>>).

* _Customize Profile_: Ergänzt den Code um einen Abschnitt `ProfileActions` für Anpassungen in den lokalen Benutzerprofilen (siehe Abschnitt <<opsi-setup-detector-customize_profile>>).

[[opsi-setup-detector-product-configuration-priority_dependecy]]
==== opsi-setup-detector: Priorität und Abhängigkeiten

Auf dem Reiter _Produkt-Konfiguration 2_ können Sie Prioritäten und Abhängigkeiten genauer definieren:

.Konfigurieren Sie Prioritäten und Abhängigkeiten.
image::osd_page_product2_de.png["Konfigurieren Sie Prioritäten und Abhängigkeiten.", pdfwidth=80%]

NOTE: Bei "normaler" Anwendungssoftware müssen Sie hier in der Regel nichts konfigurieren und können auf _Nächster Schritt_ klicken. 

Auf diesem Reiter können Sie folgende Einstellungen vornehmen:

* _Priorität_: Beeinflusst die Reihenfolge der Installation; mögliche Werte liegen zwischen 100 (ganz am Anfang) und -100 (ganz am Ende). *Für Anwendungssoftware empfohlen: 0.* Wenn außerdem Abhängigkeiten existieren, dann beeinflussen diese ebenfalls die Reihenfolge bei der Installation.

* _Abhängigkeiten_: Hier können Sie Abhängigkeiten zwischen Produkten definieren. Wenn in der Konfiguration die Zugangsdaten zu Ihrem opsi-Server hinterlegt sind, wird versucht, eine Verbindung zum Server aufzubauen. Haben Sie das Kennwort aus Sicherheitsgründen nicht hinterlegt, dann erfolgt an dieser Stelle die Passwortabfrage (siehe Abschnitt <<opsi-setup-detector-product-configuration-_dependency-config>>).

image::osd_password_dlg.png["Dialog zur Passworteingabe", pdfwidth=40%]

* _Properties_: Hier definieren Sie (veränderbare) Eigenschaften des Produktes (siehe Abschnitt <<opsi-setup-detector-product-configuration-properties-config>>).

[[opsi-setup-detector-product-configuration-_dependency-config]]
==== Abhängigkeiten definieren

Klicken Sie auf die Schaltfläche _Dependency hinzufügen_, um den Dialog _Depency Editor_ zu öffnen:

.In diesem Dialog konfigurieren Sie Abhängigkeiten.
image::osd_dependency_editor.png["In diesem Dialog konfigurieren Sie Abhängigkeiten.", pdfwidth=40%]

Hier können Sie die folgenden Einstellungen vornehmen:

* _Actionrequest zu dem die Abhängigkeit erzeugt werden soll_: In der Voreinstellung ist hier _setup_ ausgewählt. Ab opsi 4.3 sind auch andere ActionRequests erlaubt (`uninstall`, `update`, `always`, `custom` und `once`). Verwenden Sie diese Einstellung mit Vorsicht, um nicht Bedingungen zu erzeugen, die ohne Widersprüche nicht auflösbar sind! 

NOTE: Das Drop-down-Menü ist nur dann aktiv, wenn Sie in der `opsi-setup-detector`-Konfiguration die Option `dependencies_for_all_actionrequests` aktiviert haben (siehe Abschnitt <<opsi-setup-detector-use-start>>).

Productid:: Productid (Bezeichner) des Produktes zu dem eine Abhängigkeit besteht. +
Wenn es eine Verbindung zum opsi-server gibt, so wird dies hier in grüner Schrift angezeigt und die bekannten _productIds_ können über das Auswahlfeld gewählt werden. Gibt es keine Verbindung zum opsi-server, so wird dies in roter Schrift angezeigt und die _productId_ muss eingegeben werden.

Abhängigkeits Modus:: Sie können entweder die *Aktion* +setup+ anfordern oder (siehe unten) den *Status* (+installed+).

Aktion oder Status:: Für *Status*: Status den das Produkt, zu dem eine Abhängigkeit besteht, haben soll (+installed+). Liegt ein anderer Status vor, so wird das Produkt auf _setup_ gestellt. +
Für *Aktion*: Aktionsanforderung welche bei dem Produkt, zu dem eine Abhängigkeit besteht, gesetzt werden soll (_setup_) +
Bei der Erzeugung eines Meta-Produktes ist dieser Bereich disabled um unsinnige Einstellungen zu vermeiden.

Abhängigkeits Typ:: Installationsreihenfolge. Wenn das Produkt, zu dem eine Abhängigkeit besteht, installiert sein muss bevor mit der Installation des aktuellen Produktes begonnen werden kann, dann ist dies _before_. Muss es nach dem aktuellen Produkt installiert werden so ist dies _after_. Ist die Reihenfolge egal so muss hier nichts eingetragen werden. +
Bei der Erzeugung eines Meta-Produktes ist dieser Bereich disabled um unsinnige Einstellungen zu vermeiden.

*Hinweis:*

Die tatsächliche Installationsreihenfolge ermittelt sich aus einer Kombination von Produktabhängigkeiten und Produktpriorisierung. Details hierzu finden Sie im opsi-Handbuch im Kapitel _Beeinflussung der Installationsreihenfolge durch Prioritäten und Produktabhängigkeiten_

[[opsi-setup-detector-product-configuration-properties-config]]
==== Propertys definieren


Hier können veränderbare Eigenschaften (Produktvariablen) für das Produkt definiert werden.

.opsi-setup-detector Property Editor
image::osd_property-editor.png["Property Editor", pdfwidth=40%]



[cols="10,20,20"]
|==========================
|  Feld / Funktion  |  Beschreibung  |  Hinweise
|  Property Name  |  Name der Produktvariable  |
Dieser Bezeichner wird in der Produktkonfiguration im opsi-configed angezeigt und ist innerhalb der Skripte mit der Funktion `GetProductProperty` auslesbar.
|  Property Type  |  Variablentyp  |  Mögliche Werte: _Text_ / _bool_
|  Multivalue  |  Bestimmt, ob die Produktvariable nur genau einen oder mehrere Werte annehmen kann  |  Nur bei Typ _Text_ verfügbar
|  Editierbar  |  Bestimmt, ob die Vorgabewerte mit neuen oder zusätzlichen Werten überschrieben werden können oder nicht  |  Nur bei Typ _Text_ verfügbar
|  Mögliche Werte  |  Komma-separiert Liste der möglichen Eingabewerte  |
Falls Editierbar auf “True” gesetzt wurde, kann die Liste später innerhalb von opsi-configed ergänzt werden. +
Nur bei Typ _Text_ verfügbar
|  Default Wert  |  Vorgabewert  |  Auswahlliste;
Nur bei Typ _Text_ verfügbar: Freitextfeld.
Nur bei Typ Multivalue verfügbar: Mehrfachauswahl
|==========================

[[opsi-setup-detector-product-configuration-icon]]
==== *opsi-setup-detector*: Produkt-Icon

.opsi-setup-detector Produktkonfiguration 3 (Icon)
image::osd_page_producticon_de.png["Produktkonfiguration 3 (Icon)", pdfwidth=90%]

Hier kann ein Icon für die Anzeige während der Installation ausgewählt werden oder Sie übernehmen mit _Nächster Schritt_ das DefaultIcon (Zahnrad) und wechseln zum nächsten Reiter.. +


Um ein anderes Icon auszuwählen wählen Sie über den Button _Öffne Icon Verzeichnis_ in Verzeichnis aus in dem Sie Icons erwarten. Als Vorauswahl bekommen Sie ein beim _opsi-setup-detector_ mitgeliefertes Verzeichnis von 'open source' Icons: 128x128. Wählen Sie ein Unterverzeichnis und die Icons werden angezeigt. +
Nun können Sie aus der Anzeige ein Icon auswählen.

Nachdem die Produktkonfiguration vollständig ist, kann nun das Produkt erzeugt werden.

[[opsi-setup-detector-product-create]]
==== opsi-setup-detector: Produkt erzeugen


.opsi-setup-detector Produkt erzeugen
image::osd_page_create_de.png["Produkt erzeugen", pdfwidth=90%]

* _Pfad zur opsi-workbench_ ist ein Laufwerksbuchstabe oder UNC Pfad auf dem der share _opsi_workbench_ Ihres opsi-servers gemounted ist.

* Links neben dem Button _opsi Paket erstellen_ befinden sich drei mögliche Auswahl Optionen, die sich auf die Funktion des Buttons beziehen:

* _Erstellungs Modus_ ist ein Auswahlbereich bei dem die Vorgänge bei der Paketerstellung bestimmt werden können:

* _Erstelle opsi Produkt Dateien_ erzeugt falls noch nicht vorhanden, den Verzeichnisbaum für das neue opsi Paket auf der gewählten _opsi-Workbench_. Die für das Pakte benötigten Dateien werden erzeugt bzw. kopiert.

* _Erstelle opsi Produkt Dateien und baue opsi Paket_ führt die im ersten Punkt angeführten Vorgänge durch. +
Zusätzlich wird versucht das Paket auf dem opsi-server zubauen und gegebenenfalls zu installieren (siehe unten: Auswahlfeld _Bau Modus_). +
Wenn in der Konfiguration Verbindungsdaten zum opsi-webservice hinterlegt sind (siehe auch: link:https://docs.opsi.org/opsi-docs-de/4.2/windows-client-manual/softwareintegration.html#opsi-setup-detector-use-start[Opsi-setup-detector Start und notwendige Konfigurationen]) wird dieser kontaktiert. Ist kein Service Passwort gespeichert, wird nach dem Passwort gefragt. Ist die opsi-service Version größer gleich 4.2.0.287 dann wird das bauen und installieren über den opsi-service ausgeführt. +
Ist der Service nicht erreichbar oder zu alt, wird der _opsi PackageBuilder_ ohne interaktive GUI aufgerufen um aus dem erstellten Verzeichnisbaum das opsi-Paket zu erstellen und danach wieder beendet. Die genauen Abläufe werden dabei durch das Auswahlfeld _Bau Modus_ bestimmt:

** _nur bauen_ erzeugt das opsi Paket so wie der Server Befehl `opsi-makepackage`.

** _bauen und installieren_ erzeugt das opsi Paket so wie der Server Befehl `opsi-makepackage`. Danach wird das erzeugte Paket installiert wie mit dem Server Befehl `opsi-package-manager --install <package name>`.

* _Erstelle opsi Produkt Dateien und starte interaktiven Packagebuilder_ führt die im ersten Punkt angeführten Vorgänge durch. +
Zusätzlich wird der _opsi PackageBuilder_ interaktiv aufgerufen. +
Sie müssen diesen selbst beenden um zu dem _opsi-setup-detector_ zurückzukehren. +
Zu Installation, Konfiguration und Bedienung des Community Projektes _opsi PackageBuilder_ siehe https://forum.opsi.org/viewforum.php?f=22

* _opsi Paket erstellen_ ist der Button welcher die Paketerstellung veranlasst. +
Ist bereits ein Paket mit diesem Namen vorhanden, so erscheint eine Rückfrage ob die Dateien im vorhandene Verzeichnis gesichert oder gelöscht werden sollen:

image::osd_overwrite_dlg.png["Backup Dialog", pdfwidth=40%]

Wenn bei der Erstellung der Produktdateien auf der Workbench ein vorhandenes Verzeichnis mit dem Namen <productId> gefunden wird, gibt es eine Rückfrage was mit den alten Dateien geschehen soll.

* _Nur Paket neu bauen_ ist ein Button mit dem das bauen des opsi Paketes veranlasst wird ohne vorher die opsi Dateien neu zu erzeugen. +
Damit kann das Paket neu gebaut werden nach dem per Editor Änderungen an den Scripten durchgeführt wurden ohne diese Änderungen zu verlieren.

Bei der Erstellung der Produktdateien werden auch alle Informationen welche in den Masken eingegeben wurden, in die Datei `opsi-project.osd` im Basisverzeichnis des Produktes geschrieben. Diese Datei kann zu einem späteren Zeitpunkt wieder mit dem opsi-setup-detector geöffnet werden um das Produkt zu modifizieren.

[[opsi-setup-detector-product-reopen]]
=== opsi-setup-detector: Vorhandenes Projekt öffnen

Eine existierende Projektstruktur kann auf zwei Arten durch den opsi-setup-detector als Projekt geöffnet werden:

* Wenn das Produkt durch den opsi-setup-detector erzeugt wurde, können Sie dazu den Menüpunkt: `Datei / Projektdatei öffnen` verwenden um die Datei `opsi-project.osd` im Basisverzeichnis des Produktes zu öffnen.

* Wenn das Produkt *nicht* durch den opsi-setup-detector erzeugt wurde, können Sie dazu den Menüpunkt: `Datei / Controldatei öffnen` verwenden um die Datei `control` bzw. `control.toml` im `OPSI` Verzeichnis des Produktes zu öffnen. +
In diesem Fall haben Sie weniger Informationen insbesondere über die verwendete Installerdatei.
