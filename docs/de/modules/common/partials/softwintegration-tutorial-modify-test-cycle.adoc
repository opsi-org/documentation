////
; Copyright (c) uib GmbH (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: http://www.opsi.org/credits/
////

:Author:    uib GmbH
:Email:     info@uib.de
:Date:      03.10.2023
:Revision:  4.3
:toclevels: 6
:doctype:   book
:icons:     font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]

[[opsi-softwintegration-tutorial-create-and-test-script]]
== Skript testen und verbessern

Zum Testen und Verbessern eines Produktes gibt es zwei verschiedene Varianten:

* Sie testen das erstellte Skript, ohne es auf dem opsi-Server zu installieren und auf dem Client auszurollen (<<opsi-softwintegration-tutorial-create-and-test-script-standalone>>). 

* Sie testen das komplette Produkt, indem Sie es auf dem Server installieren und auf einem Client ausrollen (<<opsi-softwintegration-tutorial-create-and-test-script-integrated>>).

NOTE: Wir gehen im Folgenden davon aus, dass Sie das zu testende Produkt mit dem `opsi-setup-detector` erstellt haben.

[[opsi-softwintegration-tutorial-create-and-test-script-standalone]]
=== Standalone-Tests

Starten Sie die Anwendung `opsi-script-gui`: 

* Windows: Öffnen Sie `opsi-script.exe` per Doppelklick. Wenn der Client-Agent auf dem Rechner installiert ist, finden Sie das Programm unter `C:\Program files (x86)\opsi.org\opsi-client-agent\opsi-script\opsi-script.exe`. Andernfalls kopieren Sie den Inhalt des Verzeichnisses `opsi-script\windows\x86\` von der Freigabe `\\<opsiserver\opsi_depot` auf den Windows-Rechner.

NOTE: Unter Windows 10 klicken Sie die Datei `opsi-script.exe` mit der rechten Maustaste im Explorer an und wählen aus dem Kontextmenü den Eintrag _Ausführen als Administrator_. 

* Linux: Öffnen Sie die Datei `/usr/bin/opsi-script-gui`.

* macOS: Starten Sie die Anwendung `/Applications/opsi-script`.

Nach dem Start sehen Sie das folgende Fenster:

.Öffnen Sie *opsi-script-gui* im interaktiven Modus.
image::opsi-script-interaktiv.png["Öffnen Sie *opsi-script-gui* im interaktiven Modus.", pdfwidth=80%]

Wählen Sie über _Select Script_ das Skript, das Sie testen möchten. Drücken Sie anschließend _Start_. Das Skript wird nun auf diesem Rechner ausgeführt.

Alternativ drücken Sie _Test_Syntax_, um das Skript auf Syntaxfehler zu prüfen. Es wird dabei *nicht* auf dem Rechner ausgeführt (siehe Abschnitt xref:opsi-script-manual:cli-params.adoc#opsi-script-testsyntax[Skript-Syntax prüfen]).

Mit dem `opsi-logviewer` können Sie nun nachvollziehen, wie `opsi-script` das Skript interpretiert.

TIP: Über den Schieberegler rechts unten können Sie den Loglevel verändern und damit mehr oder weniger Details einblenden.

Falls Sie das Skript verändern möchten, können Sie es in einem Texteditor bearbeiten:

* Öffnen Sie das Projekt im opsi PackageBuilder und rufen den Editor auf.
* Verwenden Sie einen Texteditor wie beispielsweise jEdit mit `opsi-script`-Syntax-Highlighting, wie Sie ihn in der Grundausstattung der opsi-Produkte finden.

.Der Texteditor jEdit unterstützt Syntax-Highlighting für *opsi-script*-Skripte.
image::jedit-with-winst-script.png["Der Texteditor jEdit unterstützt Syntax-Highlighting für *opsi-script*-Skripte.", pdfwidth=80%]

Sie können die Änderungen nun speichern (und den Editor geöffnet lassen). Wechseln Sie zum `opsi-script`-Fenster zurück und drücken Sie erneut den _Start_Button; Sie müssen das Skript nicht erneut auswählen. Schauen Sie sich die Änderungen im `opsi-logviewer` an; dazu wählen Sie _Neu laden_ aus dem Kontextmenü der rechten Maustaste oder über den Button in der Symbolleiste.

Um Ihre Skripte weiter anzupassen, können Sie die Punkte wiederholen:

1. Skript im Editor bearbeiten und Änderungen speichern
2. Skript (erneut) in `opsi-script` ausführen
3. Logdatei kontrollieren

[[opsi-softwintegration-tutorial-create-and-test-script-integrated]]
=== Integrierte Tests

Bei den integrierten Tests rollen Sie das Produkt auf einem Testclient aus:

* Öffnen Sie das Skript `setup.opsiscript` in einem Editor und nehmen Sie ggf. Änderungen vor; speichern Sie die Änderungen:
  - Öffnen Sie das Projekt im opsi PackageBuilder und rufen den Editor auf.
  - Verwenden Sie einen Texteditor wie beispielsweise jEdit mit `opsi-script`-Syntax-Highlighting, wie Sie ihn in der Grundausstattung der opsi-Produkte finden.

* Packen Sie das Produkt:
  - Variante 1: Öffnen Sie das Projekt im opsi PackageBuilder und klicken auf den Button _Packen_. 
  - Variante 2: Öffnen Sie ein Terminal auf dem opsi-Server oder melden sich per SSH an, z.{nbsp}B. mit PuTTY. Wechseln Sie zur Workbench (`/var/lib/opsi/workbench`) und dann ins Verzeichnis des Projektes. Rufen Sie den folgenden Befehl zum Packen auf: +
`opsi-makepackage`

* Installieren Sie das Produkt auf dem opsi-Server:
  - Variante 1: Klicken Sie auf den Button _Installieren_ im opsi PackageBuilder.
  - Variante 2: Rufen Sie im Projektverzeichnis im Terminal den folgenden Befehl auf: +
`opsi-package-manager -i <myproctid_version.opsi>`
Ersetzen Sie `<myproctid_version.opsi>` durch den Namen des opsi-Paketes (wie er beim Packen ausgegeben wurde).

* Rollen Sie das Produkt über die Management-Oberfläche `opsi-configed` aus:

. Wählen Sie auf dem Reiter _Clients_ den Testclient aus.
. Wählen Sie auf dem Reiter _Localboot-Produkte_ das Produkt aus. Sollte Ihr opsi-Paket dort nicht auftauchen (was nach dem ersten Installieren normal ist), drücken Sie den Button ganz links in der Symbolleiste oder wählen Sie aus dem Menü _Datei_ / _Alle Daten neu laden_. 
. Setzen Sie das Produkt auf _setup_ und speichern Sie die Änderungen.
. Starten Sie den Client oder rufen Sie für laufende Clients aus dem Kontextmenü _on_demand_ auf.
. Warten Sie, bis die Installation des Produktes auf dem Client durchgelaufen ist.
. Wechseln Sie zum Reiter _Logfiles_ und dort zu _instlog_ und betrachten Sie die Logdatei.

TIP: Über den Schieberegler rechts unten können Sie den Loglevel verändern und damit mehr oder weniger Details einblenden.

Um Ihre Skripte weiter anzupassen, können Sie die Punkte wiederholen:

1. Skript im Editor bearbeiten und Änderungen speichern
2. Produkt packen
3. Produkt auf dem Server installieren
4. Produkt auf dem Client ausrollen
5. Logdatei kontrollieren

// include docu: how to use the opsiPackagebuilder
include::common:partial$softwintegration-tutorial-packagebuilder-use.adoc[]

[[opsi-softwintegration-create-opsi-package-makeproductfile]]
== *opsi-makepackage* Produkt packen

Um das Produkt zu packen, wechseln Sie ins Hauptverzeichnis des Produktes und rufen das Kommando `opsi-makepackage`.

TIP: Es ist empfehlenswert, gleichzeitig eine dazugehörige MD5-Prüfsummendatei zu erzeugen. Diese Datei nutzen unter anderem Tools wie `opsi-package-updater`, um die Integrität des Paketes nach einer Übertragung sicherzustellen.

In der Voreinstellung erzeugt `opsi-makepackage` eine solche MD5-Prüfsummendatei. Falls Sie die Funktion deaktivieren möchten, verwenden Sie diesen Parameter beim Aufruf:

[source,console]
----
opsi-makepackage --no-md5
----

Beim Übertragen von Paketen auf opsi-Depotserver nutzt `opsi-makepackage` das Tool `zsync`. Es überträgt lediglich die Unterschiede der Pakete und spart damit Bandbreite. Dazu ist eine `.zsync`-Datei erforderlich, die `opsi-makepackage` automatisch erstellt. Falls das nicht gewünscht ist, deaktivieren sie das Feature so:

[source,console]
----
opsi-makepackage --no-zsync
----

Wenn es beim Erstellen großer Pakete zu Platzproblemen im temporären Verzeichnis `/tmp` kommt, können Sie hinter `--temp-directory` ein abweichendes temporäres Verzeichnis angeben.

`opsi-makepackage` schaut außerdem vor dem Bauen nach, ob es im Verzeichnis schon ein Paket mit gleichem Namen bzw. mit derselben Versionsnummer gibt. Das Tool fragt in dem Fall nach, wie Sie weiter vorgehen möchten:

[source,console]
----
Package file '/var/lib/opsi/workbench/mytest/mytest_3.14-1.opsi' already exists.
Press <O> to overwrite, <C> to abort or <N> to specify a new version:
----

Drücken Sie [O], um das Paket zu überschreiben; mit [C] brechen Sie den Vorgang ab, und wenn Sie [N] drücken, können Sie anschließend eine neue Versionsnummer angeben.

Mit `o` wählen Sie überschreiben, mit `c` brechen Sie den Vorgang ab und mit `n` können Sie wählen, dass Sie nach einer neuen Product- bzw. Package-Version gefragt werden.

TIP: Weitere Informationen zum Tool `opsi-makepackage` und seinen Parametern finden Sie in Abschnitt xref:server:components/commandline.adoc#server-components-opsi-makepackage[*opsi-makepackage*].

[[opsi-softwintegration-create-opsi-package-manager]]
== *opsi-package-manager*: Produkt installieren

Mit dem Befehl `opsi-package-manager` installieren Sie opsi-Produkte. Wechseln Sie dazu ins Hauptverzeichnis des Produktes und rufen Sie dieses Kommando auf:

[source,console]
----
opsi-package-manager -i <myproductid_version.opsi>
----

TIP: Weitere Informationen zum Tool `opsi-package-manager` und seinen Parametern finden Sie in Abschnitt xref:server:components/commandline.adoc#server-components-opsi-package-manager[*opsi-package-manager*].

[[opsi-softwintegration-example-control]]
== Beispiel: *control*-Datei

Seit opsi 4.3 ist es möglich, eine `control`-Datei im TOML-Format zu erzeugen. Gibt es eine solche Datei `control.toml`, dann ist diese maßgeblich und muss gepflegt werden.


[source,toml]
----
[Package]
version: 1
depends:

[Product]
type: localboot
id: mytest
name: My Test
description: A test product
advice:
version: 3.14
priority: 10
licenseRequired: False
productClasses:
setupScript: setup.ins
uninstallScript:
updateScript:
alwaysScript:
onceScript:
customScript:
userLoginScript:

[ProductDependency]
action: setup
requiredProduct: javavm
requiredStatus: installed

[ProductProperty]
type: unicode
name: mytextprop
multivalue: False
editable: True
description: hint
values: ["off", "on"]
default: ["off"]

[ProductProperty]
type: bool
name: myboolprop
description: yes or no
default: False

[Changelog]
mytest (3.14-1) testing; urgency=low

  * Initial package

 -- jane doe <j.doe@opsi.org>  Mi, 14 Jul 2010 12:47:53 +0000
----

[[opsi-softwintegration-tool-opsi-newprod]]
== *opsi-newprod*: Produkt erstellen

Außer den in diesem Kapitel vorgestellten grafischen Programmen zum Erstellen von opsi-Produkten gibt es das Kommandozeilentool `opsi-newprod` zum Erstellen eines opsi-Produkt-Gerüstes.


Zum Erstellen wechselt man in dieses Verzeichnis und ruft `opsi-newprod` auf.
Das Programm fragt daraufhin nach dem Typ des zu erstellenden Paketes.
Dies ist üblicherweise der Typ +localboot+ für Produkte, die über den 'opsi-client-agent'/'opsi-script' installiert werden.
Der Typ +netboot+ steht für Produkte, die über das opsi-Linux-Bootimage ausgeführt werden (wie z.B. die Betriebssystem-Installationen).

.Auswahl des Produkttyps: localboot
image::newprod-localboot.png[Screenshot: Auswahl des Produkttyps: localboot, pdfwidth=40%]

Wählen Sie nun mit Tab OK (oder bestätigen mit F12). Nun müssen Sie die wesentlichen Produktdaten eingeben. Am oberen Rand ist hierzu eine Hilfe, die erläutert was die Felder bedeuten.

.Eingabe der Produktinformationen
image::newprod-product-info.png[Screenshot: Eingabe der Produktinformationen, pdfwidth=40%]

Product Id:: ist ein eindeutiger Bezeichner für das Produkt in der Regel unabhängig von der Version +
Bitte nur Kleinbuchstaben verwenden, keine Umlaute, keine Leerzeichen, keine Sonderzeichen - '-' ist als Trenner erlaubt.

Product name:: ist der Klartextname des Produktes (wir empfehlen die Vermeidung von Umlauten, '-' ist erlaubt, keine Leerzeichen).

Description:: ist eine ergänzende Beschreibung zum Produkt, die z.B. im opsi-Configeditor unter _Beschreibung_ angezeigt wird.

Advice:: ist eine ergänzende Beschreibung, in der Regel zum Umgang mit dem Produkt, die zu beachten ist und im opsi-Configeditor unter _Notiz_ angezeigt wird.

Product version:: ist die Version der eingepackten Software (max. 32 Zeichen).

Package Version:: ist die Version des Paketes für die Produktversion. Sie dient dazu, Pakete mit gleicher Produktversion, aber z.B. korrigiertem opsi-winst-Skript zu unterscheiden.

License required:: hat bei localboot Produkten keinen Einfluss. Bei netboot Produkten entscheidet diese Option, ob ein Lizenzkey aus dem Lizenzmanagement geholt wird.

Priority:: beeinflusst die Installationsreihenfolge. Mögliche Werte liegen zwischen 100 (ganz am Anfang) und -100 (ganz am Ende). Existieren auch Produktabhängigkeiten, so beeinflussen diese zusätzlich die Installationsreihenfolge.

.Eingabe der opsi-winst-Skript Namen für unterschiedliche Aktionen
image::newprod-script-names.png[Screenshot: Eingabe der opsi-winst-Skript Namen für unterschiedliche Aktionen, pdfwidth=40%]

Nach Eingabe der Produktinformationen werden Sie aufgefordert, die Skripte anzugeben, die Sie für die unterschiedlichen möglichen Aktionen bereit stellen werden.

Üblicherweise heißt das *+Setup script+* gleich `setup.opsiscript`.

Üblicherweise heißt das *+Uninstall script+* gleich `uninstall.opsiscript`.

Ein *+Update-Script+* dient zur geringfügigen Veränderung einer existierenden großen Installation. Wird das Produkt auf setup gestellt, so wird nach dem Abarbeiten des Setup-Skriptes automatisch auch das Update-Skript ausgeführt.

Ein *+Always-Script+* wird bei jedem aktiv werden des opsi-Clientagenten ausgeführt (z.B. bei jedem Boot).

Ein *+Once-Script+* hat den Folgestatus _not_installed_. Es handelt sich hierbei um einen sehr selten verwendeten Schalter, den Sie ignorieren sollten, wenn Sie nicht genau wissen, was Sie damit tun wollen.

Ein *+Custom-Script+* verändert weder Folgeaktion noch Folgestatus. Es handelt sich hierbei um einen sehr selten verwendeten Schalter, den Sie ignorieren sollten, wenn Sie nicht genau wissen, was Sie damit tun wollen.

Ein *+userLoginScript+* dient dazu nach dem Login des users Modifikationen am Profil des eingeloggten users vorzunehmen. Dies Funktioniert nur im Zusammenhang mit der opsi Erweiterung 'User Profile Management' und ist im entsprechenden Kapitel des opsi-Handbuchs beschrieben.


|=======================
| Typ | Folgestatus | Folgeaktion
| setup | installed | none
| uninstall | not_installed | none
| update | installed | none
| always | installed | always
| once | not_installed | none
| custom | _unverändert_ | _unverändert_
| User login | _unverändert_ | _unverändert_
|=======================

Nachdem nun das Produkt selber beschrieben ist, können Sie eine oder mehrere Produktabhängigkeiten definieren. Wollen Sie keine Produktabhängigkeit definieren so geben Sie _No_ ein.

.Eine (weitere) Produktabhängigkeit definieren: Ja / Nein
image::newprod-product-new-dependency.png["Screenshot: Eine (weitere) Produktabhängigkeit definieren: Ja / Nein", pdfwidth=40%]

Zur Erstellung einer Produktabhängigkeit geben Sie die folgenden Daten an. Beachten Sie auch die Hilfe im oberen Teil des Fensters:

.Eingabe der Daten zur Erstellung einer Produktabhängigkeit
image::newprod-product-dependency.png["Screenshot: Eingabe der Daten zur Erstellung einer Produktabhängigkeit", pdfwidth=90%]

Dependency for Action:: Für welche Aktion des Produktes, welches Sie gerade erstellen, soll die Abhängigkeit gelten (nur setup implementiert).

Required product id:: Productid (Bezeichner) des Produktes zu dem eine Abhängigkeit besteht.

Required  action:: Sie können entweder die Aktion _setup_ anfordern oder (siehe unten) den Status (_installed_).

Required installation status:: Status den das Produkt, zu dem eine Abhängigkeit besteht, haben soll (_installed_). Liegt ein anderer Status vor, so wird das Produkt auf _setup_ gestellt.

Requirement type:: Installationsreihenfolge. Wenn das Produkt, zu dem eine Abhängigkeit besteht, installiert sein muss bevor mit der Installation des aktuellen Produktes begonnen werden kann, dann ist dies _before_. Muss es nach dem aktuellen Produkt installiert werden so ist dies _after_. Ist die Reihenfolge egal so muss hier nichts eingetragen werden.

*Hinweis:*

Leider gibt es derzeit keinen generischen Mechanismus für Deinstallations-Produktabhängigkeiten. Zuverlässig ist der ProductDependency-Mechanismus nur für action: setup und die hierbei zu triggernden (before- oder after-) setup Aktionen und installed Status. Ein requiredAction: uninstall führt leider definitiv zu Fehlern.

Nachdem eine Produktabhängigkeit definiert ist, werden Sie wieder gefragt, ob Sie eine (weitere) Produktabhängigkeit definieren wollen. Wenn ja, wiederholt sich der Vorgang; wenn nein, so werden Sie gefragt, ob Sie eine Produkteigenschaft (Zusatzschalter) definieren wollen mit dem Sie die Installation des Produktes modifizieren können.

*Noch ein Hinweis:*

Die tatsächliche Installationsreihenfolge ermittelt sich aus einer Kombination von Produktabhängigkeiten und Produktpriorisierung. Details hierzu finden Sie im opsi-Handbuch im Kapitel 'Beeinflussung der Installationsreihenfolge durch Prioritäten und Produktabhängigkeiten'

.Eine (weitere) Produkteigenschaft definieren
image::newprod-new-property.png["Screenshot: Eine (weitere) Produkteigenschaft definieren", pdfwidth=40%]

Antworten Sie ja, so müssen Sie die Produkteigenschaft beschreiben:

Die Produkteigenschaft wird clientspezifisch gespeichert und besteht aus einem Namen (key) der verschiedene Werte (Values) zugeordnet bekommen kann und die dann vom opsi-winst-Skript abgefragt werden können.

Zunächst müssen Sie angeben, ob es sich um ein Textwert (unicode) oder um einen logische Wert also wahr/falsch (boolean) handelt. Wenn Sie unsicher sind, wählen Sie _unicode_.

.Datentyp der Produkteigenschaft wählen
image::newprod-property-type.png["Screenshot: Datentyp der Produkteigenschaft wählen", pdfwidth=30%]

Weiterhin wird eine Beschreibung benötigt, die im opsi-configed als Hilfe angezeigt wird. Weiterhin müssen Sie, durch Kommas getrennt, alle Werte angeben, die der Key annehmen darf. Wird hier nichts angegeben, so kann später im opsi-Configeditor ein beliebiger Wert eingegeben werden. Über _Editable_ (true/false) können Sie entscheiden, ob neben der vorgegebenen Liste auch andere Werte eingegeben werden dürfen.

NOTE: Enthält ein Wert einen Backslash `\`, so muss dieser doppelt angegeben werden. +
Eine Pfadangabe kann beispielsweise wie folgt aussehen: `C:\\temp`

.Beschreibung der Produkteigenschaft
image::newprod-property-desc.png["Screenshot: Beschreibung der Produkteigenschaft", pdfwidth=40%]

Im Folgefenster müssen Sie festlegen, was der Defaultwert dieser Produkteigenschaft ist.

.Festlegung des Defaultwerts der Produkteigenschaft
image::newprod-property-default.png["Screenshot: Festlegung des Defaultwerts der Produkteigenschaft", pdfwidth=40%]

Wenn Sie als Typ 'boolean' wählen, so reduziert sich die Beschreibung auf 'Property name' und 'Property description'.

.Beschreibung eines boolschen Properties
image::newprod-property-boolean.png["Screenshot: Beschreibung eines boolschen Properties", pdfwidth=60%]

Nachdem eine Produkteigenschaft definiert ist, werden Sie wieder gefragt, ob Sie eine (weitere) Produkteigenschaft definieren wollen. Wenn ja, wiederholt sich der Vorgang; wenn nein, so werden Sie als nächstes nach Name und Mail-Adresse gefragt. Diese werden im Changelog des Paketes verwendet und müssen angegeben werden.

.Eingabe der Maintainer Daten
image::newprod-maintainer.png["Screenshot: Eingabe der Maintainer Daten", pdfwidth=60%]

Danach ist das Grundgerüst des Produktes fertig gestellt.

Mithilfe des `ls` Befehls finden Sie die oben beschriebene Verzeichnis Struktur. Wechseln Sie in den OPSI-Ordner und setzen Sie erneut den `ls` Befehl ab. Hier befindet sich unter anderem die 'control'-Datei, welche die eben eingegebenen Daten enthält und Ihnen auch die Möglichkeit bietet, diese im Editor zu kontrollieren oder zu modifizieren.
