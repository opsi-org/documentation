////
; Copyright (c) uib GmbH (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: https://www.opsi.org/credits/
////

:Author:    uib GmbH
:Email:     info@uib.de
:Date:      12.11.2023
:Revision:  4.3
:toclevels: 6
:doctype:   book
:icons:     font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]

[[opsi-manual-configed-serverconsole]]
= Server-Konsole

CAUTION: Einige der nachfolgend beschriebenen Configed-Funktionen stehen erst ab der python-opsi-Version 4.0.7.38 zur Verfügung.
Dazu zählt vor allem die Befehlsbearbeitung (<<opsi-manual-configed-serverconsole-commandcontrol>>) sowie
die Ausführung der darüber hinterlegten Befehle im configed.

Mit der Version 4.0.7.5 ist der configed um einen neuen Hauptmenüeintrag erweitert,
die "Server-Konsole".
Damit wird die Möglichkeit geboten, vom configed aus
auch über eine SSH-Verbindung Aktionen auf dem opsi-server auszulösen.
Zum einen kann ein Terminal auf dem opsi-server gestartet werden,
zum anderen existieren Menüpunkte für vordefinierte Kommandozeilenbefehle.


._opsi-configed_: Menü: Server-Konsole
image::configed_serverkonsole.png["opsi-configed: Server-Konsole", pdfwidth=80%]

== Verbindungsdaten und Berechtigungen

Wenn nicht anderes konfiguriert ist, wird versucht, für die SSH-Verbindung den im configed angemeldeten User und den verbundenen Configserver zu verwenden.

Ist dies nicht erwünscht, kann die Verbindung über einen SSH-Schlüssel (ggf. mit Passphrase) beim Start des Configeds gestartet werden.
Zu diesem Zweck existieren die folgenden Aufrufparameter für den configed:

* --ssh-key PATH:  z.B. --ssh-key /home/user/.ssh/id_rsa
* --ssh-passphrase PASSPHRASE: z.B. --ssh-passphrase meinpassword

Die Einstellungen lassen sich unter dem Menüpunkt  "Verbindungsdaten" ändern. +

Über Server-Hostparameter (User-Abschnitt) kann feingranular gesteuert werden,
welche der Menüpunkte sichtbar sind bzw. genutzt werden können.
Bei aktivierter Userroles-Funktionalität (vgl. <<opsi-manual-configed-hostproperties-userroles>>)
werden die Konfigurationen userspezifisch verwendet. Für einen neu angelegten User werden dabei
als Default-Werte zunächst die Werte von der allgemeinen User-Ebene gesetzt.

Folgende Configs existieren:

* user.{}.ssh.serverconfiguration.active: +
Aktiviert das Menü der SSH-Verbindungseinstellungen . (Default: false)

* user.{}.ssh.commandmanagement.active: +
Aktiviert die Bearbeitung von Menüeinträgen der SSH-konsolen-Befehle (Default: false)

* user.{}.ssh.menu_serverconsole.active: +
Gibt den Hauptmenüeintrag "Server-Konsole" als solchen frei. (Default: true)

* user.{}.ssh.terminal.active: +
Schaltet die SSH-Shell frei. (Default: true)

* user.{}.ssh.commands.active: +
Schaltet alle SSH-Menüeinträge frei, die hinterlegte Befehle darstellen. (Default: true)

[[opsi-manual-configed-serveractions-terminal]]
== SSH-Terminal
Mithilfe des Terminals können Linux-Systembefehle auf dem verbundenen SSH-Server ausgeführt werden. +
Das Eingabe-Echo kann durch Sternchen (*) ersetzt werden (Passwort-Eingabe). +
Ein gestarteter Prozess lässt sich mit dem Button "Prozess/Verbindung beenden" oder durch "Strg+C" abbrechen. +
Wie von der Kommandozeile gewohnt, kann die "TAB"-Taste Befehle vervollständigen. Achtung: Pfade werden nicht vervollständigt - lediglich Linux-Systembefehle. +
Außerdem können Datenquellen aus dem configed-Kontext angegeben werden, die bei der Befehlsausführung durch die konkreten Werte ersetzt werden.
(Mehr zu dieser Funktionalität: <<opsi-manual-configed-serverconsole-commandcontrol>> - Punkt: Datenquellen)

._opsi-configed_: SSH-Terminal
image::configed_serverkonsole-terminal.png["opsi-configed: SSH-Terminal", pdfwidth=80%]

[[opsi-manual-configed-serveractions-parametercommands]]
== Vordefinierte Befehle mit Eingabemasken
//Als vorgegebene Befehle befinden sich unter der Menügruppe "opsi" 4 Befehle, die während der Laufzeit unterschiedliche Parameter benötigen (gekennzeichnet durch "...").
Unter der Menügruppe "opsi" stehen einige Befehle unabhängig von den selbst definierbaren Befehlen mit einer eigenen Eingabe-Oberfläche zur Verfügung. Diese vereinfachen den Umgang mit diversen Skripten.

* Datei-Download ... +
Eine beliebige Datei kann aus dem Internet mittels "wget"-Befehl heruntergeladen und in ein Zielverzeichnis auf dem Server abgelegt werden. Anwendung findet der Befehl beispielsweise für konkrete opsi-Pakete von download.uib.de.

* Erstellung opsi-Produkt ... +
Voraussetzung für diesen Befehl ist ein opsi-utils-Paket mit der Version >=4.0.7.7.
Über diesen Menüpunkt kann dann, mit Angabe eines Server-Verzeichnis, aus diesem ein opsi-Paket erstellt werden.
Außerdem können die in der Control-Datei gefundenen Versionen (Paket- und Produkt-Version) über einen Button angezeigt und überschrieben
sowie eine md5-Summe und/oder eine zsync-Datei erstellt werden.
Beim Ausführen wird eine .opsi-Datei gebaut.
Zwecks Installation auf dem Server bzw. Depot leitet der Button "Das neu erstellte Paket installieren" zum opsi-package-manager weiter.

* Opsi-Rechte setzen ... +
Dieser Menüpunkt bildet den opsi-Befehl opsi-set-rights ab. Nach der Möglichkeit einen bestimmten (optionalen) Pfad einzugeben in dem das Skript ausgeführt werden soll, wird nach dem root-Passwort gefragt und das Skript im seperaten Fenster ausgeführt.

* Paket-Installation ... +
Durch diesen Befehl können opsi-Pakete mittels "opsi-package-manager" auf allen Depots oder einem Depot installiert werden.
Dabei kann der Server-Pfad zum Paket angegeben werden, in dem sich das opsi-Paket befindet. +
Durch Auswahl eines Paketes aus dem Internet wird die Funktionalität des Befehls "Datei download ..." aufgegriffen und anschließend das heruntergeladene Paket auf dem Depot installiert.
Außerdem sind die Parameter "--update" und "--setup" des opsi-package-manager implementiert.
Sollen die zsync und md5-Dateien eines opsi-Paketes heruntergeladen werden, kann der Schalter "zsync- und md5 einschließen"  aktiviert werden.
Dann wird die url der Pakete entsprechend ergänzt und die zusätzlichen Dateien werden ebenfalls gezogen. +
Mehr zum opsi-package-manager finden Sie unter xref:server/configuration-tools#opsi-manual-configuration-tools-opsi-package-manager[Werkzeug 'opsi-package-manager': opsi-Pakete (de-)installieren]

* Paket-Deinstallation ... +
Aus einer Liste der installierten Pakete kann eines ausgewählt und deinstalliert werden. +
Siehe xref:server/configuration-tools#opsi-manual-configuration-tools-opsi-package-manager[Werkzeug 'opsi-package-manager': opsi-Pakete (de-)installieren]

* Verteilung opsi-client-agent ... +
Möchte man existierende Rechner zu opsi hinzufügen, muss der opsi-client-agent auf dem Zielrechner installiert werden. Wählt man die betreffenden Clients im configed aus und ruft diesen Befehl auf, werden die Client-Namen in das entsprechende Feld übernommen. Wenn der Befehl für mehrere Clients mit einem Aufruf ausgeführt werden soll, müssen die Login-Daten bei den beteiligten Rechnern gleich sein. +
Achtung: Das Skript zum Deployen der Client muss im Verzeichnis _/var/lib/opsi/depot/opsi-client-agent/_ liegen und den Namen _opsi-deploy-client-agent_ haben.
Genauere Informationen finden Sie im Handbuch 'opsi-getting-started' im Kapitel 'Erste Schritte'.

TIP: Einige Oberflächen beinhalten eine Auswahlkomponente für Pfade in der Verzeichnisstruktur. Wird der Button "Ermittle Unterverzeichnisse" betätigt werden alle Verzeichnisse bzw. Dateien aufgelistet, die in dem angegebem Pfad enthalten sind. Für weitere Ebenen muss der Button wiederholt betätigt werden. Diese Funktionalität befindet sich u.a. in der "Opsi-Rechte setzen" oder "Paket-Installation"-Oberfläche.

[[opsi-manual-configed-serverconsole-commandcontrol]]
== Befehle definieren
Zusätzlich zu den vordefinierten Befehlen lassen sich eigene Serverkonsolenbefehle erstellen
bzw. verändern oder entfernen, die über Menüpunkte aufgerufen werden können.
Dabei ist zu beachten, dass unterschiedliche Linux-Systeme unter Umständen nicht die gleichen Kommandozeilenbefehle ausführen können. Deswegen muss der Administrator sicherstellen, dass die Befehle entsprechend dem adressierten Linux-System funktionieren.


._opsi-configed_: Befehle definieren
image::configed_serverkonsole-defcommands.png["opsi-configed: Befehle definieren", pdfwidth=90%]

Folgende Daten müssen bzw. können (gekennzeichnet durch ein "*") für einen Befehl angegeben werden:

* Menü-Text: +
Beim Erstellen eines Befehls _muss_ darauf geachtet werden, dass der Menütext noch nicht für einen anderen Befehl verwendet wurde. Wenn ein Menütext geändert werden soll, muss der Befehl mit dem Minus-Button gelöscht und ein neuer Befehl erstellt werden.

* Beschreibung*: +
Wird eine genauere Beschreibung hinterlegt, taucht diese als Tooltip-Text des Befehls auf.

* übergeordnetes Menü*: +
Legt fest, in welchem Menü der neue Befehl als Menüeintrag erscheinen soll. Bleibt das Feld leer, wird der Menüeintrag direkt dem Menü "Server-Konsole" zugeordnet.

* Position*: +
Die Position bestimmt die Reihenfolge (kleine Zahlen zuerst) der Menüpunkte insgesamt und damit innerhalb des jeweiligen Menüs.
// Zunächst wird nach Positionen sortiert, wobei die niedrigste Zahl als erstes unter dem Menüpunkt "Server-Konsole" angezeigt wird. Erst alle einzelnen Befehle, anschließend die immer vorhandene Menügruppe "opsi" und weitere (nach der Position geordnete) Menügruppen. Es lässt sich somit nur eine Ebene von Menügruppen unter der "Server-Konsole" erstellen.  +
Ist eine alphabetische Reihenfolge erwünscht, müssen alle Positionen identisch gesetzt sein (z.B. alle 0). Bleibt das Feld leer, wird standardmäßig die Position 0 vergeben.

* "sudo"-Rechte*: +
Wenn einer der Befehle in der Befehlsliste administrative Rechte benötigt, muss das Häkchen bei "Benötigt root-Rechte" gesetzt sein, dann werden die Befehle in der Liste automatisch um das Schlüsselwort "sudo" ergänzt.

* Befehlsliste: +
Bei der Befehlsliste müssen die Linux-Befehle zeilenweise eingetragen werden, damit sie sequentiell ausgeführt werden können.
Achtung: Der Befehl kann mittels Button direkt auf dem verbundenen SSH-Server getestet / ausgeführt werden, ohne ihn als Menüpunkt zu erstellen.

* Datenquellen* (für die Befehlsliste): +
Zusätzlich können Methoden als Datenquelle hinterlegt werden, d.h. vor Ausführung des Befehls werden Parameter mit dem Ergebnis einer Methode überschrieben. folgende Methoden sind möglich:
    - Interaktive Eingabe: +
    Es ist möglich, für die Befehle Parameter nicht fest vorzugeben, sondern für eine interaktive Eingabe zu kennzeichnen. Dies geschieht in der Form $$"<<<Dieser Text wird dem Benutzer angezeigt und durch die Benutzereingabe ersetzt>>>"$$ , wobei empfohlen wird, eine Beispieleingabe für den Parameter zum Benutzertext hinzuzuschreiben.
    - Ausgewählte Client-Namen / Ausgewählte Client-IP-Adressen
    - Ausgewählte Depot-Namen / Ausgewählte Depot-IP-Adressen
    - Configserver-Name
    - Verbundener SSH-Servername +
Hinweis: Außer für die "Interaktive Eingabe" kann die Rückgabe der Methoden formatiert werden, beispielsweise in eine kommaseparierte Liste.
In der Oberfläche kann die Datenquelle sowohl getestet, als auch an die im Feld der Befehlsliste markierten Stelle eingefügt werden.

._opsi-configed_: Befehl ausführen - Parameterabfrage
image::configed_serverkonsole-exec.png["opsi-configed: Befehl ausführen - Parameterabfrage", pdfwidth=90%]

TIP: -- Unter Linux lassen sich Befehle mithilfe von zwei kaufmännischen Unds ("&&") kombinieren. Dabei muss jedoch darauf geachtet werden, dass zum zweiten Befehl, falls benötigt ein sudo ergänzt wird, da dies nicht automatisch geschieht. Beispiel: Benötigt root-Rechte:"aktiviert" , Befehlsliste: "apt-get update --yes && sudo apt-get upgrade --yes". +
 -- Während der Ausführung lassen sich keine Benutzereingaben tätigen. Es ist notwendig, alle Eingaben über die Befehls\-parameter zu steuern (Beispiel: "--yes" -Option bei "apt-get upgrade")
