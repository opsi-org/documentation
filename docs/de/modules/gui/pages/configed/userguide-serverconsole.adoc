////
; Copyright (c) uib GmbH (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: https://www.opsi.org/credits/
////

:Author:    uib GmbH
:Email:     info@uib.de
:Date:      13.11.2023
:Revision:  4.3
:toclevels: 6
:doctype:   book
:icons:     font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]

[[opsi-manual-configed-serverconsole]]
= Server-Konsole

Über den Menüeintrag _Server-Konsole_ können Sie aus dem `opsi-configed` heraus über eine SSH-Verbindung Aktionen auf dem opsi-Server auslösen. Klicken Sie auf den Eintrag, sehen Sie an erster Stelle, ob Sie bereits per SSH mit dem Server verbunden sind (Checkbox _SSH-Verbindung direkt starten_ im Logindialog). Darunter finden Sie Einträge, um die SSH-Verbindungsdaten zu ändern und die vordefinierten Kommandozeilenbefehle zu bearbeiten, die der Menüpunkt _opsi_ anzeigt. Fahren Sie mit dem Mauszeiger über einen Eintrag, um einen Tooltip einzublenden.

.*opsi-configed*: das Menü Server-Konsole
image::configed_serverkonsole.png["opsi-configed: Server-Konsole", width=800, pdfwidth=80%]

[[opsi-manual-configed-serverconsole-ssh]]
== SSH-Verbindungsdaten

Wenn nicht anderes konfiguriert ist, wird versucht, für die SSH-Verbindung den im configed angemeldeten User und den verbundenen Configserver zu verwenden.

Ist dies nicht erwünscht, kann die Verbindung über einen SSH-Schlüssel (ggf. mit Passphrase) beim Start des Configeds gestartet werden.
Zu diesem Zweck existieren die folgenden Aufrufparameter für den configed:

* --ssh-key PATH:  z.B. --ssh-key /home/user/.ssh/id_rsa
* --ssh-passphrase PASSPHRASE: z.B. --ssh-passphrase meinpassword

Die Einstellungen lassen sich unter dem Menüpunkt  "Verbindungsdaten" ändern. +

[[opsi-manual-configed-serverconsole-permissions]]
== Berechtigungen

Über Server-Hostparameter (User-Abschnitt) kann feingranular gesteuert werden,
welche der Menüpunkte sichtbar sind bzw. genutzt werden können.
Bei aktivierter Userroles-Funktionalität (vgl. <<opsi-manual-configed-hostproperties-userroles>>)
werden die Konfigurationen userspezifisch verwendet. Für einen neu angelegten User werden dabei
als Default-Werte zunächst die Werte von der allgemeinen User-Ebene gesetzt.

Folgende Configs existieren:

* user.{}.ssh.serverconfiguration.active: +
Aktiviert das Menü der SSH-Verbindungseinstellungen . (Default: false)

* user.{}.ssh.commandmanagement.active: +
Aktiviert die Bearbeitung von Menüeinträgen der SSH-konsolen-Befehle (Default: false)

* user.{}.ssh.menu_serverconsole.active: +
Gibt den Hauptmenüeintrag "Server-Konsole" als solchen frei. (Default: true)

* user.{}.ssh.terminal.active: +
Schaltet die SSH-Shell frei. (Default: true)

* user.{}.ssh.commands.active: +
Schaltet alle SSH-Menüeinträge frei, die hinterlegte Befehle darstellen. (Default: true)

[[opsi-manual-configed-serveractions-parametercommands]]
== Vordefinierte Befehle

Im Menü _Server-Konsole_ / _opsi_ stehen vordefinierte Kommandozeilenbefehle bereit, die folgende Aktionen ausführen:

* _Package-Updater_: Installieren oder aktualisieren Sie Pakete mit dem `opsi-package-updater` (siehe Abschnitt xref:server:components/commandline.adoc#server-components-opsi-package-updater[]*opsi-package-updater*); im sich öffnenden Dialog wählen Sie aus dem Drop-down-Menü _Aktion_ entweder den Eintrag _Pakete aktualisieren_ ,  _Alle Repositorys auflisten_ oder _Pakete installieren_.

* _Paket-Installation_: Installieren Sie opsi-Pakete mit dem `opsi-package-manager` (siehe Abschnitt xref:server:components/commandline.adoc#server-components-opsi-package-manager[*opsi-package-manager*]) auf allen oder einzelnen Depots. Sie können den Pfad zum Paket angeben oder ein Paket aus dem Internet herunterladen.

* _Paket-Deinstallation_: Wählen Sie aus einer Liste eines oder mehrere Pakete zur Deinstallation mit dem `opsi-package-manager` aus.

* _opsi-Paket packen_: Geben Sie ein Verzeichnis auf dem Server an, in dem Dateien für ein opsi-Paket liegen. Über eine Schaltfläche können Sie die in der `control`-Datei gefundenen Versionen (Paket- und Produkt-Version) anzeigen und ggf. überschreiben. Über einen Klick auf _Erweiterte Optionen_ blenden Sie Checkboxen ein, über die Sie Zsync- oder Md5-Dateien erstellen sowie die Rechte im Anschluss setzen. Die Schaltfläche _Das neu erstellte Paket installieren_ ruft den `opsi-package-manager` auf.

* _Datei-Download_: Laden Sie eine beliebige Datei aus dem Internet mit `wget` herunter und legen diese auf dem Server im Verzeichnis Ihrer Wahl ab.

* _Modules-Datei hochladen_: Laden Sie eine Freischaltdatei für opsi-Erweiterungen zum Server hoch. Diese wählen Sie entweder auf dem lokalen Rechner aus oder laden Sie mit `wget` aus dem Internet herunter. Optional können Sie Zugangsdaten für den `wget`-Befehl eingeben.

* _opsi-Rechte setzen_: Korrigiert die Zugriffsrechte von Dateien und Verzeichnissen auf einem opsi-Server und ruft dazu das Kommando xref:server:components/commandline.adoc#server-components-opsi-set-rights[*opsi-set-rights*] auf.

* _opsi-Client-Agent verteilen_: Um existierende Rechner als Clients in die opsi-Umgebung aufzunehmen, muss auf diesen der Client-Agent installiert werden. Wählen Sie hier die gewünschten Rechner aus; um den Befehl auf mehreren Clients gleichzeitig auszuführen, müssen die Logindaten auf diesen gleich sein.

NOTE: Das Skript zum Deployen der Clients muss im Verzeichnis `/var/lib/opsi/depot/opsi-client-agent` liegen und `opsi-deploy-client-agent` heißen (siehe Kapitel xref:first-steps:clients/client-installation.adoc[Clients hinzufügen]).

Einige Dialoge (z.{nbsp}B. _opsi-Rechte setzen_ oder _Paket-Installation_) haben Buttons zur Auswahl von lokalen Dateien. Betätigen Sie die Schaltfläche _Ermittle Unterverzeichnisse_, um alle Verzeichnisse und Dateien aus dem angegebenen Pfad aufzulisten. Um weitere Ebenen mit einzubeziehen, klicken Sie den Button mehrfach.

[[opsi-manual-configed-serverconsole-commandcontrol]]
== Befehle definieren
Zusätzlich zu den vordefinierten Befehlen lassen sich eigene Serverkonsolenbefehle erstellen
bzw. verändern oder entfernen, die über Menüpunkte aufgerufen werden können.
Dabei ist zu beachten, dass unterschiedliche Linux-Systeme unter Umständen nicht die gleichen Kommandozeilenbefehle ausführen können. Deswegen muss der Administrator sicherstellen, dass die Befehle entsprechend dem adressierten Linux-System funktionieren.


._opsi-configed_: Befehle definieren
image::configed_serverkonsole-defcommands.png["opsi-configed: Befehle definieren", pdfwidth=90%]

Folgende Daten müssen bzw. können (gekennzeichnet durch ein "*") für einen Befehl angegeben werden:

* Menü-Text: +
Beim Erstellen eines Befehls _muss_ darauf geachtet werden, dass der Menütext noch nicht für einen anderen Befehl verwendet wurde. Wenn ein Menütext geändert werden soll, muss der Befehl mit dem Minus-Button gelöscht und ein neuer Befehl erstellt werden.

* Beschreibung*: +
Wird eine genauere Beschreibung hinterlegt, taucht diese als Tooltip-Text des Befehls auf.

* übergeordnetes Menü*: +
Legt fest, in welchem Menü der neue Befehl als Menüeintrag erscheinen soll. Bleibt das Feld leer, wird der Menüeintrag direkt dem Menü "Server-Konsole" zugeordnet.

* Position*: +
Die Position bestimmt die Reihenfolge (kleine Zahlen zuerst) der Menüpunkte insgesamt und damit innerhalb des jeweiligen Menüs.
// Zunächst wird nach Positionen sortiert, wobei die niedrigste Zahl als erstes unter dem Menüpunkt "Server-Konsole" angezeigt wird. Erst alle einzelnen Befehle, anschließend die immer vorhandene Menügruppe "opsi" und weitere (nach der Position geordnete) Menügruppen. Es lässt sich somit nur eine Ebene von Menügruppen unter der "Server-Konsole" erstellen.  +
Ist eine alphabetische Reihenfolge erwünscht, müssen alle Positionen identisch gesetzt sein (z.B. alle 0). Bleibt das Feld leer, wird standardmäßig die Position 0 vergeben.

* "sudo"-Rechte*: +
Wenn einer der Befehle in der Befehlsliste administrative Rechte benötigt, muss das Häkchen bei "Benötigt root-Rechte" gesetzt sein, dann werden die Befehle in der Liste automatisch um das Schlüsselwort "sudo" ergänzt.

* Befehlsliste: +
Bei der Befehlsliste müssen die Linux-Befehle zeilenweise eingetragen werden, damit sie sequentiell ausgeführt werden können.
Achtung: Der Befehl kann mittels Button direkt auf dem verbundenen SSH-Server getestet / ausgeführt werden, ohne ihn als Menüpunkt zu erstellen.

* Datenquellen* (für die Befehlsliste): +
Zusätzlich können Methoden als Datenquelle hinterlegt werden, d.h. vor Ausführung des Befehls werden Parameter mit dem Ergebnis einer Methode überschrieben. folgende Methoden sind möglich:
    - Interaktive Eingabe: +
    Es ist möglich, für die Befehle Parameter nicht fest vorzugeben, sondern für eine interaktive Eingabe zu kennzeichnen. Dies geschieht in der Form $$"<<<Dieser Text wird dem Benutzer angezeigt und durch die Benutzereingabe ersetzt>>>"$$ , wobei empfohlen wird, eine Beispieleingabe für den Parameter zum Benutzertext hinzuzuschreiben.
    - Ausgewählte Client-Namen / Ausgewählte Client-IP-Adressen
    - Ausgewählte Depot-Namen / Ausgewählte Depot-IP-Adressen
    - Configserver-Name
    - Verbundener SSH-Servername +
Hinweis: Außer für die "Interaktive Eingabe" kann die Rückgabe der Methoden formatiert werden, beispielsweise in eine kommaseparierte Liste.
In der Oberfläche kann die Datenquelle sowohl getestet, als auch an die im Feld der Befehlsliste markierten Stelle eingefügt werden.

._opsi-configed_: Befehl ausführen - Parameterabfrage
image::configed_serverkonsole-exec.png["opsi-configed: Befehl ausführen - Parameterabfrage", pdfwidth=90%]

TIP: -- Unter Linux lassen sich Befehle mithilfe von zwei kaufmännischen Unds ("&&") kombinieren. Dabei muss jedoch darauf geachtet werden, dass zum zweiten Befehl, falls benötigt ein sudo ergänzt wird, da dies nicht automatisch geschieht. Beispiel: Benötigt root-Rechte:"aktiviert" , Befehlsliste: "apt-get update --yes && sudo apt-get upgrade --yes". +
 -- Während der Ausführung lassen sich keine Benutzereingaben tätigen. Es ist notwendig, alle Eingaben über die Befehls\-parameter zu steuern (Beispiel: "--yes" -Option bei "apt-get upgrade")
