////
; Copyright (c) uib GmbH (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: https://www.opsi.org/credits/
////

:Author:    uib GmbH
:Email:     info@uib.de
:Date:      06.11.2023
:Revision:  4.3
:toclevels: 6
:doctype:   book
:icons:     font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]


[[server-components-authorization]]
= Authorizations

This chapter deals with user and group administration on the opsi server. It explains which accounts and groups have administrative rights by default and how to create your own accounts for managing the opsi server. The chapter also explains how to integrate an opsi server into a Windows domain, how to use a directory service for authentication and how to set up two-factor authentication for the server.

[[server-components-authorization-users-and-groups]]
== Users and groups

opsi uses the following user and group accounts:

* `opsiconfd`: an account for the system service of the same name `opsiconfd` (see chapter xref:server:components/opsiconfd.adoc[The service *opsiconfd*]); account must be a member of the groups `opsiadmin` and `opsifileadmins`
* `pcpatch`: an account that the opsi clients use to access the opsi depot via CIFS (Samba); must be a member of the `opsifileadmins` group (see section <<server-components-authorization-pcpatch-password>>)

NOTE: To manage local users and groups on the opsi server, use the standard Linux tools `useradd`, `usermod`, `groupadd`, `groupmod` etc. (see section <<server-components-authorization-create-local-users>>). Alternatively, bind the opsi config server to an existing Windows domain (see section <<server-components-authorization-domain-join>>) or to LDAP/Active Directory (see section <<server-components-authorization-ldap-authentication>>).

opsi uses the following groups to control authorizations:

* `opsiadmin`: Members of this group can administratively access the opsi service, i.e. they get full access via the management interface `opsi-configed`, the opsi WebGUI, the `opsiconfd` admin page etc.
* `opsifileadmins`: Members of this group can administratively access opsi files (depot, repository, workbench).
* `opsireadonly`: Members of this group have read-only access to the opsi service.

You can change the name of these groups in the configuration file `/etc/opsi/opsi.conf` in the `groups` section:

// cSpell:disable
[source,toml]
----
[groups]
fileadmingroup = "opsifileadmins"
admingroup = "opsiadmin"
readonly = "opsireadonlys"
----
// cSpell:enable

[[server-components-authorization-pcpatch-password]]
=== Password for user *pcpatch*

As the opsi clients use this account for authentication, the opsi config server must know the password. For this purpose, the password is stored in encrypted form in the file `/etc/opsi/passwd`. When an opsi config server is installed, a random password is automatically set, which you do not usually need to change.

You can change the password with the command line tool `opsi-admin` (see section xref:server:components/commandline.adoc#server-components-opsi-admin[*opsi-admin*]):

[source,console]
----
opsi-admin task setPcpatchPassword
----

After pressing the [Enter] button, a password prompt appears and you can type in the password.

NOTE: The password is also changed for the local Unix and Samba account. If it is a domain account, you must also reset the new password there manually.

[[server-components-authorization-create-local-users]]
=== Create admin account

To create local users and groups on the opsi config server, use the standard Linux tools. The following example sets up a new user called `adminuser` and then adds this user to the two groups `opsiadmin` and `opsifileadmins`. This gives the user full administrative access to the opsi server.

NOTE: The `adminuser` account already exists in the preconfigured virtual machine and in our Docker container. However, you can use the steps shown here to add additional accounts.

First create the new account using the `useradd` command:

[source,console]
----
sudo useradd -m -s /bin/bash adminuser
----

Then set a Unix password (system) for the new account:

[source,console]
----
sudo passwd adminuser
----

If the user is also to have file access via CIFS (Samba), set a password for this as well:

[source,console]
----
sudo smbpasswd -a adminuser
----

WARNING: Do not use the *ยง* character in passwords!

Next, add the new user to the `opsiadmin` and `opsifileadmins` groups:

[source,console]
----
usermod -aG opsiadmin adminuser opsifileadmins
----

Enter the command `id` to check that the account `adminuser` exists and belongs to both groups:

[source,console]
----
id adminuser
# uid=1000(adminuser) gid=1000(opsiadmin) groups=1000(opsiadmin),999(opsifileadmins)
----

[[server-components-authorization-domain-join]]
== Include opsi server in Windows domain

Instead of working with local Unix and Samba accounts, you can also integrate an opsi server into a Windows or Samba 4 domain. To do this, create the two groups `opsiadmin` and `opsifileadmins` in the domain.

TIP: If you want to name the groups differently or use existing groups, change the names accordingly in the configuration file `/etc/opsi/opsi.conf`.

In addition, create the user `pcpatch` as a member of the group `opsifileadmins` and the user `opsiconfd` as a member of the groups `opsiadmin` and `opsifileadmins`.

Then remove the two groups `opsiadmin` and `opsifileadmins` from the local Unix groups (command `groupdel`) and the local Unix accounts `opsiconfd` and `pcpatch` (command `userdel`).

Then add the opsi server to the Windows domain. Refer to the documentation of the Linux distribution used to find out which steps are required in each case.

After the domain join, execute the following two commands:

[source,console]
----
opsiconfd setup
opsi-set-rights
----

NOTE: For more information on the two commands, see the two sections xref:server:components/opsiconfd.adoc#server-components-opsiconfd-setup[*opsiconfd setup*] and xref:server:components/commandline.adoc#server-components-opsi-set-rights[*opsi-set-rights*].

Finally, reset the password for the user `pcpatch` (see section <<server-components-authorization-pcpatch-password>>).

[[server-components-authorization-ldap-authentication]]
== Authentication against directory service

By default, opsi uses PAM (Pluggable Authentication Modules) for authentication for various services and applications. This works with local users and groups, but also if the opsi server is integrated into a domain. Alternatively, you can also use directory services such as LDAP (Lightweight Directory Access Protocol) or AD (Active Directory). In this case, the directory service stores user accounts, groups and other identity information in a central location and enables the authentication and authorization of users via various services and applications.

NOTE: Samba authentication is independent of this. The approach presented in this section is therefore mainly suitable for opsi environments in which the administrators do not access the opsi shares via Samba, but via WebDAV. This is always the case when operating an opsi server under Docker.

TIP: To use an LDAP server or an Active Directory instead of PAM for authentication, the xref:opsi-modules:modules.adoc[opsi extension] *opsi directory connector* is required.

=== Configuration

The configuration takes place via the file `/etc/opsi/opsi.conf` in the section `[ldap_auth]`. Regardless of whether you connect opsi to AD/Samba 4 or LDAP, in both cases you define the address of the directory service behind `ldap_url`. The URL has the following structure:

[source,toml]
----
ldap[s]://<Adresse-des-LDAP-Servers>[:port]/<base-dn>
----

You can also define the user name for authentication on the LDAP/AD after the `username` option; the placeholders `\{username\}` and `\{base\}` are permitted. Normally the specification of `ldap_url` is sufficient.

Example for connecting to an Active Directory or Samba 4:

[source,toml]
----
[ldap_auth]
ldap_url = "ldaps://ad.company.de/dc=ad,dc=company,dc=de"
----

Example for connecting to an OpenLDAP service:

[source,toml]
----
[ldap_auth]
ldap_url = "ldaps://ldap.company.org:636/dc=company,dc=org"
username = "uid={username},dc=Users,{base}"
----

After you have saved the changes in the configuration file, restart the xref:server:components/opsiconfd.adoc[*opsiconfd*] service.

NOTE: Please note that the group defined behind `admingroup` in the file `/etc/opsi/opsi.conf` must also exist in the directory service.

[[server-components-authorization-multi-factor]]
== Two-factor authentication

The opsi server supports two-factor authentication and uses the TOTP algorithm for this purpose. Time-based One-time Password is a standard procedure for two-factor authentication (2FA) in which a one-time password is generated. This consists of six digits and is also required to log in to the opsi server.

NOTE: To set up two-factor authentication, you need the xref:opsi-modules:modules.adoc[opsi extension] WAN/VPN.

=== General setup
// cSpell:ignore multi-factor-auth, inactive, totp_optional, totp_mandatory

To activate two-factor authentication, configure the `opsiconfd` service accordingly (see section xref:server:components/opsiconfd.adoc#server-components-opsiconfd-config[Configuration]). Customize the configuration file `/etc/opsi/opsiconfd.conf` and define one of the following values after the `multi-factor-auth` option:

* `inactive`: Two-factor authentication is inactive (default). This also applies to users with configured TOTP.
* `totp_optional`: Two-factor authentication via TOTP is optional. Users with TOTP enabled must use it.
* `totp_mandatory`: TOTP is mandatory. Users without TOTP enabled will no longer be able to log in.

NOTE: After you have added your changes, call the command `opsiconfd reload`.
 
=== User-specific setup

The setup is carried out via the _Users_ tab of the xref:server:components/opsiconfd.adoc#server-components-opsiconfd-admin-page[opsiconfd admin page]. Click on the button _Generate new secret and activate TOTP_ to generate a secret on the server side and activate two-factor authentication for the respective user. 

You can then scan the displayed QR code with an app such as *2FA Authenticator (2FAS)* (Android and iOS). The app then generates a new one-time password every 30 seconds, which the user must then append to the normal password during authentication.

You can set up two-factor authentication on the _Users_ tab.

image::opsiconfd/opsiconfd-admin-users.png["You can set up two-factor authentication on the _Users_ tab.", pdfwidth=80%]

NOTE: If you click on the button _Generate new secret and activate TOTP_ again, you will generate a new secret. The user's previous QR code will no longer be valid.

To deactivate two-factor authentication for an account, click on _Deactivate MFA_.
