////
; Copyright (c) uib GmbH (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: https://www.opsi.org/credits/
////

:Author:    uib GmbH
:Email:     info@uib.de
:Date:      07.11.2023
:Revision:  4.3
:toclevels: 6
:doctype:   book
:icons:     font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]

[[server-components-opsiconfd]]
= *opsiconfd* service

The central service on every opsi server is the `opsiconfd`. It provides various services via HTTPS (port 4447):

* */rpc*: JSON-RPC-API
* */dav*: WebDAV access to workbench, repository, depot, boot directory
* */admin*: xref:server:components/opsiconfd.adoc#server-components-opsiconfd-admin-page[admin-page] for status information and administration tasks
* */grafana*: Reverse proxy access to a local Grafana server (see chapter xref:server:components/grafana.adoc[Grafana])
* */status*: simple status output for monitoring tools
* */public*: public file share without authentication

NOTE: You can extend the `opsiconfd` via addons. For example, the opsi WebGUI is such an addon. You can read more about this in section <<server-components-opsiconfd-admin-page-addons>>.

[[server-components-opsiconfd-cli]]
== Command Line Interface

The `opsiconfd` has a command line interface that provides the following commands:

* `start`: Starts the `opsiconfd` (default command).
* `stop`: Stops a running `opsiconfd`.
* `force-stop`: Like `stop`, additionally terminates active client connections.
* `status`: Displays the service status (same output as `systemctl status`).
* `restart`: Restarts the `opsiconfd` service (`systemctl restart`).
* `reload`: Sends a `SIGHUP` signal to running `opsiconfd` (worker) processes. The processes then reload the configuration files.
//TODO: Check links at the end
* `setup`: Starts a <<server-components-opsiconfd-setup>>.
* `log-viewer`: Displays the `opsiconfd` logs (see section <<server-components-opsiconfd-logs>>) in the terminal.
* `health-check`: Starts a <<server-components-opsiconfd-health-check>>.
* `backup`: Creates a backup (see section xref:server:components/backup.adoc#server-components-opsiconfd-backup[*opsiconfd backup/restore*]).
* `restore`: Restores a backup (see section xref:server:components/backup.adoc#server-components-opsiconfd-backup[*opsiconfd backup/restore*]).

[[server-components-opsiconfd-server-id-role]]
== Server role

An opsi server can take on the role of an opsi-Configserver or that of an opsi-Depotserver. The configuration file `/etc/opsi/opsi.conf` defines the role. As of opsi 4.3, this configuration file also defines the ID of the server.

.The configuration file `/etc/opsi/opsi.conf` defines, among other things, the server role.
image::opsi-conf.png["The configuration file `/etc/opsi/opsi.conf` defines, among other things, the server role.", width=788, pdfwidth=80%]

NOTE: If you run the opsi server as a Docker container, environment variables control the behavior (see section xref:server:installation/docker.adoc#server-installation-docker-compose[Docker Compose]).

Example of an opsi-Configserver:

[source,toml]
----
[host]
id = "opsi.domain.tld"
key = "5b4324721a114195098bdaf3fab54a9f"
server-role = "configserver"

[service]
url = "https://localhost:4447"
----

Example of an opsi-Depotserver:

[source,toml]
----
[host]
id = "opsi-depot.domain.tld"
key = "a1b5098fabcaf315b13249cba1a24d17"
server-role = "depotserver"

[service]
url = "https://opsi.domain.tld:4447"
----

NOTE: As of opsi 4.3, the file `/etc/opsi/opsi.conf` replaces the file `/etc/opsi/backends/jsonrpc.conf`.

[[server-components-opsiconfd-config]]
== Configuration

You can configure the `opsiconfd` via the file `/etc/opsi/opsiconfd.conf`, via environment variables or via command line parameters when calling it. The following sequence applies:

. Entries in the configuration file overwrite the default settings.
. Environment variables overwrite entries in the configuration file.
. Command line parameters overwrite environment variables.

TIP: You can obtain a list of all configuration options by entering the following command in a terminal window:

// cSpell:disable
[source,console]
----
opsiconfd --help
...
--admin-networks ADMIN_NETWORKS [ADMIN_NETWORKS ...]
                A list of network addresses from which administrative connections are allowed.
                [env var: OPSICONFD_ADMIN_NETWORKS]
                (default: ['0.0.0.0/0', '::/0'])
...
----
// cSpell:enable

The name of the command line parameter (e.g. `--admin-networks`) is followed by the corresponding environment variable in capital letters (here: `ADMIN_NETWORKS`). If you omit the two preceding hyphens `--`, you will receive the name of the option for the configuration file (`admin-networks`).

* The configuration file `/etc/opsi/opsiconfd.conf` contains e.g. {nbsp}B: 

[source,toml]
----
admin-networks = [10.1.1.0/24,192.168.1.0/24]
----

* This is how it is set up via the environment variable:

[source,console]
----
OPSICONFD_ADMIN_NETWORKS="[10.1.1.0/24,192.168.1.0/24]"
----

* The call on the command line looks like this:

[source,console]
----
opsiconfd --admin-networks 10.1.1.0/24 192.168.1.0/24
----

NOTE: You can usually apply changes to the configuration during operation using the `opsiconfd reload` command. However, some parameters require a restart via `opsiconfd restart`.

// cSpell:ignore hostcontrol
[[server-components-opsiconfd-host-control]]
== *hostcontrol.conf*

You can control opsi clients via the HostControl functionality. Since opsi 4.3 this is preferably done via the opsi message bus. However, the previous method still exists; in this case, the opsi config server establishes a connection to the client agent and executes commands via this connection. Packets can be sent in the network via Wake on LAN (WOL) in order to start clients if required.

The HostControl configuration can be found in the file `/etc/opsi/backends/hostcontrol.conf`. The following parameters are available here:

* `useMessagebus`: The parameter controls how the opsi message bus is used for HostControl. The following values are permitted:
  ** `False`: The opsi message bus is not used, i.e. a connection to the `opsi-client-agent` is established for each command.
  ** True: Only the opsi message bus is used. If a client is not connected to the opsi message bus, it is considered unreachable and the command is not executed. If all clients are configured to use the opsi message bus, this is the preferred setting.
  ** `hybrid` (default): The opsi message bus is used if the client has an active message bus connection. If not, a connection to the `opsi-client-agent` is established-
* `opsiclientdPort`: Network port for establishing a connection to an `opsi-client-agent`.
* `hostRpcTimeout`: Timeout in seconds for establishing a connection to an `opsi-client-agent`.
* `resolveHostAddress`: The parameter controls the name resolution:
  ** `True`: When establishing a connection from the opsi-configserver to the `opsi-client-agent`, the IP address of the opsi-client is preferably determined via name resolution.
  ** `False`: When establishing a connection, the IP address stored in the opsi backend is preferred.
* `maxConnections`: maximum number of simultaneous connections to client agents
* `broadcastAddresses`: WOL packets are sent to broadcast addresses; this parameter assigns network addresses to broadcast addresses. The assignment has the following form: +
`{ "<network-address>": { "<broadcast-address>": <port-list> } }` +

This example illustrates the configuration:

[source,toml]
----
"broadcastAddresses": {
                "0.0.0.0/0": {
                        "255.255.255.255": [7, 9, 12287]
                },
                "10.10.0.0/16": {
                        "10.10.1.255": [12287],
                        "10.10.2.255": [12287]
                },
                "10.10.3.0/24": {
                        "10.10.3.255": [12287]
                },
                "192.168.1.0/24": {
                        "192.168.1.255": [12287, 9, 12287]
                }
        }
----

Several broadcast addresses can be assigned to one network address. Different ports can be configured for each broadcast address. The appropriate broadcast addresses are determined based on the IP address of a client stored in the opsi backend. If the IP address is part of several networks, the most specific entry is used.

[[server-components-opsiconfd-setup]]
== *opsiconfd setup* command

include::server:partial$opsiconfd-setup.adoc[]

[[server-components-opsiconfd-admin-page]]
== Admin page

The `opsiconfd` admin page provides status information and administration tasks for `opsiconfd` in the web browser.
Access is via `\https://<opsi-server>:4447/admin`; users must be members of the opsi admin group (see chapter xref:server:components/authorization.adoc[Authorizations]). The following sections briefly introduce the individual tabs.

[[server-components-opsiconfd-admin-page-info]]
=== Info

Here you can see general information about `opsiconfd`, including the number of connected depot servers and clients, details of the opsi-CA and the server certificate.

In the lower half you can see the `opsiconfd` configuration; you can reload the configuration using the _Service reload_ button.

.You can also view the `opsiconfd` configuration on the _Info_ tab.
image::opsiconfd/opsiconfd-admin-info.png["You can also view the `opsiconfd` configuration on the _Info_ tab.", width=900, pdfwidth=80%]

[[server-components-opsiconfd-admin-page-maintenance]]
=== Maintenance

On this tab, you can set the `opsiconfd` to maintenance mode and end it again. There will be no client activity during this time. Click the button _Set application to 'maintenance' state_ to activate the maintenance mode. At the top you will see the message `"accomplished": true` and next to it IP addresses for which the maintenance mode does not apply -- these are usually the localhost IP 127.0.0.1 and the IP address of the opsi-Configserver. All access from other computers is then no longer possible; users see the message _Maintenance mode, please try again later_. 

TIP: In the field _Address exceptions (optional)_ you can enter further IP addresses from which you want to access the `opsiconfd` in maintenance mode. Separate multiple IPs with commas.

Use the button _Set application to 'normal' state_ to exit maintenance mode.

.The _Maintenance_ tab (de)activates maintenance mode and displays the current status.
image::opsiconfd/opsiconfd-admin-maintenance.png["The _Maintenance_ (en)tab activates maintenance mode and displays the current status.", width=900, pdfwidth=80%]

NOTE: By default, the opsi-Configserver switches to maintenance mode when you create a backup or restore a backup copy (see chapter xref:server:components/backup.adoc[Backup of the opsi server]).

[[server-components-opsiconfd-admin-page-users]]
=== Users

This is where you set up two-factor authentication for users on the opsi-Configserver. After you have adjusted the `opsiconfd` configuration accordingly and restarted the service, generate a one-time password using the _Generate new secret and activate TOTP_ button. It consists of six digits and is also required to log in to the opsi server (see section xref:server:components/authorization.adoc#server-components-authorization-multi-factor[two-factor authentication]).

.You can set up two-factor authentication on the _Users_ tab.
image::opsiconfd/opsiconfd-admin-users.png["You can set up two-factor authentication on the _Users_ tab.", width=900, pdfwidth=80%]

[[server-components-opsiconfd-admin-page-clients]]
=== Clients

The page displays information about connected clients and sessions. Blocked clients appear in the _Blocked clients_ list. You can unblock individual clients in the _Unblock clients_ area via their IP address and _Execute_; alternatively, you can unblock all blocked clients at once via _Unblock all clients_.

NOTE: Please note that clients in this case means (web) clients that access the admin page. Here you will not find any information about computers managed with opsi. The admin page blocks a client, for example, if there have been too many failed login attempts.

To delete all sessions of a client, enter its IP address in the _Delete client sessions_ field and confirm with _Execute_.

.On this tab, you will see a list of blocked clients and can release them again if necessary.
image::opsiconfd/opsiconfd-admin-blocked-clients.png["On this tab you can see a list of blocked clients and release them again if necessary.", width=900, pdfwidth=80%]

[[server-components-opsiconfd-admin-page-depots]]
=== Depots

You can add further depot servers to your opsi environment in the upper area of the tab. To do this, enter the depot ID (i.e. the FQDN of the opsi-Depotserver) and a description in the two fields. After clicking on _Create depot_ you should see the new depot in the table; here the field _Messagebus_ still shows _not connected_. To enable the config server and depot server to communicate with each other, execute the following command on the depot server:

[source,console]
----
opsiconfd setup --register-depot
----

NOTE: Please note that the command `opsi-setup --register-depot` is no longer available after the change from opsi 4.2 to 4.3 (see section xref:server:components/commandline.adoc#server-components-opsi-setup[*opsi-setup*]).

.Enter new opsi depots on this tab.
image::opsiconfd/opsiconfd-admin-depots-1.png["Enter new opsi depots on this tab.", width=900, pdfwidth=80%]

If there are locked products on a depot server, these will also appear on this tab in the _Locked Products_ area. Use the _Unlock_ button next to a product to remove the lock for this one product; _Unlock all_ removes the lock for all locked products.

.Are there any locked products? The _Depots_ tab shows these and provides a button to unlock them.
image::opsiconfd/opsiconfd-admin-depots-2.png["Are there locked products? The _Depots_ tab shows these and provides a button to unlock them.", width=900, pdfwidth=80%]

[[server-components-opsiconfd-admin-page-rpc-info]]
=== RPC-Infos

The table on this tab shows the last RPC calls. You can sort the display by clicking on the name of the table column.

.In this table you can see the last RPC calls.
image::opsiconfd/opsiconfd-admin-rpc-info.png["In this table you can see the last RPC calls.", width=900, pdfwidth=80%]

[[server-components-opsiconfd-admin-page-rpc-interface]]
=== RPC-Interface

This tab lists all available methods of the JSON-RPC-API. If you click on the _Show deprecated methods_ checkbox, deprecated methods will also appear in the drop-down menu. Select a method from the _Method_ drop-down menu. Depending on the method, you will see additional input fields, such as attributes, filters or available parameters. The fields expect a valid JSON encoding; the interface indicates any syntax errors.

Clicking on the _Execute_ button executes the method. The request, processing time and result appear below in JSON format.

.You can execute JSON-RPC-API methods via this tab.
image::opsiconfd/opsiconfd-admin-rpc-interface.png["You can execute JSON-RPC-API methods via this tab.", width=900, pdfwidth=80%]

[[server-components-opsiconfd-admin-page-redis-interface]]
=== Redis-Interface

Here you can display Redis status information, execute Redis commands and clear the cache. Click on _Info+_ to display detailed information on the Redis version, the operating system, the server architecture, etc.

The response at the bottom of the tab appears in JSON format.

Display information about Redis on this tab.
image::opsiconfd/opsiconfd-admin-redis-interface.png["Show information about Redis on this tab.", width=900, pdfwidth=80%]

NOTE: You can use the _Debug keys_ button to debug keys (i.e. the names of the various data structures stored in the database). This can be helpful for troubleshooting, performance monitoring or data analysis. Please note that accidentally deleting or overwriting a key can lead to data loss; if in doubt, create a backup beforehand (see chapter xref:server:components/backup.adoc[Backup of the opsi server]).

[[server-components-opsiconfd-admin-page-addons]]
=== Addons

On this tab you install `opsiconfd` extensions. First download these from our https://download.uib.de/[repositories] and save them on the opsi server. Then click on _Browse_ on the _Addons_ tab, navigate to the zip file in the file selection dialog, select it and then click on _Install addon_. 

In addition to the name and ID, you will also see the version number and the installation path on the server for the extensions already installed in the table.

.Install addons and display information about them.
image::opsiconfd/opsiconfd-admin-addons.png["Install addons and display information about them.", width=900, pdfwidth=80%]

[[server-components-opsiconfd-admin-page-logviewer]]
=== Log Viewer

The tab provides quick access to the `opsiconfd` log files (see section <<server-components-opsiconfd-logs>>). You can enlarge the display (_Maximize_ button), filter the logs by log level (_Filter by level_), context (_Filter by context_) and your own search terms (_Filter by message_). You can activate additional functions via checkboxes, such as the automatic collapsing of multi-line information into a single continuous line (_Collapse multi-line_) and automatic scrolling (_Auto scroll_). You can change the font size using the two buttons next to _Font size_.

.The admin page provides quick access to the `opsiconfd` log files.
image::opsiconfd/opsiconfd-admin-log-viewer.png["The admin page provides quick access to the `opsiconfd` log files.", width=900, pdfwidth=80%]

[[server-components-opsiconfd-admin-page-terminal]]
=== Terminal

Switch to this tab to open a terminal window on the opsi server. To do this, select an opsi server in your environment from the _Host_ drop-down menu (default setting: _Configserver_) and click on _Connect_. The terminal then starts in the browser; you are logged in as user `opsiconfd` and start in its home directory `/var/lib/opsi`. 

.Open a terminal on the opsi server via this tab.
image::opsiconfd/opsiconfd-admin-terminal.png["Open a terminal on the opsi server via this tab.", width=900, pdfwidth=80%]

Click on the _Maximize_ button to hide the menu at the top of the admin page and give the terminal more space. _Normalize_ takes you back to the old view. Alternatively, use _Fullscreen_ to switch to the full screen view, which you can exit by pressing [Esc]. You can use the plus and minus buttons next to _Font size_ to change the font size, and clicking on _Disconnect_ closes the terminal in the browser.

TIP: You can upload files by clicking or dragging and dropping. This is useful, for example, if you want to install a self-built opsi package (file extension `.opsi`). Proceed as follows:

. Open the terminal in the browser.
. Change to the directory with the packages: `cd /var/lib/opsi/repository`.
. Drag the package from the file manager into the browser terminal. (`ls -l` lists all files in the current directory for checking purposes).
. Install the package: `opsi-package-manager -i <package.opsi>` (see also section xref:server:components/commandline.adoc#server-components-opsi-package-manager[*opsi-package-manager*])

[[server-components-opsiconfd-admin-page-messagebus]]
=== Messagebus

On the tab, you can send and receive messages via the message bus (for testing and debugging purposes). The opsi server uses the message bus to send messages to other components (e.g. installation jobs, configuration changes or status queries from clients). 

To do this, select one of the templates from the drop-down menu next to the _Send_ button and fill it with the correct values in the upper field. Finally, click on _Send_. In the lower area of the tab you will see the sent message (left) and the response from the opsi message bus (right).

.Communicate with the opsi message bus via this tab.
image::opsiconfd/opsiconfd-admin-messagebus.png["Communicate with the opsi message bus via this tab.", width=900, pdfwidth=80%]

[[server-components-opsiconfd-admin-page-licensing]]
=== Licensing

On the _Licensing_ tab, you can see which xref:opsi-modules:modules.adoc[opsi extensions] are licensed. The first table shows information about the licensee (name, active and non-active clients, etc.), below you can see a detailed list of the opsi modules, when a license was issued, how long it is still valid, etc. Scroll to the bottom of the tab to import new licenses in the new format (extension `.opsilic`). These are saved on the opsi server in the `/etc/opsi/licenses` directory. 

.Information on licenses for the extensions can be found on this tab.
image::opsiconfd/opsiconfd-admin-licensing.png["Information about licenses for the extensions can be found on this tab.",width=600, pdfwidth=80%]

NOTE: Earlier opsi versions used the file `/etc/opsi/modules` for activation. It remains valid, but we only issue new licenses in the new format. Please contact mailto:sales@uib.de[sales@uib.de] to obtain a license file in the new format.

[[server-components-opsiconfd-admin-page-grafana]]
=== Grafana

The _Grafana_ tab redirects you to xref:server:components/grafana.adoc[Grafana dashboard]. As soon as you click on the tab, the _opsiconfd main dashboard_ is created or updated on the Grafana server. In addition, the user `opsidashboard` is created, which is used to access the dashboard.

[[server-components-opsiconfd-health-check]]
== Health-Check

The `opsiconfd` provides a health check that can check various settings and versions of opsi components and thus provide information on possible problems. You can start the health check in different ways. All variants obtain their data from the API call `service_healthCheck`. The opsi API returns the data in JSON format. Such a JSON file is particularly useful for support requests.

One way to start a health check is via the admin page, _RPC interface_ tab (see section <<server-components-opsiconfd-admin-page-rpc-interface>>). On the command line, call the command `opsiconfd health-check`. Use the `--help` parameter to display online help; `opsiconfd health-check --manual` displays a description of all checks. Without further options, the check runs once and writes its results to Stdout.

.You can start the health check in the terminal.
image::opsi-health-check.png["You can start the health check in the terminal.", pdfwidth=80%]

TIP: Alternatively, you can also start the Health Check with the command line tool `opsi-cli` (see section xref:server:components/commandline.adoc#server-components-opsi-cli-commands-support[*opsi-cli support*]). The admin page provides quick access to a terminal on the opsi server via the _Terminal_ tab (see section <<server-components-opsiconfd-admin-page-terminal>>).

[[server-components-opsiconfd-logs]]
== Logfiles

// cSpell:ignore log-viewer
The `opsiconfd` uses Redis to write the log files (see chapter xref:server:components/redis.adoc[Redis]). In addition, the `opsiconfd` stores its own log files in the directory `/var/log/opsi/opsiconfd`.

NOTE: If there are problems accessing Redis, no logging takes place. To generate log files anyway, you can set the `log-mode` parameter to `local`.

opsi distinguishes between 10 different log levels:

* *0 - nothing*: Logging completely deactivated
* *1 - essential*: very important messages
* *2 - critical*: critical errors
* *3 - error*: Error
* *4 - warning*: Warnings
* *5 - notice*: important information
* *6 - info*: further information
* *7 - debug*: Messages for troubleshooting
* *8 - trace*: lots of details, e.g. recording of communication
* *9 - secret*: confidential information

The following parameters control the log level:

* *log-level*: general log level (up to which log level messages are transferred to the Redis stream)
* *log-level-stderr*: Level of the output on the terminal (Stderr)
* *log-level-file*: Log level of the log files

Use the command `opsiconfd log-viewer` to view the logs in the terminal:

[source,console]
----
opsiconfd log-viewer -l 6 --log-filter="client_address=192.168.1.1"
----

As the call reads the log stream directly from Redis, the maximum output is up to the 'log level'.

Alternatively, you can view the log files on the _Log Viewer_ tab in the admin interface (see section <<server-components-opsiconfd-admin-page-logviewer>>).

=== Filter

The `opsiconfd` divides the log files into channels and contexts. You can therefore filter the messages to obtain only certain information. You set the log level for a channel with the `log-levels` parameter. Only warnings are logged via `.*:4,opsiconfd\.headers:8`, but messages in the `opsiconfd.headers` channel are logged with the log level `trace`.

The `log-filter` parameter filters for contexts. The context `client_address` is mainly used for the `opsiconfd`. For example, you can use `client_address=192.168.1.1,192.168.1.2` to specify that you only see messages that are related to the two clients with the IP 192.168.1.1 and 192.168.1.2.

