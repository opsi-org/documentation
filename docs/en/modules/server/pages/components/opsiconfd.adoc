////
; Copyright (c) uib GmbH (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: https://www.opsi.org/credits/
////

:Author:    uib GmbH
:Email:     info@uib.de
:Date:      21.12.2023
:Revision:  4.3
:toclevels: 6
:doctype:   book
:icons:     font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]

[[server-components-opsiconfd]]
= *opsiconfd* Service

The `opsiconfd` is the core service on every opsi server, offering various services over HTTPS (port 4447):

* */rpc*: The JSON-RPC API.
* */dav*: WebDAV access for the workbench, repository, depot, and boot directory.
* */admin*: The xref:server:components/opsiconfd.adoc#server-components-opsiconfd-admin-page[Admin Page] for status information and administrative tasks.
* */grafana*: Reverse proxy access to a local Grafana server (refer to chapter xref:server:components/grafana.adoc[Grafana]).
* */status*: Provides a simple status output for monitoring tools.
* */public*: A public file share that doesn't require authentication.

NOTE: You can expand `opsiconfd` with addons. The opsi WebGUI, for instance, is one such addon. More details can be found in the section <<server-components-opsiconfd-admin-page-addons>>.

[[server-components-opsiconfd-cli]]
== Command Line Interface

The `opsiconfd` has a command line interface that provides the following commands:

* `start`: Starts the `opsiconfd` (default command).
* `stop`: Stops a running `opsiconfd`.
* `force-stop`: Like `stop`, additionally terminates active client connections.
* `status`: Displays the service status (same output as `systemctl status`).
* `restart`: Restarts the `opsiconfd` service (`systemctl restart`).
* `reload`: Sends a `SIGHUP` signal to running `opsiconfd` (worker) processes. The processes then reload the configuration files.
//TODO: Check links at the end
* `setup`: Starts a <<server-components-opsiconfd-setup>>.
* `log-viewer`: Displays the `opsiconfd` logs (see section <<server-components-opsiconfd-logs>>) in the terminal.
* `health-check`: Starts a <<server-components-opsiconfd-health-check>>.
* `backup`: Creates a backup (see section xref:server:components/backup.adoc#server-components-opsiconfd-backup[*opsiconfd backup/restore*]).
* `restore`: Restores a backup (see section xref:server:components/backup.adoc#server-components-opsiconfd-backup[*opsiconfd backup/restore*]).

[[server-components-opsiconfd-server-id-role]]
== Server Role

An opsi server can serve as either an opsi config server or an opsi depot server. This role is determined by settings in the configuration file `/etc/opsi/opsi.conf`. Starting from opsi version 4.3, this configuration file also specifies the server's ID.

.The Server Role is defined in the */etc/opsi/opsi.conf* Configuration File.
image::opsi-conf.png["The Server Role is defined in the */etc/opsi/opsi.conf* Configuration File.", pdfwidth=80%]

NOTE: When operating the opsi server as a Docker container, environment variables determine its behavior. For more information, refer to the section xref:server:installation/docker.adoc#server-installation-docker-compose[Docker Compose].

Here is an example configuration for an opsi config server:

[source,toml]
----
[host]
id = "opsi.domain.tld"
key = "5b4324721a114195098bdaf3fab54a9f"
server-role = "configserver"

[service]
url = "https://localhost:4447"
----

Example configuration for an opsi depot server:

[source,toml]
----
[host]
id = "opsi-depot.domain.tld"
key = "a1b5098fabcaf315b13249cba1a24d17"
server-role = "depotserver"

[service]
url = "https://opsi.domain.tld:4447"
----

NOTE: Starting with opsi 4.3, the file `/etc/opsi/opsi.conf` has replaced the previously used file `/etc/opsi/backends/jsonrpc.conf`.

[[server-components-opsiconfd-config]]
== Configuration

You can configure `opsiconfd` through the file `/etc/opsi/opsiconfd.conf`, via environment variables, or via command line parameters. The following precedence applies:

1. Entries in the configuration file override the default settings.
2. Environment variables override entries in the configuration file.
3. Command line parameters take precedence over environment variables.

TIP: To view a list of all available configuration options, enter the following command in a terminal window:

// cSpell:disable
[source,console]
----
opsiconfd --help
...
--admin-networks ADMIN_NETWORKS [ADMIN_NETWORKS ...]
                A list of network addresses from which administrative connections are allowed.
                [env var: OPSICONFD_ADMIN_NETWORKS]
                (default: ['0.0.0.0/0', '::/0'])
...
----
// cSpell:enable

When specifying a command line parameter (such as `--admin-networks`), the corresponding environment variable is named in capital letters (in this case, `ADMIN_NETWORKS`). If you exclude the two preceding hyphens `--`, the result is the name used for the option in the configuration file (`admin-networks`).

* For example, the configuration file `/etc/opsi/opsiconfd.conf` shows:

[source,toml]
----
admin-networks = [10.1.1.0/24,192.168.1.0/24]
----

* To set it up using the environment variable, follow this approach:

[source,console]
----
OPSICONFD_ADMIN_NETWORKS="[10.1.1.0/24,192.168.1.0/24]"
----

* To execute the command on the command line, use the following format:

[source,console]
----
opsiconfd --admin-networks 10.1.1.0/24 192.168.1.0/24
----

NOTE: Most configuration changes can be applied while the system is running by using the `opsiconfd reload` command. However, certain parameters may require a restart of the service, which can be done with `opsiconfd restart`.

// cSpell:ignore hostcontrol
[[server-components-opsiconfd-host-control]]
== The *hostcontrol.conf* File

You can manage opsi clients using the HostControl functionality. In opsi 4.3 and later versions, this is primarily done through the opsi message bus. However, the older method is still available, where the opsi config server connects directly to the client agent and executes commands over this connection. Wake on LAN (WOL) can be used to send packets in the network to power on clients if needed.

The configuration for HostControl is located in the file `/etc/opsi/backends/hostcontrol.conf`. The available parameters in this file include:

* `useMessagebus`: This parameter controls how the opsi message bus is used for HostControl. Allowed values are:
  ** `False`: The opsi message bus is not used. Instead, a direct connection to the `opsi-client-agent` is established for each command.
  ** `True`: HostControl operations solely rely on the opsi message bus. Clients not connected to the opsi message bus are deemed unreachable, and commands targeting these clients are not executed. This setting is preferred if all clients are configured to use the opsi message bus.
  ** `hybrid` (default): The opsi message bus is used for clients with an active message bus connection. If a client lacks such a connection, HostControl establishes a connection to the `opsi-client-agent`.
* `opsiclientdPort`: The network port used to connect to an `opsi-client-agent`.
* `hostRpcTimeout`: The time limit, in seconds, for establishing a connection to an `opsi-client-agent`.
* `resolveHostAddress`: This setting manages name resolution:
  ** `True`: Prefers name resolution to determine the IP address of the opsi-client when establishing a connection from the opsi config server to the `opsi-client-agent`.
  ** `False`: Favors using the IP address stored in the opsi backend when establishing a connection.
* `maxConnections`: The maximum number of concurrent connections to client agents.
* `broadcastAddresses`: This parameter defines network addresses for sending WOL (Wake on LAN) packets. It maps network addresses to broadcast addresses in the following format: +
  `{ "<network-address>": { "<broadcast-address>": <port-list> } }`

Here is an example to illustrate the configuration:

[source,toml]
----
"broadcastAddresses": {
                "0.0.0.0/0": {
                        "255.255.255.255": [7, 9, 12287]
                },
                "10.10.0.0/16": {
                        "10.10.1.255": [12287],
                        "10.10.2.255": [12287]
                },
                "10.10.3.0/24": {
                        "10.10.3.255": [12287]
                },
                "192.168.1.0/24": {
                        "192.168.1.255": [12287, 9, 12287]
                }
        }
----

Multiple broadcast addresses can be linked to a single network address. For each of these broadcast addresses, different ports can be set up. The suitable broadcast addresses are selected based on the client's IP address as recorded in the opsi backend. If the IP address falls within the range of several networks, the entry with the most specific match is used.

[[server-components-opsiconfd-setup]]
== The *opsiconfd setup* Command

include::server:partial$opsiconfd-setup.adoc[]

[[server-components-opsiconfd-admin-page]]
== Admin Page

The `opsiconfd` admin page, accessible in a web browser, offers status information and administrative tasks for `opsiconfd`. To access it, go to `\https://<opsi-server>:4447/admin`. It's important to note that users must be part of the opsi admin group to gain access (detailed in chapter xref:server:components/authorization.adoc[Authorizations]). The subsequent sections provide a brief overview of each individual tab available on the admin page.

[[server-components-opsiconfd-admin-page-info]]
=== Info

On the _Info_ tab, you can view general information about `opsiconfd`. This includes the number of connected depot servers and clients, as well as details about the opsi-CA and the server certificate.

In the lower section of this tab, the `opsiconfd` configuration is displayed. You have the option to reload this configuration using the _Service reload_ button.

.The Configuration of *opsiconfd* is accessible for Review on the *Info* Tab.
image::opsiconfd/opsiconfd-admin-info.png["The Configuration of *opsiconfd* is accessible for Review on the *Info* Tab.", width=800, pdfwidth=80%]

[[server-components-opsiconfd-admin-page-maintenance]]
=== Maintenance

On the _Maintenance_ tab, you can put `opsiconfd` into maintenance mode and later end it. During maintenance mode, client activities are paused. To activate maintenance mode, click on _Set application to 'maintenance' state_. Once activated, you will see the message `"accomplished": true` displayed at the top, along with IP addresses that are exempt from maintenance mode. Typically, these are the localhost IP 127.0.0.1 and the IP address of the opsi config server. Access from other computers is blocked during this time, and users attempting to connect will see a message stating _Maintenance mode, please try again later_.

TIP: If you wish to allow access from additional IP addresses during maintenance mode, you can specify them in the _Address exceptions (optional)_ field. If entering multiple IP addresses, separate them with commas.

To deactivate maintenance mode and resume normal operation, click on _Set application to 'normal' state_.

.The *Maintenance* Tab (de)activates Maintenance Mode and displays the Current Status.
image::opsiconfd/opsiconfd-admin-maintenance.png["The *Maintenance* Tab (de)activates Maintenance Mode and displays the Current Status.", width=800, pdfwidth=80%]

NOTE: By default, the opsi config server automatically enters maintenance mode when you create a backup or restore from a backup copy. This process is outlined in the chapter xref:server:components/backup.adoc[Backup of the opsi Server].

[[server-components-opsiconfd-admin-page-users]]
=== Users

On this tab, you manage the setup of two-factor authentication (2FA) for users on the opsi config server. Once you have appropriately configured `opsiconfd` and restarted the service, you can initiate 2FA by clicking the _Generate new secret and activate TOTP_ button. This action generates a one-time password comprised of six digits, which will be required in addition to the usual login credentials for accessing the opsi server. More details about this process are available in the section xref:server:components/authorization.adoc#server-components-authorization-multi-factor[Two-Factor Authentication].

.You can set up Two-Factor Authentication on the *Users* Tab.
image::opsiconfd/opsiconfd-admin-users.png["You can set up Two-Factor Authentication on the *Users* Tab.", width=800, pdfwidth=80%]

[[server-components-opsiconfd-admin-page-clients]]
=== Clients

The tab displays information about connected clients and their sessions. Clients that have been blocked are listed under _Blocked clients_. To unblock an individual client, use the _Unblock clients_ section by entering their IP address and clicking _Execute_. Alternatively, you can unblock all clients at once using the _Unblock all clients_ button.

NOTE: It's important to understand that "clients" here refers to (web) clients accessing the admin page, not the computers managed with opsi. This admin page feature typically blocks a client due to multiple failed login attempts.

To delete all sessions associated with a specific client, enter its IP address in the _Delete client sessions_ field and click _Execute_ to confirm.

.On this Tab, a list of Blocked Clients is displayed, and you have the Option to unblock them if necessary.
image::opsiconfd/opsiconfd-admin-blocked-clients.png["On this Tab, a list of Blocked Clients is displayed, and you have the Option to unblock them if necessary.", width=800, pdfwidth=80%]

[[server-components-opsiconfd-admin-page-depots]]
=== Depots

In the upper section of this tab, you have the option to add additional depot servers to your opsi environment. Start by entering the depot ID (which is the FQDN of the opsi depot server) and a brief description in the provided fields. After clicking on _Create depot_, the new depot should appear in the table. Initially, the _Messagebus_ column will display _not connected_. To establish communication between the config server and the new depot server, you need to execute the following command on the depot server:

[source,console]
----
opsiconfd setup --register-depot
----

NOTE: Please note that the command `opsi-setup --register-depot` is no longer available after the transition from opsi version 4.2 to 4.3 (see the section xref:server:components/commandline.adoc#server-components-opsi-setup[*opsi-setup*]).

.Add additional Depot Servers on this Tab.
image::opsiconfd/opsiconfd-admin-depots-1.png["Add additional Depot Servers on this Tab.", width=800, pdfwidth=80%]

If there are locked products on a depot server, they will also appear in the _Locked Products_ section of this tab. You can unlock a specific product by clicking the _Unlock_ button next to it. To remove the lock on all products, use the _Unlock all_ button.

.Are there any Locked Products? The *Depots* Tab will display these and provide a Button to unlock them.
image::opsiconfd/opsiconfd-admin-depots-2.png["Are there any Locked Products? The *Depots* Tab will display these and provide a Button to unlock them.", width=800, pdfwidth=80%]

[[server-components-opsiconfd-admin-page-rpc-info]]
=== RPC-Infos

The table displayed on this tab chronicles the most recent RPC (Remote Procedure Call) activities. You can organize the data by clicking on the headers of the table columns to sort the information accordingly.

.This Table shows the last RPC Calls.
image::opsiconfd/opsiconfd-admin-rpc-info.png["This Table shows the last RPC Calls.", width=800, pdfwidth=80%]

[[server-components-opsiconfd-admin-page-rpc-interface]]
=== RPC-Interface

This tab provides a comprehensive list of all methods available in the JSON-RPC API. By selecting the _Show deprecated methods_ checkbox, you can also view methods that are deprecated. To explore a specific method, choose one from the _Method_ drop-down menu. Depending on the selected method, you may see additional input fields for attributes, filters, or parameters. These fields require valid JSON encoding, and any syntax errors will be highlighted by the interface.

When you click the _Execute_ button, the selected method will be executed. The request, processing time, and result will then be displayed below in JSON format.

.You can execute JSON-RPC API Methods through this Tab.
image::opsiconfd/opsiconfd-admin-rpc-interface.png["You can execute JSON-RPC API Methods through this Tab.", width=800, pdfwidth=80%]

[[server-components-opsiconfd-admin-page-redis-interface]]
=== Redis-Interface

On this tab, you can view Redis status information, execute Redis commands, and clear the cache. By clicking on _Info+_, you can access detailed information about the Redis version, operating system, server architecture, and more.

The responses to any actions or queries you perform on this tab will be displayed at the bottom in JSON format.

.This Tab provides a Display of Information related to Redis.
image::opsiconfd/opsiconfd-admin-redis-interface.png["This Tab provides a Display of Information related to Redis.", width=800, pdfwidth=80%]

NOTE: The _Debug keys_ button allows you to debug keys, which are the names of various data structures stored in the database. This function can be useful for troubleshooting, performance monitoring, or data analysis. However, it's important to be cautious as accidentally deleting or overwriting a key could result in data loss. If you're unsure, it's advisable to create a backup beforehand (see the chapter xref:server:components/backup.adoc[Backup of the opsi Server]).

[[server-components-opsiconfd-admin-page-addons]]
=== Addons

On the _Addons_ tab, you manage the installation of `opsiconfd` extensions. Initially, download these extensions from our https://tools.43.opsi.org/[opsi Tools Website] and save them onto the opsi server. To install an addon, click _Browse_ on the _Addons_ tab, then in the file selection dialog, navigate to the zip file, select it, and finally click on _Install addon_.

The table on this tab not only shows the name and ID of each installed extension but also displays their version number and the installation path on the server.

.This Tab is used for installing Addons and provides detailed Information about each one.
image::opsiconfd/opsiconfd-admin-addons.png["This Tab is used for installing Addons and provides detailed Information about each one.", width=800, pdfwidth=80%]

[[server-components-opsiconfd-admin-page-logviewer]]
=== Log Viewer

The tab provides quick access to the `opsiconfd` log files (see section <<server-components-opsiconfd-logs>>). You can enlarge the display (_Maximize_ button), filter the logs by log level (_Filter by level_), context (_Filter by context_) and your own search terms (_Filter by message_). You can activate additional functions via checkboxes, such as the automatic collapsing of multi-line information into a single continuous line (_Collapse multi-line_) and automatic scrolling (_Auto scroll_). You can change the font size using the two buttons next to _Font size_.

.The admin page provides quick access to the `opsiconfd` log files.
image::opsiconfd/opsiconfd-admin-log-viewer.png["The admin page provides quick access to the `opsiconfd` log files.", width=900, pdfwidth=80%]

[[server-components-opsiconfd-admin-page-terminal]]
=== Terminal

Switch to this tab to open a terminal window on the opsi server. To do this, select an opsi server in your environment from the _Host_ drop-down menu (default setting: _Configserver_) and click on _Connect_. The terminal then starts in the browser; you are logged in as user `opsiconfd` and start in its home directory `/var/lib/opsi`. 

.Open a terminal on the opsi server via this tab.
image::opsiconfd/opsiconfd-admin-terminal.png["Open a terminal on the opsi server via this tab.", width=900, pdfwidth=80%]

Click on the _Maximize_ button to hide the menu at the top of the admin page and give the terminal more space. _Normalize_ takes you back to the old view. Alternatively, use _Fullscreen_ to switch to the full screen view, which you can exit by pressing [Esc]. You can use the plus and minus buttons next to _Font size_ to change the font size, and clicking on _Disconnect_ closes the terminal in the browser.

TIP: You can upload files by clicking or dragging and dropping. This is useful, for example, if you want to install a self-built opsi package (file extension `.opsi`). Proceed as follows:

. Open the terminal in the browser.
. Change to the directory with the packages: `cd /var/lib/opsi/repository`.
. Drag the package from the file manager into the browser terminal. (`ls -l` lists all files in the current directory for checking purposes).
. Install the package: `opsi-package-manager -i <package.opsi>` (see also section xref:server:components/commandline.adoc#server-components-opsi-package-manager[*opsi-package-manager*])

[[server-components-opsiconfd-admin-page-messagebus]]
=== Messagebus

On the tab, you can send and receive messages via the message bus (for testing and debugging purposes). The opsi server uses the message bus to send messages to other components (e.g. installation jobs, configuration changes or status queries from clients). 

To do this, select one of the templates from the drop-down menu next to the _Send_ button and fill it with the correct values in the upper field. Finally, click on _Send_. In the lower area of the tab you will see the sent message (left) and the response from the opsi message bus (right).

.Communicate with the opsi message bus via this tab.
image::opsiconfd/opsiconfd-admin-messagebus.png["Communicate with the opsi message bus via this tab.", width=900, pdfwidth=80%]

[[server-components-opsiconfd-admin-page-licensing]]
=== Licensing

On the _Licensing_ tab, you can see which xref:opsi-modules:modules.adoc[opsi extensions] are licensed. The first table shows information about the licensee (name, active and non-active clients, etc.), below you can see a detailed list of the opsi modules, when a license was issued, how long it is still valid, etc. Scroll to the bottom of the tab to import new licenses in the new format (extension `.opsilic`). These are saved on the opsi server in the `/etc/opsi/licenses` directory. 

.Information on licenses for the extensions can be found on this tab.
image::opsiconfd/opsiconfd-admin-licensing.png["Information about licenses for the extensions can be found on this tab.",width=600, pdfwidth=80%]

NOTE: Earlier opsi versions used the file `/etc/opsi/modules` for activation. It remains valid, but we only issue new licenses in the new format. Please contact mailto:sales@uib.de[sales@uib.de] to obtain a license file in the new format.

[[server-components-opsiconfd-admin-page-grafana]]
=== Grafana

The _Grafana_ tab redirects you to xref:server:components/grafana.adoc[Grafana dashboard]. As soon as you click on the tab, the _opsiconfd main dashboard_ is created or updated on the Grafana server. In addition, the user `opsidashboard` is created, which is used to access the dashboard.

[[server-components-opsiconfd-health-check]]
== Health Check

The `opsiconfd` provides a health check that can check various settings and versions of opsi components and thus provide information on possible problems. You can start the health check in different ways. All variants obtain their data from the API call `service_healthCheck`. The opsi API returns the data in JSON format. Such a JSON file is particularly useful for support requests.

One way to start a health check is via the admin page, _RPC interface_ tab (see section <<server-components-opsiconfd-admin-page-rpc-interface>>). On the command line, call the command `opsiconfd health-check`. Use the `--help` parameter to display online help; `opsiconfd health-check --manual` displays a description of all checks. Without further options, the check runs once and writes its results to Stdout.

.You can start the health check in the terminal.
image::opsi-health-check.png["You can start the health check in the terminal.", pdfwidth=80%]

TIP: Alternatively, you can also start the Health Check with the command line tool `opsi-cli` (see section xref:server:components/commandline.adoc#server-components-opsi-cli-commands-support[*opsi-cli support*]). The admin page provides quick access to a terminal on the opsi server via the _Terminal_ tab (see section <<server-components-opsiconfd-admin-page-terminal>>).

[[server-components-opsiconfd-logs]]
== Logfiles

// cSpell:ignore log-viewer
The `opsiconfd` uses Redis to write the log files (see chapter xref:server:components/redis.adoc[Redis]). In addition, the `opsiconfd` stores its own log files in the directory `/var/log/opsi/opsiconfd`.

NOTE: If there are problems accessing Redis, no logging takes place. To generate log files anyway, you can set the `log-mode` parameter to `local`.

opsi distinguishes between 10 different log levels:

* *0 - nothing*: Logging completely deactivated
* *1 - essential*: very important messages
* *2 - critical*: critical errors
* *3 - error*: Error
* *4 - warning*: Warnings
* *5 - notice*: important information
* *6 - info*: further information
* *7 - debug*: Messages for troubleshooting
* *8 - trace*: lots of details, e.g. recording of communication
* *9 - secret*: confidential information

The following parameters control the log level:

* *log-level*: general log level (up to which log level messages are transferred to the Redis stream)
* *log-level-stderr*: Level of the output on the terminal (Stderr)
* *log-level-file*: Log level of the log files

Use the command `opsiconfd log-viewer` to view the logs in the terminal:

[source,console]
----
opsiconfd log-viewer -l 6 --log-filter="client_address=192.168.1.1"
----

As the call reads the log stream directly from Redis, the maximum output is up to the 'log level'.

Alternatively, you can view the log files on the _Log Viewer_ tab in the admin interface (see section <<server-components-opsiconfd-admin-page-logviewer>>).

=== Filter

The `opsiconfd` divides the log files into channels and contexts. You can therefore filter the messages to obtain only certain information. You set the log level for a channel with the `log-levels` parameter. Only warnings are logged via `.*:4,opsiconfd\.headers:8`, but messages in the `opsiconfd.headers` channel are logged with the log level `trace`.

The `log-filter` parameter filters for contexts. The context `client_address` is mainly used for the `opsiconfd`. For example, you can use `client_address=192.168.1.1,192.168.1.2` to specify that you only see messages that are related to the two clients with the IP 192.168.1.1 and 192.168.1.2.

