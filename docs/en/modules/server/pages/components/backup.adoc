////
; Copyright (c) uib GmbH (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: https://www.opsi.org/credits/
////

:Author:    uib GmbH
:Email:     info@uib.de
:Date:      06.11.2023
:Revision:  4.3
:toclevels: 6
:doctype:   book
:icons:     font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]


[[server-components-backup]]
= Backup of the opsi server

Create regular backups of the opsi server. Basically, you can follow the same strategy as when backup other Linux systems. This chapter explains the opsi-specific aspects.

The opsi backup essentially involves these components:

* Backup the files of a depot
* Backup of the Redis database
* Backup of the opsi database

[[server-components-backup-depot-files]]
== Backup the files

You should back up the following directories on opsi depot servers:

* `/etc/opsi`
* `/var/lib/opsi`
* `/tftpboot/opsi` or `/var/lib/tftpboot/opsi`

NOTE: `opsiconfd backup` (see section <<server-components-opsiconfd-backup>>) only backs up the configuration files from `/etc/opsi` -- you have to take care of the other directories yourself.

Here are a few notes on the data in the `/var/lib/opsi` directory:

* `/var/lib/opsi/tmp`: Contains temporary files that you do not need to back up.
* `/var/lib/opsi/depot`: In many cases, the contents of this folder cannot be completely restored from the opsi packages, because additional files such as custom files, Windows installation files, WinPE and drivers that are not contained in the opsi packages are located here.
* `/var/lib/opsi/repository`: This directory is used as a cache for opsi packages; you can therefore exclude it from the backup. When restoring, you may then have to transfer large amounts of data again.


[[server-components-backup-redis]]
== Backup the Redis database

Redis is an in-memory database that stores all data in the main memory. Although this makes the database extremely fast, it also makes it susceptible to data loss - for example if the power fails or the Redis server process is abruptly terminated.

The Redis server is therefore usually configured in such a way that the data is written to the hard disk at regular intervals to ensure its persistence. This is done by creating so-called RDB snapshots. The data is written to the hard disk at certain intervals to ensure that it is retained even in the event of a server failure or restart.

When the Redis server is shut down, the data is also written to the hard disk so that it can be reloaded from there when the server is restarted. This means that no information is lost and the Redis server can continue to operate seamlessly.

An alternative or supplementary method is the so-called AOF (Append Only File). Here, all write processes are written to a file instead of just creating periodic snapshots. The file is updated continuously. On a restart, the Redis server can restore data from the AOF file.

TIP: Further details on this topic can be found in the Redis documentation, chapter link:https://redis.io/docs/management/persistence/[Redis persistence].

You can instruct Redis to create a database dump with the following command:

[source,console]
----
redis-cli save
----

On opsi servers, you can find the saved database dump in the file `/var/lib/redis/dump.rdb`, as defined in the configuration file `/etc/redis/redis.conf` (see chapter xref:server:components/redis.adoc[Redis]).

.Use the command `redis-cli save` to create a dump of the Redis database.
image::redis-cli-save.png["Use the command `redis-cli save` to create a dump of the Redis database.", pdfwidth=80%]

NOTE: Actually, it is not necessary to save the Redis database if you call `opsiconfd backup` (see next section) -- but such a database dump offers additional security.

[[server-components-backup-opsi-database]]
== Backup of the opsi database

opsi also uses a MySQL/MariaDB database (see chapter xref:server:components/mysql.adoc[MySQL-Server]). You can back this up with the standard tool `mysqldump`. The command creates a database dump for MySQL and MariaDB databases and then exports a complete database (or specific tables) to a file that you can use to restore or import data.

The following command creates a dump of the database called `opsi`, compresses it and saves it in the file `/var/backups/opsi.sql.bz2`:

[source,console]
----
mysqldump --single-transaction opsi | bzip2 > /var/backups/opsi.sql.bz2
----

You can then back up the file `/var/backups/opsi.sql.bz2` manually or include it in your backup strategy.

NOTE: It is not actually necessary to back up the MySQL database if you call `opsiconfd backup` (see next section) -- but such a database dump offers additional security.

[[server-components-opsiconfd-backup]]
== *opsiconfd backup/restore*

xref:server:components/opsiconfd.adoc[The *opsiconfd*] service is the central service on every opsi server. Its command line interface provides, among other things, the two commands `backup` and `restore`. This allows you to back up the opsi database and configuration files and restore a backup.

NOTE: In this case, the opsi database is backed up object-based and no database dump is created. This makes it easier to restore the backup in other environments - even if other MySQL versions are used.

A list of all parameters and their meaning is available via `--help`:

[source,console]
----
opsiconfd backup --help
opsiconfd restore --help
----

When creating and restoring the backup, the opsi config server is set to maintenance mode by default (see also section xref:server:components/opsiconfd.adoc#server-components-opsiconfd-admin-page-maintenance[*Maintenance*]).
This ensures that there is no client activity during backup and restore.

The following command creates a backup in MessagePack format (`msgpack`) with LZ4 compression:

[source,console]
----
opsiconfd backup --quiet --overwrite /var/backups/opsi-backup.msgpack.lz4
----

You can also encrypt the backup file with AES (Advanced Encryption Standard). To do this, use the parameter `--parameter`. Optionally, write the password directly after it; if you leave it out, enter it when prompted (and it will not appear in the bash history afterwards).

.As of opsi 4.3 you can encrypt opsi backups and secure them with a password.
image::opsi-backup-pw.png["Starting with opsi 4.3 you can encrypt opsi backups and secure them with a password.", pdfwidth=80%]

How to restore the backup you just created:

[source,console]
----
opsiconfd restore /var/backups/opsi-backup.msgpack.lz4
----

If you have encrypted the backup copy, also enter `--password` and then the previously set password when prompted.

CAUTION: When restoring a backup, neither configuration files nor Redis data are restored by default.
The parameters `--redis-data` or `--config-files` also restore this data.TIP: Use the `--server-id` parameter to change the ID of the opsi config server when restoring.

[[server-components-backup-webinterface]]
== Backup via admin page

As an alternative to the commands shown here, you can also create the backup via the `opsiconfd` admin page in the web browser (see section xref:server:components/opsiconfd.adoc#server-components-opsiconfd-admin-page-maintenance[*Maintenance*]). Use the checkboxes in the _Create backup_ area to define whether the configuration files should be taken into account and whether maintenance mode should be activated during the backup. If you enter a password in the _Password_ field, you activate AES encryption. After clicking on the _Create backup_ button, the backup copy is automatically saved in the download directory of the web browser. The file name consists of `opsiconfd-backup`, the date and the time, e.g. `opsiconfd-backup-20230628-162048.msgpack.lz4`.

To restore, select the desired backup copy in the _Restore Backup_ area; the _Browse_ button opens a file selection dialog. There are also checkboxes here to exclude the configuration files and to adjust the server ID. Activate _Other_ here and enter the FQDN of the server in the field behind it to restore the backup on another opsi config server. If you have encrypted the backup, enter the password in the _Password_ field. Finally, click on _Restore backup_.

.You can also create and restore backups on the _Maintenance_ tab of the admin page.
image::opsi-webinterface-backup.png["You can also create and restore backups on the _Maintenance_ tab of the admin page.", pdfwidth=80%, width=500]
