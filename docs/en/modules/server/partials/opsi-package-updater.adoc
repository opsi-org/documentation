////
; Copyright (c) uib GmbH (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: https://www.opsi.org/credits/
////

:Author:    uib GmbH
:Email:     info@uib.de
:Date:      07.11.2023
:Revision:  4.3
:toclevels: 6
:doctype:   book
:icons:     font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]

The command line tool `opsi-package-updater` is used to load opsi products from one or more repositories and install them on the opsi depot server. It is intended to automatically update opsi packages on a time-controlled basis (e.g. via a cronjob).

NOTE: Repositories are sources that offer opsi packages for download. You can configure each repository separately in terms of access and behavior.

Enter `opsi-package-updater --help` to display the online help:

[source,console]
----
opsi-package-updater --help
usage: opsi-package-updater [-h] [--version] [--config CONFIGFILE]
                            [--verbose | --log-level {0,1,2,3,4,5,6,7,8,9}]
                            [--force-checksum-calculation] [--repo repository_name]
                            [--use-inactive-repository] [--ignore-errors] [--no-zsync]
                            {install,update,download,list} ...

Updater for local opsi products. Operates in different MODEs: install, update, download and list. Each
mode has their own options that can be viewed with MODE -h
[â€¦]
----

Use the `--repo` parameter to restrict the operations to a single repository.

The `opsi-package-updater` supports the following commands:

* `list`: list available repositories or opsi packages
* `download`: download opsi packages from a repository
* `install`: download and install opsi packages from a repository
* `update`: update locally installed opsi packages from the repositories

All commands have their own help, which you can display via `opsi-package-updater <command> --help`.

TIP: Use the `-v` (verbose) parameter to make the output more detailed. You can also use the switch more than once (`-vvv`, `-vvv` etc.).

=== Examples

To display the activated repositories:

[source,console]
----
opsi-package-updater list --active-repos
----

To list the packages available in the repositories:

[source,console]
----
opsi-package-updater list --products
----

To install the package `ubuntu` from the repository `uib_linux`; at the same time `-vv` provides a very detailed output:

[source,console]
----
opsi-package-updater -vv --repo uib_linux install ubuntu
----

To download and install all packages available in the activated repositories:

[source,console]
----
opsi-package-updater install
----

To display the available updates:

[source,console]
----
opsi-package-updater list --updatable-products
----

To update the locally installed packages `firefox` and `javavm` from the repositories; `-vv` produces informative output:

[source,console]
----
opsi-package-updater -vv update firefox javavm
----

[[server-components-opsi-package-updater-repositories]]
=== Repositorys

The general settings for the `opsi-package-updater` can be found in the file `/etc/opsi/opsi-package-updater.conf`. Among other things, several sections in this file specify where the opsi packages are located (`packageDir`), the name of the log file (`logFile`) and the name of the directory with the repositories (`repositoryConfigDir`). You also make settings here for e-mail notification and Wake on LAN (WoL) on the clients.

The configuration files for the individual repositories can be found in the directory `/etc/opsi/package-updater.repos.d/`. There is also a commented template (file `example.repo.template`) which lists and explains all available options.

There are two types of repositories: Internet repositories and opsi server repositories.

==== Internet-Repositorys

Internet repositories are characterized by the following parameters:

* `baseURL`: the address, e.g. `\http://opsipackages.43.opsi.org/stable`
* `dirs`: a comma-separated list of directories, e.g. `opsi4.3/products/localboot, opsi4.3/products/netboot`
* `username` and `password` for repositories that require authentication
* `authcertfile` and `authkeyfile` for certificate-based authentication
* `verifyCert`: Activation and deactivation of server certificate verification for HTTPS connections
* `proxy`: Proxy server

NOTE: You can set up a proxy server for each repository using the option of the same name; alternatively, enter the proxy server in the file `/etc/opsi/opsi-package-updater.conf`.

==== opsi-Server-Repositorys

If you enter the host ID of another opsi server after `opsiDepotId` in the repository configuration file, this is an opsi server repository. In the case of an opsi depot server, the central opsi config server is located at this point. This means that the depot server obtains packages from the `/var/lib/opsi/repository` repository of the config server.

[[server-components-opsi-package-updater-actions]]
==== Repository behavior

You can also make a few settings for the behavior of each repository:

* `autoupdate`: More recent versions of installed packages are downloaded and installed.
* `autoinstall`: Available packages that are not yet installed locally are downloaded and installed.
* `autosetup`: Newly installed and updated packages are set to `setup` for all clients on which these packages are installed.
* `onlyDownload`: New packages are only downloaded.
* `ignoreErrors`: If errors occur with individual packages, this does not lead to termination.

TIP: The `onlyDownload` option is often used in conjunction with activated notifications. This allows an e-mail to be sent automatically after the new packages have been downloaded, leaving the actual installation to an administrator.

[[server-components-opsi-package-updater-install-default-products]]
=== Install standard products

To install the opsi standard products from the uib repositories, use the following command:

[source,console]
----
opsi-package-updater -v install
----

The command updates all existing opsi packages including the templates for operating system installations from the opsi repositories.

.Install the standard products on your opsi server.
image::opsi-package-updater.png["Install the standard products on your opsi-server.", pdfwidth=80%]

TIP: When using the preconfigured virtual machine, you can alternatively double-click the desktop icon to install the standard products.
