////
; Copyright (c) uib GmbH (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: https://www.opsi.org/credits/
////

:Author:    uib GmbH
:Email:     info@uib.de
:Date:      09.01.2024
:Revision:  4.3
:toclevels: 6
:doctype:   book
:icons:     font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]

Over time, opsi has accumulated a variety of command line tools. As the `opsi-utils` and `opsi-python` scripts were developed at different times, they each possess unique structures, command line options, and output formats. While some tools interact with the standard RPC interface, others bypass the opsi web service and directly interface with the backend.

The more recent addition, `opsi-cli`, offers access to the same functionalities found in earlier tools, and even more. Additionally, `opsi-cli` features a plugin system, enabling opsi users to enhance its capabilities with custom plugins. 

[[server-components-opsi-cli-installation]]
=== Installation

Since version 4.2.0.187, `opsi-cli` has been a component of the `opsi-utils` package and is therefore automatically installed on opsi servers. As a client component, `opsi-cli` can also be used remotely from the opsi server, with all communication occurring exclusively via the opsi web service. Consequently, `opsi-cli` is available for Linux, Windows, and macOS clients.

When using `opsi-cli` outside of an opsi server, you need to provide credentials for the opsi web service. This can be done either directly in the command line with `--service`, `--username`, and `--password`, or by saving the credentials locally on the client (use `opsi-cli config service add --help` for guidance, see section <<server-components-opsi-cli-serviceoptions>>).

NOTE: On Arch Linux you need to install the `libxcrypt-compat` package for `opsi-cli` to function correctly.

`opsi-cli` is designed to be immediately executable and portable. If you wish to include the binary in the path on an opsi client, you can manage this directly through `opsi-cli` itself:

[source,console]
----
opsi-cli self --help
----

image::opsi-cli-self-help.png["Ausgabe: opsi-cli self --help", width=800, pdfwidth=80%]

[[server-components-opsi-cli-usage]]
=== Usage

`opsi-cli` is a Python-based binary that operates based on parameters and commands. Every command within `opsi-cli` can consist of one or several subcommands. The upcoming sections will first introduce the basic functionalities and then delve into the available commands.

TIP: Each command in `opsi-cli` comes with its own online help, accessible via the `--help` parameter. For example, you can use `opsi-cli --help` or `opsi-cli config --help` to view detailed information about specific commands.

The typical structure for executing an `opsi-cli` command is as follows:

[source,console]
----
opsi-cli [OPTIONS] COMMAND [ARGS]...
----

Options specified immediately after the `opsi-cli` command are part of the global configuration and therefore apply to all subsequent subcommands. There are three main categories of global options in `opsi-cli`.

[[server-components-opsi-cli-globaloptions]]
==== General Options

The parameters in the `General options` section let you adjust aspects like logging, enable colored output, and configure other settings in `opsi-cli`. 

image::opsi-cli-general-options.png["Output: opsi-cli general options", width=800, pdfwidth=80%]

[[server-components-opsi-cli-formatoptions]]
==== Output Format

The options found under `IO options` are used to standardize the output across all subcommands, allowing you to specify output formats and apply filters.

image::opsi-cli-io-options.png["Output: opsi-cli io options", width=800, pdfwidth=80%]

The following example demonstrates how to use these options for filtering and formatting output. In the first command, `opsi-cli` executes the JSON-RPC method `host_getObjects` (`execute`) to display information about opsi clients from the domain `domain.local` with names beginning with `client`:

[source,toml]
----
opsi-cli jsonrpc execute host_getObjects [] '{"id":"client*.domain.local"}'
[
  {
    "description": "",
    "notes": "Created by opsi-deploy-client-agent at Mon, 26 Sep 2022 17:19:29",
    "id": "client-linux.domain.local",
    "hardwareAddress": "08:00:27:f5:1d:8e",
    "ipAddress": "192.168.56.11",
    "inventoryNumber": "",
    "systemUUID": null,
    "opsiHostKey": null,
    "created": "2022-09-26 17:19:29",
    "lastSeen": "2023-03-08 12:13:10",
    "oneTimePassword": null,
    "type": "OpsiClient",
    "ident": "client-linux.domain.local"
  },
  […]
]
----

The next command formats the output as a table in the terminal and filters it to include only three attributes: `id`, `type`, and `lastSeen`:

[source,console]
----
opsi-cli --output-format table --attributes id,type,lastSeen jsonrpc execute host_getObjects [] '{"id":"client*.domain.local"}'
----

image::opsi-cli-table-format.png["Tabellenformat", pdfwidth=80%, width=400]

If you prefer the CSV format, simply write `csv` after `--output-format` instead of `table`:

[source,console]
----
opsi-cli --output-format csv --attributes id,type,lastSeen jsonrpc execute host_getObjects [] '{"id":"client*.domain.local"}'
[…]
id;lastSeen;type
client-linux.domain.local;2023-03-08 12:13:10;OpsiClient
client-macos.domain.local;2023-03-15 14:55:37;OpsiClient
client-win10.domain.local;2023-03-15 15:13:46;OpsiClient
----

You can use the `--output-file` option to directly write the output to a file.

[[server-components-opsi-cli-serviceoptions]]
==== Service Options

When using `opsi-cli` outside of the opsi server, it's necessary to provide access credentials for the opsi web service. The relevant parameters for this are `--service`, `--username`, and `--password`:

image::opsi-cli-service-options.png["Output: opsi-cli service options", width=800, pdfwidth=80%]

TIP: As an alternative, you can save the access credentials directly on the client. This approach is particularly useful if you need to access multiple opsi servers, as it allows you to create and manage different service configurations as profiles. To set this up, use the `opsi-cli config` command. For detailed instructions and options, you can view the online help by entering `opsi-cli config service add --help`.

[[server-components-opsi-cli-commands]]
=== Commands and Examples

The following sections will detail the currently available commands in `opsi-cli` and provide examples to illustrate their usage.

[[server-components-opsi-cli-commands-config]]
==== *config*

Use this command to adjust the `opsi-cli` configuration:

[source,console]
----
opsi-cli config --help
----

image::opsi-cli-config-help.png["Ausgabe: opsi-cli config --help", width=800, pdfwidth=80%]

Use the following command to view the current configuration and the default settings:

[source,console]
----
opsi-cli config list
----

image::opsi-cli-config-list.png["Output: opsi-cli config list", width=800, pdfwidth=80%]

To permanently modify a configuration value, use the command `opsi-cli config set <name> <value>`. This adjustment will then be applied to all future uses of `opsi-cli`. If you need to remove a previously set value, use the command `opsi-cli config unset <name>`. For managing service access configurations, `opsi-cli config service` provides several subcommands, including `add`, `list`, and `remove`.

[[server-components-opsi-cli-commands-jsonrpc]]
==== *jsonrpc*

The `jsonrpc` command in `opsi-cli` provides access to JSON-RPC methods, allowing their execution on the opsi server. This functionality enables `opsi-cli` to fully replace the `opsi-admin` tool. The `jsonrpc` command includes two subcommands:

* `opsi-cli jsonrpc methods`: This command prints a list of all available API methods along with their parameters.
* `opsi-cli jsonrpc execute <method>`: Use this command to execute a specified method.

The output of `opsi-cli jsonrpc methods` also indicates if a method is marked as obsolete in the `deprecated` column, while the `alternative_method` column shows the recommended alternative method.

To execute a specific method, append its name after the `opsi-cli jsonrpc execute` command, for example:

[source,console]
----
opsi-cli jsonrpc execute authenticated
----

The syntax for using `opsi-cli` is similar to that of `opsi-admin`, as can be seen in a direct comparison:

[source,console]
----
opsi-admin method authenticated
----

The way in which method parameters are specified in `opsi-cli` is exactly the same as in `opsi-admin`, as illustrated by the following, slightly more complex example:

[source,console]
----
opsi-cli jsonrpc execute host_getObjects '["created","lastSeen"]' '{"id":"testclient01.uib.local"}'
----

Old variant:

[source,console]
----
opsi-admin method host_getObjects '["created","lastSeen"]' '{"id":"testclient01.uib.local"}'
----

NOTE: In the two examples provided, the `-d` parameter for `opsi-admin` (which bypasses `opsiconfd`) is intentionally omitted. Bypassing the opsi web service in the past, has occasionally led to issues within the opsi system. Therefore, access to the API is recommended solely via the opsi web service. It's important to note that `opsi-cli` does not support bypassing `opsiconfd`.

When operating directly on the opsi server, there's no need to input any access credentials, as `opsi-cli` automatically retrieves this information from the server configuration. However, if you plan to use `opsi-cli` in scripts, cronjobs, or similar automated tasks, it's essential to set up the access data in advance.

The output format for `jsonrpc` commands in `opsi-cli` can also be adjusted using parameters like `--output-format` and `--attributes`, similar to other `opsi-cli` commands. For more details on formatting options, please refer to the section <<server-components-opsi-cli-formatoptions>>.

[source,console]
----
opsi-cli --output-format table --attributes id,created,lastSeen jsonrpc execute host_getObjects '["created","lastSeen"]' '{"id":"testclient01.uib.local"}'
----

NOTE: When using `opsi-cli` on Windows, be aware that the command prompt (`cmd.exe`) and PowerShell interpret single and double quotation marks differently. Therefore, it might be necessary to use escape sequences to ensure the commands work correctly.

The following examples demonstrate how to list all depots in an opsi environment, highlighting the differences between commands on Linux/macOS and Windows. Here is how the command is executed on Linux and macOS:

[source,console]
----
opsi-cli jsonrpc execute host_getObjects [] '{"type":"OpsiDepotserver"}'
----

For the Windows command prompt, the command is executed as follows:

[source,console]
----
opsi-cli jsonrpc execute host_getObjects [] {\"type\":\"OpsiDepotserver\"}
----

In PowerShell (versions prior to 7), the command is formatted as follows:

[source,console]
----
opsi-cli jsonrpc execute host_getObjects [] '{\"type\":\"OpsiDepotserver\"}'
----

[[server-components-opsi-cli-commands-client-actions]]
==== *client-action*

The `client-action` command is used to manage opsi clients. It primarily offers options to influence which list of clients is affected by actions:

[source,console]
----
opsi-cli client-action --help
----

image::opsi-cli-client-action-help.png["Output: opsi-cli client-action --help", width=800, pdfwidth=80%]

Currently, the `client-action` command supports the `set-action-request` subcommand, which executes actions for products on opsi clients. It is comparable to the `task` command of `opsi-admin` (see section <<server-components-opsi-admin-examples>>), but works according to the exclusion principle. This means that without explicitly specifying clients and products, the action affects everything. Therefore, `set-action-request` offers further options to filter the products that an action should affect:

[source,console]
----
opsi-cli client-action set-action-request --help
----

image::opsi-cli-set-action-request-help.png["Output: opsi-cli client-action set-action-request --help", width=800, pdfwidth=80%]

CAUTION: If called without explicitly specifying clients and products, the command affects all clients and all products. To prevent errors, `opsi-cli` does not allow `set-action-request` to be executed without specifying at least one of the following: `--where-outdated`, `--where-failed`, `--products` or `--product-groups`.

To set all outdated products of clients to `setup`:

[source,console]
----
opsi-cli client-action set-action-request --where-outdated
----

Alternatively, set only a specific product (here: `opsi-client-agent`) to `setup`:

[source,console]
----
opsi-cli -l5 client-action --clients test-98.domain.tld set-action-request --products opsi-client-agent

[5] [2022-10-28 12:54:59.998] [               ] Selected clients: ['test-98.domain.tld']   (client_action_worker.py:48)
[5] [2022-10-28 12:55:00.055] [               ] Handling products ['opsi-client-agent']   (set_action_request_worker.py:105)
[5] [2022-10-28 12:55:00.065] [               ] Setting 'setup' ProductActionRequest: opsi-client-agent -> test-98.domain.tld   (set_action_request_worker.py:134)
----

The product status 'setup' is the default. If you want to set the same product to `uninstall`, the command is as follows:

[source,console]
----
opsi-cli -l5 client-action --clients test-98.domain.tld set-action-request --products opsi-client-agent --request-type uninstall

[5] [2022-10-28 12:57:06.848] [               ] Selected clients: ['test-98.domain.tld']   (client_action_worker.py:48)
[5] [2022-10-28 12:57:06.904] [               ] Handling products ['opsi-client-agent']   (set_action_request_worker.py:105)
[5] [2022-10-28 12:57:06.914] [               ] Setting 'uninstall' ProductActionRequest: opsi-client-agent -> test-98.domain.tld   (set_action_request_worker.py:134)
----

To reset an action request for a specific product on a client, use the switch `None` (`none` is also allowed):

[source,console]
----
opsi-cli -l5 client-action --clients test-98.domain.tld set-action-request --products opsi-client-agent --request-type None

[5] [2022-10-28 14:12:50.538] [               ] Selected clients: ['test-98.domain.tld']   (client_action_worker.py:48)
[5] [2022-10-28 14:12:50.574] [               ] Handling products ['opsi-client-agent']   (set_action_request_worker.py:105)
[5] [2022-10-28 14:12:50.580] [               ] Setting 'None' ProductActionRequest: opsi-client-agent -> test-98.domain.tld   (set_action_request_worker.py:134)
----

If an error occurs in a product, it should be possible to temporarily undo all actions for it on the clients. This prevents the faulty product from being distributed further:

[source,console]
----
opsi-cli client-action set-action-request --products opsi-client-agent --request-type None
----

If the product is available again without errors at some point, you can reset all outdated or incorrect status information to 'setup':

[source,console]
----
opsi-cli client-action set-action-request --where-outdated --where-failed
----

To set a specific product on a group of clients (here: `testclients`) to `setup`:

[source,console]
----
opsi-cli -l5 client-action --client-groups testclients set-action-request --products opsi-client-agent

[5] [2022-10-28 13:03:24.100] [               ] Selected clients: ['test-1.domain.tld', 'test-2.domain.tld', 'test-3.domain.tld', 'test-4.domain.tld', 'test-5.domain.tld']   (client_action_worker.py:48)
[5] [2022-10-28 13:03:24.159] [               ] Handling products ['opsi-client-agent']   (set_action_request_worker.py:105)
[5] [2022-10-28 13:03:24.169] [               ] Setting 'setup' ProductActionRequest: opsi-client-agent -> test-1.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:03:24.170] [               ] Setting 'setup' ProductActionRequest: opsi-client-agent -> test-2.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:03:24.170] [               ] Setting 'setup' ProductActionRequest: opsi-client-agent -> test-3.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:03:24.170] [               ] Setting 'setup' ProductActionRequest: opsi-client-agent -> test-4.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:03:24.170] [               ] Setting 'setup' ProductActionRequest: opsi-client-agent -> test-5.domain.tld   (set_action_request_worker.py:134)
----

In addition to a group of clients, you can also define a group of products (here: `testproducts`) behind `--product-groups`:

[source,console]
----
opsi-cli -l5 client-action --client-groups testclients set-action-request --product-groups testproducts

[5] [2022-10-28 13:05:53.147] [               ] Selected clients: ['test-1.domain.tld', 'test-2.domain.tld', 'test-3.domain.tld', 'test-4.domain.tld', 'test-5.domain.tld']   (client_action_worker.py:48)
[5] [2022-10-28 13:05:53.225] [               ] Handling products ['hwaudit', 'opsi-client-agent', 'swaudit']   (set_action_request_worker.py:105)
[5] [2022-10-28 13:05:53.236] [               ] Setting 'setup' ProductActionRequest: hwaudit -> test-1.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.237] [               ] Setting 'setup' ProductActionRequest: opsi-client-agent -> test-1.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.237] [               ] Setting 'setup' ProductActionRequest: swaudit -> test-1.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.237] [               ] Setting 'setup' ProductActionRequest: hwaudit -> test-2.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.237] [               ] Setting 'setup' ProductActionRequest: opsi-client-agent -> test-2.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.238] [               ] Setting 'setup' ProductActionRequest: swaudit -> test-2.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.238] [               ] Setting 'setup' ProductActionRequest: hwaudit -> test-3.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.238] [               ] Setting 'setup' ProductActionRequest: opsi-client-agent -> test-3.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.238] [               ] Setting 'setup' ProductActionRequest: swaudit -> test-3.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.239] [               ] Setting 'setup' ProductActionRequest: hwaudit -> test-4.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.239] [               ] Setting 'setup' ProductActionRequest: opsi-client-agent -> test-4.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.239] [               ] Setting 'setup' ProductActionRequest: swaudit -> test-4.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.239] [               ] Setting 'setup' ProductActionRequest: hwaudit -> test-5.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.239] [               ] Setting 'setup' ProductActionRequest: opsi-client-agent -> test-5.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.240] [               ] Setting 'setup' ProductActionRequest: swaudit -> test-5.domain.tld   (set_action_request_worker.py:134)
----

`opsi-cli` automatically excludes a list of certain packages with the two parameters `--where-outdated` and `--where-failed`. Currently these are `opsi-winst`, `opsi-auto-update`, `opsi-script`, `shutdownwanted`, `windows10-upgrade`, `activate-win`, `opsi-script-test`, `opsi-bootimage-local`, `opsi-uefi-netboot`, `opsi-wan-config-on`, `opsi-wan-config-off`, `opsi-winpe`, `win10-sysprep-app-update-blocker` and `windomain`. 

TIP: While it is easily possible to exclude other products or product groups, it is even safer to maintain a separate product group and specify this when calling it up. This allows you to restrict changes to just this group.

[[server-components-opsi-cli-commands-plugin]]
==== *plugin*

All `opsi-cli` commands are implemented as plugins, including the `plugin` command itself. You use it to manage plugins, i.e. to install new external plugins or to remove running plugins from the system. You can also use `opsi-cli plugin` to list or export plugins.

[source,console]
----
opsi-cli plugin --help
----

image::opsi-cli-plugin-help.png["Output: opsi-cli plugin --help", width=800, pdfwidth=80%]

How to generate a template for a new plugin:

[source,console]
----
opsi-cli plugin new
----

After you have entered the name, version and description, `opsi-cli` creates a new directory with the selected name. This directory contains the subdirectories `python` and `data`:

* You can store the code for the new plugin in the `python` directory. The directory represents a Python package and contains a `__init__.py` file as a starter. Here you will find an example of a command, a subcommand and some options.

* The `data` directory contains static resources for the plugin; you can normally ignore it.

After you have filled the template with content, add the plugin to the running `opsi-cli` instance:

[source,console]
----
opsi-cli plugin add <directory>
----

If the specified directory contains valid Python code, the contained command is then available as a plugin in `opsi-cli`. 

TIP: To display all registered plugins, enter the command `opsi-cli plugin list`.

You can export a plugin to an archive and then import it into another `opsi-cli` instance:

[source,console]
----
opsi-cli plugin export <name>
opsi-cli plugin add <archive>
----

Use these commands to convert a directory into an archive and vice versa:

[source,console]
----
opsi-cli plugin compress <directory>
opsi-cli plugin extract <archive>
----

NOTE: To subsequently change an imported plugin, unpack it with the `extract` command, adjust the contents of the directory and call `opsi-cli plugin add <directory>` again. This will overwrite the existing plugin with the same name.

To remove a plugin from an `opsi-cli` instance, call the following command:

[source,console]
----
opsi-cli plugin remove <name>
----

[[server-components-opsi-cli-commands-self]]
==== *self*

You use the `self` command to manage the `opsi-cli` instance. This includes (de)installing `opsi-cli` on the system, activating autocomplete and displaying the command structure.

[source,console]
----
opsi-cli self --help
----

image::opsi-cli-self-help.png["Output: opsi-cli self --help", width=800, pdfwidth=80%]

You can install `opsi-cli` on your system using the `opsi-cli` binary. To do this, execute the command `opsi-cli self install`. During installation, the binary program is copied to a globally available location (or included in the PATH under Windows) and a configuration file is created. You decide whether the `opsi-cli` installation should be user-specific or system-wide (option `--system`). To uninstall, use the command `opsi-cli self uninstall`.

TIP: If you install the opsi package `opsi-cli` or the `opsi-utils` on a client, the step `opsi-cli self install` is omitted.

To display the command structure including all commands, their version number and the subcommands, enter the command `opsi-cli self command-structure`.

image::opsi-cli-self-command-structure.png["Output: opsi-cli self command-structure", width=800, pdfwidth=80%]

The `opsi-cli` auto-completion works for commands, subcommands and options. To set it up, enter this command:

[source,console]
----
opsi-cli self setup-shell-completion
----

The feature currently works on three different shells: Bash, ZSH and Fish. After restarting the active shell or after a new login, you can use tab completion in the same way as in conventional Unix shells. Press [Tab] [Tab] to show all available options or commands (depending on the context). This is how [Tab] [Tab] behaves in different situations:

* After `opsi-cli` or any command that has at least one subcommand, you will see a list of available (sub)commands.
* After `-` you will see available options for the current command or `opsi-cli` itself.
* After a subcommand, the possible values for the arguments appear:
        - For the subcommands `set`, `show` and `unset` of `opsi-cli config`, [Tab] [Tab] shows a list of all available configurations that are affected.
        - For `opsi-cli jsonrpc execute`, a list of available methods is displayed (filtered by a specified prefix).

[[server-components-opsi-cli-commands-support]]
==== *support*

The `opsi-cli support` command helps to analyze and solve problems in your opsi environment. At the moment there is only one subcommand: `opsi-cli support health-check` checks various aspects that can affect the smooth running of an opsi environment and compiles a report.

image::opsi-cli-health-check.png["Output: opsi-cli support health-check", width=800, pdfwidth=80%]

The following example shows a compact representation of the report. Without restricting the attributes (`--attributes=id,status,message`), it shows more detailed information on the warnings (`warnings`) and error messages (`errors`):

[source,console]
----
opsi-cli --attributes=id,status,message support health-check
----

[[server-components-opsi-cli-commands-terminal]]
==== *terminal*

The command `opsi-cli terminal` starts a simple terminal client that you can use to establish a connection to opsi servers. It works in a similar way to SSH or PuTTY. For the opsi server to be contacted, enter either the FQDN or the opsi host ID. 

You can also use this command to address the opsi config server:

[source,console]
----
opsi-cli terminal configserver
----

As soon as you close the terminal (command `exit` or key combination [Ctrl]+[D]), the connection is terminated.
