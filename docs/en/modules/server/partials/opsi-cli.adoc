////
; Copyright (c) uib GmbH (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: https://www.opsi.org/credits/
////

:Author:    uib GmbH
:Email:     info@uib.de
:Date:      06.11.2023
:Revision:  4.3
:toclevels: 6
:doctype:   book
:icons:     font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]

Over the years, opsi has received several command line tools. Since the `opsi-utils` and `opsi-python` scripts were created at different times, they each have their own structure, command line options and output formats. Some tools use the standard RPC interface, others bypass the opsi web service and work directly on the backend.

The relatively new `opsi-cli` tool provides access to the same functions (and more!). In addition, `opsi-cli` has a plugin system that allows opsi users to extend the functionality with their own plugins.  

[[server-components-opsi-cli-installation]]
=== Installation

Since version 4.2.0.187, `opsi-cli` has been part of the `opsi-utils` package and is thus automatically installed on the opsi servers. As a client component, `opsi-cli` can also be used outside the opsi server; communication takes place exclusively via the opsi web service. Therefore, `opsi-cli` is available as a package for Linux, Windows and macOS clients.

If you want to use `opsi-cli` outside the opsi server, you have to pass credentials to the opsi web service -- either when calling via `--service`, `--username` and `--password`, or you save the credentials locally on the client (`opsi-cli config service add --help`, see section <<server-components-opsi-cli-serviceoptions>>).

NOTE: On Arch Linux you need to install the `libxcrypt-compat` package for `opsi-cli` to work properly. 

The `opsi-cli` executable is immediately executable and portable. If you want to include the binary in the path on an opsi client, you can use `opsi-cli` yourself:

[source,console]
----
opsi-cli self --help
----

image::opsi-cli-self-help.png["Ausgabe: opsi-cli self --help", pdfwidth=80%]

[[server-components-opsi-cli-usage]]
=== Usage

`opsi-cli` is a Python binary that you control via parameters and commands. Each command can contain one or more subcommands. The following sections first present the basic functionalities and then the available commands.

TIP: Each command has its own online help, which you can display using the `--help` parameter, e.g. `opsi-cli --help` or `opsi-cli config --help`.

The general call to `opsi-cli` looks like this:

[source,console]
----
opsi-cli [OPTIONS] COMMAND [ARGS]...
----

The options directly after the `opsi-cli` command are considered the global configuration and therefore also apply to all subcommands. There are three main categories of global options.

[[server-components-opsi-cli-globaloptions]]
==== General options

With the parameters listed under `General options` you can influence the logging, activate a colored output, the configuration, etc.

image::opsi-cli-general-options.png["Output: opsi-cli general options", pdfwidth=80%]

[[server-components-opsi-cli-formatoptions]]
==== output format

You can use the options listed under `IO options` to standardize the output of all subcommands, specify output formats and set filters.

image::opsi-cli-io-options.png["Output: opsi-cli io options", pdfwidth=80%]

The next example shows how to filter and format the output. In the first command, `opsi-cli` executes the JSON-RPC method `host_getObjects` (`execute`) to display information about opsi clients from the domain `domain.local` whose name starts with `client`:

[source,toml]
----
opsi-cli jsonrpc execute host_getObjects [] '{"id":"client*.domain.local"}'
[
  {
    "description": "",
    "notes": "Created by opsi-deploy-client-agent at Mon, 26 Sep 2022 17:19:29",
    "id": "client-linux.domain.local",
    "hardwareAddress": "08:00:27:f5:1d:8e",
    "ipAddress": "192.168.56.11",
    "inventoryNumber": "",
    "systemUUID": null,
    "opsiHostKey": null,
    "created": "2022-09-26 17:19:29",
    "lastSeen": "2023-03-08 12:13:10",
    "oneTimePassword": null,
    "type": "OpsiClient",
    "ident": "client-linux.domain.local"
  },
  […]
]
----

The next call formats the output as a table in the terminal and filters three attributes (`id`, `type` and `lastSeen`):
The same call with different formats and filtered to three attributes:

[source,console]
----
opsi-cli --output-format table --attributes id,type,lastSeen jsonrpc execute host_getObjects [] '{"id":"client*.domain.local"}'
----

image::opsi-cli-table-format.png["Tabellenformat", pdfwidth=80%, width=400]

If you prefer the CSV format, simply write `csv` after `--output-format` instead of `table`:

[source,console]
----
opsi-cli --output-format csv --attributes id,type,lastSeen jsonrpc execute host_getObjects [] '{"id":"client*.domain.local"}'
[…]
id;lastSeen;type
client-linux.domain.local;2023-03-08 12:13:10;OpsiClient
client-macos.domain.local;2023-03-15 14:55:37;OpsiClient
client-win10.domain.local;2023-03-15 15:13:46;OpsiClient
----

Also use the `--output-file` option to write the output directly to a file.

[[server-components-opsi-cli-serviceoptions]]
==== Service options

If you want to use `opsi-cli` outside the opsi server, you must enter access data for the opsi web service. The corresponding parameters are `--service`, `--username` and `--password`:

image::opsi-cli-service-options.png["Output: opsi-cli service options", pdfwidth=80%]

TIP: Alternatively, save the access data on the respective client. You can even store different service configurations as profiles if you want to access different opsi servers. To do this, use the command `opsi-cli config` presented in the following section; enter `opsi-cli config service add --help` to display the online help on this topic.

[[server-components-opsi-cli-commands]]
=== Commands and examples

The following sections explain the commands currently available and provide examples of their use.

[[server-components-opsi-cli-commands-config]]
==== *config*

Use this command to adjust the `opsi-cli` configuration:

[source,console]
----
opsi-cli config --help
----

image::opsi-cli-config-help.png["Ausgabe: opsi-cli config --help", pdfwidth=80%]

Use the following command to view the current configuration and the default settings:

[source,console]
----
opsi-cli config list
----

image::opsi-cli-config-list.png["Output: opsi-cli config list", pdfwidth=90%]

To change a value permanently, use the command `opsi-cli config set <name> <value>`. The new settings then apply to all subsequent `opsi-cli` calls. To remove a value, enter `opsi-cli config unset <name>`. To manage the service accesses, `opsi-cli config service` is available with the subcommands `add`, `list` and `remove`.

[[server-components-opsi-cli-commands-jsonrpc]]
==== *jsonrpc*

Use the `jsonrpc` command to access JSON-RPC methods and execute them on the opsi server. This means that `opsi-cli` can completely replace the `opsi-admin` tool. `jsonrpc` knows two subcommands:

* `opsi-cli jsonrpc methods`: Returns a list of all available API methods and their parameters.
* `opsi-cli jsonrpc execute <method>`: Executes the specified method.

The output of `opsi-cli jsonrpc methods` also shows in the `deprecated` column whether a method is marked as obsolete. In the column next to it (`alternative_method`) you can see the recommended alternative. 

To execute a specific method, enter its name after the command `opsi-cli jsonrpc execute`, for example like this:

[source,console]
----
opsi-cli jsonrpc execute authenticated
----

The syntax is similar to that of `opsi-admin`, as a direct comparison shows:

[source,console]
----
opsi-admin method authenticated
----

The specification of the method parameters is absolutely identical, as the next somewhat more complex example shows:

[source,console]
----
opsi-cli jsonrpc execute host_getObjects '["created","lastSeen"]' '{"id":"testclient01.uib.local"}'
----

Old variant:

[source,console]
----
opsi-admin method host_getObjects '["created","lastSeen"]' '{"id":"testclient01.uib.local"}'
----

NOTE: The two examples deliberately omit the `-d` parameter for `opsi-admin` (bypasses `opsiconfd`). Bypassing the opsi web service has led to problems within the opsi system in the past. Therefore the way to the API is only possible via the opsi web service -- `opsi-cli` does not support this mode at all.

If you are working directly on the opsi server, you do not need any access data; the tool receives this automatically from the server configuration. However, if you want to use `opsi-cli` in scripts, cronjobs or similar, you must store the access data beforehand.

As with the other `opsi-cli` commands, you can influence the output format for `jsonrpc` with parameters such as `--output-format` and `n --attributes` (see section <<server-components-opsi-cli-formatoptions>>).

[source,console]
----
opsi-cli --output-format table --attributes id,created,lastSeen jsonrpc execute host_getObjects '["created","lastSeen"]' '{"id":"testclient01.uib.local"}'
----

NOTE: Please note that you may have to use escape sequences under Windows, as the command prompt (`cmd.exe`) and the PowerShell interpret single and double quotation marks differently. 

The next two calls to list all depots in an opsi environment illustrate the differences. This is what the command looks like under Linux and macOS:

[source,console]
----
opsi-cli jsonrpc execute host_getObjects [] '{"type":"OpsiDepotserver"}'
----

It looks like this in the Windows command prompt:

[source,console]
----
opsi-cli jsonrpc execute host_getObjects [] {\"type\":\"OpsiDepotserver\"}
----

In PowerShell (before version 7) the command looks like this:

[source,console]
----
opsi-cli jsonrpc execute host_getObjects [] '{\"type\":\"OpsiDepotserver\"}'
----

[[server-components-opsi-cli-commands-client-actions]]
==== *client-action*

The `client-action` command is used to manage opsi clients. It primarily offers options to influence which list of clients is affected by actions:

[source,console]
----
opsi-cli client-action --help
----

image::opsi-cli-client-action-help.png["Output: opsi-cli client-action --help", pdfwidth=80%]

Currently, the `client-action` command supports the `set-action-request` subcommand, which executes actions for products on opsi clients. It is comparable to the `task` command of `opsi-admin` (see section <<server-components-opsi-admin-examples>>), but works according to the exclusion principle. This means that without explicitly specifying clients and products, the action affects everything. Therefore, `set-action-request` offers further options to filter the products that an action should affect:

[source,console]
----
opsi-cli client-action set-action-request --help
----

image::opsi-cli-set-action-request-help.png["Output: opsi-cli client-action set-action-request --help", pdfwidth=80%]

WARNING: If called without explicitly specifying clients and products, the command affects all clients and all products. To prevent errors, `opsi-cli` does not allow `set-action-request` to be executed without specifying at least one of the following: `--where-outdated`, `--where-failed`, `--products` or `--product-groups`.

To set all outdated products of clients to `setup`:

[source,console]
----
opsi-cli client-action set-action-request --where-outdated
----

Alternatively, set only a specific product (here: `opsi-client-agent`) to `setup`:

[source,console]
----
opsi-cli -l5 client-action --clients test-98.domain.tld set-action-request --products opsi-client-agent

[5] [2022-10-28 12:54:59.998] [               ] Selected clients: ['test-98.domain.tld']   (client_action_worker.py:48)
[5] [2022-10-28 12:55:00.055] [               ] Handling products ['opsi-client-agent']   (set_action_request_worker.py:105)
[5] [2022-10-28 12:55:00.065] [               ] Setting 'setup' ProductActionRequest: opsi-client-agent -> test-98.domain.tld   (set_action_request_worker.py:134)
----

The product status 'setup' is the default. If you want to set the same product to `uninstall`, the command is as follows:

[source,console]
----
opsi-cli -l5 client-action --clients test-98.domain.tld set-action-request --products opsi-client-agent --request-type uninstall

[5] [2022-10-28 12:57:06.848] [               ] Selected clients: ['test-98.domain.tld']   (client_action_worker.py:48)
[5] [2022-10-28 12:57:06.904] [               ] Handling products ['opsi-client-agent']   (set_action_request_worker.py:105)
[5] [2022-10-28 12:57:06.914] [               ] Setting 'uninstall' ProductActionRequest: opsi-client-agent -> test-98.domain.tld   (set_action_request_worker.py:134)
----

To reset an action request for a specific product on a client, use the switch `None` (`none` is also allowed):

[source,console]
----
opsi-cli -l5 client-action --clients test-98.domain.tld set-action-request --products opsi-client-agent --request-type None

[5] [2022-10-28 14:12:50.538] [               ] Selected clients: ['test-98.domain.tld']   (client_action_worker.py:48)
[5] [2022-10-28 14:12:50.574] [               ] Handling products ['opsi-client-agent']   (set_action_request_worker.py:105)
[5] [2022-10-28 14:12:50.580] [               ] Setting 'None' ProductActionRequest: opsi-client-agent -> test-98.domain.tld   (set_action_request_worker.py:134)
----

If an error occurs in a product, it should be possible to temporarily undo all actions for it on the clients. This prevents the faulty product from being distributed further:

[source,console]
----
opsi-cli client-action set-action-request --products opsi-client-agent --request-type None
----

If the product is available again without errors at some point, you can reset all outdated or incorrect status information to 'setup':

[source,console]
----
opsi-cli client-action set-action-request --where-outdated --where-failed
----

To set a specific product on a group of clients (here: `testclients`) to `setup`:

[source,console]
----
opsi-cli -l5 client-action --client-groups testclients set-action-request --products opsi-client-agent

[5] [2022-10-28 13:03:24.100] [               ] Selected clients: ['test-1.domain.tld', 'test-2.domain.tld', 'test-3.domain.tld', 'test-4.domain.tld', 'test-5.domain.tld']   (client_action_worker.py:48)
[5] [2022-10-28 13:03:24.159] [               ] Handling products ['opsi-client-agent']   (set_action_request_worker.py:105)
[5] [2022-10-28 13:03:24.169] [               ] Setting 'setup' ProductActionRequest: opsi-client-agent -> test-1.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:03:24.170] [               ] Setting 'setup' ProductActionRequest: opsi-client-agent -> test-2.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:03:24.170] [               ] Setting 'setup' ProductActionRequest: opsi-client-agent -> test-3.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:03:24.170] [               ] Setting 'setup' ProductActionRequest: opsi-client-agent -> test-4.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:03:24.170] [               ] Setting 'setup' ProductActionRequest: opsi-client-agent -> test-5.domain.tld   (set_action_request_worker.py:134)
----

In addition to a group of clients, you can also define a group of products (here: `testproducts`) behind `--product-groups`:

[source,console]
----
opsi-cli -l5 client-action --client-groups testclients set-action-request --product-groups testproducts

[5] [2022-10-28 13:05:53.147] [               ] Selected clients: ['test-1.domain.tld', 'test-2.domain.tld', 'test-3.domain.tld', 'test-4.domain.tld', 'test-5.domain.tld']   (client_action_worker.py:48)
[5] [2022-10-28 13:05:53.225] [               ] Handling products ['hwaudit', 'opsi-client-agent', 'swaudit']   (set_action_request_worker.py:105)
[5] [2022-10-28 13:05:53.236] [               ] Setting 'setup' ProductActionRequest: hwaudit -> test-1.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.237] [               ] Setting 'setup' ProductActionRequest: opsi-client-agent -> test-1.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.237] [               ] Setting 'setup' ProductActionRequest: swaudit -> test-1.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.237] [               ] Setting 'setup' ProductActionRequest: hwaudit -> test-2.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.237] [               ] Setting 'setup' ProductActionRequest: opsi-client-agent -> test-2.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.238] [               ] Setting 'setup' ProductActionRequest: swaudit -> test-2.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.238] [               ] Setting 'setup' ProductActionRequest: hwaudit -> test-3.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.238] [               ] Setting 'setup' ProductActionRequest: opsi-client-agent -> test-3.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.238] [               ] Setting 'setup' ProductActionRequest: swaudit -> test-3.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.239] [               ] Setting 'setup' ProductActionRequest: hwaudit -> test-4.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.239] [               ] Setting 'setup' ProductActionRequest: opsi-client-agent -> test-4.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.239] [               ] Setting 'setup' ProductActionRequest: swaudit -> test-4.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.239] [               ] Setting 'setup' ProductActionRequest: hwaudit -> test-5.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.239] [               ] Setting 'setup' ProductActionRequest: opsi-client-agent -> test-5.domain.tld   (set_action_request_worker.py:134)
[5] [2022-10-28 13:05:53.240] [               ] Setting 'setup' ProductActionRequest: swaudit -> test-5.domain.tld   (set_action_request_worker.py:134)
----

`opsi-cli` automatically excludes a list of certain packages with the two parameters `--where-outdated` and `--where-failed`. Currently these are `opsi-winst`, `opsi-auto-update`, `opsi-script`, `shutdownwanted`, `windows10-upgrade`, `activate-win`, `opsi-script-test`, `opsi-bootimage-local`, `opsi-uefi-netboot`, `opsi-wan-config-on`, `opsi-wan-config-off`, `opsi-winpe`, `win10-sysprep-app-update-blocker` and `windomain`. 

TIP: While it is easily possible to exclude other products or product groups, it is even safer to maintain a separate product group and specify this when calling it up. This allows you to restrict changes to just this group.

[[server-components-opsi-cli-commands-plugin]]
==== *plugin*

All `opsi-cli` commands are implemented as plugins, including the `plugin` command itself. You use it to manage plugins, i.e. to install new external plugins or to remove running plugins from the system. You can also use `opsi-cli plugin` to list or export plugins.

[source,console]
----
opsi-cli plugin --help
----

image::opsi-cli-plugin-help.png["Output: opsi-cli plugin --help", pdfwidth=80%]

How to generate a template for a new plugin:

[source,console]
----
opsi-cli plugin new
----

After you have entered the name, version and description, `opsi-cli` creates a new directory with the selected name. This directory contains the subdirectories `python` and `data`:

* You can store the code for the new plugin in the `python` directory. The directory represents a Python package and contains a `__init__.py` file as a starter. Here you will find an example of a command, a subcommand and some options.

* The `data` directory contains static resources for the plugin; you can normally ignore it.

After you have filled the template with content, add the plugin to the running `opsi-cli` instance:

[source,console]
----
opsi-cli plugin add <directory>
----

If the specified directory contains valid Python code, the contained command is then available as a plugin in `opsi-cli`. 

TIP: To display all registered plugins, enter the command `opsi-cli plugin list`.

You can export a plugin to an archive and then import it into another `opsi-cli` instance:

[source,console]
----
opsi-cli plugin export <name>
opsi-cli plugin add <archive>
----

Use these commands to convert a directory into an archive and vice versa:

[source,console]
----
opsi-cli plugin compress <directory>
opsi-cli plugin extract <archive>
----

NOTE: To subsequently change an imported plugin, unpack it with the `extract` command, adjust the contents of the directory and call `opsi-cli plugin add <directory>` again. This will overwrite the existing plugin with the same name.

To remove a plugin from an `opsi-cli` instance, call the following command:

[source,console]
----
opsi-cli plugin remove <name>
----

[[server-components-opsi-cli-commands-self]]
==== *self*

You use the `self` command to manage the `opsi-cli` instance. This includes (de)installing `opsi-cli` on the system, activating autocomplete and displaying the command structure.

[source,console]
----
opsi-cli self --help
----

image::opsi-cli-self-help.png["Output: opsi-cli self --help", pdfwidth=80%]

You can install `opsi-cli` on your system using the `opsi-cli` binary. To do this, execute the command `opsi-cli self install`. During installation, the binary program is copied to a globally available location (or included in the PATH under Windows) and a configuration file is created. You decide whether the `opsi-cli` installation should be user-specific or system-wide (option `--system`). To uninstall, use the command `opsi-cli self uninstall`.

TIP: If you install the opsi package `opsi-cli` or the `opsi-utils` on a client, the step `opsi-cli self install` is omitted.

To display the command structure including all commands, their version number and the subcommands, enter the command `opsi-cli self command-structure`.

image::opsi-cli-self-command-structure.png["Output: opsi-cli self command-structure", pdfwidth=80%]

The `opsi-cli` auto-completion works for commands, subcommands and options. To set it up, enter this command:

[source,console]
----
opsi-cli self setup-shell-completion
----

The feature currently works on three different shells: Bash, ZSH and Fish. After restarting the active shell or after a new login, you can use tab completion in the same way as in conventional Unix shells. Press [Tab] [Tab] to show all available options or commands (depending on the context). This is how [Tab] [Tab] behaves in different situations:

* After `opsi-cli` or any command that has at least one subcommand, you will see a list of available (sub)commands.
* After `-` you will see available options for the current command or `opsi-cli` itself.
* After a subcommand, the possible values for the arguments appear:
        - For the subcommands `set`, `show` and `unset` of `opsi-cli config`, [Tab] [Tab] shows a list of all available configurations that are affected.
        - For `opsi-cli jsonrpc execute`, a list of available methods is displayed (filtered by a specified prefix).

[[server-components-opsi-cli-commands-support]]
==== *support*

The `opsi-cli support` command helps to analyze and solve problems in your opsi environment. At the moment there is only one subcommand: `opsi-cli support health-check` checks various aspects that can affect the smooth running of an opsi environment and compiles a report.

image::opsi-cli-health-check.png["Output: opsi-cli support health-check", pdfwidth=80%]

The following example shows a compact representation of the report. Without restricting the attributes (`--attributes=id,status,message`), it shows more detailed information on the warnings (`warnings`) and error messages (`errors`):

[source,console]
----
opsi-cli --attributes=id,status,message support health-check
----

[[server-components-opsi-cli-commands-terminal]]
==== *terminal*

The command `opsi-cli terminal` starts a simple terminal client that you can use to establish a connection to opsi servers. It works in a similar way to SSH or PuTTY. For the opsi server to be contacted, enter either the FQDN or the opsi host ID. 

You can also use this command to address the opsi config server:

[source,console]
----
opsi-cli terminal configserver
----

As soon as you close the terminal (command `exit` or key combination [Ctrl]+[D]), the connection is terminated.
