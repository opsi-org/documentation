////
; Copyright (c) uib GmbH (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: http://www.opsi.org/credits/
////

:Author:    uib GmbH
:Email:     info@uib.de
:Date:      28.02.2024
:Revision:  4.3
:toclevels: 6
:doctype:   book
:icons:     font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]

[[opsi-softwintegration-tutorial-modify-with-opsi-packagebuilder]]
== opsi PackageBuilder: Modifying a Script

Launch the opsi PackageBuilder (oPB) from the start menu. If you encounter difficulties (particularly when using a KDE desktop environment), you might need to start the program from a terminal instead. Simply input any path, and if an error message appears indicating that the path was not found, acknowledge it to proceed:

[source,console]
----
opsipackagebuilder --path /home
----

When you start opsi PackageBuilder for the first time, it will be in offline mode because it hasn't yet established a connection with the opsi server:

.opsi PackageBuilder: First Start in Offline Mode
image::opb_firststart.png["opsi PackageBuilder: First Start in Offline Mode", pdfwidth=80%]


[[opsi-softwintegration-tutorial-modify-with-opsi-packagebuilder_config]]
=== Initial Configuration

To set up the opsi PackageBuilder, click on the _Settings_ button. 

Configure the following on the _General_ tab:

* _Config server_: Input the fully qualified domain name (FQDN) of your opsi config server, such as `\opsi.mycompany.org`.

* _opsiadmin User_: Enter the username of an administrator with access to the opsi service. This account should be a part of the `opsiadmin` group (refer to the section xref:server:components/authorization.adoc#server-components-authorization-users-and-groups[Users and Groups]).

* _opsiadmin Password_: Provide the corresponding password for the opsiadmin user. This password will be encrypted and is not visible. It's essential for the opsi PackageBuilder to communicate with the opsi server.

* _4.0.4 or newer_: Activate this checkbox.

* _SUDO without password_: This is the default setting; accept it as it is.

* _Package maintainer_: Enter your full name. This will be included in the changelogs.

* _Mail address_: Provide your email address here; it will also be featured in the changelogs.

.oPB Settings: *General* Tab
image::opb_conf_general.png["oPB Settings: *General* Tab", pdfwidth=80%]

On the _Program_ tab, configure the following settings:

* Activate the checkbox _Extended changelog editor_.

* Select a _Development folder_; enter the full path to the directory in which the opsi packages are to be created. Ideally, this is the path to the mounted share with the opsi workbench. Optionally, you can select _Use existing network drive_.

* _Script eEditor_: Choose the text editor for script editing according to your operating system:

  - Windows: Accept the default setting (path to the oPB ScriptEditor).
  - Linux: Path to the editor, e.g. `/usr/bin/jedit`; leave the _Editor command line options_ field empty.
  - macOS: Path to the editor, e.g. `/Application/jedit`; _Editor command line options_ field remains empty.

.oPB Settings: *Program* Tab
image::opb_conf_program.png["oPB Settings: *Program* Tab", pdfwidth=80%]

On the _opsi Commands_ tab, adjust the following setting, which *deviates from the default configuration*:

* _Build command_: We recommend the following command: +
`opsi-makepackage -v`

* Activate the checkbox _Use depot functions_.

.oPB Settings: *opsi Commands* Tab
image::opb_conf_commands.png["oPB Settings: *opsi Commands* Tab", pdfwidth=80%]

Save the settings and restart the opsi PackageBuilder. After restarting, the program should switch to online mode.

.opsi PackageBuilder: Start in Online Mode
image::opb_start.png["opsi PackageBuilder: Start in Online Mode", pdfwidth=80%]

[[opsi-softwintegration-tutorial-modify-with-opsi-packagebuilder_use]]
=== Install, modify and pack packages with the opsi PackageBuilder.

.opsi PackageBuilder Start
image::opb_start.jpg[Start, pdfwidth=80%]

Use _Open package (F2)_ and select the directory in which you have created with the `opsi-setup-detector` a package. (e.g.: w:\newprod2 ) +
The product window opens with different tabs. The default tab is _Package_.

.opsi PackageBuilder Package Tab
image::opb_tab_product.jpg[Package Tab, pdfwidth=80%]

In this tab you see on the left side the general metadata of the opsi product as you have already been explained in <<opsi-setup-detector-product-configuration1>>.

On the right side you see the script files and next to it the button:

.opsi PackageBuilder Edit button
image::opb_btnSkriptEdit.png["Edit button", pdfwidth=40%]

With the button you can invoke the file in the script editor specified in the configuration and modify the script. On Windows this is the script editor of the opsi PackageBuilder.

.opsi PackageBuilder Script editor under Windows
image::opb_ScEdit.jpg["Script editor", pdfwidth=80%]

Key features:

* Color syntax highlighting.

* "Folding" of source code (optional: compact, with comments)

* Lexical definition customizable (to do this, the editor must be invoked via start menu entry)

* Autocomplete for syntax elements and variables

* Freely definable and reusable code blocks ("snippets")

The core component of the editor is the module Scintilla, which is also used in other well known editors, such as Notepad++. The lexical elements (syntax highlighting and folding) for the representation of the script language valid for opsi are however completely written in AutoIt, since Scintilla does not supply its own representation module for opsi scripts. Because AutoIt is an interpreter language, it's slower than other editors and is therefore only conditionally suitable for editing very large scripts, especially when source code convolution is switched on. In the settings, however, it's possible to specify whether the editor is invoke with these functions or not, provided that the call is made directly via the script tree. If the editor is open via the link in the start menu, syntax highlighting and convolution are generally switched off at startup and can be activated via the editor menu "View".

(The editor can also be open via the command line. More information about the possible command line parameters can be check with the "-help" option).

.opsi PackageBuilder Product variables tab (Properties)
image::opb_tab_property.jpg[Product variables tab (Properties), pdfwidth=80%]

In this tab you see on the left side the product properties of the opsi product like they are already explained in
<<opsi-setup-detector-product-configuration-properties-config>>.

.opsi PackageBuilder Dependencies tab
image::opb_tab_dependencies.jpg[Dependencies tab,width=150]

In this tab you can see on the left side the product dependencies of the opsi product like they are already explained in
<<opsi-setup-detector-product-configuration-priority_dependency>>.

Buttons at the bottom of the window:

[cols="4,16"]
|====
|Button | Description

|image:opb_btnPacken.png[] | Starts an SSH connection from the server and executes the packaging command there. (see also chapter: <<opsi-softwintegration-create-opsi-package-makeproductfile>>).
|image:opb_btnInstallieren.png[] | Starts an SSH connection from the server and executes the installation command there to install the product on the server (see also chapter: <<opsi-softwintegration-create-opsi-package-manager>>).
|image:opb_InstSetup.jpg[] | *Do not use it!* Like _install_ and in addition the product will be switched to _setup_ on every client where it is _installed_.
|====


////
.opsi PackageBuilder Button: Pack
image::opb_btnPacken.png[Button: Pack,width=50]

This button starts an SSH connection from the server and executes the packaging command there. +
You can also do the same in a terminal itself as described in
<<opsi-softwintegration-create-opsi-package-makeproductfile,Packing with opsi-makepackage>>

.opsi PackageBuilder Button: Install
image::opb_btnInstallieren.png[Button: Install,width=50]

This button starts an SSH connection from the server and executes the installation command there to install the product on the server. +
You can also do the same in a terminal itself as described in
<<opsi-softwintegration-create-opsi-package-manager, Installing with opsi-package-manager>>


.opsi PackageBuilder Button: Installieren + Setup
image::opb_InstSetup.jpg[Button: Installieren + Setup,width=50]

Do not use it!
////
