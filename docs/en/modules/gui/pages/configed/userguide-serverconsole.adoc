////
; Copyright (c) uib GmbH (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: https://www.opsi.org/credits/
////

:Author:    uib GmbH
:Email:     info@uib.de
:Date:      13.11.2023
:Revision:  4.3
:toclevels: 6
:doctype:   book
:icons:     font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]

[[opsi-manual-configed-serverconsole]]
= Server Console

You can initiate actions on the opsi server from `opsi-configed` using an SSH connection through the _Server console_ menu option. When you click on this menu item, you can first check if you are already connected to the server via SSH (_Start SSH connection directly_ checkbox in the login dialog). Below this, there are options to update the SSH connection details and to modify the predefined command line commands listed under the _opsi_ menu item. Hover your mouse over an entry to see a tooltip with more information.

.*opsi-configed*: Server Console Menu
image::configed_serverkonsole.png["opsi-configed: Server Console Menu", width=800, pdfwidth=80%]

[[opsi-manual-configed-serverconsole-ssh]]
== SSH Connection Data

`opsi-configed` defaults to using the currently logged-in user's credentials for the opsi-configserver to establish the SSH connection. Through the _Server console_ menu, selecting _SSH connection data_ opens a dialog where you can enable the _Use SSH key for authentication_ checkbox and select an SSH key to upload. If the key is protected by a passphrase, enter it in the provided field.

.*opsi-configed*: SSH Connection Data
image::configed_ssh.png["*opsi-configed*: SSH Connection Data", pdfwidth=80%]

Alternatively, you can specify the SSH key and passphrase at startup using the following two parameters (refer to the section xref:gui:configed/userguide.adoc#opsi-configed-start-parameter[Start Parameters]):

* `--ssh-key <path-to-key>`, e.g. `--ssh-key /home/user/.ssh/id_rsa`
* `--ssh-passphrase <passphrase>`

[[opsi-manual-configed-serverconsole-permissions]]
== Authorizations

You can manage visibility of menu items and user permissions through server host parameters (see section xref:gui:configed/userguide-server.adoc#opsi-manual-configed-hostproperties-server[Server Host Parameters]). If the opsi extension xref:opsi-modules:user-roles.adoc[User Roles] is activated, you can specify authorizations for various user accounts, with default values set for new accounts.

Available entries include:

[source,console]
----
user.{}.ssh.serverconfiguration.active
user.{}.ssh.commandmanagement.active
user.{}.ssh.menu_serverconsole.active
user.{}.ssh.commands.active
----

They mean:

* Activates the menu for SSH connection settings (default: `false`).
* Enables editing of command line command menu entries (default: `false`).
* Enables the main menu entry _Server console_ (default: `true`).
* Enables all SSH menu entries representing stored commands (default: `true`).

[[opsi-manual-configed-serveractions-parametercommands]]
== Pre-defined Commands

The menu _Server console_ / _opsi_ contains pre-defined command line commands that perform the following actions:

* _opsi-package-updater_: Install or update packages with the xref:server:components/commandline.adoc#server-components-opsi-package-updater[*opsi-package-updater*]. In the dialog that opens, select either _Update packages_ , _List all repositories_ or _Install packages_ from the _Action_ drop-down menu. You can select the package repository in the drop-down menu below.

* _Install package_: Install opsi packages with the xref:server:components/commandline.adoc#server-components-opsi-package-manager[*opsi-package-manager*] on one or more depots. You can either enter the local path to a package or download one from the internet.

* _Uninstall package_: Select one or more packages you want to uninstall with the `opsi-package-manager`.

* _Pack opsi package_: Specify a directory on the server that contains files for an opsi package. You can use a button to display the versions found in the `control` file (package and product version) and overwrite them if necessary. Click on _Advanced settings_ to display checkboxes that you can use to create Zsync or Md5 files and set the subsequent permissions. The button _Install the built package_ invokes the `opsi-package-manager`.

* _Download a file_: Download any file from the Internet using `wget` and place it on the server in the directory of your choice.

* _Upload module file_: Upload an activation file for opsi extensions to the server. Select the file from your local machine or download it with `wget`. If necessary, you can enter credentials fot the `wget` command.

* _Set opsi rights_: Corrects the access rights of files and directories on an opsi server by invoking the xref:server:components/commandline.adoc#server-components-opsi-set-rights[*opsi-set-rights*] command.

* _Deployment of opsi client agent_: To include existing computers as clients in the opsi environment, the client agent must be installed on them. Here you can select the machines. To execute the command on several clients simultaneously, the login data on these machines must be the same.

NOTE: The script for deploying the clients must be located in the `/var/lib/opsi/depot/opsi-client-agent` directory and be called `opsi-deploy-client-agent` (see chapter xref:first-steps:clients/client-installation.adoc[Adding Clients]).

Some of the dialogs (e.g. _Set opsi rights_ or _Install package_) contain buttons to select local files. Press the _Find subfolders_ button to list all files and directories from the specified path. To include more layers, press the button multiple times.

[[opsi-manual-configed-serverconsole-commandcontrol]]
== Befehle definieren

Sie können über den Eintrag _Befehle definieren_ auch eigene Kommandozeilenbefehle definieren, die sie dann über das Menü _Server-Konsole_ erreichen. 

NOTE: Beachten Sie, dass nicht alle Linux-Distributionen dieselben Befehle bzw. Parameter verwenden. Stellen Sie als Administrator sicher, dass die Distribution für den opsi-Server die Kommandos unterstützt.

.*opsi-configed*: Befehle definieren
image::configed_serverkonsole-defcommands.png["*opsi-configed*: Befehle definieren", width=800, pdfwidth=80%]

Sie können die folgenden Angaben im Dialog _Befehle bearbeiten_ machen:

* _Menütext des Befehls_: Der Menüeintrag muss eindeutig sein und darf nicht an anderer Stelle verwendet werden. Um einen Menütext zu ändern, löschen Sie den Befehl über das Icon mit dem Minuszeichen und erstellen dann einen neuen Befehl. (obligatorische Einstellung)

* _Übergeordnetes Menü_: Legt fest, in welchem Menü der neue Befehl als Menüeintrag erscheinen soll. Lassen Sie das Feld leer, erscheint er automatisch im Menü _Server-Konsole_. (optionale Einstellung)

* _Beschreibung_: Hinterlegen Sie hier eine Beschreibung, dann taucht sie als Tooltip-Text des Befehls auf. (optionale Einstellung)

* _Position im Menü_: Die Position bestimmt die Reihenfolge (kleine Zahlen zuerst) der Menüpunkte insgesamt und damit innerhalb des jeweiligen Menüs. (optionale Einstellung)

* _Root-Rechte benötigt_: Aktivieren Sie die Checkbox, wenn ein Kommando administrative Rechte benötigt. (optionale Einstellung)

* _Befehlsliste_: Tragen Sie hier die Linux-Befehle ein, einen pro Zeile, um sie nacheinander aufzurufen. (obligatorische Einstellung)

* Über das Drop-down-Menü _Als Parameter in Befehl einfügen_ stehen verschiedene optionale Datenquellen für die Befehlsliste zur Verfügung:
  - Interaktive Eingabe: Parameter nicht fest vorgeben, sondern interaktive Eingabe in der Form `<<<"Interaktive Eingabe">>>`, wobei wir empfehlen, eine Beispieleingabe zu notieren.
  - Configserver
  - IP-Adressen der ausgewählten Clients
  - IP-Adressen der ausgewählten Depots
  - Namen der ausgewählten Clients
  - Namen der ausgewählten Depots
  - Optionen für Skript auswählen
  - Verbundener SSH-Server

NOTE: Außer bei der interaktiven Eingabe kann die Rückgabe der Methoden formatiert werden, beispielsweise als durch Kommata voneinander getrennte Liste. 

.*opsi-configed*: Befehl ausführen, Parameterabfrage
image::configed_serverkonsole-exec.png["*opsi-configed*: Befehl ausführen, Parameterabfrage", width=800, pdfwidth=80%]

TIP: Operatoren wie AND (`&&`), `||` (OR), das Pipezeichen (`|`) sowie Umleitungsoperatoren (`>`, `<` und `>>`) für die Linux-Befehle sind erlaubt. Beachten Sie, dass keine Benutzereingaben während der Ausführung möglich sind. Kombinieren Sie zwei Befehle und erfordert das erste Kommando Root-Rechte, aktivieren Sie die erwähnte Checkbox; erfordert das zweite ebenfalls Root-Rechte, notieren Sie `sudo` im Befehl:

[source,console]
----
apt-get update --yes && sudo apt-get upgrade --yes
----
