////
; Copyright (c) uib gmbh (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
; 
; credits: http://www.opsi.org/credits/
////

:Author:    uib gmbh
:Email:     info@uib.de
:Date:      11.01.2021
:doctype: book

include::common:partial$opsi_terms.adoc[]


[[opsi-manual-localimage]]
= _opsi local image_

[[opsi-manual-localimage-preconditions]]
== Requirements for the opsi extension _opsi local image_

This module is currently a
link:https://www.opsi.org/product/extensions-of-opsi/[cofunding project]. +
Some conditions have to be met to use this module. This means that you need an activation file to use it. You will receive this activation if you buy the extension. For evaluation purposes, we also provide a time-limited activation free of charge (-> mail to info@uib.de). +

Further details can be found in xref:modules/modules.adoc#opsi-manual-modules[opsi Extensions].

With the permission to use opsi-local-image you also acquire the right to use the extension opsi-vhd-reset (see xref:modules/vhd.adoc#opsi-manual-vhd[opsi vhd reset]).

A technical requirement is opsi 4.0.3 with package versions:

.Required packages
[options="header"]
|==========================
|opsi package|version
|opsi-linux-bootimage|>= 20130207-1
|==========================

CAUTION: For the product `opsi-local-image-capture` the share `opsi_depot_rw` must have write permission for 'pcpatch'. Check your Samba configuration.


[[opsi-manual-localimage-introduction]]
== Introduction

Opsi offers a good basis for the automated installation and maintenance of Windows computers - especially when it comes to heterogeneous hardware. The package-based installation technology supported by opsi is not fast enough to use computers in training rooms within a short time, e.g. to put it back into a defined state during a break between two courses. Therefore, a concept is presented here in which the package-based installation is saved locally on a second partition as an image copy and from there a quick recovery is possible.

. Initial installation finishing with a local image backup
. Fast recovery based on different techniques
. System maintenance finishing with a local image backup
. Integration of capturing of existing installations to WIM
. Integration of Linux clients in the Backup/Restore process.

[[opsi-manual-localimage-concept]]
== Concept

The requirements of educational computer networks differ in part from those of other networks. An essential requirement, which is discussed in the following part, is the quick restoration of computers to a defined state, which has been changed because of a temporary use. Specifically, it is about the provision of computers in class rooms, whereby the problem also applies to commercial computer rooms or university computer pools.

The restore should take place within a short time (approx. 15 minutes) and should, as far as possible, not only 'reset' a computer but also switch to another base installation (e.g. Win XP / Win 7 / Linux). +
It must also be possible to ensure that the systems are continuously updated with security updates.

The usual techniques for installing PCs have several specific advantages and disadvantages:

.Advantages and disadvantages of unattended and image based solutions
[options="header"]
|==========================
| Feature | Unattend | Image
| Performance | (-) slow | (+) fast
| Sensitivity to heterogenous Hardware | (+) low | (-) high
| Network load | (-) high | (-) high
|==========================

The concept of opsi-local-image tries to combine the advantages of both approaches:

.opsi-local-image
[options="header"]
|==========================
| Feature | Unattend
| Performance | (+) fast
| Sensitivity to heterogeneous Hardware | (+) low
| Network load | (+) low
|==========================

The concept can be summarized in the following key points:

* Initial Windows installation via PXE boot, package-based with individual driver integration using the opsi-Linux-Bootimage

* Store this initial installation in a backup image on another partition on the local hard drive using the opsi-Linux-Bootimage

* Quick restore the productive installation from the local image using the opsi-Linux-Bootimage

* Maintenance of the local installation (security updates) via the opsi software distribution and backup of the updated system to the local backup image using the opsi-Linux-Bootimage

[[opsi-manual-localimage-concept-technical]]
== Technical Concept

The workstation is used with a static partition table. You can work with either 3 or 4 partitions:

* Partition 1 (System) +
Holds the currently used operating system (Windows / Linux) +
The size of this partition is set during partitioning via a property of the product `opsi-local-image-prepare`.

* Optional: Partition 2 (sysdata) +
This can be for example be used to store user data, which is not overwritten during a restore. The formatting is NTFS. +
The size of this partition is set during partitioning via a property of the product `opsi-local-image-prepare`.

* Partition 3 (winpe / swap) +
The size of this partition is static and set to 4GB. +
This partition is not used on Windows XP. +
On NT6 (Windows 7) this partition is used for the winpe required during installation and is not visible during normal operation. +
On Linux this partition is used as swap.

* Partition 4 (backup) +
This partition is used to store the backup images and their metadata. +
The size of this partition is the free space still available after the other partitions have been created.

The netboot products for operating system installations use only the first two or three partitions (XP uses only the first) and leave the last backup partition untouched. This means that the images on partition 4 (backup) are retained even when installing a new operating system.

[[opsi-manual-localimage-proceedings]]
== Process steps

[[opsi-manual-localimage-proceedings-initial]]
=== Initial Installation

The necessary static partitioning is first created using the product `opsi-local-image-prepare`.

.schema: static partitioning with opsi-local-image-prepare
image::oli-prepare.png["schema: static partitioning with opsi-local-image-prepare", width=332]

Then the products `opsi-local-image-win*` or others can be used to install several operating systems with different configurations and different application software.

.schema: OS installation with opsi-local-image-win*
image::oli-os-install.png["schema: OS installation with opsi-local-image-win*", width=332]

By default, these are automatically saved as an image after installation.

.schema: image backup with opsi-local-image-backup
image::oli-backup-1.png["schema: image backup with opsi-local-image-backup", width=332]


[[opsi-manual-localimage-proceedings-restore]]
=== Restoring an image

Executing the product `opsi-local-image-restore` automatically restores the last created image. If a different image is to be restored, this has to be specified in the property `imagefile`.

.schema: image restore with opsi-local-image-restore
image::oli-restore-image.png["schema: image restore with opsi-local-image-restore", width=332]

[[opsi-manual-localimage-proceedings-delete]]
=== Deleting an image

.Schema: Deleting an Image
image::oli-delete-image.png["Schema: Deleteing an Image", width=332]

By executing the product `opsi-local-image-delete`, the image specified in the property `imagefile` will be deleted.

[[opsi-manual-localimage-proceedings-update]]
=== Updating an image: automatic work flow with opsi-auto-update

.Schema: Automatic upgrade of a saved image
image::oli-image-upgrade-flow.png["Schema: Automatic upgrade of a saved image", width=332]

`opsi-auto-update` is a product to simplify the maintenance of the clients.

In essence, this product can be used to ensure that the installed products are up to date. +
The product sets all installed products,
whose version is not identical to that on the server,
for the client to setup.

Since this product can not only be used in the context of 'opsi-local-image', it is described in the chapter 'opsi standard products' / 'opsi-auto-update': +
xref:products/localboot-products#opsi-manual-localboot-opsi-auto-update[opsi-auto-update]

[[opsi-manual-localimage-components]]
== The opsi-local-image products

The opsi-local-image products from version 4.1 also support systems with more than one harddisk. Please also note the section xref:products/netboot-products.adoc#opsi-manual-netboot-nt6[Some hints to the NT6 netboot products ]

The 'opsi-local-image' package consists of the following products

The netboot product for partitioning

* `opsi-local-image-prepare`

The netboot products for OS installation:

* `opsi-local-image-winxp`
* `opsi-local-image-win7`
* `opsi-local-image-win7-x64`
* `opsi-local-image-win81`
* `opsi-local-image-win81-x64`
* `opsi-local-image-win10`
* `opsi-local-image-win10-x64`

* `opsi-local-image-ubuntu`


The netboot products for handling the local images

* `opsi-local-image-backup`
* `opsi-local-image-restore`
* `opsi-local-image-delete`

The localboot products for process control:

* `opsi-local-image-backup-starter`
* `opsi-auto-update`


To install these products please set the attribute *active* of the repository *uib_local_image* in the file `/etc/opsi/package-updater.repos.d/uib-local_image.repo` to 'True'.
Executing `opsi-package-updater --repo uib_local_image install` will then install the new products.


[[opsi-manual-localimage-components-uefi]]
=== UEFI Compatibility

The opsi-local-image products are compatible with UEFI.



[[opsi-manual-localimage-components-part]]
=== netboot product for partitioning

* `opsi-local-image-prepare` +
Creatopm of the static partitioning of the harddisk for all other products. +
Properties:

ask_before_inst::
Determines if the start of the installation has to be confirmed on the client. (Default='true')
system_partition_size::
Determines the size of partition 1 (system). (Default = 30G)
data_partition_size::
Determines the size of partition 2 (data). If set to '0G', no partition will be created for data. (Default = 0G)
start_os_installation::
The product to install an operating system can be selected here, which is started automatically after the partitioning.
When installing any of these products, the product properties 'imagefile' and 'imagefiles_list' are deleted for the product `opsi-local-image-restore`, as this data has become invalid due to the repartitioning.
delay_for_reboot::
Seconds between the end of the script and the reboot to give the server time to create the netboot pipes.
minimal_backup_partition_size::
This property is used to check if the size entries make sense. +
The size of the backup partition results from: +
Harddisk size - (`system_partition_size` + `data_partition_size` + `winpe_partition_size`). +
Usually opsi-local-image is used because a local backup of the system partition is to be made. This requires that there is enough space for the backup partition. If, during the calculation of the partitioning, it is determined that the remaining space for the backup partition is smaller than the value of `minimal_backup_partition_size`, the process is aborted. +
(Default=55%)
winpe_partition_size:: Size of the winpe partition (Default=4G)
multi_disk_mode:: This property is used to select the target disk of the installation. +
Possible values are: "0", "1", "2", "3", "prefer_ssd", "prefer_rotational" +
The values "0", "1", "2", "3" indicate the direct index of the harddisk ("0"= first harddisk) +
The value "prefer_ssd" selects the first SSD. +
The value "prefer_rotational" selects the first classic (rotational) disk. +
This property is ignored on systems with only one disk. +
Default = "0"

backup_partition_on_same_disk::
true : create the backup partition on the system disk. false : create the backup partition on the first disk that is not the system disk. +
This property is ignored on systems with only one disk. +
Default = "true"



IMPORTANT: Use this product only for the initial preparation of the disk. It deletes all existing images.

[[opsi-manual-localimage-components-win]]
=== netboot products for the installation of Windows

The special netboot products for installing Windows are derived from the opsi standard products for installing Windows. Specifically, this means that they are identical in terms of structure and driver integration. Corresponding instructions can be found in the 'opsi-getting-started' manual.

The properties of the Windows NT6 products from version 4.1 are a subset of the properties of the standard NT6 products as described in the xref:products/netboot-products.adoc#opsi-manual-netboot-nt6[Some hints to the NT6 netboot products ] section. The missing properties for disks and partitions are taken from the product `opsi-local-image-prepare`.

ATTENTION:: Do not change the property values of opsi-local-image-prepare after you have prepared the machine with it, as subsequent products will access these values.

* `opsi-local-image-winxp` +
Installation of Windows XP. Uses the first partition only.
Administrator password is empty.

* `opsi-local-image-win7` +
Installation of Windows7 32 Bit.

* `opsi-local-image-win7-x64` +
Installation of Windows 7 64 Bit.

* `opsi-local-image-win81` +
Installation von Windows 8.1 32 Bit.

* `opsi-local-image-win81-x64` +
Installation von Windows 8.1 64 Bit.

* `opsi-local-image-win10` +
Installation von Windows 10 32 Bit.

* `opsi-local-image-win10-x64` +
Installation von Windows 10 64 Bit.

These products have the following specific properties for 'opsi-local-image':

* 'backup_after_install' with the default value 'true'. In this case, this means that after the OS installation, the application software is first installed and then an image backup of the installation is created. Furthermore, the value of the `imagefile` of the product `opsi-local-image-restore` will be deleted. This means that the created backup will be named like the running netboot product (e.g. `opsi-local-image-win7`).

* 'setup_after_install' +
One or more products can be specified here, which are set to 'setup' after the operating system installation is complete. The dependencies of these products are also resolved.

[[opsi-manual-localimage-components-linux]]
=== Netboot products for installing Linux

* `opsi-local-image-ubuntu` +
Installation of Ubuntu Linux 12.04/14.04 32Bit/64Bit. +
The installed system has two users: `root` and `user`. The password for 'root' will be set according to the product property `root_password` (default: `linux123`). For 'user' the password will be set according to `user_password` (default: `linux123`).
Details of the installation can be configured with product properties. The main product properties are:
** `askbeforeinst`: +
Determines if the start of the installation has to be confirmed on the client. (Default='true')
** `architecture`: +
Architecture selection, determines the selection of the bootimage and the installation architecture. (Default='64bit')
** `additional_packages`: +
Which additional packages should be installed? Specification of packages separated by spaces. (Default = pass: [''])
** `language`: +
Determines which language / locale should be installed. (Default='de')
** `console_keymap` +
Determines which keyboard layout should be installed.  (Default='de-latin1-nodeadkeys')
** `timezone`: +
Determines which timezone should be used. (Default='Europe/Berlin')
** `online_repository` +
Specifies from which online repository the packages should be installed. The default is 'http://de.archive.ubuntu.com/ubuntu'
** `proxy`: +
Proxystring (if required) with the following syntax: `http://<ip>:<port>`  (Default = pass:[''])
** `backup_after_install` +
('true'/'false') Default = 'true'. After the installation, an image backup of the installation is created.
** `setup_after_install` +
One or more products can be specified here, which are set to 'setup' after the operating system installation is complete. The dependencies of these products are also resolved.
** `wget_and_execute`: +
Url (http) of a file which is fetched and executed at the end of the installation. (Default = pass: [''])
** `release`: +
Determines which release of Ubuntu should be installed. (Default = "trusty")
** `install_opsi-client-agent`: +
Specifies if the Linux opsi-client-agent should be installed. (this is a cofunding project and requires activation via /etc/opsi/modules). (Default='false')
////
* `opsi-local-image-opensuse13-2` +
Installation of OpenSuse Linux 13.2 32Bit/64Bit. +
The installed system has two users: `root` and `user`. The password for 'root' will be set according to the product property `root_password` (default: `linux123`). For 'user' the password will be set according to `user_password` (default: `linux123`).
Details of the installation can be configured with product properties. The main product properties are:
** `askbeforeinst`: +
Determines if the start of the installation has to be confirmed on the client. (Default='true')
** `architecture`: +
Architecture selection, determines the selection of the bootimage and the installation architecture. (Default='64bit')
** `language`: +
Determines which language / locale should be installed. (Default='de')
** `console_keymap` +
Determines which keyboard layout should be installed.  (Default='de-latin1-nodeadkeys')
** `timezone`: +
Determines which timezone should be used. (Default='Europe/Berlin')
** `partition_disk`: +
Which disk should be used? (Default='first')
** `proxy`: +
Proxystring (if required) with the following syntax: `http://<ip>:<port>`  (Default = pass:[''])
** `backup_after_install` +
('true'/'false') Default = 'true'. After the installation, an image backup of the installation is created.
** `setup_after_install` +
One or more products can be specified here, which are set to 'setup' after the operating system installation is complete. The dependencies of these products are also resolved.
** `install_opsi-client-agent`: +
Specifies if the Linux opsi-client-agent should be installed. (this is a cofunding project and requires activation via /etc/opsi/modules). (Default='false')
////

[[opsi-manual-localimage-components-backuprestore]]
=== Netboot products for backup and restore

* `opsi-local-image-backup` +
This product backs up the operating system currently installed on partition 1 in an image file on partition 4. The name set in the product property is used as the name for the image. If this is empty, the name of the opsi netboot product is used, which is currently set to 'installed' (e.g. `opsi-local-image-winxp`). This name is set for the product `opsi-local-image-restore` as the product property 'imagefile', so that a subsequent call to` opsi-local-image-restore` will restore exactly this image by default. This name is added to the product property 'imagefiles_list' for the product `opsi-local-image-restore`. This property contains the list of all available images. Furthermore (for the Windows products) the current opsi product versions are saved together with the image so that they can be restored as part of the restore. +
The backup tool which is used is partclone. +
Properties:
** `askbeforeinst`: +
Determines if the start of the installation has to be confirmed on the client. (Default = 'false')
** `free_on_backup`: +
This is a read-only property that shows current information about the backup partition: device, size, used, remaining, use in percentage, mount point.
** `imagefile` +
Name of the image file to be created (default = empty = the name of the currently installed opsi-local-image product will be used). The name may contain spaces but no umlauts/tremas. (In the case of spaces, these are treated internally as underscores, i.e. 'my image' = 'my_image'.)
** `setup_after_install` +
One or more products can be specified here, which are set to 'setup' after the operating system installation is complete. The dependencies of these products are also resolved.


* `opsi-local-image-restore` +
This product restores the image specified in the 'imagefile' product property to partition 1 and marks it bootable. Furthermore (for the Windows products) the opsi product versions saved with the image are restored together with the image. +
Properties:
** `askbeforeinst`: +
Determines if the start of the installation has to be confirmed on the client. (Default='true')
** `architecture`: +
Architecture selection, determines the selection of the bootimage and the installation architecture. (Default='64bit')
** `imagefile` +
Name of the image to be restored. The value of this property has automatically been set by the last backup. The list of available images can be found in the property `imagefiles_list`.
** `imagefiles_list` +
List of the available images. This list is maintained by the backup product.

** `update_and_backup` +
*The use of this property is discouraged* +
Instead, use the product `opsi-auto-update`. This product is described in the chapter 'opsi standard products' / 'opsi-auto-update': +
xref:products/localboot-products.adoc#opsi-manual-localboot-opsi-auto-update[opsi-auto-update] +
('true'/'false') Default = 'false'. If set to 'true', after the restore, it is ensured that all localboot products that are available on the server in a different version are set to `setup` and the product` opsi-local-image-backup-starter` is set to `once`. This means that all existing updates are installed and a backup is created automatically after the updates.


** `setup_after_restore` +
One or more opsi products can be specified here, which are set to 'setup' after the restore is completed and are therefore automatically installed after the reboot. The default is the product 'windomain' to add the restored client to the Windows domain again.

* `opsi-local-image-delete` +
This product deletes the image given by the product property 'imagefile' from the backup partition +
** `imagefile` +
Name of the image to be deleted (default = empty, results in an error when executing)

[[opsi-manual-localimage-components-helper]]
=== Localboot products for process control

* `opsi-local-image-backup-starter` +
This localboot product sets the Netboot product `opsi-local-image-backup` to 'setup' and reboots the client. This product has a very low priority of -98. This means, that all usual localboot products will be installed first.

* `opsi-auto-update` +
In essence, this product can be used to ensure that the installed products are up to date. +
The product sets all installed products,
whose version is not identical to that on the server,
for the client to setup.

Since this product can not only be used in the context of 'opsi-local-image', it is described in the chapter 'opsi standard products' / 'opsi-auto-update': +
xref:products/localboot-products.adoc#opsi-manual-localboot-opsi-auto-update[opsi-auto-update]


[[opsi-manual-localimage-service-methods]]
== Extended opsi service methods

With this extension, the computers in a training room can be combined in an opsi-client group. In order to provide the most convenient management for all computers in a training room, the following extensions to the opsi-service methods have been implemented:

* `setProductActionRequestForHostGroup` +
Parameter: `hostGroupId, productId, actionRequest` +
Makes it possible to start a specific action (e.g. restore an image) for all members of a group (e.g. computers in a training room).

* `setProductPropertyForHostGroup` +
Parameter: `productId propertyId propertyValue hostGroupId` +
Makes it possible to set a given product property (e.g. which image is to be restored) for all members of a group (e.g. computers in a training room).

* `getPossibleImagefileValuesForHostGroup` +
Parameter: `groupId` +
Returns the list of image filenames which `opsi-local-image-backup` has created on all members of the group. If a certain image (e.g. `opsi-local-image-winxp`) is not available on one or more computers, it is not an element of the returned list.

These methods will be integrated into the standard opsi packages at a later date. Until then, a file `40_groupActions.conf` is available, which must be copied with 'root' rights to `/etc/opsi/backendManager/extend.d`. Then execute the following:
`opsi-setup --set-rights /etc/opsi`.


[[opsi-manual-localimage-backuppartition]]
== Backup partition

The backup partition is (with MBR BIOS and without data partition) the third partition of the system hard disk. +
On systems with more than one disk, the system hard disk is determined by the opsi-local-image-prepare property multi_disk_mode. +
On systems with more than one disk, the backup partition can also be the first partition of another disk, depending on the opsi-local-image-prepare property backup_partition_on_same_disk. +
It contains:

* The file `master.log` with information about all performed image operations. This log file is transferred to the bootimage logs.
* The image directories +
The image directories have the same name as the image and contain the image as well as the metadata of the image. +
To give an idea about file sizes, here are the sizes of different image directories with OS and standard software (libreoffice, adobereader, firefox, thunderbird, javavm, flashplayer):
* `opsi-local-image-ubuntu`: 3.6G
* `opsi-local-image-winxp`: 6.4G
* `opsi-local-image-win7`: 9.4G
* `opsi-local-image-win7-x64`: 13G

[[opsi-manual-localimage-wimcapture]]
== Capture Images (WIM) generating and distribution

[[opsi-manual-localimage-wimcapture-introduction]]
=== Capture Images (WIM) Introduction

Starting with NT6 (i.e. from Vista) Microsoft has introduced a new image format, the *Windows Imaging Format (WIM)*.
A WIM image is no longer a disk or partition image, but rather a file and metadata archive. A WIM file can contain multiple images. The standard installation of a NT6 computer is based on the setup.exe extracting an image from the install.wim file and then configuring it and providing it with additional drivers.

The installed Windows OS including installed software, hotfixes and configurations can be read from an existing computer and saved in the form of a WIM. Such a WIM can then be the basis for new installations.

[[opsi-manual-localimage-wimcapture-components]]
=== Capture Images (WIM) Components

To create a capture image in Wim format, from version 4.1 you only need the product:

* `opsi-local-image-wim-capture`

The previous products:

* `opsi-local-image-capture`

* `opsi-local-image-sysprep`

are obsolete and can be removed.
////
* `opsi-set-wim-imagenames`
* `opsi-del-wim-images`
////

In addition, there are the 'target products' which are intended to hold the captured images:

* `opsi-local-image-win7-capture`
* `opsi-local-image-win7-x64-capture`
* `opsi-local-image-win81-capture`
* `opsi-local-image-win81-x64-capture`
* `opsi-local-image-win10-capture`
* `opsi-local-image-win10-x64-capture`

[[opsi-manual-localimage-wimcapture-proceedings]]
=== Capture Images (WIM) Processing

The process and settings for the product `opsi-local-image-wim-capture` are very similar to the product `opsi-wim-capture` which is described here: xref:modules/wim-capture.adoc#opsi-manual-wimcap[opsi WIM Capture]. The properties of `opsi-wim-capture` are described here: xref:modules/wim-capture.adoc#opsi-manual-wimcap-products-main[opsi WIM Capture].

The main difference between the two products is: +
To backup and restore the partition to be captured `opsi-local-image-wim-capture` uses the mechanism of `opsi-local-image-backup`/`opsi-local-image-restore`.
For the same purpose `opsi-wim-capture` uses the product `opsi-clonezilla`.

NOTE: `opsi-local-image-wim-capture` will fail if you have setup your system with a data partition. In this case, reinstall the computer with the opsi-local-image-prepare property data_partition_size=0.


////
*Overview:* +
Do the following steps in this sequence:

. Initial prepare with `opsi-local-image-prepare`
. Install the OS with `opsi-local-image-win*`
. Install and configure additional software with 'opsi' or / and manually
. Configure the product properties of the netboot product `opsi-local-image-capture` (but do not switch it to setup)
. Start the localboot product `opsi-local-image-sysprep`
. `opsi-local-image-sysprep` starts (according to its product properties) an `opsi-local-image-backup` run
. `opsi-local-image-sysprep` runs sysprep in order to depersonalize the OS installation
. `opsi-local-image-sysprep` starts (according to its product properties) `opsi-local-image-capture`
. `opsi-local-image-capture` configures the winpe partition for boot and capture and reboots
. The PC boots from winpe and will do the capture process. The log is appended to the `opsi-local-image-capture` bootimage log


*Generating the master client:* +
this will be generated with 'opsi-local-image' as client and can get software and configuration per opsi as well as manually.

*sysprep: depersonalization of the master:* +
for that an image can be the starting point of an installation, at first it must be prepared. The client has to be depersonalised, so that the client has no identity anymore and so can be the template for new installations. But being depersonalised it can not be used as a working client anymore. +
So with the product 'opsi-local-image-sysprep' by special properties can be configured, whether there has to be created a backup before depersonalisation:

* `always_backup_before_sysprep`: +
(true/false), default=true, +
always make a backup before starting the sysprep.

[NOTE]
===============================
If `always_backup_before_sysprep`='true' then the product `opsi-local-image-backup`
will be set to 'setup' and a reboot will be performed. +
In order to avoid a never ending loop, we write a reboot flag, so that after writing the backup, we can see that this step has already been done.

Technical note: We do not want to reboot again after restoring the backup, though (but the reboot flag is contained in the backup). Thats why the reboot flag is being set as a time stamp. In case the time stamp is older than 0.1 days (i.e. 2.4 hrs), it will be ignored.
===============================


* `abort_on_no_backup`: +
(true/false) default=true, +
check whether the backup partition has a backup for this product and abort if not. After the sysprep usually the actual capture will be started, which is performed by the netboot product 'opsi-local-image-capture'. Whether it starts automatically is set by the property:

* `startcapture`: +
(true/false), default=true: set the product `opsi-local-image-capture` to 'setup' and reboots

* `disabled`: +
(true/false), Default=false, +
If true nothing will be done. This avoids loops that may start after restoring an image that has `opsi-local-image-sysprep` with action request `setup` in the restored meta data.

.capture images: configed: opsi-local-image-sysprep
image::oli-capture-configed-sysprep.jpg["capture images: configed: opsi-local-image-sysprep", width=500]

*capture: read the existing installation and provide for installation:* +
within this multi-stage process the existing client will be readout and integrated as WIM into an existing opsi Windows installation product. So there is a product property to define, in which product the image readout is to be integrated:

* `target_product`: +
name of target product (default = pass:[''])

IMPORTANT:  this property isn't smart, so it does not check whether the image matches the specified target. So you could by mistake integrate a Win7-32Bit into a Win81-64Bit product without getting an error or warning message. So you must take care not to do so. We recommend using special capture target products (like `opsi-local-image-win81-x64-capture`).

The target product, like the standard product for Windows installation must be prepared. The target file within the target product is `install.wim` (`installfiles/sources/install.wim`), that also includes the images provided by Microsoft. Whether the image readout has to be appended to this file or a new `install.wim` has to be generated, is defined by the property:

* `capture_mode`: +
(append/always_create) default = 'append': +
with `append` the new image will be appended to the existing `install.wim`.

IMPORTANT: In case the `install.wim` contains an image with the same name it will be *deleted without notice*. With `always_create` a new `install.wim` will be created. +
`always_create` does not works only with winpe that are based on windows < 8.x.

The `install.wim` file is a container that can hold several images. The images have a name and a description. The name and the description of the new created images is set by these properties:

* `imagename` +
default = pass:['']

* `image_description` +
default = pass:['']

* The property `start_after_capture` +
is a list of products, which have to be set to 'setup' after the capture. This could be for instance 'opsi-local-image-restore', which restores the client from the backup that had been generated before the sysprep.

.capture images: configed: opsi-local-image-capture
image::oli-capture-configed-capture.jpg["capture images: configed: opsi-local-image-capture", width=500]

.capture images: schema: sysprep
image::oli-capture-sheme-sysprep.png["capture images: schema: sysprep", width=500]

.capture images: opsi-local-image-sysprep 1 : start
image::oli-capture-sysprep1.jpg["capture images: opsi-local-image-sysprep 1 : start", width=350]

.capture images: opsi-local-image-sysprep 2 : backup before sysprep
image::oli-capture-sysprep1-backup.jpg["capture images: opsi-local-image-sysprep 2 : backup before sysprepp", width=350]

.capture images: opsi-local-image-sysprep 3 : deactivating the opsi-client-agent
image::oli-capture-sysprep2a.jpg["capture images: opsi-local-image-sysprep 3 : deactivating the opsi-client-agent", width=350]

.capture images: opsi-local-image-sysprep 4 : actual sysprep
image::oli-capture-sysprep2b.jpg["capture images: opsi-local-image-sysprep 4 : actual sysprep", width=350]

With the property `startcapture` the capture process can be started directly following the sysprep. +
The capture process basically consists of two phases: +
the actual capture process is performed by winpe on the disc. Therefore this must be prepared and this is phase one:

* Activating WinPE as bootable partition, generating the required boot records and, if necessary, deactivating the drive letter for other partitions.

* Reading the opsi meta data about installed products on the client and saving these date on the client in a temporary directory.

* Some cleanups on the readout system.

* Writing a command file, that initiates the capture process at the next start of WinPE.

* Providing some more files for the processing of WinPE like the list of products from the property `start_after_capture`

* Rebooting the client

.capture images: schema: capture 1
image::oli-capture-scheme-capture1.png["capture images: sSchema: capture 1", width=500]

During the second phase WinPE starts and executes the actual capture process. In detail:

* mount the opsi_depot_rw share for writing.

* check the architecture of WinPE (32/64 bit) and start the opsi-script in the corresponding architecture.

* connect to the opsi-webservice

* reactivating the drive letters

* in case of `append` mode: check whether an image with this name exists and in case delete this existing image.

* start the capture process. Doing so, depending on the Windows version of the WinPE, on Windows 7 the program imagex from the 'opsi-local-image-capture' product will be used. On Windows 8 the program dism from WinPE will be used (with fallback to imagex).

* The resulting logfiles will be merged.

* check the list of images in the modified install.wim and set this list as the product property `Imagenames` of the target product, so that the new created image can be selected for installation.

* set the product `start_after_capture` to 'setup'.

* deactivate the WinPE partition and activate the system partition (Windows). Including activating UEFI netboot if possible.

* write the logfile to the server. It will be attached to the logfile from the 'opsi-local-capture' bootimage process.

* reboot

.capture images: schema: capture 2
image::oli-capture-scheme-capture2.png["capture images: schema: capture 2", width=500]

.capture images: capture: delete an existing image
image::oli-capture-del-existing-image.jpg["capture images: capture: delete an existing image", width=350]

.capture images: capture: capture and append the new image
image::oli-capture-append-image-dism.jpg["capture images: capture: capture and append the new image", width=350]
////

////
To rollout the generated image use the target product defined as `target_product`. Set the `imagename` to the name of the generated image and then the product can be installed like any other Windows installation. So all the standards like driver integration and installation of the opsi-client-agent are performed like with using the original Microsoft image. +
One important aspect has to be taken into account: if on the client the image has been generated from, software had been installed per opsi, these installation files are restored when installing the 'opsi-client-agent'. This results in the side effect, that, differing from the standard installation, not all the products that have been set to installed before the installation are set to setup. Because this standard feature would result in installing again all the products that have been integrated into the image. So in this case only those products will be installed, that have explicitely been set to 'setup' before the OS installation.
////

[[opsi-manual-localimage-wimcapture-rollout]]
== Windows installation from a target product
(Roll out the captured image)

*Restore opsi metadata about installed products*

*The Problem:*

If you reinstall Windows with opsi, e.g. `win7-x64`, then during the installation of the opsi-client-agent all local boot products that were previously set to `installed` on this computer are automatically set to setup and thus reinstalled later. +
This cannot be done in the same way when rolling out a 'captured' image. +
The image contains the backup of the opsi data that was stored there during the capture process. This is discovered during the installation of the opsi-client-agent and imported back into the opsi-server. The products that were installed in the 'captured' image are now set to `installed` for the freshly installed computer.
If all products set to `installed` were now set to `setup`, this would result in all products already installed in the image being installed again. This is not desirable.


As of opsi 4.0.7, there are two options for restoring the opsi metadata for installed products: +

*Option 1* +
Restore metadata and retain 'setup' action requests. +
Products that have the status 'installed' will *not* be set to 'setup'. +
This is the default and the behavior before opsi 4.0.7

*Option 2* +
Restore metadata. Products that are marked as 'installed' are set to 'setup' except those which were contained in the restored metadata. +

*Option 1* +
When rolling out a 'captured' image, only those products are automatically installed that were set to `setup` before the start of the operating system installation. This can be changed manually or with the property `setup_after_install`.
In this case, therefore, only those products are installed that were set to `setup` before the operating system was installed. +
This is the default and the behavior before opsi 4.0.7

*Option 2* +
Option 2 behaves similarly to installations from non-captured images: +
* Restore the metadata. +
* Products that are marked 'installed' are set to 'setup' except those which were contained in the restored metadata. +
This behavior is only available from opsi 4.0.7 and is not the default. Option 2 has been made possible by extensions to the opsi-script and is part of the opsi-client-agent from 4.0.7. +
To use this behavior a 'config' ('host parameter') must be set: +
The Boolean configuration entry: `clientconfig.capture.switch_installed_products_to_setup`. If this entry has the value 'true' for the client then option 2 is used, otherwise option 1. +

These '{opsi-config-objects}' can then be used to activate or deactivate client-specific events.
The '{opsi-config-objects}' can be created using '{opsi-configed}' or '{opsi-admin}'.

To create the '{opsi-config-objects}' using '{opsi-admin}', the following commands must be executed on the '{opsi-configserver}':

[source,prompt]
----
opsi-admin -d method config_createBool clientconfig.capture.switch_installed_products_to_setup "capture.switch_installed_products_to_setup" true
----
This sets 'Option 2' for *all* computers.

To create the '{opsi-config-objects}' using  '{opsi-configed}', select 'Server configuration' / 'clientconfig' / Right-click on the right side: `Add Boolean configuration entry`.



[[opsi-manual-localimage-wim-info]]
== Helper product opsi-wim-info

The product `opsi-wim-info` can be used to quickly read information about the images saved in an install.wim. This information is then saved in the log file. +
Properties:

* `target_product` +
ProductId of the product where is searched for 'install.wim'.

[[opsi-manual-localimage-ubuntumirror]]
== Creating your own Ubuntu 'proxy'
You can find useful instructions for creating your own Ubuntu proxy here:

* link:https://help.ubuntu.com/community/Apt-Cacher-Server[]

* link:https://www.debuntu.org/how-to-set-up-a-repository-cache-with-apt-cacher/index.html[]

* link:http://wiki.ubuntuusers.de/Lokale_Paketquellen/Apt-Cacher-ng[]

* link:http://www.gambaru.de/blog/2011/10/26/apt-cacher-ng-ein-proxy-server-fur-debian-und-ubuntu/[]
