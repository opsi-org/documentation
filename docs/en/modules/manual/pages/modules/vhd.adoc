////
; Copyright (c) uib gmbh (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
; 
; credits: http://www.opsi.org/credits/
////

:Author:    uib gmbh
:Email:     info@uib.de
:Date:      09.02.2023
:Revision:  4.1
:toclevels: 6
:doctype:   book

include::common:partial$opsi_terms.adoc[]

[[opsi-manual-vhd]]
= Virtual Hard Disk (`opsi-vhd-reset`)

`opsi-local-image` helps you to quickly restore many opsi clients to a certain state — for example in the coffee break during a training or in the classroom after class. The administrator controls everything in a central place: first, the extension creates an image, then it saves it on a separate hard disk partition. This image is then used for fast recovery, with minimal impact on network performance.

The `opsi-vhd-reset` module extends `opsi-local-image` (see xref:modules/local-image#opsi-manual-localimage[Local Images (`opsi-local-image`)]): The initial installation with a final local image backup takes place in a VHD container.


[[opsi-manual-vhd-preconditions]]
== Prerequisites

NOTE: This module is currently a link:https://www.opsi.org/product/extensions-of-opsi/[paid extension]. This means that you need an activation file to unlock it. You will receive this file after you have purchased the extension. For evaluation purposes, we're happy to provide you with a temporary license free of charge. Please contact us via mailto:info@uib.de[email].

More details can be found in xref:modules/modules#opsi-manual-modules[opsi Extensions].

`opsi-vhd-reset` is bundled with the `opsi-local-image` extension (see xref:modules/local-image#opsi-manual-localimage[Local Images (`opsi-local-image`)]), which means that activating `opsi-local-image` automatically applies to `opsi-vhd-reset` as well.

The extension requires opsi 4.0.7 or newer. The following table lists the required opsi packages:

.Required Packages
[options="header"]
|==========================
|opsi Package|Version
|`opsi-winst` |>= 4.12.0.13
|==========================

[[opsi-manual-vhd-introduction]]
== Introduction

opsi is a great tool to install and maintain Windows computers in an automated way -- also and especially if heterogeneous hardware is involved. However, a package-based opsi installation is not fast enough to bring computers back to a predefined state within a short time, e.g. during trainings or in a classroom during a break. The module `opsi-vhd-reset` extends `opsi-local-image`:

. initial Windows 10 installation in a VHD container
. "sealing" the initial installation with a child VHD
. quick restore by replacing the child VHD
. upgrade of the initial installation by a merge of the child VHD

NOTE: This method uses snapshot techniques known from virtualization without using virtualization per se.

[[opsi-manual-vhd-proceedings]]
== Proceedings

[[opsi-manual-vhd-proceedings-initial]]
=== Initial Installation

Install a Windows 10 system in a VHD container using the `opsi-vhd-win10-x64` product.

.Scheme: Partition and create a VHD (`opsi-vhd-win10-x64`)
image::opsi-vhd-inst1.png["Scheme: Partition and create a VHD (`opsi-vhd-win10-x64`)", width=332]

.Scheme: Install Windows (`opsi-vhd-win10-x64`)
image::opsi-vhd-inst2.png["Scheme: Install Windows (`opsi-vhd-win10-x64`)", width=332]

After that, you can install the necessary applications on this Windows system.

.Scheme: Install application software (`opsi-vhd-win10-x64`)
image::opsi-vhd-inst3.png["Scheme: Install application software (`opsi-vhd-win10-x64`)", width=332]

Execute the product `opsi-vhd-control` to store current metadata about this opsi client. This includes the information about which product is installed in which version. Afterwards activate and boot the Windows PE (Preinstallation Environment).

TIP: The product `opsi-vhd-control` has a very low priority (-97). It therefore runs only runs after the installation of application software. As a result, you can set `opsi-vhd-control` to `setup` together with the application software.

.Scheme: Activate Windows PE partition (`opsi-vhd-win10-x64`)
image::opsi-vhd-inst4.png["Scheme: Activate Windows PE partition (`opsi-vhd-win10-x64`)", width=332]

On Windows PE, creating a child VHD protects the initial installation against modifications.

.Scheme: Seal initial installation (`opsi-vhd-control`)
image::opsi-vhd-control-1stsnap.png["Scheme: Seal initial installation (`opsi-vhd-control`)", width=332]

From now on, all changes are stored in the child VHD.

.Scheme: Working with the sealed system
image::opsi-vhd-control-work.png["Scheme: Working with the sealed system", width=332]

[[opsi-manual-vhd-proceedings-restore]]
=== Restoring an Image

With the product `opsi-vhd-control` you can restore the initial installation. First the product restores the saved opsi metadata, then for handling of the child VHD the system boots Windows PE again.

.Scheme: Restore initial installation, part 1 (`opsi-vhd-control`)
image::opsi-vhd-control-activatepe.png["Scheme: Restore initial installation, part 1 (`opsi-vhd-control`) 1", width=332]

In Windows PE, the child VHD with the modifications is deleted and replaced with a new, empty child VHD.

.Scheme: Restore initial installation, part 2 (`opsi-vhd-control`)
image::opsi-vhd-control-resnap.png["Scheme: Restore initial installation, part 2 (`opsi-vhd-control`)", width=332]

[[opsi-manual-vhd-proceedings-update]]
=== Updating an image using `opsi-auto-update`

To update the initial installation with patches and software updates, you can proceed as follows:

* Restore the initial installation (as described above)
* Install the updates
* Integration of the updates in the initial installation and re-sealing by starting 'opsi-vhd-control' with the property 'upgrade=true'
* This also stores the new opsi metadata in the system

These processes are carried out automatically by the product `opsi-auto-update`.

The product `opsi-auto-update` replaces the previous product `opsi-vhd-auto-upgrade`


[[opsi-manual-vhd-components]]
== The opsi-vhd products

The extension 'opsi-vhd-reset' consists of the following products:

The netboot product for the initial installation:

* `opsi-vhd-win10-x64`

The localboot product to control the creation, the replacement and merge of the child VHDs:

* `opsi-vhd-control`

The localboot product to control the fully automatic upgrade of the parent VHD.

* `opsi-auto-update`

[[opsi-manual-vhd-components-uefi]]
=== UEFI Compatibility

The opsi-vhd products are UEFI compatible.


[[opsi-manual-vhd-components-netboot]]
=== The opsi netboot product 'opsi-vhd-win10-x64' and its properties

This netboot product is very similar to the normal netboot products (4.1.0) for Windows installations and must be filled accordingly as described in the 'getting-started' manual. +
Also the properties are mostly the same.

The following properties are special for this product:

* `windows_vhd_size` +
This property specifies the size of the base VHD absolute or as a percentage of the harddisk size, minus the WinPE partition. The default value of 100% is automatically reduced to 80% to leave room for the child VHD. If (absolute or relative) a value is entered that would exceed 80%, this is also reduced to 80%. +
This property replaces the standard property 'windows_partition_size' +
(Default = 100%)

* `installto`: +
This value is 'vhd' and should not be changed.

The following properties are not existing for this product:

* `windows_partition_size`, `windows_partition_label` +
See above. The label of the partition on which the VHDs are located is 'CONTAINER'.
* `data_partition_size`, `data_partition_letter`, `data_partition_create`, `data_partition_preserve` +
Currently the usage of a data partition is not possible with opsi-vhd.
* `boot_partition_size`, `boot_partition_letter`, `boot_partition_label` +
Currently the usage of a boot partition is not possible with opsi-vhd.
* `pre_format_system_partitions`, `preserve_winpe_partition` +
With opsi-vhd these two values are always 'true'.

[[opsi-manual-vhd-components-control]]
=== The opsi localboot product 'opsi-vhd-control' and its properties

The opsi-vhd-control product has a very low priority (-96).

* `disabled` +
This property is for debugging purposes. +
If 'true', the product does not execute any actions. +
Default = 'false'

* `upgrade` +
If 'true': Merge the changes that are collected in the child VHD to the parent VHD.
Then replace the child VHD with an empty one. +
If 'false': replace the child VHD with an empty child VHD. +
At the end of a successful 'upgrade' run, this property is automatically reset to 'false'. +
Default = 'false'

* `stop_on_no_network_in_pe` +
This property is for debugging purposes. +
If 'true': Abort with an error message, to analyze why no network connection could be established.
Default = 'false'

[[opsi-manual-vhd-components-upgrade]]
=== The opsi localboot product 'opsi-auto-update' and its properties

opsi-auto-update is a product to simplify the maintenance of the clients.

In essence, this product can be used to ensure that the installed products are up to date. +
The product sets all installed products,
whose version is not identical to that on the server,
for the client to setup. +
Since this product can not only be used in the context of 'opsi-vhd-reset', it is described in the chapter 'opsi standard products' / 'opsi-auto-update': +
xref:products/localboot-products#opsi-manual-localboot-opsi-auto-update[opsi-auto-update]

[[opsi-manual-vhd-restrictions]]
=== Known Problems and Restrictions

* There is also a 32 bit version. Due to a problem with the diskpart merge command, this can only be used to a limited extent in the 32 bit Windows PE versions.

* In theory, an implementation for Windows 8.1 or Windows 7 Enterprise would be possible. We will only build these products at request. 

* There are indications that a Windows 10 release upgrade of an installation in a VHD will fail. +
(https://www.heise.de/newsticker/meldung/VHD-Boot-Windows-Update-demoliert-Aktivierung-3806023.html)
