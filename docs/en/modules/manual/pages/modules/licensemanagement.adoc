////
; Copyright (c) uib gmbh (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
; 
; credits: http://www.opsi.org/credits/
////

:Author:    uib gmbh
:Email:     info@uib.de
:Date:      10.02.2023
:Revision:  4.1.0
:toclevels: 6
:doctype: book

include::common:partial$opsi_terms.adoc[]

[[opsi-manual-licensemanagement]]
= License Management

License management or software license management ensures the legal handling of proprietary software in companies and organizations. Ideally, license management supports different license models and helps those responsible to maintain an overview of the software used in the company and the existing licenses. Using a good license management system, you can avoid penalties and unnecessary licensing costs.

[[opsi-manual-licensemanagement-preconditions]]
== Prerequisites

NOTE: This module is currently a https://www.uib.de/de/opsi-erweiterungen/erweiterungen[paid extension]. This means that you need an activation file to unlock it. You will receive this file after you have purchased the extension. For evaluation purposes, weâ€™re happy to provide you with a temporary license free of charge. Please contact us via mailto:info@uib.de[email].

More details can be found in xref:modules/modules#opsi-manual-modules[opsi Extensions].

[[opsi-manual-licensemanagement-overview]]
== Overview

The license management module simplifies the time-consuming and complex administration of licenses of non-free software installed on clients managed with opsi.

[[opsi-manual-licensemanagement-overview-features]]
=== Main Features

The main features of this opsi extension are:

* The configuration of the license management takes place in the same interface as the software distribution and operating system installation (see chapter xref:configed[opsi Management GUI: `opsi-configed`]).

* You can easily generate reports about the installed licenseable software, even for software not distributed via opsi. The latter uses the information from the software inventory as a basis.

* You can reconcile installations and existing license agreements.

* Optionally you can automatically provision, allocate and reserve licenses and license keys.

=== Software Licensing Models

A licensing model defines who may use a software in which form (see section <<opsi-manual-licensemanagement-createlicense-model>>). There are various approaches as to how the software manufacturers handle this:

* Standard Single License: one installation on one computer (with individual license key).

* Volume License: maximum number of installations is fixed; as campus license the key is valid for an unlimited number of installations

* OEM License: license bound to one computer, key is valid only for specific hardware

* Concurrent User License: any installation of the software, a license server regulates the number of usages

If the opsi server controls the allocation of licenses, it is ensured that the license and if necessary the key are released again when the software is uninstalled. Furthermore, the allocation of licenses can also be done manually or even script-controlled, e.g. if a license has not been distributed with opsi.

[[opsi-manual-licensemanagement-database-tables]]
=== Database Model for License Management

License management is a complex topic. To represent it, opsi has to implement a relatively complex database model to manage the licenses and their keys. For a better overview the following diagram represents the involved tables. The blue line marks the border between tables which are automatically generated by the software audit functions and tables with data that is collected or assigned specifically for license management.
Only the license pool table has connections to both spheres. This fact hints at the importance of this construct.

.Database Tables relevant for License Management
image::mysql-schema-licensemanagement.png["Database Tables relevant for License Management"]

The diagram also shows the meaning of license pools, which the <<opsi-manual-licensemanagement-licensepools>> section explains in detail.

[[opsi-manual-licensemanagement-overview-start]]
=== Lizenzmanagement im `opsi-configed`

The management interface `opsi-configed` offers a separate window for license management. You can access the dialog via the _Licenses_ button in the main window. The prerequisite is that the extension is installed and activated. To check this, go to the _Help_ / _Modules_ menu in the main window.

.`opsi-configed`: You can reach the license management via the rightmost icon (_Licenses_).
image::opsi-configed-mode-selection.png["`opsi-configed`: You can reach the license management via the rightmost icon (_Licenses_).", pdfwidth=50%, width=400]

The license management dialog box displays six tabs at the top:

* License pools
* New license
* Edit licenses
* Licenses usage
* Reconsiliation
* Statistics

The following sections explain the individual dialogs and their various features.

[[opsi-manual-licensemanagement-licensepools]]
== License Pools

The tab _License pools_ shows the associations of the license pools with the information of the opsi database about installed software and installation packages.

[[opsi-manual-licensemanagement-licensepools-concept]]
=== What's a License Pool?

For each type of license you want to manage with this extension, you need to set up a separate license pool. This pool describes the summary of rights, which are needed to install a certain kind of software legally. The license pool is the center of all opsi license management activities:

* On the one hand, it refers to the installed software items and opsi installation packages.
* On the other hand, it combines legal and technical constructions of the installation permissions.

.The tab _License pools_
image::licensemanagement-licensepools.png["The tab _License pools_", pdfwidth=80%]

[[opsi-manual-licensemanagement-licensepools-creation]]
=== Managing License Pools

At the very top of the _License pools_ dialog you can see a two-column table listing all available license pools. You can edit the _description_ field and enter your own descriptions there.

Further editing functions can be accessed via the context menu of the right mouse button. Use the entries displayed there to create a new pool, delete an existing one, save or discard the changes, and reload the data.

When creating a new pool, i.e. when creating a new table row, enter a (unique) _licensePoolId_ in the corresponding field, for example `pool_for_x`.

NOTE: Please do not use special characters for the IDs. Upper case letters are automatically converted to lower case!

Unlike the description, you can edit the pool ID only until you save it for the first time. After that, it cannot be changed because it's used as the primary key. Deleting an entry is only possible if there is no reference to this key in other tables. Recursive search for such references is currently not supported.

Each editing operation changes the status display of the two buttons _OK_ and _Cancel_. The green check mark of the _OK_ button turns red and the _Cancel_ button is enabled. Press one of the two buttons or select the corresponding entry from the context menu of the right mouse button to save or cancel your changes.

[[opsi-manual-licensemanagement-licensepools-opsiproducts]]
=== License Pools and opsi Products

In general, only one license pool belongs to an opsi product which installs a software requiring a license and which is to use the license management. The required licenses are drawn from this pool. It's possible, though, that several products refer to the same license pool if those are variants of the same software. For example, the products `win10-x64` and `opsi-local-image-win10-x64` both use the pool `p_win10-x64`.

The situation is less clear, if an opsi product installs several software products requiring licenses from several license pools. Assuming that a package called _Design-Programs_ includes Adobe Photoshop and Adobe Writer, the opsi product must request licenses from two different pools. Basically, these assignments are based on an n:m scheme. 

TIP: To keep things easy, please assign only one software which needs a license to an opsi product. Assign this product to the corresponding license pool. This restriction is mandatory if you use the license management module together with the xref:modules/wan-support#opsi-manual-wansupport[WAN/VPN Support] extension.

The second table in the _License pools_ tab (see <<licensemanagement-licensepools.png>>) manages the relationship between the license pools and the product IDs of the opsi products. Click on the _licensePoolId_ or _productId_ column title to sort the table. This way you can show the connections between opsi products and a license pool or all license pools assigned to an opsi product.

You can create a new entry, i.e. a new assignment of a license pool to a product ID, via the context menu of the right mouse button. After clicking into the table field you will see a list of available options.

[[opsi-manual-licensemanagement-licensepools-softwareids]]
=== License Pools and installed Software

The lower half of the  _License pools_ tab (see <<licensemanagement-licensepools.png>>) represents the correlation between license pools and the installed software on the opsi clients, either installed with opsi tools or in another way. In the individual columns you can see a unique ID, which is constructed from combining all attributes and acts as a unique key. This is followed by information about the software, including the name, the version number, the operating system, the architecture etc.

The opsi software audit determines the values (see section xref:manual/pages/products/localboot-products#opsi-manual-localboot-swaudit_hwaudit[Products for Hardware and Software Audit: `hwaudit` and `swaudit`]); it retrieves information from the registry and reports it back to the opsi server. The table _SOFTWARE_CONFIG_ of the opsi database stores the values for each client. If not already present, they are added to the table _SOFTWARE_. This forms the basis for the table displayed in the license management.

Two different views determine which data you can see in the table at the bottom of the _License pools_ dialog:

* Only show specific data (_Show all_, _Don't show software assigned to other pools_, _Only software items not yet assigned to any pool_); this is the default.
* Description of what the highlighting of rows means (_Selection = Complete list of SW items assigned/to assign_, _Selection = SW items to assign (additionally)_).

[[sw-table-configuration]]
.Software Table: configuring the view
image::licensemanagement-sw-table-configuration.png["Software Table: configuring the view", pdfwidth=80%]

So here you can see all assignments of software items (from the database table _SOFTWARE_) to a license pool (table _LICENSE_POOL_). All entries belonging to the license pool selected in the upper table appear as highlighted rows with a colored background. This allocation is precisely the data from the _AUDIT_SOFTWARE_TO_LICENSE_POOL_ table.

TIP: Change the selection to edit the assignment of software items to the individual license pools. Use [Ctrl]+click or [Shift]+click to select multiple rows in the software table. A single click in a row restarts the selection.

NOTE: If there is still an assignment of a software item to a license pool in the database, but the software no longer exists according to the database, the _Missing_ button is activated. Press the button to open a new dialog window. It lists the referenced but apparently no longer existing software and offers to remove the allocation from the _AUDIT_SOFTWARE_TO_LICENSE_POOL_ table.

[[opsi-manual-licensemanagement-licensepools-softwarei-navigation]]
=== Navigating the Software Table

A change in the rows highlighted in blue means a change in data. Therefore, the functions for navigating in the table behave differently than usual. A red asterisk at the beginning of the line marks the location of the cursor.

.Software Table: Cursor in the Row
image::licensemanagement-table-sw-rowcursor.png["Software Table: Cursor in the Row", pdfwidth=80%]

In order to reposition the cursor, you have the following options:

* Search for a value (e.g. by showing the assigned software items when changing the license pool).
* Use the search field above the table.
* Use the buttons with the red arrows above the table for navigation.
* Click the column of the row marked with the asterisk. (Attention: Clicking into the data itself resets the row selection!)

[[opsi-manual-licensemanagement-softwareids-based-audit]]
=== Performing a Compliance Check

By allocating software items to license pools, you have already established the base for a compliance check required by Microsoft. This is how it works: Use the mouse to mark the software items in a pool. To determine the total number of installations assigned to a pool, open the _Statistics_ tab (see section <<opsi-manual-licensemanagement-statistics>>).

NOTE: To get correct results, it is important to carefully maintain the assignments of software items to a license pool. It is imperative that these are complete. Thus, when a new licensable application is added, the software must be assigned to the pool.

[[opsi-manual-licensemanagement-softwareids-filtered-by-assignment]]
=== Filtering the Software Table

Use the context menu of the right mouse button to access functions for filtering the assigned software items. You can either display all items or only the selected ones.

.Software Table: the context menu of the right mouse button
image::licensemanagement-table-sw-contextmenu01.png["Software Table: the context menu of the right mouse button", pdfwidth=80%]

This can be helpful since the rows of assigned software items are not necessarily consecutive in the software table. Select _Show only marked items_, and the view changes:

.Software Table: displaying software items assigned to a pool
image::licensemanagement-table-sw-contextmenu02.png["Software Table: displaying software items assigned to a pool", pdfwidth=80%]

Alternatively, use the filter icon next to the search field. When a filter is active, the icon appears crossed out.

TIP: Even when the filter is active, you can edit the assignments, or more precisely: remove assignments.

[[opsi-manual-licensemanagement-completeness-by-softwarename-policy]]
=== Completing Assignments to Software Names

When the software manufacturer distributes a new version, an update or a patch, the new variant also receives a new Windows software ID and therefore shows up as a new entry in the software table (with a new ID). In most cases, the new software can be treated the same way as far as the license is concerned. If a license agreement was required for the old version, one probably exists for the new one. This means that the need for licensing for both editions must be registered in the same license pool. Coverage is then organized via the common license pool.

When rolling out new versions, you should therefore remember to add an assignment to the correct license pool. Of course, there is also software which installs updates without your intervention. As a result, the correct allocation may be missing after the update. That is why the management interface `opsi-configed` (since version 4.1.9.8) offers a separate dialog to simplify the completion of allocations. You can open the window by clicking on the _Name -> Pool_ button in the lower half of the _License pools_ tab.

.Allocation of IDs, Names and Pools
image::licensemanagement-table-sw-name2pool.png["Allocation of IDs, Names and Pools", pdfwidth=90%]

TIP: Usually the data field _name_ is sufficient for identifying the required license pool, so you can ignore differences in other components of the software ID.

The dialog displays two auxiliary tables. If you have activated the default setting _Show all software names_ before opening that window, the first column of the first table shows the names in alphabetical order. The second column lists all IDs associated with the respective name (although the first part of the ID, i.e. the exact software name, is not repeated for simplicity reasons).

The second table lists the IDs for the name selected in the first table. For each ID, it shows whether there is an allocation to a license pool and what it is called. This allows you to standardize the license pool assignments:

* remove all assignments
* assign the pool selected in the main window to all ID variants (probably the standard case)
* assign everything to the selected pool if the variants are allocated to different pools

.Main Window: Options for assigning IDs, Names and Pools
image::licensemanagement-table-sw-alternative-view.png["Main Window: Options for assigning IDs, Names and Pools", pdfwidth=80%, width=400]

NOTE: If such unresolved assignments exist, a small _i_ appears in this gray box as an indicator. We have deliberately chosen a subtle design because it may well be correct and necessary that variants of a software are licensed differently.

The third option (_Show software without any assignments_) allows you to search for any forgotten license assignments.

[[opsi-manual-licensemanagement-softwareids-total-assignment-policy]]
=== Detecting Software Not Yet Assigned

Of course, it is possible to assign all installed applications to a license pool -- including free software. If you then install a new software or a new version of an existing one, previously unassigned software items are easily identifiable.

TIP: For such an approach to work in reality, you need pseudo license pools such as _Free Software_ or _Operating System Components_. You then allocate software items to these pools for which no licensing exists or is required.

`opsi-configed` provides additional display options for such scenarios (see also <<sw-table-configuration>>):

.Software Table: Options for displaying Software Items
image::licensemanagement-table-sw-modi-primary.png["Software Table: Options for displaying Software Items", pdfwidth=80%, width=400]

Assuming you have assigned all software to a license pool until now, the individual steps look like this:

. You install a (new) software on an opsi client.
. On the client, you start the opsi product `swaudit`.
. If the software is new indeed, a new entry appears in the software table. It's possible that you see several entries there, for example for additionally installed libraries.
. Select a suitable license pool and activate the option _Show software names without uniform assignments_. The new table entries are now the only ones highlighted.
. If the selected license pool is suitable, then add a new entry with [Ctrl]+click.

The steps are different if you want to distribute arbitrary, not yet assigned software items to license pools:

. Activate the option _Show software names without any assignments_
. In the section _Edit mode_, select _Selection = SW items to assign (additionally)_.
. Use [Ctrl]+click to select the relevant rows; optionally, you can use the search function or a filter.
. Now select the license pool to which you want to assign the highlighted software items.
. Press the now green _OK_ button to save.
. Finally, set the _Edit mode_ back to _Selection = Complete list of SW items assigned/to assign_.

NOTE: Please note that the functions described here (seem to) behave differently when a filter is active for the table.

[[opsi-manual-licensemanagement-createlicense]]
== Setting up Licenses (_New license_)

Change to the _New license_ tab to set up licenses and then make them available via a license pool. The dialog window shows a (non-editable) table with all available license pools in the upper area. Select a pool that the new license is to be assigned to.

.The tab _New license_
image::licensemanagement-createlicense.png["The tab _New license_", pdfwidth=80%]

[[opsi-manual-licensemanagement-createlicense-concepts]]
=== The Licensing Concept

First, let's clarify some important terms:

* *Licensing*
* *License Key*
* *Software License*
* *Licensing Model*
* *License Contract*
* *Licensing Option*
* *License Usage*

*Licensing* means the actual deployment of a permission to use software by installing the software on a client. Sometimes, but not always, this includes using a special *license key*.

The *software license* is the permission to install and use a software as defined by the license contract. In the opsi database the _software license_ corresponds to the licensing right and is identified by a _softwareLicenseId_. The *licensing model* describes the licensing right in more detail and determines, for example, for how many computers and how long a license is valid. The *license contract* states and documents the licensing right in the legal sense.

A *licensing option* describes the possibility to apply a licensing right for a specific license pool. opsi defines the licensing option by a combination of _softwareLicenseId_ and _licensePoolId_. If required, this includes the actual _licenseKey_.

Finally, the *license usage* documents the use of a license by assigning the license option to a client, it's the completed and authorized licensing of a software installation. The description is composed of _softwareLicenseId_, _licensePoolId_, and _hostId_ (unique name of the opsi client). If required, it also notes the _licenseKey_.

[[opsi-manual-licensemanagement-createlicense-contract]]
=== Registering the License Contract

After you have decided on a license pool for which you want to create a licensing option, you select the license contract. In the table _Select or enter license contract_ you can choose an existing contract or create a new contract record.

The first column shows the _licenseContractId_, which is used to identify the license contract in the database. This is followed by information about the contract partner (_partner_), the conclusion date (_conclusionDate_), the notification date (_notificationDate_) and the expiration date (_expirationDate_). The last field (_notes_) can hold some additional information. For example, here you can write down the location of the documents belonging to the contract or a file number.

Use the context menu of the right mouse button to create a new record. A new unique ID (based on the current date and time stamp) is automatically created. You can use the default setting if purchasing the software implies the license contract or if the contract is documented and traceable in some other way. Otherwise, the data can and should be edited to ensure orderly tracking of the underlying contract, for example, by entering a file number in the _notes_ field.

NOTE: You can only change the contract ID as long as the data record has not yet been saved. When saving the data, the opsi service checks whether the ID is unique. If it isn't, a new ID is generated and cannot be changed anymore.

[[opsi-manual-licensemanagement-createlicense-model]]
=== Configuring the Licensing Model

In the _Configure license_ section of the _New license_ tab, you can register the licensing model. Use one of the four buttons to select the licensing model: 

* _Standard_: Installation on any computer (with individual license key, which is also used only once).
* _Volume_: Maximum number of installations is fixed; one volume license legitimizes _n_ installations (possibly with a single license key); _n=0_ means that the key is valid for an unlimited number of installation (campus license).
* _OEM_: License is bound to a computer, key is only valid for certain hardware (often for PCs with pre-installed operating system).
* _Concurrent_: From opsi's point of view, this is an unlimited volume license which may be used as often as desired; de facto, however, the number of licenses used is controlled differently, e.g. by a license server.

In all four cases, the automatically generated data includes a unique ID (based on the current date and time stamp). You can accept or modify the default value. Depending on the license model you have chosen, you can adjust the other fields or not.

NOTE: Please note that the file _Expiration date_ defines the validity of the licensing right. The _expirationDate_ field in table above (_Select or enter license contract_) shows the same value, but is currently used for documentation purposes only. This may change in the future.

[[opsi-manual-licensemanagement-createlicense-finish]]
=== Saving the data

The "Send" button sends the data to the opsi service to save them permanently to the opsi database (if they are consistent and no errors occur).

While proceeding with this, data records will be generated for the new software license based on the selected software contract and the new license option assigned to that.

The list of available license options at the bottom of the window will be refreshed with the new license option selected. If necessary, the license key can be changed then.

[[opsi-manual-licensemanagement-editlicense]]
== Editing licenses

In ninety percent of the use cases editing the license data with help of the tabs "License pools" and "New license" will do.
But there might be some special cases where more specific and explicit editing of the license data is needed.
For this, the "Edit licenses" tab presents the license data in three tables, representing the internal data structure and allowing to adapt the data for some special cases.

.License management: "Edit licenses" tab from the license management window
image::licensemanagement-editlicense.png["License management: 'Edit licenses' tab", pdfwidth=90%]

Based on this direct data access, the following chapter shows how to configure a special license, like the Microsoft Vista or Windows 7 Professional downgrade option for installing Windows XP.

[[opsi-manual-licensemanagement-editlicense-downgrade-option]]
=== Example downgrade option

The downgrade option means, that instead of the purchased software, the preceding version can also be installed.
For instance, installing Windows XP based on a Windows Vista license.
In this case, the license key can also be used for an installation, which it was not meant for originally.

In the opsi license model this case can be configured like this:

From the "New license" tab the Vista license is to be registered, as usual, resulting in a new license option, which is displayed in the list of license options at the bottom of the window.
This new license option is based on a new software license identified by _softwareLicenseId_.

.License management: copying the license-ID to the license options from the context menu
image::licensemanagement-editlicense-copying-license-id.png["License management: copying the license ID", pdfwidth=90%]

This _softwareLicenseId_ is needed for further configuration steps. You can keep it in mind or copy it with drag&drop.
You can look for the ID in the "Available license options" list of the "Edit licenses" tab as well.
The context menu also supports copying the ID.

The important step now is to connect this _softwareLicenseId_ to an additional _license-pool_.

For this, a new record has to be registered from the "Available license options" table of the "Edit licenses" tab.
The fields of the new record have to be filled with the _softwareLicenseId_ and the ID of the additional _license-pool_ (in this case the pool for Windows XP licenses).
To install Windows XP based on this license, an applicable Windows XP license key that is already in use by another client has to be added.

After saving the new record, there are two different license options based on the same software license!
The opsi service counts the use of both of them as an installation deducting from the maximum installation count.
So in case of a downgrade license (with maxInstallations = 1), the opsi service delivers a license key for a Vista installation _or_ for an XP installation, but not for both of them.

[[opsi-manual-licensemanagement-usages]]
== Assignment and release of licenses

Using a license option by installing the software on a client results in the actual licensing.

In the opsi context, installations are done script-based and automatically.
The client running the Winst script then invokes calls to the central opsi service.

The following chapters introduce some of these service calls, which are relevant for license management.
For further information about Winst and opsi commands see the documentation on Winst and opsi.


[[opsi-manual-licensemanagement-usages-opsiservice]]
=== opsi service calls for requesting and releasing a license

The opsi service call for requesting a license option and retrieving the license key for doing the installation (as transmitted by a Winst script) is
`getAndAssignSoftwareLicenseKey`.

The parameters to be passed are the client _hostId_ (hostID of the client where the software is to be installed) and the ID of the _license-pool_ that the license is requested from.
Instead of the _licensePoolId_, an _opsi-product_ ID or a Windows Software ID can also be passed if they are connected to a _license-pool_ within the opsi license management.

The use of a license option can be released by calling `deleteSoftwareLicenseUsage`.

Again the parameters to be passed are the _hostId_ and alternatively the _licensePoolId_, _productId_ or Windows Software ID.
Calling this method releases the license option and returns it to the pool of available license options.

For the complete documentation of opsi service calls see below.

[[opsi-manual-licensemanagement-usages-winst]]
=== _opsi-winst_ script calls for requesting and releasing of licenses

The _opsi-winst_ provides the client-related calls as _opsi-winst_ commands.

An _opsi-winst_ script can make a call to the function  `DemandLicenseKey`
to get a license key for installing. The parameters to be passed are:

`DemandLicenseKey (poolId [, productId [, windowsSoftwareId]])`

The return value is the license key (which can be empty) as a string:

[source, winst]
----
set $mykey$ = DemandLicenseKey ("pool_office2007")
----

The returned license key can be used by other script commands for installing the software.

For releasing a license option and license key (as to be used in an _opsi-winst_
deinstallation script) the command `FreeLicense` is available with the following syntax:

`FreeLicense (poolId [, productId [, windowsSoftwareId]])`

The boolean function `opsiLicenseManagementEnabled` can be used to check
whether the opsi license management is enabled and can be used for scripting:

[source, winst]
----
if opsiLicenseManagementEnabled
	set $mykey$ = DemandLicenseKey ("pool_office2007")
else
	set $mykey$ = IniVar("productkey")
----

The service calls can be invoked from the command-line tool `opsi-admin`.

Parameters marked with '*' are optional.

[[opsi-manual-licensemanagement-service-methods-contracts]]
=== License contracts

[source, prompt]
----
method createLicenseContract(*licenseContractId, *partner, *conclusionDate, *notificationDate, *expirationDate, *notes)
----

This method registers a new license contract record with the ID 'licenseContractId'.
If no 'licenseContractId' is passed, it will be generated automatically.
Using the 'licenseContractId' of an existing contract, this contract can be edited.

The parameters partner (co-contractor) and notes are strings and can be filled with any information desired.
The parameters 'conclusionDate' (date of conclusion of the contract), 'notificationDate' (date for a reminder) and 'expirationDate' (expiration date of the contract) are passed in the format `YYYY-MM-DD` (e.g. 2009-05-18).

The method returns the 'licenseContractId' of the contract.

[source, winst]
----
	set $mykey$ = DemandLicenseKey ("pool_office2007")
else
	set $mykey$ = IniVar("productkey")
----

With the string returning functions `getLastServiceErrorClass` and `getLastServiceErrorMessage` error states can be detected and handled, e.g. if there is no license available:

[source, winst]
----
if getLastServiceErrorClass = "None"
	comment "no error"
endif
----

The error class `LicenseMissingError` is returned if a license has been demanded but there is no license available.
The error class `LicenseConfigurationError` is returned if the current configuration does not allow assignment of a license pool to a software.
This could be the case if either no assignment exists or no distinct assignment is possible.

[[opsi-manual-licensemanagement-usages-manually]]
=== Manual administration of license usage

Within the opsi config editor, the licenses registered by the opsi service are listed on the tab "License usages":

.License management: "License usages" tab from the license management window
image::licensemanagement-usages.png["License management: License usages tab", pdfwidth=90%]

From this tab, licenses can also be managed manually.
This can be useful, if a licensed software is not integrated into the opsi deployment, but installed manually on just a few clients.

These are the functions for manual license management in detail:

* "Delete row" (available from the context menu) releases a license option.

* "Reserve license for client" at the bottom of the window to create a license reservation for a dedicated client.

* By editing the field "licenseKey" from the "Usage of licenses" table, the license key can be changed.

[[opsi-manual-licensemanagement-usages-kept]]
=== Preservation and deletion of license usages

If a software packet is reinstalled, the call to the _opsi-winst_ function DemandLicenseKey will return the same license option and license key as used before.

In case this is not favored, the former license option has to be released by calling the _opsi-winst_ command `FreeLicense`, or by calling the opsi service call `deleteSoftwareLicenseUsage`, or deleting the license use manually.

So, if not explicitly deleted, the license usages are preserved when reinstalling a client.

To release the licenses, they can be deleted from the "License usage" tab or deleted by the service call `deleteAllSoftwareLicenseUsages` by passing the client host name as a parameter.


[[opsi-manual-licensemanagement-reconciliation]]
== Reconciliation with the software inventory

The tab "Reconciliation" lists for each client and each _license-pool_ whether the use of this _license-pool_ is registered by opsi ("used_by_opsi") and if the software inventory (_swaudit_) on that client reported a software that requires a license option from that pool ('Swinventory_used').

To evaluate the results from _swaudit_, the relevant software IDs (as found in the client registry) have to be associated with the appropriate _license-pool_ (tab "License pools").

When matching the data with the software inventory, the license management counts not more than one license per client and _license-pool_.
So for example if the _license-pool_ _office2010_ is connected with ten different patterns from software inventory, indicating that _office2010_ is installed on this client, this is (regarding the license usages count) counted as a single installation, although all of the detection patterns might be found on the client.

.License management: "Reconciliation" (data matching) tab with the inventory
image::licensemanagement-reconciliation.png["License management: 'Reconciliation' (data matching) tab with the inventory", pdfwidth=90%]

As usual, this table can be copied using _Drag & Drop_ and for instance pasted to a spreadsheet program.
If the _opsi-configed_ process has the required access rights (running standalone and not from the applet), the table can also be printed from the context menu.

By virtue of the config 'configed.license_inventory_extradisplayfields' which can be edited in the host parameter page of the server, you may add extra data fields for each client to the table.

[[opsi-manual-licensemanagement-statistics]]
== License usages overview

The tab "Statistics" displays a summary of the different _license-pools_,
showing the total number of license options ('license_options') and how many of them are in use ('used_by_opsi') or still available ('remaining opsi').

.License management: "Statistics" tab from the license management window
image::licensemanagement-statistics.png["License management: Statistics tab from the license management window", pdfwidth=90%]

In addition to the number of license-uses registered by opsi ('used by opsi')
and the currently available licenses ('remaining...'), the overview also shows the total number of detected installations, that require a license ('SWinventory_used').

The data from the column 'SWinventory_used' is based on the registry scans from the _opsi-product_  _swaudit_ and the assignment of the Windows software IDs (as they are found in the registry) to the _license-pools_ (as registered with the opsi license management (tab "License pools", see <<opsi-manual-licensemanagement-licensepools>>).

From the context menu, the table can be printed (because of restricted access rights not available from the applet), and using drag&drop data can be copied to e.g. a spreadsheet.

[[opsi-manual-licensemanagement-statistics-downgrade-option]]
=== In case of downgrade option

If a downgrade option has been configured (see <<opsi-manual-licensemanagement-editlicense-downgrade-option>>), it appears in the overview and statistics like this:

A single downgrade license results in a license option for at least two different _license-pools_ but only one of them can be requested for an installation.
So using a downgrade license option decreases the number of available license options ('remaining_opsi') in each of the _license-pools_ concerned by that downgrade option by _1_.
So it looks like a single installation reduces the number of available license options by _2_, which, in this case, actually is the fact.

[[opsi-manual-licensemanagement-service-methods]]
== Service methods for license management

The service methods for license management can be called from the command-line tool 'opsi-admin', so they are accessible for scripting, e.g. to read license keys from a file.

Examples can be found in the products 'license-test-....opsi' from https://download.uib.de/opsi4.1/misc/license-management/.
After installing the packages with opsi-package-manager -i \*.opsi, in the directory /var/lib/opsi/depot/<product name> the corresponding scripts: create_license-*.sh can be found.

As an example here the script `create_license-mixed.sh`
(the current version comes with the download packet).

[source,prompt]
----
#!/bin/bash
# This is a test and example script
# (c) uib gmbh licensed under GPL

PRODUCT_ID=license-test-mixed
# read the license key from a file
# myretailkeys.txt has one licensekey per line
MYRETAILKEYS=`cat myretailkeys.txt`
# myoemkeys.txt has one pair: <licensekey> <hostid.domain.tld> per line
MYOEMKEYS=`cat myoemkeys.txt`
# some output
echo "$PRODUCT_ID"

# this is the function to create the oem licenses
#############
createlic ()
{
while [ -n "$1" ]
do
	#echo $1
	AKTKEY=$1
	shift
	#echo $1
	AKTHOST=$1
	shift
	echo "createSoftwareLicense with oem key: ${PRODUCT_ID}-oem-${AKTKEY} for host ${AKTHOST}"
	MYLIC=`opsi-admin -dS method createSoftwareLicense "" "c_$PRODUCT_ID" "OEM" "1" "${AKTHOST}" ""`
	opsi-admin -d method addSoftwareLicenseToLicensePool "$MYLIC" "p_$PRODUCT_ID" "${PRODUCT_ID}-oem-${AKTKEY}"
done
}
#############

# here the script starts

# delete the existing license pool and all connected licenses
# ATTENTION: never (!) do this on a productive system
echo "deleteLicensePool p_$PRODUCT_ID"
opsi-admin -d method deleteLicensePool "p_$PRODUCT_ID" true

# delete the existing license contract
echo "deleteLicenseContract c_$PRODUCT_ID"
opsi-admin -d method deleteLicenseContract "c_$PRODUCT_ID"

# create the new license pool
# the used method has the following syntax:
# createLicensePool(*licensePoolId, *description, *productIds, *windowsSoftwareIds)
echo "createLicensePool p_$PRODUCT_ID"
opsi-admin -d method createLicensePool "p_$PRODUCT_ID" "opsi license test" \'['"'$PRODUCT_ID'"']\' \'['"'$PRODUCT_ID'"']\'

# create the new license contract
# the used method has the following syntax:
# createLicenseContract(*licenseContractId, *partner, *conclusionDate, *notificationDate, *expirationDate, *notes)
echo "createLicenseContract c_$PRODUCT_ID"
opsi-admin -d method createLicenseContract "c_$PRODUCT_ID" "uib gmbh" "" "" "" "test contract"

# create the new license and add the key(s)
# the used methods have the following syntax:
# createSoftwareLicense(*softwareLicenseId, *licenseContractId, *licenseType, *maxInstallations, *boundToHost, *expirationDate)
# addSoftwareLicenseToLicensePool(softwareLicenseId, licensePoolId, *licenseKey)

# create the retail licenses:
for AKTKEY in $MYRETAILKEYS
do
	echo "createSoftwareLicense with retail key: ${PRODUCT_ID}-retail-${AKTKEY}"
	MYLIC=`opsi-admin -dS method createSoftwareLicense "" "c_$PRODUCT_ID" "RETAIL" "1" "" ""`
	opsi-admin -d method addSoftwareLicenseToLicensePool "$MYLIC" "p_$PRODUCT_ID" "${PRODUCT_ID}-retail-${AKTKEY}"
done

# create the oem licenses
createlic $MYOEMKEYS

# create the volume licenses
echo "createSoftwareLicense with volume key: ${PRODUCT_ID}-vol-key"
MYLIC=`opsi-admin -dS method createSoftwareLicense "" "c_$PRODUCT_ID" "VOLUME" "10" "" ""`
opsi-admin -d method addSoftwareLicenseToLicensePool "$MYLIC" "p_$PRODUCT_ID" "${PRODUCT_ID}-vol-key"#

----

[[opsi-manual-licensemanagement-examples]]
== Example products and templates

In the uib download section at https://download.uib.de/opsi4.1/misc/license-management/ are four example products available.
One for each type of license model, as there are Retail, OEM and Volume license type, as well as a product combining all of them.

These example products use as an example some licenses and release them again.
So using them leaves some marks in the software inventory, that might be of influence to reconciliation and statistics.

All of these products contain a shell script to automatically generate _license-pools_, license contracts and license options.

The standard template for _opsi-winst_ scripts 'opsi-template' also contains some examples for using the opsi license management.
