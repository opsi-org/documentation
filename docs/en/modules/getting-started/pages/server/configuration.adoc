////
; Copyright (c) uib gmbh (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
////

:Author:    uib gmbh
:Email:     info@uib.de
:Date:      02.05.2023
:Revision:  4.2
:toclevels: 6
:doctype:   book
:icons: font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]

[[opsi-getting-started-installation-config]]
= Configuration

This chapter explains how to update a freshly installed opsi server and then how to install the standard products. It also covers the backend and samba configuration of the opsi server, users and groups for administration, the DHCP configuration and the name resolution.

[[opsi-getting-started-installation-config-update-server]]
== Updating the opsi Server

Before you configure the opsi server, make sure that the packages of the underlying Linux system are up-to-date. If you use the virtual machine provided by us (see section xref:getting-started:server/base-installation.adoc#opsi-getting-started-installation-base-vm[Starting the preconfigured Virtual Machine]), then use the package management tool APT. The VM is based on the latest Ubuntu LTS version. On Debian and other Ubuntu versions, you can also use APT to upgrade the server; the last command removes packages which were installed as dependencies and are no longer needed:

[source,prompt]
----
sudo apt update
sudo apt upgrade
sudo apt autoremove
----

Enter the password of the user `adminuser` when prompted.

TIP: On our preconfigured VM, you can double-click the icon _Update OS_ on the desktop background. It executes exactly these commands in a terminal.

On SLES/openSUSE you can use the tool `zypper` to upgrade the server:

[source,prompt]
----
sudo zypper refresh
sudo zypper update
----

If you use RHEL/AlmaLinux/Rocky Linux, then enter the following commands to upgrade the distribution:

[source,prompt]
----
sudo yum check-update
sudo yum update
----

After the upgrade is complete, restart the server.

NOTE: If you use a proxy server to access the internet, configure it via the `http_proxy` and `https_proxy` environment variables (see chapter xref:getting-started:server/requirements.adoc[Prerequisites]).

[[opsi-getting-started-installation-config-update-opsi-product]]
== Installing the Standard Products

After upgrading the Linux system of your opsi server it's time to install the opsi standard products. Enter the following command in a terminal:

[source,prompt]
----
sudo opsi-package-updater -v install
----

Enter the password for the user `adminuser` at the prompt.

The command updates current opsi packages, including the templates for OS deployments, from the opsi repositories. 

.Install the standard products on your opsi server.
image::opsi-package-updater.png["Install the standard products on your opsi server.", pdfwidth=80%]

TIP: On our preconfigured virtual machine, you can alternatively double-click the _First package installation_ desktop icon to install the standard products.

[[opsi-getting-started-installation-config-update-start-configed]]
== Starting the Management Interface

In the virtual machine you can start the management interface `opsi-configed` by double-clicking on the desktop icon _Opsi Configuration Editor_. More information about this graphical application can be found in xref:manual:configed.adoc[Management Interface `opsi-configed`].

[[opsi-getting-started-installation-config-backend]]
== Backend Configuration

opsi supports different backends. For data storage, there are basically these two:

* *file*: data storage in files
* *mysql*: data storage in a MySQL database

NOTE: Some distributions use MariaDB instead of MySQL. The MySQL backend also works with MariaDB. The MySQL backend for inventory data is free. Read more about our paid extensions in chapter xref:manual:modules/modules.adoc[opsi Extensions].

In addition, these backends exist for special purposes:

* *opsipxeconfd*: the service for opsi network boot
* *dhcpd*: for communication with the DHCP service on the opsi server
* *jsonrpc*: execute {json-rpc} methods on an opsi server

By default, the MySQL backend is used for inventory data. It is possible to use the file backend for inventory--this is significantly slower, though.

=== MySQL Backend Configuration

The following sections show how to set up the MySQL backend. We assume that you have installed and configured the MySQL server and that you know the credentials of the database administrator.

TIP: If you use our preconfigured virtual machine, the password for the database administrator is `linux123`. For security reasons, you should change this in a production environment. For more information about MySQL, please refer to the manuals of your distribution.

To initially configure the MySQL backend, enter the following command; it requires root privileges:

[source,prompt]
----
opsi-setup --configure-mysql
----

You'll see the following dialog:

.Configure the MySQL backend for the opsi server.
image::mysql-config-input-mask.png["Configure the MySQL backend for the opsi server.", pdfwidth=80%]

Enter `localhost` in the `Database host` field, the `Database admin user` is `root` (if not configured otherwise), and in the `Database admin password` field you have to enter the administrator password set up during the MySQL server installation. You can accept the other default settings. Use the [Tab] key to navigate to `OK` and press [Enter].

After that the new database `opsi` and a new user `opsi` with appropriate permissions for this database will be created.

.The new database and a user have been created.
image::mysql-config-output.png["The new database and a user have been created.", pdfwidth=80%]

You should see the message `MySQL Backend configuration done`.

=== Assigning Methods and Backends

opsi can store different data in different backends. For some actions (such as method calls) more than one backend is involved. For this purpose, the configuration file `/etc/opsi/backendManager/dispatch.conf` assigns the opsi methods to the backends.

Here's an example:
[source,configfile]
----
# = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
# =      backend dispatch configuration                                     =
# = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
#
# This file configures which methods are dispatched to which backends.
# Entries has to follow the form:
# <regular expression to match method name(s)> : <comma separated list of backend name(s)>
#
# Backend names have to match a backend configuration
# file basename <backend name>.conf beneath /etc/opsi/backends.
# For every method executed on backend dispatcher
# the first matching regular expression will be decisive.

# Recommended standard configuration (dhcpd not at the opsi server)
#    file as main backend, mysql as hw/sw invent
#     and license management backend and {opsipxeconfd} backend:
backend_.*         : file, mysql, {opsipxeconfd}
host_.*            : file, {opsipxeconfd}
productOnClient_.* : file, {opsipxeconfd}
configState_.*     : file, {opsipxeconfd}
license.*          : mysql
softwareLicense.*  : mysql
audit.*            : mysql
.*                 : file
----

The first few lines contain comments (behind a hashtag symbol), followed by example setups and explanations. At the bottom, in the lines that are not commented out, you can see the name of the opsi methods (with wildcard `.*`), a colon and then a list of backends used by that opsi method.

For every method call opsi uses this list to check which backends it has to address. It uses the first line that matches the name of the method. The last line (`.*`) matches all opsi method calls.

The default setting after the installation is: The file backend comes first and is the main backend, except for license management and hardware/software inventory. Here, the MySQL backend takes over. 

WARNING: Make sure that all used backends are listed in the line starting with `backend_.*`.

If you have edited the `dispatch.conf` file, then run the following commands to initialize the configuration and restart opsi:

[source,prompt]
----
opsi-setup --init-current-config
opsi-set-rights
systemctl restart opsiconfd.service
systemctl restart opsipxeconfd.service
----

The commands apply the change to the opsi database, set the permissions and restart the two services `opsiconfd` and `opsipxeconfd`.

[[opsi-getting-started-installation-config-passwords]]
== Samba Configuration

To ensure that the Samba shares required for opsi are available, please run the following command:

[source,prompt]
----
opsi-setup --auto-configure-samba
----

After that restart the samba services:

[source,prompt]
----
systemctl restart smbd.service
systemctl restart nmbd.service
----

TIP: If you are asked if you want to overwrite the `smb.conf` file when you upgrade the opsi server packages, confirm this. If you changed the `/etc/samba/smb.conf` file before the upgrade, keep it and merge the files later.

=== Password for User `pcpatch`

A pseudo user `pcpatch` exists on the opsi server. Clients log in with this account to install software and to get access to the installation files on the Samba shares. The `pcpatch` user requires a password that applies to the system account, the Samba account, and the opsi account. You can set this password for all three accounts with one single `opsi-admin` command:

[source,prompt]
----
{opsi-admin} -d task setPcpatchPassword
----

After you hint [Enter] a password prompt appears and you can type the password.

[[opsi-getting-started-installation-config-users-and-groups]]
== User and Group Accounts for opsi

NOTE: On the preconfigured virtual machine, the `adminuser` account and the two groups `opsiadmin` and `opsifileadmins` have already been set up, so you can skip this section.

A user must be a member of the `opsiadmin` group to perform administrative tasks on the opsi server. The following command creates a new user account named `adminuser` and you run it as `root`:

[source,prompt]
----
useradd -m -s /bin/bash adminuser
----

Next, set a Unix password (system) for the new account:

[source,prompt]
----
passwd adminuser
----

Additionally, the account needs a Samba password:

[source,prompt]
----
smbpasswd -a adminuser
----

WARNING: Do not use the `§` character in the two passwords!

Next, add the `adminuser` account to the `opsiadmin` group:

[source,prompt]
----
usermod -aG {opsi-admin-group} adminuser
----

You can use the `getent` command to check that this was successful:

[source,prompt]
----
getent group {opsi-admin-group}
opsiadmin:x:1001:opsiconfd,adminuser,root
----

NOTE: If `root` isn't a member of the `opsiadmin` group, the user may not be able to execute all opsi administration commands!

For everyday work on your opsi server it's usually not necessary to work as `root`.
We recommend to log in as normal user and put `sudo` in front of the commands which need root privileges.

All users who package (`opsi-makepackage`), install (`opsi-package-manager`) or edit configuration files in a text editor must also be a member of the `opsifileadmins` group:

[source,prompt]
----
usermod -aG {opsi-file-admin-group} adminuser
----

Again, you can use `getent` to check the result:

[source,prompt]
----
getent group {opsi-file-admin-group}
opsifileadmins:x:999:adminuser,root
----

To allow members of the `opsifileadmins` group to run `sudo opsi-set-rights`, run the following command:

[source,prompt]
----
opsi-setup --patch-sudoers-file
----

TIP: `opsi-set-rights` is equivalent to `opsi-setup --set-rights`.

[[opsi-getting-started-installation-config-dhcp]]
== DHCP Configuration

A properly configured name resolution (see section <<opsi-getting-started-installation-config-nameresolution>>) and DHCP (Dynamic Host Configuration Protocol) are important for opsi to work correctly. This section focuses on DHCP: the protocol ensures that newly integrated devices in the network are automatically configured. This includes, for example, the dynamic assignment of IP addresses, netmask, gateway, etc. 

The opsi server can work as a DHCP server and configure connected clients automatically (section <<opsi-getting-started-installation-config-dhcp-at-opsi>>). In many environments, a DHCP server is already present; therefore, section <<opsi-getting-started-installation-config-at-other-server>> describes how to use that.

[[opsi-getting-started-installation-config-dhcp-at-opsi]]
=== DHCP on the opsi Server

NOTE: The preconfigured virtual machine is already equipped with a DHCP server that has no free leases, i.e. it doesn't assign IP addresses to unknown clients. Therefore, when you create a client through the `opsi-configed` management interface, you specify its IP address and the MAC address, which are then entered in the `/etc/dhcp/dhcpd.conf` configuration file. The DHCP service will be restarted after that.

If you have installed the opsi server yourself and want to use it as DHCP server, install the package `isc-dhcp-server` respectively `dhcp-server`. Since opsi 4.0.3 this is no longer installed automatically.

On Debian-based systems, use the fowllowing command:

[source,prompt]
----
apt install isc-dhcp-server
----

TIP: On many distributions, the package is called `dhcp-server` instead (RHEL, Rocky Linux, AlmaLinux, SLES, etc.)--if in doubt, check the manual or the Linux system's package sources.

After the installation, adjust the configuration file; you can use the `opsi-setup` tool for this:

[source,prompt]
----
opsi-setup --auto-configure-dhcpd
----

The permissions of the DHCP server configuration file should be as follows:

[source,prompt]
----
-rw-r--r-- 1 {opsiconfd} {opsi-admin-group} 80174 Dec 22 14:37 /etc/dhcp/dhcpd.conf
----

[[opsi-getting-started-installation-config-at-other-server]]
=== Using an External DHCP Server

NOTE: To uninstall the DHCP server of the preconfigured virtual machine, use the following command:

[source,prompt]
----
apt remove isc-dhcp-server
----

If there is a DHCP server in your network, then configure it to enable PXE boot via the opsi server. If the service runs on a Linux machine, adjust the configuration file `/etc/dhcp/dhcpd.conf` and enter this:

[source,configfile]
----
next-server <IP-opsi-Server>;
filename "linux/pxelinux.0";
----

Replace `<IP-opsi-Server>` with the opsi server's IP address.

On openSUSE and SLES, the second line is like this:

[source,configfile]
----
filename=opsi/pxelinux.0
----

On UCS, the line looks like this:

[source,configfile]
----
filename=pxelinux.0
----

On a Windows server, the corresponding entries are `bootserver (Option 66)` and `bootfile (Option 67)`.

NOTE: If you are using an external DHCP server, when you create a client in the `opsi-configed` management interface, specify its MAC address, but not its IP address.

[[opsi-getting-started-installation-config-dhcp-backend]]
=== Adjusting the Backend

Depending on whether you use the DHCP server on the opsi server or as an external service, the backend configuration looks different. In the file `/etc/opsi/backendManager/dispatch.conf` you define which opsi backends are used (see the section <<opsi-getting-started-installation-config-backend>>).

The two lines `backend_.*` and `host_.*` control whether the opsi server also handles the local DHCP configuration, i.e. the assignment of IP addresses to the MAC addresses of the network cards. This is necessary if the DHCP entries of the opsi clients should be generated by the opsi configuration calls. In this case the two lines in the file `dispatch.conf` look like this:

[source,configfile]
----
backend_.*         : file, opsipxeconfd, dhcpd
host_.*            : file, opsipxeconfd, dhcpd
----

If the opsi server does not provide the DHCP service (because another server in the local network handles this task), then you do not need the backend `dhcpd`:

[source,configfile]
----
backend_.*         : file, {opsipxeconfd}
host_.*            : file, {opsipxeconfd}
----

NOTE: If you have edited the `dispatch.conf` file, then run the following commands to initialize the configuration and restart opsi:

[source,prompt]
----
opsi-setup --init-current-config
opsi-set-rights
systemctl restart opsiconfd.service
systemctl restart opsipxeconfd.service
----

[[opsi-getting-started-installation-config-nameresolution]]
== Name Resolution

To install software on the opsi clients before login, only the clients need to know how to reach the opsi server.

NOTE: New opsi versions support a number of push functionalities, such as on-demand installations, sending messages, launching remote control software, retrieving session information, etc.

For all these tasks, the server must be able to reach the clients and determine their IP address. DHCP and DNS must therefore be configured accordingly in the network. There are several ways to do this--two typical scenarios are listed below:

. The clients are not known by th DNS and have dynamically assigned, changing IP addresses.

. The IP addresses of all running clients are always known and can be queried via DNS.

To adapt the opsi server to the different situations, there are two configuration files, which you can change:

* `/etc/opsi/backends/hostcontrol.conf`: +.
If you set `resolveHostAddress` to `True`, then the IP address of the client will be preferably determined by name resolution when establishing a connection from the opsi server to the opsi client. To use the IP address stored in the backend of opsi instead, set the option to `False`.

* `/etc/opsi/opsiconfd.conf`: +
If the option `update-ip` is set to `true` (default), then the IP database of the opsi server will be updated whenever the opsi server receives an IP address from a client, e.g. on every connection from client to server.

For variant 1 listed above, it makes sense to set `resolveHostAddress` to `False` and `update-ip` to `true`.

For variant 2 listed above, it is better to set `resolveHostAddress` to `True` and `update-ip` to `false`.

If you have changed anything in these configuration files, then restart the `opsiconfd` service:

[source,prompt]
----
systemctl restart opsiconfd.service
----
