////
; Copyright (c) uib gmbh (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
////

:Author:    uib gmbh
:Email:     info@uib.de
:Date:      25.04.2023
:Revision:  4.2
:toclevels: 6
:doctype:   book
:icons: font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]

[[opsi-getting-started-installation-config]]
= Configuration

In this chapter, #####

[[opsi-getting-started-installation-config-update-server]]
== Updating the opsi Server

Before you configure the opsi server, make sure that the packages of the underlying Linux system are up-to-date. If you use the virtual machine provided by us (see section xref:getting-started:server/base-installation.adoc#opsi-getting-started-installation-base-vm[Starting the preconfigured Virtual Machine]), then use the package management tool APT. The VM is based on the latest Ubuntu LTS version. On Debian and other Ubuntu versions, you can also use APT to upgrade the server; the last command removes packages which were installed as dependencies and are no longer needed:

[source,prompt]
----
sudo apt update
sudo apt upgrade
sudo apt autoremove
----

Enter the password of the user `adminuser` when prompted.

TIP: On our preconfigured VM, you can double-click the icon _Update OS_ on the desktop background. It executes exactly these commands in a terminal.

On SLES/openSUSE you can use the tool `zypper` to upgrade the server:

[source,prompt]
----
sudo zypper refresh
sudo zypper update
----

If you use RHEL/AlmaLinux/Rocky Linux, then enter the following commands to upgrade the distribution:

[source,prompt]
----
sudo yum check-update
sudo yum update
----

After the upgrade is complete, restart the server.

NOTE: If you use a proxy server to access the internet, configure it via the `http_proxy` and `https_proxy` environment variables (see chapter xref:getting-started:server/requirements.adoc[Prerequisites]).

[[opsi-getting-started-installation-config-update-opsi-product]]
== Installing the Standard Products

After upgrading the Linux system of your opsi server it's time to install the opsi standard products. Enter the following command in a terminal:

[source,prompt]
----
sudo opsi-package-updater -v install
----

Enter the password for the user `adminuser` at the prompt.

The command updates current opsi packages, including the templates for OS deployments, from the opsi repositories. 

.Install the standard products on your opsi server.
image::opsi-package-updater.png["Install the standard products on your opsi server.", pdfwidth=80%]

TIP: On our preconfigured virtual machine, you can alternatively double-click the _First package installation_ desktop icon to install the standard products.

[[opsi-getting-started-installation-config-update-start-configed]]
== Starting the Management Interface

In the virtual machine you can start the management interface `opsi-configed` by double-clicking on the desktop icon _Opsi Configuration Editor_. More information about this graphical application can be found in xref:manual:configed.adoc[Management Interface `opsi-configed`].

[[opsi-getting-started-installation-config-backend]]
== Backend Configuration

opsi supports different backends. For data storage, there are basically these two:

* *file*: data storage in files
* *mysql*: data storage in a MySQL database

NOTE: Some distributions use MariaDB instead of MySQL. The MySQL backend also works with MariaDB. The MySQL backend for inventory data is free. Read more about our paid extensions in chapter xref:manual:modules/modules.adoc[opsi Extensions].

In addition, these backends exist for special purposes:

* *opsipxeconfd*: the service for opsi network boot
* *dhcpd*: for communication with the DHCP service on the opsi server
* *jsonrpc*: execute JSON-RPC methods on an opsi server

By default, the MySQL backend is used for inventory data. It is possible to use the file backend for inventory--this is significantly slower, though.

=== MySQL Backend Configuration

The following sections show how to set up the MySQL backend. We assume that you have installed and configured the MySQL server and that you know the credentials of the database administrator.

TIP: If you use our preconfigured virtual machine, the password for the database administrator is `linux123`. For security reasons, you should change this in a production environment. For more information about MySQL, please refer to the manuals of your distribution.

To initially configure the MySQL backend, enter the following command; it requires root privileges:

[source,prompt]
----
opsi-setup --configure-mysql
----

You'll see the following dialog:

.Configure the MySQL backend for the opsi server.
image::mysql-config-input-mask.png["Configure the MySQL backend for the opsi server.", pdfwidth=80%]

Enter `localhost` in the `Database host` field, the `Database admin user` is `root` (if not configured otherwise), and in the `Database admin password` field you have to enter the administrator password set up during the MySQL server installation. You can accept the other default settings. Use the [Tab] key to navigate to `OK` and press [Enter].

After that the new database `opsi` and a new user `opsi` with appropriate permissions for this database will be created.

.The new database and a user have been created.
image::mysql-config-output.png["The new database and a user have been created.", pdfwidth=80%]

You should see the message `MySQL Backend configuration done`.

=== Assigning Methods and Backends

opsi can store different data in different backends. For some actions (such as method calls) more than one backend is involved. For this purpose, the configuration file `/etc/opsi/backendManager/dispatch.conf` assigns the opsi methods to the backends.

Here's an example:
[source,configfile]
----
# = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
# =      backend dispatch configuration                                     =
# = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
#
# This file configures which methods are dispatched to which backends.
# Entries has to follow the form:
# <regular expression to match method name(s)> : <comma separated list of backend name(s)>
#
# Backend names have to match a backend configuration
# file basename <backend name>.conf beneath /etc/opsi/backends.
# For every method executed on backend dispatcher
# the first matching regular expression will be decisive.

# Recommended standard configuration (dhcpd not at the opsi server)
#    file as main backend, mysql as hw/sw invent
#     and license management backend and opsipxeconfd backend:
backend_.*         : file, mysql, opsipxeconfd
host_.*            : file, opsipxeconfd
productOnClient_.* : file, opsipxeconfd
configState_.*     : file, opsipxeconfd
license.*          : mysql
softwareLicense.*  : mysql
audit.*            : mysql
.*                 : file
----

The first few lines contain comments (behind a hashtag symbol), followed by example setups and explanations. At the bottom, in the lines that are not commented out, you can see the name of the opsi methods (with wildcard `.*`), a colon and then a list of backends used by that opsi method.

For every method call opsi uses this list to check which backends it has to address. It uses the first line that matches the name of the method. The last line (`.*`) matches all opsi method calls.

The default setting after the installation is: The file backend comes first and is the main backend, except for license management and hardware/software inventory. Here, the MySQL backend takes over. 

CAUTION: Make sure that all used backends are listed in the line starting with `backend_.*`.

If you have edited the `dispatch.conf` file, then run the following commands:

[source,prompt]
----
opsi-setup --init-current-config
opsi-set-rights
systemctl restart opsiconfd.service
systemctl restart opsipxeconfd.service
----

The commands apply the change to the opsi database, set the permissions and restart the two services `opsiconfd` and `opsipxeconfd`.

[[opsi-getting-started-installation-config-passwords]]
== Set Samba Configuration and Change Passwords

Opsi requires certain samba shares. To ensure that they are available please enter the following command:

[source,prompt]
----
opsi-setup --auto-configure-samba
----

Please restart the samba services using the following commands:

[source,prompt]
----
systemctl restart smbd.service
systemctl restart nmbd.service
----


TIP: If the server is updated and it asks if the file smb.conf should be overwritten, you have to confirm this. +
If the smb.conf has been customised before, you should keep the default and merge the files later. +
If this question has already been answered with no, you can repeat this later on the {opsi-Server} by running `opsi-setup --auto-configure-samba`.


A 'pcpatch' pseudo-user is created on the system. Clients login with this user to install software and to get access to the installation files on the samba shares. The user 'pcpatch' must be created with a correct password - simultaneously as a system user, as a samba user and as an opsi user.

In a terminal window the program '{opsi-admin}' should be executed, which will set the pcpatch-password (for the opsi, unix and samba user).

[source,prompt]
----
opsi-admin -d task setPcpatchPassword
----

After executing the command you are asked to enter the password.


[[opsi-getting-started-installation-config-users-and-groups]]
== Create users and configure the groups opsiadmin and opsifileadmins

Administrative control of opsi is only allowed for members of the UNIX-group '{opsi-admin-group}'.

In the following example, we create the user 'adminuser'.

Firstly we create the user:

[source,prompt]
----
useradd -m -s /bin/bash adminuser
----

We then set the unix password:

[source,prompt]
----
passwd adminuser
----

and now the samba password:

[source,prompt]
----
smbpasswd -a adminuser
----

CAUTION: Do not use the character '§' in the passwords, because this character is not permitted when connecting to the opsi service.

Now we create and test the group membership with these commands:

[source,prompt]
----
usermod -aG opsiadmin adminuser
getent group opsiadmin
----

The getent command should show a result like this:
[source,prompt]
----
opsiadmin:x:1001:opsiconfd,adminuser
----

NOTE: When 'root' is not a member of the {opsi-admin-group}, then 'root' will not be able to use all administrative opsi commands! +

To perform everyday tasks on your opsi server, it is usually not necessary to be logged in as 'root'.
Our recommendation is to use a normal user and use the `sudo` command whenever administrative privileges are required.

All users who build opsi packages (`opsi-makepackage`), install opsi packages (`opsi-package-manager`), or manually edit the configuration files also have to be members of the group '{opsi-file-admin-group}' :

[source,prompt]
----
usermod -aG opsifileadmins adminuser
----

Test the results by entering:

[source,prompt]
----
getent group opsifileadmins
----
The result should look like +
'opsifileadmins:x:998:adminuser'

To make `sudo opsi-set-rights` available for users of the group 'pcpatch', please execute:
[source,prompt]
----
opsi-setup --patch-sudoers-file
----

Afterwards `opsi-set-rights`, which does the same as `opsi-setup --set-rights`, can be executed not only as root, but also with sudo by members of the group 'opsi-file-admins':

Example: +
[source,prompt]
----
sudo opsi-set-rights .
----


[[opsi-getting-started-installation-config-dhcp]]
== DHCP Configuration

A correctly working name resolution and DHCP are essential for the correctly functioning of opsi.
To simplify the setup the {opsi-server} VM is supplied with a working DHCP server.
On the other hand, in many environments there often already exists a DHCP server, which will be used with opsi.
Both alternatives are described below.


[[opsi-getting-started-installation-config-dhcp-at-opsi]]
=== Using a DHCP Server at the {opsi-server}

.Using the opsi-Server VM:
The preconfigured opsi VM already has a DHCP server installed. +
The DHCP server on the {opsi-server} VM is configured with no free leases, so no unknown clients will get an IP address from this DHCP server. +
If you create a client on the {opsi-server} using {opsi-configed}, you must supply the IP address and MAC address of the client. This will be entered into `/etc/dhcp/dhcpd.conf` and the DHCP service will be restarted.

.Your own installation:
If you want to use the opsi server as a DHCP server, you have to install the corresponding DHCP server package.

e.g.
[source,prompt]
----
apt install isc-dhcp-server
----

After the installation the dhcp configuration file has to be adjusted. This is done by the following command:
[source,prompt]
----
opsi-setup --auto-configure-dhcpd
----
To restart the DHCP server, as described in `/etc/opsi/backends/dhcpd.conf`, an entry in `/etc/sudoers` is required. This is created using the command:
[source,prompt]
----
opsi-setup --patch-sudoers-file
----
The permissions for the dhcpd configuration file should look similar to this:
[source,prompt]
----
-rw-r--r-- 1 opsiconfd opsiadmin 80174 Dec 22 14:37 /etc/dhcp/dhcpd.conf
----


[[opsi-getting-started-installation-config-at-other-server]]
=== Using an External DHCP Server

.Using the opsi-Server VM:
If you use an external DHCP server, then you can uninstall the DHCP server on the {opsi-server}.

This is done by entering this command:
[source,prompt]
----
apt remove isc-dhcp-server
----

.Your own installation:
Since opsi 4.0.3 a DHCP server will not be installed automatically in this situation.

You have to configure the external DHCP server, so a PXE boot from the {opsi-server} is possible. If your external DHCP runs on Linux, then you need the following entries for the clients in the DHCP daemon configuration file (i.e. `etc/dhcp/dhcpd.conf`):

[source,configfile]
----
next-server <ip of opsi-server>;
filename "linux/pxelinux.0";
----

Replace '<ip of opsi-server>' with the IP address of your {opsi-server}.

If the opsi server runs on openSUSE or SLES, then `filename=opsi/pxelinux.0`. +
If the opsi server runs on UCS, then `filename=pxelinux.0`.

If you are using a Windows DHCP server, then the corresponding entries are 'bootserver (Option 66)' and 'bootfile (Option 67)'.

If you create a client on the {opsi-server}, then you only have to supply the MAC-address, but not the IP address.


[[opsi-getting-started-installation-config-dhcp-backend]]
=== Checking the Backend Configuration for DHCP Entries

Regardless of whether or not you use an external DHCP server, the configuration of the {opsi-server} must be changed.

The file `/etc/opsi/backendManager/dispatch.conf` defines which backends are used (i.e. 'file', 'mysql').

The lines with the `backend_.*` and `host_.*` entries configure whether or not the {opsi-server} should work with the local DHCP configuration.
If you are using the DHCP server on the {opsi-server}, then the backend dhcpd has to be added here. The corresponding entry with `file` backend must then look like this:
[source,configfile]
----
backend_.*         : file, opsipxeconfd, dhcpd
host_.*            : file, opsipxeconfd, dhcpd
----

If the local DHCP service on the {opsi-server} isn't used (because another server in the local network performs this task, and is also used for the {opsi-Client}s), then the backend `dhcpd` is not required:

[source,configfile]
----
backend_.*         : file, opsipxeconfd
host_.*            : file, opsipxeconfd
----

After editing the backend configuration, the configuration has to be initialised and the {opsiconfd} service has to be restarted:

[source,prompt]
----
opsi-setup --init-current-config
opsi-set-rights
systemctl restart opsiconfd.service
systemctl restart opsipxeconfd.service
----


[[opsi-getting-started-installation-config-nameresolution]]
== Configuration of the name resolution

To install software on the clients before login, generally only the clients have to know how to contact the {opsi-server}.

However, opsi also has a number of 'push' features such as 'on_demand' events, sending messages, starting remote control software, and retrieving session information.

For all these functions the server must be able to reach the client and therefore needs to determine the IP address of the client. How this works best depends on the specific configuration of DNS and DHCP. There are a large number of possible configurations.

Therefore we show two typical extremes:

. The clients are not known by the DNS, and they have dynamically assigned frequently changing IP addresses.

. The DNS always provides the correct IP address of a client.

To adapt the opsi server to different situations, you may change the following parameters:

* The entry +resolveHostAddress+ in the file `/etc/opsi/backends/hostcontrol.conf` +
If this option is set to 'True', when connecting from the {opsi-server} to an opsi-client, the IP address of the client is first determined via the name resolution. To give preference to the IP address stored in the opsi backend, the option must be set to 'False'.

* The entry +update ip+ in the file `/etc/opsi/opsiconfd.conf` +
If this entry is set to 'yes', whenever the opsi-server receives an IP address from a client (e.g. on every connection the client makes) the IP address stored in the backend will be updated. The default is 'yes'.

For the first variant, then you should probably set +resolveHostAddress+ to 'False' and +update ip+ to 'yes'.

FOr the second variant, then the best configuration is to set  +resolveHostAddress+ to 'True' and +update ip+ to 'no'.

You should decide for yourself which combination fits your situation best.

If you changed anything in these files, then you should restart the opsiconfd:

[source,prompt]
----
systemctl restart opsiconfd.service
----


