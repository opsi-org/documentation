////
; Copyright (c) uib gmbh (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
////

:Author:    uib gmbh
:Email:     info@uib.de
:Date:      21.04.2023
:Revision:  4.2
:toclevels: 6
:doctype:   book
:icons: font
:xrefstyle: full

include::common:partial$opsi_terms.adoc[]

[[opsi-getting-started-installation-base]]
= Installation

This chapter presents different ways to install an opsi server: <<opsi-getting-started-installation-base-vm>>,
// <opsi-getting-started-installation-base-docker>>,
<<opsi-getting-started-installation-base-quickinstall>>, and the <<opsi-getting-started-installation-base-packages>> on Debian, Ubuntu, openSUSE/Suse Linux Enterprise Server (SLES), CentOS, Red Hat Enterprise Linux (RHEL), Alma Linux, Rocky Linux, and Univention Corporate Server (UCS).

[[opsi-getting-started-installation-base-vm]]
== Starting the preconfigured Virtual Machine

The opsi server itself needs relatively little computing power. Therefore it's no problem to run it as a virtual machine. We offer a ready-to-use and preconfigured virtual machine for download on our link:https://uib.de/de/opsi/opsi-testen-download/[website].

You can run the virtual machine in link:https://www.virtualbox.org/[VirtualBox], link:https://www.vmware.com/de/products/workstation-player.html[VMware Workstation Player], or link:https://www.vmware.com/de/products/esxi-and-esx.html[VMware ESXi].

[[opsi-getting-started-installation-base-vm-start]]
=== VM herunterladen und importieren

Download the virtual machine and extract the zip file. In most graphical work environments, this can be done in the respective file manager with a right-click and _Unzip here_ or similar. Alternatively, use a program like link:https://www.7-zip.de/[7-Zip] (Windows) or the command `unzip` on Linux in the shell. Afterwards. you will find the three files `opsi[...].vmdk`, `opsi[...].mf` and `opsi[...].ovf` in the current directory.

This is how you import the virtual machine:

*VMware Workstation Player*

* Select _Open a Virtual Maschine_ from the menu and navigate to the folder with the files from the extracted zip file.
* Select the `.ovf` file. (In case it's not visible change the type to _Virtual Machines (*vmx, *.ovf, *.ova)_ at the bottom of the dialog.)
* Click _Open_, enter a name and a location.
* Finally, click _Import_.
* You can now start the VM via  _Power On_.

.VMware Workstation Player: Importing the virtual machine
image::vmware-player-import.png["VMware Workstation Player: Importing the virtual machine", pdfwidth=80%]

*ESXi Server*

* Start vSphere Client.
* Install a new client via _File_ / _Deploy OVF Template_ and navigate to the `.ovf` file.
* Click _Open_ and _Next_.
* Enter a name or stick with the default settings.
* Click _Next_ to check the summary, and then _Finish_ to start the import.


*VirtualBox* 

* Select _File / _Import Appliance_ from the menu.
* In the file selection dialog, navigate to the `.ovf` file and click _Open_.
* After clicking _Next_, you can edit the settings in the following dialog and change, for example, the name, the size of the RAM, etc.
* Finally, click _Import_.
 
.VirtualBox: Importing the Virtual Machine
image::virtualbox-import.png["VirtualBox: Importing the Virtual Machine", pdfwidth=80%]

[[opsi-getting-started-installation-base-vm-lang]]
=== Booting the VM and selecting the Language 

Boot the new virtual machine. In the first dialog, select the language of the new opsi server. Navigate with [Tab] to the preferred option and press the space bar to highlight it. Then press [Tab] again until you reach _Ok_, and press [Enter].

.Select the language for your new opsi server.
image::1stboot-language-selection.png["Select the the language for your new opsi server.", pdfwidth=80%]

You will now see a message that the installation program configures the network settings of the opsi server. Confirm this with [Enter].

TIP: Depending on the environment and virtualization software, system messages may appear in the window so that the installer's dialogs may become unreadable. Use the key combination [Ctrl]+[L] to reset the display.

[[opsi-getting-started-installation-base-vm-1stboot]]
=== First Start: the Script `1stboot.py`

The `1stboot.py` script, which starts automatically when you boot the appliance for the first time, helps you to configure the network. You can run the script at any time later via `/usr/local/bin/1stboot.py` on the command line and adjust the settings. The log file of `1stboot.py` is located in `/var/lib/1stboot/1stboot.log`.

WARNING: You cannot use `1stboot.py` to rename a configured opsi server!

.The `1stboot.py` script helps you with the network configuration.
image::1st-startup-mask.png["The `1stboot.py` script helps you with the network configuration.", pdfwidth=80%]

The script asks for the following information:

server name::		Name of this opsi server (without domain), e.g. `opsiserver` or `opsidepot`.

domain::		DNS domain (not Windows domain, must contain a dot), e.g. `opsi.local` or `mycompany.local`.

ip address::		Address of this server, e.g. `192.168.1.50`.

netmask::		Netmask of this server, e.g. `255.255.255.0`.

windows domain::	Windows domain name (not DNS domain), e. g. `OPSI`.

gateway::	IP address of the gateway, e.g. `192.168.1.1`.

proxy::	Address and port of the proxy server (if required), e.g. `http://myuser:mypass@192.168.1.5:8080`.

DNS server:: IP address of the name server, e.g. `192.168.1.1`.

mail relay:: IP address of the mail server, e.g. `192.168.1.1`.

tftp server::	Usually this is the IP address of the opsi server (default).

Password of root::	The password for the local root user; enter the password twice to avoid possible typos.

Password of adminuser::	The password for the local opsi administrator; enter this password twice, too.

After that, restart the virtual machine.

[[opsi-getting-started-installation-base-vm-second-start]]
=== Second Start: Login and Update

After the restart, log in to the graphical desktop environment with the user name `adminuser` and the password you set up during the installation. The virtual machine contains three lightweight desktop environments which you can select from the _Session_ menu at the top.

After logging in, the Firefox browser starts and opens a page with further links to the manual, to our forum (community support), to the opsi wiki and to the professional uib support.

.The graphical desktop environment on the opsi server
image::opsiserver_start_gui.png["The graphical desktop environment on the opsi server", pdfwidth=80%]

NOTE: If the message appears that no network connection is available, it may be related to the particular configuration of the virtual appliance. Before checking for errors, it is best to restart the server once. To do this, either click the shutdown button in the start menu or enter the command `reboot` in a terminal window.

[[opsi-getting-started-installation-base-vm-term]]
=== Working on the Command Line

Throughout the rest of the chapter (and also in the other chapters of this manual) we introduce commands which you enter on the command line. You can do this via a terminal application directly on the server, or you can access the opsi server from another computer via SSH. On Linux and macOS use the command `ssh` for this. On Windows you can use the program link:https://www.chiark.greenend.org.uk/~sgtatham/putty/[PuTTY]. As user name enter `root` and authenticate yourself with the root password entered during the installation.

On the opsi server there are different ways to open a terminal window:

* Double click the LXTerminal icon on the desktop background.

* Open the start menu and navigate to a terminal application (_System Tools_ menu).

* Press the key combination [Alt]+[F2]; on most desktops this opens a quick launcher. Type `terminal` to list any installed terminal programs, and then select the application you want.

TIP: We've formatted commands in this manual so that you can copy{nbsp}&{nbsp}paste them directly into a terminal window, if the terminal program supports it.

Example snippets from configuration files are formatted like this:
[source,configfile]
----
depoturl = smb://smbhost/sharename/path
----

Commands are formatted like this:
[source,prompt]
----
cd /tmp
ls -l
----

Replace the identifiers in `<angle brackets>` with their real names. For example, the file share with the opsi packages is called `<opsi-depot-share>`. On a real server it is usually located in `/var/lib/opsi/depot`. So the software package `<opsi-depot-share>/ooffice` is located in `/var/lib/opsi/depot/ooffice`.

[[opsi-getting-started-installation-base-vm-update-server]]
=== Updating the opsi Server

Before you configure the opsi server, make sure that the packages of the underlying Linux system are up-to-date. The virtual machine provided by us is based on the latest Ubuntu LTS version and uses the package management tool APT.

If you are already familiar with APT, you can upgrade the server in a terminal window with the following commands; the last command removes packages which were installed as dependencies and are no longer needed:

[source,prompt]
----
sudo apt update
sudo apt upgrade
sudo apt autoremove
----

Alternatively, we have added an icon called _Update OS_ to the desktop background, which executes exactly these commands in a terminal after a double click. Enter the password of the user `adminuser` at the prompt.

NOTE: If you use a proxy server to access the internet, configure it via the `http_proxy` and `https_proxy` environment variables (see chapter xref:server/requirements[prerequisites]). In addition, you have to enter the proxy in the configuration file `/etc/apt/apt.conf`. You can edit this file as user `root` in a text editor of your choice, e.g. via the command `nano /etc/apt/apt.conf`.

Put the following in the configuration file:

[source,prompt]
----
Acquire::http::proxy "http://<proxy-address>:<port>/";
Acquire::https::proxy "https://<proxy-address>:<port>/";
----

If authentication is required, the two entries look like this:

[source,prompt]
----
Acquire::http::proxy "http://<user>:<password>@<proxy-address>:<port>/";
Acquire::https::proxy "https://<user>:<password>@<proxy-address>:<port>";
----

After the upgrade is complete, restart the server.

[[opsi-getting-started-installation-base-vm-update-opsi-product]]
=== Installing the Standard Products

Next, install the opsi standard products. You can use the desktop icon  _First package installation_ for this and enter the password for the user `adminuser` at the prompt.

Alternatively, run the following command in a terminal:

[source,prompt]
----
sudo opsi-package-updater -v install
----

The command updates current opsi packages, including the templates for OS deployments, from the opsi repositories. When prompted, enter the password of the user `adminuser`.

TIP: For more information, see chapter xref:server/minimal-products#opsi-getting-started-installation-config-get-essential-products[Instaling Products].

[[opsi-getting-started-installation-base-vm-start-configed]]
=== Starting the Management Interface

You can start the management interface `opsi-configed` by double-clicking on the desktop icon _Opsi Configuration Editor_. More information about this graphical application can be found in xref:opsiconfiged.adoc[Management Interface: `opsi-configed`].

The basic server configuration is now complete.

You can now proceed with:

* xref:adding-clients.adoc#opsi-getting-started-firststeps-software-deployment-client-integration[Adding Clients to opsi]

* xref:os-installation.adoc#opsi-getting-started-firststeps-osinstall[Installation of a new Windows PC with opsi (OS Installation)]

// check and publish this with the 4.3 release
////

[[opsi-getting-started-installation-base-docker]]
== opsi as Docker Container

In 2022 we published the first opsi link:https://github.com/opsi-org/opsi-docker[Docker image]. You can use it to set up a config server or a depot server. The opsi Docker image relies on the orchestration tool Docker Compose, which lets you define multiple containers, connect them and run them on a Docker host. You need at least Docker Compose 1.17.0 and Docker Engine 17.09.0 or later.

NOTE: Please note that only WebDAV is used as protocol to communicate with the opsi depot; there is no Samba support in this variant (yet). Also, the file backend is not supported, you will need an opsi MySQL module license (see chapter xref:modules/modules[opsi Extensions]).

Install Docker or Docker Desktop on Linux, Windows, or macOS. You can quickly verify that the installation was successful by entering the following command in a terminal:

[source,prompt]
----
docker run --rm hello-world
----

The output should look like this:

[source,prompt]
----
Hello from Docker!
This message shows that your installation appears to be working correctly.
[...]
----

[[opsi-getting-started-installation-base-docker-quick]]
=== Quick Start

To get the Docker container up and running, these three commands are required:

[source,prompt]
----
git clone https://github.com/opsi-org/opsi-docker.git
cd opsi-docker/opsi-server
./opsi-server.sh start
----

[[opsi-getting-started-installation-base-docker-compose]]
=== Docker Compose

The `docker-compose.yml` configuration file defines networks, volumes and these four services (`services` section):

* `mysql`: Installs the database server MariaDB.
* `redis`: Installs the in-memory database Redis with the RedisTimeSeries module.
* `grafana`: Installs the latest Grafana version.
* `opsi-server`: Installs the packages `opsiconfd`, `opsipxeconfd`, `opsi-tftpd-hpa`, and `opsi-utils` (latest version).

At the beginning of the file some X properties (so called extension fields) are defined, e.g. `x-restart-policy`, `x-common-variables`, etc. These YAML anchors are used to exchange settings between services.

NOTE: For security reasons you should change all passwords in the `docker-compose.yml` file: `MYSQL_ROOT_PASSWORD`, `MYSQL_PASSWORD`, `REDIS_PASSWORD`, `GF_SECURITY_ADMIN_PASSWORD`, and `OPSI_ADMIN_PASSWORD`.

A password for the user `root` is not set. You can specify it through `OPSI_ROOT_PASSWORD`:

[source,prompt]
----
OPSI_ROOT_PASSWORD: <password>
----

TIP: If you do not need TFTP network boot (and thus `opsipxeconfd` and `opsi-tftp-hpa`), you can set the variable `OPSI_TFTPBOOT` to `"false"`.

The next two sections explain how to customize the `docker-compose.yml` configuration file to set up a config server or a depot server.

[[opsi-getting-started-installation-base-docker-compose-config]]
==== Config Server

After you have adjusted the hostname and domain settings in the `opsi-server` section to your network, set the `OPSI_HOST_ROLE` variable to `configserver`:

[source,prompt]
----
OPSI_HOST_ROLE: configserver
----

On Linux and macOS, use `./opsi-server.sh start` to start all services, on Windows use the command `.\opsi-server.ps1 start` (see section <<opsi-getting-started-installation-base-docker-scripts>>). Check the status of the container with the command `./opsi-server.sh status` (Linux, macOS) or `.\opsi-server.ps1 status`. You can view the log files with `./opsi-server.sh logs` or `.\opsi-server.ps1 logs`.

.Check the Status and the Logfiles with the Script `opsi-server.sh`.
image::opsi-server-script.png["Check the Status and the Logfiles with the Script `opsi-server.sh`.", pdfwidth=80%]

[[opsi-getting-started-installation-base-docker-compose-depot]]
==== Depot Server

Check the network and volumes settings. You don't need the two services `mysql` and `grafana` for a depot server, so you can comment them out or delete them. Be sure to then remove `mysql` from the `depends_on` attribute in the `opsi-server` section as well.

Set the `OPSI_HOST_ROLE` variable to `depotserver`:

[source,prompt]
----
OPSI_HOST_ROLE: depotserver
----

For a depot server you also need to set the two variables `OPSI_SERVICE_ADDRESS` (IP address of the opsi config server) and `OPSI_HOST_KEY` (host key of the depot). After that start all services via `./opsi-server.sh start` (Linux, macOS) or `.\opsi-server.ps1 start` (Windows).

[[opsi-getting-started-installation-base-docker-scripts]]
=== Helper Scripts

We have included two helper scripts to make it easier to work with the opsi Docker container. If you use Linux or macOS, use the `opsi-server.sh` script. First, make sure it's executable:

[source,prompt]
----
chmod +x opsi-server.sh
----

As unprivileged user, display an online help by calling the script without any parameters or options:

[source,prompt]
----
./opsi-server.sh 
Usage: ./opsi-server.sh <command>

Commands:
  edit                      Edit docker-compose.yml.
  start                     Start all containers.
  status                    Show running containers.
  stop                      Stop all containers.
  logs [service]            Attach to container logs (all logs or supplied service).
  shell [service]           Exexute a shell in a running container (default service: opsi-server).
  update                    Update and restart all containers.
  open-volumes              Open volumes directory in explorer.
  inspect [service]         Show detailed container informations (default service: opsi-server).
  diff [service]            Show container's filesystem changes (default service: opsi-server).
  prune                     Delete all containers and unassociated volumes.
  export-images             Export images as archive.
  import-images [archive]   Import images from archive.
  build [--no-cache]        Build opsi-server image. Use --no-cache to build without cache.
  publish                   Publish opsi-server image.
----

The second script `opsi-server.ps1` is intended for Windows users and for use on Windows PowerShell. It has essentially the same options and parameters--only the last two commands (`build` and `publish`) are not available.
////

[[opsi-getting-started-installation-base-packages]]
== Package-based Installation

As an alternative to the virtual appliance 
//and the Docker container,
you can install the opsi server on your Linux machine using the package management tool of your distribution. This usually includes the following steps:

* Install missing software.
* Add our repository.
* Update the list of installable packages.
* Install one of the opsi-server packages `opsi-server-full`, `opsi-server`, or `opsi-server-expert` (see section <<opsi-getting-started-installation-base-prerequires>>).

[[opsi-getting-started-installation-base-prerequires]]
=== Prerequisites

Starting with version 4.2 the opsi server needs access to a Redis and a Grafana instance. Assuming these services and the opsi server are running on the same machine, you can install the package `opsi-server-full`. It will automatically install and configure all necessary applications. The following sections refer to this as _Single Server Setup_. If services such as Redis, MySQL/MariaDB, or Grafana are running on another server, install `opsi-server` or `opsi-server-expert` instead.

TIP: Use the official Grafana repositories to install Grafana. If you are running a Debian-based distribution, note that the repositories moved from `<packages.grafana.com/deb/{product}>` to `<apt.grafana.com>` in November 2022. The old addresses still work, but there may be warnings on the system when installing or updating.

=== Debian/Ubuntu/UCS:

[source,bash]
----
sudo mkdir -p /usr/local/share/keyrings
REPO_URL=https://apt.grafana.com
REPO_KEY=/usr/local/share/keyrings/grafana.gpg
sudo apt-get install -y apt-transport-https software-properties-common curl gpg
curl -fsSL ${REPO_URL}/gpg.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL} stable main" > /etc/apt/sources.list.d/grafana.list
----

==== SLES/openSUSE

[source,bash]
----
zypper install wget
cd /etc/zypp/repos.d
cat <<EOF > grafana.repo
[grafana]
name=grafana
baseurl=https://rpm.grafana.com
repo_gpgcheck=1
enabled=1
gpgcheck=1
gpgkey=https://rpm.grafana.com/gpg.key
sslverify=1
sslcacert=/etc/pki/tls/certs/ca-bundle.crt
EOF
----

==== RHEL/Alma Linux/Rocky Linux

[source,bash]
----
yum install wget
cd /etc/yum.repos.d
cat <<EOF > grafana.repo
[grafana]
name=grafana
baseurl=https://rpm.grafana.com/
repo_gpgcheck=1
enabled=1
gpgcheck=1
gpgkey=https://rpm.grafana.com/gpg.key
sslverify=1
sslcacert=/etc/pki/tls/certs/ca-bundle.crt
EOF
----

==== MySQL instead of MariaDB

If you want to use MySQL instead of MariaDB, you need to specify a username and a `mysql_native_password` for `opsi-setup --configure-mysql`. This is how to enable `mysql_native_password` for user `root`:

. In the MySQL configuration, enter `skip-grant-tables` in the `[mysqld]` section.
. Restart the MySQL service.
. Log in as `root` with `mysql -u root -p`.
. Run the command `flush privileges;`.
. Run the command `ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'NewPassword';`.
. Remove the `skip-grant-tables` entry from the configuration and restart the MySQL service.

[[opsi-getting-started-installation-base-deb]]
== Installation on Debian/Ubuntu

We recommend to install the following packages first:

[source,bash]
----
apt install host pigz apt-transport-https software-properties-common curl gpg
----

If it doesn't exist, please create the folder `/usr/local/share/keyrings`:

[source,bash]
----
mkdir -p /usr/local/share/keyrings
----

Additionally, install Samba:

[source,bash]
----
apt install samba samba-common smbclient cifs-utils
----

Next, add the opsi repository to your APT configuration:

*Debian 11 _Bullseye_:*
[source,bash]
[subs="attributes"]
----
REPO_URL=https://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/{release}/Debian_11
REPO_KEY=/usr/local/share/keyrings/opsi.gpg
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL}/ /" > /etc/apt/sources.list.d/opsi.list
curl -fsSL ${REPO_URL}/Release.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
----

*Debian 10 _Buster_:*
[source,bash]
[subs="attributes"]
----
REPO_URL=https://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/{release}/Debian_10
REPO_KEY=/usr/local/share/keyrings/opsi.gpg
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL}/ /" > /etc/apt/sources.list.d/opsi.list
curl -fsSL ${REPO_URL}/Release.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
----

*Ubuntu 22.04 LTS _Jammy Jellyfish_:*
[source,bash]
[subs="attributes"]
----
REPO_URL=https://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/{release}/xUbuntu_22.04
REPO_KEY=/usr/local/share/keyrings/opsi.gpg
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL}/ /" > /etc/apt/sources.list.d/opsi.list
curl -fsSL ${REPO_URL}/Release.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
----

*Ubuntu 20.04 LTS _Focal Fossa_:*
[source,bash]
[subs="attributes"]
----
REPO_URL=https://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/{release}/xUbuntu_20.04
REPO_KEY=/usr/local/share/keyrings/opsi.gpg
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL}/ /" > /etc/apt/sources.list.d/opsi.list
curl -fsSL ${REPO_URL}/Release.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
----

*Ubuntu 18.04 LTS _Bionic Beaver_:*
[source,bash]
[subs="attributes"]
----
REPO_URL=https://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/{release}/xUbuntu_18.04
REPO_KEY=/usr/local/share/keyrings/opsi.gpg
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL}/ /" > /etc/apt/sources.list.d/opsi.list
curl -fsSL ${REPO_URL}/Release.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
----

Make sure the import of the GnuPG was successful:

[source,bash]
----
gpg /usr/local/share/keyrings/opsi.gpg 2>/dev/null
----

The following lines should appear in the output:

[source,bash]
----
pub   rsa2048 2017-09-30 [SC] [expires: 2023-11-09]
      2E98F7B5A5B2C8FE7F609705D1F933E6D8361F81
uid           home:uibmz:opsi OBS Project <home:uibmz:opsi@build.opensuse.org>
----

Install one of the opsi server packages:

*Single Server Setup:*
[source,prompt]
----
apt update
apt install opsi-server-full
----

*Manual Setup:*
[source,prompt]
----
apt update
apt install redis-server redis-timeseries grafana mariadb-server
systemctl daemon-reload
systemctl enable grafana-server
systemctl start grafana-server
apt install opsi-server
apt install opsi-windows-support
----

TIP: If you are prompted for the TFTP base directory during installation, type `/tftpboot`.

[[opsi-getting-started-installation-base-opensuse-sles]]
=== Installation on SLES/openSUSE

Necessary preparations:

* Samba must be installed and configured.

* The `mariadb-server` package must be installed.

* If the machine is to be used as a DHCP server, the `dhcpd` daemon must be configured and running.

To add the opsi repository via `zypper`, use one of the following commands:

*openSUSE Leap 15.1:*
[source,prompt]
[subs="attributes"]
----
zypper addrepo https://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/openSUSE_Leap_15.1/home:uibmz:opsi:4.2:{release}.repo
----

*openSUSE Leap 15.2:*
[source,prompt]
[subs="attributes"]
----
zypper addrepo https://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/openSUSE_Leap_15.2/home:uibmz:opsi:4.2:{release}.repo
----

*openSUSE Leap 15.3:*
[source,prompt]
[subs="attributes"]
----
zypper addrepo https://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/openSUSE_Leap_15.3/home:uibmz:opsi:4.2:{release}.repo
----

*SLES 15SP1:*
[source,prompt]
[subs="attributes"]
----
zypper addrepo http://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/SLE_15_SP1/home:uibmz:opsi:4.2:{release}.repo
----

*SLES 15SP2:*
[source,prompt]
[subs="attributes"]
----
zypper addrepo http://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/SLE_15_SP2/home:uibmz:opsi:4.2:{release}.repo
----

*SLES 15SP3:*
[source,prompt]
[subs="attributes"]
----
zypper addrepo http://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/SLE_15_SP3/home:uibmz:opsi:4.2:{release}.repo
----

After adding the repository, you can install the opsi server:

*Single Server Setup:*
[source,prompt]
----
zypper refresh
  Do you want to (r)eject the Key, (t)emporary or (a)lways trust? [r/t/a/?] (a): a
zypper -v install opsi-server-full
----

*Manual Setup:*
[source,prompt]
----
zypper refresh
zypper install redis-server redis-timeseries grafana
systemctl daemon-reload
systemctl enable grafana-server
systemctl start grafana-server
zypper -v install opsi-server
zypper -v install opsi-windows-support
----

NOTE: Please make sure that your firewall configuration allows connections to the ports 69/UDP (TFTP) as well as 4447/TCP and 4441/TCP (opsi).

If you have used YaST or AutoYaST to configure your network, the file `/etc/hosts` may contain the following setting:

[source,configfile]
----
127.0.0.2 <fqdn> <hostname>
----

If you want to leave the configuration of the DHCP server to opsi, this entry has to be changed to the public IP address of the server.

[[opsi-getting-started-installation-base-centos-rhel]]
=== Installation on RHEL/Alma Linux/Rocky Linux

Installing the opsi server on Red Hat Enterprise Linux (RHEL), Alma Linux, and Rocky Linux is basically the same. There are only differences in the repository used.

NOTE: If you run Red Hat Enterprise Linux, you first need to register with the Red Hat Network to have access to all required packages: +
[source,prompt]
----
subscription-manager register
subscription-manager attach --auto
----

Necessary preparations:

* Install Samba and the database server: +
[source,prompt]
----
yum install mariadb-server samba samba-client
----

* Configure Samba and the database server: +
[source,prompt]
----
systemctl start smb.service
systemctl start nmb.service
systemctl start mariadb.service
systemctl enable smb.service
systemctl enable nmb.service
systemctl enable mariadb.service
mysql_secure_installation
----

* If the machine is to be used as a DHCP server, the `dhcpd` daemon must be configured and running.

This is how to add the opsi repository:

*RHEL 8:*
[source,prompt]
[subs="attributes"]
----
cd /etc/yum.repos.d/
wget https://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/RHEL_8/home:uibmz:opsi:4.2:{release}.repo
yum makecache
----

*Alma Linux 8:*
[source,prompt]
[subs="attributes"]
----
cd /etc/yum.repos.d/
wget https://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/AlmaLinux_8/home:uibmz:opsi:4.2:{release}.repo
yum makecache
----

*Rocky Linux 8:*
[source,prompt]
[subs="attributes"]
----
cd /etc/yum.repos.d/
wget https://download.opensuse.org/repositories/home:uibmz:opsi:4.2:{release}/RockyLinux_8/home:uibmz:opsi:4.2:{release}.repo
yum makecache
----

After adding the repositories, you can now start the installation:

*Single Server Setup:*
[source,prompt]
----
yum install opsi-server-full
----

*Manual Setup:*
[source,prompt]
----
yum makecache
yum install redis-server redis-timeseries grafana.x86_64
systemctl daemon-reload
systemctl enable grafana-server
systemctl start grafana-server
yum install opsi-server
yum install opsi-windows-support
----

It's possible that you see a message like this when importing the GnuPG key:

[source,prompt]
----
   Importing GPG key 0xD8361F81 "home:uibmz OBS Project <home:uibmz@build.opensuse.org>" from http://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/stable/CentOS_8/repodata/repomd.xml.key
   Is this ok [y/N]: y
----

Enter `y` and press [Enter] to confirm that you want to add the key.

NOTE: Please make sure that your firewall and the SELinux configuration allow connections to the ports 69/UDP (TFTP) as well as 4447/TCP and 4441/TCP (opsi).

[[opsi-getting-started-installation-base-ucs]]
== Installation on Univention Corporate Server (UCS)

On Unter Univention Corporate Server (UCS) there are two different ways of installing the opsi server:

* <<opsi-getting-started-installation-base-ucs-appcenter>> (only UCS 5.0 or newer)
* <<opsi-getting-started-installation-base-ucs-manually>> using the uib repositorys (UCS 4.4 and 5.0)

Both installation methods are equally supported, we recommend not to mix them on one server, though. Better decide in advance which installation method fits your environment. If you obtain opsi via the Univention App Center, changing to a newer UCS version (i.e. from UCS 4.4 to UCS 5) will only work when all installed apps are available for the new UCS version. If you decide to use the uib repositories, you will receive updates quicker. 

NOTE: With the release of opsi 4.2 we have adapted the UCS support to the other distributions. The function of `opsi4ucs` is taken over by the package for the opsi server and its variants. The package `opsi4ucs` is still included in opsi 4.2 as a transition package to simplify the migration from opsi 4.1. During the upgrade from opsi 4.1 to 4.2 the package management tool automatically replaces `opsi4ucs` with `opsi-server`.

[[opsi-getting-started-installation-base-ucs-appcenter]]
==== Installation via the Univention App Center

The link:https://www.univention.com/products/univention-app-center/app-catalog/opsi/[Univention App Center Catalog] offers opsi for UCS 5.0. During the installation the package manager automatically installs other packages: `opsi-tftpd-hpa`, `opsi-windows-support`, and `univention-mariadb`.

NOTE: The first opsi server of a UCS environment uses an existing MariaDB server as backend. All further opsi servers are registered as depots. So if there is already an opsi server in the UCS environment during installation, the `opsi-package-updater` tool is configured to get the packages from this server.

[[opsi-getting-started-installation-base-ucs-manually]]
==== Manual Installation 

Before you install the opsi server on Univention Corporate Server, make a few preparations:

* Samba must be installed and configured. If the UCS server is a member of an AD domain, install `univention-samba`, which sets up and configures Samba as a member server without domain controller functionality. The `univention-samba4` package, on the other hand, sets up Samba as an AD domain controller.

* A MariaDB server must be installed and configured. To do this, install `univention-mariadb`; the `univention-mysql` package is a meta package since UCS 4.3 which installs the MariaDB server.

* If the UCS machine should also serve as DHCP server, configure and start the DHCP daemon before the opsi installation.

Basically, the installation is possible on servers with the UCS roles Primary Directory Node, Backup Directory Node, Replica Directory Node, and Managed Node.

CAUTION: If you install the opsi server on a machine with a UCS system role other than Primary Directory Node, the UCS server must first join the domain.

The `/etc/opsi/opsi.conf` configuration file defines the group for accessing the Samba shares; the name is `opsifileadmins`. All users who are to have access rights to the opsi shares (opsi packagers) must be members of the `opsifileadmins` group accordingly.

This is how to add the opsi repository:

*Univention UCS 4.4:*
[source,bash]
[subs="attributes"]
----
REPO_URL=https://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/{release}/Univention_4.4
REPO_KEY=/usr/local/share/keyrings/opsi.gpg
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL}/ /" > /etc/apt/sources.list.d/opsi.list
curl -fsSL ${REPO_URL}/Release.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
----

*Univention UCS 5.0:*
[source,bash]
[subs="attributes"]
----
REPO_URL=https://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.2:/{release}/Univention_5.0
REPO_KEY=/usr/local/share/keyrings/opsi.gpg
echo "deb [signed-by=${REPO_KEY}] ${REPO_URL}/ /" > /etc/apt/sources.list.d/opsi.list
curl -fsSL ${REPO_URL}/Release.key | gpg --dearmor | sudo tee ${REPO_KEY} > /dev/null
----

Next, you can start the installation:

*Single Server Setup:*
[source,bash]
----
univention-install opsi-server-full
----

*Manual Setup:*
[source,bash]
----
univention-install redis-server redis-timeseries grafana
systemctl daemon-reload
systemctl enable grafana-server
systemctl start grafana-server
univention-install opsi-server
----

If the opsi server is to run on a UCS system role other than Primary Directory Node, additionally execute the `univention-run-join-scripts` command.

Users must be a member of the `opsi-admin-group` to use the management interface `opsi-configed`. During the installation, the user `administrator` is automatically added to this group. Other accounts can be added via the UMC module _User Management_ , tab _Groups_.

Finally, to make sure that all opsi settings have been applied correctly, run the following commands:

[source,bash]
----
opsi-setup --init-current-config
opsi-set-rights
systemctl restart opsiconfd.service
systemctl restart opsipxeconfd.service
----

== Help and Support

If you run into problems, please visit our link:https://forum.opsi.org[forum] to talk to other opsi users. 

TIP: If you have a support contract, you can also contact our link:https://www.uib.de/en/support-training/support[support team].
