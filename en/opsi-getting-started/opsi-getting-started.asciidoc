////
; Copyright (c) uib gmbh (www.uib.de)
; This documentation is owned by uib
; and published under the German creative commons by-sa license
; see:
; http://creativecommons.org/licenses/by-sa/3.0/de/
; http://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; http://creativecommons.org/licenses/by-sa/3.0/
; http://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: http://www.opsi.org/credits/
////

////
;***************************************************************************
; Subversion:
; $Revision$
; $Author$
; $Date$
;***************************************************************************
////

:Author:    uib gmbh
:Email:     info@uib.de
:Revision:  4.0.6
:toclevels: 6
:doctype:		book

// Include common opsi terms
include::../common/opsi_terms.asciidoc[]


= opsi Getting Started opsi-Version 4.0.7

// Include common opsi copyright
include::../common/opsi_manual_copyright.asciidoc[]

[[opsi-getting-started-introduction]]
== Introduction
These instructions explain in detail the installation and starting of an {opsi-server}. It starts from the provided installation package and leads to the test installation of a client.

The network configuration described here is exemplary and relates to a network without a concurrent DHCP server (i.e. the first trials are done in an isolated test network with an {opsi-server} and a few clients).

We strongly recommend that the first trials of opsi be done in a test network, separated from other DHCP servers. A temporary connection to the main network can be used for downloads of actual product packages.

uib provides consulting services for the integration of opsi into your existing production environment.

[[opsi-getting-started-introduction-first-steps]]
=== Steps for Installation and Getting Starting
The four steps to install and start an {opsi-server} are:

. base installation of the server
. configuration of the server: +
configuration of the network, setting passwords (opsi administrator, pcpatch, samba), server updates
. download and installation of the required opsi client products to the opsi server
. completion of the system software base packages for Windows using the original Windows DVD or other sources.

At that point, a client can be automatically integrated into the opsi server.

Depending on your requirements, opsi offers different types of base installations.
The procedure to perform different types of base installations are described in Chapter <<opsi-getting-started-installation>> of this manual.
The types of installations included offer the possibility to either use an existing VMware machine or to perform a direct installation of opsi to
the host machine.

[[opsi-getting-started-introduction-hardware-preconditions]]
=== Hardware Requirements

For a {opsi-server} the following hardware is recommended:

* Intel-x86-compatible PC

* 2GB RAM or higher

* a hard disk with 60 GB capacity or more

The requirements of the server are moderate in testing environments. In the case of production environments it is recommended to increase the capabilities of the host system.

We recommend in the case of testing with a Virtual machine, that the host computer should have at least a dual core processor and at least 4GB of RAM.
For testing purposes, a test client can be run as another Virtual machine on the same host computer.


[[opsi-getting-started-introduction-software-and-configuration-preconditions]]
=== Configuration Requirement

Your server and your network have to comply the following requirements to install and work with opsi:

* *valid DNS domain name* +
Your DNS domain name should contain at least a domain name and a top level domain. So the full qualified domain name (FQDN) should contain one or more dots. The top level domain must contain at least two chars. +
Valid domain names are e.g.: 'domain.local' , 'uib.de', 'subdomain.domain.de'.
An invalid example: 'mydomain.d' because this is only one character at the top-level domain
An invalid example: 'mydomain' because this is only a top-level domain +
see also: +
http://en.wikipedia.org/wiki/Domain_name

* *valid DNS hostname* +
The hostnames (also the client hostnames) have to follow standard naming rules. They may contain the ASCII letters a-z, digits 0-9 and the hyphen '-'. No underscores are allowed. +
see also: +
http://en.wikipedia.org/wiki/Hostname

* *correct name resolution for the server* +
Execute the following command and check the result:
+
[source,prompt]
----
getent hosts $(hostname -f)
----
+
The result should look like the following example: +
'192.168.1.1 server.domain.tld server' +
The result has the scheme: +
'<IP-Number> <full qualified hostname> <hostname>' +
If the result looks different from the above example (contains eg. '127.0.0.1' or 'localhost'), or the full qualified hostname does not contain one or more dots, then you must correct your name resolution (DNS or `/etc/hosts` file).

[[opsi-getting-started-supportmatrix]]
== opsi Support Matrix (opsi runs on which server)

Here an overview on which distributions and releases the opsi-server will run:

include::../common/opsi_manual_supportmatrix.asciidoc[]

[[opsi-getting-started-installation]]
== Installation

[[opsi-getting-started-installation-base]]
=== {opsi-server} Base Installation

This chapter describes different types of {opsi-server} installations. You can choose your installation type and skip the other instructions.

If all required steps are successful, then the server system is properly configured and ready to start. Before you run the {opsi-server}, you should update your system according to the chapter 'Update of the {opsi-server}'.

For evaluation purposes, we recommend using the Virtual-Machine provided by uib.

Please follow the instructions by entering the commands in the
[source,prompt]
----
marked fields
----
(via cut-and-paste from this document)

If you encounter any problems, please ask for help at https://forum.opsi.org

[[opsi-getting-started-installation-base-vm]]
==== Starting up a virtual Machine

An '{opsi-server}' can be installed as a virtual machine, because the load on the system is low. A ready-to-use and pre-configured virtual machine is provided by uib. You can download the VMware or Virtualbox files from the uib website. The free of charge VMware player or Virtualbox is sufficient to run this machine.

You may also use VMware ESX.


[[opsi-getting-started-installation-base-vm-start]]
===== First Start

*VMware*

If you have a server running VMware or a VMware player, it only takes a few mouse clicks to install a base '{opsi-server}':

* Download the opsi-ServerVM from http://uib.de/de/opsi/opsi-testen-download/
* Unzip the file and a directory 'opsivm' will be generated.
* Start the VMware player. Open "Open a Virtual Machine" and search for the file `opsivm.ovf` in the 'opsivm' directory. You can import the server with an new name. The virtual machine will still boot.

*ESXi-Server*

* Download the opsi-ServerVM from http://uib.de/de/opsi/opsi-testen-download/
* Unzip the file and a directory 'opsivm' will be generated.
* Start the vSphere Client. +
Install a new client with 'File' / 'Deploy OVF Template....' and answer the following questions.

*Virtualbox*

* Download the opsi-ServerVM from http://uib.de/de/opsi/opsi-testen-download/
* Unzip the file and a directory 'opsivm' will be generated.
* Start the Virtualbox. +
At the menu 'File' / 'Import Appliance' select your `opsivm.ovf` file and import it.

*General*

The VMware player is free of charge and available for all common operating systems at vmware.com. Usually it can be installed without any problems, as long as the resources of the host computer (especially memory) meet the needs of running software systems in parallel.


[[opsi-getting-started-installation-base-vm-lang]]
===== Language selection
The first step is to choose the preferred language:

.Language selection
image::1stboot-language-selection.png["Screenshot: Language selection",width=400]

[[opsi-getting-started-installation-base-vm-1stboot]]
===== "1stboot"
The {opsi-server} needs to be connected to the Internet to work properly. The script `1stboot.py` will automatically start at the first boot in order to configure the {opsi-server} network settings.

If something goes wrong while running '1stboot.py', then you may run `1stboot.py` again from the command line.

WARNING: You cannot use `1stboot.py` to rename your '{opsi-server}' afterwards!

The log file of `1stboot.py` is located at `/var/lib/1stboot/1stboot.log`.

.1stboot.py Startup mask
image::1st-startup-mask.png["Screenshot: 1stboot.py Startup mask",width=400]

Fill in the configuration information for your network and answer the questions.

.1stboot Input mask
image::1stboot-input-mask.png["Screenshot: 1stboot Input mask",width=400]

In the following, you will be asked for:

server name::		Name of this server (without domain) e.g. +opsidemo+

domain::		DNS-Domain (not Windows-Domain) the name has to include a dot e.g. +opsi.local+

ip address::		Address of this server e.g. +192.168.1.50+

netmask::		Net mask of this server e.g. +255.255.255.0+

windows domain::	Name of the Windows Domain (not the DNS domain)

country::		For the creation of the SSL-certificate: Identification of the nation (2 capital letter) e.g. +DE+

state::			For the creation of the SSL-certificate: Identification of the federal state e.g. +RPL+

city::	For the creation of the SSL-certificate: Identification of the city e.g. +Mainz+

organization::		For the creation of the SSL-certificate: Identification of the company e.g. +uib gmbh+

organizational unit:: For the creation of the SSL-certificate: Identification of 				the bureau (optional)

email address::	For the creation of the SSL-certificate: mail address (optional)

gateway::	IP-address of the Internet gateway e.g. +192.168.1.1+

proxy::	If required for the Internet access the proxy information: e.g. 				http://myuser:mypass@192.168.1.5:8080

DNS server:: ip address of the name server e.g. +192.168.1.1+

mail relay:: ip address of the mail server e.g. +192.168.1.1+

tftp server::	ip of the tftp server (usually the server)

Password of root::	Password of root

Password of adminuser::	Password of local opsi-admin.

After the program '1stboot.py' finishes, the server VMware machine will be rebooted.

A technical note about the program 1stboot.py: +
The program works with templates to modify the configuration files. The templates are located in: `/var/lib/1stboot/templates/`. +
They can be edited for subsequent use.

[[opsi-getting-started-installation-base-vm-second-start]]
===== Second Start

After the reboot, login as 'adminuser' with your password.

The graphical user interface of the {opsi-server} should have already started (implemented as a sustainable window manager). A "Firefox" browser window might appear at startup, and display further instructions and information. This information can serve as a reference to the getting started document (the document you are currently reading).

If you get a message that there is no network connection, try rebooting the server. This might solve the problem.

.View of fresh started opsi-server
image::opsiserver_start_gui.png["Screenshot: View of newly started opsi-server",400]

If the network was correctly configured in the previous steps, then you should be able to remotely access the {opsi-server}, for example:

* use 'ssh' at the command line to access to the server ('ssh' should already be installed on linux systems, for Windows use putty: http://www.chiark.greenend.org.uk/~sgtatham/putty/) +

Use 'root' as the user name, and authenticate with the root password.

[[opsi-getting-started-installation-base-vm-term]]
===== Terminal Window

In the following sections, some commands have to be entered into a command line interface. It may be the easiest way to work through these instructions.

The commands are input into a window called a "terminal window". Here are examples that explain how to access a terminal window:

* Remote access per ssh on the '{opsi-server}' (see Section 3.1.1.4 of the last chapter)

  * Open a terminal window in the {opsi-server} graphical interface with a click on the terminal icon in the icon bar.

* Open a terminal window in the {opsi-server} graphical interface with a right mouse click inside the interface, and choose "Terminal". +
Note: the graphical interface has many working applications that are reachable using the variety of buttons in the upper-left-hand corner of the display.

We recommend cutting and pasting commands from this handbook directly into the {opsi-server} terminal window (most applications support cut and paste).

Example snippets from configuration files are formatted like this:
[source,configfile]
----
depoturl = smb://smbhost/sharename/path
----

Example snippets for commands that you have to execute are formatted like this:
[source,prompt]
----
cd /tmp
ls -l
----

Angle brackets '< >' mark abstract names. When entering commands, please replace the '<abstract name>' with a real name. +
For example: The file share, where opsi places the software packages, may abstractly be noted as '<opsi-depot-share>'. If the real file share is `/var/lib/opsi/depot`, then you have to replace the abstract name by this exact string. The location of the package '<opsi-depot-share>/ooffice' becomes `/var/lib/opsi/depot/ooffice`. .

[[opsi-getting-started-installation-base-vm-network]]
===== Check the Network Connection

If the network configuration is correct, and the computer is connected to the Internet, then you can access any Internet address using the browser in the start window.

If the Internet connection is not working, then you have to open a terminal window (maybe remote access isn't possible, except using the server terminal window) and then perform the necessary network connection checks and fixes.

You can re-enter the network configuration by entering this command in the terminal window:
[source,prompt]
----
1stboot.py
----

A reboot is forced with the command:
[source,prompt]
----
reboot
----

If the network connection works, then you can install opsi packages or update them, and configure the environment for the first installation test. If you want to use the VMware machine (and not install the {opsi-server} directly to your host system), then skip to <<opsi-getting-started-installation-config>>.


[[opsi-getting-started-installation-base-vm-update-server]]
===== Update the opsi-Server

To update your opsi-Server you need to double click the Icon "Update Manager" on the desktop.

[[opsi-getting-started-installation-base-vm-update-opsi-product]]
===== Install the standard opsi-products

By performing a double click the Icon 'opsi-product-update FirstRun' the minimal opsi Products will be installed. To do this please introduce the current password for the adminuser.
Through this installation the actual stock of opsi-products, incl. templates for Windows- and Linux-OS, will be downloaded from http://download.uib.de/opsi4.0/products/ and installed on the server. For more information you can see here <<opsi-getting-started-installation-config-get-essential-products>>.

[[opsi-getting-started-installation-base-vm-start-configed]]
===== Starting opsi-Server Interface
For a description of the Server Interface check <<opsi-getting-started-installation-config-configed>>.

You have a running opsi server now, i.e. the opsi application itself is fully configured. You should want to proceed with

* <<opsi-getting-started-firststeps-software-deployment-client-integration>>

* <<opsi-getting-started-firststeps-osinstall>>


[[opsi-getting-started-installation-base-deb]]
==== Installation of a Debian / Ubuntu System

In this chapter, we assume you are familiar with the debian-package system (you will find information about the debian-package in the appropriate Debian books, in the manual pages, or under http://www.debian.org/doc/).

Please note that an {opsi-server} needs storage in `/var/lib/opsi`. A minimum of 16 GB of free space is recommended.

Please read the chapter <<opsi-getting-started-introduction-software-and-configuration-preconditions>> (if you haven't done so yet).

For the following installation commands, aptitude should be installed:

[source,prompt]
----
apt-get install aptitude
----

We recommend the following software installations:

[source,prompt]
----
aptitude install wget lsof host p7zip-full cabextract openbsd-inetd pigz
----

opsi needs samba, which can be installed as:

[source,prompt]
----
aptitude install samba samba-common smbclient cifs-utils
----

If you plan to use MySQL as a backend (i.e. for Inventory and license management), then you should install a mysql-server:
[source,prompt]
----
aptitude install mysql-server
----

Check the {opsi-server} entry in `/etc/hosts`, or the output of
[source,prompt]
----
getent hosts $(hostname -f)
----

The result should look like the following example: +
'192.168.1.1 server.domain.tld server' +
The result has the scheme: +
'<IP-Number> <full qualified hostname> <hostname>' +
If the result looks different than the above example (contains eg. '127.0.0.1' or 'localhost'), or the full qualified hostname does not contain one or more dots, then you must correct your name resolution (DNS or `/etc/hosts` file).

To start with the installation of opsi create the file +
'/etc/apt/sources.list.d/opsi.list' with the following content in it depending +
on your operating system:

Ubuntu Precise:
[source,configfile]
----
deb http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/xUbuntu_12.04 ./
----

Ubuntu Trusty:
[source,configfile]
----
deb http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/xUbuntu_14.04 ./
----

Ubuntu Xenial:
[source,configfile]
----
deb http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/xUbuntu_16.04 ./
----

Debian Wheezy:
[source,configfile]
----
deb http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/Debian_7.0 ./
----

Debian Jessie:
[source,configfile]
----
deb http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/Debian_8.0 ./
----

Now execute this command in order to import the signature key of the repository:

Ubuntu Precise:

[source,prompt]
----
wget -O - http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/xUbuntu_12.04/Release.key | apt-key add -
----

Ubuntu Trusty:

[source,prompt]
----
wget -O - http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/xUbuntu_14.04/Release.key | apt-key add -
----

Ubuntu Xenial:

[source,prompt]
----
wget -O - http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/xUbuntu_16.04/Release.key | apt-key add -
----

Debian Wheezy:

[source,prompt]
----
wget -O - http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/Debian_7.0/Release.key | apt-key add -
----

Debian Jessie:

[source,prompt]
----
wget -O - http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/Debian_8.0/Release.key | apt-key add -
----

All: +
Check for key import success:
[source,prompt]
----
apt-key list
----
should contain the output: +
`pub   1024D/4DC87421 2010-07-23 [verfÃ¤llt: 2017-02-17] +
uid   home:uibmz OBS Project <home:uibmz@build.opensuse.org>`

Execute the following commands in order to install opsi at your server:

[source,prompt]
----
aptitude update
aptitude safe-upgrade
aptitude remove tftpd
update-inetd --remove tftpd
aptitude install opsi-atftpd
aptitude install opsi-depotserver
aptitude install opsi-configed
aptitude install wimtools
----

While executing 'aptitude update' the following warning may be displayed, should that happend, please ignore it:
[source,configfile]
----
W: http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/xUbuntu_16.04/./Release.gpg:
Signature by key 2371C96FC045365D00729A19520B97144DC87421 uses weak digest algorithm (SHA1)
----

During the tftpd-installation, you may be asked for the tftp directory. Answer with `/tftpboot`. Answer the question after the multicast support question with a 'no'.

During the installation of the opsiconfd, you will be asked for information about a SSL certificate preparation.

During the {opsi-server} installation, you have to allow the patching of the file `smb.conf`. Answer the question with 'yes'. Also, you will be asked for a password for the user 'pcpatch'. Set a new password, and please remember this password when continuing with the following sections.

During the {opsi-server} installation, please ignore any warnings about a missing `/etc/opsi/modules` file.

If you would like to run the opsi management interface '{opsi-configed}' directly on the server, then you need to install the Java Runtime Environment. In order to install these packages, enter these commands:

.Debian:
In the file `/etc/apt/sources.list`, add the branches +non-free+ and +contrib+ to your repositories.

The result may look like this:
[source,configfile]
----
deb http://ftp.de.debian.org/debian/ lenny main non-free contrib
deb-src http://ftp.de.debian.org/debian/ lenny main non-free contrib

deb http://security.debian.org/ lenny/updates main non-free contrib
deb-src http://security.debian.org/ lenny/updates main non-free contrib
----
NOTE: If you are running 'squeeze', then the repositories have to be 'squeeze' instead of 'lenny'.

To install the Java JRE execute:
[source,prompt]
----
aptitude update
aptitude install openjdk-7-jre icedtea-7-plugin
----

.Ubuntu:

.Ubuntu Precise, Trusty:
Since Oneric, we recommend using version 7 of the OpenJDK.
To install version 7 of the Java JRE execute:
[source,prompt]
----
aptitude update
aptitude install openjdk-7-jre icedtea-plugin
----

.Ubuntu Xenial:
To install version 8 of the Java JRE execute:
[source,prompt]
----
aptitude update
aptitude install openjdk-8-jre icedtea-plugin
----

.Debian 8 (Jessie) specialities: +

The bootimage has issues to mount the `opsi_depot`-Share over mount.cifs.
To avoid these problems you can either configure ID mapping in Samba or disable `winbind`.
If you do not rely on `winbind` we recommend to disable the daemon.

Disable starting of winbindd:
[source,prompt]
----
systemctl disable winbind
----
or
[source,prompt]
----
insserv -r winbind
----

For a sane ID mapping configuration specify a configuration with limited
mapping range in `smb.conf` and then restart Samba.

To configure ID mapping you can insert the following into the `[global]` section of `smb.conf`.
[source,prompt]
----
idmap config * : range = 1000-1999999
----

Assuming all of the above steps completed successfully, we can assume that the network is properly configured. Next continue on with <<opsi-getting-started-installation-config-backend>>

[[opsi-getting-started-installation-base-ucs]]
==== Installation on a Univention Corporate Server (UCS)


[[opsi-getting-started-installation-base-ucs-appcenter]]
===== Installation over the Univention App-Center

In the Univention App-Center an automatic installation of the opsi-Server is available.
The installation-app for opsi can be found in the UCS-Management-Webinterface in the category "System". Over the App-Center opsi can be installed on UCS4-Serverroles Master and Backup. If you want to update a existing opsi4ucs-Installation please check the next Chapter for further information. +
The following will describe what will be happen during a installation:

* The pre-requirements for a MySQL-Installation will be fulfilled.

* The Ignore-List of the Samba4-Connector will be modified: the user pcpatch will be removed if found as an entry in the ignore list.

* The MySQL-Backend will be configured to use for inventory data in opsi (dispatch.conf will be modified).

* The opsi-Samba-Shares will be checked, if they are configured in the right way to work with opsi.

* Required packages for the opsi-Installation will be installed: opsi4ucs, opsi-atftpd, p7zip-full cabextract, mysql-server, digitec-opsi-listener.

* 'opsi-product-updater' will be called to download and install the minimal opsi-Packages for the first work with the new installation.

With the automatic installation and configuration of the digitec-opsi-listener over the Univention-Appcenter, the system will automated register new Clients in the UCS-Bakcend and synchronize these clients automatically to the opsi-Backend.
This will not automatically replicate already existing clients. If a complete replication of existing clients are required, please have a look in the Chapter:
<<opsi-getting-started-installation-base-ucs-listener>>

After the described steps the opsi-Installation on a UCS-Server over the Univention App-Center is finished. Please continue with following chapter:
<<opsi-getting-started-installation-config-modules>>

[[opsi-getting-started-installation-upgrade-appcenter]]
===== Upgrade a existing opsi-Installation from UCS 3 to UCS 4 (over the App-Center)

One major change of opsi 4.0.5 is the opsifileadmins group. In the future the group openfileadmins will replace the group pcpatch in UCS. This group has already been introduced with the support of UCS 3.0,
but only on installations that had Samba 4 and the Univention Directory Services (Samba4-AD). In all other Variants and roles the group continues to be, as it was before pcpatch.

Since this situation represents a problem not only on the installation, but could also lead to potential problems with migrations (especially of Samba3 on Samba4) with the release 4.0.5 the pcpatch group will be created with the id opsifileadmins group, no matter what combination of UCS 3.2 / 4.0 or Samba3 / Samba4
is found during installation.

WARNING: To implement the integration package in a clean way, the group pcpatch will be renamed automatically in opsifileadmins with the integration package.
This is done via the join script. If your config server is run on a Master or backup, the join script will be executed automatic. +
 +
The main reason for this drastic measure is that the manual rename of this group is not trivial, because it comes to be a primary group. Therefore it is recommended before installing
this update to make sure that your group is still named pcpatch. If so, the update should be started with the config server and soon afterwards on the Depot servers as well. Otherwise the operation on
Multi Depots environments could lead to issues. This should not be the case, if your group named opsifileadmins already. Nevertheless, it is recommended after importing the update to check every opsi server to verify complete functionality.

[[opsi-getting-started-installation-base-ucs-3]]
===== Manual opsi-installation on a UCS 3 and UCS 4 System (without App-Center)

Please read <<opsi-getting-started-introduction-software-and-configuration-preconditions>> (if you haven't done so yet).

Necessary preparations:

* The command
+
[source,prompt]
----
hostname -f
----
+
must return a full qualified domain name containing two dots, e.g. 'opsiserver.domain.local'

* The command
+
[source,prompt]
----
getent hosts $(hostname -f)
----
+
have to afford the IP-adress of the network interface which the client has to connect with. If the command shows the address '127.0.0.1' or '127.0.0.2', you have to correct your name resolution in `/etc/hosts` file.

* Samba has to be configured. For the use of a server with the member role `univention-samba` has to be used instead of `univention-samba4`.

* Mysql-server has to be installed.

* If the machine should also work as DHCP-server, then the daemon dhcpd has to be configured and should be running.

The installation of opsi is possible on the roles master, backup, slave and member.
For the installation on a member you need to read <<opsi-getting-started-installation-base-ucs-member>>!

The following documentation describes an installation on a master with Samba4.

Please note:

* If an Installation will be done on a Slave, this must joint to the Master and Samba4 have to be installed first. The following configuration will be done on the Master. Since customize the repositories this will be done on the Slave.

The classic installation with the user: 'pcpatch' in the primary group: 'pcpatch' does not work with UCS 3. Samba4 has placed fundamental restrictions on the Active-Directory, so groups with the same name like the user (usually in Unix/Linux) are no longer allowed. For this reason a new configuration file has
been introduced: `/etc/opsi/opsi.conf`, which controls how the groups establish access to Samba. More specifically for UCS 3 the group name 'pcpatch' will be called 'opsifileadmins'. This means that users that need clearance for opsi (opsi package builder for example) under UCS 3 can't be members of the group 'pcpatch'. And therefore now belong to the group 'opsifileadmins'.
This peculiarity initially applies only to UCS 3 and is different for several distributions and chapters of the opsi-documentation. Furthermore, since UCS 3 the user 'pcpatch' is created as an adequate domain user and not longer as a system user. (Also, the UID of 'pcpatch' and the GID of the
'opsifileadmins' group will no longer be fix, but will be self-assigned in UDM which will also eliminate the replication problems with the user and group). For more information about this new configuration file please refer the opsi-manual.

TIP: If you use UCS 4.0 or higher and you have no existing opsi installation, you can skip the following steps and continue with the edition of the repositories.

Before opsi can be installed some specific preconditions must be met. At first it must be ensured that pcpatch account will be cleanly replicated to Samba4. Please check that the Univention s4-connector has the pcpatch account in the Ignore-List - in addition execute on UCS-Master following commands:

[source,prompt]
----
ucr get connector/s4/mapping/user/ignorelist
----

If you see pcpatch in the output, which looks like this:

[source,configfile]
----
root,pcpatch,ucs-s4sync
----

The following command will remove pcpatch from the Ignore-List:

[source,prompt]
----
ucr set connector/s4/mapping/user/ignorelist=root,ucs-s4sync
----

After these commands have been executed, please restart the connector:

[source,prompt]
----
invoke-rc.d univention-s4-connector restart
----

It may take few minutes for the changes be effective.

Another problem is that a security feature of UCS which does not allow the anonymous reading of the Univention-LDAP. This features is turned off per default at the UCS 2.4-x installation. Therefore, the opsi config server has no possibility to know the group membership of each user. Since no users (neither system nor domain users) can explicitly give reading rights, there remain two alternatives to provide reading rights from the configserver:

Either completely turn off the features:
[source,prompt]
----
ucr set ldap/acl/read/anonymous=yes
----

(This will done automatically with an upgrade from UCS 2.4-x to UCS 3.)

The second option is to disconnect the configserver partial:

[source,prompt]
----
ucr set ldap/acl/read/ips="127.0.0.1,192.168.1.1"
----

In this case the address 192.168.1.1 must be replaced with the real IP address of the server.

When any changes have been made to the server, then slapd at the server has to be restarted (Note: Starting slapd restarts LDAP on a productive system so the next commands only execute planned):

[source,prompt]
----
invoke-rc.d slapd restart
----

After these settings have been made opsi4ucs can be installed. The unmaintained repositories of UCS are important and can be set with the following command:

[source,prompt]
----
ucr set repository/online/unmaintained="yes"
----

*Next, create the file '/etc/apt/sources.list.d/opsi.list' and add the opsi4ucs repository:*

.UCS 3.2: +
[source,prompt]
----
echo "deb http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/Univention_3.2 ./" >> /etc/apt/sources.list.d/opsi.list
----

.UCS 4.0: +
[source,prompt]
----
echo "deb http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/Univention_4.0 ./" >> /etc/apt/sources.list.d/opsi.list
----

.UCS 4.1: +
[source,prompt]
----
echo "deb http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/Univention_4.1 ./" >> /etc/apt/sources.list.d/opsi.list
----

Now import the key to the repository system with the following command:

.UCS 3.2

[source,prompt]
----
wget -O - http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/Univention_3.2/Release.key | apt-key add -
----

.UCS 4.0

[source,prompt]
----
wget -O - http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/Univention_4.0/Release.key | apt-key add -
----

.UCS 4.1

[source,prompt]
----
wget -O - http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/Univention_4.1/Release.key | apt-key add -
----

For the installation the following commands must be entered:

[source,prompt]
----
univention-install opsi-atftpd
univention-install opsi4ucs
univention-install p7zip-full cabextract mysql-server wimtools
----

Please ignore any warnings that say `/etc/opsi/modules` not found during the {opsi-Server} installation.


If the role of the target systems different than Master or Backup then the following commands run the opsi4ucs Join-Script:

[source,prompt]
----
univention-run-join-scripts
----

A link to the management interface can be found at the URL link `https://<servername>:4447`.

To use the opsi configurations editor the user has to be a member of the group {opsiadmin}. The group membership can be edited by using Univention-Admin. The user administrator will automatically be added to this group during the opsi installation.

Finally the 'opsi_depot' release point must be released in UDM. To realize this settings set the link to 'yes' under Advanced Settings -> Advanced Samba Settings: 'follow symlinks'. The same should be done for the 'opsi_depot_rw', so the driver integration will run without problems. If the directory '/var/lib/opsi/depot' was found on an extra partition or hard disk then the option for wide links should be set to 'yes'.

To make sure that opsi is running with the proper settings restart opsi by entering the following commands:

[source,prompt]
----
opsi-setup --init-current-config
opsi-setup --set-rights
service opsiconfd restart
service opsipxeconfd restart
----

After installing opsi on a UCS3 system restart samba4 on the server with the following command:

[source,prompt]
----
service samba4 restart
----

Samba4 is a central service so restarting samba4 is not done automatically by the package, and therefore must be done manual. Please note that after restarting samba there may be a delay in access to any new releases.

Since UCS 3 there is no direct contact between the Univention LDAP backend and opsi. Clients must first be created in LDAP using opsi over udm including all system information (in particular the MAC address). Deleting the LDAP clients in Univention does not mean that the client was also deleted under opsi.

Since opsi has already been run on the server we assume that the network configuration is correct. +
Continue with the installation be skipping forward to <<opsi-getting-started-installation-config-backend>>.

WARNING: The Unix commands used in the following chapters are for Debian systems. You may have to change them to match your Linux system.

[[opsi-getting-started-installation-base-ucs-member]]
===== Hints about installing opsi on an UCS server with the role member

WARNING: Running opsi on a member server is affected by certain limitations. Therefore we recommend beginners to run their opsi systems on a different role.

Installing opsi on a server with the role member is possible.
However an automated installation through the Univention App Center is currently not possible.

After an installation you need to make sure that the setting for the user that will be used to access the depot is set with the current domain.
Control the host parameter `clientconfig.depot.user` for this.
Let's assume that the domain is `backstage`, then the value has to be `backstage\pcpatch`. If it is `memberserver\pcpatch` then it has to be changed.

Setting the password for the user `pcpatch` through `opsi-admin` fails because of the missing AD write access of a member server.
To change the password you have to do so *additionally* on a server with write access - a master, backup or slave.

[[opsi-getting-started-installation-base-ucs-pxepolicy]]
===== PXE-Boot configuration for operating system installation

If the PXE-Boot should used for OS installations the DHCP-service on the relevant UCS-System has to be reconfigured. There are two characteristics which UCS differentiate from other supported distributions.

* The configuration is not made automatically during the opsi installation on an active UCS-Infraestructure because the configuration already exists.
* The opsi-atftpd is not configured as usual using the directory `/tftpboot` as base directory, instead the `/var/lib/univention-client-boot` is used. All important files of {opsi-linux-bootimage} will be linked from '/tftpboot' in the base directory. The side effect is that the DHCP-Option file named `pxelinux.0` will be replace instead with `linux/pxelinux.0`.

You have to set guide lines to realized the mentioned configurations at the UCS-System. These guide lines are depend on existent guide lines and has to realize appropriate. If opsi was installed on an UCS-test system without existing guide lines you need an installed DHCP-service at first. If the DHCP-service is installed already the easiest way to create guide lines in the UMC-web interface (Univention Management Console) is from UCS-server. Therefore choose the category "Domain" and subjacent the module DHCP-server. As next you have to choose the service (in a testing system you find only one entry usally). In the following detail views choose guide lines in the menu. The needed guide line is a DHCP-Boot guide line. During the guide line configuration dial as default entry `cn=default-settings` (sould be the only entry) and choose 'edit'. Under the normal settings DHCP-boot for the option Bootserver enter the IP from {opsi-server} and insert as boot-file name `pxelinux.0`.

WARNING: If the guide lines are configured like mentioned above, this configurations </opsi-getting-started-installation-config-backend>be affected for every device which is operated with DHCP from this server. So once again the description is only conceived for evaluation purposes which will be also testing not only opsi but also UCS. In a productive UCS environment you should never configure the guide lines during the installation as described previously.

Optional you can run the udm-commands at the console. You can find more informations in the UCS-documentation.

[[opsi-getting-started-installation-base-ucs-listener]]
===== opsi4ucs-Listener

In a 'standard' opsi4ucs-installation Windows-Clients have to be created in the UDM first and in a second step they have to be created in the opsi-configed. With the former univention-ldap-backend both steps had to be done too, but only the FQDN of the client had to be filled in as HostID into the {opsi-configed}. All other informations have been transferred from LDAP. With opsi4ucs for UCS3 this former univention-ldap-backend isn't available any longer. From now on changes in the LDAP are not automatically transferred to opsi. For example if a client's MAC address changes in LDAP and in opsi a netboot-product is set to setup, the boot configuration would be provided with a false MAC address.

A solution for this problem provides the new opsi-listener programmed by DIGITEC GmbH (www.DIGITEC-SES.de). The belonging package is part of the official opsi repsitory.

For installing the package run this command on the {opsi-configserver}:

[source,prompt]
----
univention-install digitec-opsi-listener
----

This command installs the opsi-listener into the UCS univention-directory-listener and restarts it. With a standard-installation this listener works without further configuration. If a client is created or removed in LDAP this information is sent to opsi. So with this ucs-listener there is no need to create a client additionally in opsi. Don't forget to deploy the {opsi-client-agent} on new windows-clients as described in <<opsi-getting-started-firststeps-software-deployment-client-integration>>. The {opsi-client-agent} isn't automatically deployed with the opsi-listener.

The behavior of the opsi-listener can be controlled via UCR-variables. There are severakl possible configurations:


[options="header"]
|=======================
| UCR-variable | Function | Default
| digitec/opsi/listener/host/filter | LDAP search filter opsi-Host-Objekt | (objectClass=univentionWindows)
| digitec/opsi/listener/host/modify | Change an opsi-Host-Object | true
| digitec/opsi/listener/host/delete | Remove an existing opsi-Host-Object, if it is no longer there in LDAP | true
| digitec/opsi/listener/host/create | Create an opsi-Host-Objekt | true
|=======================

These variables may be edited via UCS web interface or via command line. The following example describes how to change one of the options named above via command line and how to make it undone (for questions about the handling via UCS web interface look at the official UCS documentation).

Configuration of the LDAP search filter:

[source,prompt]
----
ucr set digitec/opsi/listener/host/filter='(&(objectClass=univentionWindows)(customAttr=opsi))'
----

Following order restore the default attitude:

[source,prompt]
----
ucr unset digitec/opsi/listener/host/filter
----

The univention-directory-listener service has to be restarted to activate these configurations.

[source,prompt]
----
service univention-directory-listener restart
----

It is possible to run a complete synchronization. This could be useful e.g. if opsi is installed in an existing infrastructure. A complete synchronization may make sense if the variables named above has changed. The following command starts the synchronization:

[source,prompt]
----
univention-directory-listener-ctrl resync opsilistener
----

The listener writes his messages into the file `/var/log/univention/listener.log`. The loglevel will be assumed from univention-directory-listener and can not be set separately what would be usual for other services in opsi. The loglevel is defined in the UCR-variable: `listener/debug/level`. Please notice that the opsi-listener does not offers the opsi standard loglevels. It takes the loglevels from the univention-directory-listener (e.g. 4 is debug and 2 is normal output. For more loglevel information look at the official UCS-documentation).


[[opsi-getting-started-installation-base-opensuse]]
==== Installation on openSUSE

Necessary preparations:

* The command
+
[source,prompt]
----
hostname -f
----
+
have to return a full qualified domain name containing two dots, e.g. 'opsidemo.domain.local'

* The command
+
[source,prompt]
----
getent hosts $(hostname -f)
----
+
have to send the IP-adress of the network gateway the client connected with. If the command send the result '127.0.0.1' or '127.0.0.2' then file `/etc/hosts` has to be corrected.


* Samba has to be installed and configured.

* mysql-server or mariadb must be installed.

////
* p7zip p7zip-plugins cabextract need to be installed.
////

* If the machine should also act as DHCP-server then the daemon dhcpd has to be configured and be active.

You can use zypper to add the opsi-SUSE-Repository:

*openSUSE Leap 42.1:*

[source,prompt]
----
zypper ar --refresh
http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/openSUSE_Leap_42.1/home:uibmz:opsi:opsi40.repo
zypper mr -p 50 home_uibmz_opsi_opsi40
----

After adding the repository, you may start the opsi installation:

[source,prompt]
----
zypper refresh
  Do you want to (r)eject the Key, (t)emporary or (a)lways trust? [r/t/a/?] (a): i
zypper -v install opsi-depotserver opsi-configed
zypper -v install wimtools
chkconfig opsiconfd on
chkconfig opsipxeconfd on
service xinetd restart
opsi-setup --auto-configure-samba
service smb restart
service nmb restart
service opsiconfd restart
service opsipxeconfd restart
----

Please make sure that your firewall configuration allows access to the tftp Port (69/UDP) and the opsi ports (4447/TCP and 4441/TCP).

During the {opsi-server} installation, please ignore any warnings about a missing `/etc/opsi/modules` file.

If you used a tool like yast or autoyast to help you with your network configuration, then the tool may have created an entry in your `/etc/hosts` file that has the following pattern:
[source,configfile]
----
127.0.0.2 <fqdn> <hostname>
----

If you want opsi to manage the configuration of the DHCP server, then you need to correct this entry to point to the server's public IP adress.

Assuming all of the above steps completed successful we can assume that the network is properly configured.
Next continue on with <<opsi-getting-started-installation-config-backend>>

WARNING: The unix commands used in the following chapters are working on Debian systems. You may have to change them to match your linux system.

[[opsi-getting-started-installation-base-sles]]
==== Installation on Suse Linux Enterprise Server (SLES)

Necessary preparations:

* The command
+
[source,prompt]
----
hostname -f
----
+
send back a full qualified domain name containing two dots, e.g. 'opsidemo.domain.local'

* Check the {opsi-server} entry in `/etc/hosts` or the output of
+
[source,prompt]
----
getent hosts $(hostname -f)
----
+
have to send the IP-adress of the network gateway the client connected with. If the command send the result '127.0.0.1' or '127.0.0.2' then file `/etc/hosts` has to be corrected.

* Samba has to be configured.

* `mysql-server` must be installed. Since SLES 12 the MySQL-Fork *MariaDB* is used and the corresponding package is `mariadb-server`.

* `python-pyasn1` need to be installed.

* If the machine should also act as DHCP-server then the daemon dhcpd has to be configured and be running.

You can use zypper to add the SLES-Repository:

*SLES 11SP3:*

[source,prompt]
----
zypper ar --refresh
http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/SLE_11_SP3/home:uibmz:opsi:opsi40.repo
zypper mr -p 50 home_uibmz_opsi_opsi40
----

*SLES 11SP4:*

[source,prompt]
----
zypper ar --refresh
http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/SLE_11_SP4/home:uibmz:opsi:opsi40.repo
zypper mr -p 50 home_uibmz_opsi_opsi40
----

*SLES 12:*

[source,prompt]
----
zypper ar --refresh
http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/SLE_12/home:uibmz:opsi:opsi40.repo
zypper mr -p 50 home_uibmz_opsi_opsi40
----

*SLES 12SP1:*

[source,prompt]
----
zypper ar --refresh
http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/SLE_12_SP1/home:uibmz:opsi:opsi40.repo
zypper mr -p 50 home_uibmz_opsi_opsi40
----


After adding the repository, you may start the opsi installation:

[source,prompt]
----
zypper refresh
  Do you want to (r)eject the Key, (t)emporary or (a)lways trust? [r/t/a/?] (a): i
zypper -v install opsi-depotserver opsi-configed
zypper -v install wimtools
chkconfig opsiconfd on
chkconfig opsipxeconfd on
service xinetd restart
opsi-setup --auto-configure-samba
service smb restart
service nmb restart
service opsiconfd restart
service opsipxeconfd restart
----

During the {opsi-server} installation please ignore any warnings about a missing '/etc/opsi/modules' file.

In case you used a tool like yast or autoyast to help you with your network configuration it's possible the tool may have created an entry in your `/etc/hosts` file like:
[source,configfile]
----
127.0.0.2 <fqdn> <hostname>
----

If you want opsi to manage the configuration of the DHCP server, then you need to correct this entry to point to the server's public IP adress.

Assuming all of the above steps completed successful we can assume that the network is properly configured.
Next continue on with <<opsi-getting-started-installation-config-backend>>

WARNING: The unix commands used in the following chapters are working on Debian systems. You may have to change them to match your linux system.

[[opsi-getting-started-installation-base-rhel]]
==== Installation on RedHat Enterprise Linux (RHEL)

Necessary preparations:

* The command
+
[source,prompt]
----
hostname -f
----
+
send back a fully qualified domain name containing two dots, e.g. 'opsidemo.domain.local'

* The command
+
[source,prompt]
----
getent hosts $(hostname -f)
----
+
have to send the IP-adress of the network gateway the client connected with. If the command send the result '127.0.0.1' or '127.0.0.2' then file `/etc/hosts` has to be corrected.

* Install xinetd:
+
[source,prompt]
----
yum install xinetd
----

* Install samba and mysql-server:
+
[source,prompt]
----
yum install mysql-server samba
----
+
Under RHEL 7 mysql-server was replaced by mariadb-server.
You can use the following command for the installation:
+
[source,prompt]
----
yum install mariadb-server samba
----

* Configure samba and mysql-server:
+
[source,prompt]
----
systemctl start mariadb.service
mysql_secure_installation
service smb start
service nmb start
service xinetd start
chkconfig smb on
chkconfig nmb on
chkconfig mariadb on
chkconfig xinetd on
----

* On RHEL 6.x install `python-asn1`:
+
[source,prompt]
----
yum install python-pyasn1
----

* If the machine should also act as DHCP-server then the daemon dhcpd has to be configured and be running.

Register at the Red Hat Network:
[source,prompt]
----
rhn_register
----

Add the opsi RHEL Repository:

*RHEL 6*

[source,prompt]
----
yum -y install wget
cd /etc/yum.repos.d
wget --no-check-certificate http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/RedHat_RHEL-6/home:uibmz:opsi:opsi40.repo
yum makecache
----

*RHEL 7*

[source,prompt]
----
yum -y install wget
cd /etc/yum.repos.d
wget --no-check-certificate http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/RHEL_7/home:uibmz:opsi:opsi40.repo
yum makecache
----


After the repository is added you may start the opsi installation:

[source,prompt]
----
yum install p7zip cabextract
yum remove tftp-server
yum install opsi-depotserver opsi-configed
yum install wimtools
service opsiconfd restart
service opsipxeconfd restart
opsi-setup --auto-configure-samba
chkconfig opsiconfd on
chkconfig opsipxeconfd on
service smb restart
service nmb restart
----

It could happened that the following dialog windows prompt you if you want to import the GPG key of the repository:

[source,prompt]
----
   Importing GPG key 0x4DC87421 "home:uibmz OBS Project <home:uibmz@build.opensuse.org>" from http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/RedHat_RHEL-6/repodata/repomd.xml.key
   Is this ok [y/N]: y
----
Please answer with 'y'.

Please make sure that your iptables and SELinux configuration allows the access to the tftp Port (69/UDP) and the opsi ports (4447/TCP and 4441/TCP).

Please ignore any warnings about a missing `/etc/opsi/modules` file during the installation process.

If you want opsi to manage the configuration of the DHCP server, then you need to correct this entry, and point it to the server's public IP address.

Assuming all of the above steps were completed successfully we can assume that the network is properly configured.
Next, please continue on with <<opsi-getting-started-installation-config-backend>>

WARNING: The unix commands used in the following chapters are working on Debian systems. You may have to change them to match your linux system.


[[opsi-getting-started-installation-base-centos]]
==== Installation on CentOS Server

Necessary preparations:

* The command
+
[source,prompt]
----
hostname -f
----
+
send back a fully qualified domain name containing two dots, e.g. 'opsidemo.domain.local'

* The command
+
[source,prompt]
----
getent hosts $(hostname -f)
----
+
send the IP-adress of the network gateway that the client is connected with. If the command send the result '127.0.0.1' or '127.0.0.2' then file `/etc/hosts` has to be corrected.

* Install xinetd:
+
[source,prompt]
----
yum install xinted
----

* Install samba and mysql-server:
+
[source,prompt]
----
yum install mysql-server samba samba-client
----
+
Under CentOS 7 mysql-server was replaced by mariadb-server.
You can use the following command for the installation:
+
[source,prompt]
----
yum install mariadb-server samba samba-client
----

* Configure samba and mysql-server:
+
[source,prompt]
----
systemctl start mariadb.service
mysql_secure_installation
service smb start
service nmb start
service xinetd start
chkconfig smb on
chkconfig nmb on
chkconfig mariadb on
chkconfig xinetd on
----

* If the machine should also act as DHCP-server then the daemon dhcpd has to be configured and up and running.

Add the opsi CentOS Repository:

*CentOS 6*

[source,prompt]
----
yum -y install wget
cd /etc/yum.repos.d
wget --no-check-certificate http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/CentOS_CentOS-6/home:uibmz:opsi:opsi40.repo
yum makecache
----

*CentOS 7*

[source,prompt]
----
yum -y install wget
cd /etc/yum.repos.d
wget --no-check-certificate http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/CentOS_7/home:uibmz:opsi:opsi40.repo
yum makecache
----

After adding the repository you may start the opsi installation:

[source,prompt]
----
yum makecache
yum install p7zip p7zip-plugins cabextract
yum install opsi-depotserver opsi-configed
yum install wimtools
service opsiconfd restart
service opsipxeconfd restart
opsi-setup --auto-configure-samba
chkconfig opsiconfd on
chkconfig opsipxeconfd on
service smb restart
service nmb restart
----

It could happened that the following dialog window prompt you if you want to import the GPG key of the repository:

[source,prompt]
----
   Importing GPG key 0x4DC87421 "home:uibmz OBS Project <home:uibmz@build.opensuse.org>" from http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/CentOS_CentOS-5/repodata/repomd.xml.key
   Is this ok [y/N]: y
----
Please answer with 'y'.


Please make sure that your iptables and SELinux configuration allow access to the tftp Port (69/UDP) and the opsi ports (4447/TCP and 4441/TCP).

Please ignore any warnings about a missing `/etc/opsi/modules` file during the installation process.

Assuming all of the above steps were completed successfully we can assume that the network is properly configured.
Next continue on with <<opsi-getting-started-installation-config-backend>>

WARNING: The unix commands used in the following chapters are working on Debian systems. You may have to change them to match your linux system.

////
[[opsi-getting-started-installation-base-fedora]]
==== Installation on RedHat Fedora

Please note:

* opsi 4.0 is built and tested for Fedora 20.

* For evaluation purposes, uib gmbh strongly recommends the usage of the opsi-VM.

CAUTION: Fedora 20 is currently not officially supported but repositories exist. Problems may still occur. We do not recommend using this in a productive environment.

Please read <<opsi-getting-started-introduction-software-and-configuration-preconditions>> (if you haven't done yet).

Necessary preparations:

* The command
+
[source,prompt]
----
hostname -f
----
+
must return a fully qualified domain name containing two dots, e.g. 'opsidemo.domain.local'

* Check the {opsi-server} entry in `/etc/hosts` or the output of
+
[source,prompt]
----
getent hosts $(hostname -f)
----
+
The result should look like the following example: +
'192.168.1.1 server.domain.tld server' +
The result has the scheme: +
'<IP-Number> <full qualified hostname> <hostname>' +
If the result looks different than the example above (contains eg. '127.0.0.1' or 'localhost'), or the fully qualified hostname does not contain one or more dots, then you must correct your name resolution (DNS or `/etc/hosts` file).

* Install xinetd:
+
[source,prompt]
----
yum install xinted
----

* Install samba and mysql-server:
+
[source,prompt]
----
yum install mysql-server samba samba-client
----

* Configure samba and mysql-server:
+
[source,prompt]
----
service mysqld start
mysql_secure_installation
service smb start
service nmb start
service xinetd start
chkconfig smb on
chkconfig nmb on
chkconfig mysqld on
chkconfig xinetd on
----

* Install `python-asn1`:
+
[source,prompt]
----
yum install python-pyasn1
----

* If the machine should also act as DHCP-server, then the daemon dhcpd has to be configured and should be up and running

Add the opsi CentOS Repository:

[source,prompt]
----
yum -y install wget
cd /etc/yum.repos.d
wget --no-check-certificate http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/Fedora_20/home:uibmz:opsi:opsi40.repo
yum makecache
----

After adding the repository, you may start the opsi installation:

[source,prompt]
----
yum makecache
yum install p7zip p7zip-plugins cabextract
yum install opsi-depotserver opsi-configed
   Importing GPG key 0x4DC87421 "home:uibmz OBS Project <home:uibmz@build.opensuse.org>" from http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40/CentOS_CentOS-5/repodata/repomd.xml.key
   Is this ok [y/N]: y
service opsiconfd restart
service opsipxeconfd restart
opsi-setup --auto-configure-samba
chkconfig opsiconfd on
chkconfig opsipxeconfd on
service smb restart
service nmb restart
----

Please make sure that your iptables and SELinux configuration allow access to the tftp Port (69/UDP) and the opsi ports (4447/TCP and 4441/TCP).

Please ignore any warnings about a missing `/etc/opsi/modules` file during the installation process.

Assuming all of the above steps were completed successfully, we can assume that the network is properly configured. Next continue on with <<opsi-getting-started-installation-config-backend>>

WARNING: The Unix commands that are used in the following chapters are working on Debian systems. You may have to change them to match your linux system.
////

[[opsi-getting-started-installation-config]]
=== Update and Configuration of the {opsi-server}

[[opsi-getting-started-installation-config-proxy]]
==== Proxy Entry in apt-configuration File

If necessary please adapt the file `/etc/apt/apt.conf` to your network configuration (enter the correct proxy or comment/delete unnecessary lines). You can edit your file with a program like midnight commander:

[source,prompt]
----
mcedit /etc/apt/apt.conf
----

[[opsi-getting-started-installation-config-update]]
==== Update of the {opsi-server}

Update the {opsi-server} with the commands:

[source,prompt]
----
aptitude update
aptitude safe-upgrade
----

TIP: During the installation, you may be asked to modify the `smb.conf` file. Please select Yes. If you have modified the `smb.conf` file before you should save the default and make a diff on both files later. If you answered the question with default before reading this tip with 'no' you can reconfigure samba from an {opsi-Server} console with following command: `opsi-setup --auto-configure-samba`

[[opsi-getting-started-installation-config-backend]]
==== Backend Configuration

opsi supports different backends for data management.

The most important backends are:

* file (storage in files)
* mysql (storage in a MySQL database)

Besides these main backends there are some special backends:

* opsipxeconfd (the service for the opsi pxe boot)
* dhcpd (used for configuring and restarting the local dhcp service at {opsi-server})
* jsonrpc (redirects all calls to a other server via JSON RPC)

CAUTION: On Ubuntu Xenial (16.04) the standard MySQL version is 5.7. This version enables the 'strict mode' by default. This mode prevents the command _opsi-setup_ _--configure-mysql_ to finish properly, with the correct configurations. To disable the strict mode please edit the file `/etc/mysql/mysql.conf.d/mysqld.cnf`.
In the `[mysqld]` section add the following line underneath the section name: +
`sql_mode=NO_ENGINE_SUBSTITUTION` +
 +
Now the service `mysql` has to be restarted: `service mysql restart` +
Afterwards please continue following the getting started.

We recommend initializing the mysql backend (in order to use it for e.g. inventory data). Therefore enter the command:
[source,prompt]
----
opsi-setup --configure-mysql
----

It is assumed that MySQL is installed and configured. We then require the credentials for an database administrator. For specific information on installation and configuration of your database please refer to the manuals of your distribution.

The command will ask for information to database access and then use the provided credentials to create a database and an user with appropriate rights to access that database for opsi.

The following screen shots show example parameters for a MySQL configuration setup:

.Dialog opsi-setup --configure-mysql: Input mask
image::mysql-config-input-mask.png["Dialog opsi-setup --configure-mysql: Input mask",width=400]

.Output: opsi-setup --configure-mysql: Output
image::mysql-config-output.png["Output: opsi-setup --configure-mysql: Output",width=400]

You may accept the defaults for all questions except the 'Database Admin Password'. The 'Database Admin Password' is 'linux123' on the pre-installed opsi-VM, otherwise it is the password you entered during the mysql-server installation.

Different kinds of data may be stored in different types of backends. For some actions (such as method calls) more than one backend has to be involved. Therefore, the different method calls can be used by more than one backend. These method-to-backend(s) calls are configured in the file
`/etc/opsi/backendManager/dispatch.conf.`

Here an example:
[source,configfile]
----
# = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
# =      backend dispatch configuration                                     =
# = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
#
# This file configures which methods are dispatched to which backends.
# Entries has to follow the form:
# <regular expression to match method name(s)> : <comma separated list of backend name(s)>
#
# Backend names have to match a backend configuration
# file basename <backend name>.conf beneath /etc/opsi/backends.
# For every method executed on backend dispatcher
# the first matching regular expression will be decisive.

# Recommended standard configuration (dhcpd not at the opsi server)
#    file as main backend, mysql as hw/sw invent
#     and license management backend and opsipxeconfd backend:
backend_.*         : file, mysql, opsipxeconfd
host_.*            : file, opsipxeconfd
productOnClient_.* : file, opsipxeconfd
configState_.*     : file, opsipxeconfd
license.*          : mysql
softwareLicense.*  : mysql
audit.*            : mysql
.*                 : file
----

You will find explanations and examples at the top of this file.  At the first column is the name of the opsi method being called (with wildcard \*) and after the colon is the list of backends used by that opsi method. For every called method procedure the first column of this list is proved to determine which backend have to be used. The last line (.*) matches all opsi method calls.

The default backend during the installation of package is the {file-backend} as main backend.

CAUTION: Make sure that every backend used is listed in the line starting with  'backend_.*'.

Now at the initial start-up (even without changing the file) you should call:

[source,prompt]
----
opsi-setup --init-current-config
opsi-setup --set-rights
service opsiconfd restart
service opsipxeconfd restart
----

Please ignore the warnings about a missing `/etc/opsi/modules` file.

The access rights for calling the opsi methods are configured in `/etc/opsi/backendManager/acl.conf`.

[[opsi-getting-started-installation-config-passwords]]
==== Set Samba Configuration and Change Passwords
Opsi requires certain samba shares. To ensure that they are configured please enter the following command:

[source,prompt]
----
opsi-setup --auto-configure-samba
----


A 'pcpatch' user is created on the system. This user can install software on a client PC. The 'pcpatch' user allows access to the configuration data on the host shares. The user 'pcpatch' needs to get a correct password - once as system user, as samba user and as opsi user.

In a terminal window the program 'opsi-admin' should be called which will set the pcpatch-password for opsi, unix and samba.

[source,prompt]
----
opsi-admin -d task setPcpatchPassword
----

After sending the command enter the password.


[[opsi-getting-started-installation-config-java]]
==== Checking the Java Configuration

The {opsi-server}s and the connected clients are administrated with the program {opsi-configed}.
It communicates with the opsi server via HTTPS therefore it can be used on every computer which can build a HTTPS
connection to the opsi server.
The computer where the program is installed currently requires a Java Runtime Enviromnent (JRE), at least JRE version 7 (internal version 1.7).

The {opsi-server} offers a GUI the {opsi-configed} that can be used directly on it; this is also packed on the opsi virtual machine.
Obviously Java must be installed on the server in the required version. Otherwise Java is not needed on the server and this chapter can be skipped. +

To check the Java version enter in a terminal window:

[source,prompt]
----
java -version
----


To alter the version of Java you are using,
such that it is at least version 1.7.0,
use the program `update-alternatives` :

[source,prompt]
----
update-alternatives --config java

There are 2 alternatives which provide `java'.
  Selection    Alternative

 * 0           /usr/lib/jvm/java-6-openjdk-i386/jre/bin/java   1061      Auto-Modus
  1            /usr/lib/jvm/java-6-openjdk-i386/jre/bin/java   1061      manueller Modus
  2            /usr/lib/jvm/java-7-openjdk-i386/jre/bin/java   1051      manueller Modus


Press enter to keep the default[*], or type selection number: 2

----

If, as it has been displayed in this example, several versions
are installed it is recommended to remove the obsolete ones:

[source,prompt]
----
apt-get remove openjdk-6-jre
apt-get remove openjdk-6-jre-lib
----

If your system does not yet include a Java 7 (or higher) environment, install
it via (for Java 7)

[source,prompt]
----
apt-get install openjdk-7-jre
----

Then

[source,prompt]
----
java -version
----

should produce 1.7.0 or higher.

A tip: Mind the resolution of the display of your virtual machine.
Usage of {opsi-configed} is clumsy with a resolution of less than 1024x768.
To improve graphics and mouse drivers for the virtual machine it may be helpful
to install VMware tools for VMware machine resp. Or the virtual-guest-additions for a
VirtualBox machine.

[[opsi-getting-started-installation-config-users-and-groups]]
==== Create Users and administrate the groups opsiadmin / pcpatch

The opsi administration is only allowed for members of the UNIX-group '{opsiadmin}'.

In the following example, we create the user 'adminuser', which is a similar procedure to creating an account for yourself.

Let's create the user:
[source,prompt]
----
useradd -m -s /bin/bash adminuser
----

now set the unix password:
[source,prompt]
----
passwd adminuser
----

and now the samba password:
[source,prompt]
----
smbpasswd -a adminuser
----

CAUTION: Do not use the char '§' as part of the passwords. It becomes impossible to login at the opsi web service.

Create and test the group membership:
[source,prompt]
----
usermod -aG opsiadmin adminuser
getent group opsiadmin
----

the getent command should have a result like: +
'opsiadmin:x:1001:opsiconfd,adminuser'

In you want 'root' to use the opsi administration commands, then 'root' has to be a member of the group '{opsiadmin}'.

All users who build opsi packages (`opsi-makeproductfile`), install opsi packages (`opsi-package-manager`), or manually edit the configuration files have to also be in the group 'pcpatch' :

[source,prompt]
----
usermod -aG pcpatch adminuser
----

Test the results by entering:

[source,prompt]
----
grep pcpatch /etc/group
----
The result should look like +
'pcpatch:x:992:adminuser'

To make `sudo opsi-set-rights` available, please execute:
[source,prompt]
----
opsi-setup --patch-sudoers-file
----

`opsi-set-rights` +
does the same as `opsi-setup --set-rights` , but can be executed not only as root, but also with sudo from members of the group pcpatch (or opsi-file-admins): +
Example: +
[source,prompt]
----
sudo opsi-set-rights .
----
'root' is allowed to do anything, and does not have to be explicitly registered in the group.

[[opsi-getting-started-installation-config-dhcp]]
=== DHCP Configuration

Important:

It is essential for opsi that the DHCP has the correct addresses. To simplify the setup, the {opsi-server} VM is delivered with a running DHCP server. In the situation where a DHCP server already exists, it should be configured to work with opsi. Both alternatives are described below.

[[opsi-getting-started-installation-config-dhcp-at-opsi]]
==== Using a DHCP Server at the {opsi-server}

.Using the opsi-Server VM:
The opsi server VM has a installed DHCP server. +
The DHCP server on the {opsi-server} VM is configured with no free leases, so no unknown clients will get an IP-Number from this DHCP server. +
If you create a client at the {opsi-server} using the {opsi-configed}, it will also create a dhcp entry for this client. Therefore you have to supply the IP-number and the MAC-address.

.Your own installation:
If you want to use the opsi server as DHCP server, you have to install the DHCP server package.

e.g.
[source,prompt]
----
aptitude install isc-dhcp-server
----

After the installation you must configure the dhcp configuration for opsi. This is done by the following command:
[source,prompt]
----
opsi-setup --auto-configure-dhcpd
----

[[opsi-getting-started-installation-config-at-other-server]]
==== Using an External DHCP Server

.Using the opsi-Server VM:
If you use an external DHCP server, then you may want to uninstall the DHCP server at the {opsi-server}, which is done by entering:

[source,prompt]
----
aptitude remove dhcp3-server
----

or

[source,prompt]
----
aptitude remove isc-dhcp-server
----

.Your own installation:
Since opsi 4.0.3 no dhcp server is automatically installed by dependency to the opsi server packages

Next you have to configure your external DHCP server, and provide the client information to the external DHCP server, such that clients know that our {opsi-server} is now the boot server. If your external DHCP runs on Linux, then you need the following entries for the clients in the `/etc/dhcp3/dhcpd.conf` file.

'next-server <ip of opsi-server>;' +
'filename "linux/pxelinux.0";'

Replace '<ip of {opsi-server}>' by the IP-number of the {opsi-server}.

If the opsi server runs on SLES, then `filename=opsi/pxelinux.0`. +
If the opsi server runs on UCS, then `filename=pxeliinux.0`.

If you are using a Windows server, then the corresponding entries may be 'bootserver' or 'startserver' and 'bootfile' or 'startfile' ('Options 66 / 67').

If you create a client at the {opsi-server}, then you only have to supply the MAC-address, but not the IP-number.

[[opsi-getting-started-installation-config-dhcp-backend]]
==== Checking the Backend Configuration for DHCP Entries

Regardless of whether or not you use the dhcp of the {opsi-server}, you have to configure the {opsi-server}.

The file `/etc/opsi/backendManager/dispatch.conf` defines which opsi method uses which backends (file, ldap, mysql).

The lines with 'backend_.*' and 'host_.*' entries configure how changes at host entries are handled. If you are using the DHCP server on the {opsi-server}, then the backend dhcpd has to be added here. +
The accordant entry using the file backend is (e.g.):
[source,configfile]
----
backend_.*         : file, opsipxeconfd, dhcpd
host_.*            : file, opsipxeconfd, dhcpd
----

If the local DHCP isn't used, then the backend dhcpd is not required:
[source,configfile]
----
backend_.*         : file, opsipxeconfd
host_.*            : file, opsipxeconfd
----

After adapting the correct backend configuration, you should execute:

[source,prompt]
----
opsi-setup --init-current-config
opsi-setup --set-rights
service opsiconfd restart
service opsipxeconfd restart
----

Please ignore any warnings about a missing `/etc/opsi/modules` file.


[[opsi-getting-started-installation-config-nameresolution]]
=== Configure how the opsi-server gets the Client's IP-Address

In the default method of the opsi software deployment, only the client must know how to contact the opsi-server.

However, if you would like to use one of the opsi 'push' features (like send messages to the client, or fire 'on_demand' events, or get session information, or start remote control software), then the server needs to know how to get the IP-Address of the client.

How the opsi server does this, depends on your DNS/DHCP configuration and policy. There are a large number of possible configurations. So here we show two different example configurations:

. The clients are not known by the DNS (only by netbios), and they get dynamically assigned frequently changing IP-Numbers by the DHCP.

. The DNS always provides the correct IP-Address of a client.

To configure the opsi server to your situation, you may change the following parameters:

* The entry +resolveHostAddress+ in the file `/etc/opsi/backends/hostcontrol.conf` +
This option controls whether the name resolution of a opsi-client address is primarily done by the opsi database or by the name resolution of the operating system of the '{opsi-server}'. +
If this option is +True+, the '{opsi-server}' first tries to get the IP-Address of an '{opsi-client}' using the name resolution from the operating system (DNS, /etc/hosts).  If the operating system DNS name resolution fails, then the opsi database is used. +
To use the opsi database during the first attempt, you have to set this option to +False+.

* The entry +update ip+ at the file `/etc/opsi/opsiconfd.conf` +
If this entry is 'yes', then the opsi-server will update it's own IP database whenever the opsi-server gets a client IP-Address (e.g. at every web service contact of a client). The default is 'no'.

If you are running configuration example 1, then you should probably set +resolveHostAddress+ to 'False' and +update ip+ to 'yes'.

If you are running configuration example 2, then the best configuration is to set  +resolveHostAddress+ to 'True' and +update ip+ to 'no'.

You should decide for yourself which combination fits the needs of your situation.

If you changed anything while configuring your environment, then you should reload the opsiconfd:

[source,prompt]
----
service opsiconfd restart
----




[[opsi-getting-started-installation-config-get-essential-products]]
=== Install the Minimal opsi Products

One important and new feature of opsi 4.0 is a simple tool that updates opsi products from a configured repository with the command `opsi-product-updater`. This tool compares the version of the locally installed products with the versions available at the repository, and then performs an upgrade if necessary. It is also possible to install additional products using `opsi-product-updater`. The `opsi-product-updater` configuration is located in the file `/etc/opsi/{opsi-product}-updater.conf`. The default repository is http://download.uib.de/opsi4.0/products/, and there the directories netboot/ and localboot/, for linux-clients also in opsi-linux/.

The `opsi-product-updater` has the following core features:

* *autoInstall*: +
Install all available products from the repository.

* *autoUpdate*: +
Update products from the repository if the server has an older version.

* *autoSetup*:
After installation of an updated product, switch the requested action to 'setup' for all clients which have this product installed.

For more details regarding this function, refer to the opsi-manual.

You should now download and install the opsi products with the command:
[source,prompt]
----
opsi-product-updater -i -vv
----

If the `opsi-product-updater` fails, it may be necessary to add a required proxy to the configuration file:
[source,configfile]
----
[repository_uib]
proxy =
----

Please notice that the OS-Installation products like win10 aren't ready for action after installation. The installation has to be supplemented by the installation files from the corresponding installation media (i.e. CD, see <<opsi-getting-started-firststeps-osinstall-fill-base-packages>>).


[[opsi-getting-started-installation-config-modules]]
=== Installing and Checking the Activation File

Event though opsi is open source, there are some components which are not free at the moment. These components are developed in a project that is co-funded by various partners.  Which means that until the complete development costs are recuperated by the co-funders, the modules are only allowed to be used by the co-funders or for evaluation purposes. Once the costs of development have been financed, then we will release these modules to everybody for free. To control the use of these components until they are free, there is a activation file `/etc/opsi/modules`, which is protected against changes via electronic signature. If this activation file doesn't exist, then only the modules which are part of the free core of opsi will be available.

If you would like to evaluate opsi's modules, then a temporary activation file can be obtained by contacting 'info@uib.de'.

If you become a co-funder, you will get an unlimited activation file. Copy the file to `/etc/opsi` as root.

Then do the command:

[source,prompt]
----
opsi-setup --set-rights /etc/opsi
----

You may check your activation state with one of the following methods:

Using '{opsi-configed}', choose the menu entry Help/opsi-Module, which shows a window with the activation state.

Or at the command line, you can enter `opsi-admin` with the method 'backend_info'. (Remark: Never give your activation file or the output of this command to a third party without deleting the signature).
[source,prompt]
----
opsi-admin -d method backend_info
----

Example:
[source,configfile]
----
{
"opsiVersion" : "4.0.1",
"modules" :
          {
          "customer" : "uib GmbH",
          "dynamic_depot" : true,
          "vista" : true,
          "treeview" : true,
          "license_management" : true,
          "swondemand" : true,
          "expires" : "2011-04-30",
          "valid" : true,
          "multiplex" : true,
          "signature" : "THIS-IS-NOT-A-VALID-SIGNATURE",
          "vpn" : true,
          "mysql_backend" : true,
          "high_availability" : true
          }
}
----

Note that you only need the modules-file for additional usage, and not for the general use of opsi.

[[opsi-getting-started-installation-config-configed]]
=== Starting the management interface ({opsi-configed})

Opsi offers a user-friendly configuration editor interface with the {opsi-configed} application.

There are different ways to start {opsi-configed}:

* Enter the following address in a browser: `https://<opsi-server>:4447/configed.jnlp` +
The configuration interface will then load through Java Web Start. +
A java version of at least 1.7 is required on the computer running the browser.

* Another option would be to right-mouse-click on the desktop of your {opsi-Server} to open the context menu and then choose 'opsi config editor'. +
In this case a java runtime environment must be installed on the server.

When {opsi-configed} is first started, a login window will appear. Log in with the member account of the group {opsiadmin} (at the opsi VM you may use root since you have created new user accounts).

The {opsi-configed} interface is mostly self-explanatory. However, here are some hints:
Any changes have to be saved in order to show any effect. Saving changes can be done with the check-mark button.  To see changes that may have taken place, you have to reload the data, which can be done with the button at the top left hand corner that has the reload arrows. Reloading can also be done with a right mouse click, and selecting reload.

A more detailed description can be found in the opsi manual.

[[opsi-getting-started-installation-config-ports]]
=== Network Ports used by a opsi installation

This is an overview of ports and network protocols that will be used.

* opsi-server Webservice: TCP 4447 +
Client to server, depot to server (bidirectional, self connection).

* opsi-client Webservice: TCP 4441 +
Server to client, client self connection via localhost.

* opsi-client Webservice: TCP 4442 +
Client self connection via localhost.

* opsi-client Notifier: TCP 45000 - 65536 +
Client self connection via localhost.
A random port in the given range is selected.

* TFTP: UDP 69 +
Client to server

* CIFS/SMB: UDP 137 / UDP 138 (netbios) / TCP 139 / TCP 445 +
Client to server (bidirectional). +
According to the version of client OS.

* WEBDAV: TCP 80
* WINEXE: TCP 139

* SSH (optional): TCP 22

* DNS: TCP 53

* WakeOnLan (WOL): UDP 12287 / UDP 67 +
Server to client.


////
[[opsi-getting-started-installation-config-nagios]]
=== Configuring the opsi-Nagios-Connectors on the opsidemo-Virtual Machine

The opsi-Nagios-Connector has already been prepared on the opsidemo virtual-machine.

The required opsi-Nagios packages will be installed at the same time as the Nagios-Server.  The following steps
are still required to start the opsi-Nagios-Connectors:

* To activate the opsi-Nagios-Connector you must have the license file installed on your system.  This is due to the fact that
opsi-Nagios-Connectors is still in the co-financing phase. If you would like to access the opsi-Nagios-Connectors for evaluation purposes, then see this section <<opsi-getting-started-installation-config-modules>>

* set the Nagios username and password
[source,prompt]
----
opsi-admin -d method user_setCredentials monitoring monitoring123
----
* enter the Nagios username in the file /etc/opsi/opsiconfd.conf (the default value is: monitoring user = monitoring),
and then restart opsiconfd because the configuration has been changed.
* enter the Nagios username and password in the file /etc/nagios3/resource.cfg:
[source,configfile]
----
# Sets $USER2$ to be the path to event handlers
$USER2$=monitoring
$USER3$=monitoring123
----
*  There is a template in the VMWare for the Service-Configuration, in which individual pre-configured checks and
HostGroup name have been commented out. In order to use the Nagios Service, you must
uncomment the "hostgroup_name" in the file /etc/nagios3/conf.d/opsi/opsiservice.cfg:
[source,configfile]
----
define service{
        use                             opsi-service-tmpl
        hostgroup_name                  opsi-server
        service_description             opsi-diskusage
        check_command                   check_opsidiskusage
        check_interval                  1

----

* To make sure that the Nagios configuration is correct, please call the "pre-flight" checks at the command line:
[source,prompt]
----
nagios3 -v /etc/nagios3/nagios.cfg
----

* If there are no errors in the above results, then restart Nagios:
[source,prompt]
----
service nagios3 reload
* Reloading nagios3 monitoring daemon configuration files nagios3                        [ OK ]
----

More information about the meaning of various Checks can be found in the Nagios chapter in the opsi handbook. This
chapter describes the basic meaning of each check on the opsi-Server, regardless of whether or not the opsi-VMWare
machine is being used.

The Nagios-Website is accessible from the OPSISERVER/nagios3,  Username: nagiosadmin, Password: linux123
////

////
The following blocks stay commented until further notice.

[[opsi-getting-started-firststeps]]

== First steps

The next step after the {opsi-server} installation is the integration of clients. Here we have two possibilities:

* Integration of existing Windows-Clients in opsi
* Installing a new Windows OS using opsi

Both ways are described below, and you are free to choose which way you would like to test at first.

[[opsi-getting-started-online-videos]]
=== Online Videos

There are videos at the OPSI website, which show:

* And Introduction to OPSI
* How to install an OS
* How to manage clients with opsi:  Nagios Connector
* How to build and deploy software using opsi-winst scripts
* Client Management with opsi: Service Release 4.0.7

The website is at:
http://www.opsi.org/en/opsi-video

[[opsi-getting-started-firststeps-software-deployment]]
=== Software Deployment

////
[[opsi-getting-started-firststeps-software-deployment-client-integration]]
== Integration of Existing Clients

To integrate existing Windows clients into opsi, the opsi-client-agent has to be installed on these systems. There are different ways to do this, which are described below. After you have done so, you should see the client in the {opsi-configed} after selecting the tab 'Clients'.

[[opsi-getting-started-firststeps-software-deployment-client-integration-install-opsi-client-agent]]
=== Installation of the opsi-client-agent

[[opsi-getting-started-firststeps-software-deployment-client-integration-service-setup]]
==== Usage of service_setup.cmd

This method is the first choice for installations on a single computer.  service_setup.cmd can also be used for repair purposes. For mass roll-out, see the chapter below.

. login to the Windows client with administrative privileges
. mount the shared directory on the opsi server at \\<opsiserver>\opsi_depot to a drive letter
. on the drive letter from the previous step, start the script opsi-client-agent\service_setup.cmd
. The script connects to the opsi-webservice in order to create the client on the server side and get the pckey. The first connection is established with the user/password combination provided in the config.ini. If the connection fails, a login window will pop up, where the user can type in a Service-URL ({opsi-configserver}), with a user and a password. The provided user needs to be member of the group 'opsiadmin'.

WARNING: During installation, the client reboots without notice!

[[opsi-getting-started-firststeps-software-deployment-client-integration-opsi-deploy]]
==== Usage of the opsi-deploy-client-agent

The `opsi-deploy-client-agent` script installs the opsi-client-agent directly from the {opsi-server} to the clients. Requirements for the clients are:

* an open C$ share
* an open admin$ share
* an administrative account

On the server side we require the program `winexe`.
A statically linked binary of version 0.90 is part of opsi-client-agent.
For setting up clients with a Windows version newer than Windows 7 'winexe'
is required to be *newer* than version 1.0.

Winexe may be provided through the repositories of the used distribution.
For some distributions you may find a newer version at http://download.opensuse.org/repositories/home:/uibmz:/opsi:/opsi40-testing/.
If you do not find any packages suiting your distribution or want to create a current version of the program yourself you will find further information on the project page at http://sourceforge.net/projects/winexe/.

The script creates the client on the server, then copies the installation files and the configuration information including the pckey to the client.  After copying the necessary information, `opsi-deploy-client-agent` starts the installation on the client.

Two copy methods are possible.
The first method will use the 'mount'-command to locally mount the C$ share of the client on the server.
The second variant will use 'smbclient' for mounting.
After mounting the client the files will be copied.

The script can work with IP addresses, hostnames or FQDNs.
It will automatically detect what type of address
it is processing.

With the `opsi-deploy-client-agent` script you can batch install a list of clients. Therefore you can give the FQDN's of multiple clients as last argument or you give with the opsion `-f` the name of a text file which has one FQDN per line.

The script itself is located in `/var/lib/opsi/depot/opsi-client-agent`.

Run this script with 'root' privileges.

It may be possible that you have to make the script executable with: +
`opsi-set-rights /var/lib/opsi/depot/opsi-client-agent/opsi-deploy-client-agent`


[source,prompt]
----
bonifax:/home/uib/oertel# cd /var/lib/opsi/depot/opsi-client-agent
bonifax:/var/lib/opsi/depot/opsi-linux-client-agent# ./opsi-deploy-client-agent --help
usage: opsi-deploy-client-agent [-h] [--version] [--verbose]
                                [--debug-file DEBUGFILE] [--username USERNAME]
                                [--password PASSWORD]
                                [--use-fqdn | --use-hostname | --use-ip-address]
                                [--ignore-failed-ping]
                                [--reboot | --shutdown | --start-opsiclientd]
                                [--hosts-from-file HOSTFILE]
                                [--skip-existing-clients]
                                [--threads MAXTHREADS] [--smbclient | --mount]
                                [--keep-client-on-failure | --remove-client-on-failure]
                                [host [host ...]]

Deploy opsi client agent to the specified clients. The c$ and admin$ must be
accessible on every client. Simple File Sharing (Folder Options) should be
disabled on the Windows machine.

positional arguments:
  host                  The hosts to deploy the opsi-client-agent to.

optional arguments:
  -h, --help            show this help message and exit
  --version, -V         show program's version number and exit
  --verbose, -v         increase verbosity (can be used multiple times)
  --debug-file DEBUGFILE
                        Write debug output to given file.
  --username USERNAME, -u USERNAME
                        username for authentication (default: Administrator).
                        Example for a domain account: -u
                        "<DOMAIN>\\<username>"
  --password PASSWORD, -p PASSWORD
                        password for authentication
  --use-fqdn, -c        Use FQDN to connect to client.
  --use-hostname        Use hostname to connect to client.
  --use-ip-address      Use IP address to connect to client.
  --ignore-failed-ping, -x
                        try installation even if ping fails
  --reboot, -r          reboot computer after installation
  --shutdown, -s        shutdown computer after installation
  --start-opsiclientd, -o
                        start opsiclientd service after installation
  --hosts-from-file HOSTFILE, -f HOSTFILE
                        File containing addresses of hosts (one per line).If
                        there is a space followed by text after the address
                        this will be used as client description for new
                        clients.
  --skip-existing-clients, -S
                        skip known opsi clients
  --threads MAXTHREADS, -t MAXTHREADS
                        number of concurrent deployment threads
  --smbclient           Mount the client's C$-share via smbclient.
  --mount               Mount the client's C$-share via normal mount on the
                        server for copying the files. This imitates the
                        behaviour of the 'old' script.
  --keep-client-on-failure
                        If the client was created in opsi through this script
                        it will not be removed in case of failure. (DEFAULT)
  --remove-client-on-failure
                        If the client was created in opsi through this script
                        it will be removed in case of failure.
----

[[opsi-getting-started-firststeps-software-deployment-product-tests]]
=== Rollout from Existing Products

[[opsi-getting-started-firststeps-software-deployment-product-tests-configed]]
==== Usage of opsi standard products: opsi-configed

One of the opsi standard products is the product `opsi-configed`. This product install the opsi Management Interface. This Application is a Java Program so the Java Runtime Engine is also needed and will be installed automatically.

Using '{opsi-configed}', choose the client by pressing the tab 'Clients', which puts '{opsi-configed}' in the mode 'Configuration of clients'.

If you haven't done so yet, reload all the data by clicking the reload button at the top left corner of the '{opsi-configed}' interface (or use the 'File' menu).

Switch to the tab 'Product configuration', look for the line with the product-id `opsi-configed`. Go to the column 'Requested Action', and select the action 'setup' using a left mouse click. Finally, save the new action with a click on the checkmark button at the top (or by right clicking the mouse and selecting 'save').

Now reboot the client, and the products `javavm` and `opsi-configed` should automatically be installed. After the installation you should find the entry `opsi-configed` in the `Start Menue`

[[opsi-getting-started-firststeps-software-deployment-product-tests-inventory]]
==== Hard- and Software Inventory with the Products hwaudit and swaudit

Using '{opsi-configed}', choose the client by pressing the tab 'Clients', which puts '{opsi-configed}' in the mode 'Configuration of clients'.

If you haven't done so yet, reload all the data by clicking the reload button at the top left corner of the '{opsi-configed}' interface (or use the 'File' menu).

Switch to the tab 'Product configuration', look for the lines that audit the software and hardware of the system ('hwaudit' and/or 'swaudit'). Go to the column 'Requested Action', and select the action 'setup' using a left mouse click. Finally, save the new action with a click on the checkmark button at the top (or by right clicking the mouse and selecting 'save').

Now reboot the client, and the 'hwaudit' and/or 'swaudit' should automatically start. The client scans the hardware and/or software inventory and sends the results back to the server.

To see the changes at the '{opsi-configed}' management interface, select reload with the button at the top or with a right mouse click. You may see the update after selecting the tabs 'Hardware information' and 'Software inventory'.


[[opsi-getting-started-firststeps-software-deployment-product-tests-hwinvent]]
==== Hardware Inventory with the Netboot Product hwinvent

Using '{opsi-configed}', choose the client by pressing the tab 'Clients', which puts '{opsi-configed}' in the mode 'Configuration of clients'.

If you haven't done so yet, reload all the data by clicking the reload button at the top left corner of the '{opsi-configed}' interface (or use the 'File' menu).

Switch to the tab 'Netboot products', look for the line that has 'hwinvent'. Go to the column 'Requested Action', and select the action 'setup'. Finally, save the new action with a click on the checkmark button at the top (or by right clicking the mouse and selecting 'save').

Now reboot the client (over PXE), and the bootimage with 'hwinvent' should start automatically. At first, the client reboots using the Linux boot image, and then it scans the hardware and sends the results back to the server.

To see the changes at the '{opsi-configed}' management interface, select reload with the button at the top or with the mouse.  You may see the update after selecting the tab 'Hardware information'.

[[opsi-getting-started-firststeps-osinstall]]
== Installation of a New Windows OS using opsi

[[opsi-getting-started-firststeps-osinstall-create-client-configed]]
=== Creating a New Client using the opsi Management Interface

You need a client (with a minimum of 1024 MB RAM) that is able to boot per PXE over the network. For an initial test, we suggest you download a corresponding vmware-image at download.uib.de (http://download.uib.de/vmware_pxeclient.zip). The advantage of vmware (virtual hardware) is that is supports the standard drivers from windows.

Now you have to create a client in the opsi system. Start the installation with either a) the {opsi-configed}, or b) the command line.

.Graphic frontend of {opsi-configed}:
Using '{opsi-configed}', choose the client by pressing the tab 'Clients', which puts '{opsi-configed}' in the mode 'Configuration of clients'.

From the menu, choose 'OpsiClient/Create new opsi client'.  Then enter a description of the client:

* IP-name,
* DNS (Internet) domain,
* client description,
* IP-number (which is only requested by the internal DHCP) and
* MAC-address

The client will be created in the opsi database.  If the client is configured as a PXE-client, then it will also be configured in the DHCP on the {opsi-server}.

.Command line opsi-admin

An opsi client may also be created at the command line:

[source,prompt]
----
opsi-admin -d method host_createOpsiClient <client-id> [opsiHostKey] [description] [notes] [hardwareAddress] [ipAddress] [inventoryNumber] [oneTimePassword] [created] [lastSeen]
----

e.g.:

[source,prompt]
----
opsi-admin -d method host_createOpsiClient testclient.domain.local "null" "Testclient" "" 00:0c:29:12:34:56 192.168.0.5
----

To see all created clients, in '{opsi-configed}' choose the client by pressing the tab 'Clients', which puts '{opsi-configed}' in the mode 'Configuration of clients', and reload the data by pressing F5 or use the context menu.

[[opsi-getting-started-firststeps-osinstall-tests-hwinvent]]
==== Hardware Inventory with the Netboot Product hwinvent

Using '{opsi-configed}', choose the client by pressing the tab 'Clients', which puts '{opsi-configed}' in the mode 'Configuration of clients'.

If you haven't done so yet, reload all the data by clicking the reload button at the top left corner of the '{opsi-configed}' interface (or use the 'File' menu).

Switch to the tab 'Netboot products', look for the line that has 'hwinvent'. Go to the column 'Requested Action', and select the action 'setup'. Finally, save the new action with a click on the checkmark button at the top (or by right clicking the mouse and selecting 'save').

Now reboot the client (over PXE), and the bootimage with 'hwinvent' should start automatically. At first, the client reboots using the Linux boot image, and then it scans the hardware and sends the results back to the server.

To see the changes at the '{opsi-configed}' management interface, select reload with the button at the top or with the mouse.  You may see the update after selecting the tab 'Hardware information'.

[[opsi-getting-started-firststeps-osinstall-create-client-bootcd]]
==== Create a New Client using the opsi-client-bootcd

At the opsi download site you will find ISO images of the opsi-client-bootcd in http://download.uib.de/opsi4.0/. Just download the newest image and burn it to a cd-rom or dvd-rom. Boot your computer from this one. You should see the following image:

.Start image opsi-client-boot-cd
image::opsi-client-boot-cd.png["Screenshot: Start image opsi-client-boot-cd",width=400]

Choose 'Start opsi (English)'. After a while, the following screen will appear. If your DHCP server gives IP-numbers to unknown DHCP clients, then most fields will already have valid values. You have to complete the missing data. You must at least give the hostname.

.bootimage/boot-cd configuration screen
image::boot-cd-config.png["Screenshot: bootimage/boot-cd configuration screen",width=400]

Confirm with 'OK'.

.bootimage / boot-cd:  Choose how to create Client
image::boot-cd-select.png["Screenshot: bootimage / boot-cd:  Choose how to create Client",width=200]

Choose 'Admin account'. This means that the client should register himself at the {opsi-server}. This procedure must be authorized.

.bootimage / boot-cd: Authenticate as member of {opsiadmin} group
image::boot-cd-authent.png["Screenshot: bootimage / boot-cd: Authenticate as member of {opsiadmin} group",width=400]

Therefore you will get a login window, where you should authenticate yourself as a member of the {opsiadmin} group. If the authorization is successful, then the client gives its data to the server, at which point the client will be created at the server. In the next step, the server provides a list of Netboot products to the client.

.bootimage / boot-cd: netboot product list
image::boot-cd-product.png["Screenshot: bootimage / boot-cd: netboot product list",width=200]

Now you may choose the operating system that you would like to install (or e.g. hwinvent for testing).

[[opsi-getting-started-firststeps-osinstall-fill-base-packages]]
==== OS-Installation: Complete the Base Package for Windows

The opsi OS-packages contain only the files that are necessary to perform our automated OS installation, but not the operating system software itself (Windows Operating Systems).

If you want to make use of fully automated OS installations of {client-os}}, you have to complete these packages as described below.

[[opsi-getting-started-firststeps-osinstall-fill-base-packages-nt6]]
==== NT 6 family: Win10 / Win8.1 / Win7 / 2008R2

In order to perform an OS Installation, a so-called WinPE is being used as a 'Live OS'. You can create it using an opsi package (ADK 8.1,10), or do it all yourself manually following the steps described.
Generally speaking, the Windows- Version of the PE does not matter with regard to the Windows OS version being installed. Still, working drivers should be present for at least disk and network devices.
Microsoft recommends 32-Bit PE for x86 installations , and 64-Bit PE for x64 installations.

'"To install a 64-bit version of Windows you must use a 64-bit version of Windows PE. Likewise, to install a 32-bit version of Windows, you must use a 32-bit version of Windows PE."' +
http://technet.microsoft.com/en-us/library/cc766093.aspx

Regardless of how you want to make your PE, you'll need an "Assessment and Deployment Kit" (ADK, Win8.1 bzw 10), or its predecessor "Windows Automated Installation Kit" (Windows AIK; bis Windows 7), and installing it on a supported Windows OS (use x64): +

ADK Windows 8: http://msdn.microsoft.com/en-us/library/windows/hardware/br259106.aspx +
ADK Windows 10: https://msdn.microsoft.com/en-us/library/windows/hardware/dn914754%28v=vs.85%29.aspx
It's sufficient to install 'Windows Preinstallation Environment (Windows PE)' and the dependencies automatically selected. Stick with the suggested install path in `Program Files (x86)`. +
WAIK Windows 7: http://www.microsoft.com/downloads/details.aspx?displaylang=en&FamilyID=696dd665-9f76-4177-a811-39c26d3b3b34
This site provides you with an ISO file, which may then be burnt to a CD or mounted. The content of this CD must be installed in an OS mentioned in the previous system requirements.

[[opsi-getting-started-firststeps-osinstall-fill-base-packages-nt6-pe]]
===== Creating a PE

The easiest available method for tweaking your PE requires a computer that has opsi-client-agent installed, as well as a Windows ADK (Win8.1,Win10).
Doing all steps manually is being described below <<opsi-getting-started-firststeps-osinstall-fill-base-packages-nt6-pe-manual>>.

[[opsi-getting-started-firststeps-osinstall-fill-base-packages-nt6-pe-opsi]]
===== Creating a PE using opsi

* Set the localboot- produkt `opsi-winpe` to `once` for the client you intend to use, if desired adjust the produkt properties to `x86` instead of `x64` at the lower right side, and save (right click > save)
* (in case the opsi-product `opsi-winpe` is missing, install it onto your opsi server via CLI `opsi-product-updater -i -p opsi-winpe -vv` )
* launch an installation event for the client (right click > on-demand , or reboot)
* after successful run of this action move or copy the contents of the now existing folder on your client C:\winpe_<ARCH>\media\ into the folder (already existing) within the OS folder you want to use at `\\opsiserver\opsi_depot_rw\<OS>\winpe\`
* finally run the CLI command on your new opsi server. Done.
[source,prompt]
----
opsi-setup --set-rights
----

[[opsi-getting-started-firststeps-osinstall-fill-base-packages-nt6-pe-manual]]
===== Manually Creating a PE

Here is how to manually tweak a PE. The console commands are very similar in 32- or 64-bit versions, except for the *<ARCH>* entries. These have to be set to either *x86* , *amd64* or *ia64*.

===== Tweaking a WinPE (WAIK / Windows 7)

Start a terminal as Administrator with elevated rights (Start => Programs => Accessories => right click on "Command Prompt" => "Run as" => Administrator)

* Copy the WinPE
[source,prompt]
----
"%ProgramFiles%\Windows AIK\Tools\PETools\copype.cmd" <ARCH> C:\winpe
----

* Mount Image: +
[source,prompt]
----
"%ProgramFiles%\Windows AIK\Tools\<ARCH>\imagex.exe" /mountrw "C:\winpe\winpe.wim" 1 "C:\winpe\mount"
----

* replace startnet.cmd
[source,prompt]
----
echo c:\opsi\startnet.cmd > "C:\winpe\mount\Windows\System32\startnet.cmd"
----
(Remark: The file `startnet.cmd` will be created by the opsi linux boot image after the script `setup.py` is executed. The `startnet.cmd` contains the call to wpeinit.)

* Unmount the Image
[source,prompt]
----
"%ProgramFiles%\Windows AIK\Tools\<ARCH>\imagex.exe" /commit /unmount "C:\winpe\mount"
----

* Move the WinPE now. From the target dir more files will be moved to the server.
[source,prompt]
----
move "C:\winpe\winpe.wim" "C:\winpe\ISO\sources\boot.wim"
----

* Copy the contents of `C:\winpe\ISO` to `/var/lib/opsi/depot/win7/winpe` (or `/var/lib/opsi/depot/win2008/winpe`). +
Adjust the file access rights by entering e.g.:
[source,prompt]
----
opsi-setup --set-rights /var/lib/opsi/depot/<productid>/winpe
----

===== Tweaking a WinPE (ADK / Windows 8/10)

run Start > "Windows Kits" > "Windows ADK" > "Deployment and Imaging Toolkits Environment" from the Start Menu. You will see a command prompt, but with some enironment variables set.

* Copy the WinPE
[source,prompt]
----
copype.cmd <ARCH> C:\winpe
----

* Mount the Image
[source,prompt]
----
dism /Mount-Wim /WimFile:C:\winpe\media\sources\boot.wim /index:1 /MountDir:c:\winpe\mount
----

* replace startnet.cmd
[source,prompt]
----
echo c:\opsi\startnet.cmd > "C:\winpe\mount\Windows\System32\startnet.cmd"
----
(Remark: The file `startnet.cmd` will be created by the opsi linux boot image after the script `setup.py` is executed. The `startnet.cmd` contains the call to wpeinit.)

* Unmount the Image
[source,prompt]
----
dism /Unmount-Wim /MountDir:c:\winpe\mount /Commit
----

* Copy the contents of `C:\winpe\media` to `/var/lib/opsi/depot/<productid>/winpe` . +
Adjust the file access rights by entering:
[source,prompt]
----
opsi-setup --set-rights /var/lib/opsi/depot/<productid>/winpe
----

[[opsi-getting-started-firststeps-osinstall-fill-base-packages-nt6-extendpe]]
===== Extending a PE

In some cases it is useful to extend a PE. Especially when using Dell-Hardware. Dell provides special network and storage drivers for use in PE. These instructions only work with Windows 7. (Windows Vista does not inherit the needed DISM- Deployment Image Servicing and Management.) These instructions assume that you have already completed the chapter "Creating a PE".

NOTE: The Windows Automated Installation Kit is not needed for following instructions.

The first step is to download Dell-PE-drivers from the Dell-Website. For Windows 7, you will need the WINPE 3.0 Drivers from Dell. The downloaded CAB-File must be extracted to the local disk. This can be done with 7zip or the command-line-tool Expand.exe. For simplicity, we recommend creating a directory called "dell-driver" on the local disk, and then extracting the CAB-File into this directory.

* Use dism to scan the image, in order to determine the required index number. Normally a PE-image is a one-image-file, so you can use the index 1, but it is better to check at first. Start a terminal as administrator (Start => Programs => Accessories => right click on "Command Prompt" => "Run as" => (Administrator) and run the following command:
[source,prompt]
----
dism /Get-WimInfo /WimFile:C:\winpe\ISO\sources\boot.wim
----

In the output of this command, you can see which images are included in the image file.

* The next command mounts the image for modification:
[source,prompt]
----
dism /Mount-Wim /WimFile:C:\winpe\ISO\sources\boot.wim /index:1 /MountDir:c:\winpe\mount
----

* To integrate the extracted drivers into the mounted image, you need to execute this command:
[source,prompt]
----
dism /Image:C:\winpe\mount /Add-Driver /Driver:c:\dell-driver\winpe\x64 /Recurse
----

If the architecture is 32Bit, the `x64` must be replaced with `x86`. The Driver-CAB from Dell inherits drivers for both architectures.

NOTE: If only one driver has to be integrated, then leave out the option `/Recurse`, and point directly to the driver-inf-File instead of the driver-directory. With the option `/ForceUnsigned` it is possible to integrate unsigned drivers to the image.

* For the changes to be committed, the images must be unmounted:
[source,prompt]
----
dism /Unmount-Wim /MountDir:c:\winpe\mount /Commit
----

* Copy the directory `C:\winpe\ISO` with the target name `winpe` to `/var/lib/opsi/depot/win7/` (or `/var/lib/opsi/depot/win2008`). +
Adjust the file access rights by entering(e.g.):
[source,prompt]
----
opsi-setup --set-rights /var/lib/opsi/depot/win7/winpe
----

[[opsi-getting-started-firststeps-osinstall-fill-base-packages-nt6-unattend]]
===== unattend.xml

The control file for the unattended installation is the XML file `unattend.xml`, which you can find under `/var/lib/opsi/depot/win7/custom`. If you would like to make any modifications to this file, then do it in this directory and not in the opsi directory.

The file `unattend.xml` that comes with the opsi package, contains the activating of the Administrator account with the password 'nt123'.

Documentation of the file `unattend.xml` can be found (after the installing WAIK) in the directory `c:\Program Files\Windows\Waik\docs\chms`.

[[opsi-getting-started-firststeps-osinstall-fill-base-packages-nt6-drivers]]
===== Driver Integration

The integration of drivers works in the usual way described in the opsi manual: Place your driver directories in `/var/lib/opsi/depot/win7/drivers/drivers` and then call the `create_driver_links.py` script.

Please keep in mind that Vista/Win7 only accept signed drivers. Therefore, if you want to use driver packs like the driver packs from driverpacks.net, be sure to use only the Vista/Win7 versions.

[[opsi-getting-started-firststeps-osinstall-fill-base-packages-nt6-installfiles]]
===== Providing the Installation Files

Copy the complete installation DVD to +
`/var/lib/opsi/depot/win7/installfiles`
Adjust the file access rights by entering:
[source,prompt]
----
opsi-setup --set-rights /var/lib/opsi/depot/win7/installfiles
----

[[opsi-getting-started-firststeps-osinstall-fill-base-packages-nt6-logfiles]]
===== Installation Log files

* `c:\Windows\Panther\setupact.log`: +
Logs until the end of setup phase 4 (running under WinPE)

* `c:\Windows\Panther\setupact.err`: +
Error log including the end of setup phase 4 (running under WinPE)

* `c:\Windows\Panther\UnattendGC\setupact.log`: +
Logs a specialize phase

* `c:\Windows\Panther\UnattendGC\setupact.err`: +
Error log for a specialize phase

* `c:\Windows\System32\Winevt\Logs\*`

* `c:\Windows\ntbtlog.txt` (only when the startup protocol is activated)

[[opsi-getting-started-firststeps-osinstall-productkey]]
==== Windows Product Key

If you are using the opsi license management module, then you may administrate your Windows product keys using the license management software. Information on how to do this can be found in the opsi manual.

If you don't want to use the license management module, then the product key can simply be made up using the product properties.

While creating a client, you can use the opsi management interface to enter the product key:

* choose a client
* change to the tab 'nettboot products'
* select the product (e.g. {opsi-client-os})
* change to the product property 'productkey' (on the right lower corner of the opsi management interface)
* type in your key
* leave the input field and save the changes

A other possibility is to use the command line. While working with an opsi server, you can read and/or change the server defaults.
To read the server default use (you may need to modify the productId and you must change '<opsiserver.domain.local>' with the fqdn from your opsiserver. Be sure that you enter the commands in one line):
[source,prompt]
----
opsi-admin -d method productPropertyState_getObjects [] '{"productId":"win10-x64","objectId":"opsiserver.domain.local"}'
----

The easiest way to modify the defaults, is to modify the file, and then update the objects with the modified file.

The first step would be to view the contents of an actual configuration file (you may need to modify the productId and you must change '<opsiserver.domain.local>' with the fqdn from your opsiserver. Be sure that you enter the commands in one line):
[source,prompt]
----
opsi-admin -d method productPropertyState_getObjects [] '{"productId":"win10-x64","objectId":"opsiserver.domain.local"}' > /tmp/property_config.json
----

The second step would be to modify the file `/tmp/property_config.json`, and change the entries and values. Finally, you must update the objects using this modified file (enter this command in one line):
[source,prompt]
----
opsi-admin -d method productPropertyState_updateObjects < /tmp/property_config.json
----

You can check that the modifications were successful using the following command (you may need to modify the productId and you must change '<opsiserver.domain.local>' with the fqdn from your opsiserver. Be sure that you enter the commands in one line):
[source,prompt]
----
opsi-admin -d method productPropertyState_getObjects [] '{"productId":"win10-x64","objectId":"opsiserver.domain.local"}'
----

[[opsi-getting-started-firststeps-osinstall-start]]
==== Start the Windows Installation

To start a windows installation:

* choose a client

* change to the tab 'netboot products'

* select the product (e.g. {opsi-client-os})

* set the 'action request' to 'setup'

* save the changes by clicking the red check mark (which then changes to green)

Now the client should load the {opsi-linux-bootimage} via the network and start it up. Before the Windows installation starts, you might have to confirm.

CAUTION: This refers to clients with a hard drive larger than 2 terabyte. On a non UEFI-system the possible largest partition size is 2 terabyte. When you have a larger partiton scheme the installation will fail. This is a technical restriction. You have to configure the system partition with a maximal size of 2 terabyte and therefore configure two partitions. This can be done with the product-properties. On the other hand the UEFI-module bypasses this restriction by using another partition table.

[[opsi-getting-started-firststeps-osinstall-structure]]
==== Structure of the Unattended Installation Products

This chapter describes the Windows netboot products.

[[opsi-getting-started-firststeps-osinstall-structure-dirs]]
===== Directory Tree Overview

[source,configfile]
----
<productid>-
           |-i386/				NT5 only: Installations files
           |-installfiles/			NT6 only: Installations files
           |-winpe/				NT6 only
           |-opsi/				scripts and templates by opsi.org
           |  |-$oem$/					NT5 only: $oem$ according to MS
           |  |-postinst.d/				scripts after OS-install by opsi.org
           |  !-unattend.(txt/xml).template	  	Template by opsi.org
           |-custom/				scripts and templates by customer
           |  |-$oem$/					NT5 only: $oem$ according to MS by customer
           |  |-postinst.d/				scripts after OS-install by customer
           |  !-unattend.(txt/xml)			unattend.txt by customer
           |-drivers/				drivers directory
           |  |-drivers/			drivers directory
           |  |-pciids/				symbolic links to drivers
           |  |-vendors/			symbolic links to drivers
           |  |-classes/			symbolic links to drivers
           |  |-usbids/				symbolic links to drivers
           |  |-hdaudioids/			symbolic links to drivers
           |  |-pci.ids				PCI-IDs DB
           |  !-usb.ids				USB-IDs DB
           |-setup.py				installation script
           |-<productid>_<version>.control	meta data (only for info)
           |-<productid>.files		    	file list (created automatically)
           |-create_driver_links.py		driver management script
           |-show_drivers.py			driver management script
           |-download_driver_pack.py		driver management script
           !-extract_driver_pack.py		driver management script
----

[[opsi-getting-started-firststeps-osinstall-structure-files]]
===== File Descriptions

* `setup.py` +
This is the installation script which is executed by the boot image.

* `<productid>_<version>.control` +
Contains the meta data of the product as prepared from the package maintainer. These files are here for information purposes only. There will be no effect after changing these files.

* `<productid>.files` +
This file is created automatically and should not be changed.

* `create_driver_links.py` +
`show_drivers.py` +
`download_driver_pack.py` +
`extract_driver_pack.py` +
These are scripts for the simplified driver integration, which is described in its own chapter (<<opsi-getting-started-firststeps-osinstall-driverintegration,"Simplified driver integration for the automatic OS installation">>).

[[opsi-getting-started-firststeps-osinstall-structure-i386]]
===== Directory installfiles / winpe

* `installfiles` +
This directory contains the all files from the windows installation DVD (NT6 = Windows 7 and above).

* `winpe` +
From Windows 7, this directory contains a bootable winpe image among other files.

[[opsi-getting-started-firststeps-osinstall-structure-opsicustom]]
===== Directories opsi and custom

Both directories contain scripts and configuration files for the OS installation. During the installation process, the directories work together in such a way that they give the priority usage to the files in the custom directories.

The opsi directory contains files and templates that are maintained by opsi.org, and maybe replaced during the next update. So it's not a good idea to make specific (or customized) changes to these files in this location. Please use the custom directory for this purpose, because that directory is not subject to any changes by opsi.org.

The subdirectory `postinst.d` contains scripts which are executed after the OS installation is completed by the `postinst.cmd` program. These scripts are needed to install the opsi-client-agent, among other software. The scripts will be executed in alphabetic order. To make it easier to see the order in which the scripts will be executed, the name always starts with a 2 digit number (`10_dhcp.cmd`). If you want to make extensions, then please do so in the custom/postinst.d directory and start numbers between the 10, 20, 30 ,... (e.g. `13_myscript.cmd`). The starting numbers 10, 20, 30,... are reserved for use by opsi org / uib gmbh. The script `99_cleanup.cmd` is the last one and initiate a reboot.

[[opsi-getting-started-firststeps-osinstall-structure-drivers]]
===== Directory drivers

This directory is used for the integration of drivers and is described in the following chapter.

[[opsi-getting-started-firststeps-osinstall-driverintegration]]
==== Simplified Driver Integration during the Automatic Windows Installation

If a group of computers have drivers that are not part of the Windows default installation, it's best to put these computers into a pool and integrate their drivers during installation time.

Opsi supports the automatic integration of drivers into the installation, and therefore simplifies driver deployment. In this case, the drivers simply need to be place into the correct directory.  When the installation script is called it searches through these directories and creates a catalog. The boot image automatically uses this catalog to embed the correct drivers.  Opsi supports the automatic installation of standard drivers, USB drivers, HD audio drivers, and disk controller drivers (text-mode drivers).

In order for a driver to be immediately installed with the Windows installation, you must place the drivers on the server in a specific format. The drivers must be placed in the drivers directory, with the format '\*.inf' , where the file name describes the driver for the Windows setup program. The drivers in the 'setup.exe' or '*.zip' are not used here. If you have a computer that already has the drivers installed, then you can extract the appropriate drivers using the program 'double driver' (http://www.boozet.org/dd.htm).

There are many levels of driver integration:

* General driver packages

* Preferred drivers that belong to your hardware, but are not assigned to specific computers

* Drivers that will be manually assigned to computers

* Drivers that will be automatically assigned to the computers using the fields <vendor>/<model>

Below is a detailed discussion about how to include each of these drivers

[[opsi-getting-started-firststeps-osinstall-driverintegration-generaldrivers]]
===== General Driver Packages

When the hardware configuration is very heterogeneous, then it may be reasonable to work with general driver packages. +
General drivers can be placed under `./drivers/drivers`. +
You can find example of general driver packages here http://driverpacks.net/ . +
Download the appropriate driver package to a temporary directory, and then unpack the driver package using the opsi script extract_driver_pack.py as such:
[source,prompt]
----
./extract_driver_pack.py <path to the temporary directory with the compressed driverpacks>
----
This will unpack and store the drivers in the directory `./drivers/drivers/`. +
It may be the case that the drivers found by opsi in this location do not necessarily work with your hardware. +
For the drivers which are found in `./drivers/drivers/`, the driver will be matched to the corresponding hardware using the PCI IDs (i.e. USB- or HD_Audio-ID) in the description file, and then integrated into the Windows setup as needed.

[[opsi-getting-started-firststeps-osinstall-driverintegration-preferred]]
===== Preferred Drivers

In the case that you have to support special hardware, and you can find the additional drivers from the manufacturers, then use the following procedure to include them in the installation. +
Place the additional drivers in their own directory under: +
`./drivers/drivers/preferred`. +
(the naming and depth of the directory structure is not important).  Drivers that are found in the directory `./drivers/drivers/preferred` will be integrated into the Windows setup, assuming that opsi finds a suitable match to the drive hardware based off of the PCI IDs (i.e. USB or HD_Audo-ID) in the description file. +
Problems can occur when the same PCI ID of the drivers is found in `preferred`. In this case, a direct mapping of the drivers to the devices is needed.

[[opsi-getting-started-firststeps-osinstall-driverintegration-additional]]
===== Drivers that will be Manually Assigned to Computers

When installing additional drivers based on the PCI-IDs or USB-IDs, they should be installed under the directory `./drivers/drivers/additional` (where name and depth of the directory structure is not important).  You can map one or more drivers to a client using the Product-Property 'additional_drivers' and a list of driver directories under `./drivers/drivers/additional`.  The directories specified by 'additional_drivers' are searched recursively until all drivers are found.  This method can be used to make a specific directory based on the client type (i.e. dell-optiplex-815).

When a driver is found under the drivers directory that is specified by 'additional_drivers' and also matches the PCI identifier, then other drivers in `drivers/preferred` or `drivers/` will not be used.  Therefore the drivers under 'additional_drivers' add functionality that would not have been found with the normal drivers.  Also, the drivers that are manually bound to a client using 'additional_drivers' receive priority over other drivers ('additional_drivers' can be thought of as 'super-preferred').

[[opsi-getting-started-firststeps-osinstall-driverintegration-byaudit]]
===== Drivers that will be Automatically Assigned to the Computers using the Fields <vendor>/<model>

The previously described mechanisms that directly map drivers to devices is automated since the 4.0.2 Release 2 of opsi. The {opsi-linux-bootimage} will search the directory `./drivers/drivers/additional/byAudit` for a director name that matches the field 'Vendor' that was given in the Hardware Inventory. This 'Vendor' directory will be search for a 'Model' directory that corresponds to what is seen in Hardware Inventory.   If this directory is found, then it will be manually assigned to the product property 'additional_drivers'. +
The directory name 'byAudit' is case sensitive.  The directory names for 'Vendor' and 'Model' are not case sensitive ('Dell' and 'dELL' are treated the same way).

Since opsi 4.0.5 one can use {opsi-configed} for uploading the drivers Automatic driver upload (see opsi-manual "Automatic driver upload")

The {opsi-linux-bootimage} looks first for drivers in

* `<vendor>/<model> (<sku>)`
* If nothing is found as a first fallback at `<vendor>/<model>`
* If nothing is found then as second fallback at motherboard `<vendor>/<motherboard-model>`


[[opsi-getting-started-firststeps-osinstall-driverintegration-structure]]
===== Structure of the Driver Directory and Driver Files:

[source,configfile]
----
/var/
  !-lib/
     !-opsi/depot/
        !-<productid>/
           !-drivers
              |-classes/		(Links to driver device classes)
              |-hdaudioids/		(Links to HD-Audio drivers)
              |-pciids/			(Links to PCI-ID drivers)
              |-pci.ids			(PCI database)
              |-usbids/			(Links to USB-ID drivers)
              |-usb.ids			(USB database)
              |-vendors/		(Links to manufacturer drivers)
              !-drivers			(place for general driver packages)
                 |-additional/		(manually assigned drivers)
                    |-byAudit/		Model-specific drivers that
                       |-<vendor>		will be assigned by
                          |-<model>		the Hardware Inventory
                 |-buildin/		(data for the i386 version)
                 |-preferred/		(certified drivers)
                 |-exclude/		(excluded drivers)
                 !-mydriverpacks/	(example driver packages)
----

[[opsi-getting-started-firststeps-osinstall-driverintegration-processing]]
===== Processing of the Different Levels of Driver Integration

The top priority is given to drivers that are found using the property 'additional_drivers' or using the inventory data in `./drivers/drivers/additional/byAudit`.  Tests will be made during driver integration to determine which drivers are already installed on which hardware devices. When a driver is not found for a device, the following method will be used to search for drivers.

For devices that have drivers that were not listed in 'additional_drivers', opsi will search for, and integrate, an appropriate driver based off of the PCI ID (ie. USB-, HD_Audio-ID).

'Integration' of drivers means the following:

* The driver will be copied to the local hard drive at `c:\drv\<num>`.

* The Windows Setup will search for the driver sub-directory under `c:\drv\` , where the sub-directory name will be read from the unattended file in the root 'unattend' sub-directory.

[[opsi-getting-started-firststeps-osinstall-driverintegration-drivercheck]]
===== Driver Addition and Checking

After any changes in the directory `./drivers/drivers` have been made, call the following command from the Netboot Products root directory in order to set the permissions:
[source,prompt]
----
opsi-setup --set-rights ./drivers
----

Then call the script `./create_driver_links.py`.  The script searches through the directories under './drivers/drivers' and generates a list of links using PCI-IDs, USB-IDs, HD-Audio-IDs that enables hardware to know about drivers.  The script will use the drivers in the preferred directories.

The script `setup.py` examines the hardware of the installed computers and identifies the necessary drivers.  These will be copied to the disk and the file unattended.txt will be patched.  The script `create_driver_links.py` examines the NT5 products one at a time in the 'i386' tree and extracts the .inf files of the necessary drivers into 'windows_builtin'.  If you make a change to the i386 directory tree (i.e. after installing a service pack), then delete that directory and run `create_driver_links.py` again.  The recognized drivers for NT6 products are found in WinPE at 'windows_builtin'.

With the following command, one can see the hardware inventory for a client:
[source,prompt]
----
./show_drivers.py <clientname>
----
When this is command is called, it will show a selection for which drivers would be chosen for installation to the Bootimage via PCI-IDs, USB-IDs, HD-Audio-IDs, and 'additional_drivers' (or 'byAudit'),  and which hardware still has no driver.

Use the output of `show_drivers.py` to check and see which drivers need to be installed.

It could be that manufacturers include different drivers for different operating systems (i.e. Vista vs. Win7) or different configurations (ie. SATA vs. SATA RAID).  The `create_driver_links.py` cannot make this distinction.  If you think the wrong driver has been installed, then move the driver to the 'drivers/exclude' directory and then call `create_driver_links.py` again.  Drivers in the directory 'drivers/exclude' are not used during the integration.

Example output of a `show_drivers.py` call:

[source,opsifiles]
----
./show_drivers.py pcdummy

PCI-Devices
   [(StandardsystemgerÃ¤te), PCI Standard-PCI-zu-PCI-Bridge]
      No driver - device directory  /var/lib/opsi/depot/<productid>/drivers/pciids/1022/9602 not found
   [ATI Technologies Inc., Rage Fury Pro (Microsoft Corporation)]
      Using build-in windows driver
   [(Standard-IDE-ATA/ATAPI-Controller), Standard-Zweikanal-PCI-IDE-Controller]
      /var/lib/opsi/depot/<productid>/drivers/drivers/D/M/N/123
   [Realtek Semiconductor Corp., Realtek RTL8168C(P)/8111C(P) PCI-E Gigabit Ethernet NIC]
      /var/lib/opsi/depot/<productid>/drivers/drivers/preferred/realtek_gigabit_net_8111_8168b
   [IEEE 1394 OHCI-konformer Hostcontroller-Hersteller, OHCI-konformer IEEE 1394-Hostcontroller]
      No driver - device directory '/var/lib/opsi/depot/<productid>/drivers/pciids/197B/2380' not found
   [Advanced Micro Devices, Inc., AMD AHCI Compatible RAID Controller]
      /var/lib/opsi/depot/<productid>/drivers/drivers/preferred/ati_raid_sb7xx
   [(Standard-USB-Hostcontroller), Standard OpenHCD USB-Hostcontroller]
      No driver - device directory '/var/lib/opsi/depot/<productid>/drivers/pciids/1002/4397' not found
   [ATI Technologies Inc, ATI SMBus]
      /var/lib/opsi/depot/<productid>/drivers/drivers/preferred/ati_smbus

USB-Devices
   [(Standard-USB-Hostcontroller), USB-VerbundgerÃ¤t]
      /var/lib/opsi/depot/<productid>/drivers/drivers/preferred/brother_844x_pGerb
   [Microsoft, USB-DruckerunterstÃ¼tzung]
      /var/lib/opsi/depot/<productid>/drivers/drivers/preferred/brother_844x_pGerb

Additional drivers
   [ati_hdaudio_azalia]
     /var/lib/opsi/depot/<productid>/drivers/drivers/additional/ati_hdaudio_azalia
----

Example with  'additional_drivers':
[source,opsifiles]
----
 ./show_drivers.py e5800
Manually selected drivers (additional)
   [hp_e5800]
      [/var/lib/opsi/depot/<productid>/drivers/drivers/additional/hp_e5800/sp52852/Vista64/HDXHPAI3.inf]
      [/var/lib/opsi/depot/<productid>/drivers/drivers/additional/hp_e5800/sp52852/Vista64/HDX861A.inf]
      [/var/lib/opsi/depot/<productid>/drivers/drivers/additional/hp_e5800/sp52852/Vista64/HDXHPAI1.inf]
      [/var/lib/opsi/depot/<productid>/drivers/drivers/additional/hp_e5800/sp52852/Vista64/HDXCPC.inf]
      [/var/lib/opsi/depot/<productid>/drivers/drivers/additional/hp_e5800/sp52852/Vista64/HDXHPAI2.inf]
      [/var/lib/opsi/depot/<productid>/drivers/drivers/additional/hp_e5800/sp50134/autorun.inf]
      [/var/lib/opsi/depot/<productid>/drivers/drivers/additional/hp_e5800/sp50134/ibxHDMI/IntcDAud.inf]
      [/var/lib/opsi/depot/<productid>/drivers/drivers/additional/hp_e5800/sp50134/HDMI/IntcHdmi.inf]
      [/var/lib/opsi/depot/<productid>/drivers/drivers/additional/hp_e5800/sp50134/Graphics/kit24890.inf]
      [/var/lib/opsi/depot/<productid>/drivers/drivers/additional/hp_e5800/sp50134/IIPS/Impcd.inf]
      [/var/lib/opsi/depot/<productid>/drivers/drivers/additional/hp_e5800/sp54284/Realtek 64bit/hp64win7.inf]

PCI-Devices
   [8086:27C8]  Intel : Intel(R) N10/ICH7 Family USB Universal Host Controller - 27C8
      /var/lib/opsi/depot/<productid>/drivers/drivers/preferred/R293337/WIN7
   [8086:27DA]  Intel : Intel(R) N10/ICH7 Family SMBus Controller - 27DA
      /var/lib/opsi/depot/<productid>/drivers/drivers/preferred/R293337/WIN7
   [8086:27C9]  Intel : Intel(R) N10/ICH7 Family USB Universal Host Controller - 27C9
      /var/lib/opsi/depot/<productid>/drivers/drivers/preferred/R293337/WIN7
   [8086:27DF]  Intel : Intel(R) ICH7 Family Ultra ATA Storage Controllers - 27DF
      /var/lib/opsi/depot/<productid>/drivers/drivers/preferred/R293337/WIN7
   [8086:27CA]  Intel : Intel(R) N10/ICH7 Family USB Universal Host Controller - 27CA
      /var/lib/opsi/depot/<productid>/drivers/drivers/preferred/R293337/WIN7
   [8086:2E30]  Intel : Intel(R) 4 Series Chipset Processor to I/O Controller - 2E30
      /var/lib/opsi/depot/<productid>/drivers/drivers/not_preferred/x64/C/Intel/1
   [8086:27CB]  Intel : Intel(R) N10/ICH7 Family USB Universal Host Controller - 27CB
      /var/lib/opsi/depot/<productid>/drivers/drivers/preferred/R293337/WIN7
   [8086:2E32]  Intel Corporation : Intel(R) G41 Express Chipset
      Manually selected [hp_e5800] /var/lib/opsi/depot/<productid>/drivers/drivers/additional/hp_e5800/sp50134/Graphics
   [8086:27CC]  Intel : Intel(R) N10/ICH7 Family USB2 Enhanced Host Controller - 27CC
      /var/lib/opsi/depot/<productid>/drivers/drivers/preferred/R293337/WIN7
   [8086:244E]  Intel : Intel(R) 82801 PCI-BrÃ¼cke - 244E
      Using build-in windows driver
      This driver will not be integrated, because same device already integrated in: '/var/lib/opsi/depot/<productid>/drivers/drivers/not_preferred/x64/C/Intel/1/dmi_pci.inf'
   [8086:27D0]  Intel : Intel(R) N10/ICH7 Family PCI Express Root Port - 27D0
      /var/lib/opsi/depot/<productid>/drivers/drivers/preferred/R293337/WIN7
   [8086:27B8]  Intel : Intel(R) ICH7 Family LPC Interface Controller - 27B8
      /var/lib/opsi/depot/<productid>/drivers/drivers/preferred/R293337/WIN7
   [8086:27D2]  Intel : Intel(R) N10/ICH7 Family PCI Express Root Port - 27D2
      /var/lib/opsi/depot/<productid>/drivers/drivers/preferred/R293337/WIN7
   [8086:27C0]  Intel : Intel(R) N10/ICH7 Family Serial ATA Storage Controller - 27C0
      /var/lib/opsi/depot/<productid>/drivers/drivers/preferred/R293337/WIN7
   [8086:27D8]  Microsoft : High Definition Audio-Controller
      No driver - device directory '/var/lib/opsi/depot/<productid>/drivers/pciids/8086/27D8' not found
   [10EC:8136]  Realtek : Realtek RTL8102E/RTL8103E-Familie-PCI-E-Fast-Ethernet-NIC (NDIS 6.20)
      Manually selected [hp_e5800] /var/lib/opsi/depot/<productid>/drivers/drivers/additional/hp_e5800/sp54284/Realtek 64bit

USB-Devices
   [0461:0010]  (StandardsystemgerÃ¤te) : USB-EingabegerÃ¤t
      No driver - vendor directory '/var/lib/opsi/depot/<productid>/drivers/usbids/0461' not found
   [0461:4D20]  (StandardsystemgerÃ¤te) : USB-EingabegerÃ¤t
      No driver - vendor directory '/var/lib/opsi/depot/<productid>/drivers/usbids/0461' not found
   [058F:6366]  Kompatibles USB-SpeichergerÃ¤t : USB-MassenspeichergerÃ¤t
      No driver - vendor directory '/var/lib/opsi/depot/<productid>/drivers/usbids/058F' not found
   [0461:0010]  (Standard-USB-Hostcontroller) : USB-VerbundgerÃ¤t
      No driver - vendor directory '/var/lib/opsi/depot/<productid>/drivers/usbids/0461' not found

HD-Audio-Devices
   [10EC:0662]  Realtek High Definition Audio
      Manually selected [hp_e5800] /var/lib/opsi/depot/<productid>/drivers/drivers/additional/hp_e5800/sp52852/Vista64
----

Example with 'byAudit':
[source,opsifiles]
----
 ./show_drivers.py pctry5detlef
Manually selected drivers (additional)
   [/var/lib/opsi/depot/<productid>/drivers/drivers/additional/byAudit/nvidia/awrdacpi]
      [/var/lib/opsi/depot/<productid>/drivers/drivers/additional/byAudit/nvidia/awrdacpi/pctry5detlef/Display/Radeon X300-X550-X1050 Series Secondary (Microsoft Corporation - WDDM)/atiilhag.inf]
      [/var/lib/opsi/depot/<productid>/drivers/drivers/additional/byAudit/nvidia/awrdacpi/pctry5detlef/Display/Radeon X300-X550-X1050 Series (Microsoft Corporation - WDDM)/atiilhag.inf]
      [/var/lib/opsi/depot/<productid>/drivers/drivers/additional/byAudit/nvidia/awrdacpi/pctry5detlef/MEDIA/Realtek AC'97 Audio/oem21.inf]

PCI-Devices
   [1002:5B70]  ATI Technologies Inc. : Radeon X300/X550/X1050 Series Secondary (Microsoft Corporation - WDDM)
      Manually selected [/var/lib/opsi/depot/<productid>/drivers/drivers/additional/byAudit/nvidia/awrdacpi] /var/lib/opsi/depot/<productid>/drivers/drivers/additional/byAudit/nvidia/awrdacpi/pctry5detlef/Display/Radeon X300-X550-X1050 Series Secondary (Microsoft Corporation - WDDM)
      Multiple selected [/var/lib/opsi/depot/<productid>/drivers/drivers/additional/byAudit/nvidia/awrdacpi] /var/lib/opsi/depot/<productid>/drivers/drivers/additional/byAudit/nvidia/awrdacpi/pctry5detlef/Display/Radeon X300-X550-X1050 Series (Microsoft Corporation - WDDM)
   [10DE:0053]  (Standard-IDE-ATA/ATAPI-Controller) : Standard-Zweikanal-PCI-IDE-Controller
      No driver - device directory '/var/lib/opsi/depot/<productid>/drivers/pciids/10DE/0053' not found
   [10DE:005D]  (StandardsystemgerÃ¤te) : PCI Standard-PCI-zu-PCI-BrÃ¼cke
      No driver - device directory '/var/lib/opsi/depot/<productid>/drivers/pciids/10DE/005D' not found
   [1022:1100]  AMD : AMD HyperTransport(tm)-Konfiguration
      Using build-in windows driver
   [10DE:0054]  (Standard-IDE-ATA/ATAPI-Controller) : Standard-Zweikanal-PCI-IDE-Controller
      /var/lib/opsi/depot/<productid>/drivers/drivers/preferred/evb_potsdam_fsc__esprimo_p625/FTS_NVIDIASATAAHCIDRIVERVISTA64V103042MCP78__1026963/NVIDIA_SATA_AHCI_DRIVER_Vista64_V10.3.0.42_MCP78 (textmode capable)
   [1022:1101]  AMD : AMD-Adresszuordnungskonfiguration
      Using build-in windows driver
   [10DE:0055]  (Standard-IDE-ATA/ATAPI-Controller) : Standard-Zweikanal-PCI-IDE-Controller
      /var/lib/opsi/depot/<productid>/drivers/drivers/preferred/evb_potsdam_fsc__esprimo_p625/FTS_NVIDIASATAAHCIDRIVERVISTA64V103042MCP78__1026963/NVIDIA_SATA_AHCI_DRIVER_Vista64_V10.3.0.42_MCP78 (textmode capable)
   [1022:1102]  AMD : AMD DRAM und HyperTransport(tm)-Nachverfolgungsmoduskonfiguration
      Using build-in windows driver
   [10DE:0057]  NVIDIA : NVIDIA nForce-Netzwerkcontroller
      Using build-in windows driver
   [1022:1103]  AMD : Sonstige AMD-Konfiguration
      Using build-in windows driver
   [10DE:0059]  Realtek : Realtek AC'97 Audio
      Manually selected [/var/lib/opsi/depot/<productid>/drivers/drivers/additional/byAudit/nvidia/awrdacpi] /var/lib/opsi/depot/<productid>/drivers/drivers/additional/byAudit/nvidia/awrdacpi/pctry5detlef/MEDIA/Realtek AC'97 Audio
   [10DE:005E]  NVIDIA : NVIDIA nForce4 HyperTransport-BrÃ¼cke
      /var/lib/opsi/depot/<productid>/drivers/drivers/preferred/ga-ma78-pcbon4/chipset_win7-64/SMBUS
   [104C:8025]  Texas Instruments : OHCI-konformer Texas Instruments 1394-Hostcontroller
      No driver - device directory '/var/lib/opsi/depot/<productid>/drivers/pciids/104C/8025' not found
   [10DE:005A]  (Standard-USB-Hostcontroller) : Standard OpenHCD USB-Hostcontroller
      No driver - device directory '/var/lib/opsi/depot/<productid>/drivers/pciids/10DE/005A' not found
   [10DE:0050]  (StandardsystemgerÃ¤te) : PCI Standard-ISA-BrÃ¼cke
      No driver - device directory '/var/lib/opsi/depot/<productid>/drivers/pciids/10DE/0050' not found
   [10DE:005B]  (Standard-USB-Hostcontroller) : Standard PCI-zu-USB erweiterter Hostcontroller
      No driver - device directory '/var/lib/opsi/depot/<productid>/drivers/pciids/10DE/005B' not found
   [1002:5B60]  ATI Technologies Inc. : Radeon X300/X550/X1050 Series (Microsoft Corporation - WDDM)
      Manually selected [/var/lib/opsi/depot/<productid>/drivers/drivers/additional/byAudit/nvidia/awrdacpi] /var/lib/opsi/depot/<productid>/drivers/drivers/additional/byAudit/nvidia/awrdacpi/pctry5detlef/Display/Radeon X300-X550-X1050 Series Secondary (Microsoft Corporation - WDDM)
      Multiple selected [/var/lib/opsi/depot/<productid>/drivers/drivers/additional/byAudit/nvidia/awrdacpi] /var/lib/opsi/depot/<productid>/drivers/drivers/additional/byAudit/nvidia/awrdacpi/pctry5detlef/Display/Radeon X300-X550-X1050 Series (Microsoft Corporation - WDDM)
   [10DE:0052]  NVIDIA : NVIDIA nForce PCI-Systemverwaltung
      Using build-in windows driver
   [10DE:005C]  (StandardsystemgerÃ¤te) : PCI Standard-PCI-zu-PCI-BrÃ¼cke
      No driver - device directory '/var/lib/opsi/depot/<productid>/drivers/pciids/10DE/005C' not found

USB-Devices
   [1241:1111]  (StandardsystemgerÃ¤te) : USB-EingabegerÃ¤t
      No driver - vendor directory '/var/lib/opsi/depot/<productid>/drivers/usbids/1241' not found

HD-Audio-Devices
   No devices installed
----

TIPS::
* Directory names `NDIS1` contain Vista-Drivers ; `NDIS2` contain Win7-Driver

* Some chip drivers contain description files, which specify hardware without actually providing drivers. An example would be the `cougar.inf` or `ibexahci.inf` from Intel. If such a 'Pseudo-Driver' were to be placed in 'additional_drivers' (or 'byAudit'), then the other drivers in the 'preferred' subdirectory may be excluded.  It is better to move these directories to the 'preferred' subdirectory.

* SATA drivers and SATA-RAID drivers refer to the same PCI ID. A SATA-RAID driver will not function with a single-disk system.

* Check the output of `./show_drivers.py` carefully !

[[opsi-getting-started-softwintegration]]
== Integration of New Software Packages into the opsi Server

The primary objective of software distribution is to accomplish automatic software installation without user interaction. Software installation and user activity should be strictly separated. In most cases, the installation process requires administrative privileges which the user usually doesn't have. So the installation process has to be done independently from the user. This way, the user can neither interfere nor be affected by the software installation process.

In order to do this, you have to write a script for the script driven installer, which is called an '{opsi-winst}' script.

[[opsi-getting-started-softwintegration-tutorial]]
=== A Brief Tutorial: How to write a {opsi-winst} Script

[[opsi-getting-started-softwintegration-tutorial-introduction]]
==== Introduction

This tutorial merely helps you getting started with opsi. It can't replace professional training (which you may order through uib), or thoroughly studying the complete opsi manuals (which might be time consuming and partially error prone if you lack background knowledge).
uib now offers training in English, too.

.Training and Support:

Get Training by uib gmbh in Europe or possibly Northern America: +
http://uib.de/en/support-training/support/

.Manuals:

The opsi Manuals can be found at:
http://uib.de/en/opsi-documentation/documentation/
important for scripting: +
opsi-winst reference card and opsi-winst manual

.Wiki (Scripts, Tips, Links):

http://forum.opsi.org/wiki

.Support Forum (fast and free vendor support):
http://forum.opsi.org

[[opsi-getting-started-softwintegration-tutorial-general]]
==== Methods of Non-Interactive Installation

Regardless of whether or not you are using opsi or another management product, there are three different ways to install software without user interaction:

. *Unattended or Silent Installation* +
The original setup programs from the software manufacturer can be executed from within a {opsi-winst} script in 'silent' or 'unattended' mode. It depends on whether or not the program supports a silent installation mode. A special case of this method is the unattended installation of MSI packages.

. *Interactive Setup with recorded Answers* +
The answers provided by the opsi administrator, while running the manufacturer's setup program during a pre-installation, can be automatically saved using the free tool 'Autoit' or Autohotkey. That requires providing an autoIt script for an unattended installation.

. *Analyze and Repackaging* +
The standard setup can be analyzed and 'recorded' by Windows to do the installation tasks by the '{opsi-winst}' program. Usually that is something like file installation to the local file system, followed by patching the registry

NOTE: opsi supports all of these variants. +
Usually a combination of all three different methods in one script provides the best result. For example, performing the basic installation using the original setup if available, and then doing some customizing by patching the registry or the file based configuration.


[[opsi-getting-started-softwintegration-tutorial-script-structure]]
==== Structure of a opsi-script / opsi-winst Script

An example of a simpleopsi-winst script:
[source,winst]
----
[Actions]
WinBatch_tightvnc_silent_install

[WinBatch_tightvnc_silent_install]
"%ScriptPath%\tightvnc-1.3.9-setup.exe" /silent
----

An opsi-winst script contains a *primary* and a *secondary* section. The section headers are in square brackets, similar to what you may have seen in ini-files. The primary section is noted by the identifier [Actions], and the secondary section is noted by the identifier [WinBatch_...].

The core work, like starting programs or copying files, is done in the secondary sections, not in the primary sections. These secondary sections are topic specific, and have a specific syntax that relates to their specific topic.

The name of a secondary section starts with a reserved word for that type of secondary section followed by a free identifier.

In the above example, the primary section +[Actions]+ calls a secondary section +[WinBatch_tightvnc_silent_install]+. +
This secondary section has the type +WinBatch+. The content of the secondary sections, of type 'WinBatch', are executed by the Windows API. In this case, the program `tightvnc-1.3.9-setup.exe` will be started with the parameter +/silent+.

[[opsi-getting-started-softwintegration-tutorial-primary-sections]]
==== Primary Sections

Initial::
The Initial section is used to set runtime parameters. +
This section is optional.

Actions::
The section +[Actions]+ is the main program. +
Any part of the code that is called more then one time can be placed in sub sections.

Sub-sections::
Primary sections which may be called multiple times or have their code in external files.

The primary sections are the main program which control the program flow. There you will find:

* Variables: strings and string lists
* if else endif statements
* for loops that traverse string lists
* Functions

.double code for deinstallation
image::opsi-winst-without-delsub.png["example of repetitive code (for deinstallation)",width=300]

.avoid double code by using sub sections
image::opsi-winst-with-delsub.png["avoid repetitive code by using sub sections",width=300]

[[opsi-getting-started-softwintegration-tutorial-secondary-sections]]
==== Important Kinds of Secondary Sections

Files::
File operations include

* copying (regarding the internal version information, recursive, ...)
* deleting files or directories
* creating directories

WinBatch::
It's used for calling programs using the Windows API. For example, WinBatch calls the setup programs in the silent mode.

DosBatch/DosInAnIcon::
The content of these sections are interpreted by the `cmd.exe` like normal batch files. +
A variant of 'DosBatch' is 'DosInAnIcon' which is run in a minimized window.

ExecWith::
A program is given as a parameter, and then that program interprets the content of this section (e.g. AutoIt).

Registry::
The 'Registry' sections are used for registry manipulations.

Linkfolder::
Link folder sections are used for the manipulation of start menus and desktop icons.

[[opsi-getting-started-softwintegration-tutorial-global-constants]]
==== Global Constants

Global constants are placeholders which can be used in primary and secondary sections. These placeholders are replaced by their values at runtime.

Examples:

+%ProgramFiles32Dir%+:: c:\program files
+%Systemroot%+::        c:\windows
+%System%+::            c:\windows\system32
+%Systemdrive%+::       c:\
+%Scriptpath%+::        <path to the running script>

[[opsi-getting-started-softwintegration-tutorial-second-example]]
==== Second Example: tightvnc

The following example shows a simple script that is used for a tightvnc installation. This script should contain only the winbatch call for the silent installation. If you call the sub-section silent installation more the one time, a confirmation window appears (which is a bug in the installer). This confirmation window will be closed by a 'autoit' script if it appears.

tightvnc.ins:
[source,winst]
----
[Actions]
Message "Install tightvnc 1.3.9 ..."
ExecWith_autoit_confirm "%ScriptPath%\autoit3.exe" WINST /letThemGo
WinBatch_tightvnc_silent_install
KillTask "autoit3.exe"

[WinBatch_tightvnc_silent_install]
"%ScriptPath%\tightvnc-1.3.9-setup.exe" /silent

[ExecWith_autoit_confirm]
; Wait for the confirm dialog which only appears if tightvnc was installed before as service
; Waiting for the window to appear
WinWait("Confirm")
; Activate (move focus to) window
WinActivate("Confirm")
; Choose answer no
Send("N")
----

[[opsi-getting-started-softwintegration-tutorial-elementary-commands]]
==== Elementary Commands for Primary Sections

[[opsi-getting-started-softwintegration-tutorial-elementary-commands-string-variable]]
===== String Variable

Declaration of a variable:: DefVar <variable name>

Setting a value:: Set <variable name> = <value>

Example:
[source,winst]
----
DefVar $ProductId$
Set $ProductId$ = "firefox"
----

IMPORTANT: The use of string variables is different in primary versus secondary sections. In the primary section, the string variables are handled as independent objects. String variables can only be declared and set to values in primary sections. Therefore you have to use a operator ('+') to concatenate variables and strings in a string expression. +
Example:`"Installing "+$ProductId$+" ..."` +
In secondary sections string variables are used as a placeholder for their values. +
Example: `"Installing $ProductId$ ..."` +
You should keep this in mind if you cut and paste string expressions between primary and secondary sections. +
The advantage of handling string variables in this format is that is possible to use these variables in secondary sections that are interpreted by other programs (DosBatch / Execwith).

[[opsi-getting-started-softwintegration-tutorial-elementary-commands-message]]
===== Message / showbitmap

Displaying text during runtime: +
`Message <string>`

Example:
[source,winst]
----
Message "Installing "+ $ProductId$ +" ..."
----

Displaying a picture during installation: +
`ShowBitMap [<file name>] [<sub title>]`

Example:
[source,winst]
----
ShowBitmap "%ScriptPath%\python.png" "Python"
----

[[opsi-getting-started-softwintegration-tutorial-elementary-commands-if-else-endif]]
===== if [else] endif

*Syntax:*
[source,winst]
----
if <condition>
	;statement(s)
[
else
	;statement(s)
]
endif
----

[[opsi-getting-started-softwintegration-tutorial-elementary-commands-functions]]
===== Functions

HasMinimumSpace:: Check for free space on the hard disk
FileExists:: Check for the existence of a file or directory

[[opsi-getting-started-softwintegration-tutorial-elementary-commands-error]]
===== Error, Logging and Comments

comment char ';':: Lines starting with the ';' char are simply ignored.
comment:: writes a comment to the log file
LogError:: writes error messages to the log file
isFatalError:: aborts the script, and return the installation state 'failed' to the server.

[[opsi-getting-started-softwintegration-tutorial-elementary-commands-requirements]]
===== Requirements

requiredWinstVersion:: Minimum required version of {opsi-winst}


[[opsi-getting-started-softwintegration-tutorial-template]]
==== Third example: The Generic Template 'opsi-template'

This third template should be used as a rough guide whenever you create your own opsi product. Do not cut-and-paste from this manual, but instead look at http://download.uib.de for a new version of the 'opsi-template' product package. Using the opsi-package-manager command you may install 'opsi-template' (-i) or extract (-x) at your server and then grab the scripts.

.setup32.opsiscript: installation script
[source,winst]
----
; Copyright (c) uib gmbh (www.uib.de)
; This sourcecode is owned by uib
; and published under the Terms of the General Public License.
; credits: http://www.opsi.org/en/credits/

[Actions]
requiredWinstVersion >= "4.11.4.6"
ScriptErrorMessages=off

DefVar $MsiId$
DefVar $UninstallProgram$
DefVar $LogDir$
DefVar $ProductId$
DefVar $MinimumSpace$
DefVar $InstallDir$
DefVar $ExitCode$
DefVar $LicenseRequired$
DefVar $LicenseKey$
DefVar $LicensePool$
DefVar $displayName32$
DefVar $displayName64$

DefStringlist $msilist$

Set $LogDir$ = "%opsiLogDir%"

; ----------------------------------------------------------------
; - Please edit the following values                             -
; ----------------------------------------------------------------
;$ProductId$ should be the name of the product in opsi
; therefore please: only lower letters, no umlauts,
; no white space use '-' as a separator
Set $ProductId$       = "opsi-template"
Set $MinimumSpace$    = "1 MB"
; the path where the product will be found after the installation
Set $InstallDir$      = "%ProgramFiles32Dir%\<path to the product>"
Set $LicenseRequired$ = "false"
Set $LicensePool$     = "p_" + $ProductId$
; ----------------------------------------------------------------

if not(HasMinimumSpace ("%SystemDrive%", $MinimumSpace$))
	LogError "Not enough space on %SystemDrive%, " + $MinimumSpace$ + " on drive %SystemDrive% needed for " + $ProductId$
	isFatalError "No Space"
	; Stop process and set installation status to failed
else
	comment "Show product picture"
	ShowBitmap "%ScriptPath%\" + $ProductId$ + ".png" $ProductId$

	if FileExists("%ScriptPath%\delsub32.opsiscript")
		comment "Start uninstall sub section"
		Sub "%ScriptPath%\delsub32.opsiscript"
	endif

	Message "Installing " + $ProductId$ + " ..."

	if $LicenseRequired$ = "true"
		comment "Licensing required, reserve license and get license key"
		Sub_get_licensekey
	endif

	comment "Start setup program"
	ChangeDirectory "%SCRIPTPATH%"
	Winbatch_install
	Sub_check_exitcode

	comment "Copy files"
	Files_install /32Bit

	comment "Patch Registry"
	Registry_install /32Bit

	comment "Create shortcuts"
	LinkFolder_install

endif

[Winbatch_install]
; Choose one of the following examples as basis for your installation
; You can use $LicenseKey$ var to pass a license key to the installer
;
; === Nullsoft Scriptable Install System ================================================================
; "%ScriptPath%\Setup.exe" /S
;
; === MSI package =======================================================================================
; You may use the parameter PIDKEY=$Licensekey$
; msiexec /i "%ScriptPath%\some.msi" /l* "$LogDir$\$ProductId$.install_log.txt" /qb-! ALLUSERS=1 REBOOT=ReallySuppress
;
; === InstallShield + MSI=====================================================================================
; Attention: The path to the log file should not contain any whitespaces
; "%ScriptPath%\setup.exe" /s /v" /l* $LogDir$\$ProductId$.install_log.txt /qb-! ALLUSERS=1 REBOOT=ReallySuppress"
; "%ScriptPath%\setup.exe" /s /v" /qb-! ALLUSERS=1 REBOOT=ReallySuppress"
;
; === InstallShield =====================================================================================
; Create setup.iss answer file by running: setup.exe /r /f1"c:\setup.iss"
; You may use an answer file by the parameter /f1"c:\setup.iss"
; "%ScriptPath%\setup.exe" /s /sms /f2"$LogDir$\$ProductId$.install_log.txt"
;
; === Inno Setup ========================================================================================
; http://unattended.sourceforge.net/InnoSetup_Switches_ExitCodes.html
; You may create setup answer file by: setup.exe /SAVEINF="filename"
; You may use an answer file by the parameter /LOADINF="filename"
; "%ScriptPath%\setup.exe" /sp- /silent /norestart /nocancel /SUPPRESSMSGBOXES

[Files_install]
; Example of recursively copying some files into the installation directory:
;
; copy -s "%ScriptPath%\files\*.*" "$InstallDir$"

[Registry_install]
; Example of setting some values of an registry key:
;
; openkey [HKEY_LOCAL_MACHINE\Software\$ProductId$]
; set "name1" = "some string value"
; set "name2" = REG_DWORD:0001
; set "name3" = REG_BINARY:00 af 99 cd

[LinkFolder_install]
; Example of deleting a folder from AllUsers startmenu:
;
; set_basefolder common_programs
; delete_subfolder $ProductId$
;
; Example of creating an shortcut to the installed exe in AllUsers startmenu:
;
; set_basefolder common_programs
; set_subfolder $ProductId$
;
; set_link
; 	name: $ProductId$
; 	target: <path to the program>
; 	parameters:
; 	working_dir: $InstallDir$
; 	icon_file:
; 	icon_index:
; end_link
;
; Example of creating an shortcut to the installed exe on AllUsers desktop:
;
; set_basefolder common_desktopdirectory
; set_subfolder ""
;
; set_link
; 	name: $ProductId$
; 	target: <path to the program>
; 	parameters: <some_param>
; 	working_dir: $InstallDir$
; 	icon_file: <path to icon file>
; 	icon_index: 2
; end_link

[Sub_get_licensekey]
if opsiLicenseManagementEnabled
	comment "License management is enabled and will be used"

	comment "Trying to get a license key"
	Set $LicenseKey$ = demandLicenseKey ($LicensePool$)
	; If there is an assignment of exactly one licensepool to the product the following call is possible:
	; Set $LicenseKey$ = demandLicenseKey ("", $ProductId$)
	;
	; If there is an assignment of a license pool to a windows software id, it is possible to use:
	; DefVar $WindowsSoftwareId$
	; $WindowsSoftwareId$ = "..."
	; Set $LicenseKey$ = demandLicenseKey ("", "", $WindowsSoftwareId$)

	DefVar $ServiceErrorClass$
	set $ServiceErrorClass$ = getLastServiceErrorClass
	comment "Error class: " + $ServiceErrorClass$

	if $ServiceErrorClass$ = "None"
		comment "Everything fine, we got the license key '" + $LicenseKey$ + "'"
	else
		if $ServiceErrorClass$ = "LicenseConfigurationError"
			LogError "Fatal: license configuration must be corrected"
			LogError getLastServiceErrorMessage
			isFatalError
		else
			if $ServiceErrorClass$ = "LicenseMissingError"
				LogError "Fatal: required license is not supplied"
				isFatalError
			endif
		endif
	endif
else
	LogError "Fatal: license required, but license management not enabled"
	isFatalError
endif


[Sub_check_exitcode]
comment "Test for installation success via exit code"
set $ExitCode$ = getLastExitCode
; informations to exit codes see
; http://msdn.microsoft.com/en-us/library/aa372835(VS.85).aspx
; http://msdn.microsoft.com/en-us/library/aa368542.aspx
if ($ExitCode$ = "0")
	comment "Looks good: setup program gives exitcode zero"
else
	comment "Setup program gives a exitcode unequal zero: " + $ExitCode$
	if ($ExitCode$ = "1605")
		comment "ERROR_UNKNOWN_PRODUCT	1605	This action is only valid for products that are currently installed."
		comment "Uninstall of a not installed product failed - no problem"
	else
		if ($ExitCode$ = "1641")
			comment "looks good: setup program gives exitcode 1641"
			comment "ERROR_SUCCESS_REBOOT_INITIATED	1641	The installer has initiated a restart. This message is indicative of a success."
		else
			if ($ExitCode$ = "3010")
				comment "looks good: setup program gives exitcode 3010"
				comment "ERROR_SUCCESS_REBOOT_REQUIRED	3010	A restart is required to complete the install. This message is indicative of a success."
			else
				logError "Fatal: Setup program gives an unknown exitcode unequal zero: " + $ExitCode$
				isFatalError
			endif
		endif
	endif
endif
----

.delsub32.opsiscript: external deinstallation sub section
[source,winst]
----
; Copyright (c) uib gmbh (www.uib.de)
; This sourcecode is owned by uib gmbh
; and published under the Terms of the General Public License.
; credits: http://www.opsi.org/en/credits/

Set $MsiId$ = '{XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX}'
Set $UninstallProgram$ = $InstallDir$ + "\uninstall.exe"

Message "Uninstalling " + $ProductId$ + " ..."

if FileExists($UninstallProgram$)
	comment "Uninstall program found, starting uninstall"
	Winbatch_uninstall
	sub_check_exitcode
endif
if not (GetRegistryStringValue32("[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\" + $MsiId$ + "] DisplayName") = "")
	comment "MSI id " + $MsiId$ + " found in registry, starting msiexec to uninstall"
	Winbatch_uninstall_msi
	sub_check_exitcode
endif

comment "Delete files"
Files_uninstall /32Bit

comment "Cleanup registry"
Registry_uninstall /32Bit

comment "Delete program shortcuts"
LinkFolder_uninstall

[Winbatch_uninstall]
; Choose one of the following examples as basis for program uninstall
;
; === Nullsoft Scriptable Install System ================================================================
; maybe better called as
; Winbatch_uninstall /WaitforProcessending "Au_.exe" /Timeoutseconds 10
; "$UninstallProgram$" /S
;
; === Inno Setup ========================================================================================
; "$UninstallProgram$" /silent /norestart /SUPPRESSMSGBOXES /nocancel

[Winbatch_uninstall_msi]
msiexec /x $MsiId$ /qb-! REBOOT=ReallySuppress

[Files_uninstall]
; Example for recursively deleting the installation directory:
;
; del -sf "$InstallDir$\"

[Registry_uninstall]
; Example of deleting a registry key:
;
; deletekey [HKEY_LOCAL_MACHINE\Software\$ProductId$]

[LinkFolder_uninstall]
; Example of deleting a folder from AllUsers startmenu:
;
; set_basefolder common_programs
; delete_subfolder $ProductId$
;
; Example of deleting a shortcut from AllUsers desktop:
;
; set_basefolder common_desktopdirectory
; set_subfolder ""
; delete_element $ProductId$

[Sub_check_exitcode]
;(.... see above .....)
----

.uninstall32.opsiscript: deinstallation script
[source,winst]
----
requiredWinstVersion >= "4.11.4.6"
ScriptErrorMessages=off

DefVar $MsiId$
DefVar $UninstallProgram$
DefVar $LogDir$
DefVar $ExitCode$
DefVar $ProductId$
DefVar $InstallDir$
DefVar $LicenseRequired$
DefVar $LicensePool$

Set $LogDir$ = "%opsiLogDir%"

; ----------------------------------------------------------------
; - Please edit the following values                             -
; ----------------------------------------------------------------
Set $ProductId$       = "opsi-template"
Set $InstallDir$      = "%ProgramFiles32Dir%\<path to the product>"
Set $LicenseRequired$ = "false"
Set $LicensePool$     = "p_" + $ProductId$
; ----------------------------------------------------------------


comment "Show product picture"
ShowBitmap "%ScriptPath%\" + $ProductId$ + ".png" $ProductId$

Message "Uninstalling " + $ProductId$ + " ..."

if FileExists("%ScriptPath%\delsub32.opsiscript")
	comment "Start uninstall sub section"
	Sub "%ScriptPath%\delsub32.opsiscript"
endif

if $LicenseRequired$ = "true"
	comment "Licensing required, free license used"
	Sub_free_license
endif

[Sub_free_license]
comment "License management is enabled and will be used"

comment "Trying to free license used for the product"
DefVar $result$
Set $result$ = FreeLicense($LicensePool$)
; If there is an assignment of a license pool to the product, it is possible to use
; Set $result$ = FreeLicense("", $ProductId$)
;
; If there is an assignment of a license pool to a windows software id, it is possible to use
; DefVar $WindowsSoftwareId$
; $WindowsSoftwareId$ = "..."
; set $result$ = FreeLicense("", "", $WindowsSoftwareId$)
----

[[opsi-getting-started-softwintegration-tutorial-create-and-test-script]]
==== Interactive Creation and Testing of a {opsi-winst} Script

It is possible to interactively adapt and test your own opsi-winst script using winst32.exe.

Start by creating a directory where you will build and test your script (e.g. `c:\test`), and then copy the template scripts from the opsi-template (`setup.ins`, `delsub.ins` und `uninstall.ins`) to this directory.

Start the {opsi-winst} (`winst32.exe`) program via a double mouse click. (On Windows 7 Clients, you must right-click on the mouse button and select "run as Administrator"). If the opsi-client-agent is installed on your computer you will find the {opsi-winst} at the directory `C:\program files\opsi.org\opsi-client-agent\opsi-winst. If the {opsi-client} agent is not installed you will find the {opsi-winst} at the share
'\\<opsiserver\opsi_depot_rw' in the directory `install\opsi-winst\files`.

After starting {opsi-winst}, you will see the following window:

.opsi-winst Started in Interactive Mode
image::winst-interactive["Screenshot: {opsi-winst} started in interactive mode",400]

* 'Select Script' is used to choose the script that you want to execute.
* 'Start' will start the execution of the selected script.
* 'View Log' is used to read the log file from the script that was run most recently.

Select the 'setup.ins' script and run it.

.{opsi-winst} log view window
image::winst-log-view.png["{opsi-winst} log view window",400]

* Look at the log file to see how {opsi-winst} interpreted the script.

* After figuring out which setup.exe that you will use to install software, copy setup.exe to the directory where the scripts are located (e.g. `c:\test`).

* Open the `setup.ins` script with a editor. You may use any text editor you like. We suggest the 'jEdit' with syntax highlighting for {opsi-winst} which is part of the essential {opsi-product}s.

.jEdit with a opsi script
image::jedit-with-winst-script.png["jEdit with a opsi script",400]

* You may now change the script using the editor. Save the changes (keep the editor open).

* Now switch to the {opsi-winst} and start the script again. (You don't have to reselect the script. Just press the 'start' button).

* Just have a look at the log again and see how the program flow changed according to your script changes.

* You can interactively develop a script until it fits your needs by performing these steps in this order: +
 - Change the script and save +
 - run the script +
 - review the log +


The next chapter contains some hints about handle any problems that may arise while building a opsi-winst script. <<opsi-getting-started-softwintegration-create-opsi-package-newprod>> describes how to create an {opsi-product} from your scripts, and how to install the products on the {opsi-server}.


[[opsi-getting-started-softwintegration-tutorial-template-details]]
==== Suggestions on How to Solve Problems with {opsi-winst} Scripts

[[opsi-getting-started-softwintegration-tutorial-find-switches]]
===== Search for Unattend or Silent Switches

For an unattended or silent setup, the original setup will be switched to an unattended non-interactive mode using the proper command line arguments.

The problem is to find the correct arguments

.Look on the internet:
Before you start integrating a new package, you'd better first have a look online to see if somebody has already done that job for you:

Ready to run {opsi-winst} scripts, built by the community, can be found at: +
https://forum.opsi.org/wiki/

A collection of links to web sites with switch collections can be found here +
http://www.opsi.org/en/software-integration-web-links

.Search the software producer's site:
Many software manufacturers are aware of the needs of unattended software distribution, so there are often some hints and instructions in the product documentation or on the software producer's website.

.Identify the manufacturer of the setup program:
Most setup programs are built using frameworks like 'Inno', 'NSIS', 'Installshield' or 'Wise'. Each one of these setup frameworks has their own switch.  The following method can be used to determine the framework and other necessary information:  The input strings can be determined using the command line program 'strings' given the setup program 'setup.exe', and the output framework names can be found using 'grep' or 'findstr'.

The Linux commands looks like this (change <mysetup.exe> to the name of your setup.exe):

[source,prompt]
----
strings <mysetup.exe> | grep -i -E "(inno|nsis|installshield|wise)"
----

Windows does not have a native `strings` command, so you will have to install it. You can download a `strings.exe` program from here: http://technet.microsoft.com/en-us/sysinternals/bb897439

To use this program, enter these commands at the command line interface (change <mysetup.exe> to the name of your setup.exe):
[source,prompt]
----
strings.exe <mysetup.exe> | findstr /i /r "inno installshield nsis wise"
----

The same method is used in the `opsi-setup-detector`.  See the example below:

.opsi setup detector
image::opsi-setup-detector.png[width="100mm"]

This GUI program can be called from the Windows context menu Explore.

.opsi setup detector in Windows Explore context menu
image::opsi-setup-detector-context-small-en.png[width="70mm"]

The 'opsi setup detector' is part of the 'opsi-adminutils' package.  The program can be downloaded as a stand-alone application from:

http://download.uib.de/opsi4.0/helper/opsisetupdetector.exe

At opsi.org, you can find a web link: +
http://www.opsi.org/en/software-integration-web-links +
to the section 'Installer specific switches', which has web links to the websites that give hints on how to detect the manufacturer of the setup program.

[[opsi-getting-started-softwintegration-tutorial-winst-commands]]
===== Some Important {opsi-winst} Commands

A short overview of the {opsi-winst} commands can be found in the reference card:
http://download.uib.de/opsi4.0/doc/opsi-winst-reference-card-en.pdf

All syntax details are described in the {opsi-winst} manual:
http://download.uib.de/opsi4.0/doc/winstdoc-en.pdf

Here are some hints regarding important methods:

.Stringlisten
String lists can be powerful tools to review the output from other programs. Read the {opsi-winst} manual for details.

.ExitWindows
* `ExitWindows /Reboot` +
Reboot after the script is finished

* `ExitWindows /ImmediateReboot` +
Reboot now

* `ExitWindows /ImmediateLogout`
Exit the {opsi-winst} now

.Product Properties
For some products it is important to know which product properties can modify the installation in order to make a client-specific installation. Creating these properties is described below in <<opsi-getting-started-softwintegration-create-opsi-package,"Creating an opsi package">>.

To evaluate these properties, {opsi-winst} provides the function `GetProductProperty`

[source,winst]
----
if GetProductProperty("example-property", "no") = "yes"
	Files_copy_extra_files
endif
----

[[opsi-getting-started-softwintegration-tutorial-opsiadmin]]
===== Installation When the User is Logged on

Before we begin, we assume that you have tried an unattended installation using an {opsi-winst} script, and the installation worked OK when the user had administrative privileges.
However with some software products, you will see that the installation fails when started from within the opsi deployment software (opsi-client-agent). A possible reason for that difference might be that the installation process requires knowledge about the user environment or profile.

In the case of a MSI package, the option 'ALLUSERS=1' might help.
Example:

[source,winst]
----
[Actions]
DefVar $MsiLogFile$
Set $MsiLogFile$ = %opsiLogDir% + "\myproduct.log"
winbatch_install_myproduct

[winbatch_install_myproduct]
msiexec /qb-! /l* $MsiLogFile$ /i "%ScriptPath%\files\myproduct.msi" ALLUSERS=1
----

Another possibility is that the installation starts a second process and stops before the second process is finished. So from the point of view of the {opsi-winst} script, the task is finished while in fact the second process is still working (installing / uninstalling). +
In this case, you may use the modifier +/WaitSeconds <seconds>+ , or
+/WaitForProcessEnding "program.exe" /TimeOutSeconds "<seconds>"+, in the WinBatch section so that the script waits for the end of the second process.

Another more complex way to solve the problem is to create a temporary administrative user account and use this account for the program installation. For a detailed description on how to do this, please refer to the {opsi-winst} manual chapter 8.3 'Script for installation in the context of a local administrator' and use the template 'opsi-template-with-admin'.

[[opsi-getting-started-softwintegration-tutorial-msi]]
===== Working with MSI-packages

With Windows 2000, Microsoft launched its own installation concept based on the Microsoft Installer Service "MSI". Since then, many setup programs have become MSI compliant.

To be MSI compliant means to provide a package with installation instructions for the MSI. Usually this is a file named 'product.msi'.

In practice, the setup.exe of a product contains a 'product.msi' file and an additional control program for the installation. The control program unpacks the 'product.msi' and pops up a window that asks if it is allowed to start the installation. If installation has been approved, then the control program checks whether or not MSI is installed, and if so passes 'product.msi' to MSI. If no MSI is found, then the control program tries to install MSI.

If you were to interrupt the installation at that point, you will often find the unpacked MSI-package in a temporary directory.

For example, this package can be used for an unattended installation with the statement:
[source,winst]
----
msiexec /i "%ScriptPath%\Product.msi" /qb-! ALLUSERS=1 REBOOT=ReallySuppress
----

[[opsi-getting-started-softwintegration-tutorial-customizing]]
===== Customization after a silent/unattended Installation

After a successful silent installation, some customizing might be useful. The {opsi-winst} is a powerful tool to do that job. First, find out what patches have to be applied. For example, that could mean analyzing which registry settings are affected by the GUI customizing tools.

You can use the tools shown in <<opsi-getting-started-softwintegration-tutorial-analyse-and-repackage>>. Some other tools can be found here:

http://www.sysinternals.com/ +
http://www.german-nlite.de/files/guides/regshot/regshot.html

[[opsi-getting-started-softwintegration-tutorial-autoit]]
===== Integration with Automated Answers for the setup Program

Another fast way of integration is to provide an automated answer file for the setup process. The answer file contains pre-defined answers.  To be more precise, the answer file is used by a control tool, which waits for the setup to come up with the interactive windows.  The control tool then passes input to these windows as defined in the answer file. As a control tool we recommend 'AutoIt'. The AutoIt program and the documentation can be found at: http://www.hiddensoft.com/autoit3.

AutoIt provides a lot of commands to control the setup process. Also, several error states can be handled (if known in advance) with the '[ADLIB]' section in the script.

There is, however, a fundamental challenge in using AutoIt: +
The AutoIt script must provide input for every window that might pop up during installation. So if any unexpected window pops up, which isn't handled in the [ADLIB] section, AutoIt provides no input for this window and the installation stops at that point while waiting for input. This input could be done interactively by a user, and then the script can take over again and handle the next windows.

Another situation that may cause failure of an AutoIt installation: +
The user can interfere with the installation if the mouse and keyboard are not disabled. Therefore we regard 'unattended' or 'silent' setup as a more stable solution.

A combination of both might do a good job: +
The 'silent'-setup does the main installation and the AutoIt script handles special conditions that might occur.

If you use the opsi option of running the installation on another desktop than the current desktop, or if the current desktop is locked, then you will find that some autoit functions do not work properly under these conditions.

Therefore you should avoid using the following autoit commands in '{opsi-winst}' scripts:

* winwait()

* winactivate()

* Send()

Because these commands are so widely used, we provide substitutes:
*winwait()* +
should be replaced by the function +
`opsiwinwait($title, $text, $maxseconds, $logname)` +
which is defined as:
[source,configfile]
----
Func opsiwinwait($title, $text, $maxseconds, $logname)
	Local $exists = 0
	Local $seconds = 0
	Local $mylog
	$mylog = FileOpen($logname, 1)
	While ($seconds <= $maxseconds) and ($exists = 0)
		$exists = WinExists($title , $text)
		FileWriteLine($mylog,"win: "  & $title & " ; " & $text & " exists result (1=exists): " & $exists )
		$seconds = $seconds + 1
		sleep(1000)
	WEnd
	FileClose($mylog)
EndFunc

----
The parameters are:

* `$title` the title of the window

* `$text` a part of the readable text in the window

* `$maxseconds` the timeout in seconds

* `$logname` the name of the log file


*Send()* +
should be replaced by the function +
`opsiControlClick($title, $text, $id, $maxseconds, $logname)` +
respectively by +
`opsiControlSetText($title, $text, $id,$sendtext, $maxseconds, $logname)` +
which are defined as:
[source,configfile]
----
Func opsiControlClick($title, $text, $id, $maxseconds, $logname)
	Local $result = 0
	Local $seconds = 0
	Local $mylog
	$mylog = FileOpen($logname, 1)
	While ($seconds <= $maxseconds) and ($result = 0)
		$result = ControlClick($title , $text,$id)
		FileWriteLine($mylog,"answer for " & $title & " ; " & $text & " id: " & $id & " sended: result (1=success) : " & $result)
		$seconds = $seconds + 1
		sleep(500)
	WEnd
	FileClose($mylog)
EndFunc

Func opsiControlSetText($title, $text, $id,$sendtext, $maxseconds, $logname)
	Local $result = 0
	Local $seconds = 0
	Local $mylog
	$mylog = FileOpen($logname, 1)
	While ($seconds <= $maxseconds) and ($result = 0)
		$result = ControlSetText ($title , $text,$id, $sendtext)
		FileWriteLine($mylog,"answer for " & $title & " ; " & $text & " id: " & $id & " set: " & $sendtext & " sended: result (1=success) : " & $result)
		$seconds = $seconds + 1
		sleep(500)
	WEnd
	FileClose($mylog)
EndFunc

----
The parameters are:

* `$title` the title of the window

* `$text` a part of the readable text in the window

* `$id` the numerical ControlId of the button or edit field

* `$sendtext` the text to insert to a edit field

* `$maxseconds` the timeout in seconds

* `$logname` the name of the log file

Therefore, you should use the program `Au3info.exe` to get the 'ControlId' needed by these commands. Please use the numerical 'ControlId', because the other variants do not seem to work properly:

Below is an example from a script. +
In this script we produce a log file from the autoit activities, which may be integrated in the '{opsi-winst}' log file with the following commands:
[source,winst]
----
includelog %opsiLogDir% + "\au3.log" "500"
----

Example:
[source,configfile]
----
[ExecWith_autoit_confirm]
Func opsiwinwait($title, $text, $maxseconds, $logname)
	Local $exists = 0
	Local $seconds = 0
	Local $mylog
	$mylog = FileOpen($logname, 1)
	While ($seconds <= $maxseconds) and ($exists = 0)
		$exists = WinExists($title , $text)
		FileWriteLine($mylog,"win: "  & $title & " ; " & $text & " exists result (1=exists): " & $exists )
		$seconds = $seconds + 1
		sleep(1000)
	WEnd
	FileClose($mylog)
EndFunc

Func opsiControlClick($title, $text, $id, $maxseconds, $logname)
	Local $result = 0
	Local $seconds = 0
	Local $mylog
	$mylog = FileOpen($logname, 1)
	While ($seconds <= $maxseconds) and ($result = 0)
		$result = ControlClick($title packet
	FileClose($mylog)
EndFunc

Func opsiControlSetText($title, $text, $id,$sendtext, $maxseconds, $logname)
	Local $result = 0
	Local $seconds = 0
	Local $mylog
	$mylog = FileOpen($logname, 1)
	While ($seconds <= $maxseconds) and ($result = 0)
		$result = ControlSetText ($title , $text,$id, $sendtext)
		FileWriteLine($mylog,"answer for " & $title & " ; " & $text & " id: " & $id & " set: " & $sendtext & " sended: result (1=success) : " & $result)
		$seconds = $seconds + 1
		sleep(500)
	WEnd
	FileClose($mylog)
EndFunc

; exact title match
Opt("WinTitleMatchMode", 3)
$mylog = FileOpen("%opsiLogDir%\au3.log", 2)
FileWriteLine($mylog,"auto-it started - waiting for the window")
FileClose($mylog)

opsiwinwait("InstallShield Wizard" , "Wollen Sie wirklich", 200, "%opsiLogDir%\au3.log")
	opsiControlClick("InstallShield Wizard" , "Wollen Sie wirklich", 6, 5, "%opsiLogDir%\au3.log")
opsiwinwait("InstallShield Wizard" , "Deinstallation ist abgeschlossen", 400, "%opsiLogDir%\au3.log")
	opsiControlClick("InstallShield Wizard" , "Deinstallation ist abgeschlossen", 1, 5, "%opsiLogDir%\au3.log")

Sleep(500)
;and good bye
Exit
----

see also: +
http://www.autoitscript.com/wiki/FAQ#Why_doesn.27t_my_script_work_on_a_locked_workstation.3F +
http://www.autoitscript.com/autoit3/docs/ +
http://www.autoitscript.com/autoit3/docs/intro/controls.htm +
http://www.autoitscript.com/autoit3/docs/functions.htm


[[opsi-getting-started-softwintegration-tutorial-analyse-and-repackage]]
===== Analyze and Repackage

When a software developer builds a setup for deployment, the developer usually knows about the required components of the software that have to be installed. But if somebody has a black box as a setup, then they need first to analyze what the setup does. This can be done by monitoring the setup activities with the appropriate tools (e.g. monitoring files and registry access) or by comparing the system states before and after installation.

To analyze the before or after states, there are several tools. For Example:

* 'WinINSTALL LE' which is currently not available as freeware: +
http://www.ondemandsoftware.com

* 'InstallWatch Pro' +
http://download.fyxm.net/download-now-InstallWatch-Pro-OS-OS-Info-83813.html

* 'appdeploy-repackager' +
http://www.itninja.com/media/downloads/appdeploy-repackager.msi



[[opsi-getting-started-softwintegration-tutorial-deinstall]]
===== How to uninstall Products

To uninstall a software product from a computer, you need an 'uninstall' script to perform the deletion. The fundamental difficulty in software deletion is deciding what exactly has to be removed. Not all of the files that came with a software package can be deleted afterwards. Sometimes a package comes with standard modules that are also referred to by other programs. Often only the software manufacturer himself knows what parts have to be removed. The manufacturer's setup might offer an unattended uninstall option which can be embedded in the opsi uninstall script. Otherwise {opsi-winst} provides several commands for software deletion:

.Using an uninstall routine
If the product manufacturer provides an option for software deletion, you must checked whether or not it can be run unattended (or in silent mode). If it requires some user interaction, an AutoIt script combined with the uninstall routine might do the job. The uninstall statement can be embedded in a [WinBatch] section of the {opsi-winst} script:
[source,winst]
----
[WinBatch_start_ThunderbirdUninstall]
"%SystemRoot%\UninstallThunderbird.exe" /ma
----

When using an uninstall program, always run a test to see if all of the files have been deleted and the computer is still in a stable state.

Products that are installed by MSI normally come with an uninstall option, which is usually the program `msiexec.exe` combined with the parameter `/x`. The parameter `/qb-!` is for the unattended mode (or without user interaction). So here is an example of an unattended uninstall command:

[source,winst]
----
msiexec.exe /x some.msi /qb-! REBOOT=ReallySuppress
----

Instead of the package name, you could also use the GUID (Global Unique ID) with `msiexec.exe`. This GUID identifies the product in the system, which can be found in the registry directory
'HKLM\Software\Microsoft\Windows\CurrentVersion\Uninstall'

A request using the GUID looks like this:
[source,winst]
----
msiexec.exe /x {003C5074-EB37-4A75-AC4B-F5394E08B4DD} /qb-!
----

If none of these methods are available or sufficient, the uninstall can be done using a {opsi-winst} script as described below:

.Useful {opsi-winst} commands for uninstall

If a product has been installed by {opsi-winst} functions, or if there is no uninstall routine for the product, the complete uninstall has to be done by a {opsi-winst} script. {opsi-winst} comes with some powerful uninstall functions. This chapter provides a brief overview of the uninstall functions, and more detailed information can be found in the {opsi-winst} handbook.

Basic uninstall means deleting one or more files from the file system. This command can be executed from a {opsi-winst} files section:
[source,winst]
----
delete -f <file name>
----

or to delete a directory including sub directories:

[source,winst]
----
delete -sf <dir name>\
----

The parameter 'f' means 'force' or to delete the files even if they are marked as 'read only' and the parameter 's' means including the 'subdirectories'. A file or directory can be deleted from all user profiles using the option '/AllNTUserProfiles' (see {opsi-winst} manual for details).

Directories containing files with the attribute 'hidden' or 'system' can be deleted by using a 'DosInAnIcon'-section:

[source,winst]
----
[DosInAnIcon_deleteDir]
rmdir /S /Q "<List>"
----

To stop a running process before deletion use the `killtask` command with the process' name (look at the task manager for process name):

[source,winst]
----
KillTask "thunderbird.exe"
----

If the product or part of it, runs as a service, you will have to stop the service before deleting the files. One way to do so, is to set the service state to inactive in the registry and restart the computer. Or to stop the service by using the command 'net stop', which doesn't need a reboot:
[source,winst]
----
net stop <servicename>
----

Deleting DLL files also requires special attention, since DLLs could also be used by other products. There is no general way of handling this.

To delete registry entries with {opsi-winst} you can use the command DeleteVar. This command deletes entries from the currently open key:

[source,winst]
----
DeleteVar <VarName>
----

To delete a registry key with all sub keys and registry variables, you can use the {opsi-winst} command DeleteKey:
[source,winst]
----
DeleteKey [HKLM\Software\Macromedia]
----


[[opsi-getting-started-softwintegration-tutorial-64bit]]
===== Known Issues with the 64 Bit Support

The opsi installer {opsi-winst} is a 32 bit program. There are no known problems when installing 32 bit software on a 64 bit system using {opsi-winst}. For the installation of 64 bit software, some constants (like '%ProgramFilesDir%') give wrong values.

New Versions of {opsi-winst} have special commands to handle these problems. So read the {opsi-winst} manual (http://download.uib.de/opsi4.0/doc/winstdoc-en.pdf) for these issues.


[[opsi-getting-started-softwintegration-create-opsi-package]]
=== Creating an opsi Package

In opsi, the new software is integrated into the system as a package. This package contains the installation files, the {opsi-winst} installation script, and any meta data.

The advantages of this format are essentially:

* Simplified menu driven handling using the program `opsi-newprod`.
* Holding all meta data in one file, which is easy to edit.
* Optional menu driven installation of the package, with optional default overriding.
* Information about the package will be saved; including product version, package version, and customer extensions. The package information is stored in the installation directory, and all the information can be seen in the package name and the opsi-configeditor. This means that different package versions can be easily handled (product life cycle management).
* For creating and unpacking products, no root privileges are required. Privileges of the group 'pcpatch' are sufficient.

The package itself is merely a Gzip compressed cpio archive. This archive includes three directories:

* `CLIENT_DATA` +
holds the files which are to be copied into the product directory (`/var/lib/opsi/depot/<productid>`).

* `OPSI` +
The file named `control` holds the product meta data (like the product dependencies). The files `preinst` and `postinst` will be executed before and after the installation. Any customer extensions might be added here.


[[opsi-getting-started-softwintegration-create-opsi-package-handling]]
==== Create, Pack, and Unpack a New Product

In order to create a new opsi package, you must login to the server and do some things at the command line. To be able to do this from windows you may use putty.exe:
(http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html).

The essential commands to create and install packages are:

* `opsi-newprod`
* `opsi-makeproductfile`
* `opsi-package-manager -i <{opsi-product}-file>`

The privileges of the group 'pcpatch' are required to create a new product.

Opsi makes use of parallel compression provided by `pigz` if installed. This requires a minimum version 2.2.3 or any higher version. If a sufficient version is installed, opsi will automatically use it for (de-)compression of products.
Please keep in mind that archives created by `gzip` or `pigz` can profit from the bandwidth preserving synchronization via `rsync` but they are not bit-compatible. This will become relevant if you have been using `gzip` before to create your packages and synchronized these packages to other depots. If you now use `pigz` for compression an sync, it will transmit more than the expected differences. This is the case for the first synchronization after a switch of the used compression program. Any further synchronization will then again only transmit the differences.
It is possible to explicitly disable the usage of `pigz` on your server by setting the value for `use_pigz` under the section `packages` in the file `/etc/opsi/opsi.conf` to `False` as shown below:

[source,configfile]
----
[packages]
use_pigz = False
----

You should create products in the directory `/home/opsiproducts`. This directory is also available as share on 'opsi_workbench'. The group 'pcpatch' has to be owner of the directory and the directory permissions are 2770 ('set group ID' bit is set for group pcpatch).

CAUTION: On distributions from the SUSE family this directory is located at `/var/lib/opsi/workbench`.

[[opsi-getting-started-softwintegration-create-opsi-package-newprod]]
===== Create with opsi-newprod

WARNING: Do not use any country-specific symbols (umlaut), since the actual country code might vary for different code tables.


To start creating a new product, change directories to the product directory, and start the creation of the new product by entering the command `opsi-newprod`. The next question will ask you about the type of product you want to create. Choose the type 'localboot' for products which should be installable by '{opsi-client-agent}'/'{opsi-winst}'. The product type 'netboot' is used for products which are activated as a bootimage (like OS installation)

.Choose the product type: localboot
image::newprod-localboot.png["Screenshot: Choose the product type: localboot",width=400]

Confirm your choice with tab (or F12). Next, fill in the basic product parameters. At the top of the window there is an explanation for the current input field.

.Input of the product information
image::newprod-product-info.png["Screenshot: Input of the product information",width=400]

Product Id:: is a distinct short name for the product, independent from the product version (we recommend to use only plain ASCII letters and '-', no white space, no special characters)

Product name:: is the full name of the product

Description:: is an additional description of the product.

Advice:: is some additional information on how to handle the product (a note).

Product version:: is the version of the packed software (max 32 chars).

Package Version:: is the version of the package for the product version. For example, this helps to distinguish between packages with the same product version but with modified '{opsi-winst}' scripts.

License required:: is only relevant to netboot products.

Priority:: controls the installation sequence. Possible Values are between 100 (at the very beginning) and -100 (at the end). Note: product dependencies also have influence on the installation sequence. See the opsi manual for more information.

After the product information is completed, fill in which action scripts should be provided:

.Input of the {opsi-winst} script names for different actions
image::newprod-script-names.png["Screenshot: Input of the {opsi-winst} script names for different actions",width=400]

After editing the product information you should mention the script you want to use for different activities.

Usually the *+Setup script+* is named `setup.ins`

Usually the *+Uninstall script+* is named `uninstall.ins`

An *+Update-Script+* will be used for minor changes on existing big installations. If this product is switched to the required action 'setup', then the update script will be automatically executed after the setup script.

An *+Always-Script+* will be executed at the beginning of every activity of '{opsi-client-agent}' (e.g. on every boot).

A *+Once-Script+* has the resulting state `not_installed`. It is a very special kind of script, and you should only use it if you really know what you are doing.

A *+Custom-Script+* doesn't change the resulting state.  It is a very special kind of script, and you should only use it if you really know what you are doing.

A *+userLoginScript+* is used to modify the user's profile after the user logs into the system. It only works with the opsi extension 'User Profile Management', which is described at the 'User Profile Management' chapter in the opsi-manual.


|=======================
| Type | resulting state | resulting action
| setup | installed | none
| uninstall | not_installed | none
| update | installed | none
| always | installed | always
| once | not_installed | none
| custom | _unchanged_ | _unchangend_
| User login | _unchanged_ | _unchanged_
|=======================

The next step is to define one or more product dependencies. If there are no product dependencies, select 'No'.

.Create product dependency: No/Yes
image::newprod-product-new-dependency.png["Screenshot: Create product dependency: No/Yes",width=400]

To create a product dependency, enter the following data (help is available at the top of the window):

Dependency for Action:: Which product action shall the dependency create, or when should the dependency be checked (setup, uninstall ...).

Required product id:: Product id of the required product.

Required action:: Select the required action (if any) for the required product. Actions can be as 'setup', 'uninstall', 'update'. If no 'required action' is set, a 'required installation status' must be set

Required installation status:: Select the required status of the required product (if any). Usually this is 'installed'. So the required product will be installed if it isn't installed on the client yet. If no 'required installation status' is set, a 'required action' must be set

Requirement type:: This is regarding the installation order. If the required product has to be installed before the installation of the actual product, this is set to 'before'. If it has to be installed after the actual product, set 'requirement type' to 'after'. Leave it blank if the installation order doesn't matter.

NOTE: The possibility to define uninstall actions or dependencies is broken.
After defining a product dependency, you will be asked if you want to create another product dependency. If you choose 'Yes', then the procedure for defining a product dependency is repeated.  If you choose 'No', then you will be asked to define some product properties, which means defining additional  switches for product customization.

NOTE: The installation sequence results from a combination of product dependencies and product priorities. For details on how this is done, and what you can configure, see the opsi-manual.

.A(nother) product property to create?
image::newprod-new-property.png["Screenshot:  A(nother) product property to create?",width=400]

If you answer 'Yes', you will have to describe the product properties.

The product properties are client specific, and have names (keys) which can hold different values. These values can be evaluated by the '{opsi-winst}' script, and result in installing different options at installation time.

First we have to decide if our property is a text value ('unicode') or a logical value e.g. true/false ('boolean'). If you are not sure choose 'unicode'.


.Choose the data type of the property
image::newprod-property-type.png["Screenshot: Choose the data type of the property",width=400]

Next, a description for the switch needs to be specified.  This description will be shown in the {opsi-configed} as a help text. Next, you can define the set of values for the switch (separated by comma). If this is left blank, then any value is allowed for the switch.

NOTE: If a values contains a backslash `\` it has to be doubled. +
An example showing how a path would be defined: `C:\\temp`

.Description of the product properties
image::newprod-property-desc.png["Screenshot: Description of the product properties",width=400]

Next, you can decide if the product property has a default value (switch).

.Default value of the product property
image::newprod-property-default.png["Screenshot: Default value of the product property",width=400]

If you choose 'boolean' as the data type, then the description will contain only the 'Property name' and 'Property description'.

.Description of a boolean property
image::newprod-property-boolean.png["Screenshot: Description of a boolean property",width=400]

After defining a product property, you will be asked if you want to create another product property. If you choose 'Yes', then the procedure of defining a property will be repeated.  If you choose 'No', then you will be asked for name and email of the product maintainer. This data will be written on the changelog.

.Input of the maintainer data
image::newprod-maintainer.png["Screenshot: Input of the maintainer data",width=400]

Finally, the basic definitions for the new product are done.

Using the list command (`ls`), you can see the directory structure as described above. Change to the `OPSI` folder and list the content. The `control` file now contains the data you just defined, and you can load the file into an editor to view or change the entries.

.Example of a `control` file:

[source,configfile]
----
[Package]
version: 1
depends:
incremental: False

[Product]
type: localboot
id: mytest
name: My Test
description: A test product
advice:
version: 3.14
priority: 10
licenseRequired: False
productClasses:
setupScript: setup.ins
uninstallScript:
updateScript:
alwaysScript:
onceScript:
customScript:
userLoginScript:

[ProductDependency]
action: setup
requiredProduct: javavm
requiredStatus: installed

[ProductProperty]
type: unicode
name: mytextprop
multivalue: False
editable: True
description: hint
values: ["off", "on"]
default: ["off"]

[ProductProperty]
type: bool
name: myboolprop
description: yes or no
default: False

[Changelog]
mytest (3.14-1) testing; urgency=low

  * Initial package

 -- jane doe <j.doe@opsi.org>  Mi, 14 Jul 2010 12:47:53 +0000
----

For the next step, you will have to copy the product '{opsi-winst}' script, and any necessary data files (i.e. program-installation-executable.exe), into the `CLIENT_DATA` folder.

So if the script you have written is currently at `c:\test`, just mount the share '\\<opsiserver\opsi_workbench' e.g. to 'w:', and then copy the complete content of `c:\test` to the directory 'CLIENT_DATA'.

[[opsi-getting-started-softwintegration-create-opsi-package-makeproductfile]]
===== Build the Package with opsi-makeproductfile

Now you may build the package. Change to the root directory of the product (maybe `/home/opsiproducts/myproduct/`, and enter 'opsi-makeproductfile'. The product package will be built.  The package (`<package name>`) will be a file that has a format similar to `/home/opsiproducts/<myproduct>/<myproduct_ProductVersion-PackageVersion>.opsi`.

Finally, install the package. The resulting package can be installed on the {opsi-server} with the command +
`opsi-package-manager -i <package name>`.

`opsi-makeproductfile` can be started with different options:

[source,prompt]
----
#  opsi-makeproductfile --help

Usage: opsi-makeproductfile [-h] [-v|-q] [-F format] [-l log-level] [-i|-c custom name] [-I required version] [-t temp dir] [source directory]
Provides an opsi package from a package source directory.
If no source directory is supplied, the current directory will be used.
Options:
   -v          verbose
   -q          quiet
   -l          log-level 0..9
   -n          do not compress
   -F          archive format [tar|cpio], default: cpio
   -h          follow symlinks
   -I          incremental package
   -i          custom name (add custom files)
   -c          custom name (custom only)
   -C          compatibility mode (opsi 3)
   -t          temp dir
----

It is recommended to create the packages with a corresponding md5 checksum file.
This file is used amongst others by opsi-product-updater to check after a file transfer to ensure package integrity.
Such a file can be created with `-m`.

When transferring packages to {opsi-depotserver} zsync can be used to only transfer differences between different packages.
To be able to use this method a special `.zsync` file is required.
Such a file can be created with `-z`.

If you are running into the problem that the creation of a package fails because of insufficient free space in `/tmp` you can use the option `-t` to specify a different temporary folder.

If there is already a package file with the same version information, opsi-makeproductfile will ask for overwrite confirmation:

[source,prompt]
----
Package file '/home/opsiproducts/mytest/mytest_3.14-1.opsi' already exists.
Press <O> to overwrite, <C> to abort or <N> to specify a new version:
----
Choosing 'o' will overwrite, 'c' abort, and 'n' will ask for new version information.

The created opsi-package can be installed at the {opsi-server} with the command: +
`opsi-package-manager -i <packagename>`

More information about the opsi-package-manager can be found in the opsi-manual.

[[opsi-getting-started-more-info]]
== More Information
More detailed information can be found in the opsi-manual (http://download.uib.de/opsi_stable/doc/opsi-manual-stable-en.pdf).

If you need help during your evaluation of opsi, then more help can be found at https://forum.opsi.org

For production-level installations, we offer commercial support:
http://uib.de/en/support-training/support/
