////
; Copyright (c) uib gmbh (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; http://creativecommons.org/licenses/by-sa/3.0/de/
; http://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; http://creativecommons.org/licenses/by-sa/3.0/
; http://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: http://www.opsi.org/credits/
////

:Author:    uib gmbh
:Email:     info@uib.de
:Date:      05.05.2011
:Revision:  4.0.1
:toclevels: 6


include::../common/opsi_terms.asciidoc[]

[[opsi-manual-clientagent]]
=== opsi-client-agent

[[opsi-manual-clientagent-overview]]
==== Overview

To make Software distribution manageable for the system administrator, a client computer has to notice that new software-packets or updates are available and install them without user interaction. It is important to make user-interaction completely obsolete as the installation can run unattended this way and a user cannot stop the installation during the installation process.

These requirements are implemented in opsi by the '{opsi-client-agent}':

On the client side the service 'opsiclientd' examines usually at boot time, before the user logs in, whether an update has to be installed for this client.

If there are software packets to be installed on the client, the script processing program 'opsi-winst' is being started to do the installation job. The server provides all the installation scripts and software files on a file share. At this time the user has no chance to interfere with the installation process.

As an additional option the module 'loginblocker' can be installed to prevent a user login before the end of the installation process is reached.

Before any software can be installed with the 'opsi-winst' program, it has to be prepared as '{opsi-product-package}'. For details see Chapter 'Integration of new software packets into the opsi software deployment' from the 'getting started' manual.

[[opsi-manual-clientagent-directories]]
==== Directories of the opsi-client-agent

The '{opsi-client-agent}' is installed at `%ProgramFiles%\opsi.org\opsi-client-agent`.

This directory contains all programs of the '{opsi-client-agent}' like e.g. the '{opsiclientd}', the '{opsiclientd-notifier}', the '{opsi-winst}' and some required libraries. Also we will find here the configuration files and graphical templates (skins) of the mentioned programs.

The directory `%ProgramFiles%\opsi.org\opsi-client-agent` is protected against manipulation by users without administrator privileges. +
The directory `%ProgramFiles%\opsi.org\opsi-client-agent\opsiclientd` contains the configuration file of the '{opsiclientd}' and you need administrator privileges to read it.

There also is the directory `c:\opsi.org`.

This directory is used (at the moment) for caching installation files and data (see WAN-Extension). In future it will have some more functions like containing log files. +
You need administrator privileges to read the directory `c:\opsi.org`.

The log files of the '{opsi-client-agent}' you will find in `c:\opsi.org\log\`.

[[opsi-manual-clientagent-service]]
==== The service: opsiclientd

The '{opsiclientd}' is the core of the '{opsi-client-agent}'. The '{opsiclientd}' starts at boot time and runs with administrative privileges.

The important features are:

* Event based control: +
The activity of the opsi client agent (opsiclientd) may be triggered by different events in the client system. According to this fact, the start of the installation can be triggered by the system start up event or can be configured to be triggered by some other system event.

* Control via web service: +
This interface is used for 'push' installations and for maintenance purposes as well.

* Remote configuration: +
The configuration data for the clients may be changed (globally or client specific) at the server by editing the 'Host parameters'.

The '{opsi-client-agent}' consists of multiple components :

* '{opsiclientd}': the main service
* '{opsiclientd-notifier}': information and communication window
* '{opsi-login-blocker}': block the user login until the installation has finished

[[opsi-manual-clientagent-installation]]
===== Installation

In case of automatic OS-Installation with opsi (not image based), the '{opsi-client-agent}' will be installed automatically.

You may set the action request 'uninstall' to uninstall the '{opsi-client-agent}'.

For a subsequent installation on an existing Windows system or for repair purposes see the 'getting started' manual.
See also: <<opsi-manual-clientagent-subsequent-installation>>.
See also Chapter 'opsi Software On Demand (Kiosk-Mode)': <<software-on-demand>>


[[opsi-manual-clientagent-opsiclientd]]
===== opsiclientd

Core component of the '{opsi-client-agent}' is the service '{opsiclientd}'. This service starts at the boot time.

The '{opsiclientd}' has the following tasks:

* while the system is booting and the '{opsiclientd}' is waiting for the GUI to come up, the 'block_login_notifier' is started and shows a padlock at the right upper corner of the screen.

* Getting in action if the configuration event takes place. In case of action the '{opsiclientd}' contacts the opsi server via web service (JSON-RPC) and asks for the configuration data and required actions. +
The default event is 'gui_startup' which will fire at boot time before user login.

* Creates a named pipe which is used by the '{opsi-login-blocker}' to ask via JSON-RPC the '{opsiclientd}' when to unblock the login.

* Starting the '{opsiclientd-notifier}' as a thread for information and interaction with the user.

* If needed, it connects to the '{opsi-depot}' to update the local installation of the '{opsi-winst}' and then starts it to process the '{action-requests}' (software packet installations).

[[opsi-manual-clientagent-opsiclientd-notifier]]
===== opsiclientd notifier

The '{opsiclientd-notifier}' implements the interaction with the user. It displays status messages and may give the possibility to interact with the process.

There are different situations where the '{opsiclientd-notifier}' will become active in different ways:

blocking notifier::
Indicates that the '{opsi-login-blocker}' is blocking

.opsiclientd blocklogin notifier
image::opsiclientd-blocklogin-notifier.png["opsiclientd blocklogin notifier",width=80]

event notifier::
Shows information about the current event.

.opsiclientd event notifier
image::opsiclientd-event-notifier.png["opsiclientd event notifier",width=150]

action notifier::
Shows state of the event processing

.opsiclientd action notifier
image::opsiclientd-action-notifier.png["opsiclientd action notifier",width=150]

shutdown notifier::
Gives information about a requested reboot / shutdown
(if +shutdown_warning_time+ > 0)

.opsiclientd shutdown notifier
image::opsiclientd-shutdown-notifier.png["opsiclientd shutdown notifier",width=150]

CAUTION: Names and functionality of the notifier have changed from opsi 4.0 to opsi 4.0.1. +
The opsi 4.0 event notifier doesn't exist anymore. +
The opsi 4.0.1 event notifier equals the opsi 4.0 action notifier. +
The opsi 4.0.1 action notifier has almost the same functionality as the opsi 4.0 event notifier, but it will only be activated if there is a '{action-request}'.


[[opsi-manual-clientagent-loginblocker]]
===== {opsi-login-blocker}
The '{opsi-login-blocker}' for NT5 (Win2K/WinXP) is implemented as a 'GINA'  ('opsigina.dll').
This 'GINA' waits until the opsiclientd reports, that all '{product-actions}' are finished or, if the opsiclientd is not reachable, until the connection timeout to the opsiclientd is reached (normally 120 seconds). Then the complete control is forwarded to the next 'GINA', which is normally the `msgina.dll`.

The '{opsi-login-blocker}' for NT6 (Vista/Win7) is implemented as a 'credential provider filter' ('OpsiLoginBlocker.dll').
This 'credential provider filter' blocks all 'credential providers' until the opsiclientd reports, that all '{product-actions}' are finished or, if the opsiclientd is not reachable, until the connection timeout to the opsiclientd is reached (normally 120 seconds).

[[opsi-manual-clientagent-event-flow]]
===== Processing sequence

How the opsiclientd works may be configured in many details. To understand these configuration options, it is necessary to understand the processing sequence. Here comes an overview of the work flow of a 'standard event' like the 'event_gui_startup'.

.simplified work flow of a 'standard event'
image::eventflowchsrt.png["simplified work flow of a 'standard event'",height=400]

The most important parameters have the following relations:

TIP: If there is an error while connecting to the '{opsi-configserver}', the log of this problem cannot be sent to the server. But you may find the log in the local log file `opsiclientd.log` in the log directory (`c:\opsi.org\log\opsiclientd.log`) at the client.

. If an event fires, the +event_notifier_command+ will be started. +
Now the opsiclientd tries to reach the '{opsi-configserver}' using the url address. +
If after +user_cancelable_after+ seconds there is still no connection established, so the '{opsiclientd-notifier}' will enable an 'Abort' button. If no connection could be established in +connection_timeout+ seconds, the 'opsiclientd' connection process will be aborted and the event ends with an error message. To avoid a user from aborting, set +user_cancelable_after+ = +connection_timeout+ .

. After a successful connection to the '{opsi-configserver}', the 'opsiclientd' checks if there are 'action requests' for this client. If there are 'action requests' and the +action_warning_time+ > 0, the +action_notifier_command+ will be executed. +
This is normally the '{opsiclientd-notifier}', which shows now the list of 'action requests' for this client for +action_warning_time+ seconds. +
Is the +action_warning_time+ = 0 (default) the +action_notifier_command+ will not be executed. +
You may allow the user to suspend the process at this time by setting +action_user_cancelable+ >= 0. The user may suspend the actions up to +action_user_cancelable+ times. After +action_user_cancelable+ aborts in sequence or if +action_user_cancelable+ = 0 the user gets no possibility to suspend the actions. +
In every case there will be a button which allows the user to start the installations immediately without waiting for the count down of +action_warning_time+ seconds. The messages displayed by the '{opsiclientd-notifier}' may be configured with the options +action_message+ or +action_message[lang]+ . This messages may contain the placeholders +%action_user_cancelable%+ (total number of allowed suspensions) and +%action_cancel_counter%+ (number of suspensions already used by the user). +
If the actions are not suspended by the user, the +action_cancel_counter+ will reset and the '{opsi-winst}' will be executed to process the 'action requests'.

. If the '{opsi-winst}' terminates with a reboot or shutdown request, the +shutdown_notifier_command+ will be executed if +shutdown_warning_time+ > 0. +
The now starting +shutdown_notifier_command+ shows for +shutdown_warning_time+ seconds a message saying that the client will be rebooted. If +shutdown_user_cancelable+ > 0 the user may suspend the reboot up to +shutdown_user_cancelable+ times in sequence. If the user suspends the reboot, the +shutdown_notifier_command+ will be restarted after +shutdown_warning_repetition_time+. The +shutdown_notifier_command+ shows a message which may be configured by +shutdown_warning_message+ or +shutdown_warning_message[lang]+. This message may contain the placeholders  +%shutdown_user_cancelable%+ (maximum number of allowed suspensions) and +%shutdown_cancel_counter%+ number of suspensions already done by the user). +
If the client is rebooted (by the user or the 'opsi-client-agent') the +%shutdown_cancel_counter%+ will be reset.

TIP: The sequence of event processing and user actions is visualized as a timeline graphic at the info page of the '{opsiclientd}'.

(<<opsi-manual-clientagent-infopage>>).


.Complete work flow of an event
image::opsiclientd-event-processing-flow.png["Complete work flow of a event",height=650]

[[opsi-manual-clientagent-configuration]]
===== Configuration

The following chapters shows how to configure the opsi-client-agent.


[[opsi-manual-clientagent-configuration-events]]
===== Configuration of different events

To meet the requirements of the various different situations in which the '{opsi-client-agent}' will become active, a slightly complex configuration is needed. To reduce the complexity, the configuration file uses something like inheritance. +
In the '{opsiclientd}' configuration section headers like +[event_<config-id>]+ introduce a new event configuration section. An event configuration may be disabled by setting the section option +active = false+.

There are different types of event configurations (+type+).

* There are 'event configuration templates' (type = template). +
Event configurations may inherit configurations from another event. In this case the option +super+ points to the other event to inherit all parameters from (excluding the parameter +active+). These inherited parameters may be overridden by local parameters in the current event section. So an event section needs only those parameters which are different from the +super+ event. +
Setting an event to +active = false+ does not change anything in the inheritance process.

* The other event types are: +
  - +gui startup+ +
A +gui startup+ event starts while booting the client and loading the 'graphical user interface' (GUI). It is the most used event and set to active in the default configuration.

  - +custom+ +
Event configurations of the type +custom+ are fired by a +wql+ event. A +wql+ event is defined by the corresponding +wql+ statement in the event configuration. If the +wql+ statement is empty, the event will never be fired, but can be executed from the interactive web interface.

  - +user login+ +
will be fired at the login of a user

  - +timer+ +
will be fired all +interval+ seconds

  - +sync completed+ +
will be fired if the synchronization of configurations (+sync_config_from_server+) or products (+cache_products+) is completed.

  - +sw on demand+ +
will be fired by the user choosing 'Start actions now' in the 'software-on-demand' web page of the opsiclientd. It will never be fired if 'software-on-Demand' is not used.

* There are 'Preconditions' +
'Preconditions' define special system states (e.g. a user is logged on).
In the '{opsiclientd}' configuration a section header of the form +[precondition_<precondition-id>]+ starts the declaration of a 'Precondition'.
A 'Precondition' is true, if all declared options are true.
An option not declared (but possible) is assumed as true. +
Possible options for 'Preconditions' are:
  - +user_logged_in+: is true if currently a user is logged on.
  - +config_cached+: is true if the caching of configuration data is completed (see: +sync_config_from_server+).
  - +products_cached+: is true if the caching of product files is completed (see: +cache_products+).

* A 'Precondition' can be assigned to an event configuration. +
This can be done by giving the 'precondition' in curly brackets at the end of the event configuration section hedaer (e.g. +[event_on_demand{user_logged_in}]+). +
If there is a 'Precondition' in an event configuration header, there also must be a configuration for this event without any 'precondition'.
Is there for example an event configuration +event_on_demand{user_logged_in}+, there also has to be an event configuration +event_on_demand+ !
The event configuration with the precondition inherits all the parameters from the event configuration without 'precondition'. +
If the event is fired, first it will be checked which 'preconditions' are true. If there is no 'precondition' true, the configuration without 'precondition' is used.
Is one 'precondition' true, the configuration is used, which is bound to this 'precondition'.
If more than one of the 'preconditions' are true, the most specific event configuration is used (which is the configuration with the most matching options).


A small example for a better understanding: +
While installing software it may be necessary to reboot the computer. Is there currently a user logged on, you should warn about the pending reboot. This warning should have a timeout and it may make sense to ask the user, if the reboot should be canceled (at the moment). +
Is there no user logged on, it makes no sense to ask and wait for an answer. So in this case the reboot should take place immediately. +
To handle these different situations, we configure the +event_on_demand+ in the following way:

* We define a 'Precondition' +user_logged_in+ which comes true if a user is logged on to the system (+user_logged_in = true+).

* In the default configuration for the event +event_on_demand+ (without any 'Precondition') we set +shutdown_warning_time = 0+ (immediate reboot without warning).

* At the configuration +event_on_demand\{user_logged_in\}+ we set  +shutdown_warning_time = 300+ (warning with 300 seconds timeout).

[[opsi-407-releasenotes-clientagent-configuration-proxysupport]]
===== Proxysupport-Configuration

In the global section of opsiclientd.conf you have the option to define a proxyserver that will be used by the opsi-client-agent.
If a proxyserver is defined in config, all HTTP- and HTTPS-Connection of the opsiclientd will be redirected to this proxyserver.

[source,ini]
----
# Use a proxy for connecting configservice
# proxy_mode:
#   'system' will try to check the system setting,
#   'static' to use proxyurl from configfile/hostparameter
# proxy_url usage: http://<user>:<password>@<proxy-url>:<proxy-port>
# Example: http://proxyuser:proxypass123@proxy.domain.local:8080
proxy_mode = static
proxy_url =
----

This proxy settings allows also to use a proxyserver, that require authentication.
In that case you must define the credentials as shown in the configuration snippet.

WARNING: The option proxy_mode is reserved for the value 'system' to use on the system proxy settings. This feature is not implemented yet. Therefore the only option that works at the moment is the 'static' mode.


[[opsi-407-releasenotes-clientagent-configuration-eventcontrol_over_productgroups]]
===== Event configuration to control which products will be processed

With this new feature it's possible over the configuration to control the list of products, that will be processed in Events with product groups:

There are (basically) two ways to use this control:

Blacklisting (excluding):

The option `exclude_product_group_ids` allows to configure a comma separated list of product Groups. The members of these groups will be excluded from the actual Event. Also if action request is set for this products. This products will be ignored in this event, but the action requests will not be changed.

White listing (including):

The option `include_product_group_ids` allows to also configure a comma separated list of products Groups. The members of this groups are the only products, that will be processed from the actual event if they have set action requests.

You can use these options globally from the default-Event. From that point this settings will be used in every event. You can also set these options in a special event. If you use the option on event_on_demand, you can control which products will not be installed in push installations, although they have an action request. On normal restart of the client, the products will be installed from gui_startup (default event) at startup.
CAUTION: For Clients that work in WAN/VPN-mode you must set this options in sync-event and also in the cacheservice-section, because the cache service have no access to the configuration of main sync-event.

WARNING: Product dependencies will not be observed by this feature. That means that you have to observe the process in order to prevent dependency issues.

[[opsi-manual-clientagent-configuration-file]]
===== Configuration via configuration file

The configuration file is: +
`c:\program files\opsi.org\opsi-client-agent\opsiclientd\opsiclientd.conf`

CAUTION: This configuration file is UTF-8 encoded. +
Any changes using editors which do not support this encoding (e.g. notepad.exe) may destroy any umlaut in this file.

The configuration written in this file may be changed by different configuration data, which come via web service after a successful connection to the '{opsi-server}'.

A sample `opsiclientd.conf`:
[source,ini]
----
; = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
; =     configuration file for opsiclientd                              =
; = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =


; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
; -     global settings                                                 -
; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[global]

# Location of the log file.
log_file = c:\\opsi.org\\log\\opsiclientd.log

# Set the log (verbosity) level
# (0 <= log level <= 9)
# 0: nothing, 1: essential, 2: critical, 3: errors, 4: warnings, 5: notices
# 6: infos, 7: debug messages, 8: more debug messages, 9: passwords
log_level = 4

# Client id.
host_id =

# Opsi host key.
opsi_host_key =

# Verify opsi server certs
verify_server_cert = false

# Verify opsi server certs by ca
verify_server_cert_by_ca = false

# On every daemon startup the user login gets blocked
# If the gui starts up and no events are being processed the login gets unblocked
# If no gui startup is noticed after <wait_for_gui_timeout> the login gets unblocked
# Set to 0 to wait forever
wait_for_gui_timeout = 120

# Application to run while blocking login
block_login_notifier = %global.base_dir%\\notifier.exe -s notifier\\block_login.ini

# Use a proxy for connecting configservice
# proxy_mode:
#   'system' will try to check the system setting,
#   'static' to use proxyurl from configfile/hostparameter
# proxy_url usage: http://<user>:<password>@<proxy-url>:<proxy-port>
# Example: http://proxyuser:proxypass123@proxy.domain.local:8080
proxy_mode = static
proxy_url =

; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
; -     config service settings                                         -
; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[config_service]
# Service url.
# http(s)://<opsi config server address>:<port>/rpc
url = https://opsi.uib.local:4447/rpc

# Conection timeout.
connection_timeout = 30

# The time in seconds after which the user can cancel the connection establishment
user_cancelable_after = 30

# If this option is set, the local system time will be synced with time from service
sync_time_from_service = false

; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
; -     depot server settings                                           -
; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[depot_server]

# Depot server id
depot_id =

# Depot url.
# smb://<depot address>/<share name>/<path to products>
url =

# Local depot drive
drive =

# Username that is used for network connection [domain\]<username>
username = pcpatch

; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
; -     cache service settings                                          -
; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[cache_service]
# Maximum product cache size in bytes
product_cache_max_size = 5000000000
# Members of this ProductGroups will be excluded from processing
exclude_product_group_ids =
# Only members of this ProductGroups will be excluded from processing
include_product_group_ids =

; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
; -     control server settings                                         -
; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[control_server]

# The network interfaces to bind to.
# This must be the IP address of an network interface.
# Use 0.0.0.0 to listen to all interfaces
interface = 0.0.0.0

# The port where opsiclientd will listen for HTTPS rpc requests.
port = 4441

# The location of the server certificate.
ssl_server_cert_file = %global.base_dir%\\opsiclientd\\opsiclientd.pem

# The location of the server private key
ssl_server_key_file = %global.base_dir%\\opsiclientd\\opsiclientd.pem

# The location of the static files
static_dir = %global.base_dir%\\opsiclientd\\static_html

# The maximum number of authentication failures before a client ip
# is blocked for an amount of time.
max_authentication_failures = 5

; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
; -     notification server settings                                    -
; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[notification_server]

# The network interfaces to bind to.
# This must be the IP address of an network interface.
# Use 0.0.0.0 to listen to all interfaces
interface = 127.0.0.1

# The first port where opsiclientd will listen for notification clients.
start_port = 44000

# Port for popup notification server
popup_port = 45000

; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
; -     opsiclientd notifier settings                                   -
; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[opsiclientd_notifier]

# Notifier application command
command = %global.base_dir%\\notifier.exe -p %port% -i %id%

; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
; -     opsiclientd rpc tool settings                                   -
; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[opsiclientd_rpc]

# RPC tool command
command = %global.base_dir%\\opsiclientd_rpc.exe "%global.host_id%" "%global.opsi_host_key%" "%control_server.port%"

; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
; -     action processor settings                                       -
; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[action_processor]
# Locations of action processor
local_dir = %global.base_dir%\\opsi-winst
remote_dir = opsi-winst\\files\\opsi-winst
filename = winst32.exe

# Action processor command
command = "%action_processor.local_dir%\\%action_processor.filename%" /opsiservice "%service_url%" /clientid %global.host_id% /username %global.host_id% /password %global.opsi_host_key%

# Load profile / environment of %run_as_user%
create_environment = false

; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
; -     events                                                          -
; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[event_default]
; === Event configuration
# Type of the event (string)
type = template
# Interval for timer events in seconds (int)
interval = -1
# Maximum number of event repetitions after which the event will be deactivated (int, -1 = forever)
max_repetitions = -1
# Time in seconds to wait before event becomes active (int, 0 to disable delay)
activation_delay = 0
# Time in seconds to wait before an event will be fired (int, 0 to disable delay)
notification_delay = 0
# Event notifier command (string)
event_notifier_command = %opsiclientd_notifier.command% -s notifier\\event.ini
# The desktop on which the event notifier will be shown on (current/default/winlogon)
event_notifier_desktop = current
# Block login while event is been executed (bool)
block_login = false
# Lock workstation on event occurrence (bool)
lock_workstation = false
# Logoff the current logged in user on event occurrence (bool)
logoff_current_user = false
# Get config settings from service (bool)
get_config_from_service = true
# Store config settings in config file (bool)
update_config_file = true
# Transmit log file to opsi service after the event processing has finished (bool)
write_log_to_service = true
# Shutdown machine after action processing has finished (bool)
shutdown = false
# Reboot machine after action processing has finished (bool)
reboot = false
# Members of this ProductGroups will be excluded from processing
exclude_product_group_ids =
# Only members of this ProductGroups will be excluded from processing
include_product_group_ids =

; === Sync/cache settings
# Sync configuration from local config cache to server (bool)
sync_config_to_server = false
# Sync configuration from server to local config cache (bool)
sync_config_from_server = false
# Sync configuration from local config cache to server after action processing (bool)
post_sync_config_to_server = false
# Sync configuration from server to local config cache after action processing (bool)
post_sync_config_from_server = false
# Work on local config cache
use_cached_config = false
# Cache products for which actions should be executed in local depot cache (bool)
cache_products = false
# Maximum transfer rate when caching products in byte/s (int, 0 = no limit)
cache_max_bandwidth = 0
# Dynamically adapt bandwith to other network traffic (bool)
cache_dynamic_bandwidth = false
# Work on local depot cache
use_cached_products = false

; === Action notification (if product actions should be processed)
# Time in seconds for how long the action notification is shown (int, 0 to disable)
action_warning_time = 0
# Action notifier command (string)
action_notifier_command = %opsiclientd_notifier.command% -s notifier\\action.ini
# The desktop on which the action notifier will be shown on (current/default/winlogon)
action_notifier_desktop = current
# Message shown in the action notifier window (string)
action_message = Starting to process product actions. You are allowed to cancel this event a total of %action_user_cancelable% time(s). The event was already canceled %state.action_processing_cancel_counter% time(s).
# German translation (string)
action_message[de] = Starte die Bearbeitung von Produkt-Aktionen. Sie können diese Aktion insgesamt %action_user_cancelable% mal abbrechen. Die Aktion wurde bereits %state.action_processing_cancel_counter% mal abgebrochen.
# French translation (string)
action_message[fr] = Traitement des actions du produit. Vous êtes autorisé à annuler cet événement un total de %action_user_cancelable% fois. L'événement a été déjà annulée %state.action_processing_cancel_counter% fois.
# Number of times the user is allowed to cancel the execution of actions (int)
action_user_cancelable = 0

; === Action processing
# Should action be processed by action processor (bool)
process_actions = true
# Type of action processing (default/login)
action_type = default
# Update the action processor from server before starting it (bool)
update_action_processor = true
# Command which should be executed before start of action processor
pre_action_processor_command =
# Action processor command (string)
action_processor_command = %action_processor.command%
# The desktop on which the action processor command will be started on (current/default/winlogon)
action_processor_desktop = current
# Action processor timout in seconds (int)
action_processor_timeout = 10800
# Command which should be executed before after action processor has ended
post_action_processor_command =

; === Shutdown notification (if machine should be shut down or rebooted)
# Process shutdown requests from action processor
process_shutdown_requests = true
# Time in seconds for how long the shutdown notification is shown (int, 0 to disable)
shutdown_warning_time = 0
# Shutdown notifier command (string)
shutdown_notifier_command = %opsiclientd_notifier.command% -s notifier\\shutdown.ini
# The desktop on which the action notifier will be shown on (current/default/winlogon)
shutdown_notifier_desktop = current
# Message shown in the shutdown notifier window (string)
shutdown_warning_message = A reboot is required to complete software installation tasks. You are allowed to delay this reboot a total of %shutdown_user_cancelable% time(s). The reboot was already delayed %state.shutdown_cancel_counter% time(s).
# German translation (string)
shutdown_warning_message[de] = Ein Neustart wird benötigt um die Software-Installationen abzuschliessen. Sie können diesen Neustart insgesamt %shutdown_user_cancelable% mal verschieben. Der Neustart wurde bereits %state.shutdown_cancel_counter% mal verschoben.
# French translation (string)
shutdown_warning_message[fr] = Un redémarrage est nécessaire pour terminer l'installation du logiciel. Vous êtes autorisé à retarder le redémarrage un total de %shutdown_user_cancelable% fois. Le redémarrage a été déjà retardé %state.shutdown_cancel_counter% fois.
# Number of times the user is allowed to cancel the shutdown (int)
shutdown_user_cancelable = 0
# Time in seconds after the shutdown notification will be shown again after the user has canceled the shutdown (int)
shutdown_warning_repetition_time = 3600

[event_gui_startup]
super = default
type = gui startup
name = gui_startup
block_login = true

[event_gui_startup{user_logged_in}]
name = gui_startup
shutdown_warning_time = 300
block_login = false

[event_gui_startup{cache_ready}]
use_cached_config = true
use_cached_products = true
action_user_cancelable = 3
action_warning_time = 60

[event_gui_startup{installation_pending}]
name = gui_startup
active = true

[event_on_demand]
super = default
type = custom
name = on_demand

[event_on_demand{user_logged_in}]
name = on_demand
shutdown_warning_time = 300

[event_software_on_demand]
super = default
type = sw on demand

[event_sync]
super = default
type = template
process_actions = false
event_notifier_command =
sync_config_to_server = true
sync_config_from_server = true
cache_products = true
cache_dynamic_bandwidth = true

[event_timer]
super = sync
type = timer
active = false
interval = 3600

[event_net_connection]
super = sync
type = custom
active = false
wql = SELECT * FROM __InstanceModificationEvent WITHIN 2 WHERE TargetInstance ISA 'Win32_NetworkAdapter' AND TargetInstance.NetConnectionStatus = 2

[event_sync_completed]
super = default
type = sync completed
event_notifier_command =
process_actions = false
get_config_from_service = false
write_log_to_service = false

[event_sync_completed{cache_ready_user_logged_in}]
reboot = true
shutdown_user_cancelable = 10
shutdown_warning_time = 300

[event_sync_completed{cache_ready}]
reboot = true

[event_user_login]
super = default
type = user login
action_type = login
active = false
action_message = Starting to process user login actions.
action_message[de] = Beginne mit der Verarbeitung der Benutzer-Anmeldungs-Aktionen.
action_message[fr] = Traitement des actions à la connexion de l'utilisateur.
block_login = false
process_shutdown_requests = false
get_config_from_service = false
update_config_file = false
write_log_to_service = false
update_action_processor = true
event_notifier_command = %opsiclientd_notifier.command% -s notifier\\userlogin.ini
event_notifier_desktop = default
action_processor_command = %action_processor.command% /sessionid %service_session% /allloginscripts /silent
action_processor_desktop = default
action_processor_timeout = 300

[event_on_shutdown]
super = default
type = custom
name = on_shutdown
active = False

[event_on_shutdown{installation_pending}]
name = on_shutdown
active = False

[event_silent_install]
super = default
type = custom
name = silent_install
event_notifier_command =
process_shutdown_requests = false
action_processor_productIds = swaudit,hwaudit
action_processor_command = %action_processor.command% /productlist %action_processor_productIds% /silent
action_processor_desktop = winlogon
action_processor_timeout = 300

[event_timer_silentinstall]
super = silent_install
type = timer
active = false
interval = 21600

[precondition_user_logged_in]
user_logged_in = true

[precondition_cache_ready]
config_cached = true
products_cached = true

[precondition_cache_ready_user_logged_in]
user_logged_in = true
config_cached = true
products_cached = true

[precondition_installation_pending]
installation_pending = true
----

[[opsi-manual-clientagent-configuration-webservice]]
===== Configuration via web service (Host Parameter)

The opsiclientd configuration can be changed by the 'host parameter' tab at the opsi management interface.

The entries in the 'host parameter' have to be according to the following patterns:

`opsiclientd.<name of the section>.<name of the key>`

Example: +
`opsiclientd.event_gui_startup.action_warning_time = 20` +
set in the configuration file `opsiclientd.conf` in the section +[event_gui_startup]+ the value of +action_warning_time+ to the value 20.

The following figure shows how to change the serverwide general configure via '{opsi-configed}'

.Setting the server default opsiclientd configuration
image::opsiclientd-configuration-via-configed-serverdefault.png["Setting the server default opsiclientd configuration",width=400]

Using the context menu you may choose 'add property' to set a new key/value pair.

To delete a server default, please use the '{opsi-admin}' tool:

Example:
[source,prompt]
----
opsi-admin -d method config_delete "opsiclientd.event_gui_startup.action_warning_time"
----

It is also possible to manipulate these entries client specific via '{opsi-configed}'.

To delete a client specific entry, please use the '{opsi-admin}' tool:

Example:

[source,prompt]
----
@opsi-admin> method configState_delete "opsiclientd.event_gui_startup.action_warning_time" "myclient.uib.local"
----

.client specific {opsiclientd} configuration via {opsi-configed}
image::opsiclientd-configuration-via-configed.png["client specific {opsiclientd} configuration via {opsi-configed}",width=400]


[[opsi-manual-clientagent-logging]]
===== Logging

The '{opsiclientd}' logs to: +
`C:\opsi.org\log\opsiclientd.log`.

All log information will be transferred to the '{opsi-configserver}' via web service. At the server you find these log infos at `/var/log/opsi/clientconnect/<ip-or-name-of-the-client>.log`. They are presented in the opsi configed at the tab 'logfiles / client connect'.

Every line at the log has the pattern: +
+[<log level>] [<time stamp>] [message source] message+.

There are the following log levels:
....
# Set the log (verbosity) level
# (0 <= log level <= 9)
# 0: nothing, 1: essential, 2: critical, 3: errors, 4: warnings, 5: notices
# 6: infos, 7: debug messages, 8: more debug messages, 9: passwords
....

Example:
[source,opsilog]
----
(...)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] Event config 'sync_completed{cache_ready}' added to event generator 'sync_completed'   (Events.pyo|1107)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] Event config 'gui_startup' added to event generator 'gui_startup'   (Events.pyo|1107)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] Event config 'gui_startup{cache_ready}' added to event generator 'gui_startup'   (Events.pyo|1107)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] Event config 'on_demand' added to event generator 'on_demand'   (Events.pyo|1107)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] Event config 'sync_completed{cache_ready_user_logged_in}' added to event generator 'sync_completed'   (Events.pyo|1107)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] Event config 'gui_startup{user_logged_in}' added to event generator 'gui_startup'   (Events.pyo|1107)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] Event config 'sync_completed' added to event generator 'sync_completed'   (Events.pyo|1107)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] Event config 'software_on_demand' added to event generator 'software_on_demand'   (Events.pyo|1107)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] Event config 'on_demand{user_logged_in}' added to event generator 'on_demand'   (Events.pyo|1107)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] Updating config file: 'C:\Program Files (x86)\opsi.org\opsi-client-agent\opsiclientd\opsiclientd.conf'   (Config.pyo|287)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] No need to write config file 'C:\Program Files (x86)\opsi.org\opsi-client-agent\opsiclientd\opsiclientd.conf', config file is up to date   (Config.pyo|318)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] No product action requests set   (EventProcessing.pyo|591)
[5] [Mar 22 10:17:49] [ event processing gui_startup  ] Writing log to service   (EventProcessing.pyo|247)
[6] [Mar 22 10:17:49] [ opsiclientd                   ] shutdownRequested: 0   (Windows.pyo|340)
[6] [Mar 22 10:17:49] [ opsiclientd                   ] rebootRequested: 0   (Windows.pyo|326)
[5] [Mar 22 10:17:49] [ opsiclientd                   ] Block login now set to 'False'   (Opsiclientd.pyo|111)
[6] [Mar 22 10:17:49] [ opsiclientd                   ] Terminating block login notifier app (pid 1620)   (Opsiclientd.pyo|148)
[6] [Mar 22 10:17:49] [ event processing gui_startup  ] Stopping notification server   (EventProcessing.pyo|225)
[6] [Mar 22 10:17:51] [ control server                ] client connection lost   (Message.pyo|464)
[6] [Mar 22 10:17:52] [ event processing gui_startup  ] Notification server stopped   (Message.pyo|651)
[5] [Mar 22 10:17:52] [ event processing gui_startup  ] ============= EventProcessingThread for event 'gui_startup' ended =============   (EventProcessing.pyo|1172)
[5] [Mar 22 10:17:52] [ opsiclientd                   ] Done processing event '<ocdlib.Events.GUIStartupEvent object at 0x023CE330>'   (Opsiclientd.pyo|405)
[5] [Mar 22 10:19:41] [ opsiclientd                   ] Session 'HSzMB1wtOiBS6vHl7mh3ro5r6s3TanFu' from ip '127.0.0.1', application 'opsi jsonrpc module version 4.0.1' expired after 120 seconds   (Session.pyo|184)
[6] [Mar 22 10:19:41] [ opsiclientd                   ] Session timer <_Timer(Thread-20, started daemon 2636)> canceled   (Session.pyo|120)
[5] [Mar 22 10:19:41] [ opsiclientd                   ] Session 'HSzMB1wtOiBS6vHl7mh3ro5r6s3TanFu' from ip '127.0.0.1', application 'opsi jsonrpc module version 4.0.1' deleted   (Session.pyo|207)
[6] [Mar 22 10:27:55] [ control pipe                  ] Creating pipe \\.\pipe\opsiclientd   (ControlPipe.pyo|253)
[5] [Mar 22 10:27:55] [ event generator wait_for_gui  ] -----> Executing: getBlockLogin()   (JsonRpc.pyo|123)
[5] [Mar 22 10:27:55] [ opsiclientd                   ] rpc getBlockLogin: blockLogin is 'False'   (ControlPipe.pyo|428)
[6] [Mar 22 10:27:55] [ event generator wait_for_gui  ] Got result   (JsonRpc.pyo|131)
'
----

The '{opsi-login-blocker}' logging to the log file: `C:\opsi.org\log\opsi_loginblocker.log`.

[[opsi-manual-clientagent-infopage]]
===== {opsiclientd} infopage

According to the fact that there are a lot of subcomponents of the '{opsiclientd}' which work and log at the same time, the log file of the '{opsiclientd}' becomes complex.

In order to make it easier to understand how the different subcomponents work together, the '{opsiclientd}' has an own 'info page' which visualizes the running tasks on a timeline. +
You may view this 'info page' at the browser calling the url: +
https://<address-of-the-client>:4441/info.html

.Info page of the {opsiclientd} after push installation with activated product caching
image::opsiclientd_infopage_event_on_demand.png["Info page of the {opsiclientd} at push installation with activated product caching",width=400]

[[opsi-manual-clientagent-control]]
===== {opsi-client-agent} remote control

The '{opsiclientd}' has its own web service interface which can be used to transmit commands to the '{opsiclientd}'. The possible commands can be divided in the following categories:

* send Messages (Popup)
* 'Push' installation (start the event 'on_demand')
* other maintenance tasks

This can be done on the command line using the tool '{opsi-admin}' by calling one of the +hostControlSafe_*+ methods. Calling one of these methods takes the parameter +*hostid+ which:

* can be `["*"]` to send the command to all clients
* can be the name of a client (e.g.. "pcbon4.uib.local")
* can be a list of client names according to the pattern [ <client1>, <client2>] +
e.g.. ["pcbon1.uib.local", "pcbon2.uib.local"]
* may contain wildcards like +*+
+
e.g.. "pcbon4.\*" or "pcbon*"

If a client isn't reachable (e.g. powerd off) you will get a message.

[[opsi-manual-clientagent-control-messages]]
===== Sending popup messages

Using the '{opsi-configed}' you may send messages to the clients.
 <<opsi-manual-configed-client-editing-send-message>>


At the command line you may do this with the tool '{opsi-admin}':
[source,prompt]
----
opsi-admin -d method hostControlSafe_showPopup message *hostid
----

Example:
[source,prompt]
----
opsi-admin -d method hostControlSafe_showPopup "This is my message" "myclient.uib.local"
----

[[opsi-manual-clientagent-control-fire-event]]
===== 'Push' installations: start the event 'on demand'

The '{opsi-server}' may send a command to the client that the client should process the configured action requests immediately. This is done by activating the event 'on_demand' at the client.

This is possible using the '{opsi-configed}' and is described in chapter:
'Push' installationen: start the event 'on demand'

From the '{opsi-server}' the client can be instructed to execute the '{product-actions}'.

Executing Events can also be done from the '{opsi-configed}'.
<<opsi-manual-configed-client-editing-ondemand>>

On the command line you may use '{opsi-admin}' to fire an event:
[source,prompt]
----
opsi-admin -d method hostControlSafe_fireEvent event *hostIds
----

Example:
[source,prompt]
----
opsi-admin -d method hostControlSafe_fireEvent "on_demand" "myclient.uib.local"
----

[[opsi-manual-clientagent-control-misc]]
===== Additional maintenance tasks (shutdown, reboot,.....)

Using the control server port you may remote control the '{opsiclientd}'. In order to do this you have to authenticate yourself at the web service. This could be done either with the local administrator account (with a not empty password) or with the '{opsi-host-id}' (FQDN, client name and DNS Domain name) as user name and the opsi-hostkey as password.

Using the '{opsi-configed}' you may choose the menu 'opsiClient' or the context menu in the 'Clients' Tab.

.Web service of the {opsiclientd}
image::opsiclientd-control-server-web-interface.png["Web service of the {opsiclientd}",width=400]

At the command line you also can initiate a client:

shutdown:
[source,prompt]
----
opsi-admin -d method hostControlSafe_shutdown *hostIds
----

reboot:
[source,prompt]
----
opsi-admin -d method hostControlSafe_reboot *hostIds
----

[[opsi-manual-clientagent-ci]]
==== Adapting the opsi-client-agent to your Corporate Identity (CI)

Adapting the '{opsi-client-agent}' to your Corporate Identity can be important for the user acceptance when rolling out opsi. By adding your corporate logo to the opsi background image, the users feel more familiar with the opsi installation instead of being puzzled by something unknown.

Since opsi-client-agent version 4.0.7.16 all graphic components of the opsi-client-agent (notifier, opsi-script, kiosk-client) are base on the same graphic libraries and may be customized in the same way. +
Colors can be configured in three different ways: as symbolic name (clRed), as hexadecimal value ($FF00FF) and as rgb value ((255,0,0)). There is a helper program set allows you simple to choose your colors and get the correct way to write the colors to the configuration file. You find this program over here: +
http://download.uib.de/opsi40/helper/opsi-colorchooser.exe

As background graphic formats you may use a large number of different formats like: .bmp, .png, jpeg and so on. But all these formats are include a number of subformats. So for example is one png file displayed without any problem while an other, different png-file may not displayed in a correct way. +
There may also be a difference between the operating system platforms (e.g between Windows and Linux). +
There is a helper program set allows you simply to check if a given bitmap file will be displayed correct or not. You find this program over here: +
http://download.uib.de/opsi40/helper/opsi-bitmapviwer.exe



[[opsi-manual-clientagent-ci-winst]]
===== Elements to be patched: opsi-winst
The files to be configured for opsi-winst are to be found in the directory `/var/lib/opsi/depot/opsi-client-agent/files/opsi/opsi-winst/winstskin`:

* `bg.png` +
This is the '{opsi-winst}' background image, where during installation text messages and product logos are shown.

* `skin.ini` +
This is the configuration file to specify the position, font and color of text messages during installation.

[[opsi-manual-clientagent-ci-opsiclientd]]
===== Elements to be configured: opsiclientd
In the directory
`/var/lib/opsi/depot/opsi-client-agent/files/opsi/dist/notifier`
are the files to configure the look of the notifiers. Each notifier has an image and a configuration file:

* `block_login.bmp` +
background image of the login blocker notifier.
* `block_login.ini` +
configuration file of the login blocker notifier.
* `event.bmp` +
background image of the server connection event notifier.
* `event.ini` +
configuration file of the server connection event notifier.
* `action.bmp` +
background image of the action notifier (software installation).
* `action.ini` +
configuration file of the action notifier.
* `shutdown.bmp` +
background image of the shutdown/reboot action notifier.
* `shutdown.ini` +
configuration file of the shutdown/reboot action notifier.
* `popup.bmp` +
background image of the popup message notifier.
* `popup.ini` +
configuration file of the popup message notifier.
* `userlogin.bmp` +
background image of the user login event notifier.
* `userlogin.ini` +
configuration file of the user login event notifier.

[[opsi-manual-clientagent-ci-kioskclient]]
===== Elements to be configured: kioskclient

For description of the kiosk client see also: <<software-on-demand>>

The Headers list from the Main window (1) is customizable to the desire of the client.
To that, there are two files which play a roll:

* `opsiclientkiosk.png`
* `opsiclientkiosk.ini`

The `opsiclientkiosk.png` holds the picture which will be loaded in this area. +

The `opsiclientkiosk.ini` defines the text and its representation which will be shown in this area.

Example:
----
[TitleLabel]
Text= Opsi Client Kiosk
FontName = Arial
FontSize = 15
FontColor = clWhite
FontBold = false
FontItalic = false
FontUnderline = false

[Tile]
width = 220
height = 200
color =  clCream
FontName = Arial
FontSize = 12
FontColor = clBlack
FontBold = false
FontItalic = false
FontUnderline = false

[TileRadio]
fontsize = 10
none_color = clBlack
uninstall_color = clRed
setup_color = clGreen
----

You will find templates for these files under `/var/lib/opsi/depot/opsi-client-agent /files/opsi/opsiclientkiosk/opsiclientkioskskin`
or `C:\Program Files(x86)\opsi.org\opsi-client-agent\opsiclientkiosk\opsiclientkioskskin`






[[opsi-manual-clientagent-ci-custom]]
===== Protect your CI changes from updates: the custom directory

(available since opsi-client-agent version 4.0.2.3)

The custom directory can be used to protect your configuration changes during opsi-client-agent updates: (`/var/lib/opsi/depot/opsi-client-agent/files/opsi/custom`). During server updates of opsi-client-agent the whole custom directory will be saved and restored after the update, so that your custom changes will persist.

* `custom/config.ini` +
Values from this config file override values from the default `cfg/config.ini`. Except of the values for `pckey` and `bootmode`, which never are picked from that file. Add to your custom config file *only* those values, that are different from the default settings.

* `custom/winstskin/*.*` +
All the files from this directory will be copied to the clients `C:\Program Files (x86)\opsi.org\opsi-client-agent\custom\winstskin` directory during installation of the opsi-client-agent on the client. This `winstskin` directory, if it exists, since opsi-winst Version 4.11.3.4. is the preferred one. It must contain all required winstskin files and configurations, for the content of the default directory is ignored.

* `custom/notifier/*.*` +
All the files from this directory will be copied to the clients `C:\Program Files (x86)\opsi.org\opsi-client-agent\notifier` directory during installation of the opsi-client-agent and overwrite the files from the server side `files/opsi/dist/notifier/` directory.

* `custom/opsiclientd.conf` +
If it exists, the `custom/opsiclientd.conf` will be copied to the clients `C:\Program Files (x86)\opsi.org\opsi-client-agent\opsiclientd` directory during installation of the opsi-client-agent and overwrites the default opsiclientd.conf from the server side `files/opsi/dist/opsiclientd/` directory. So the custom opsiclientd.conf must contain *all* the required configuration entries. +
*Attention:* +
Using a custom `opsiclientd.conf` is not recommended. To customize your client configuration, use the host parameter configuration for single features as described in the opsi-client-agent chapter. Using a custom `opsiclientd.conf` is applicable for very complex configurations only. By using a custom `opsiclientd.conf`, after each update of opsi-client-agent it is required to check the server default file  `files/opsi/dist/opsiclientd/opsiclientd.conf` for changes to be patched to your custom `opsiclientd.conf`. +
 *So: hands off this feature, unless you really know what you are doing!*

* `custom/opsiclientkioskskin/*.*` +
All the files in these directory will be copied, by the installation of an opsi-client-agent to C:\Program Files(x86)\opsi.org\opsi-client-agent\custom\opsiclientkioskskin. If available, this directory (opsiclientkioskskin) will have the preference over others.


To avoid errors by the change of rights, the following helps:

[source, prompt]
----
opsi-setup --set-rights /var/lib/opsi/depot/opsi-client-agent
----

[[opsi-manual-clientagent-loginblock]]
==== Blocking the user login with the opsi-Loginblocker

To prevent a user login before all installations are completed, opsi provides the optional '{opsi-login-blocker}'.



[[opsi-manual-clientagent-loginblock-nt5]]
===== opsi loginblocker at Windows 2000 to XP (NT 5)

The '{opsi-login-blocker}' is implemented as the 'Gina' `opsigina.dll`. 'Gina' means 'Graphical Identification and Authentication' and is the official Microsoft hook to manipulate the login process.

If you already have a special 'Gina-DLL' installed, which is different from the original Microsoft 'msgina.dll' (e.g. Novell 'nwgina.dll'), you should not install the '{opsi-login-blocker}' without consulting uib or https://forum.opsi.org. It is possible to chain different gina.dll's, but therefore the installation has to be customized. Proper chaining of Gina DLLs is a quite critical task and might result in a locked up computer if done improperly.

Whether the '{opsi-login-blocker}' is installed or not is configured by the switch 'LoginBlockerStart=on/off' in section [opsi-client-agent-install] of the client configuration.


[[opsi-manual-clientagent-loginblock-nt6]]
===== opsi loginblocker at NT 6 (Win 7 & Co)
The '{opsi-login-blocker}' at Vista is implemented as a 'credential provider filter'. It blocks all 'credential providers' until the release by the '{opsiclientd}' or timeout.

[[opsi-manual-clientagent-subsequent-installation]]
==== Subsequent installation of the opsi-client-agents
The information about the 'Subsequent installation of the opsi-client-agent' you will find in the 'opsi-getting-started' manual (Chapter 'First Steps').

[[opsi-manual-clientagent-image-installation]]
===== Installation of the opsi-client-agent from a master image or as exe

In order to install the opsi-client-agent from a prepared (sysprep) masterimage,
the opsi-client-agent has to be (re)installed while the clone awakes and get a new personality.

To do this use the following steps:

* Copy from the share `opsi_depot` the complete content of the directory `opsi-client-agent` in a temporary directory on the master.

* Edit there the file `files\opsi\cfg\config.ini` :
** In section `[installation]` set for `service_user=` the login name of a user that is member of the opsiadmin group..
** NOT RECOMMENDED: In section  `[installation]` set for `service_password=` the uncoded password of this user. Better:
** In section `[installation]` set for `service_hidden_password=` the base64 encoded password of this user. For encoding of the pawword you may use the opsi-winst function `base64EncodeStr(<string>)` or a online service like  http://www.base64encode.org/ +
If `service_hidden_password=` has any value the key `service_password=` will be ignored.
** In section `[opsiclientd]`set for `config_service.url =` the web service address of your opsi-config-server e.g.. https://192.168.1.10:4447

* Make sure that the script `silent_setup.cmd` from the temporary directory is called after the clone has its new personality.

* After the call of `silent_setup.cmd` is finished, the temporary directory should be deleted.

If you like you may pack the temporary directory to a self extracting exe with final program start using a tool like filzip.

[[opsi-manual-clientagent-systray-program]]
==== The Systray Program of the opsi-client-agent

The systray program of the 'opsi-client-agent' focuses on the following targets:

* Notifying the user in regular (and configurable) Intervals on pending Installations. (Optional)

* Notifying the user on pending Installations on demand by using the context menu.

* Possibility for the user to start the installations.

.Message window of the opsi-systray program
image::opsi-systray-message.png["Message window of the opsi-systray program",width=200]

.Context menu (right mouse click) of the opsi-systray program
image::opsi-systray-menue.png["Context menu (right mouse click) of the opsi-systray program",width=200]

*Controlling the opsi systray program via the 'opsi-client-agent' product properties:* +

* `systray_install` +
(`true` / `false`) Install the opsi systray program ? +
Default = `false`

* `systray_check_interval` +
Interval in minutes to check for pending action requests. +
Default=`180` (Small values here give heavy load to the server) +
The value `0` means: no checks at all..

* `systray_request_notify_format` +
Format of action request notification. +
Possible Values: +
"productid : request", "productname : request", "productname productversion : request" +
default: "productname : request"

*Logs of the opsi systray program:* +

The program logs to `%Appdata%\opsi.org\log`. That is the `opsi.org\log` directory in the Appdata directory of the loggedin user. +
For Example: +
`C:\Users\<username>\AppData\Roaming\opsi.org\log\`

See also Chapter 'opsi Software On Demand (Kiosk-Mode)': <<software-on-demand>>

