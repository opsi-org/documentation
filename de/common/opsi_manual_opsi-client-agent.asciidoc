////
; Copyright (c) uib gmbh (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; http://creativecommons.org/licenses/by-sa/3.0/de/
; http://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; http://creativecommons.org/licenses/by-sa/3.0/
; http://creativecommons.org/licenses/by-sa/3.0/legalcode
; 
; credits: http://www.opsi.org/credits/
////

:Author:    uib gmbh
:Email:     info@uib.de
:Date:      25.03.2011
:Revision:  4.0.1
:toclevels: 6


include::../common/opsi_terms.asciidoc[]

[[opsi-manual-clientagent]]
=== opsi-client-agent

[[opsi-manual-clientagent-overview]]
==== Überblick

Damit die Verteilung von Software nicht zur "Turnschuh-Administration" wird, muss ein Client-PC selbstständig erkennen,
dass neue Softwarepakete oder Updates für ihn bereit stehen und diese installieren.
Bei der Installation ist auf jede Form von Anwender-Interaktion zu verzichten, damit diese unbeaufsichtigt erfolgen kann
und nicht durch verunsicherte Anwender notwendige Installationen abgebrochen werden.

Diese Anforderungen werden bei opsi durch einen Agenten auf dem Client realisiert:

Auf dem Client wird der sogenannte '{opsi-client-agent}' installiert.
Dieser überprüft üblicherweise beim Start des Clients und vor dem Login des Anwenders,
anhand von Konfigurations-Informationen auf dem '{opsi-configserver}', ob für diesen Client ein Update installiert werden soll.

Soll Software installiert werden, wird das skriptgesteuerte Installationsprogramm '{opsi-winst}' gestartet.
Auf einer Dateifreigabe, dem sogenannten '{opsi-depot}', stehen die dafür notwendigen Skripte und Softwarepakete bereit.
Während dieser Zeit besteht für den Anwender keine Notwendigkeit und keine Möglichkeit in den Installationsprozess einzugreifen.

Um zu verhindern, dass sich ein Anwender vor dem Abschluss der Installation am System anmelden und so den Installations-Prozess stören kann,
wird zusätzlich der sogenannte '{opsi-login-blocker}' installiert, der eine Anmeldung erst nach Abschluss der Installationen zulässt.

Damit Softwarepakete mit dem Programm '{opsi-winst}' ohne Interaktion installiert werden können, müssen sie dafür vorbereitet werden.
Siehe dazu das Kapitel 'Einbindung eigener Software in die Softwareverteilung von opsi' im 'opsi-getting-started' Handbuch.

[[opsi-manual-clientagent-directories]]
==== Verzeichnisse des opsi-client-agent

Der '{opsi-client-agent}' installiert sich nach `%ProgramFiles%\opsi.org\opsi-client-agent`.

Dieses Verzeichnis enthält alle Programme des '{opsi-client-agent}' wie z.B. den '{opsiclientd}', die '{opsiclientd-notifier}' den '{opsi-winst}' und einige Bibliotheken. Weiterhin finden sich hier die Konfigurationsdateien und grafischen Vorlagen der genannten Programme. +
Das Verzeichnis `%ProgramFiles%\opsi.org\opsi-client-agent` ist gegen Veränderung mit Benutzerrechten geschützt. +
Das Verzeichnis `%ProgramFiles%\opsi.org\opsi-client-agent\opsiclientd` enthält die Konfigurationsdatei des '{opsiclientd}' und kann nur mit Administratorrechten gelesen werden.

Weiterhin gibt es das Verzeichnis `c:\opsi.org`.

Dieses Verzeichnis dient zur Zeit für den Installationscache (wenn gecached installiert wird -> WAN-Erweiterung). Es wird in Zukunft noch weitere Funktionen übernehmen. +
Das Verzeichnis `c:\opsi.org` kann nur mit Administratorrechten gelesen werden.

Logdateien des '{opsi-client-agent}' befinden sich unter `c:\opsi.org\log\`.



[[opsi-manual-clientagent-service]]
==== Der Service: opsiclientd

Der '{opsiclientd}' ist die Basis des '{opsi-client-agent}s'.
Er läuft als Service mit administrativen Rechten und wird beim Boot automatisch gestartet.

Wesentliche Funktionen sind:

* Eventbasierte Steuerung: Es kann auf unterschiedliche Events im System reagiert werden.
Ein Event ist zum Beispiel der Start des Betriebssystems.

* Steuerung über Webservice: Auf den Webservice des '{opsiclientd}' kann über das Netzwerk zugegriffen werden.
Diese Schnittstelle dient zum Anstoßen von Installationen ('push') aber auch zu Wartungszwecken.

* Remote Konfiguration: Alle wesentlichen Konfigurationsdaten des '{opsiclientd}' lassen sich zentral über
die '{opsi-config-object}' global oder Client-spezifisch bearbeiten.

Der '{opsi-client-agent}' besteht aus mehreren Komponenten:

* '{opsiclientd}': Der zentrale Service des '{opsi-client-agent}s'.

* '{opsiclientd-notifier}': Fenster zur Information / Kommunikation mit dem Anwender

* '{opsi-login-blocker}': Sperrt den Login bis die Installationen abgeschlossen sind.

[[opsi-manual-clientagent-installation]]
===== Installation

Im Rahmen einer Neuinstallation eines Betriebssystems per unattended Setup über opsi wird der '{opsi-client-agent}' automatisch mit installiert.

Zur Deinstallation kann der '{opsi-client-agent}' auf 'uninstall' gesetzt werden.

Zur nachträglichen Installation oder zu Reparaturzwecken siehe Kapitel  <<opsi-manual-clientagent-subsequent-installation>>.

[[opsi-manual-clientagent-opsiclientd]]
===== opsiclientd

Kernkomponente des '{opsi-client-agent}s' ist der Service '{opsiclientd}'. Dieser läuft beim Start des Betriebssystems an.

Er übernimmt folgende Aufgaben:

* Während das System bootet und der opsiclientd auf den Start der Windows GUI wartet, wird der 'block_login_notifier' ausgeführt.
Dieser zeigt standardmäßig ein Schloss in der oberen rechten Ecke des Bildschirms.

* Er baut beim Auftreten der konfigurierten Events Kontakt zum '{opsi-configserver}' auf.
Konfigurationen und anstehende '{action-requests}' werden per JSON-RPC abgefragt.
Das Standard-Event ist hierbei 'gui_startup', welches beim Start des Rechners (Start der GUI) und damit vor dem Login aktiv wird.

* Er stellt eine Named-Pipe bereit, über die der '{opsi-login-blocker}' Kontakt zu ihm aufnehmen kann,
um den Zeitpunkt der Freigabe des Logins zu erfragen. Auch diese Kommunikation erfolgt per '{json-rpc}'.

* Startet den '{opsiclientd-notifier}' zur Interaktion und Kommunikation mit dem Anwender.

* Bei Bedarf stellt er eine Verbindung zum '{opsi-depot}' her, aktualisiert die lokale Installation des '{opsi-winst}'
und startet diesen zur Bearbeitung der anstehenden '{action-requests}' (Installationen).

[[opsi-manual-clientagent-opsiclientd-notifier]]
===== opsiclientd notifier

Der '{opsiclientd-notifier}' realisiert die Interaktion mit dem Anwender.
Hier werden sowohl Statusmeldungen des '{opsiclientd}' ausgegeben als auch Dialoge, die zur Steuerung des '{opsiclientd}' dienen.
Die jeweilige Funktion und das Erscheinungsbild wird hierbei über Konfigurations-Dateien bestimmt.

Der '{opsiclientd-notifier}' kann zu unterschiedlichen Situationen und auf unterschiedliche Weise erscheinen:

blocklogin notifier::
Wird angezeigt während der '{opsi-login-blocker}' aktiv ist.

.opsiclientd blocklogin notifier
image::opsiclientd-blocklogin-notifier.png["Abbildung: opsiclientd blocklogin notifier",width=80]

event notifier::
Startet beim Auftreten eines Events, gibt Informationen zum Event-Ablauf aus und bietet die Möglichkeit,
die Bearbeitung eines Events abzubrechen.

.opsiclientd event notifier
image::opsiclientd-event-notifier.png["Abbildung: opsiclientd event notifier",width=150]

action notifier::
Wird gestartet wenn Aktionen ausgeführt werden sollen und bietet die Möglichkeit, diese zu verschieben.

.opsiclientd action notifier
image::opsiclientd-action-notifier.png["Abbildung: opsiclientd action notifier",width=150]

shutdown notifier::
Startet sobald ein Shutdown/Reboot ausgeführt werden muss und bietet die Möglichkeit, diesen zu verschieben.

.opsiclientd shutdown notifier
image::opsiclientd-shutdown-notifier.png["Abbildung: opsiclientd shutdown notifier",width=150]

CAUTION: Änderung der Benennung/Funktionalität von opsi 4.0.1 gegenüber opsi 4.0. +
Den opsi 4.0 event notifier gibt es nicht mehr. +
Der opsi 4.0.1 event notifier entspricht dem opsi 4.0 action notifier. +
Der opsi 4.0.1 action notifier ähnelt dem opsi 4.0 event notifier, wird aber nur aktiv, wenn die Bearbeitung von Aktionen ansteht.


[[opsi-manual-clientagent-loginblocker]]
===== {opsi-login-blocker}
Der '{opsi-login-blocker}' für NT5 Win2K/WinXP ist als 'GINA' implementiert ('opsigina.dll').
Diese 'GINA' wartet bis zum Abschluss der '{product-actions}' oder dem Timeout (Standard-Wert: 120 Sekunden) bei nicht erreichbarem '{opsiclientd}'.
Danach wird die Kontrolle an die nächste 'GINA' übergeben (in der Regel an die msgina.dll).

Der '{opsi-login-blocker}' für NT6 (Vista/Win7) ist als 'credential provider filter' realisiert ('OpsiLoginBlocker.dll').
Er blockiert alle 'credential provider' bis zum Abschluss der '{product-actions}' oder dem Timeout (Standard-Wert: 120 Sekunden) bei nicht erreichbarem '{opsiclientd}'.

[[opsi-manual-clientagent-event-flow]]
===== Event-Ablauf

Der Ablauf der Aktionen, die in einem Event stattfinden, ist vielfältig konfigurierbar.
Um die Konfigurations-Möglichkeiten zu verstehen, ist ein Verständnis der Ablauf-Logik notwendig.
Es folgt zunächst ein Überblick über den Ablauf eines "Standard-Events" bei dem der {opsi-configserver} gefragt wird,
ob Aktionen auszuführen sind (z.B. 'event_gui_startup').

.Ablauf eines Standard-Events
image::eventflowchsrt.png["Abbildung: Ablauf eines Standard-Events",height=400]

Die wichtigsten Parameter wirken hier wie folgt zusammen:

TIP: Tritt bei der Verbindungsaufnahme zum '{opsi-configserver}' ein Fehler auf, kann natürlich auch keine Log-Datei
zum '{opsi-configserver}' übertragen werden.
Die genaue Fehlerbeschreibung ist jedoch in der `opsiclientd.log` im Log-Verzeichnis auf dem Client festgehalten.

. Tritt ein Event ein, wird der +event_notifier_command+ ausgeführt. +
Nun wird versucht die konfigurierten '{opsi-configserver}' über deren URLs zu erreichen. +
Konnte nach +user_cancelable_after+ Sekunden keine Verbindung hergestellt werden, so wird im '{opsiclientd-notifier}'
der Button aktiviert, der das Abbrechen der Verbindungsaufnahme ermöglicht.
Sobald die Verbindung zum '{opsi-configserver}' hergestellt ist, ist ein Abbrechen nicht mehr möglich. +
Kann innerhalb von +connection_timeout+ Sekunden keine Verbindung zum '{opsi-configserver}' hergestellt werden,
so wird das laufende Event mit einem Fehler beendet.
Soll der User keine Möglichkeit zum Abbrechen haben, muss +user_cancelable_after+ auf einen Wert größer oder gleich +connection_timeout+ gesetzt werden.

. Wird der '{opsi-configserver}' erreicht, wird geprüft, ob Aktionen gesetzt sind.
Sollen Aktionen ausgeführt werden wird der +action_notifier_command+ ausgeführt. +
Dieser '{opsiclientd-notifier}' zeigt die Liste der Produkte an, für die Aktionen gesetzt sind und ist +action_warning_time+ Sekunden sichtbar.
Ist die +action_warning_time+ = 0 (Standard-Wert) wird kein +action_notifier_command+ ausgeführt. +
Zusätzlich kann dem Anwender ermöglicht werden, das Bearbeiten der Aktionen auf einen späteren Zeitpunkt zu verschieben.
Die Aktionen können hierbei +action_user_cancelable+ mal verschoben werden. +
Nach Erreichen der maximalen Abbrüche oder im Fall von +action_user_cancelable+ = 0 kann der Anwender die Aktionen nicht verhindern. +
In jedem Fall wird ein Button angezeigt, mit dem die Wartezeit abgebrochen und die Bearbeitung der Aktionen ohne weitere Verzögerung begonnen werden kann.
Der Hinweis-Text, der im '{opsiclientd-notifier}' erscheint, ist über die Option +action_message+ bzw +action_message[lang]+ konfigurierbar. +
Innerhalb dieses Textes können die Platzhalter +%action_user_cancelable%+ (Gesamtanzahl der möglichen Abbrüche)
und +%action_cancel_counter%+ (Anzahl der bereits erfolgten Abbrüche) verwendet werden. +
Wurden die Aktionen nicht vom User abgebrochen, wird der +action_cancel_counter+ zurückgesetzt und der '{opsi-winst}' startet mit deren Bearbeitung.

. Beendet sich der '{opsi-winst}' mit einer Reboot-/Shutdown-Anforderung so wird geprüft ob ein +shutdown_notifier_command+ gesetzt ist
und ob sie +shutdown_warning_time+ > 0 ist.
Sind diese Bedingungen erfüllt, wird der +shutdown_notifier_command+ ausgeführt. +
Der nun startende '{opsiclientd-notifier}' kündigt den Reboot / Shutdown an
und ist +shutdown_warning_time+ Sekunden sichtbar. +
Die maximale Anzahl, wie oft ein Reboot/Shutdown vom Benutzer verschoben werden kann, wird hierbei über +shutdown_user_cancelable+ konfiguriert. +
In jedem Fall bietet der '{opsiclientd-notifier}' die Möglichkeit, den Shutdown/Reboot sofort auszuführen. +
Bei einem Verschieben der Reboot-/Shutdown-Anforderung durch den Benutzer erscheint der '{opsiclientd-notifier}' nach +shutdown_warning_repetition_time+ Sekunden wieder. +
Der Hinweis-Text ist über +shutdown_warning_message+ bzw. +shutdown_warning_message[lang]+ konfigurierbar.
Innerhalb dieses Textes können die Platzhalter +%shutdown_user_cancelable%+ (Gesamtanzahl der möglichen Abbrüche)
und +%shutdown_cancel_counter%+ (Anzahl der bereits erfolgten Abbrüche) verwendet werden. +
Nach erfolgtem Shutdown oder Reboot wird der +shutdown_cancel_counter+ zurückgesetzt.

TIP: Der Ablauf des Event und auch die Aktionen des Benutzers sind in der Timeline auf der Info-Seite des '{opsiclientd}s' sichtbar (siehe <<opsi-manual-clientagent-infopage>>).

.Vollständiges Ablaufdiagramm eines Events
image::opsiclientd-event-processing-flow.png["Abbildung: Vollständiges Ablaufdiagramm eines Events",height=650]

[[opsi-manual-clientagent-configuration]]
===== Konfiguration

Im folgenden wird die Konfiguration des opsi-client-agent vorgestellt.

[[opsi-manual-clientagent-configuration-events]]
===== Konfiguration unterschiedlicher Events

Um den vielen unterschiedlichen Situationen gerecht zu werden, in denen der '{opsi-client-agent}' aktiv werden kann, sind die Konfigurations-Möglichkeiten vielfältig. +
In der Konfiguration des '{opsiclientd}' leitet eine Sektion in der Form +[event_<config-id>]+ eine neue Event-Konfiguration ein. +
Eine Event-Konfiguration kann über das Setzen der Option +active = false+ deaktiviert werden.
Existiert zu einem Event-Typ keine Event-Konfiguration (oder sind diese deaktiviert), wird der entsprechende Event-Typ komplett deaktiviert. +
Es gibt verschiedene Typen von Event-Konfigurationen (+type+).

* Es gibt 'Event-Konfigurations-Vorlagen' (type = template) +
Event-Konfigurationen können voneinander "erben". Ist über die Option +super+ die Id einer anderen Event-Konfiguration gesetzt,
erbt die Event-Konfiguration alle Optionen (bis auf +active+) der Parent-Konfiguration.
Geerbte Optionen können jedoch überschrieben werden. +
Das Deaktivieren von Events beeinflusst die Vererbung nicht.

* Alle weiteren Event-Konfigurationen gelten für einen gewissen Event-Typ (type). +
Verfügbare Event-Typen sind:
  - +gui startup+ +
Ein Event vom Typ +gui startup+ tritt beim Start des Clients (der GUI) auf. +
Es ist das gängigste Event und ist in der Standard-Konfiguration aktiv.

  - +custom+ +
Event-Konfigurationen vom Typ +custom+ können selbst festlegen, wann ein solches Event erzeugt wird.
Hierfür kann über die Option +wql+ ein 'WQL'-Ausdruck angegeben werden.
Sobald dieser 'WQL'-Ausdruck ein Ergebnis liefert, wird ein +custom+-Event mit der jeweiligen Konfiguration gestartet. +
Wird bei einem +custom+-Event die Option +wql+ leer angegeben, tritt dieses Event praktisch nie auf,
kann aber über die Webservice-Schnittstelle des '{opsiclientd}' bei Bedarf ausgelöst werden.

  - +user login+ +
Wird ausgelöst, wenn sich ein Benutzer am System anmeldet.

  - +timer+ +
Tritt in festen Intervallen auf (alle +interval+ Sekunden).

  - +sync completed+ +
Wird ausgelöst, wenn die Synchronisation von Konfigurationen (+sync_config_from_server+) oder von Produkten (+cache_products+) erfolgt.

  - +sw on demand+ +
Tritt auf, wenn ein Benutzer bei Verwendung des 'Software-On-Demand-Moduls' 'Aktionen sofort ausführen' wählt.

* Es gibt 'Preconditions' (Vorbedingungen) +
'Preconditions' geben bestimmte Systemzustände vor (z.B. ob gerade ein Benutzer am System angemeldet ist).
In der Konfiguration des '{opsiclientd}' leitet eine Sektion in der Form +[precondition_<precondition-id>]+ die Deklaration einer 'Precondition' ein.
Eine 'Precondition' ist dann erfüllt, wenn alle angegebenen Optionen erfüllt sind.
Eine nicht angegebene Option gilt hierbei als erfüllt.
Mögliche Optionen für 'Preconditions' sind:
  - +user_logged_in+: ist erfüllt, wenn ein Benutzer am System angemeldet ist.
  - +config_cached+: ist erfüllt, wenn das Cachen von Konfigurationen abgeschlossen ist (siehe: +sync_config_from_server+).
  - +products_cached+: ist erfüllt, wenn das Cachen von Produkten abgeschlossen ist (siehe: +cache_products+).

* Einer Event-Konfiguration kann eine 'Precondition' zugewiesen werden. +
Einer Event-Konfiguration kann eine 'Precondition' zugewiesen werden, indem diese bei der Deklaration in geschweiften Klammern angegeben wird (z.B. +[event_on_demand{user_logged_in}]+). +
Zu einer Event-Konfiguration mit 'Precondition' muss immer eine entsprechende Event-Konfiguration ohne 'Precondition' existieren.
Existiert z.B. eine Event-Konfiguration +event_on_demand{user_logged_in}+ muss auch die Event-Konfiguration +event_on_demand+ existieren!
Hierbei erbt die Event-Konfiguration mit 'Precondition' automatisch von der Event-Konfiguration ohne 'Precondition'. +
Beim Auftreten eines Events wird nun entschieden welche 'Preconditions' erfüllt sind.
Ist keine der 'Preconditions' erfüllt, gilt die Event-Konfiguration ohne 'Precondition'.
Ist eine der 'Preconditions' erfüllt, gilt die Event-Konfiguration die mit dieser 'Precondition' verknüpft ist.
Sind mehrere 'Preconditions' erfüllt, so wird die 'Precondition' bevorzugt, die am genauesten definiert ist (die meisten Optionen besitzt).


Ein Beispiel zur Erläuterung: +
Im Rahmen einer Installation kann es notwendig sein den Rechner zu rebooten.
Ist gerade ein Benutzer am System angemeldet, sollte dieser über den anstehenden Reboot informiert werden.
Hierbei ist eine angemessene Wartezeit vor dem Ausführen des Reboots angebracht.
Zusätzlich kann es sinnvoll sein, dem Benutzer die Entscheidung zu überlassen, ob der Reboot besser zu einem späteren Zeitpunkt ausgeführt werden soll. +
Ist zum Zeitpunkt des benötigten Reboots jedoch kein Benutzer angemeldet, ist es sinnvoll, den Reboot ohne weitere Wartezeit sofort durchzuführen. +
Dieses Problem wird am Beispiel von +event_on_demand+ wie folgt konfiguriert:

* Es wird eine 'Precondition' +user_logged_in+ definiert, die erfüllt ist, wenn ein Benutzer am System angemeldet ist (+user_logged_in = true+).

* In der Event-Konfiguration +event_on_demand+ (ohne 'Precondition') wird +shutdown_warning_time = 0+ gesetzt (sofortiger Reboot ohne Meldung).

* In der Event-Konfiguration +event_on_demand\{user_logged_in\}+ wird +shutdown_warning_time = 300+ gesetzt (300 Sekunden Vorwarnzeit).

[[opsi-407-releasenotes-clientagent-configuration-proxysupport]]
===== Proxysupport-Konfiguration

In der global-Sektion von der opsiclientd.conf gibt es jetzt die Möglichkeit, den opsi-client-agent einen Proxyserver mit zu konfigurieren.
Wenn ein Proxy konfiguriert wurde, werden alle HTTP- und HTTPS-Verbindungen vom opsiclientd über diesen Proxy umgeleitet.

[source,ini]
----
# Use a proxy for connecting configservice
# proxy_mode:
#   'system' will try to check the system setting,
#   'static' to use proxyurl from configfile/hostparameter
# proxy_url usage: http://<user>:<password>@<proxy-url>:<proxy-port>
# Example: http://proxyuser:proxypass123@proxy.domain.local:8080
proxy_mode = static
proxy_url =
----

Die Proxyeinstellungen erlauben auch einen Proxy zu benutzen, der eine Authentifizierung erfordert. Dazu muss die Proxy_url wie oben im Beispiel angegeben werden.

WARNING: Der proxy_mode ist vorgesehen, dass bei der Einstellung system, der proxy aus dem laufenden Client-System ausgelesen werden. Dies ist im Moment nicht implementiert, deshalb funktioniert momentan nur die Einstellung 'static'.

[[opsi-407-releasenotes-clientagent-configuration-eventcontrol_over_productgroups]]
===== Steuerung der Produkte die ausgeführt werden pro Event

Mit diesem neuen Feature ist es über die Konfiguration möglich, die Liste der ab zu bearbeitenden Produkte über Produktgruppen zu steuern.

Dazu gibt es Grundsätzlich zwei Vorgehensweise:

Blacklisting (Ausschliessen):

Mit der Option `exclude_product_group_ids` kann man nun eine Kommaseparierte Liste von Produktgruppen-Ids mitgeben, dessen Mitglieder vom aktuellen Event ausgeschlossen werden. Auch wenn Sie eigentich auf setup stehen. Diese Produkte werden zwar ignoriert, aber bleiben auf setup stehen.

Whitelisting (Liste von Produkten ausschliesslich freigeben):

Mit der Option `include_product_group_ids`kann man nun eine Kommaseparierte Liste von Produktgruppen-Ids festlegen, dessen Mitglieder überhaupt bearbeitet werden dürfen, vorausgesetzt Sie eine Aktion ist auch gesetzt.

Diese Einstellung kann man entweder Global im Default-Event angeben, damit das für jedes Event gilt. Man kann diese Optionen aber auch Zum Beispiel nur im Event_on_demand einsetzen, somit kann man Pakete die auf setup stehen von Push-Installationen ausschliessen, obwohl Sie auf setup stehen. Bei einem normalen Neustarts des Clients mit gui_startup (default) würden diese ausgeschlossenen Pakete trotzdem auf dem Client installiert werden.

CAUTION: Für Clients, die das Modul WAN/VPN aktiviert haben, muss man diese Optionen neben dem Sync-Event auch in der CacheService-Sektion mit aufgenommen werden, da der CacheService zwar vom Sync-Event getriggert wird, aber selbst keinen Zugriff auf das sync-Event hat.

WARNING: Produktabhängigkeiten werden bei diesem Feature nicht berücksichtigt. Bitte achten Sie darauf, dass Sie bei der Konfiguration keine Abhängigkeiten ausser Kraft setzen.


[[opsi-manual-clientagent-configuration-file]]
===== Konfiguration über die Konfigurationsdatei

Die Konfigurationsdatei ist: +
`c:\program files\opsi.org\opsi-client-agent\opsiclientd\opsiclientd.conf`

CAUTION: Diese Konfigurationsdatei ist UTF-8 kodiert. +
Änderungen mit Editoren, die diese Kodierung nicht beherrschen (z.B. notepad.exe), zerstören die Umlaute in dieser Datei.

Die hier festgelegte Konfiguration kann nach erfolgreicher Verbindung zum '{opsi-configserver}' durch die dort festgelegte '{opsi-config-object}' überschrieben werden.
Beispiel `opsiclientd.conf`:
[source,ini]
----
; = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
; =     configuration file for opsiclientd                              =
; = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =


; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
; -     global settings                                                 -
; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[global]

# Location of the log file.
log_file = c:\\opsi.org\\log\\opsiclientd.log

# Set the log (verbosity) level
# (0 <= log level <= 9)
# 0: nothing, 1: essential, 2: critical, 3: errors, 4: warnings, 5: notices
# 6: infos, 7: debug messages, 8: more debug messages, 9: passwords
log_level = 4

# Client id.
host_id = 

# Opsi host key.
opsi_host_key = 

# Verify opsi server certs
verify_server_cert = false

# Verify opsi server certs by ca
verify_server_cert_by_ca = false

# On every daemon startup the user login gets blocked
# If the gui starts up and no events are being processed the login gets unblocked
# If no gui startup is noticed after <wait_for_gui_timeout> the login gets unblocked
# Set to 0 to wait forever
wait_for_gui_timeout = 120

# Application to run while blocking login
block_login_notifier = %global.base_dir%\\notifier.exe -s notifier\\block_login.ini

# Use a proxy for connecting configservice
# proxy_mode:
#   'system' will try to check the system setting,
#   'static' to use proxyurl from configfile/hostparameter
# proxy_url usage: http://<user>:<password>@<proxy-url>:<proxy-port>
# Example: http://proxyuser:proxypass123@proxy.domain.local:8080
proxy_mode = static
proxy_url =

; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
; -     config service settings                                         -
; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[config_service]
# Service url.
# http(s)://<opsi config server address>:<port>/rpc
url = https://opsi.uib.local:4447/rpc

# Conection timeout.
connection_timeout = 30

# The time in seconds after which the user can cancel the connection establishment
user_cancelable_after = 30

# If this option is set, the local system time will be synced with time from service
sync_time_from_service = false

; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
; -     depot server settings                                           -
; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[depot_server]

# Depot server id
depot_id =

# Depot url.
# smb://<depot address>/<share name>/<path to products>
url =

# Local depot drive
drive =

# Username that is used for network connection [domain\]<username>
username = pcpatch

; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
; -     cache service settings                                          -
; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[cache_service]
# Maximum product cache size in bytes
product_cache_max_size = 5000000000
# Members of this ProductGroups will be excluded from processing
exclude_product_group_ids = 
# Only members of this ProductGroups will be excluded from processing
include_product_group_ids =

; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
; -     control server settings                                         -
; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[control_server]

# The network interfaces to bind to.
# This must be the IP address of an network interface.
# Use 0.0.0.0 to listen to all interfaces
interface = 0.0.0.0

# The port where opsiclientd will listen for HTTPS rpc requests.
port = 4441

# The location of the server certificate.
ssl_server_cert_file = %global.base_dir%\\opsiclientd\\opsiclientd.pem

# The location of the server private key
ssl_server_key_file = %global.base_dir%\\opsiclientd\\opsiclientd.pem

# The location of the static files
static_dir = %global.base_dir%\\opsiclientd\\static_html

# The maximum number of authentication failures before a client ip
# is blocked for an amount of time.
max_authentication_failures = 5

; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
; -     notification server settings                                    -
; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[notification_server]

# The network interfaces to bind to.
# This must be the IP address of an network interface.
# Use 0.0.0.0 to listen to all interfaces
interface = 127.0.0.1

# The first port where opsiclientd will listen for notification clients.
start_port = 44000

# Port for popup notification server
popup_port = 45000

; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
; -     opsiclientd notifier settings                                   -
; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[opsiclientd_notifier]

# Notifier application command
command = %global.base_dir%\\notifier.exe -p %port% -i %id%

; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
; -     opsiclientd rpc tool settings                                   -
; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[opsiclientd_rpc]

# RPC tool command
command = %global.base_dir%\\opsiclientd_rpc.exe "%global.host_id%" "%global.opsi_host_key%" "%control_server.port%"

; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
; -     action processor settings                                       -
; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[action_processor]
# Locations of action processor
local_dir = %global.base_dir%\\opsi-winst
remote_dir = opsi-winst\\files\\opsi-winst
filename = winst32.exe

# Action processor command
command = "%action_processor.local_dir%\\%action_processor.filename%" /opsiservice "%service_url%" /clientid %global.host_id% /username %global.host_id% /password %global.opsi_host_key%

# Load profile / environment of %run_as_user%
create_environment = false

; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
; -     events                                                          -
; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[event_default]
; === Event configuration
# Type of the event (string)
type = template
# Interval for timer events in seconds (int)
interval = -1
# Maximum number of event repetitions after which the event will be deactivated (int, -1 = forever)
max_repetitions = -1
# Time in seconds to wait before event becomes active (int, 0 to disable delay)
activation_delay = 0
# Time in seconds to wait before an event will be fired (int, 0 to disable delay)
notification_delay = 0
# Event notifier command (string)
event_notifier_command = %opsiclientd_notifier.command% -s notifier\\event.ini
# The desktop on which the event notifier will be shown on (current/default/winlogon)
event_notifier_desktop = current
# Block login while event is been executed (bool)
block_login = false
# Lock workstation on event occurrence (bool)
lock_workstation = false
# Logoff the current logged in user on event occurrence (bool)
logoff_current_user = false
# Get config settings from service (bool)
get_config_from_service = true
# Store config settings in config file (bool)
update_config_file = true
# Transmit log file to opsi service after the event processing has finished (bool)
write_log_to_service = true
# Shutdown machine after action processing has finished (bool)
shutdown = false
# Reboot machine after action processing has finished (bool)
reboot = false
# Members of this ProductGroups will be excluded from processing
exclude_product_group_ids = 
# Only members of this ProductGroups will be excluded from processing
include_product_group_ids = 

; === Sync/cache settings
# Sync configuration from local config cache to server (bool)
sync_config_to_server = false
# Sync configuration from server to local config cache (bool)
sync_config_from_server = false
# Sync configuration from local config cache to server after action processing (bool)
post_sync_config_to_server = false
# Sync configuration from server to local config cache after action processing (bool)
post_sync_config_from_server = false
# Work on local config cache
use_cached_config = false
# Cache products for which actions should be executed in local depot cache (bool)
cache_products = false
# Maximum transfer rate when caching products in byte/s (int, 0 = no limit)
cache_max_bandwidth = 0
# Dynamically adapt bandwith to other network traffic (bool)
cache_dynamic_bandwidth = false
# Work on local depot cache
use_cached_products = false

; === Action notification (if product actions should be processed)
# Time in seconds for how long the action notification is shown (int, 0 to disable)
action_warning_time = 0
# Action notifier command (string)
action_notifier_command = %opsiclientd_notifier.command% -s notifier\\action.ini
# The desktop on which the action notifier will be shown on (current/default/winlogon)
action_notifier_desktop = current
# Message shown in the action notifier window (string)
action_message = Starting to process product actions. You are allowed to cancel this event a total of %action_user_cancelable% time(s). The event was already canceled %state.action_processing_cancel_counter% time(s).
# German translation (string)
action_message[de] = Starte die Bearbeitung von Produkt-Aktionen. Sie können diese Aktion insgesamt %action_user_cancelable% mal abbrechen. Die Aktion wurde bereits %state.action_processing_cancel_counter% mal abgebrochen.
# French translation (string)
action_message[fr] = Traitement des actions du produit. Vous êtes autorisé à annuler cet événement un total de %action_user_cancelable% fois. L'événement a été déjà annulée %state.action_processing_cancel_counter% fois.
# Number of times the user is allowed to cancel the execution of actions (int)
action_user_cancelable = 0

; === Action processing
# Should action be processed by action processor (bool)
process_actions = true
# Type of action processing (default/login)
action_type = default
# Update the action processor from server before starting it (bool)
update_action_processor = true
# Command which should be executed before start of action processor
pre_action_processor_command =
# Action processor command (string)
action_processor_command = %action_processor.command%
# The desktop on which the action processor command will be started on (current/default/winlogon)
action_processor_desktop = current
# Action processor timout in seconds (int)
action_processor_timeout = 10800
# Command which should be executed before after action processor has ended
post_action_processor_command =

; === Shutdown notification (if machine should be shut down or rebooted)
# Process shutdown requests from action processor
process_shutdown_requests = true
# Time in seconds for how long the shutdown notification is shown (int, 0 to disable)
shutdown_warning_time = 0
# Shutdown notifier command (string)
shutdown_notifier_command = %opsiclientd_notifier.command% -s notifier\\shutdown.ini
# The desktop on which the action notifier will be shown on (current/default/winlogon)
shutdown_notifier_desktop = current
# Message shown in the shutdown notifier window (string)
shutdown_warning_message = A reboot is required to complete software installation tasks. You are allowed to delay this reboot a total of %shutdown_user_cancelable% time(s). The reboot was already delayed %state.shutdown_cancel_counter% time(s).
# German translation (string)
shutdown_warning_message[de] = Ein Neustart wird benötigt um die Software-Installationen abzuschliessen. Sie können diesen Neustart insgesamt %shutdown_user_cancelable% mal verschieben. Der Neustart wurde bereits %state.shutdown_cancel_counter% mal verschoben.
# French translation (string)
shutdown_warning_message[fr] = Un redémarrage est nécessaire pour terminer l'installation du logiciel. Vous êtes autorisé à retarder le redémarrage un total de %shutdown_user_cancelable% fois. Le redémarrage a été déjà retardé %state.shutdown_cancel_counter% fois.
# Number of times the user is allowed to cancel the shutdown (int)
shutdown_user_cancelable = 0
# Time in seconds after the shutdown notification will be shown again after the user has canceled the shutdown (int)
shutdown_warning_repetition_time = 3600

[event_gui_startup]
super = default
type = gui startup
name = gui_startup
block_login = true

[event_gui_startup{user_logged_in}]
name = gui_startup
shutdown_warning_time = 300
block_login = false

[event_gui_startup{cache_ready}]
use_cached_config = true
use_cached_products = true
action_user_cancelable = 3
action_warning_time = 60

[event_gui_startup{installation_pending}]
name = gui_startup
active = true

[event_on_demand]
super = default
type = custom
name = on_demand

[event_on_demand{user_logged_in}]
name = on_demand
shutdown_warning_time = 300

[event_software_on_demand]
super = default
type = sw on demand

[event_sync]
super = default
type = template
process_actions = false
event_notifier_command = 
sync_config_to_server = true
sync_config_from_server = true
cache_products = true
cache_dynamic_bandwidth = true

[event_timer]
super = sync
type = timer
active = false
interval = 3600

[event_net_connection]
super = sync
type = custom
active = false
wql = SELECT * FROM __InstanceModificationEvent WITHIN 2 WHERE TargetInstance ISA 'Win32_NetworkAdapter' AND TargetInstance.NetConnectionStatus = 2

[event_sync_completed]
super = default
type = sync completed
event_notifier_command = 
process_actions = false
get_config_from_service = false
write_log_to_service = false

[event_sync_completed{cache_ready_user_logged_in}]
reboot = true
shutdown_user_cancelable = 10
shutdown_warning_time = 300

[event_sync_completed{cache_ready}]
reboot = true

[event_user_login]
super = default
type = user login
action_type = login
active = false
action_message = Starting to process user login actions.
action_message[de] = Beginne mit der Verarbeitung der Benutzer-Anmeldungs-Aktionen.
action_message[fr] = Traitement des actions à la connexion de l'utilisateur.
block_login = false
process_shutdown_requests = false
get_config_from_service = false
update_config_file = false
write_log_to_service = false
update_action_processor = true
event_notifier_command = %opsiclientd_notifier.command% -s notifier\\userlogin.ini
event_notifier_desktop = default
action_processor_command = %action_processor.command% /sessionid %service_session% /allloginscripts /silent
action_processor_desktop = default
action_processor_timeout = 300

[event_on_shutdown]
super = default
type = custom
name = on_shutdown
active = False

[event_on_shutdown{installation_pending}]
name = on_shutdown
active = False

[event_silent_install]
super = default
type = custom
name = silent_install
event_notifier_command =
process_shutdown_requests = false
action_processor_productIds = swaudit,hwaudit
action_processor_command = %action_processor.command% /productlist %action_processor_productIds% /silent
action_processor_desktop = winlogon
action_processor_timeout = 300

[event_timer_silentinstall]
super = silent_install
type = timer
active = false
interval = 21600

[precondition_user_logged_in]
user_logged_in = true

[precondition_cache_ready]
config_cached = true
products_cached = true

[precondition_cache_ready_user_logged_in]
user_logged_in = true
config_cached = true
products_cached = true

[precondition_installation_pending]
installation_pending = true
----

[[opsi-manual-clientagent-configuration-webservice]]
===== Konfiguration über den Webservice ({opsi-config-object})

Die Konfiguration kann auch zentral gesteuert werden. Hierzu dienen Einträge in der '{opsi-config-object}' des '{opsi-configserver}s'.

Diese Einträge müssen dem folgenden Muster folgen: +
`opsiclientd.<name der section>.<name der option>`

Ein Beispiel: +
`opsiclientd.event_gui_startup.action_warning_time = 20` +
setzt in der Konfigurationsdatei `opsiclientd.conf` in der Sektion +[event_gui_startup]+ den Wert von +action_warning_time+ auf 20.

Die folgende Abbildung zeigt, wie diese Werte als Defaults für alle Clients über den '{opsi-configed}' gesetzt werden können.

.Serverweite Konfiguration des {opsiclientd} über den {opsi-configed}
image::opsiclientd-configuration-via-configed-serverdefault.png["Abbildung: Serverweite Konfiguration des {opsiclientd} über den {opsi-configed}",width=400]

Hier kann über das Kontextmenü +Property hinzufügen+ ein neuer Wert gesetzt werden.

Um einen {opsi-config-object} zu löschen, verwenden Sie das Werkzeug '{opsi-admin}'.
Beispiel:
[source,prompt]
----
opsi-admin -d method config_delete "opsiclientd.event_gui_startup.action_warning_time"
----

Eine Client-spezifische Änderung über den '{opsi-configed}' führen Sie über den 'Hosts-Parameter' Tab in der Client-Konfiguration aus.
Um Client-spezifische Einträge zu löschen, verwenden Sie das Werkzeug '{opsi-admin}'.
Beispiel:
[source,prompt]
----
@opsi-admin> method configState_delete "opsiclientd.event_gui_startup.action_warning_time" "myclient.uib.local"
----

.Client-spezifische Konfiguration des {opsiclientd} über den {opsi-configed}
image::opsiclientd-configuration-via-configed.png["Abbildung: Client spezifische Konfiguration des {opsiclientd} über den {opsi-configed}",width=400]


[[opsi-manual-clientagent-logging]]
===== Logging

Die Log-Datei des '{opsiclientd}' ist standardmäßig `c:\opsi.org\log\opsiclientd.log`.

Die Log-Informationen werden auch an den '{opsi-configserver}' übertragen.
Dort liegen sie unter '/var/log/opsi/clientconnect/<ip-bzw.-name-des-clients>.log'.
Sie sind auch im '{opsi-configed}' über Logdateien => Clientconnect einsehbar.

Jede Zeile in der Logdatei folgt dem Muster: +
+[<log level>] [<datum zeit>] [Quelle der Meldung] Meldung   (Quellcode-Datei|Zeilennummer).+

Dabei gibt es die folgenden Log-Level:
....
# Set the log (verbosity) level
# (0 <= log level <= 9)
# 0: nothing, 1: essential, 2: critical, 3: errors, 4: warnings, 5: notices
# 6: infos, 7: debug messages, 8: more debug messages, 9: passwords
....

Beispiel:
[source,opsilog]
----
(...)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] Event config 'sync_completed{cache_ready}' added to event generator 'sync_completed'   (Events.pyo|1107)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] Event config 'gui_startup' added to event generator 'gui_startup'   (Events.pyo|1107)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] Event config 'gui_startup{cache_ready}' added to event generator 'gui_startup'   (Events.pyo|1107)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] Event config 'on_demand' added to event generator 'on_demand'   (Events.pyo|1107)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] Event config 'sync_completed{cache_ready_user_logged_in}' added to event generator 'sync_completed'   (Events.pyo|1107)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] Event config 'gui_startup{user_logged_in}' added to event generator 'gui_startup'   (Events.pyo|1107)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] Event config 'sync_completed' added to event generator 'sync_completed'   (Events.pyo|1107)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] Event config 'software_on_demand' added to event generator 'software_on_demand'   (Events.pyo|1107)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] Event config 'on_demand{user_logged_in}' added to event generator 'on_demand'   (Events.pyo|1107)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] Updating config file: 'C:\Program Files (x86)\opsi.org\opsi-client-agent\opsiclientd\opsiclientd.conf'   (Config.pyo|287)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] No need to write config file 'C:\Program Files (x86)\opsi.org\opsi-client-agent\opsiclientd\opsiclientd.conf', config file is up to date   (Config.pyo|318)
[5] [Mar 22 10:17:46] [ event processing gui_startup  ] No product action requests set   (EventProcessing.pyo|591)
[5] [Mar 22 10:17:49] [ event processing gui_startup  ] Writing log to service   (EventProcessing.pyo|247)
[6] [Mar 22 10:17:49] [ opsiclientd                   ] shutdownRequested: 0   (Windows.pyo|340)
[6] [Mar 22 10:17:49] [ opsiclientd                   ] rebootRequested: 0   (Windows.pyo|326)
[5] [Mar 22 10:17:49] [ opsiclientd                   ] Block login now set to 'False'   (Opsiclientd.pyo|111)
[6] [Mar 22 10:17:49] [ opsiclientd                   ] Terminating block login notifier app (pid 1620)   (Opsiclientd.pyo|148)
[6] [Mar 22 10:17:49] [ event processing gui_startup  ] Stopping notification server   (EventProcessing.pyo|225)
[6] [Mar 22 10:17:51] [ control server                ] client connection lost   (Message.pyo|464)
[6] [Mar 22 10:17:52] [ event processing gui_startup  ] Notification server stopped   (Message.pyo|651)
[5] [Mar 22 10:17:52] [ event processing gui_startup  ] ============= EventProcessingThread for event 'gui_startup' ended =============   (EventProcessing.pyo|1172)
[5] [Mar 22 10:17:52] [ opsiclientd                   ] Done processing event '<ocdlib.Events.GUIStartupEvent object at 0x023CE330>'   (Opsiclientd.pyo|405)
[5] [Mar 22 10:19:41] [ opsiclientd                   ] Session 'HSzMB1wtOiBS6vHl7mh3ro5r6s3TanFu' from ip '127.0.0.1', application 'opsi jsonrpc module version 4.0.1' expired after 120 seconds   (Session.pyo|184)
[6] [Mar 22 10:19:41] [ opsiclientd                   ] Session timer <_Timer(Thread-20, started daemon 2636)> canceled   (Session.pyo|120)
[5] [Mar 22 10:19:41] [ opsiclientd                   ] Session 'HSzMB1wtOiBS6vHl7mh3ro5r6s3TanFu' from ip '127.0.0.1', application 'opsi jsonrpc module version 4.0.1' deleted   (Session.pyo|207)
[6] [Mar 22 10:27:55] [ control pipe                  ] Creating pipe \\.\pipe\opsiclientd   (ControlPipe.pyo|253)
[5] [Mar 22 10:27:55] [ event generator wait_for_gui  ] -----> Executing: getBlockLogin()   (JsonRpc.pyo|123)
[5] [Mar 22 10:27:55] [ opsiclientd                   ] rpc getBlockLogin: blockLogin is 'False'   (ControlPipe.pyo|428)
[6] [Mar 22 10:27:55] [ event generator wait_for_gui  ] Got result   (JsonRpc.pyo|131)
'
----


Die Log-Datei des '{opsi-login-blocker}s' befindet sich unter NT6 (Vista/Win7) als auch unter NT5 (Win2k/WinXP) in `C:\opsi.org\log\opsi_loginblocker.log`.

[[opsi-manual-clientagent-infopage]]
===== {opsiclientd} infopage

Da bei den Abläufen im '{opsiclientd}' vielfältige Komponenten zusammenwirken, welche zum Teil gleichzeitig aktiv sind, wird die Logdatei leicht unübersichtlich.

Daher verfügt der '{opsiclientd}' über eine eigene 'infopage' welche die Abläufe auf einer Zeitachse grafisch darstellt.
Diese 'infopage' kann mit dem Browser über die URL https://<adresse-des-clients>:4441/info.html aufgerufen werden.

.Info-Page des {opsiclientd} nach einer Push-Installation mit aktiviertem Produkt-Caching
image::opsiclientd_infopage_event_on_demand.png["Abbildung: Info-Page des {opsiclientd} nach einer Push-Installation mit aktiviertem Produkt-Caching",width=400]

[[opsi-manual-clientagent-control]]
===== Fernsteuerung des {opsi-client-agent}

Der '{opsiclientd}' verfügt über eine Webservice-Schnittstelle.
Diese ermöglicht es, dem {opsi-client-agent} Anweisungen zu übermitteln und Vieles mehr.
Sie lassen sich momentan grob in drei Bereiche aufteilen:

* Nachrichten (Popup) versenden

* 'Push'-Installationen durch auslösen von Events (z.B. 'on_demand')

* Sonstige Wartungsarbeiten

Dies kann auch auf der Kommandozeile mittels Aufrufs einer 'hostControlSafe_*'-Methode über '{opsi-admin}' geschehen.
Bei Verwendung der 'hostControlSafe_*'-Methoden +
`opsi-admin -d method hostControlSafe_xx *hostIds` kann der Parameter +*hostIds+

* sein `["*"]`, dann gilt der Aufruf für alle Clients

* einen Client enthalten (z.B. "myclient.uib.local")

* eine Liste von Clients enthalten ["<client1>", "<client2>", ...]
+
z.B. ["client1.uib.local", "client2.uib.local"]

* eine Wildcard enthalten, wobei +*+ als Platzhalter dient
+
z.B. "client.\*" oder "\*.uib.*"

Werden Rechner nicht erreicht (z.B. weil sie aus sind), wird für diese Rechner eine Fehlermeldung ausgegeben.

[[opsi-manual-clientagent-control-messages]]
===== Nachrichten per Popup senden

Über den '{opsi-configed}' lassen sich Nachrichten an einen oder mehrere Clients versenden.

Siehe dazu Kapitel <<opsi-manual-configed-client-editing-send-message>>

Auf der Kommandozeile lässt sich dies ebenfalls mittels '{opsi-admin}' durchführen:
[source,prompt]
----
opsi-admin -d method hostControlSafe_showPopup message *hostid
----

Beispiel:
[source,prompt]
----
opsi-admin -d method hostControlSafe_showPopup "Ein Text..." "myclient.uib.local"
----

[[opsi-manual-clientagent-control-fire-event]]
===== 'Push'-Installationen: Event 'on demand' auslösen

Vom '{opsi-server}' aus kann der Client aufgefordert werden, die gesetzten '{product-actions}' auszuführen.

Das Auslösen des Events kann vom '{opsi-configed}' aus erfolgen.
<<opsi-manual-configed-client-editing-ondemand>>

Auf der Kommandozeile lässt sich dies ebenfalls mittels '{opsi-admin}' durchführen:
[source,prompt]
----
opsi-admin -d method hostControlSafe_fireEvent event *hostIds
----

Beispiel:
[source,prompt]
----
opsi-admin -d method hostControlSafe_fireEvent "on_demand" "myclient.uib.local"
----

[[opsi-manual-clientagent-control-misc]]
===== Sonstige Wartungsarbeiten (shutdown, reboot, ...)

Über den Webservice des '{opsiclientd}' ist es möglich, steuernd auf den '{opsi-client-agent}' einzuwirken.
Dazu muss man sich an diesem Webservice authentifizieren.
Dies geschieht entweder mittels des lokalen Administrator-Accounts (ein leeres Passwort ist unzulässig)
oder mittels der '{opsi-host-id}' (FQDN / vollständiger Host-Name inkl. DNS-Domain) als Benutzername und des '{opsi-host-key}s' als Passwort.

Vom '{opsi-configed}' aus geht dies über das Menü 'OpsiClient' oder aus dem Kontextmenü des 'Client'-Tabs.

.Webservice des {opsiclientd}
image::opsiclientd-control-server-web-interface.png["Abbildung: Webservice des {opsiclientd}",width=400]

Auch auf der Kommandozeile gibt es hierfür Entsprechungen:

shutdown:
[source,prompt]
----
opsi-admin -d method hostControlSafe_shutdown [hostIds]
----

reboot:
[source,prompt]
----
opsi-admin -d method hostControlSafe_reboot [hostIds]
----

[[opsi-manual-clientagent-ci]]
==== Anpassen des opsi-client-agent an Corporate Identity (CI)

Die Anpassung des Erscheinungsbildes des '{opsi-client-agent}' kann insbesondere bei der Einführung erheblich zur Akzeptanz beitragen. So kann z.B. durch das Einfügen eines bekannten Firmenlogos in die Hintergrundgrafiken eine Verunsicherung der Anwender vermieden werden.

Seit opsi-client-agent 4.0.7.16 basieren alle graphischen Komponenten des opsi-client-agent (notifier, opsi-script, kiosk-client) auf den Darstellungskomponenten zum Anzeigen von Grafiken und werden auf die selbe Weise angepasst.
Farben können auf drei unterschiedliche Weise angegeben werden: Als symbolischer Name (clRed), als Hexadezimalwert ($FF00FF) oder als rgb Wertliste ((255,0,0)).
Ein Hilfsprogramm zur Auswahl von Farben und deren richtigen Schreibweise finden Sie unter http://download.uib.de/opsi40/helper/opsi-colorchooser.exe

Als Hintergrund Grafikformate kommt eine Vielzahl unterschiedlicher Bitmap Formate wie .bmp, .png, jpeg usw in Frage. All dies Formate sind wieder Containerformate, dh. z.B. PNG ist nicht unbeding gleich PNG. Evtl ist das eine Darstellbar und das andere nicht.
Ein Hilfsprogramm mit dem Sie schnell prüfen können ob eine gegeben Bitmap Grafik korrekt angezeigt werden wird, finden Sie unter http://download.uib.de/opsi40/helper/opsi-bitmapviwer.exe

[[opsi-manual-clientagent-ci-winst]]
===== Anzupassende Elemente: opsi-winst
Die Dateien die Sie beim opsi-winst anpassen können finden Sie im Verzeichnis `/var/lib/opsi/depot/opsi-client-agent/files/opsi/opsi-winst/winstskin`:

* `bg.png` +
Die Default Hintergrundgrafik des '{opsi-winst}' in welche dann zur Laufzeit Textmeldungen und Produktlogos eingeblendet werden. Der Name kann in der Datei `skin.ini` angepasst werden.

* `skin.ini` +
Die Konfigurationsdatei in der festgelegt ist, an welcher Stelle, mit welchem Font und Farbe Textmeldungen eingeblendet werden.

[[opsi-manual-clientagent-ci-opsiclientd]]
===== Anzupassende Elemente: opsiclientd
Im Verzeichnis
`/var/lib/opsi/depot/opsi-client-agent/files/opsi/dist/notifier`
finden sich die Dateien welche das Erscheinungsbild der unterschiedlichen Notifier bestimmen. Dabei gibt es für jeden Notifier eine Bild- und eine Konfigurationsdatei:

* `block_login.bmp` +
Hintergrundbild des notifiers der einen aktiven Loginblocker anzeigt.
* `block_login.ini` +
Konfigurationsdatei des Loginblocker notifiers.
* `event.bmp` +
Hintergrundbild des notifiers der einen aktives Event mit Connection zum opsi-server anzeigt.
* `event.ini` +
Konfigurationsdatei des Event notifiers.
* `action.bmp` +
Hintergrundbild des notifiers der eine anstehende Aktion (Softwareinstallation) anzeigt.
* `action.ini` +
Konfigurationsdatei des Action notifiers.
* `shutdown.bmp` +
Hintergrundbild des notifiers der einen anstehenden Shutdown oder Reboot anzeigt.
* `shutdown.ini` +
Konfigurationsdatei des Shutdown notifiers.
* `popup.bmp` +
Hintergrundbild des notifiers der eine vom Server gesendete Popup Nachricht anzeigt.
* `popup.ini` +
Konfigurationsdatei des Popup notifiers.
* `userlogin.bmp` +
Hintergrundbild des notifiers der ein aktives userlogin Event anzeigt.
* `userlogin.ini` +
Konfigurationsdatei des UserLogin notifiers.

[[opsi-manual-clientagent-ci-kioskclient]]
===== Anzupassende Elemente: kioskclient

Zum Kioskclient siehe auch: <<software-on-demand>>

Die Headerleiste des Hauptfensters (1) ist Kunden spezifisch anpassbar.
Dabei spielen zwei Dateien eine Rolle:

* `opsiclientkiosk.png`
* `opsiclientkiosk.ini`

Die `opsiclientkiosk.png` enthält das Bild welches in diesen Bereich geladen wird. +

Die `opsiclientkiosk.ini` definiert den Text und dessen Darstellung die in diesem Bereich angezeigt wird.

Beispiel:

----
[TitleLabel]
Text= Opsi Client Kiosk
FontName = Arial
FontSize = 15
FontColor = clWhite
FontBold = false
FontItalic = false
FontUnderline = false

[Tile]
width = 220
height = 200
color =  clCream
FontName = Arial
FontSize = 12
FontColor = clBlack
FontBold = false
FontItalic = false
FontUnderline = false

[TileRadio]
fontsize = 10
none_color = clBlack
uninstall_color = clRed
setup_color = clGreen
----

Templates für diese Dateien finden Sie unter `/var/lib/opsi/depot/opsi-client-agent/files/opsi/opsiclientkiosk/opsiclientkioskskin`
bzw. `C:\Program Files (x86)\opsi.org\opsi-client-agent\opsiclientkiosk\opsiclientkioskskin`


Das jeweils verwendete Icon kann durch Ablegen einer `kiosk.ico` Datei unter
/var/lib/opsi/depot/opsi-client-agent/files/opsi/custom/opsiclientkioskskin/
verändert werden.


[[opsi-manual-clientagent-ci-custom]]
===== Schutz Ihrer Änderungen vor Updates: Das custom Verzeichnis

(Seit opsi-client-agent Version 4.0.3.1)

Möchten Sie Änderungen, welche Sie an den oben genannten Dateien durchgeführt haben, davor schützen, dass selbige beim Einspielen einer neuen Version des opsi-client-agenten verloren gehen, so können Sie hierfür das `custom` Verzeichnis (`/var/lib/opsi/depot/opsi-client-agent/files/opsi/custom`) verwenden. Das komplette `custom` Verzeichnis wird bei der Installation einer neuen Version des opsi-client-agenten gesichert und wieder hergestellt, so dass hier gemachte Änderungen bei einem Update nicht verloren gehen.

* `custom/config.ini` +
Diese custom Config-Datei wird als letzte eingelesen, somit gelten die in dieser Datei enthaltenen Werte statt den entsprechenden Einstellungen aus der Standard-Datei `cfg/config.ini`. Ausnahme: die Werte für `pckey` und `bootmode` werden nie aus dieser Datei geholt. Schreiben Sie in diese Datei *nur* die Werte, die Sie tatsächlich gegenüber dem Default geändert haben wollen.

* `custom/winstskin/*.*` +
Alle Dateien aus diesem Verzeichnis werden bei der Installation des opsi-client-agent auf dem Client nach `C:\Program Files (x86)\opsi.org\opsi-client-agent\custom\winstskin` kopiert. Falls vorhanden, wird (ab opsi-winst Version 4.11.3.4) dieses winstskin Verzeichnis bevorzugt verwendet. Es muss alle benötigten Dateien und Einträge vollständig enthalten, da die Inhalte des Standard-winstskin-Verzeichnisses bei Verwendung des `custom/winstskin/` ignoriert werden.

* `custom/notifier/*.*` +
Alle Dateien aus diesem Verzeichnis werden bei der Installation des opsi-client-agent auf dem Client nach `C:\Program Files (x86)\opsi.org\opsi-client-agent\notifier` kopiert und überschreiben dabei die entsprechenden aus dem serverseitigen Standard-Verzeichnis `files/opsi/dist/notifier/` stammenden Dateien.

* `custom/opsiclientd.conf` +
wird, falls vorhanden, bei der Installation des opsi-client-agent auf dem Client nach `C:\Program Files (x86)\opsi.org\opsi-client-agent\opsiclientd` kopiert und überschreibt dabei die aus dem serverseitigen `files/opsi/dist/opsiclientd/` Verzeichnis stammende `opsiclientd.conf`. Es werden also nicht einzelne Werte überschrieben, sondern die komplette Datei, die deshalb alle benötigten Einstellungen vollständig enthalten muss. +
*Achtung:* +
Die Anpassung der `opsiclientd.conf` über diese Methode wird nicht empfohlen. Verwenden Sie zur Konfiguration Ihrer Clients Hostparameter/Configs wie im Kapitel zum opsi-client-agent beschrieben. Die Verwendung einer `custom/opsiclientd.conf` ist nur bei extrem komplexen Anpassungen der opsiclientd.conf sinnvoll. Wenn Sie diese Methode anwenden, müssen Sie bei jedem Einspielen einer neuen opsi-client-agent Version auf dem Server überprüfen, ob in der Default Datei `files/opsi/dist/opsiclientd/opsiclientd.conf` Änderungen gemacht oder neue Einträge hinzugefügt wurden, welche Sie in Ihrer Version nachpflegen müssen. Also: +
 *Finger weg, es sei denn Sie wissen wirklich was Sie tun !*

* `custom/opsiclientkioskskin/*.*`
Alle Dateien aus diesem Verzeichnis werden bei der Installation des opsi-client-agent auf dem Client nach C:\Pro
gram Files (x86)\opsi.org\opsi-client-agent\custom\opsiclientkioskskin kopiert. Falls vorhanden, wird dieses opsiclientkioskskin
Verzeichnis bevorzugt verwendet.


Ein nachträgliches Rechte nachziehen hilft Folgefehler zu vermeiden:

[source, prompt]
----
opsi-setup --set-rights /var/lib/opsi/depot/opsi-client-agent
----


[[opsi-manual-clientagent-loginblock]]
==== Sperrung des Anwender Logins mittels {opsi-login-blocker}

Um zu verhindern, dass sich ein Anwender schon vor dem Abschluss der Installation am System anmeldet, kann zusätzlich der {opsi-login-blocker} installiert werden.
Dieser gibt den Zugriff auf den Login erst frei, wenn der Installations-Prozess beendet ist.

Ob der '{opsi-login-blocker}' währen der '{opsi-client-agent}'-Installation installiert bzw. aktiviert wird,
kann über das '{product-property}' +loginblockerstart+ konfiguriert werden.

[[opsi-manual-clientagent-loginblock-nt5]]
===== {opsi-login-blocker} unter NT5 (Win2k/WinXP)
Der {opsi-login-blocker} (`opsigina.dll`) ist als 'GINA' realisiert.
Die 'opsigina' wartet bis zum Abschluss der '{product-actions}' oder dem Timeout (standard-Wert: 120 Sekunden) bei nicht erreichbarem '{opsiclientd}'.
Danach wird die Kontrolle an die nächste 'GINA' übergeben (in der Regel an die msgina.dll).

'GINA' steht hierbei für „Graphical Identification and Authentication“ und stellt die seitens Microsofts offiziell unterstützte Möglichkeit dar,
in den Login-Prozess von Windows einzugreifen.

Gelegentlich ist es der Fall, dass bereits andere Softwareprodukte (z.B. Client für Novell-Netzwerke) eine 'GINA' auf dem System installiert haben
und empfindlich auf Eingriffe reagieren.

Generell sind mehrere ,nacheinander aufgerufene 'GINAs' ('GINA-chaining') durchaus möglich.
Auch die 'opsigina.dll' des {opsi-login-blocker} ist für das genannte 'GINA-chaining' vorbereitet.
Sollte der beschriebene Fall bei Ihren Clients eintreten, informieren Sie sich bitte auf dem freien Supportforum (https://forum.opsi.org)
nach bestehenden Anpassungsmöglichkeiten oder kontaktieren Sie die Firma 'uib'.

[[opsi-manual-clientagent-loginblock-nt6]]
===== {opsi-login-blocker} unter NT6 (Vista/Win7)
Der '{opsi-login-blocker}' für NT6 (Vista/Win7) ist als 'credential provider filter' realisiert ('OpsiLoginBlocker.dll').
Er blockiert alle 'credential provider' bis zum Abschluss der '{product-actions}' oder dem Timeout (Standard-Wert: 120 Sekunden) bei nicht erreichbarem '{opsiclientd}'.

[[opsi-manual-clientagent-subsequent-installation]]
==== Nachträgliche Installation des opsi-client-agents
Die Anleitung zur nachträglichen Installation des '{opsi-client-agent}s' finden Sie im Handbuch 'opsi-getting-started' im Kapitel 'Erste Schritte'.

Siehe aus Kapitel 'opsi Software On Demand (Kiosk-Mode)': <<software-on-demand>>

[[opsi-manual-clientagent-image-installation]]
===== Installation des opsi-client-agent in einem Master-Image oder als Exe

Um den opsi-client-agent über ein versiegeltes (sysprep) Masterimage zu verteilen, muß der opsi-client-agent sich beim 'aufwachen' also beim personaliesieren des erstellten Klons auch neu personalisieren.

Dies geschieht am besten über eine Neuinstallation.

Dazu gehe Sie wie folgt vor:

* Kopieren Sie vom opsi_depot share den Inhalt des Verzeichnisses opsi-client-agent in ein temporäres Verzeichnis auf dem Master.

* Editieren Sie die Datei `files\opsi\cfg\config.ini` :
** In der Sektion `[installation]` setzen Sie für `service_user=` einen User der Mitglied in der Gruppe opsi-admin ist.
** In der Sektion `[installation]` (nicht empfohlen) setzen Sie für `service_password=` das Klartextpasswort des users. Besser:
** In der Sektion `[installation]` setzen Sie für `service_hidden_password=` das base64 encodete passwort des users. Das encoden des Klartextpasswortes können sie über die entsprechende opsi-winst Funktion `base64EncodeStr(<string>)` durchführen oder z.B. über http://www.base64encode.org/ +
Wenn `service_hidden_password=` einen Wert hat wird `service_password=` ignoriert.
** In der Sektion `[opsiclientd]` setzen Sie für `config_service.url =` die Webserviceadresse Ihres opsi-config-servers z.B. https://192.168.1.10:4447

* Sorgen Sie dafür das in der Personalisierungsphase die Datei `silent_setup.cmd` aus dem temporären Verzeichnis aufgerufen wird.

* Nach dem Abschluß des Aufrufs der `silent_setup.cmd` kann das temporäre Verzeichnis gelöscht werden.

Wenn man möchte, kann man das ganze jetzt in eine selbstextrahierende .exe-Datei mit Programmaufruf verpacken, bspw. über das Programm filzip.

[[opsi-manual-clientagent-systray-program]]
==== Das Systray Programm des opsi-client-agents

Das Systray Programm des opsi-client-agent erfüllt folgende Aufgaben:

* Regelmässige Information des Anwenders über anstehende Installationen (Optional)

* Information des Anwenders über anstehende Installationen auf Anforderung über das Kontextmenü

* Möglichkeit des Anwenders den Start der Installationen anzufordern.

.Message Fenster des opsi-systray Programms
image::opsi-systray-message.png["Abbildung: Message Fenster des opsi-systray Programms",width=200]

.Kontext Menü (Rechte Maustaste) des opsi-systray Programms
image::opsi-systray-menue.png["Abbildung: Kontext Menü (Rechte Maustaste) des opsi-systray Programms",width=200]

*Steuerung des opsi systray Programms über die Produktproperties des Produkts 'opsi-client-agent':* +

* `systray_install` +
(`true` / `false`) Soll das opsi-systray Programm installiert werden ? +
Default = `false`

* `systray_check_interval` +
Alle wieviel Minuten soll das Programm überprüfen ob für den Client Installationen anstehen. +
Default=`180` (Kleine Werte hier, geben viel Last auf den Server) +
Der Wert `0` bedeutet, das keine regelmäßigen Prüfungen durchgeführt werden.

* `systray_request_notify_format` +
Format der Benachrichtigung über anstehende Installationen. +
Mögliche Werte: +
"productid : request", "productname : request", "productname productversion : request" +
default: "productname : request"

*Logging des opsi systray Programms:* +

Das Programm loggt nach `%Appdata%\opsi.org\log`. D.h. in das Verzeichnis `opsi.org\log` im Anwendungsdatenverzeichnis des angemeldeten Users. +
Zum Beispiel: +
`C:\Users\<username>\AppData\Roaming\opsi.org\log\`

Siehe auch Kapitel 'opsi Software On Demand (Kiosk-Mode)': <<software-on-demand>>
