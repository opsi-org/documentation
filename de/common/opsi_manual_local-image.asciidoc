////
; Copyright (c) uib gmbh (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; https://creativecommons.org/licenses/by-sa/3.0/de/
; https://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; https://creativecommons.org/licenses/by-sa/3.0/
; https://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: http://www.opsi.org/credits/
////

:Author:    uib gmbh
:Email:     info@uib.de
:Date:      19.10.2017
:Revision:  4.1
:toclevels: 6

include::../common/opsi_terms.asciidoc[]

[[opsi-manual-localimage]]
=== 'opsi local image'

[[opsi-manual-localimage-preconditions]]
==== Vorbedingungen für die opsi Erweiterung 'opsi local image'

Dieses Modul ist momentan eine
http://www.uib.de/www/kofinanziert/index.html[kofinanzierte opsi Erweiterung]. +
Es sind eine Reihe von Vorbedingungen nötig, um dieses Modul einsetzen
zu können. Das bedeutet, dass Sie zum Einsatz eine Freischaltdatei benötigen. Diese Freischaltung erhalten Sie, wenn Sie die Erweiterung kaufen. Zu Evaluierungszwecken stellen wir Ihnen auch eine zeitlich befristete Freischaltung kostenlos zur Verfügung ( -> mail an info@uib.de). +
Weitere Details hierzu finden Sie in <<opsi-manual-modules>>.

Mit der Berechtigung opsi-local-image zu verwenden erwerben Sie gleichzeitig auch das Recht die Erweiterung opsi-vhd-reset (siehe <<opsi-manual-vhd>>) zu verwenden.

Technische Voraussetzungen sind opsi 4.0.3 mit den Paketständen:

.Benötigte Pakete
[options="header"]
|==========================
|opsi-Paket|Version
|opsi-linux-bootimage|>= 20130207-1
|==========================

CAUTION: Für das Produkt `opsi-local-image-capture` muß der share `opsi_depot_rw` für 'pcpatch' beschreibbar sein. Prüfen Sie Ihre Samba Konfiguration.


[[opsi-manual-localimage-introduction]]
==== Einführung

Opsi bietet eine gute Basis, um automatisiert Windows Rechner zu installieren und zu pflegen - auch und gerade, wenn es sich um heterogene Hardware handelt. Die von opsi unterstützte Technik der Paket basierten Installation ist aber nicht schnell genug, um in Schulungsräumen Rechner innerhalb von kurzer Zeit wie z.B. in einer Pause zwischen zwei Kursen wieder in einen definierten Zustand zu versetzen. Daher wird hier ein Konzept vorgestellt, bei dem die paketbasiert durchgeführte Installation lokal auf einer zweiten Partition als Imagekopie gesichert wird und von dort eine schnelle Wiederherstellung möglich ist.

. Initiale Installation mit abschließender lokaler Image-Sicherung
. Schnelle Wiederherstellung auf Basis unterschiedlicher Techniken
. Systempflege mit abschließender lokaler Image-Sicherung
. Integration von Capturing von vorhandenen Installationen zu WIM
. Integration von Linuxclients in das Backup/Restore Verfahren.

[[opsi-manual-localimage-concept]]
==== Konzept

Die Anforderungen edukativer Computernetze unterscheiden sich teilweise von denen anderer Netzwerke. Eine wesentliche Anforderung, die im Folgenden diskutiert wird, ist die schnelle Wiederherstellung von Rechnern in einen definierten Zustand, den Sie im Rahmen einer temporären Nutzung verloren haben. Konkret geht es um die Bereitstellung von Rechnern in schulischen Computerräumen, wobei die Problemlage auch auf kommerzielle Computerräume oder universitäre Computerpools zutrifft.

Die Wiederherstellung soll innerhalb von kurzer Zeit (ca. 15 Minuten) erfolgen und sollte soweit möglich einen Rechner nicht nur 'zurücksetzen' sondern auf eine andere Basisinstallation (z.B. Win XP / Win 7 / Linux) umschalten können. +
Weiterhin muss es möglich sein, dass eine kontinuierliche Pflege der Systeme mit Sicherheitsupdates gewährleistet ist.

Die Üblichen Techiken zur Installation von PC's haben verschiedene spezifische Vor- und Nachteile:

.Vor- und Nachteile von Unattend und Image Lösungen
[options="header"]
|==========================
| Feature | Unattend | Image
| Geschwindigkeit | (-) langsam | (+) schnell
| Empfindlichkeit gegen heterogene Hardware | (+) gering | (-) hoch
| Netzwerkbelastung | (-) hoch | (-) hoch
|==========================

Das Konzept von opsi-local-image versucht die Vorteile beider klassischen Konzepte miteinander zu kombinieren:

.opsi-local-image
[options="header"]
|==========================
| Feature | Unattend
| Geschwindigkeit | (+) schnell
| Empfindlichkeit gegen heterogene Hardware | (+) gering
| Netzwerkbelastung | (+) gering
|==========================

Das Konzept kann in den folgenden Stichpunkten zusammengefasst werden:

* Initiale Windowsinstallation per PXE-Boot paketbasiert mit individueller Treiberintegration unter Verwendung des opsi-Linux-Bootimage

* Sicherung dieser initialen Installation in einem Sicherungsimage auf einer 2. Partition auf der lokalen Festplatte des Rechners unter Verwendung des opsi-Linux-Bootimage

* Schnelle Wiederherstellung der Produktiv-Installation aus dem lokalen Image unter Verwendung des opsi-Linux-Bootimage

* Pflege der lokalen Installation (Sicherheitsupdates) über die opsi Softwareverteilung und Sicherung des aktualisierten Systems auf das lokale Backup-Image unter Verwendung des opsi-Linux-Bootimage

[[opsi-manual-localimage-concept-technical]]
==== Technisches Konzept

Der Schulungsrechner wird mit einer statischen Partitionstabelle verwendet. Dabei kann entweder mit 3 oder 4 Partitionen gearbeitet werden:

* Partition 1 (System) +
Hier findet sich das aktuell verwendete Betriebssystem (Windows / Linux) +
Die Größe dieser Partition wird bei der Partitionierung über das Produkt `opsi-local-image-prepare` über ein Property gesteuert.

* Optional: Partition 2 (sysdata) +
Hier können z.B. Anwenderdaten gespeichert werden, welche bei einem Restore nicht überschrieben werden. Die Formatierung ist NTFS. +
Die Größe dieser Partition wird bei der Partitionierung über das Produkt `opsi-local-image-prepare` über ein Property gesteuert.

* Partition 3 (winpe / swap) +
Die Größe dieser Partition ist statisch auf 4GB festgelegt. +
Unter Windows XP wird dies Partition nicht verwendet. +
Unter NT6 (Windows 7) wird diese Partition für das bei der Installation notwendige winpe verwendet und ist im Betrieb nicht sichtbar. +
Unter Linux wird diese Partition als Swap verwendet.

* Partition 4 (backup) +
Diese Partition dient zur Speicherung der gesicherten Images und ihrer Metadaten. +
Die Größe dieser Partition ergibt sich aus dem nach Erstellung der anderen Partitionen noch vorhandenen freien Platz.

Die Netbootprodukte zur Betriebssystem Installation verwenden nur die ersten zwei oder drei Partitionen (XP nur die erste) und lassen die letzte Backup-Partition unberührt. Somit bleiben die auf der Partition 4 (backup) liegenden Images auch bei der Installation eines neuen Betriebssystems erhalten.

[[opsi-manual-localimage-proceedings]]
==== Abläufe

[[opsi-manual-localimage-proceedings-initial]]
===== Initiale Installation

Über das Produkt `opsi-local-image-prepare` wird zunächst die notwendige statische Partitionierung erzeugt.

.Schema: Statische Partitionierung mit opsi-local-image-prepare
image::oli-prepare.png["Schema: Statische Partitionierung mit opsi-local-image-prepare", width=332]

Anschließend können über die Produkte `opsi-local-image-win`* und andere verschiedene Betriebssysteme mit unterschiedlicher Ausstattung an Anwendungssoftware installiert werden.

.Schema: OS Installation mit opsi-local-image-win*
image::oli-os-install.png["Schema: OS Installation mit opsi-local-image-win*", width=332]

Diese werden per default nach Ihrer Installation automatisch als Image gesichert.

.Schema: Image Backup mit opsi-local-image-backup
image::oli-backup-1.png["Schema: Image Backup mit opsi-local-image-backup", width=332]


[[opsi-manual-localimage-proceedings-restore]]
===== Restore eines Images

Der einfache Aufruf des Produktes `opsi-local-image-restore` stellt automatisch das letzte erstellte Image wieder her. Soll ein anderes Image wieder hergestellt werden, so muß dies im Property `imagefile` angegeben werden.

.Schema: Image Restore mit opsi-local-image-restore
image::oli-restore-image.png["Schema: Image Restore mit opsi-local-image-restore", width=332]

[[opsi-manual-localimage-proceedings-delete]]
===== Löschen eines Images

.Schema: Löschen eines gespeicherten Images
image::oli-delete-image.png["Schema: Löschen eines gespeicherten Images", width=332]

Durch den Aufruf des Produktes `opsi-local-image-delete` wird das im Property `imagefile` angegebene Image gelöscht.


[[opsi-manual-localimage-proceedings-update]]
==== Update eines Images: Automatisierter Workflow mit opsi-auto-update

.Schema: Ablauf des automatischen Upgrades eines gespeicherten Images
image::oli-image-upgrade-flow.png["Schema: Ablauf des automatischen Upgrades eines gespeicherten Images", width=332]


`opsi-auto-update` ist ein Produkt um die Pflege der Clients zu vereinfachen.

Im Kern ist es die Aufgabe des Produktes dafür zu sorgen die installierten Produkte aktuell zu halten. +
Das Produkt setzt alle installierten Produkte, 
deren Version nicht identisch mit der auf dem Server ist, 
für den Client auf setup.

Da dieses Produkt nicht nur im Kontext von 'opsi-local-image' eingesetzt werden kann, ist es im Kapitel 'opsi Standardprodukte' / 'opsi-auto-update' beschrieben: +
<<opsi-manual-localboot-opsi-auto-update>>

[[opsi-manual-localimage-components]]
==== Die opsi-local-image Produkte

Die opsi-local-image Produkte ab Version 4.1 unterstützen auch Mehrplattensysteme. Bitte beachte Sie dazu auch den Abschnitt <<opsi-manual-netboot-nt6>>

Das Paket 'opsi-local-image' besteht aus folgenden Produkten

Das Netbootprodukt zur Partitionierung

* `opsi-local-image-prepare`

Die Netbootprodukte zur Betriebssystem Installation:

* `opsi-local-image-winxp`
* `opsi-local-image-win7`
* `opsi-local-image-win7-x64`
* `opsi-local-image-win81`
* `opsi-local-image-win81-x64`
* `opsi-local-image-win10`
* `opsi-local-image-win10-x64`

* `opsi-local-image-ubuntu`


Den Netbootprodukten zum Handling der lokalen Images

* `opsi-local-image-backup`
* `opsi-local-image-restore`
* `opsi-local-image-delete`

Den Lokalbootprodukten zur Ablaufsteuerung:

* `opsi-local-image-backup-starter`
* `opsi-auto-update`


Zur Installation der Produkte stellen Sie bitte in der Datei `/etc/opsi/package-updater.repos.d/uib-local_image.repo` das Attribut *active* des Repositories *uib_local_image* auf 'True'.
Anschließend können Sie über einen Aufruf von `opsi-package-updater --repo uib_local_image install` die neuen Produkte installieren lassen.


[[opsi-manual-localimage-components-uefi]]
===== UEFI Kompatibilität

Die opsi-local-image Produkte sind UEFI kompatibel.



[[opsi-manual-localimage-components-part]]
===== Netboot Produkt zur Partitionierung

* `opsi-local-image-prepare` +
Erstellung der statischen Partitionierung der Festplatte für alle anderen Produkte. +
Properties:

ask_before_inst:: 
Soll am Client vor dem Start bestätigt werden. (Default='true')
system_partition_size:: 
Gibt die Größe der Partition 1 (system) an (Default = 30G)
data_partition_size:: 
Gibt die Größe der Partition 2 (data) an. Bei eine Größe von '0G' wird keine Partition für Daten angelegt. (Default = 0G)
start_os_installation:: 
Hier kann das Produkt zur Installation eines Betriebssystems ausgewählt werden, welches im Anschluß an die Partitionierung automatisch gestartet wird.
Bei der Installation dieses Produkts werden beim Produkt `opsi-local-image-restore` die Produktproperties 'imagefile' und 'imagefiles_list' gelöscht, da durch die Neupartitionierung diese Daten ungültig geworden sind.
delay_for_reboot::
Sekunden zwischen Beendigung des Scriptes und dem Reboot um dem Server Zeit zugeben die Netboot-Pipe zu erstellen.
minimal_backup_partition_size::
Diese Property dient zu einer Plausibilitätsüberprüfung der gemachten Angaben. +
Die Größe der Backuppartition ergibt sich aus: +
Größe der Festplatte - (`system_partition_size` + `data_partition_size` + `winpe_partition_size`). +
Üblicherweise verwendet man opsi-local-image, weil ein lokales Backup der Systempartition gemacht werden soll. Dazu ist Voraussetzung, das für die Backuppartition genügend Platz ist. Wird bei der Berechnung der Partitionierung festgestellt das der verbleibende Platz für die Backuppartition kleiner ist als der Wert von `minimal_backup_partition_size` wird mit einem Fehler abgebrochen. +
(Default=55%)
winpe_partition_size:: Größe der winpe Partition (Default=4G)
multi_disk_mode:: Diese Property dient zur Wahl der Festplatte auf die installiert werden soll. +
Mögliche Werte sind: "0","1","2","3","prefer_ssd","prefer_rotational" +
Die Werte "0","1","2","3" geben den Index der Festplatte direkt an ("0"= 1. Festplatte) +
Der Wert "prefer_ssd" wählt die erste SSD Platte aus. +
Der Wert "prefer_rotational" wählt die erste klassische Platte (mit rotierenden Scheiben)aus. +
Das Property wird auf Systemen mit nur einer Platte ignoriert. +
Default = "0"

backup_partition_on_same_disk::
true : Backuppartition auf der Systemplatte anlegen. false : Backuppartition auf der ersten freien Platte anlegen, welche nicht die Systemplatte ist. +
Das Property wird auf Systemen mit nur einer Platte ignoriert. +
Default = "true"



IMPORTANT: Verwenden Sie dieses Produkt nur zur initialen Vorbereitung der Platte. Es löscht alle gespeicherten Images.

[[opsi-manual-localimage-components-win]]
===== Netboot Produkte zur Installation von Windows

Die Netbootprodukte zur Installation von Windows sind Abkömmlinge der opsi Standardprodukte zur Windowsinstallation. Das bedeutet konkret, dass sie bezüglich des Aufbaus und der Treiberintegration identisch sind. Entsprechende Anleitungen finden sich im 'opsi-getting-started' Handbuch.

Die Properties der Windows NT6 Produkte ab Version 4.1 sind eine Teilmenge der Properties der NT6 Standardprodukte wie sie im  Abschnitt <<opsi-manual-netboot-nt6>> beschrieben sind. Die fehlenden Properties zu Platten und Partitionen werden dem produkt `opsi-local-image-prepare` entnommen.

ACHTUNG:: Ändern Sie die Propertyeinstellungen von opsi-local-image-prepare nicht mehr nach dem sie die Maschine damit präpariert haben, da die nachfolgenden Produkte auf diese Werte zugreifen. 

* `opsi-local-image-winxp` +
Installation von Windows XP. Verwendet nur die erste Partition.
Administrator Passwort ist leer.

* `opsi-local-image-win7` +
Installation von Windows 7 32 Bit.

* `opsi-local-image-win7-x64` +
Installation von Windows 7 64 Bit.

* `opsi-local-image-win81` +
Installation von Windows 8.1 32 Bit.

* `opsi-local-image-win81-x64` +
Installation von Windows 8.1 64 Bit.

* `opsi-local-image-win10` +
Installation von Windows 10 32 Bit.

* `opsi-local-image-win10-x64` +
Installation von Windows 10 64 Bit.

Diese Produkte haben folgende 'opsi-local-image' spezifische Properties:

* 'backup_after_install' mit dem default Wert 'true'. Dies bedeutet in diesem Fall, dass nach der OS Installation zunächst die Anwendungssoftware installiert wird und abschließend eine Imagesicherung der Installation durchgeführt wird. Weiterhin wird der Wert vom `imageFile` des Produktes `opsi-local-image-restore` gelöscht. Dies führt dazu, dass das erstellte Backup den Namen des laufenden Netbootproduktes (z.B. `opsi-local-image-win7`) bekommt.

* 'setup_after_install' +
Hier können ein oder mehrere Produkte angegeben werden, welche nach Abschluß der Betriebssysteminstallation auf 'setup' gestellt werden. Dabei werden auch die Abhängigkeiten diese Produkte mit aufgelöst.

[[opsi-manual-localimage-components-linux]]
===== Netboot Produkte zur Installation von Linux

* `opsi-local-image-ubuntu` +
Installation von Ubuntu Linux 12.04/14.04 32Bit/64Bit. +
Das installierte System kennt 2 user: `root` und `user`. Für 'root' wird das im Produktproperty `root_password` festgelegte Passwort gesetzt (Default: `linux123`). Für 'user' wird das im Produktproperty `user_password` festgelegte Passwort gesetzt (Default: `linux123`).
Details der Installation werden über Produktproperties gesteuert. Die wesentlichen Produktproperties sind dabei:
** `askbeforeinst`: +
Soll das Starten der Installation am Client bestätigt werden müssen?  (Default='true')
** `architecture`: +
Architektur Auswahl, beeinflusst die Auswahl des bootimages und die Installationsarchitektur.  (Default='64bit')
** `additional_packages`: +
Welche zusätzlichen Pakete sollen installiert werden? Angabe der Pakete Leerzeichen separiert. (Default = pass:[''])
** `language`: +
Welche Sprache / locale soll installiert werden.  (Default='de')
** `console_keymap` +
steuert in welches Tastaturlayout installiert wird. (Default='de-latin1-nodeadkeys')
** `timezone`: +
Welche Zeitzone soll verwendet werden?. (Default='Europe/Berlin')
** `online_repository` +
gibt an aus welchem online Repository die Pakete installiert werden sollen. Der Default ist 'http://de.archive.ubuntu.com/ubuntu'
** `proxy`: +
Proxystring (wenn benötigt) in der Form: `http://<ip>:<port>`. (Default = pass:[''])
** `backup_after_install` +
('true'/'false') Default = 'true'. Nach der Installation wird sofort eine Imagesicherung der Installation durchgeführt.
** `setup_after_install` +
Hier können ein oder mehrere Produkte angegeben werden, welche auf 'setup' gestellt werden und somit nach Abschluß der Betriebssysteminstallation installiert werden. Dabei werden auch die Abhängigkeiten dieser Produkte mit aufgelöst.
** `wget_and_execute`: +
Url (http) einer Datei welche am Ende der Installation geholt und ausgeführt wird. (Default = pass:[''])
** `release`: +
Welches Release von Ubuntu soll installiert werden. (Default="trusty")
** `install_opsi-client-agent`: +
Installiere den Linux opsi-client-agent (Kofinanzierungsprojekt: Sie benötigen eine Aktivierung durch die /etc/opsi/modules). (Default='false')
////
* `opsi-local-image-opensuse13-2` +
Installation von OpenSuse Linux 13.2 32Bit/64Bit. +
Das installierte System kennt 2 user: `root` und `user`. Für 'root' wird das im Produktproperty `root_password` festgelegte Passwort gesetzt (Default: `linux123`). Für 'user' wird das im Produktproperty `user_password` festgelegte Passwort gesetzt (Default: `linux123`).
Details der Installation werden über Produktproperties gesteuert. Die wesentlichen Produktproperties sind dabei:
** `askbeforeinst`: +
Soll das Starten der Installation am Client bestätigt werden müssen?  (Default='true')
** `architecture`: +
Architektur Auswahl, beeinflusst die Auswahl des bootimages und die Installationsarchitektur.  (Default='64bit')
** `language`: +
Welche Sprache / locale soll installiert werden.  (Default='de')
** `console_keymap` +
steuert in welches Tastaturlayout installiert wird. (Default='de-latin1-nodeadkeys')
** `timezone`: +
Welche Zeitzone soll verwendet werden?. (Default='Europe/Berlin')
** `partition_disk`: +
Welche Platte soll verwender werden? (Default='first')
** `proxy`: +
Proxystring (wenn benötigt) in der Form: `http://<ip>:<port>`. (Default = pass:[''])
** `backup_after_install` +
('true'/'false') Default = 'true'. Nach der Installation wird sofort eine Imagesicherung der Installation durchgeführt.
** `setup_after_install` +
Hier können ein oder mehrere Produkte angegeben werden, welche auf 'setup' gestellt werden und somit nach Abschluß der Betriebssysteminstallation installiert werden. Dabei werden auch die Abhängigkeiten dieser Produkte mit aufgelöst.
** `install_opsi-client-agent`: +
Installiere den Linux opsi-client-agent (Kofinanzierungsprojekt: Sie benötigen eine Aktivierung durch die /etc/opsi/modules) . (Default='false')
////

[[opsi-manual-localimage-components-backuprestore]]
===== Netboot Produkte zum Backup und Restore

* `opsi-local-image-backup` +
Dieses Produkt sichert das aktuell auf Partition 1 installierte Betriebssystem in einer Imagedatei auf Partition 4. Als Image Namen wird der im Property gesetzte Name verwendet. Wenn dieser leer ist, so wird der Name des opsi Netbootproduktes verwendet, welcher aktuell auf 'installed' steht (z.B. `opsi-local-image-winxp`). Dieser Name wird beim Produkt `opsi-local-image-restore` als Produktproperty 'imagefile' gesetzt, so daß ein nachfolgender Aufruf von `opsi-local-image-restore` per default genau dieses Image wiederherstellt. Dieser Name wird beim Produkt `opsi-local-image-restore` dem Produktproperty 'imagefiles_list' hinzugefügt. Damit enthält dieses Property die Liste aller verfügbaren Images. Weiterhin werden (für die Windows-Produkte) die aktuellen opsi-Produktstände zusammen mit dem Image gesichert, damit auch diese im Rahmen des restores wiederhergestellt werden können. +
Als Sicherungsmethode wird partclone verwendet. +
Properties:
** `askbeforeinst`: +
Soll das Starten der Installation am Client bestätigt werden müssen?  (Default='false')
** `free_on_backup`: +
Dies ist ein read-only property welches aktuelle Informationen zur Backuppartition anzeigt: device, size, used, remaining, use in %, mount point
** `imagefile` +
Name der zu erstellenden Imagedatei (default = leer = der Name des aktuell installierten opsi-local-image Produktes wird verwendet). Der Name darf Leerzeichen aber keine Umlaute enthalten. (Im Fall von Leerzeichen werden diese intern als Unterstich behandelt. D.h. 'mein image' = 'mein_image'.)
** `setup_after_install` +
Hier können ein oder mehrere Produkte angegeben werden, welche auf 'setup' gestellt werden und somit nach Abschluß installiert werden. Dabei werden auch die Abhängigkeiten dieser Produkte mit aufgelöst.


* `opsi-local-image-restore` +
Dieses Produkt spielt das im Produktproperty 'imagefile' angegebene Image wieder auf der Partition 1 ein und sorgt dafür, dass es gebootet werden kann. Weiterhin werden (für die Windows-Produkte) die für das Image gesicherten opsi-Produktstände zusammen mit dem Image wiederhergestellt. +
Properties:
** `askbeforeinst`: +
Soll das Starten der Installation am Client bestätigt werden müssen?  (Default='true')
** `architecture`: +
Architektur Auswahl, beeinflusst die Auswahl des bootimages und die Installationsarchitektur.  (Default='64bit')
** `imagefile` +
Name des Images welches restored werden soll. Der Wert dieses Properties wird automatisch durch das letzte Backup gesetzt. Die Liste der verfügbaren Images findet sich im Property `imagefiles_list`.
** `imagefiles_list` +
Liste der verfügbaren Images. Wird duch das Backup Produkt gepflegt.

** `update_and_backup` +
*Die Verwendung dieses Properties wird nicht mehr empfohlen.* +
Verwenden Sie statt dessen das Produkt `opsi-auto-update`. Dieses ist es im Kapitel 'opsi Standardprodukte' / 'opsi-auto-update' beschrieben: +
<<opsi-manual-localboot-opsi-auto-update>> +
('true'/'false') Default = 'false'. Bei 'true' wird nach dem restore dafür gesorgt, dass alle Localboot Produkte die auf dem Server in einer abweichenden Version vorhanden sind auf `setup` gestellt werden und das Produkt `opsi-local-image-backup-starter` auf `once` gesetzt wird. Dies führt dazu, dass alle vorhandenen Updates eingespielt und nach den Updates automatisch wieder eine Sicherung durchgeführt wird.


** `setup_after_restore` +
Hier können ein oder mehrere opsi-Produkte angegeben werden, welche nach dem Abschluß des Restores auf 'setup' gesetzt werden und somit nach dem Reboot automatisch ausgeführt werden. Der Default ist das Produkt 'windomain' zur erneuten Aufnahme des restorten Clients in die Windows Domain.

* `opsi-local-image-delete` +
Dieses Produkt löscht das im Produktproperty 'imagefile' angegebene Image von der Backup Partition +
** `imagefile` +
Name des zu löschenden Images (default = leer = Fehler)

[[opsi-manual-localimage-components-helper]]
===== Localboot Produkt zur Ablaufsteuerung

* `opsi-local-image-backup-starter` +
Dieses Localbootprodukt stellt das Netbootprodukt `opsi-local-image-backup` auf 'setup' und rebootet den Rechner dann. Dieses Produkt hat eine sehr niedrige Priorität von -98. Dies bedeutet das alle 'normalen' Localboot Produkte vorher abgearbeitet werden. 

* `opsi-auto-update` +
Im Kern ist es die Aufgabe des Produktes dafür zu sorgen die installierten Produkte aktuell zu halten. +
Das Produkt setzt alle installierten Produkte, 
deren Version nicht identisch mit der auf dem Server ist, 
für den Client auf setup. +
Da dises Produkt nicht nur im Kontext von 'opsi-local-image' eingesetzt werden kann, ist es im Kapitel 'opsi Standardprodukte' / 'opsi-auto-update' beschrieben: +
<<opsi-manual-localboot-opsi-auto-update>>


[[opsi-manual-localimage-service-methods]]
==== Erweiterte opsi Service Methoden

Im Rahmen dieser Erweiterung können die Rechner eines Schulungsraums in einer opsi-client Gruppe zusammengefasst werden. Um möglichst komfortable Aktionen für alle Rechner eines Schulungsraums auszulösen sind folgende Erweiterungen der opsi-service Methoden vorgesehen:

* `setProductActionRequestForHostGroup` +
Parameter: `hostGroupId, productId, actionRequest` +
Ermöglicht für alle Mitglieder einer Gruppe (z.B. Rechner eines Schulungsraums) eine bestimmte Aktion zu starten (z.B. Restore des Images).

* `setProductPropertyForHostGroup` +
Parameter: `productId propertyId propertyValue hostGroupId` +
Ermöglicht für alle Mitglieder einer Gruppe (z.B. Rechner eines Schulungsraums) für ein betimmtes Produkt einen Propertywert zusetzen (z.B. welches Image restored werden soll).

* `getPossibleImagefileValuesForHostGroup` +
Parameter: `groupId` +
Liefert die Liste der Imagefile Namen, welche das `opsi-local-image-backup` auf allen Mitgliedern der Gruppe angelegt hat. Wenn ein bestimmtes Image (z.B. `opsi-local-image-winxp`) auf einem oder mehreren Rechnern nicht vorhanden ist, so ist es nicht Bestandteil der Rückgabeliste.

Diese Methoden werden zu einem späteren Zeitpunkt in die Standardpakete von opsi integriert. Bis dahin steht Ihnen in der Auslieferung eine Datei `40_groupActions.conf` zur Verfügung die Sie bitte mit 'root' Rechten nach `/etc/opsi/backendManager/extend.d` kopieren. Führen Sie danach aus:
`opsi-setup --set-rights /etc/opsi`.


[[opsi-manual-localimage-backuppartition]]
==== Backuppartition

Die Backuppartion ist (bei MBR BIOS und ohne Datenpartition) die dritte Partition der System-Festplatte. +
Bei Systemen mit mehr als einer Platte wird die Systemfestplatte bestimmt durch das opsi-local-image-prepare Property multi_disk_mode. +
Bei Systemen mit mehr als einer Platte kann sich die Backuppartition abhängig vom opsi-local-image-prepare Property backup_partition_on_same_disk auch als erste Partition einer anderen Platte befinden. +
Dort finden sich:

* Die Datei `master.log` mit Informationen über alle durchgeführten Image Operationen. Diese Logdatei wird in die bootimage logs übernommen.
* Die Image Verzeichnisse +
Die Imageverzeichnisse haben den selben Namen wie das Image und enthalten neben dem Image noch die Metadaten des Images. +
Zur Orientierung hier Beispielhaft die Größen von unterschiedlichen Imageverzeichnissen mit OS und Standardsoftware (Libreoffice, Adobereader, firefox, thunderbird, javavm, flashplayer):
* `opsi-local-image-ubuntu`: 3.6G
* `opsi-local-image-winxp`: 6.4G
* `opsi-local-image-win7`: 9.4G
* `opsi-local-image-win7-x64`: 13G

[[opsi-manual-localimage-wimcapture]]
==== Capture Images (WIM) erstellen und verteilen

[[opsi-manual-localimage-wimcapture-introduction]]
===== Capture Images (WIM) Einführung

Microsoft hat mit NT6 (also ab Vista) zur Installation ein neues Imageformat,
das *Windows Imaging Format (WIM)* eingeführt.
Ein WIM Image ist kein Platten- oder Partitionsimage sondern mehr ein Dateien und Metadaten Archiv. Eine WIM Datei kann mehrere Images enthalten. Die normale Installation eines NT6 Rechners basiert darauf, dass die setup.exe ein Image aus der Datei install.wim auspackt und dieses danach konfiguriert und mit zusätzlichen Treibern versieht.

Von einem existierender Rechner kann das Windows inclusive installierter Software, Hotfixes und Konfigurationen ausgelesen und in Form eines WIM abgespeichert werden. Ein solches WIM kann dann wieder die Basis für neue Installationen sein.

[[opsi-manual-localimage-wimcapture-components]]
===== Capture Images (WIM) Komponenten

Für die Erstellung eines Capture Images im Wim Format benötigen Sie ab den Produktversionen 4.1 nur noch das Produkt:

* `opsi-local-image-wim-capture`

Die vorherigen Produkte:

* `opsi-local-image-capture`

* `opsi-local-image-sysprep`

Sind damit obsolet und können gelöscht werden.
////
* `opsi-set-wim-imagenames`
* `opsi-del-wim-images`
////

Ergänzend gibt es die 'Zielprodukte' welche dafür gedacht sind, das gecapturte Image aufzunehmen:

* `opsi-local-image-win7-capture`
* `opsi-local-image-win7-x64-capture`
* `opsi-local-image-win81-capture`
* `opsi-local-image-win81-x64-capture`
* `opsi-local-image-win10-capture`
* `opsi-local-image-win10-x64-capture`

[[opsi-manual-localimage-wimcapture-proceedings]]
===== Capture Images (WIM) Abläufe

Die Abläufe und Einstellungen beim Produkt `opsi-local-image-wim-capture` entsprechen denen des Produktes `opsi-wim-capture` welches hier: <<opsi-manual-wimcap>> beschrieben ist. Die Properties von `opsi-wim-capture` sind hier: <<opsi-manual-wimcap-products-main>> beschrieben.

Der wesentliche Unterschied zwischen den beiden Produkten ist: +
`opsi-local-image-wim-capture` verwendet zur Sicherung und Wiederherstellung der zu capturten Partition den Mechanismus von `opsi-local-image-backup`/`opsi-local-image-restore`.
Für den selben Zweck verwendet `opsi-wim-capture` das Produkt `opsi-clonezilla`

HINWEIS::`opsi-local-image-wim-capture` schlägt fehl, wenn Sie Ihr System mit einer Datenpartition angelegt haben. Installieren Sie in diesem Fall den Rechner neu mit dem opsi-local-image-prepare Property data_partition_size=0.


////
*Übersicht:* +
Folgende Reihenfolge ist einzuhalten:

. Initale Vorbereitung des Rechners mit `opsi-local-image-prepare`
. Installation des Betriebssystems mit `opsi-local-image-win*`
. Installation und Konfiguration weiterer Software mit 'opsi' und / oder per Hand
. Einstellen der Produktproperties des netbootproduktes `opsi-local-image-capture` (aber nicht auf setup stellen)
. Starten des Localboot Produktes `opsi-local-image-sysprep`
. `opsi-local-image-sysprep` startet (je nach Property Einstellung) ein `opsi-local-image-backup`
. `opsi-local-image-sysprep` führt Sysprep zur Depersonalisierung aus
. `opsi-local-image-sysprep` startet (je nach Property Einstellung) `opsi-local-image-capture`
. `opsi-local-image-capture` konfiguriert die winpe Partition für das capturen und als Bootpartition
. Der PC bootet das winpe und führt den capture Vorgang aus

*Erstellen des Masterrechners:* +

Dieser wird mit 'opsi-local-image' als Rechner erstellt und kann dabei Software und Konfigurationen sowohl per opsi als auch von Hand bekommen.

*Sysprep: Depersonalisieren des Masters:* +

Damit ein capture Image als Basis für eine Installation dienen kann muß es zunächst dafür vorbereitet werden. Dabei wird der Rechner depersonalisiert, d.h. Der Rechner hat danach keine Identität mehr und ist gut geeignet als Vorlage für eine Neuinstallation aber als Rechner selber kaum noch brauchbar. +
Daher kann beim opsi-local-image-sysprep Produkt über Produkt Properties gesteuert werden ob vor der eigentlichen Depersonalisierung noch ein Backup angelegt werden soll:

* `always_backup_before_sysprep`: +
(true/false), Default=true, +
Startet immer ein Backup vor dem sysprep Vorgang.

[NOTE]
===============================
`always_backup_before_sysprep`='true' bedeutet, das Produkt `opsi-local-image-backup` wird auf setup gestellt und ein Reboot durchgeführt.
Um eine Endlosschleife zu vermeiden, wird nun ein Rebootflag gesetzt, damit nach Beendigung des Backup erkannt werden kann, dass dieser Schritt bereits erledigt ist.

Technischer Hinweis: Hier entseht das Problem, dass der Rebootflag auch in dem Backup landet, aber nach einem Restore nicht mehr erwünscht ist. Daher wird der Rebootflag als Timestamp gesetzt. Ein Rebootflag, der älter als 0,1 Tage (=2,4 Stunden) ist wird ignoriert.
===============================

* `abort_on_no_backup`: +
(true/false), Default=true, +
Prüft ob auf der Backuppartition ein Backup zu diesem Produkt vorhanden ist und bricht ab falls nicht. +
Nach dem sysprep Vorgang wird üblicherweise der eigentliche capture Vorgang gestartet, der durch das netboot Produkt 'opsi-local-image-capture' durchgeführt wird. Ob der Start automatisch durchgeführt wird entscheidet das Property:
* `startcapture`: +
(true/false), Default=true, +
Setze das Produkt `opsi-local-image-capture` auf 'setup' und rebootet den Rechner
* `disabled`: +
(true/false), Default=false, +
Wenn true wird das Produkt nicht ausgeführt. Dies dient dazu Endlosschleifen zu vermeiden wenn ein Image restored wird, in dessen Meta-Daten `opsi-local-image-sysprep` auf `setup` steht.

.Capture Images: Configed: opsi-local-image-sysprep
image::oli-capture-configed-sysprep.jpg["Capture Images: Configed: opsi-local-image-sysprep", width=500]

*Capture: Die vorhandene Installation auslesen und zur Installation bereitstellen:* +

Im Rahmen dieses Mehrstufigen Prozesses wird der vorhandene Rechner ausgelesen und als WIM Image in ein vorhandenes opsi Windows Installationsprodukt integriert. Von daher gibt es naheliegender Weise ein Produktproperty über das angegeben werden kann in welches Produkt das ausgelesene Image integriert werden soll:

* `target_product`: +
Name des Ziel Produktes  (Default = pass:[''])

IMPORTANT: Dieses Property ist nicht 'schlau', es wird nicht überprüft ob das ausgelesene Image zum Zielprodukt passt. Sie können also ohne Fehlermeldung ein win7-32Bit Image in ein Win81-64Bit Produkt schreiben. Das sollten Sie aber nicht! Wir empfehlen die Verwendung von gesonderten Produkten, welche nur als Ziel dienen (z.B. `opsi-local-image-win81-x64-capture`).

Das Zielprodukt muß genauso wie ein normales Produkt zur Windows Installation vorbereitet werden. Als Zieldatei innerhalb des Zielproduktes dient die `install.wim` Datei (`installfiles/sources/install.wim`) welche auch die von Microsoft gelieferten Images enthält. Ob das ausgelese Image nun an diese Datei angehängt werden soll oder eine neue install.wim erzeugt werden soll, steuert das Property:

* `capture_mode`: +
(append/always_create) Default='append':

Bei `append` wird das neu erstellte Image an die vorhandene install.wim angehängt.

IMPORTANT: Enthält die install.wim schon ein Image gleichen Namens wird dieses *ohne Nachfrage gelöscht*. Bei `always_create` wird eine neue install.wim erstellt. +
`always_create` funktioniert nicht mit winpe installationen die auf Windows < 8 basieren.

Die Install.wim Datei ist ein Container der mehrere Images enthalten kann. Die Images haben einen Namen und eine Beschreibung. Der Name und die Beschreibung des neu erstellten Images werden durch die folgenden Properties gesteuert:

* `imagename`: +
Default = pass:['']

* `image_description`: +
Default = pass:['']

* Das Property `start_after_capture` +
ist ein Liste von Produkten, welche nach dem Abschluß des Capturevorgangs auf 'setup' gestellt werden sollen. Eine gute Idee ist hier zum Beispiel opsi-local-image-restore, welches das vor dem sysprep erstellte backup wiederherstellt.

.Capture Images: Configed: opsi-local-image-capture
image::oli-capture-configed-capture.jpg["Capture Images: Configed: opsi-local-image-capture", width=500]

.Capture Images: Schema: sysprep
image::oli-capture-sheme-sysprep.png["Capture Images: Schema: sysprep", width=500]

.Capture Images: opsi-local-image-sysprep 1 : Start
image::oli-capture-sysprep1.jpg["Capture Images: opsi-local-image-sysprep 1 : Start", width=350]

.Capture Images: opsi-local-image-sysprep 2 : Backup vor sysprep
image::oli-capture-sysprep1-backup.jpg["Capture Images: opsi-local-image-sysprep 2 : Backup vor sysprepp", width=350]

.Capture Images: opsi-local-image-sysprep 3 : Deaktivierung des opsi-client-agent
image::oli-capture-sysprep2a.jpg["Capture Images: opsi-local-image-sysprep 3 : Deaktivierung des opsi-client-agent", width=350]

.Capture Images: opsi-local-image-sysprep 4 : Eigentlicher sysprep Vorgang
image::oli-capture-sysprep2b.jpg["Capture Images: opsi-local-image-sysprep 4 : Eigentlicher sysprep Vorgang", width=350]

Gesteuert durch das Property `startcapture` kann der Capturevorgang direkt im Anschluß an das sysprep gestartet werden. +
Der Capture Vorgang besteht grob aus zwei Phasen: +
Der eigentliche Capture Vorgang soll durch das winpe auf der Platte durchgeführt werden. Hierfür muß dieses aber erst präpariert werden und dies ist die erste Phase:

* Aktivierung des WinPE als bootbare Partition, Erstellung der nötigen bootrecords und soweit nötig die Deaktivierung von Laufwerksbuchstaben bei anderen Partitionen

* Auslesen der opsi-Metadaten über Installierte Produkte auf dem Client und Speicherung dieser Daten auf dem Client in einem temporären Verzeichnis.

* Einige Aufräumarbeiten auf dem auszulesenden System.

* Schreiben einer Kommandodatei welches die Capturevorgänge beim nächsten WinPE start initiiert.

* Bereitstellen weiterer Daten für die Abläufe im WinPE wie z.B. Liste der Produkte aus dem Property `start_after_capture`

* Reboot des Clients

.Capture Images: Schema: Capture 1
image::oli-capture-scheme-capture1.png["Capture Images: Schema: Capture 1", width=500]

In der zweiten Phase startet das WinPE und führt nun den eigentlichen Capturevorgang durch. Im Detail:

* Mounten des opsi_depot_rw shares damit auf diesen auch geschrieben werden kann.

* Prüfen der Architektur des WinPE (32/64 Bit) und Start des opsi-script in der entsprechenden Architektur.

* Herstellung der Verbindung zum opsi-webservice

* Reaktivierung der Laufwerksbuchstaben

* Im Falle von `append` mode: Überprüfen ob ein Image mit diesem Namen schon vorhanden ist und gegebenenfalls dieses löschen.

* Start des Capturevorgangs. Dabei wird in Abhängigkeit der Windows Version des WinPE bei Windows 7 das Programm imagex aus dem 'opsi-local-image-capture' Produkt verwendet. Bei Windows 8 wird das Programm dism aus dem WinPE verwendet (mit Fallback zu imagex).

* Die entstandenen Logfiles werden zusammengeführt.

* Überprüfung der Liste der Images im Modifizierten install.wim und setzten dieser Namensliste in das Produktproperty `Imagenames` des Zielproduktes, so das das neu erstellte Image auch zur Installation ausgewählt werden kann.

* Setzen der Produkte aus `start_after_capture` auf 'setup'.

* Deaktivierung der WinPE Partition und Aktivierung der Systempartition (Windows). Bei UEFI Umstellung auf Netboot soweit möglich.

* Schreiben der Logdatei zum Server. Dort wird diese an die Logdatei des opsi-local-capture bootimage Laufs angehängt.

* Reboot

.Capture Images: Schema: Capture 2
image::oli-capture-scheme-capture2.png["Capture Images: Schema: Capture 2", width=500]

.Capture Images: Capture: Löschen eines existierenden Images
image::oli-capture-del-existing-image.jpg["Capture Images: Capture: Löschen eines existierenden Images", width=350]

.Capture Images: Capture: Capture und Anhängen (Append) des neuen Images
image::oli-capture-append-image-dism.jpg["Capture Images: Capture: Capture und Anhängen (Append) des neuen Images", width=350]
////

[[opsi-manual-localimage-wimcapture-rollout]]
==== Windows Installation von einem Targetprodukt aus
(Ausrollen des gecapturten Images)

*Wiederherstellung der opsi Metadaten zu installierten Produkten*

*Das Problem:*

Wenn Sie ein Windows mit opsi neu installieren, z.B. aus `win7-x64`, dann werden bei der Installation des opsi-client-agent alle Localboot-Produkte, welche bei diesem Rechner vorher auf `installed` standen, automatisch auf setup gestellt und damit später erneut installiert. +
Dies kann beim Ausrollen eines 'gecapturten' Images nicht ganz genauso durchgeführt werden. +
Im Image befindet sich das Backup der opsi-Daten, das dort während des capture Vorgangs abgelegt wurde. Dieses wird bei der Installation des opsi-client-agent entdeckt, und wieder in den opsi-server eingespielt. Damit stehen die Produkte, die in dem 'gecapturten' Image installiert waren, jetzt für den frisch installierten Rechner auf `installed`.
Würden jetzt alle Produkte, welche auf `installed` stehen auf `setup` gesetzt, würde dies dazu führen, dass alle schon im Image installierten Produkte nochmal installiert werden. Dies ist nicht erwünscht.


Bei der Wiederherstellung der opsi Metadaten zu installierten Produkten gibt es ab opsi 4.0.7 zwei Varianten: +

* Variante 1: +
Zurückspielen der Metadaten und Beibehaltung von 'setup'-Actionrequests. +
Produkte die auf 'installed' stehen werden *nicht* auf 'setup' gestellt. +
Dies ist der Default und das Verhalten vor opsi 4.0.7

* Variante 2: +
Zurückspielen der Metadaten. Produkte die auf 'installed' stehen werden auf 'setup' gestellt ausser denen welche in den restorten Metadaten enthalten waren. +

*Variante 1* +
Beim Ausrollen eines 'gecapturten' Images werden nach der Installation des Images nur die Produkte automatisch installiert, welche schon vor dem Beginn der Betriebssystem-Installation auf `setup` standen. Dies kann durch Ihren Eingriff oder das Property `setup_after_install` erfolgt sein.
Daher werden in diesem Fall auch nur die Produkte installiert, welche vor der Installation des Betriebssystems auf `setup` standen. +
Dies ist der Default und das Verhalten vor opsi 4.0.7

*Variante 2* +
Die Variante 2 verhält sich vom Ergebnis ähnlich wie es bei Installationen aus nicht gecapturten Images der Fall ist: +
* Zurückspielen der Metadaten. +
* Produkte die auf 'installed' stehen werden auf 'setup' gestellt ausser denen welche in den restorten Metadaten enthalten waren. +
Diese Verhalten steht erst ab opsi 4.0.7 zur Verfügung und ist nicht der Default. Variante 2 ist durch Erweiterungen am opsi-script möglich geworden und ist Bestandteil des opsi-client-agent von 4.0.7. +
Um dieses Verhalten zu verwenden muss ein 'config' ('Hostparameter') gesetzt werden: +
Der boolsche Konfigurationseintrag: `clientconfig.capture.switch_installed_products_to_setup`. Hat dieser Eintrag für den Client den Wert 'true' dann wird Variante 2 verwendet, ansonsten Variante 1. +

Über diese '{opsi-config-objects}' können dann Events Client-spezifisch aktiviert bzw. deaktiviert werden.
Die '{opsi-config-objects}' können über den '{opsi-configed}' oder '{opsi-admin}' angelegt werden.

Zum Anlegen der '{opsi-config-objects}' über '{opsi-admin}' sind die folgenden Befehle auf dem '{opsi-configserver}' auszuführen:

[source,prompt]
----
opsi-admin -d method config_createBool clientconfig.capture.switch_installed_products_to_setup "capture.switch_installed_products_to_setup" true
----
Damit stellen Sie für *alle* Rechner 'Variante 2' ein.

Zum Anlegen der '{opsi-config-objects}' über den '{opsi-configed}' wählen Sie dort 'Serverkonfiguration' / 'clientconfig' / Auf der Rechten Seite mit der rechten Maustaste: `Boolschen Konfigurationseintrag hinzufügen`.



[[opsi-manual-localimage-wim-info]]
==== Hilfsprodukt opsi-wim-info

Das Produkt `opsi-wim-info` kann verwendet werden um schnell informationen über die in einer install.wim gespeicherten Images auszulesen. Diese Informationen werden dann in der Logdatei gespeichert. +
Properties:

* `target_produkt` +
ProductId des Produktes in dem die 'install.wim' gesucht wird.

[[opsi-manual-localimage-ubuntumirror]]
==== Erstellen eines eigenen Ubuntu 'Proxy'
Eine brauchbare Anleitung zur Erstellung eines eigenen Ubuntu Proxy finden Sie hier:

* link:http://wiki.ubuntuusers.de/Lokale_Paketquellen/Apt-Cacher-ng

* link:http://www.gambaru.de/blog/2011/10/26/apt-cacher-ng-ein-proxy-server-fur-debian-und-ubuntu/
